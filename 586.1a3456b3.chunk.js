!function(){var t,e,n,s,r={17008:function(t,e,n){"use strict";n.d(e,{E0:function(){return o},LB:function(){return u},Wt:function(){return c},bd:function(){return h},dt:function(){return m},iL:function(){return i},rk:function(){return l},xD:function(){return r},z4:function(){return d}});n(21073);var s=n(64762);function r(){return"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope}const a=!r()&&localStorage.getItem("chainId")||"bostrom",i=s.A[a].LCD_URL,o=s.A[a].RPC_URL,c=s.A[a].WEBSOCKET_URL,u=s.A[a].INDEX_HTTPS,d=s.A[a].INDEX_WEBSOCKET,l=s.A[a].BECH32_PREFIX,p=`${l}val`,m=`${p}oper`,h=(s.A[a].BASE_DENOM,s.A[a].DENOM_LIQUID,2e5),{MEMO_KEPLR:g}=s.A[a]},64762:function(t,e,n){"use strict";var s=n(21073);const r={bostrom:{CHAIN_ID:s.a.BOSTROM,BASE_DENOM:"boot",DENOM_LIQUID:"hydrogen",RPC_URL:"https://rpc.bostrom.cybernode.ai",LCD_URL:"https://lcd.bostrom.cybernode.ai",WEBSOCKET_URL:"wss://rpc.bostrom.cybernode.ai/websocket",INDEX_HTTPS:"https://index.bostrom.cybernode.ai/v1/graphql",INDEX_WEBSOCKET:"wss://index.bostrom.cybernode.ai/v1/graphql",BECH32_PREFIX:"bostrom",MEMO_KEPLR:"[bostrom] cyb.ai, using keplr"},localbostrom:{CHAIN_ID:s.a.LOCAL_BOSTROM,BASE_DENOM:"boot",DENOM_LIQUID:"hydrogen",RPC_URL:"https://rpc.bostrom.moon.cybernode.ai",LCD_URL:"https://lcd.bostrom.moon.cybernode.ai",WEBSOCKET_URL:"wss://rpc.bostrom.moon.cybernode.ai/websocket",INDEX_HTTPS:"https://index.bostrom.moon.cybernode.ai/v1/graphql",INDEX_WEBSOCKET:"wss://index.bostrom.moon.cybernode.ai/v1/graphql",BECH32_PREFIX:"bostrom",MEMO_KEPLR:"[bostrom] cyb.ai, using keplr"},"space-pussy":{CHAIN_ID:s.a.SPACE_PUSSY,BASE_DENOM:"pussy",DENOM_LIQUID:"liquidpussy",RPC_URL:"https://rpc.space-pussy.cybernode.ai/",LCD_URL:"https://lcd.space-pussy.cybernode.ai",WEBSOCKET_URL:"wss://rpc.space-pussy.cybernode.ai/websocket",INDEX_HTTPS:"https://index.space-pussy.cybernode.ai/v1/graphql",INDEX_WEBSOCKET:"wss://index.space-pussy.cybernode.ai/v1/graphql",BECH32_PREFIX:"pussy",MEMO_KEPLR:"[space-pussy] cyb.ai, using keplr"}};e.A=r},32833:function(t,e,n){"use strict";n.d(e,{d5:function(){return r},mt:function(){return o},rP:function(){return a},s_:function(){return i}});var s=n(17008);const r=new RegExp(`^${s.rk}[a-zA-Z0-9]{39}$`,"g"),a=/^Qm[a-zA-Z0-9]{44}$/g,i=(new RegExp(`^${s.rk}[a-zA-Z0-9]{59}$`,"g"),new RegExp(`^${s.dt}valoper[a-zA-Z0-9]{39}$`,"g"),/^cosmos[a-zA-Z0-9]{39}$/g),o=/^https:\/\/|^http:\/\//g},86193:function(t,e,n){"use strict";n.d(e,{s:function(){return s}});var s=(t=>(t.to="to",t.from="from",t.all="all",t))(s||{})},55723:function(t,e,n){"use strict";var s=n(29017),r=(t=>(t[t.ZERO=0]="ZERO",t[t.LOW=.1]="LOW",t[t.MEDIUM=.5]="MEDIUM",t[t.HIGH=.9]="HIGH",t[t.URGENT=1]="URGENT",t))(r||{}),a=n(27291),i=n(49426);function o(t){return{async*[Symbol.asyncIterator](){let e=!1;for(;!e;){const n=new Promise((n=>{t.onmessage=t=>{null===t.data?(e=!0,n(null)):n(t.data)}})),s=await n;null!==s&&(yield s)}}}}const c={canHandle:t=>t&&t.result&&"function"==typeof t.result[Symbol.asyncIterator],serialize(t){if(void 0===t)return[null,[]];const{result:e,...n}=t,{port1:s,port2:r}=new MessageChannel;return e&&(async()=>{for await(const t of e)s.postMessage(t);s.postMessage(null),s.close()})(),[{...n,port:r},[r]]},deserialize(t){if(!t)return;const{port:e,...n}=t;return{...n,result:o(e)}}};var u=n(93776),d=n(64423),l=n(65606),p=n(96763);"undefined"!=typeof SharedWorker&&l.env.IS_DEV;function m(){s.J3.set("IPFSContent",c),s.J3.set("observable",{canHandle:t=>t instanceof u.c,deserialize:t=>new u.c((e=>{const n=s.J3.get("proxy").deserialize(t);n.subscribe((0,s.BX)({next:t=>e.next(t),error:t=>e.error(t),complete:()=>e.complete()})).then((t=>e.add((()=>{t.unsubscribe(),n[s.A2]()}))))})),serialize:t=>s.J3.get("proxy").serialize({subscribe:e=>t.subscribe({next:t=>e.next(t).then(),error:t=>e.error(t).then(),complete:()=>e.complete().then()})})}),s.J3.set("subscription",{canHandle:t=>t instanceof d.yU,deserialize:t=>new d.yU((()=>{const e=s.J3.get("proxy").deserialize(t);e.unsubscribe().then((()=>{e[s.A2]()}))})),serialize:t=>s.J3.get("proxy").serialize({unsubscribe:()=>t.unsubscribe()})})}function h(t){const e={log:{original:p.log},error:{original:p.error},warn:{original:p.warn}},n=n=>{const{original:s}=e[n];e[n].original=p[n],p[n]=(...e)=>{s.apply(p,e);const r=e.map((t=>function(t){try{return JSON.stringify(t)}catch(e){return String(t)}}(t)));t.postMessage({type:"console",method:n,args:r})}};Object.keys(e).forEach((t=>n(t)))}var g=n(74192),y=n(81160),f=n(60258),b=n(22325);var w=(t=>(t[t.transactions=1]="transactions",t[t.particle=2]="particle",t[t.chat=3]="chat",t))(w||{}),v=(t=>(t[t.pending=0]="pending",t[t.executing=1]="executing",t[t.done=2]="done",t[t.error=-1]="error",t))(v||{}),S=(t=>(t[t.particle=0]="particle",t[t.embedding=1]="embedding",t))(S||{});function $(t){return Boolean(t.match(/^Qm[a-zA-Z0-9]{44}$/g))}var x=n(17008),_=n(96763);const A={list:{isLoading:!1,data:[],error:void 0},chats:{},summary:{unreadCount:{total:0,particles:0,neurons:0}},llm:{threads:(0,x.xD)()?[]:JSON.parse(localStorage.getItem("llmThreads")||"[]"),currentThreadId:null}};function C(t){t.entryType===w.chat&&t.meta.to&&(t.entryType=w.particle);const{meta:e}=t,n={timestamp:new Date(e.timestamp).toISOString(),transactionHash:t.transactionHash||t.hash||t.meta.transaction_hash||t.meta.hash||t.meta.transactionHash,memo:t.memo||e.memo,senseChatId:t.id,unreadCount:t.unreadCount||0};switch(t.entryType){case w.chat:case w.transactions:{const e=t.meta,{type:s}=e;let r=t.ownerId;if("cosmos.bank.v1beta1.MsgSend"===s){r=e.value.fromAddress}else if("cosmos.bank.v1beta1.MsgMultiSend"===s){r=e.value.inputs[0].address}Object.assign(n,{type:s,from:r,meta:t.meta.value});break}case w.particle:{const e=t.meta;Object.assign(n,{type:"cyber.graph.v1beta1.MsgCyberlink",from:e.neuron,meta:e,fromLog:!0});break}default:return{}}return n}const T=(0,f.zD)("sense/getSenseList",(async t=>(await t.getList()).map(C))),k=(0,f.zD)("sense/getSenseChat",(async({id:t,senseApi:e})=>{if($(t)){return(await e.getLinks(t)).map((e=>{if(0!==e.timestamp)return C({...e,id:t,entryType:w.particle,meta:e})})).filter(Boolean)}return(await e.getFriendItems(t)).map((e=>{const n=e.to?w.particle:w.chat;return C({...e,entryType:n,id:t,meta:e})}))})),E=(0,f.zD)("sense/markAsRead",(async({id:t,senseApi:e})=>e.markAsRead(t))),I={id:"",isLoading:!1,data:[],error:void 0,unreadCount:0};function P(t,e){return t.data.slice(-5).some((t=>t.transactionHash===e.transactionHash))}const M=(0,f.Z0)({name:"sense",initialState:A,reducers:{updateSenseList:{reducer:(t,e)=>{e.payload.forEach((e=>{const{senseChatId:n}=e;t.chats[n]||(t.chats[n]={...I});const s=t.chats[n];Object.assign(s,{id:n,unreadCount:e.unreadCount||0}),P(s,e)||(s.data=s.data.concat(e))})),M.caseReducers.orderSenseList(t)},prepare:t=>({payload:t.map(C)})},addSenseItem(t,e){const{id:n,item:s}=e.payload;t.chats[n].data.push({...s,meta:s.meta,status:"pending"});const r=t.list.data.filter((t=>t!==n));r.unshift(n),t.list.data=r},updateSenseItem(t,e){const{chatId:n,txHash:s,isSuccess:r}=e.payload,a=t.chats[n].data.find((t=>t.transactionHash===s));a&&(r?delete a.status:a.status="error")},orderSenseList(t){const e=Object.keys(t.chats).reduce(((e,n)=>{const s=t.chats[n];if(!s.data.length)return e;const r=s.data[s.data.length-1];return e.push({id:n,lastMsg:r}),e}),[]).sort(((t,e)=>Date.parse(e.lastMsg.timestamp)-Date.parse(t.lastMsg.timestamp)));t.list.data=e.map((t=>t.id))},reset:()=>A,createLLMThread(t,e){const n={id:e.payload.id,messages:[],dateUpdated:Date.now(),title:e.payload.title||`Conversation ${t.llm.threads.length+1}`};t.llm.threads.push(n),t.llm.currentThreadId=e.payload.id,localStorage.setItem("llmThreads",JSON.stringify(t.llm.threads))},selectLLMThread(t,e){t.llm.currentThreadId=e.payload.id},addLLMMessageToThread(t,e){const n=t.llm.threads.find((t=>t.id===e.payload.threadId));n&&(n.messages.push(e.payload.message),n.dateUpdated=e.payload.message.timestamp,localStorage.setItem("llmThreads",JSON.stringify(t.llm.threads)))},replaceLastLLMMessageInThread(t,e){const n=t.llm.threads.find((t=>t.id===e.payload.threadId));n&&n.messages.length>0&&(n.messages[n.messages.length-1]=e.payload.message,localStorage.setItem("llmThreads",JSON.stringify(t.llm.threads)))},deleteLLMThread(t,e){const n=t.llm.threads.filter((t=>t.id!==e.payload.id));_.log("newT",n),t.llm.threads=n,t.llm.currentThreadId===e.payload.id&&(t.llm.currentThreadId=null),localStorage.setItem("llmThreads",JSON.stringify(t.llm.threads))},clearLLMThreads(t){t.llm.threads=[],t.llm.currentThreadId=null,localStorage.removeItem("llmThreads")}},extraReducers:t=>{t.addCase(T.pending,(t=>{t.list.isLoading=!0})),t.addCase(T.fulfilled,((t,e)=>{t.list.isLoading=!1;const n=[];e.payload.forEach((e=>{const{senseChatId:s}=e;t.chats[s]||(t.chats[s]={...I});const r=t.chats[s];Object.assign(r,{id:s,unreadCount:e.unreadCount||0}),P(r,e)||(r.data=r.data.concat(e)),n.push(s)})),t.list.data=n})),t.addCase(T.rejected,((t,e)=>{_.error(e),t.list.isLoading=!1,t.list.error=e.error.message})),t.addCase(k.pending,((t,e)=>{const{id:n}=e.meta.arg;t.chats[n]||(t.chats[n]={...I}),t.chats[n].isLoading=!0})),t.addCase(k.fulfilled,((t,e)=>{const{id:n}=e.meta.arg,s=t.chats[n];s.isLoading=!1,s.id=n,s.data=e.payload})),t.addCase(k.rejected,((t,e)=>{_.error(e);const n=t.chats[e.meta.arg.id];n.isLoading=!1,n.error=e.error.message})),t.addCase(E.fulfilled,((t,e)=>{const{id:n}=e.meta.arg,s=t.chats[n],r=$(n),{unreadCount:a}=s;t.summary.unreadCount.total-=a,r?t.summary.unreadCount.particles-=a:t.summary.unreadCount.neurons-=a,s.unreadCount=0}))}}),{addSenseItem:R,updateSenseItem:O,updateSenseList:L,reset:z,createLLMThread:D,deleteLLMThread:q,selectLLMThread:N,addLLMMessageToThread:B,replaceLastLLMMessageInThread:U,clearLLMThreads:F}=((0,b.Mz)((t=>t.sense.chats),(t=>{let e=0,n=0;Object.values(t).forEach((({id:t,unreadCount:s})=>{$(t)?e+=s:n+=s}));return{total:e+n,particles:e,neurons:n}})),M.actions);M.reducer;const j={POCKET:"pocket",POCKET_ACCOUNT:"pocketAccount"};const H={actionBar:{tweet:n(31948).dB.STAGE_TWEET_ACTION_BAR.TWEET},isInitialized:!1,defaultAccount:{name:null,account:null},accounts:null};function Q(t){const{defaultAccount:e,accounts:n}=t;e&&localStorage.setItem(j.POCKET,JSON.stringify({[e.name]:e.account})),n&&localStorage.setItem(j.POCKET_ACCOUNT,JSON.stringify(n))}const W=(0,f.Z0)({name:"pocket",initialState:H,reducers:{setDefaultAccount:(t,{payload:{name:e,account:n}})=>{t.defaultAccount={name:e,account:n||t.accounts?.[e]||null},Q(t)},setAccounts:(t,{payload:e})=>{t.accounts=e,Q(t)},setInitialized:t=>{t.isInitialized=!0},setStageTweetActionBar:(t,{payload:e})=>{t.actionBar.tweet=e},deleteAddress:(t,{payload:e})=>{t.accounts&&Object.keys(t.accounts).forEach((n=>{Object.keys(t.accounts[n]).forEach((s=>{if(t.accounts[n][s].bech32===e){if(delete t.accounts[n][s],0===Object.keys(t.accounts[n]).length&&delete t.accounts[n],t.defaultAccount?.account?.cyber?.bech32===e){const e=Object.entries(t.accounts).find((([,t])=>t.cyber?.bech32));t.defaultAccount=e?{name:e[0],account:e[1]}:{name:null,account:null}}Q(t)}}))}))}}}),{setDefaultAccount:J,setAccounts:Z,setStageTweetActionBar:V,deleteAddress:Y}=W.actions;W.reducer;const G="cyb-queue-channel";var K=class{constructor(){this.channel=new BroadcastChannel("cyb-broadcast-channel")}postServiceStatus(t,e,n){this.channel.postMessage({type:"service_status",value:{name:t,status:e,message:n}})}postSyncEntryProgress(t,e){this.channel.postMessage({type:"sync_entry",value:{entry:t,state:e}})}postMlSyncEntryProgress(t,e){this.channel.postMessage({type:"sync_ml_entry",value:{entry:t,state:e}})}postSenseUpdate(t){t.length>0&&this.channel.postMessage(L(t))}postSetDefaultAccount(t,e){this.channel.postMessage(J({name:t,account:e}))}post(t){this.channel.postMessage(t)}},X=n(52665),tt=n(59099),et=n(16126),nt=n(28452),st=n(61701),rt=n(1005);const at=(t,e)=>({sendStatus:(n,s,r)=>{e.postSyncEntryProgress(t,{status:n,message:s,progress:r,done:["active","error","listen"].some((t=>t===n))})}});async function it(t,e,n=10){let s=[];for await(const r of t)s.push(r),s.length===n&&(await e(s),s=[]);s.length>0&&await e(s)}async function*ot(t,e){let n=0;for(;;){const s=await t({...e,offset:n});if(0===s.length)break;yield s,n+=s.length}}const ct=(()=>{const t=new BroadcastChannel(G);return{enqueue:e=>{t.postMessage(e)}}})(),ut=async t=>{const e=await gt(t);return e&&ct.enqueue({type:"sync",data:{id:t.cid,data:e,jobType:S.embedding,priority:r.MEDIUM}}),!!e};var dt=n(32833);const lt="QmbdH2WBamyKLPE5zu4mJ9v49qvY8BFfoumoVPMR5V4Rvx",pt="QmPLSA5oPqYxgc8F7EwrM8WS9vKrr1zPoDniSRFh8HSrxx",mt=[lt,pt];var ht=n(96763);const gt=async t=>{const[e,n]=await(async t=>{const e=t?.meta?.contentType||"";return"text"===e?[e,t.textPreview]:[e,void 0]})(t);let s="text"===e&&!!n;return s=s&&(!n.match(dt.s_)||!n.match(dt.d5)),s?n:void 0};var yt=class{constructor(t){if(this.statusApi=at("resolver",new K),this._syncQueue$=new i.t(new Map),!t.waitForParticleResolve)throw new Error("waitForParticleResolve is not defined");this.waitForParticleResolve=t.waitForParticleResolve,t.embeddingApi$.subscribe((t=>{this.embeddingApi=t,this.queue.size>0&&this._syncQueue$.next(this.queue)})),t.dbInstance$.pipe((0,X.$)((t=>void 0!==t))).subscribe((async t=>{this.db=t,await this.loadSyncQueue()})),this.isInitialized$=(0,g.z)([t.dbInstance$,t.ipfsInstance$]).pipe((0,y.T)((([t,e])=>!!e&&!!t)))}get canEmbed(){return!!this.embeddingApi}get queue(){return this._syncQueue$.getValue()}get loop$(){return this._loop$}async resolveIpfsParticle(t,e){return this.waitForParticleResolve(t,e).then((async({status:t,result:e})=>!("not_found"===t||!e)&&(await ut(e),!0))).catch((()=>!1))}async saveEmbedding(t,e){try{if(!await this.db.existEmbedding(t)){const n=await this.embeddingApi.createEmbedding(e);await this.db.putEmbedding(t,n)}return!0}catch(n){return ht.error(`saveEmbedding error: ${t} - ${e} `,n.toString()),!1}}async processSyncQueue(t){const e=t.length;this.statusApi.sendStatus("in-progress",`processing batch ${e}/${e} batch. ${this.queue.size} pending...`);let n=e;await Promise.all(t.map((async t=>{const{id:s,jobType:a,data:i}=t;let o=Promise.resolve(!1);return a===S.embedding&&i?o=this.saveEmbedding(s,i):a===S.particle&&(o=this.resolveIpfsParticle(s,r.MEDIUM)),o.then((async t=>{t?await this.db.removeSyncQueue({id:s,jobType:a}):await this.db.updateSyncQueue({id:s,jobType:a,status:v.error});const r=this._syncQueue$.value;r.delete(s),n--,this._syncQueue$.next(r),this.statusApi.sendStatus("in-progress",`processing batch ${e-n}/${e} batch. ${this.queue.size} pending...`)}))})))}start(){const t=this.isInitialized$.pipe((0,tt.M)((t=>ht.log(`sync queue isInitialized - ${t}`))),(0,et.p)((t=>!0===t)),(0,nt.Z)((()=>this._syncQueue$)),(0,et.p)((t=>t.size>0)),(0,nt.Z)((t=>{const e=[...t.values()],n=100-e.filter((t=>t.status===v.executing)).length,s=t=>t.jobType===S.particle||t.jobType===S.embedding&&this.canEmbed;if(n>0){const r=e.filter((t=>t.status===v.pending&&s(t))).sort(((t,e)=>t.priority-e.priority)).slice(0,n);if(r.length>0)return r.forEach((e=>{t.set(e.id,{...e,status:v.executing})})),this._syncQueue$.next(t),this.statusApi.sendStatus("in-progress","starting..."),this.processSyncQueue(r)}return st.w})));return this._loop$=t.pipe((0,rt.u)()),this._loop$.subscribe({next:t=>{this.statusApi.sendStatus("active")},error:t=>this.statusApi.sendStatus("error",t.toString())}),this}async enqueueBatch(t,e,n){return it(t,(t=>this.enqueue(t.map((t=>({id:t,priority:n,jobType:e}))))),500)}async enqueue(t){if(0===t.length)return;await this.db.putSyncQueue(t);const e=this._syncQueue$.value;t.forEach((t=>e.set(t.id,{...t,status:v.pending}))),this._syncQueue$.next(e)}async loadSyncQueue(){const t=await this.db.getSyncQueue({statuses:[v.pending]}).then((t=>new Map(t.map((t=>[t.id,t])))));this._syncQueue$.next(new Map([...t,...this.queue]))}},ft=n(41900),bt=n(44240),wt=n(72316),vt=n(37968),St=n(2543),$t=n(84954);function xt(t,e=300){return t.length>e?`${t.slice(0,e)}...`:t}const _t=/\\u\{[a-fA-F0-9]+\}/g;const At=(t,e)=>{const{transaction_hash:n,index:s,transaction:{memo:r,block:{timestamp:a,height:i},success:o},type:c,value:u}=e;return{hash:n,index:s,type:c,timestamp:(0,$t.$Y)(a),memo:r,value:u,success:o,neuron:t,blockHeight:i}},Ct=({from:t,to:e,neuron:n,timestamp:s,transaction_hash:r})=>({from:t,to:e,neuron:n,timestamp:(0,$t.$Y)(s),transactionHash:r});function Tt(t,e){return async(...n)=>{if(e.aborted)throw new DOMException("The operation was aborted.","AbortError");return t(...n)}}var kt=n(2135);var Et=(t=>(t.Asc="asc",t.AscNullsFirst="asc_nulls_first",t.AscNullsLast="asc_nulls_last",t.Desc="desc",t.DescNullsFirst="desc_nulls_first",t.DescNullsLast="desc_nulls_last",t))(Et||{});kt.J1`
    subscription Transactions {
  transaction(offset: 0, limit: 200, order_by: {height: desc}) {
    success
    messages
    height
    hash
  }
}
    `;kt.J1`
    query accountCount {
  account_aggregate {
    aggregate {
      count(columns: address)
    }
  }
}
    `;kt.J1`
    query blockByHeight($blockId: bigint) {
  block(where: {height: {_eq: $blockId}}) {
    hash
    height
    proposer_address
    timestamp
    transactions {
      messages
      hash
      height
      success
    }
  }
}
    `;kt.J1`
    query blocks($limit: Int, $offset: Int, $where: block_bool_exp) {
  block(where: $where, limit: $limit, offset: $offset, order_by: {height: desc}) {
    hash
    height
    proposer_address
    transactions_aggregate {
      aggregate {
        count
      }
    }
    timestamp
  }
}
    `;kt.J1`
    query contractsCount {
  contracts_aggregate {
    aggregate {
      count
    }
  }
}
    `;const It=kt.J1`
    query CyberlinksByParticle($limit: Int, $offset: Int, $orderBy: [cyberlinks_order_by!], $where: cyberlinks_bool_exp) {
  cyberlinks(limit: $limit, offset: $offset, order_by: $orderBy, where: $where) {
    from: particle_from
    to: particle_to
    timestamp
    neuron
    transaction_hash
  }
}
    `;const Pt=kt.J1`
    query CyberlinksCountByNeuron($address: String, $particles_from: [String!], $timestamp: timestamp) {
  cyberlinks_aggregate(
    where: {_and: [{neuron: {_eq: $address}}, {particle_from: {_in: $particles_from}}, {timestamp: {_gt: $timestamp}}]}
  ) {
    aggregate {
      count
    }
  }
}
    `;kt.J1`
    query cyberlinksCountByParticle($cid: String, $where: cyberlinks_bool_exp) {
  cyberlinks_aggregate(where: $where) {
    aggregate {
      count
    }
  }
}
    `;const Mt=kt.J1`
    query MessagesByAddressCount($address: _text, $timestamp: timestamp) {
  messages_by_address_aggregate(
    args: {addresses: $address, limit: "100000000", offset: "0", types: "{}"}
    where: {transaction: {block: {timestamp: {_gt: $timestamp}}}}
  ) {
    aggregate {
      count
    }
  }
}
    `;const Rt=kt.J1`
    query MessagesByAddressSense($address: _text, $limit: bigint, $offset: bigint, $timestamp_from: timestamp, $types: _text, $order_direction: order_by) {
  messages_by_address(
    args: {addresses: $address, limit: $limit, offset: $offset, types: $types}
    order_by: {transaction: {block: {timestamp: $order_direction}}}
    where: {transaction: {block: {timestamp: {_gt: $timestamp_from}}}}
  ) {
    transaction_hash
    index
    value
    transaction {
      success
      block {
        timestamp
        height
      }
      memo
    }
    type
  }
}
    `;const Ot=kt.J1`
    subscription MessagesByAddressSenseWs($address: _text, $limit: bigint, $offset: bigint, $timestamp_from: timestamp, $types: _text, $order_direction: order_by) {
  messages_by_address(
    args: {addresses: $address, limit: $limit, offset: $offset, types: $types}
    order_by: {transaction: {block: {timestamp: $order_direction}}}
    where: {transaction: {block: {timestamp: {_gt: $timestamp_from}}}}
  ) {
    transaction_hash
    index
    value
    transaction {
      success
      block {
        timestamp
        height
      }
      memo
    }
    type
  }
}
    `;kt.J1`
    query transactionCount {
  transaction_aggregate {
    aggregate {
      count(columns: hash)
    }
  }
}
    `;kt.J1`
    query uptimeByAddress($address: String) {
  uptime(where: {consensus_address: {_eq: $address}}) {
    uptime
  }
}
    `;kt.J1`
    query wasmDashboardPage($offset: Int, $limit: Int) {
  contracts(limit: $limit, offset: $offset, order_by: {tx: desc}) {
    address
    admin
    code_id
    creator
    fees
    gas
    label
    tx
  }
  contracts_aggregate {
    aggregate {
      sum {
        gas
        fees
        tx
      }
      count(columns: address)
    }
  }
}
    `;kt.J1`
    query MessagesByAddress($address: _text, $limit: bigint, $offset: bigint, $types: _text) {
  messages_by_address(
    args: {addresses: $address, limit: $limit, offset: $offset, types: $types}
    order_by: {transaction: {block: {height: desc}}}
  ) {
    transaction_hash
    value
    transaction {
      success
      height
      logs
      memo
      block {
        timestamp
      }
    }
    type
  }
}
    `;var Lt=n(6975),zt=n(44941),Dt=n(44917);const qt="cosmos.bank.v1beta1.MsgSend",Nt="cosmos.bank.v1beta1.MsgMultiSend",Bt=(t,e)=>{const{data:n,events:s}=e,r=s["tx.hash"][0],a=s["message.action"][0].slice(1),i=(0,$t.YB)(),o=s["tx.height"][0],{memo:c="",messages:u}=(t=>{const e=Lt.Tx.decode((0,Dt.fromBase64)(t)),n=e.body?.memo,s=e.body?.messages.map((t=>{const e=t.typeUrl.slice(1);return e===qt?zt.MsgSend.decode(t.value):e===Nt?zt.MsgMultiSend.decode(t.value):void 0})).filter((t=>void 0!==t));return{memo:n,messages:s}})(n.value.TxResult.tx),d=[];return u.forEach(((e,n)=>{d.push({hash:r,index:n,type:a,timestamp:i,success:!0,value:e,memo:c,neuron:t,blockHeight:o})})),d};var Ut=n(90306),Ft=n(27404),jt=n(58205),Ht=n(97907),Qt=n(559);const Wt=new jt.c((0,Qt.UU)({url:x.z4,shouldRetry:t=>!0,retryAttempts:10,retryWait:async t=>{setTimeout((()=>Promise.resolve()),Math.min(1e3*2**t,1e4))}})),Jt=t=>new Ht.l4(x.LB,{signal:t});const Zt=async({particleCid:t,timestampFrom:e,offset:n=0,abortSignal:s})=>(await Jt(s).request(It,{limit:200,offset:n,orderBy:[{timestamp:Et.Asc}],where:{_or:[{particle_to:{_eq:t}},{particle_from:{_eq:t}}],timestamp:{_gt:(0,$t.jb)(e)}}})).cyberlinks,Vt=async({neuron:t,particlesFrom:e,timestampFrom:n,batchSize:s,offset:r=0,abortSignal:a})=>{const i={_and:[{timestamp:{_gt:(0,$t.jb)(n)}},{neuron:{_eq:t}},{particle_from:{_in:e}}]};return(await Jt(a).request(It,{limit:s,offset:r,orderBy:[{timestamp:Et.Asc}],where:i})).cyberlinks},Yt=async(t,e,n,s,r)=>ot(Vt,{neuron:t,particlesFrom:e,timestampFrom:n,batchSize:s,abortSignal:r}),Gt=t=>[...new Set([...t.map((t=>t.to)),...t.map((t=>t.from))])],Kt=async(t,e,n,s,r)=>{const a=((t,e,n)=>ot(Zt,{particleCid:t,timestampFrom:e,abortSignal:n}))(t,e,r),i=[];for await(const t of a){i.push(...t);const e=Gt(t);e.length>0&&await it(e,(t=>n.enqueueBatch(t,S.particle,s)),20)}return i};const Xt=({neuron:t,timestampFrom:e,offset:n=0,types:s=[],orderDirection:r="desc",limit:a})=>({address:`{${t}}`,limit:a,timestamp_from:(0,$t.jb)(e),offset:n,types:`{${s.map((t=>`"${t}"`)).join(" ,")}}`,order_direction:r}),te=async({neuron:t,timestampFrom:e,offset:n=0,types:s=[],orderDirection:r="desc",limit:a,abortSignal:i})=>{const o=await Jt(i).request(Rt,Xt({neuron:t,timestampFrom:e,offset:n,types:s,orderDirection:r,limit:a,abortSignal:i}));return o?.messages_by_address},ee=(t,e,n,s,r)=>{const a=t.get(e),i=a?.transactions||[];return i.push(n),t.set(e,{userAddress:e,lastSendTimestamp:r?n.timestamp:a?.lastSendTimestamp||0,last:{amount:s,memo:n.memo,direction:r?"to":"from"},transactions:i}),t},ne=async(t,e,n,s,r=!0)=>{const a=await t.findSyncStatus({ownerId:e,entryType:w.chat}),i=new Map(a?.map((t=>[t.id,t]))),o=((t,e)=>{if(0===(e.filter((t=>t.type===qt||t.type===Nt))||[]).length)return[];const n=new Map;return e.forEach((e=>{let s="";if(e.type===Nt){const{inputs:s,outputs:r}=e.value,a=s.find((e=>e.address===t));(a?r:s).forEach((t=>ee(n,t.address,e,t.coins,a)))}else if(e.type===qt){const{fromAddress:r,toAddress:a,amount:i}=e.value,o=r===t;s=o?a:r,ee(n,s,e,i,o)}})),n})(e,await t.getTransactions(e,{order:"asc",timestampFrom:n})),c=[];for(const n of o.values()){const a=i.get(n.userAddress),o=n.transactions.at(-1),{timestamp:u,hash:d,index:l}=o,p={entryType:w.chat,ownerId:e,meta:{transactionHash:d,index:l}};if(a){const{id:e,timestampRead:i,timestampUpdate:d,meta:l,unreadCount:m}=a,h=Math.max(i,n.lastSendTimestamp),{timestampUpdateContent:g=0,timestampUpdateChat:y=0}=l,f=Math.max(n.lastSendTimestamp,y),b=m+n.transactions.filter((t=>t.timestamp>f)).length;if(d<u){const n=r?u:y,i={...p,id:e,unreadCount:b,timestampRead:h,timestampUpdate:Math.max(u,g,n),meta:{...p.meta,timestampUpdateChat:n,timestampUpdateContent:g}};await Tt(t.updateSyncStatus.bind(t),s)(i),c.push({...a,...i,meta:o})}}else{const e=n.transactions.filter((t=>t.timestamp>n.lastSendTimestamp)).length,a={...p,id:n.userAddress,unreadCount:e,timestampUpdate:r?u:0,timestampRead:n.lastSendTimestamp,disabled:!1};await Tt(t.putSyncStatus.bind(t),s)(a),c.push({...a,meta:o})}}return c};var se=n(96222),re=n(63720),ae=n(79100);class ie{constructor(t){this.requestRecords=[],this.totalRequests=0,this.completedRequests=0,this.estimatedTime=-1,this.batchSize=1,this.onProgressUpdate=t}get progress(){return{totalCount:this.totalRequests,completeCount:this.completedRequests,estimatedTime:this.estimatedTime}}start(t,e=1){return this.totalRequests=t,this.requestRecords=[],this.completedRequests=0,this.estimatedTime=-1,this.batchSize=e,this.progress}add(t){return this.totalRequests+=t,this.progress}trackProgress(t){if(this.addRequestRecord(t),this.requestRecords.length>10&&this.requestRecords.shift(),this.requestRecords.length>1){const e=this.calculateAverageTimePerItem()*((this.totalRequests-this.completedRequests)*t);this.completedRequests+=t,this.estimatedTime=Math.round(e),this.onProgressUpdate&&this.onProgressUpdate(this.progress)}return this.progress}addRequestRecord(t){this.requestRecords.push({timestamp:Date.now(),itemCount:t})}calculateAverageTimePerItem(){let t=0,e=0;for(let n=1;n<this.requestRecords.length;n++){const s=this.requestRecords[n].timestamp-this.requestRecords[n-1].timestamp,{itemCount:r}=this.requestRecords[n];t+=s*r,e+=r}return 0===e?0:t/e}}var oe=class{constructor(t,e,n){if(this.progressTracker=new ie,this.channelApi=new K,this.params={myAddress:null},this.name=t,this.abortController=new AbortController,this.statusApi=at(t,this.channelApi),this.particlesResolver=n,this.cyblogCh=(0,ae.S)({thread:"bckd",module:t}),!e.params$)throw new Error("params$ is not defined");e.dbInstance$.subscribe((t=>{this.db=t})),this.particlesResolver=n,this.isInitialized$=this.createIsInitializedObserver(e),this.isInitialized$.subscribe((t=>{this.cyblogCh.info(`>>> ${this.name} - ${t?"initialized":"inactive"}`),this.statusApi.sendStatus(t?"initialized":"inactive")})),this.isInitialized$.pipe((0,re.n)((()=>e.params$))).subscribe((t=>{this.params=t,this.cyblogCh.info(`>>> ${this.name} - params updated`,{data:t})})),this.isInitialized$.pipe((0,et.p)((t=>!!t)),(0,re.n)((()=>this.createRestartObserver(e.params$)))).subscribe((()=>{this.restart()}))}initAbortController(){this.abortController=new AbortController}createRestartObserver(t){return t.pipe((0,y.T)((t=>t.myAddress)),(0,ft.F)(((t,e)=>t===e)),(0,y.T)((t=>!!t)),(0,et.p)((t=>!!t)))}};const ce=(t,e,n)=>t.pipe((0,ft.F)(),(0,tt.M)((t=>n?.(t))),(0,et.p)((t=>t)),(0,re.n)((()=>e)),(0,rt.u)());var ue=n(96763);var de=class extends oe{constructor(t,e,n){super(t,e,n),this.reloadTrigger$=new a.B;const s=ce(this.isInitialized$,this.reloadTrigger$.pipe((0,se.Z)(null),(0,tt.M)((()=>{this.initAbortController()})),(0,re.n)((()=>this.createInitObservable().pipe((0,re.n)((t=>this.createClientObservable(t).pipe((0,tt.M)((()=>this.statusApi.sendStatus("listen"))),(0,re.n)((t=>(0,vt.H)(this.onUpdate(t,this.params))))))))))),(e=>{ue.log(`>>> ${t} isInitialized`,e),this.statusApi.sendStatus(e?"initialized":"inactive")}));s.subscribe({next:()=>{this.statusApi.sendStatus("listen")},error:t=>{this.statusApi.sendStatus("error",t)}}),this.source$=s}restart(){this.abortController?.abort(),this.reloadTrigger$.next(),ue.log(`>>> ${this.name} client restart`)}start(){return this.source$.subscribe((()=>{})),this}};var le=class extends de{createIsInitializedObserver(t){return(0,g.z)([t.dbInstance$,t.params$.pipe((0,y.T)((t=>t.myAddress)),(0,ft.F)()),this.particlesResolver.isInitialized$]).pipe((0,y.T)((([t,e,n])=>!!t&&!!n&&!!e)))}createClientObservable(t){const{myAddress:e}=this.params;this.cyblogCh.info(`>>> ${this.name} subscribe ${e} from ${(0,$t.jb)(t)}`);const n=Xt({neuron:e,timestampFrom:t,types:[],orderDirection:"desc",limit:100}),s=function(t,e){const n=new Ut.R({link:Wt,cache:new Ft.D}).subscribe({query:t,variables:e});return new u.c((t=>{const e=n.subscribe({next(e){t.next(e.data)},error(e){t.error(e)},complete(){t.complete()}});return()=>e.unsubscribe()}))}(Ot,n).pipe((0,y.T)((t=>({source:"indexer",transactions:t.messages_by_address.map((t=>At(e,t)))})))),r=function(t,e,n){return new u.c((s=>{const r=new WebSocket(x.Wt);return r.onopen=()=>{n(`node ws connected to ${x.Wt} with ${e}`),r.send(JSON.stringify({jsonrpc:"2.0",method:"subscribe",id:"0",params:{query:e}}))},r.onmessage=e=>{const r=JSON.parse(e.data);n(`node ws ${t} onmessage`,r),s.next(r.result)},r.onerror=e=>{n(`node ws ${t} error`,{error:e}),s.error(e)},r.onclose=()=>{n(`node ws ${t} closed`),s.complete()},()=>{r.close()}}))}(e,(a=e,`tm.event='Tx' AND transfer.recipient='${a}'`),((t,e)=>this.cyblogCh.info(t,{unit:"node-ws",...e}))).pipe((0,et.p)((t=>!(0,St.isEmpty)(t))),(0,y.T)((t=>({source:"node",transactions:Bt(e,t)}))));var a;return(0,bt.h)(s,r)}createInitObservable(){return(0,wt.v)((()=>(0,vt.H)(this.initSync())))}async initSync(){const{myAddress:t}=this.params,{signal:e}=this.abortController,n=await this.db.getSyncStatus(t,t),s=await this.syncTransactions(t,t,n);this.statusApi.sendStatus("in-progress","sync my chats");const r=await ne(this.db,t,n.timestampUpdate,e);return this.channelApi.postSenseUpdate(r),this.statusApi.sendStatus("active"),s}async onUpdate({source:t,transactions:e},n){const{myAddress:s}=n,{signal:r}=this.abortController;if(0===e.length)return void this.cyblogCh.info(`>>> ${this.name} ${s} recived 0 updates `);const a=await this.db.getSyncStatus(s,s);await this.processBatchTransactions(s,s,e,a,t),this.statusApi.sendStatus("in-progress","sync my chats");const i=await ne(this.db,s,a.timestampUpdate,r,"node"!==t);this.channelApi.postSenseUpdate(i),this.statusApi.sendStatus("listen")}async processBatchTransactions(t,e,n,{timestampRead:s,unreadCount:r,timestampUpdate:a},i){const{signal:o}=this.abortController,c="node"!==i;this.cyblogCh.info(`   syncTransactions - process ${e}[${i}],  count: ${n.length}, from: ${n.at(0)?.timestamp}, to: ${n.at(-1)?.timestamp}`),await Tt(this.db.putTransactions,o)(n),this.syncLinks(n,o);const{hash:u,index:d,timestamp:l}=n.at(-1),p=l,m={ownerId:t,entryType:w.transactions,id:e,timestampUpdate:c?p:a,unreadCount:r+n.length,timestampRead:s||0,disabled:!1,meta:{transactionHash:u,index:d}};return await Tt(this.db.putSyncStatus,o)(m),p}async syncTransactions(t,e,n){const{unreadCount:s,timestampUpdate:r}=n,a=r+1;this.statusApi.sendStatus("estimating");const i=await(async(t,e,n)=>{const s=await Jt(n).request(Mt,{address:`{${t}}`,timestamp:(0,$t.jb)(e)});return s?.messages_by_address_aggregate.aggregate?.count})(e,a,this.abortController.signal);if(this.cyblogCh.info(`>>> syncTransactions - start ${e},  count: ${i}, from: ${a}`),0===i)return a;this.statusApi.sendStatus("in-progress",`sync ${e}...`,this.progressTracker.start(Math.ceil(i/500)));const o=(({neuron:t,timestampFrom:e,types:n,orderDirection:s,limit:r,abortSignal:a})=>ot(te,{neuron:t,timestampFrom:e,types:n,orderDirection:s,limit:r,abortSignal:a}))({neuron:e,timestampFrom:a,types:[],orderDirection:"asc",limit:500,abortSignal:this.abortController?.signal});let c=0,u=a;for await(const r of o){this.statusApi.sendStatus("in-progress",`sync ${e}...`,this.progressTracker.trackProgress(1)),c+=r.length;const a=r.map((t=>At(e,t)));u=await this.processBatchTransactions(t,e,a,{...n,unreadCount:s+c},"indexer")}return u}async syncLinks(t,e){const{tweets:n,particlesFound:s,links:a}=function(t){const e=t.filter((t=>"cyber.graph.v1beta1.MsgCyberlink"===t.type)),n=new Set,s=[];return{tweets:e.reduce(((t,{value:e,hash:r,timestamp:a})=>(e.links.forEach((i=>{n.add(i.to),n.add(i.from);const o={...i,timestamp:a,neuron:e.neuron,transactionHash:r};s.push(o),i.from===lt&&(t[o.to]=o)})),t)),{}),particlesFound:[...n],links:s}}(t);a.length>0&&await it(a,(t=>Tt(this.db.putCyberlinks,e)(t)),500);const i=Object.keys(n),o=s.filter((t=>!i.includes(t)));await this.particlesResolver.enqueueBatch(i,S.particle,r.HIGH),o.length>0&&await this.particlesResolver.enqueueBatch(o,S.particle,r.LOW)}};const pe=t=>t.replace(/([-_][a-z])/g,(t=>t.toUpperCase().replace("-","").replace("_","")));function me(t){if(!t||"object"!=typeof t)return t;const e={};return Object.keys(t).forEach((n=>{if(Object.prototype.hasOwnProperty.call(t,n)){const s=pe(n);let r=t[n];Array.isArray(t[n])?r=t[n].map((t=>me(t))):"object"==typeof t[n]?r=me(t[n]):"string"==typeof t[n]&&(r=r.replace(/\\r/g,"\r").replace(/\\n/g,"\n").replace(/\\'/g,"'").replace(/\\''/g,'"').replace(/\\\\/g,"\\").replace(/\\!!/g,"#")),e[s]=r}})),e}function he(t,e,n=0,s=0){const r=t.filter((t=>t.timestamp>n)),a=(0,St.findLastIndex)(r,(t=>t.neuron===e)),i=a<0?s+r.length:r.length-a-1;return{timestampRead:a<0?n:t[a].timestamp,unreadCount:i}}function ge(t,e,n,s=!0){const{timestampRead:r,unreadCount:a}=he(e,n,t.timestampRead,t.unreadCount),i=me(e[e.length-1]),o=i.timestamp;return{...t,ownerId:n,entryType:w.particle,disabled:!1,unreadCount:a,meta:{...i,timestamp:o},timestampRead:r,timestampUpdate:s?o:t.timestampUpdate}}const ye=t=>t instanceof DOMException&&"AbortError"===t.name;var fe=n(45426),be=n(96083),we=n(15373),ve=n(81080),Se=n(33160),$e=n(96763);var xe=class extends oe{constructor(t,e,n,s,{warmupMs:r}={warmupMs:0}){super(t,n,s);const{loop$:i,restartLoop:o}=((t,e,n={})=>{const{intervalMs:s,warmupMs:r=0,onStartInterval:i,onError:o,retryDelayMs:c=0,onChange:u}=n,d=new a.B,l=d.pipe((0,se.Z)(null),(0,re.n)((()=>(0,be.Y)(s).pipe((0,se.Z)(0),(0,we.c)(r)))));return{loop$:ce(t,l.pipe((0,tt.M)((()=>i&&i())),(0,ve.p)((()=>e.pipe((0,Se.L)({delay:t=>($e.log("retry",t),o&&o(t),(0,be.Y)(c))}))))),(t=>u?.(t))),restartLoop:()=>{d.next()}}})(this.isInitialized$,(0,wt.v)((()=>(0,vt.H)(this.doSync()))),{intervalMs:e,warmupMs:r,onError:e=>{this.cyblogCh.info(`>>> ${t} error`,e.toString()),this.statusApi.sendStatus("error",e.toString())},onChange:e=>{this.cyblogCh.info(`>>> ${t} initialized: ${e}`),this.statusApi.sendStatus(e?"initialized":"inactive")}});this.loop$=i,this.restartLoop=o}restart(){this.abortController?.abort(),this.restartLoop?.(),this.cyblogCh.info(`>>> ${this.name} loop restart`)}start(){return this.loop$.subscribe((()=>this.statusApi.sendStatus("active"))),this}async doSync(){const t=(0,fe.o8B)(this.params);this.initAbortController();try{await this.sync(t)}catch(e){const n=ye(e);if(this.cyblogCh.info(`>>> ${this.name} ${t.myAddress} sync error [abrt:${n}]:`,{error:e}),!n)throw e}}};var _e=class extends xe{createIsInitializedObserver(t){return(0,g.z)([t.dbInstance$,t.ipfsInstance$,t.params$.pipe((0,y.T)((t=>t.myAddress)),(0,ft.F)()),this.particlesResolver.isInitialized$]).pipe((0,y.T)((([t,e,n,s])=>!!(e&&t&&s&&n))))}async sync(t){const{myAddress:e}=t,{signal:n}=this.abortController;this.statusApi.sendStatus("estimating");const s=await this.db.findSyncStatus({ownerId:e,entryType:w.particle}),r=s.at(0)?.timestampUpdate||0,a=await(async(t,e,n,s)=>{const r=await Jt(s).request(Pt,{address:t,particles_from:e,timestamp:(0,$t.jb)(n)});return r.cyberlinks_aggregate.aggregate?.count})(e,[lt],r,n);if(this.cyblogCh.info(`>>> syncMyParticles ${e} count ${a}`),this.progressTracker.start(a+s.length),this.statusApi.sendStatus("in-progress","preparing...",this.progressTracker.progress),a>0){const t=await this.fetchNewTweets(e,r,n);s.push(...t)}await this.syncParticles(e,s,n)}async fetchNewTweets(t,e,n){const s=await Yt(t,[lt],e,200,this.abortController?.signal),r=[],a=await this.db.findSyncStatus({ownerId:t,entryType:w.particle}),i=new Map(a.map((t=>[t.id,t])));for await(const e of s){this.statusApi.sendStatus("in-progress","fetching new tweets...",this.progressTracker.trackProgress(1));const s=e.map(me).map((e=>{const{timestamp:n,to:s}=e,r=(0,$t.$Y)(n),a=i.get(s)?(0,$t.$Y)(n):0;return{ownerId:t,id:s,entryType:w.particle,timestampUpdate:a,timestampRead:r,unreadCount:0,disabled:!1,meta:{...e,timestamp:r}}}));s.length>0&&(await Tt(this.db.putSyncStatus,n)(s),r.push(...s))}return r}async syncParticles(t,e,n){const s=[];for(const a of e){const{id:e,timestampUpdate:i}=a;this.statusApi.sendStatus("in-progress","fetching tweet updates...",this.progressTracker.trackProgress(1));const o=await Kt(e,i,this.particlesResolver,r.MEDIUM,this.abortController?.signal);if(o.length>0){const e=o.map(Ct);await it(e,(t=>Tt(this.db.putCyberlinks,n)(t)),500);const r=ge(a,e,t);s.push(r)}}s.length>0&&await Tt(this.db.putSyncStatus,n)(s),this.channelApi.postSenseUpdate(s)}};var Ae=class extends xe{constructor(t,e,n,s,{warmupMs:r}={warmupMs:0}){if(!n.followings$)throw new Error("followings$ is required");super(t,e,n,s,{warmupMs:r}),this.followings=[]}createIsInitializedObserver(t){const e=new i.t(!1);t.params$?.pipe((0,y.T)((t=>t.myAddress)),(0,ft.F)()).subscribe((()=>{e.next(!1)})),t.followings$.subscribe((t=>{this.followings=t,e.next(!0),this.restart()}));return(0,g.z)([t.dbInstance$,t.params$,this.particlesResolver.isInitialized$,e]).pipe((0,y.T)((([t,e,n,s])=>!!t&&!!e.myAddress&&!!n&&s)))}async sync(t){const{signal:e}=this.abortController;this.statusApi.sendStatus("in-progress","preparing...");const{myAddress:n}=t,{followings:s}=this;this.statusApi.sendStatus("estimating"),this.cyblogCh.info(`>>> syncMyFriends ${n} count ${s.length}`,{unit:"friends-sync",data:s}),this.progressTracker.start(s.length),this.statusApi.sendStatus("in-progress","sync...",this.progressTracker.progress);for(const t of s)await this.syncLinks(n,t,e)}async syncLinks(t,e,n){let s=[];try{this.statusApi.sendStatus("in-progress",`starting sync ${e}...`,this.progressTracker.progress);const{timestampRead:a,unreadCount:i,meta:o}=await this.db.getSyncStatus(t,e),{timestampUpdateChat:c=0,timestampUpdateContent:u=0}=o||{},d=u+1,l=await Yt(e,mt,d,200,n);for await(const o of l){this.statusApi.sendStatus("in-progress",`sync ${e}...`,this.progressTracker.trackProgress(1));const u=o.map(Ct),{timestampRead:d,unreadCount:l}=he(u,t,a,i);if(u.length>0){const a=me(u.at(-1)),i=a.timestamp;await Tt(this.db.putCyberlinks,n)(u);const o=u.map((t=>t.to));await this.particlesResolver.enqueueBatch(o,S.particle,r.HIGH);const p={ownerId:t,entryType:w.chat,id:e,timestampUpdate:Math.max(i,c),unreadCount:l,timestampRead:d,disabled:!1,meta:{...a,timestampUpdateContent:i,timestampUpdateChat:c}};await Tt(this.db.putSyncStatus,n)(p),s.push(p)}}}catch(t){if(this.cyblogCh.error(`>>> SyncMyFriends ${e} error`,{error:t}),ye(t))throw s=[],t;this.statusApi.sendStatus("error",t.toString())}finally{this.channelApi.postSenseUpdate(s)}}},Ce=n(46926),Te=n(33110);n(96763);const ke=(0,ae.S)({thread:"bckd",unit:"fetchStoredSyncCommunity"}),Ee=(t,e,n,s)=>new u.c((a=>{a.next({action:"reset",items:[]}),(async()=>{const i=await t.getCommunity(e);a.next({action:"add",items:i});const o=new Map(i.map((t=>[t.particle,t]))),c=t=>o.get(t)||{ownerId:e,name:"",following:!1,follower:!1},u=await(async(t,e)=>{const n=await(0,Te.I0)({events:[{key:"cyberlink.neuron",value:t},{key:"cyberlink.particleFrom",value:pt}],pagination:{limit:1e9},config:{signal:e}});return n.txResponses.length?n.txResponses.map((t=>t?.tx?.body.messages[0].links[0].to)):[]})(e,s),d=await(async(t,e)=>{const n=await(0,Ce.N)(t),s=await(0,Te.I0)({events:[{key:"cyberlink.particleFrom",value:pt},{key:"cyberlink.particleTo",value:n}],pagination:{limit:1e9},config:{signal:e}});return s.txResponses.length?s.txResponses.map((t=>t?.tx?.body.messages[0].neuron)):[]})(e,s),l=u.filter((t=>!i.some((e=>e.particle===t&&e.following)))),p=d.filter((t=>!i.some((e=>e.neuron===t&&e.follower))));ke.info(`>>>$ sync community ${e} processing, stored ${i.length} new followers: ${l.length} new following: ${p.length}`);const m=await Promise.all(p.map((async e=>{const n=await(0,Ce.N)(e),s={...c(n),particle:n,neuron:e,follower:!0};return await t.putCommunity(s),o.set(n,s),s})));a.next({action:"add",items:m}),await Promise.all(l.map((async e=>{const s=(await n(e,r.URGENT))?.result?.textPreview;if(s&&s.match(dt.d5)){const n={...c(e),neuron:s,particle:e,following:!0};await t.putCommunity(n),o.set(e,n),a.next({action:"add",items:[n]})}}))),ke.info(`>>>$ sync community ${e}, done`),a.next({action:"complete",items:[]}),a.complete()})().catch((t=>{ke.error(`>>>$ sync community ${e}, error`,{error:t}),a.error(t)}))}));var Ie=n(96763);var Pe=class{constructor(t,e){this.channel=new BroadcastChannel(G),this.particlesResolver=t,e.subscribe((t=>{this.dbInstance$.next(t)})),this.dbInstance$=new i.t(void 0),this.channel.onmessage=t=>this.onMessage(t),this.channel.onmessageerror=t=>Ie.error(`${G} error`,t)}async getDeffredDbApi(){return new Promise((t=>{const e=this.dbInstance$.getValue();e&&t(e),this.dbInstance$.pipe((0,X.$)((t=>void 0!==t))).subscribe((e=>{t(e)}))}))}async saveLinks(t){const e=await this.getDeffredDbApi();await e.putCyberlinks(t)}async saveParticles(t){try{const e=await this.getDeffredDbApi(),n=(t=>{const{cid:e,meta:n,textPreview:s}=t,{size:r,mime:a,type:i,blocks:o,sizeLocal:c}=n;var u;return{cid:e,size:r||0,mime:a||"unknown",type:i,text:s?(u=function(t){let e=t.replace(/^#{1,6}\s+/gm,"");return e=e.replace(/(\*\*|__)(.*?)\1/g,"$2"),e=e.replace(/(\*|_)(.*?)\1/g,"$2"),e=e.replace(/(~~)(.*?)\1/g,"$2"),e=e.replace(/`{1,3}[^`](.*?)`{1,3}/g,"$1"),e=e.replace(/```[\s\S]*?```/g,""),e=e.replace(/^\s{0,3}>\s?/gm,""),e=e.replace(/\[(.*?)\]\(.*?\)/g,"$1"),e=e.replace(/!\[(.*?)\]\(.*?\)/g,"$1"),e=e.replace(/^-{3,}$/gm,""),e=e.replace(/^\s*[-+*]\s+/gm,""),e=e.replace(/^\s*\d+\.\s+/gm,""),e=e.replace(/\n{2,}/g,"\n\n"),e=e.replace(/^\s+|\s+$/g,""),e}(s),u.replace(/"/g,"'")):"",size_local:c||-1,blocks:o||0}})(t);(await e.putParticles(n)).ok&&await ut(t)}catch(e){throw Ie.log("---saveParticle e",t,t.textPreview,e.toString()),e}}async enquueSync(t){await this.getDeffredDbApi(),this.particlesResolver.enqueue(Array.isArray(t)?t:[t])}onMessage(t){const{type:e,data:n}=t.data;"link"===e?this.saveLinks(n):"particle"===e?this.saveParticles(n):"sync"===e&&this.enquueSync(n)}};const Me=(0,ae.S)({thread:"bckd"});class Re{constructor(t){this.channelApi=new K,this.loops={};const{dbInstance$:e,ipfsInstance$:n}=t,s=new yt(t).start();new Pe(s,e);this.isInitialized$=(0,g.z)([e,n]).pipe((0,y.T)((([t,e])=>!!t&&!!e))),this.isInitialized$.subscribe({next:t=>t&&this.channelApi.postServiceStatus("sync","started"),error:t=>this.channelApi.postServiceStatus("sync","error",t)});const r=function(t){const{dbInstance$:e,ipfsInstance$:n,params$:s}=t,r=new K;return(0,g.z)([e,s.pipe((0,y.T)((t=>t.myAddress)),(0,ft.F)()),n]).pipe((0,et.p)((([t,e,n])=>!!t&&!!n&&!!e)),(0,re.n)((([e,n,s])=>{const{waitForParticleResolve:a}=t;let i=[];return new u.c((t=>{t.next([]),Ee(e,n,a).subscribe((({action:e,items:n})=>{r.post({type:"load_community",value:{action:e,items:n}}),"reset"===e?i=[]:["add","complete"].some((t=>t===e))&&i.push(...n),"complete"===e&&(t.next(i),t.complete())}))}))})))}(t);r.subscribe((t=>{Me.info("--\x3e community fetched",{unit:"community",data:t})}));const a=r.pipe((0,y.T)((t=>t.filter((t=>t.following)))),(0,y.T)((t=>t.map((t=>t.neuron)))));new le("transactions",t,s).start(),new _e("particles",3e5,t,s).start(),new Ae("my-friends",3e5,{...t,followings$:a},s).start()}restart(t){this.loops[t]?.restart()}}var Oe=n(19823),Le=n(56978),ze=n(90593),De=n(13288),qe=n(66847),Ne=n(62467),Be=n(44008),Ue=n(44554),Fe=n(96763);const je=async t=>{if(!t)return"unknown";const e=await(0,Ue.BI)(t);return e?.mime||"text/plain"};const He=new(n(65823).Ay)("cyber-page-cash");He.version(3).stores({cid:"cid",following:"cid"});var Qe=He;var We={add:async(t,e)=>{if(!await Qe.table("cid").get({cid:t})){const n={cid:t,data:e};Qe.table("cid").add(n)}},get:async t=>{const e=await Qe.table("cid").get({cid:t});return e?.data||e?.content}},Je=n(27894);const Ze="QmUgmRxoLtGERot7Y6G7UyF6fwvnusQZfGR15PuE6pY3aB",Ve=`/dns4/swarm.io.cybernode.ai/tcp/443/wss/p2p/${Ze}`,Ye=`/ip4/88.99.105.146/tcp/4001/p2p/${Ze}`,Ge="https://gateway.ipfs.cybernode.ai";var Ke=(()=>{const t=new Je.d2("https://io.cybernode.ai");return{add:async e=>{const n="string"==typeof e?new File([e],"file.txt"):e;return t.add(n,{cidVersion:0,rawLeaves:!1})},status:async e=>t.status(e)}})(),Xe=n(98067),tn=n(82202),en=n.n(tn),nn=n(62045).hp;function sn(t,e){const n=new Blob([t],{type:e});return URL.createObjectURL(n)}function rn(t,e){return`data:${e};base64,${(0,Xe.d)(t,"base64")}`}const an=t=>{if(t){if(t.includes("video"))return"video";if(t.includes("audio"))return"audio";if(t.includes("epub"))return"epub"}},on=/\s?<!doctype html>|(<html\b[^>]*>|<body\b[^>]*>|<x-[^>]+>)+/i;const cn=t=>{if(!t)return"other";const e=an(t);return e||(-1!==t.indexOf("text/plain")||-1!==t.indexOf("application/xml")?"text":-1!==t.indexOf("image")?"image":-1!==t.indexOf("application/pdf")?"pdf":"other")},un=async(t,e,n)=>{if(!t||!t?.result)return{gateway:!0,text:e.toString(),cid:e};const{result:s,meta:r}=t,{mime:a,contentType:i}=r;if(!a)return{cid:e,gateway:!0,text:`Can't detect MIME for ${e.toString()}`};const o={link:`/ipfs/${e}`,gateway:!1,cid:t.cid,type:i};if(an(a))return{...o,gateway:!0};const c="string"!=typeof s?await(async(t,e)=>{let n=0;try{if(t instanceof Uint8Array)return e&&e(t.byteLength),t;const s=[];if(t instanceof ReadableStream){const r=t.getReader(),a=async({done:t,value:i})=>t?(0,Be.x)(s):(s.push(i),n+=i.byteLength,e&&e(n),r.read().then(a));return await r.read().then(a)}if(Symbol.asyncIterator in t){const r=t[Symbol.asyncIterator]();for await(const t of r)t instanceof Uint8Array&&(s.push(t),n+=t.byteLength,e&&e(n));return(0,Be.x)(s)}return}catch(t){return void Fe.error("Error reading stream/iterable.\r\n Probably Hot reload error!",t)}})(s,n):s,u="string"==typeof c;if(!c)return{...o,gateway:!0,text:`Can't parse content for ${e.toString()}`};if("text"===o.type){if(!u&&en()(nn.from(c)))return{...o,type:"image",content:rn(c,"image/svg+xml")};const t=u?c:(0,Xe.d)(c);return t.match(dt.rP)?{...o,type:"cid",content:t}:t.match(dt.mt)?{...o,type:"link",content:t}:function(t){const e=t.trim().slice(0,1e3);return on.test(e)}(t)?{...o,type:"html",gateway:!0,content:e.toString()}:{...o,link:t.length>42?`/ipfs/${e}`:`/search/${t}`,type:"text",text:xt(t),content:t}}if(!u){if("image"===o.type)return{...o,content:rn(c,a)};if("pdf"===o.type)return{...o,content:sn(c,a),gateway:!0}}return o},dn=(t,e,n=150)=>{if(t)return"string"==typeof t?t.slice(0,n):e&&"text"===e?(0,Xe.d)(t).slice(0,n):void 0};var ln=n(96763);const pn=async t=>{const e=await We.get(t);if(e&&e.length){const n=await je(e),s=cn(n),r=dn(e,s);return{result:e,cid:t,meta:{type:"file",size:e.length,sizeLocal:e.length,mime:n,contentType:s},source:"db",textPreview:r}}},mn={type:"file",size:void 0,sizeLocal:void 0,blocks:void 0},hn=async(t,e,n)=>{if(e){return await e.stat(t,{signal:n})}return mn},gn=async(t,e,n)=>{const s=n||new AbortController,{signal:r}=s;let a;if(e){n||(a=setTimeout((()=>{s.abort()}),6e4));try{const n=Date.now(),s=await hn(t,e,r),i=s,o=Date.now();i.statsTime=o-n;const c=!!s.size&&s.size<2e7;if(a&&clearTimeout(a),"directory"===s.type)return{cid:t,availableDownload:!0,source:"node",meta:s};{const{value:n}=await e.cat(t,{signal:r,length:2048,offset:0})[Symbol.asyncIterator]().next();i.mime=await je(n),i.contentType=cn(i.mime);const a=s.size&&s.size>-1&&n.length>=s.size,u=dn(n,i.contentType);a&&await We.add(t,(0,Be.x)([n]));const d=a?n:c?e.cat(t,{signal:r}):void 0;return i.catTime=Date.now()-o,!i.local&&c?(e.pin(t),i.pinTime=Date.now()-i.catTime):i.pinTime=-1,{result:d,textPreview:u,cid:t,meta:i,source:"node"}}}catch(e){return ln.debug("error fetchIPFSContentFromNode",e),{cid:t,availableDownload:!0,source:"node",meta:{...mn}}}}else ln.log("--------fetchIPFSContentFromNode NO NODE INTIALIZED--------")},yn=async(t,e,n,s)=>{const r="external"===e?.nodeType,a=r?await hn(t,e,n?.signal):mn,i=`${Ge}/ipfs/${t}`,o=await fetch(i,{method:"GET",signal:n?.signal,headers:s});if(o&&o.body){const e=e=>r?Promise.resolve():We.add(t,(0,Be.x)(e)),{mime:n,result:s,firstChunk:c}=await async function(t,e){const[n,s]=t.tee(),r=[],a=n.getReader(),{value:i}=await a.read(),o=i?await je(i):void 0,c=s.getReader(),u={async*[Symbol.asyncIterator](){for(;;){const{done:t,value:n}=await c.read();if(t)return void(e&&e(r,o));e&&r.push(n),yield n}}};return{mime:o,result:u,firstChunk:i}}(o.body,e),u=cn(n),d=dn(c,u);return{cid:t,textPreview:d,meta:{...a,mime:n,contentType:u},result:s,source:"gateway",contentUrl:i}}};const fn=async(t,e,n,s)=>{const r=await pn(t);if(void 0!==r)return r;if(e){s&&s("trying to get with a node");return await gn(t,e,n)}s&&s("trying to get with a gatway");return await yn(t,e,n)},bn=async(t,e)=>{let n;return t&&(n=await t.add(e)),Ke.add(e),n&&await We.add(n,await(async t=>new Uint8Array("string"==typeof t?nn.from(t):await t.arrayBuffer()))(e)),n};var wn=n(96763);class vn{constructor(t,e){this.settings=t,this.order=e}getNextSource(t){const e=this.order.indexOf(t);return e<this.order.length?this.order[e+1]:void 0}}class Sn extends Error{constructor(t){super(`Timeout after ${t}`),Object.setPrototypeOf(this,Sn.prototype)}}const $n="X-Cyb-Source";var xn=(t=>(t.sharedWorker="shared-worker",t))(xn||{}),_n=n(96763);function An(t){return(t.priority||0)+(t.viewPortPriority||0)}const Cn={external:new vn({db:{timeout:5e3,maxConcurrentExecutions:999},node:{timeout:6e4,maxConcurrentExecutions:30},gateway:{timeout:1e4,maxConcurrentExecutions:11}},["db","node","gateway"]),embedded:new vn({db:{timeout:5e3,maxConcurrentExecutions:999},node:{timeout:6e4,maxConcurrentExecutions:30},gateway:{timeout:21e3,maxConcurrentExecutions:11}},["db","gateway","node"]),helia:new vn({db:{timeout:5e3,maxConcurrentExecutions:999},node:{timeout:6e4,maxConcurrentExecutions:50},gateway:{timeout:1e4,maxConcurrentExecutions:11}},["db","node","gateway"])};var Tn=class{constructor(t,{strategy:e,queueDebounceMs:n}){this.queue$=new i.t(new Map),this.node=void 0,this.lastNodeCallTime=Date.now(),this.channel=new K,this.executing={db:new Set,node:new Set,gateway:new Set},t.subscribe((t=>{t&&this.setNode(t)})),this.strategy=e||Cn.embedded,this.queueDebounceMs=n||33,(0,be.Y)(15e3).pipe((0,et.p)((()=>!!this.node&&!![...this.queue$.value.values()].find((t=>"node"===t.source))))).subscribe((()=>{this.node.reconnectToSwarm(!0)}));const s=(0,g.z)([t]).pipe((0,y.T)((([t])=>!!t&&t?.isStarted)),(0,ft.F)(),(0,rt.u)());s.subscribe((t=>{t&&_n.log(" ipfs queue initialized"),this.node?.reconnectToSwarm(!0)})),this.queue$.pipe((0,Oe.E)(s),(0,et.p)((([,t])=>t)),(0,Le.B)(this.queueDebounceMs),(0,y.T)((([t])=>this.cancelDeprioritizedItems(t))),(0,nt.Z)((t=>{const e=this.getItemBySourceAndPriority(t);return e.length>0?(this.node?.reconnectToSwarm(!1),(0,bt.h)(...e.map((t=>this.fetchData$(t))))):st.w}))).subscribe((({item:t,status:e,source:n,result:s})=>{const{cid:r}=t,a=this.queue$.value.get(r)?.callbacks||[];if(a.map((t=>t(r,e,n,s))),"node"===n&&(this.lastNodeCallTime=Date.now()),this.executing[n].delete(r),"completed"===e||"cancelled"===e)this.removeAndNext(r);else{const e=this.strategy.getNextSource(n);e?this.switchSourceAndNext(t,e):(this.removeAndNext(r),a.map((t=>t(r,"not_found",n,s))))}this.postSummary()}))}switchStrategy(t){this.strategy=t}async setNode(t,e){_n.log(`* switch node from ${this.node?.nodeType||"<none>"} to ${t.nodeType}`),this.node=t,this.switchStrategy(e||Cn[t.nodeType])}getItemBySourceAndPriority(t){const e=[...t.values()].filter((t=>"pending"===t.status)),n=fe.$zQ((t=>t.source),e),s=[];for(const[t,e]of Object.entries(n)){const n=this.strategy.settings[t].maxConcurrentExecutions-this.executing[t].size,r=e.sort(((t,e)=>An(e)-An(t))).slice(0,n);s.push(...r)}return s}postSummary(){const t=`(total: ${this.queue$.value.size} |  db - ${this.executing.db.size} node - ${this.executing.node.size} gateway - ${this.executing.gateway.size})`;this.channel.postServiceStatus("ipfs","started",t)}fetchData$(t){const{cid:e,source:n,callbacks:s,controller:r}=t,a=this.strategy.settings[n];this.executing[n].add(e),this.postSummary();const i=this.queue$.value.get(e);return this.queue$.value.set(e,{...i,status:"executing",executionTime:Date.now(),controller:new AbortController}),s.map((t=>t(e,"executing",n))),(o=async()=>async function(t,e,n){const{node:s,controller:r,headers:a}=n;try{switch(e){case"db":return pn(t);case"node":return gn(t,s,r);case"gateway":return yn(t,s,r,a);default:return}}catch(t){return void ln.log("----fetchIpfsContent error",t)}}(e,n,{controller:r,node:this.node,headers:{[$n]:xn.sharedWorker}}).then((t=>(t&&"db"!==n&&(t=>{ct.enqueue({type:"particle",data:{...t,result:void 0}})})(t),t))),new u.c((t=>{o().then((e=>{t.next(e),t.complete()})).catch((e=>{wn.debug("----promiseToObservable error",e),t.error(e)}))}))).pipe((0,ze.w)({each:a.timeout,with:()=>(0,De.$)((()=>(r?.abort("timeout"),new Sn(a.timeout))))}),(0,y.T)((e=>({item:t,status:e?"completed":"error",source:n,result:e}))),(0,qe.W)((e=>e instanceof Sn?(0,Ne.of)({item:t,status:"timeout",source:n}):"AbortError"===e?.name?(0,Ne.of)({item:t,status:"cancelled",source:n}):(0,Ne.of)({item:t,status:"error",source:n}))));var o}mutateQueueItem(t,e){const n=this.queue$.value,s=n.get(t);return s&&n.set(t,{...s,...e}),this.queue$.next(n)}removeAndNext(t){const e=this.queue$.value;e.delete(t),this.queue$.next(e)}switchSourceAndNext(t,e){t.callbacks.map((n=>n(t.cid,"pending",e))),this.mutateQueueItem(t.cid,{status:"pending",source:e})}cancelDeprioritizedItems(t){return["node","gateway"].forEach((e=>{Array.from(this.executing[e]).forEach((n=>{const s=t.get(n);s&&An(s)<0&&s.controller&&(s.controller.abort("cancelled"),s.callbacks.map((t=>t(s.cid,"pending",s.source))),t.set(n,{...s,status:"pending"}),this.executing[e].delete(n))}))})),t}releaseExecution(t){Object.keys(this.executing).forEach((e=>this.executing[e].delete(t)))}enqueue(t,e,n={}){const s=this.queue$.value,r=s.get(t);if(r)this.mutateQueueItem(t,{callbacks:[...r.callbacks,e]});else{const r=n.initialSource||this.strategy.order[0],a={cid:t,callbacks:[e],source:r,status:"pending",postProcessing:!0,...n};e(t,"pending",r),s.set(t,a),this.queue$.next(s)}}enqueueAndWait(t,e={}){return new Promise((n=>{this.enqueue(t,((t,e,s,r)=>{"completed"!==e&&"not_found"!==e||n({status:e,source:s,result:r})}),e)}))}updateViewPortPriority(t,e){this.mutateQueueItem(t,{viewPortPriority:e})}cancel(t){const e=this.queue$.value.get(t);e&&(e.controller?e.controller.abort("cancelled"):this.removeAndNext(t))}cancelByParent(t){const e=this.queue$.value;e.forEach(((n,s)=>{n.parent===t&&(this.releaseExecution(s),n.controller?.abort("cancelled"),e.delete(s))})),this.queue$.next(e)}clear(){const t=this.queue$.value;t.forEach(((e,n)=>{this.releaseExecution(n),e.controller?.abort("cancelled"),t.delete(n)})),this.queue$.next(new Map)}getQueueMap(){return this.queue$.value}getQueueList(){return Array.from(this.queue$.value.values())}getStats(){return fe.FsL(fe.TrE(fe._w2("status")),fe.xcu,fe.TjK(fe.FAy(["status","count"])))(this.getQueueList())}},kn=n(4816),En=n(2597),In=n(75946);const Pn=t=>In.TO.parse(t),Mn=t=>`/ipfs/${t}`;var Rn=n(96763);var On=class{constructor(){this.nodeType="external",this._config={},this._isStarted=!1}get config(){return this._config}get isStarted(){return this._isStarted}async initConfig(){const t=await this.node.config.get("Addresses.Gateway");if(!t)return{gatewayUrl:Ge};const e=(0,En.HZ)(t).nodeAddress();return{gatewayUrl:`http://${e.address}:${e.port}`}}async init(t){this.node=(0,kn.vt)(t),this._config=await this.initConfig(),"undefined"!=typeof window&&(window.node=this.node,window.toCid=Pn),Rn.log("IPFS - Kubo addrs",(await this.node.swarm.localAddrs()).map((t=>t.toString()))),this._isStarted=!0}async stat(t,e={}){return this.node.files.stat(Mn(t),{...e,withLocal:!0,size:!0}).then((t=>{const{type:e,size:n,sizeLocal:s,local:r,blocks:a}=t;return{type:e,size:n||-1,sizeLocal:s||-1,blocks:a}}))}cat(t,e={}){return this.node.cat(Pn(t),e)}async add(t,e={}){return(await this.node.add(t,e)).cid.toString()}async pin(t,e={}){return(await this.node.pin.add(Pn(t),e)).toString()}async getPeers(){return(await this.node.swarm.peers()).map((t=>t.peer.toString()))}async stop(){}async start(){}async connectPeer(t){const e=(0,En.HZ)(t);return await this.node.bootstrap.add(e),await this.node.swarm.connect(e),!0}ls(){return this.node.pin.ls()}async info(){const{repoSize:t}=await this.node.stats.repo(),e=await this.node.id(),{agentVersion:n,id:s}=e;return{id:s.toString(),agentVersion:n,repoSize:t}}},Ln=n(98730),zn=n(93439),Dn=n(96059),qn=n(93379),Nn=n(86320),Bn=n(84419),Un=n(41908),Fn=n(19213),jn=n(49736),Hn=n(13231),Qn=n(52049),Wn=n(98010),Jn=n(61336),Zn=n(96763);const Vn={cidVersion:0,rawLeaves:!1};var Yn=class{constructor(){this.nodeType="helia",this._isStarted=!1}get config(){return{gatewayUrl:Ge}}get isStarted(){return this._isStarted}async init(){const t=new zn.E("helia-bs");await t.open();const e=new Dn.t("helia-ds");await e.open();const n=await(async(t,e=[])=>await(0,qn.E)({datastore:t,transports:[(0,Qn.h)(),(0,Wn.q)(),(0,Hn.c)({rtcConfiguration:{iceServers:[{urls:["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478","STUN:freestun.net:3479","STUN:stun.bernardoprovenzano.net:3478","STUN:stun.aa.net.uk:3478"]},{credential:"free",username:"free",urls:["TURN:freestun.net:3479","TURNS:freestun.net:5350"]}]}}),(0,Hn.b)(),(0,Un.y)({discoverRelays:1})],connectionEncryption:[(0,Nn.f)()],streamMuxers:[(0,Bn.N)()],connectionGater:{denyDialMultiaddr:()=>!1},peerDiscovery:[(0,jn.N)({list:e})],services:{identify:(0,Jn.iQ)()}}))(e,["/dnsaddr/bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN","/dnsaddr/bootstrap.libp2p.io/p2p/QmQCU2EcMqAqQPR2i9bChDtGNJchTbq5TbXJJ16u19uLTa","/dnsaddr/bootstrap.libp2p.io/p2p/QmbLHAnMoJPWSCR5Zhtx6BHJX9KiKNN6tpvbUcqanj75Nb","/dnsaddr/bootstrap.libp2p.io/p2p/QmcZf59bWwK5XFi76CZX8cbJ4BhTzzA3gU1ZjYZcYW3dwt","/dns4/swarm.io.cybernode.ai/tcp/443/wss/p2p/QmUgmRxoLtGERot7Y6G7UyF6fwvnusQZfGR15PuE6pY3aB"]);this.node=await(0,Ln.g)({blockstore:t,datastore:e,libp2p:n}),this.fs=(0,Fn.Si)(this.node),"undefined"!=typeof window&&(window.libp2p=n,window.node=this.node,window.fs=this.fs,window.toCid=Pn),n.addEventListener("peer:connect",(t=>{const e=t.detail.toString(),s=n.getConnections(e)||[],r=Object.fromEntries(s.map((t=>[t.remoteAddr.toString(),t.remoteAddr.protoCodes().map((t=>(0,En.WH)(t)?.name))])));Zn.debug(`Connected to ${e}`,r)})),n.addEventListener("peer:disconnect",(t=>{Zn.debug(`Disconnected from ${t.detail.toString()}`)})),Zn.log("IPFS - Helia addrs",n.getMultiaddrs().map((t=>t.toString()))),this._isStarted=!0}async stat(t,e={}){return this.fs.stat(Pn(t),e).then((t=>{const{type:e,fileSize:n,localFileSize:s,blocks:r,dagSize:a,mtime:i}=t;return{type:e,size:n||-1,sizeLocal:s||-1,blocks:r}}))}cat(t,e={}){return this.fs.cat(Pn(t),e)}async add(t,e={}){const n={...e,...Vn};let s;if(t instanceof File){const e=t.name,r=await t.arrayBuffer(),a=new Uint8Array(r);s=await this.fs.addFile({path:e,content:a},n)}else{const e=(new TextEncoder).encode(t);s=await this.fs.addBytes(e,n)}return this.pin(s.toString(),e),s.toString()}async pin(t,e={}){const n=Pn(t);if(!await(this.node?.pins.isPinned(n,e))){(await(this.node?.pins.add(n,e)))?.cid.toString()}}async getPeers(){return this.node.libp2p.getConnections().map((t=>t.remotePeer.toString()))}async stop(){await(this.node?.stop())}async start(){await(this.node?.start())}async connectPeer(t){await this.node.libp2p.dial((0,En.HZ)(t));return!0}ls(){const t=async function*(t){for await(const e of t){const{cid:t,metadata:n}=e;yield{cid:t.toV0(),metadata:n,type:"recursive"}}}(this.node.pins.ls());return t}async info(){return{id:this.node.libp2p.peerId.toString(),agentVersion:this.node.libp2p.services.identify.host.agentVersion,repoSize:-1}}},Gn=n(84073),Kn=n(72767);var Xn=()=>({start:!0,repo:"ipfs-repo-cyber-v2",relay:{enabled:!1,hop:{enabled:!1}},preload:{enabled:!1},config:{API:{HTTPHeaders:{"Access-Control-Allow-Methods":["PUT","POST"],"Access-Control-Allow-Origin":["http://localhost:3000","http://127.0.0.1:5001","http://127.0.0.1:8888","http://localhost:8888"]}},Addresses:{Gateway:"/ip4/127.0.0.1/tcp/8080",Swarm:[],Delegates:[]},Discovery:{MDNS:{Enabled:!0,Interval:10},webRTCStar:{Enabled:!1}},Bootstrap:[],Pubsub:{Enabled:!1},Swarm:{ConnMgr:{HighWater:300,LowWater:50},DisableNatPortMap:!1},Routing:{Type:"dhtclient"}},libp2p:{transports:[(0,Qn.h)({filter:Kn.$u})],nat:{enabled:!1}},EXPERIMENTAL:{ipnsPubsub:!1}});var ts=class{constructor(){this.nodeType="embedded",this._isStarted=!1}get config(){return{gatewayUrl:Ge}}get isStarted(){return this._isStarted}async init(){this.node=await(0,Gn.vt)(Xn()),"undefined"!=typeof window&&(window.node=this.node,window.toCid=Pn),this._isStarted=!0}async stat(t,e={}){return this.node.files.stat(Mn(t),{...e,withLocal:!0,size:!0}).then((t=>{const{type:e,size:n,sizeLocal:s,local:r,blocks:a}=t;return{type:e,size:n||-1,sizeLocal:s||-1,blocks:a}}))}cat(t,e={}){return this.node.cat(Pn(t),e)}async add(t,e={}){return(await this.node.add(t,e)).cid.toString()}async pin(t,e={}){return(await this.node.pin.add(Pn(t),e)).toString()}async getPeers(){return(await this.node.swarm.peers()).map((t=>t.peer.toString()))}async stop(){}async start(){}async connectPeer(t){const e=(0,En.HZ)(t);return await this.node.bootstrap.add(e),await this.node.swarm.connect(e),!0}ls(){return this.node.pin.ls()}async info(){const t=await this.node.stats.repo(),e=Number(t.repoSize),n=await this.node.id(),{agentVersion:s,id:r}=n;return{id:r.toString(),agentVersion:s,repoSize:e}}},es=n(96763);const ns={helia:Yn,embedded:ts,external:On};async function ss(t){const{ipfsNodeType:e,...n}=t,s=function(t,e){return class extends t{async fetchWithDetails(t,e,n){const s=await fn(t,this,n),r=await un(s,t);return e?r?.type===e?r:void 0:r}async addContent(t){return bn(this,t)}async isConnectedToSwarm(){return!!(await super.getPeers()).find((t=>t===e.swarmPeerId))}async reconnectToSwarm(t=!1){await this.isConnectedToSwarm()&&!t||super.connectPeer(e.swarmPeerAddress).then((()=>(es.log(` connected to swarm - ${e.swarmPeerAddress}`),!0))).catch((t=>(es.log(`Can't connect to swarm ${e.swarmPeerAddress}: ${t.message}`),!1)))}}}(ns[e],{swarmPeerId:Ze,swarmPeerAddress:"external"===e?Ye:Ve}),r=new s;return await r.init({url:n.urlOpts}),await r.reconnectToSwarm(),r}var rs=n(96763);var as=n(16174),is=n(39741),os=n(96763);as._K2.allowLocalModels=!1;const cs={featureExtractor:{name:"feature-extraction",model:"Xenova/all-MiniLM-L6-v2"}},us=(t,e)=>{const n=new a.B,r=((t,e)=>{const n=new is.m(1);return(0,g.z)([t,e]).subscribe((([t,e])=>{if(t&&e){const r=async t=>(await e(t,{pooling:"mean",normalize:!0})).data,a=async(e,n)=>{const s=await r(e);return await t.searchByEmbedding(s,n)},i={createEmbedding:r,searchByEmbedding:a};n.next((0,s.BX)(i))}})),n})(t,n),i=async t=>{const{name:s,model:r}=cs[t],a=await((t,e,n)=>(0,as.TkF)(t,e,{progress_callback:t=>{try{const{status:s,progress:r,loaded:a,total:i}=t,o=a?`${e} - ${a}/${i} bytes`:e,c=["ready","error"].some((t=>t===s)),u={status:s,message:o,done:c,progress:r?Math.round(r):0};n(u)}catch(t){os.log("-------progresss error",e,t.toString())}}}))(s,r,(n=>e.postMlSyncEntryProgress(t,n)));"feature-extraction"===s&&n.next(a),os.log(`${t} - loaded`)},o=async()=>(e.postServiceStatus("ml","starting"),os.time(" ml initialized"),Promise.all([i("featureExtractor")]).then((t=>(setTimeout((()=>e.postServiceStatus("ml","started")),0),os.timeEnd(" ml initialized"),t))).catch((t=>e.postServiceStatus("ml","error",t.toString()))));return o(),{embeddingApi$:r,init:o}};var ds=n(21423),ls=n(54011);var ps='pub fn pass() {\n    #{ "action": "pass" }\n}\n\npub fn hide() {\n    #{ "action": "hide" }\n}\n\npub fn cid_result(cid) {\n    #{ "cid": cid, "action": "cid_result" }\n}\n\npub fn content_result(content) {\n    #{ "content": content, "action": "content_result" }\n}\n\npub fn error(message) {\n    #{ "message": message, "action": "error" }\n}\n\npub fn meta_text(text) {\n    #{ "text": text, "type": "text" }\n}\n\npub fn meta_link(url, title) {\n    #{ "url": url, "title": title, "type": "link" }\n}\n\npub async fn async_callback(data) {\n    cyb::callback(cyb::ref_id, data).await\n}\n',ms=n(15824),hs=n(96763);const gs={budget:1e6,experimental:!1,instructions:!1,options:[]},ys={readOnly:!1,execute:!0,funcName:"main",funcParams:{},params:{},input:'/*\n    Any information here, will be shown in the description of your soul.\n    [template]\n*/\n\n// CODE EXAMPLES\n\n// your content for <citizen_name>.moon domain\npub async fn moon_domain_resolver() {\n    // get nickname of domain resolver at the momemnt\n    let nickname =  cyb::context.user.nickname;\n\n    let rng = rand::WyRand::new();\n    let rand_int = rng.int_range(0, 999999);\n\n    return content_result(`Hello, ${nickname}, your lucky number is ${rand_int} `);\n\n    // substitute with some CID (ipfs hosted app in this case)\n    // return cid_result("QmcqikiVZJLmum6QRDH7kmLSUuvoPvNiDnCKY4A5nuRw17")\n}\n\n// Extend particle page with custom UI elements\npub async fn ask_companion(cid, content_type, content) {\n    // plain text item\n    let links = [meta_text("similar: ")];\n    let rows = [links];\n\n    // search closest 5 particles using local data from the brain\n    let similar_results = cyb::search_by_embedding(content, 5).await;\n\n\n    for v in similar_results {\n        // link item\n        links.push(meta_link(`/oracle/ask/${v.cid}`, v.text));\n    }\n\n    if links.len() == 1 {\n        links = [meta_text("no similar particles found")];\n    }\n\n\tlet secrets = cyb::context.secrets;\n    if let Some(api_key) = secrets.get("open_ai_key") {\n        let messages = [\n            #{\n                "role": "system",\n                "content": "You should give description or summary of any content. aswer should not exceed 32 words"\n            },\n            #{\n                "role": "user",\n                "content": content\n            }\n        ];\n\n        let inference = cyb::open_ai_completions(messages, api_key, #{"model": "gpt-3.5-turbo"}).await;\n        rows.push([meta_text(`inference: ${inference}`)]);\n    }\n\n    return content_result(rows)\n}\n\n// Transform content of the particle\npub async fn personal_processor(cid, content_type, content) {\n\n    // skip any non-text content\n    if content_type != "text" {\n        return pass()\n    }\n\n    // <citizen_name>.moon domain resolver\n    if content.ends_with(".moon") {\n        let items = content.split(".").collect::<Vec>();\n\n        let username = items[0];\n        let ext = items[1];\n\n        if username.len() <= 14 && ext == "moon" {\n\n            // get passport data by username\n            let passport = cyb::get_passport_by_nickname(username).await;\n\n            // particle - CID of soul script\n            let particle_cid = passport["extension"]["particle"];\n\n            cyb::log(`Resolve ${username} domain from passport particle \'${particle_cid}\'`);\n\n            // resolve content(script) by cid\n            // evaluate \'moon_domain_resolver\' from that\n            let result = cyb::eval_script_from_ipfs(particle_cid, "moon_domain_resolver", []).await;\n\n            return result\n        }\n    }\n\n    // example of content exclusion from the search results\n    let buzz_word = " ";\n\n    if content.contains(buzz_word) {\n        cyb::log(`Hide ${cid} item because of \'${buzz_word}\' in the content`);\n        return hide()\n    }\n\n\n    // example of content modification\n    // replaces cyber with cyber\n    let highlight_text = "cyber ";\n    let highlight_with = " ";\n\n    if content.contains(highlight_text) {\n        cyb::log(`Update ${cid} content, highlight ${highlight_text}${highlight_with}`);\n        return content_result(content.replace(highlight_text, `${highlight_text}${highlight_with}`))\n    }\n\n    // replace <token_name>@NOW (ex. bitcoin@NOW) with actual price in usdt\n    // using external api call\n    if content.contains("@NOW") {\n        let left_part = content.split("@NOW").next().unwrap();\n        let token_name = left_part.split(" ").rev().next().unwrap();\n        let vs_currency = "usd";\n\n        // external url call\n        let json =  http::get(`https://api.coingecko.com/api/v3/simple/price?ids=${token_name}&vs_currencies=${vs_currency}`).await?.json().await?;\n        return content_result(content.replace(`${token_name}@NOW`, `Current ${token_name} price is ${json[token_name][vs_currency]} ${vs_currency}`))\n    }\n\n    // anything else\n\tcontent = content.replace("", "").replace("", "").replace("", "");\n\n    content_result(content)\n}',script:ps};const fs=function(){let t={},e={params:{},user:{},secrets:{}};const n=new i.t(!1),s=new i.t({}),r=new Map,a=new is.m(1);(0,g.z)([n,s]).pipe((0,y.T)((([t,e])=>!(!t||!e.particle))),(0,ft.F)()).subscribe((t=>{a.next(t)})),s.subscribe((e=>{t=e}));const o=async(t,n,s,a={})=>{const i=(0,ls.A)().toString();s&&r.set(i,s);const o={...ys,...n,input:t,scripts:{...a,runtime:ps},params:{app:e,refId:i}},c=await(0,ds.wE)(o,gs),{result:u,error:d}=c;try{return r.delete(i),{...me(c),error:d,result:u?"()"===u?"":JSON.parse((l=u,l.replace(_t,""))):{action:"error",message:"No result"}}}catch(t){return r.delete(i),hs.log(`engine.run err ${o.funcName}`,t,c,o),{diagnosticsOutput:`scripting engine error ${t}`,...c,result:{action:"error",message:t?.toString()||"Unknown error"}}}var l},c=()=>{if(!t.particle)return["error",""];const{script:e,enabled:n}=t.particle;return n?["script",e]:["pass",""]};return{init:async()=>{hs.time(" rune initialized"),await(0,ds.Ay)(),hs.timeEnd(" rune initialized"),n.next(!0)},isSoulInitialized$:a,run:o,askCompanion:async(t,e,n,s)=>{const[r,a]=c();if("error"===r)return{action:"error",metaItems:[[{type:"text",text:"No particle entrypoint"}]]};if("pass"===r)return{action:"pass",metaItems:[]};const i=await o(a,{funcName:"ask_companion",funcParams:[t,e,n]},s);return"error"===i.result.action?(hs.error("---askCompanion error",i),{action:"error",metaItems:[[{type:"text",text:i.error}]]}):{action:"answer",metaItems:i.result.content}},personalProcessor:async t=>{const[e,n]=c();if("error"===e)return{action:"error",message:"No particle entrypoint"};if("script"!==e)return{action:"pass"};const{cid:s,contentType:r,content:a}=t,i=await o(n,{funcName:"personal_processor",funcParams:[s,r,a]}),{action:u,content:d}=i.result;return"error"===u&&hs.error(`RUNE: personalProcessor error: ${t.cid}`,t,i),d?{...i.result,content:d}:i.result},setEntrypoints:e=>{t=(0,fe.tTi)((t=>({...t,script:(0,ms.PH)(t.script)})),e),s.next(t)},pushContext:(t,n)=>{e[t]=n},popContext:t=>{const n=e;t.forEach((t=>{n[t]={}})),e=n},executeFunction:async(t,e,n)=>{hs.log("-----executeFunction rune",e,n);return(await o(t,{funcName:e,funcParams:n,readOnly:!0})).result},executeCallback:async(t,e)=>{const n=r.get(t);n&&await n(e)},getDebug:()=>({context:e,entrypoints:t})}}();var bs=fs,ws=n(6528);const vs=(()=>{const t=new K,e=new a.B,n=new i.t({myAddress:null}),{embeddingApi$:o}=us(e,t),{setInnerDeps:c,rune:u}=((t,e,n)=>{const s=t=>ws.A.setInnerDeps(t);return t.subscribe((t=>{s({embeddingApi:t})})),e.subscribe((t=>{s({dbApi:t})})),bs.isSoulInitialized$.subscribe((t=>{t?setTimeout((()=>n.postServiceStatus("rune","started")),0):n.postServiceStatus("rune","inactive")})),(async()=>{n.postServiceStatus("rune","starting"),await bs.init(),s({rune:bs})})(),{rune:bs,setInnerDeps:s,abort:ws.A.abort}})(o,e,t),{ipfsQueue:d,ipfsInstance$:l,api:p}=((t,e)=>{const n=new i.t(void 0),s=new Tn(n,{rune:t}),r={start:async t=>{try{if(n.getValue())return setTimeout((()=>e.postServiceStatus("ipfs","started")),0),Promise.resolve();e.postServiceStatus("ipfs","starting"),rs.time(" ipfs initialized");const s=await ss(t);return rs.timeEnd(" ipfs initialized"),n.next(s),setTimeout((()=>e.postServiceStatus("ipfs","started")),0),!0}catch(t){rs.log("----ipfs node init error ",t);const n=t instanceof Error?t.message:t;throw e.postServiceStatus("ipfs","error",n),Error(n)}},stop:async()=>{const t=n.getValue();t&&await t.stop(),n.next(void 0),e.postServiceStatus("ipfs","inactive")},config:async()=>n.getValue()?.config,info:async()=>n.getValue()?.info(),fetchWithDetails:async(t,e,s)=>{const r=n.getValue();if(!r)throw new Error("ipfs node not initialized");return r.fetchWithDetails(t,e,s)},enqueue:async(t,e,n)=>s.enqueue(t,e,n),enqueueAndWait:async(t,e)=>s.enqueueAndWait(t,e),dequeue:async t=>s.cancel(t),dequeueByParent:async t=>s.cancelByParent(t),clearQueue:async()=>s.clear(),addContent:async t=>n.getValue()?.addContent(t)};return{ipfsInstance$:n,ipfsQueue:s,api:r}})(u,t),m={waitForParticleResolve:(t,e=r.MEDIUM)=>d.enqueueAndWait(t,{postProcessing:!1,priority:e}),dbInstance$:e,ipfsInstance$:l,embeddingApi$:o,params$:n};new Re(m);return c({ipfsApi:p}),{injectDb:t=>e.next(t),isIpfsInitialized:()=>!!l.getValue(),ipfsApi:(0,s.BX)(p),rune:(0,s.BX)(u),embeddingApi$:o,ipfsQueue:(0,s.BX)(d),setRuneDeps:t=>c(t),setParams:t=>n.next({...n.value,...t})}})();var Ss,$s;Ss=self,$s=vs,m(),void 0!==Ss.onconnect?Ss.onconnect=t=>{const e=t.ports[0];h(e),(0,s.p)($s,e)}:(0,s.p)($s)},15824:function(t,e,n){"use strict";function s(t){const{script:e,markdown:n,hasRune:s}=function(t){const e=/```rune\s*([\s\S]*?)```/g;let n,s="",r=t,a=!1;for(;null!==(n=e.exec(t));)a=!0,s+=n[1]+"\n",r=r.replace(n[0],"");return{script:s.trim(),markdown:r,hasRune:a}}(t);return s?e:n}n.d(e,{PH:function(){return s}})},6528:function(t,e,n){"use strict";n.d(e,{A:function(){return _}});var s=n(49426),r=n(52665),a=n(75331),i=n(17008),o=n(32833),c=n(46926),u=(n(69674),n(44917));n(76005),n(18121),n(31948),n.p,n.p,n.p,n(96763),n(62045).hp;var d=n(96763);var l=n(96540);n(74848),n(96763);l.createContext(void 0);var p=n(71083),m=n(64762);var h=n(96763);const g="bostrom1xut80d09q0tgtch8p0z4k5f88d3uvt8cvtzm5h3tu3tsy4jk9xlsfzhxel",y=async(t,e)=>{try{const t=await async function(t){return(await p.A.get(`${m.A.bostrom.LCD_URL}/cosmwasm/wasm/v1/contract/${g}/smart/${(0,u.toBase64)((0,u.toAscii)(JSON.stringify(t)))}`)).data.data}(e);return t}catch(t){return h.log("error",t),null}};var f=n(84954),b=n(79100).A;class w extends Error{constructor(t){let e="",n=-1;t instanceof Array?e=t.join("\r\n"):t.rawLog?(e=t.rawLog.toString(),n=t.code):e=e?.error,super(e),b.error(e,{error:t}),this.code=n}}n(51298),n(75736),n(74442);const v={amount:[],gas:i.bd.toString()},S=async(t,e,n,{senseApi:s,signingClient:r},a=v)=>{const i=(t=>{if(t instanceof Array||0!==t.code)throw new w(t);return t})(await r.cyberlink(t,e,n,a)),{transactionHash:o}=i,c={from:e,to:n,transactionHash:o,timestamp:(0,f.YB)(),neuron:t};return await(s?.putCyberlink(c)),await(s?.addCyberlinkLocal(c)),o};var $=n(15824);const x=(()=>{const t={ipfsApi:new s.t(void 0),rune:new s.t(void 0),queryClient:new s.t(void 0),embeddingApi:new s.t(void 0),signingClient:new s.t(void 0),senseApi:new s.t(void 0),address:new s.t(void 0),dbApi:new s.t(void 0)};let e;const n=e=>new Promise((n=>{const s=t[e];s.getValue()&&n(s.getValue()),s.pipe((0,r.$)((t=>!!t))).subscribe((t=>{n(t)}))}));a.CyberClient.connect(i.E0).then((e=>{t.queryClient?.next(e)}));const u=async t=>(await n("ipfsApi")).fetchWithDetails(t,"text"),l={createAbortController:()=>(e=new AbortController,e),graphSearch:async(t,e=0)=>{const s=await n("queryClient"),r=await(async t=>t.match(o.rP)?t:(0,c.N)(t.replace(/%2F/g,"/")))(t);return(async(t,e,n)=>{try{return await t.search(e,n)}catch(t){return void d.error(t)}})(s,r,e)},cyberlink:async(e,s)=>{const r=t.address.getValue();if(!r)throw new Error("Connect your wallet first");const a=await n("senseApi"),i=await n("signingClient");return S(r,e,s,{senseApi:a,signingClient:i})},getPassportByNickname:async t=>{await n("queryClient");const e=await(async(t,e)=>{try{const t={passport_by_nickname:{nickname:e}};return await y(0,t)}catch(t){return h.log("error",t),null}})(0,t);return e},searcByEmbedding:async(t,e=10)=>{const s=await n("embeddingApi");return await n("dbApi"),s.searchByEmbedding(t,e)},evalScriptFromIpfs:async(t,e,s={})=>{try{const r=await u(t);if(void 0===r?.content)return{action:"error",message:"Particle not found"};const a=(0,$.PH)(r.content);return(await n("rune")).executeFunction(a,e,s)}catch(t){return{action:"error",message:t.toString()}}},getIpfsTextConent:u,addContenToIpfs:async t=>(await n("ipfsApi")).addContent(t),executeScriptCallback:async(t,e={})=>{try{return(await n("rune")).executeCallback(t,e)}catch(t){return{action:"error",message:t.toString()}}}};return{setInnerDeps:e=>{Object.keys(e).filter((t=>void 0!==e[t])).forEach((n=>{const s=e[n];t[n].next(s)}))},cybApi:l,abort:()=>{e?.abort()}}})();var _=x},97217:function(t,e,n){"use strict";n.d(e,{rz:function(){return h},lJ:function(){return d},_4:function(){return b},vZ:function(){return w},Bn:function(){return u},bn:function(){return p},Df:function(){return g},So:function(){return m},xm:function(){return l},TC:function(){return y},YD:function(){return f}});var s=n(33110),r=n(6528),a=n(96763);const i={model:"gpt-3.5-turbo"},o=async(t,e,n={},s,r)=>{const o=JSON.stringify({messages:t,...i,...n}),c={"Content-Type":"application/json",Authorization:`Bearer ${e}`},u=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",signal:r?.signal,headers:c,body:o});if(!n.stream){return(await u.json()).choices[0].message.content}const d=u.body?.getReader(),l=new TextDecoder;let p="",m="";if(d)for(;;){const{done:t,value:e}=await d.read();if(t||r?.signal.aborted)break;m+=l.decode(e,{stream:!0});const n=m.split("\n");m=n.pop()||"";for(const t of n){const e=t.replace(/^data: /,"");if("[DONE]"===e)return p;try{const t=JSON.parse(e);if(t.choices&&t.choices.length>0){const{content:e}=t.choices[0].delta;p+=e,e&&await s(e)}}catch(t){a.error("Error parsing stream message:",e,t)}}}return p};var c=n(96763);async function u(t){return r.A.cybApi.graphSearch(t)}async function d(t,e){return r.A.cybApi.cyberlink(t,e)}async function l(t){return r.A.cybApi.getPassportByNickname(t)}async function p(t,e,n={}){return r.A.cybApi.evalScriptFromIpfs(t,e,n)}async function m(t){return r.A.getIpfsTextConent(t)}async function h(t){return r.A.addContenToIpfs(t)}async function g(t,e){return c.log("exec deps callback",t),r.A.cybApi.executeScriptCallback(t,e)}async function y(t,e,n,s){return await o(t,e,n,(async t=>g(s,t)),r.A.cybApi.createAbortController())}async function f(t,e){return r.A.cybApi.searcByEmbedding(t,e)}async function b(t){return await(0,s.Pg)(t)}async function w(t){return await(0,s.Uy)(t)}},33110:function(t,e,n){"use strict";n.d(e,{I0:function(){return c},Pg:function(){return d},Uy:function(){return l}});var s=n(91214),r=n(71083),a=n(17008),i=n(86193),o=n(96763);async function c({events:t,pagination:e={limit:20,offset:0},orderBy:n,config:s}){const{offset:i,limit:o}=e,c=await r.A.get(`${a.iL}/cosmos/tx/v1beta1/txs`,{params:{"pagination.offset":i,"pagination.limit":o,orderBy:n,events:t.map((t=>`${t.key}='${t.value}'`))},paramsSerializer:{indexes:null},signal:s?.signal}),{txs:u}=c.data,d={txs:u,pagination:c.data.pagination||{total:c.data.total},txResponses:c.data.tx_responses};return d.pagination?.total||(d.pagination.total=d.txResponses.length),d}const u=async(t,e=i.s.from,{offset:n,limit:r,order:a=s.mF.ORDER_BY_DESC})=>{try{return await c({events:[{key:"cyberlink.particle"+(e===i.s.to?"To":"From"),value:t}],pagination:{limit:r,offset:n},orderBy:a})}catch(t){return o.log(t),null}},d=async(t,e,n)=>u(t,i.s.from,{offset:e,limit:n}),l=async(t,e,n)=>u(t,i.s.to,{offset:e,limit:n})},21073:function(t,e,n){"use strict";n.d(e,{a:function(){return s}});var s=(t=>(t.BOSTROM="bostrom",t.LOCAL_BOSTROM="localbostrom",t.SPACE_PUSSY="space-pussy",t.ETH="eth",t.OSMO="osmo",t.TERRA="terra",t.COSMOS="cosmoshub-4",t))(s||{})},31948:function(t,e,n){"use strict";n.d(e,{dB:function(){return s}});const s={STAGE_TWEET_ACTION_BAR:{ADD_AVATAR:"addAvatar",FOLLOW:"follow",TWEET:"tweet"}}},84954:function(t,e,n){"use strict";n.d(e,{$Y:function(){return i},YB:function(){return o},jb:function(){return a}});var s=n(54075),r=n.n(s);const a=t=>r()(new Date(t),'yyyy-mm-dd"T"HH:MM:ss.l',!0),i=t=>Date.parse(t.endsWith("Z")?t:`${t}Z`),o=()=>Date.now()},46926:function(t,e,n){"use strict";n.d(e,{N:function(){return o}});var s=n(22322),r=n.n(s),a=n(47095),i=(n(2543),n(32833),n(62045).hp);const o=t=>new Promise(((e,n)=>{const s=new(r())("file",i.from(t)).marshal();a.DAGNode.create(s,((t,s)=>{t&&n(new Error("Cannot create ipfs DAGNode")),a.util.cid(s,((t,n)=>{e(n.toBaseEncodedString())}))}))}))},8923:function(t,e,n){"use strict";n.d(e,{DR:function(){return s}});const s="CYBLOG_BROADCST_CHANNEL"},79100:function(t,e,n){"use strict";n.d(e,{S:function(){return c}});var s=n(2543),r=n.n(s),a=n(8923),i=n(96763);const o=[];const c=(t={})=>{const e=new BroadcastChannel(a.DR);function n(n,s,r){const a={...t,...r};r?.error&&(a.error=JSON.stringify(r.error)),e.postMessage({type:"log",value:{level:n,message:s,context:a}})}return{info:function(t,e){return n("info",t,e)},error:function(t,e){return n("error",t,e)},warn:function(t,e){return n("warn",t,e)},trace:function(t,e){return n("warn",t,e)}}},u=function(t={}){let e={};function n(n,a,c=t){try{const t=c?.formatter?c?.formatter(a):a;!function(t,e=!0){for(o.push(t);e&&o.length>1e3;)o.shift()}({timestamp:new Date,level:n,message:t,stacktrace:c?.stacktrace,context:r().omit(c,["formatter","stacktrace"])});Object.keys(e).reduce(((t,n)=>{const s=e[n],r=c[n];return s&&r?t||"all"===s||0===s.length||s.some((t=>t===r)):t}),!1)&&function(t,e,n){const a=r().omit(n,["formatter","thread","module","unit","data"]),{thread:o="",module:c="",unit:u="",data:d=""}=n,l=(0,s.isEmpty)(a)?"":a;Array.isArray(e)?i[t](...e,l):n?.formatter?i[t](n?.formatter(e),l):i[t](`[${o}:${c}:${u}] ${e}`,d,l)}(n,a,c)}catch(t){i.log("cyblog error",t)}}return new BroadcastChannel(a.DR).onmessage=t=>{"params"===t.data.type&&(e={...e,...t.data.value})},{log:n,info:function(t,e){return n("info",t,e)},error:function(t,e){return n("error",t,e)},warn:function(t,e){return n("warn",t,e)},trace:function(t,e){return n("warn",t,e)},logList:o,getLogs:()=>o.map((t=>{const{context:e,...n}=t,{unit:s="",module:r="",thread:a="",data:i="",error:o="",stacktrace:c=""}=e||{};return{...n,unit:s,module:r,thread:a,data:i,error:o,stacktrace:c}})),clear:()=>o.splice(0,o.length),getConsoleLogParams:()=>e}}({thread:"main"});e.A=u},85471:function(){},43281:function(){},66178:function(){},52044:function(){},9712:function(){},29122:function(){},70495:function(){},77051:function(){},83052:function(){},60143:function(){},72603:function(){},5425:function(){},22009:function(){},6837:function(){},12499:function(){},47790:function(){},73776:function(){},98285:function(){},38664:function(){},61626:function(){},21638:function(){},92668:function(){},8460:function(){},92382:function(){},71619:function(){},36180:function(){},97429:function(){},19984:function(){},32638:function(){},34625:function(){},92934:function(){},77667:function(){},76447:function(){},50310:function(){},54658:function(){},27287:function(){},70143:function(){},3411:function(){},63779:function(){},77199:function(){}},a={};function i(t){var e=a[t];if(void 0!==e)return e.exports;var n=a[t]={id:t,loaded:!1,exports:{}};return r[t].call(n.exports,n,n.exports,i),n.loaded=!0,n.exports}i.m=r,i.x=function(){var t=i.O(void 0,[667,742,45,748,854,235,187],(function(){return i(55723)}));return t=i.O(t)},i.amdO={},t=[],i.O=function(e,n,s,r){if(!n){var a=1/0;for(d=0;d<t.length;d++){n=t[d][0],s=t[d][1],r=t[d][2];for(var o=!0,c=0;c<n.length;c++)(!1&r||a>=r)&&Object.keys(i.O).every((function(t){return i.O[t](n[c])}))?n.splice(c--,1):(o=!1,r<a&&(a=r));if(o){t.splice(d--,1);var u=s();void 0!==u&&(e=u)}}return e}r=r||0;for(var d=t.length;d>0&&t[d-1][2]>r;d--)t[d]=t[d-1];t[d]=[n,s,r]},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,{a:e}),e},n=Object.getPrototypeOf?function(t){return Object.getPrototypeOf(t)}:function(t){return t.__proto__},i.t=function(t,s){if(1&s&&(t=this(t)),8&s)return t;if("object"==typeof t&&t){if(4&s&&t.__esModule)return t;if(16&s&&"function"==typeof t.then)return t}var r=Object.create(null);i.r(r);var a={};e=e||[null,n({}),n([]),n(n)];for(var o=2&s&&t;"object"==typeof o&&!~e.indexOf(o);o=n(o))Object.getOwnPropertyNames(o).forEach((function(e){a[e]=function(){return t[e]}}));return a.default=function(){return t},i.d(r,a),r},i.d=function(t,e){for(var n in e)i.o(e,n)&&!i.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},i.f={},i.e=function(t){return Promise.all(Object.keys(i.f).reduce((function(e,n){return i.f[n](t,e),e}),[]))},i.u=function(t){return 667===t?"667.3917b962.js":742===t?"742.71ed727d.js":45===t?"45.6a43f7cf.js":t+"."+{187:"1146adee",198:"44cc2170",235:"c8ba16cc",748:"2250a551",854:"d2b02017"}[t]+".chunk.js"},i.miniCssF=function(t){},i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),i.hmd=function(t){return(t=Object.create(t)).children||(t.children=[]),Object.defineProperty(t,"exports",{enumerable:!0,set:function(){throw new Error("ES Modules may not assign module.exports or exports.*, Use ESM export syntax, instead: "+t.id)}}),t},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.nmd=function(t){return t.paths=[],t.children||(t.children=[]),t},i.p="/",function(){i.b=self.location+"";var t={586:1};i.f.i=function(e,n){t[e]||importScripts(i.p+i.u(e))};var e=self.webpackChunkcyb=self.webpackChunkcyb||[],n=e.push.bind(e);e.push=function(e){var s=e[0],r=e[1],a=e[2];for(var o in r)i.o(r,o)&&(i.m[o]=r[o]);for(a&&a(i);s.length;)t[s.pop()]=1;n(e)}}(),s=i.x,i.x=function(){return Promise.all([667,742,45,748,854,235,187].map(i.e,i)).then(s)};i.x()}();
//# sourceMappingURL=586.1a3456b3.chunk.js.map