(self.webpackChunkcyb=self.webpackChunkcyb||[]).push([[112],{41287:function(e){e.exports=function e(s,r){var o,i=0,a=0,c=r=r||0,l=s.length;do{if(c>=l||a>49)throw e.bytes=0,new RangeError("Could not decode varint");o=s[c++],i+=a<28?(o&n)<<a:(o&n)*Math.pow(2,a),a+=7}while(o>=t);return e.bytes=c-r,i};var t=128,n=127},35939:function(e){e.exports=function e(r,o,i){if(Number.MAX_SAFE_INTEGER&&r>Number.MAX_SAFE_INTEGER)throw e.bytes=0,new RangeError("Could not encode varint");o=o||[];var a=i=i||0;for(;r>=s;)o[i++]=255&r|t,r/=128;for(;r&n;)o[i++]=255&r|t,r>>>=7;return o[i]=0|r,e.bytes=i-a+1,o};var t=128,n=-128,s=Math.pow(2,31)},32669:function(e,t,n){e.exports={encode:n(35939),decode:n(41287),encodingLength:n(56605)}},56605:function(e){var t=Math.pow(2,7),n=Math.pow(2,14),s=Math.pow(2,21),r=Math.pow(2,28),o=Math.pow(2,35),i=Math.pow(2,42),a=Math.pow(2,49),c=Math.pow(2,56),l=Math.pow(2,63);e.exports=function(e){return e<t?1:e<n?2:e<s?3:e<r?4:e<o?5:e<i?6:e<a?7:e<c?8:e<l?9:10}},30640:function(e){!function(t){"use strict";const n="(0?\\d+|0x[a-f0-9]+)",s={fourOctet:new RegExp(`^${n}\\.${n}\\.${n}\\.${n}$`,"i"),threeOctet:new RegExp(`^${n}\\.${n}\\.${n}$`,"i"),twoOctet:new RegExp(`^${n}\\.${n}$`,"i"),longValue:new RegExp(`^${n}$`,"i")},r=new RegExp("^0[0-7]+$","i"),o=new RegExp("^0x[a-f0-9]+$","i"),i="%[0-9a-z]{1,}",a="(?:[0-9a-f]+::?)+",c={zoneIndex:new RegExp(i,"i"),native:new RegExp(`^(::)?(${a})?([0-9a-f]+)?(::)?(${i})?$`,"i"),deprecatedTransitional:new RegExp(`^(?:::)(${n}\\.${n}\\.${n}\\.${n}(${i})?)$`,"i"),transitional:new RegExp(`^((?:${a})|(?:::)(?:${a})?)${n}\\.${n}\\.${n}\\.${n}(${i})?$`,"i")};function l(e,t){if(e.indexOf("::")!==e.lastIndexOf("::"))return null;let n,s,r=0,o=-1,i=(e.match(c.zoneIndex)||[])[0];for(i&&(i=i.substring(1),e=e.replace(/%.+$/,""));(o=e.indexOf(":",o+1))>=0;)r++;if("::"===e.substr(0,2)&&r--,"::"===e.substr(-2,2)&&r--,r>t)return null;for(s=t-r,n=":";s--;)n+="0:";return":"===(e=e.replace("::",n))[0]&&(e=e.slice(1)),":"===e[e.length-1]&&(e=e.slice(0,-1)),{parts:t=function(){const t=e.split(":"),n=[];for(let e=0;e<t.length;e++)n.push(parseInt(t[e],16));return n}(),zoneId:i}}function d(e,t,n,s){if(e.length!==t.length)throw new Error("ipaddr: cannot match CIDR for objects with different lengths");let r,o=0;for(;s>0;){if(r=n-s,r<0&&(r=0),e[o]>>r!=t[o]>>r)return!1;s-=n,o+=1}return!0}function u(e){if(o.test(e))return parseInt(e,16);if("0"===e[0]&&!isNaN(parseInt(e[1],10))){if(r.test(e))return parseInt(e,8);throw new Error(`ipaddr: cannot parse ${e} as octal`)}return parseInt(e,10)}function h(e,t){for(;e.length<t;)e=`0${e}`;return e}const p={};p.IPv4=function(){function e(e){if(4!==e.length)throw new Error("ipaddr: ipv4 octet count should be 4");let t,n;for(t=0;t<e.length;t++)if(n=e[t],!(0<=n&&n<=255))throw new Error("ipaddr: ipv4 octet should fit in 8 bits");this.octets=e}return e.prototype.SpecialRanges={unspecified:[[new e([0,0,0,0]),8]],broadcast:[[new e([255,255,255,255]),32]],multicast:[[new e([224,0,0,0]),4]],linkLocal:[[new e([169,254,0,0]),16]],loopback:[[new e([127,0,0,0]),8]],carrierGradeNat:[[new e([100,64,0,0]),10]],private:[[new e([10,0,0,0]),8],[new e([172,16,0,0]),12],[new e([192,168,0,0]),16]],reserved:[[new e([192,0,0,0]),24],[new e([192,0,2,0]),24],[new e([192,88,99,0]),24],[new e([198,51,100,0]),24],[new e([203,0,113,0]),24],[new e([240,0,0,0]),4]]},e.prototype.kind=function(){return"ipv4"},e.prototype.match=function(e,t){let n;if(void 0===t&&(n=e,e=n[0],t=n[1]),"ipv4"!==e.kind())throw new Error("ipaddr: cannot match ipv4 address with non-ipv4 one");return d(this.octets,e.octets,8,t)},e.prototype.prefixLengthFromSubnetMask=function(){let e=0,t=!1;const n={0:8,128:7,192:6,224:5,240:4,248:3,252:2,254:1,255:0};let s,r,o;for(s=3;s>=0;s-=1){if(r=this.octets[s],!(r in n))return null;if(o=n[r],t&&0!==o)return null;8!==o&&(t=!0),e+=o}return 32-e},e.prototype.range=function(){return p.subnetMatch(this,this.SpecialRanges)},e.prototype.toByteArray=function(){return this.octets.slice(0)},e.prototype.toIPv4MappedAddress=function(){return p.IPv6.parse(`::ffff:${this.toString()}`)},e.prototype.toNormalizedString=function(){return this.toString()},e.prototype.toString=function(){return this.octets.join(".")},e}(),p.IPv4.broadcastAddressFromCIDR=function(e){try{const t=this.parseCIDR(e),n=t[0].toByteArray(),s=this.subnetMaskFromPrefixLength(t[1]).toByteArray(),r=[];let o=0;for(;o<4;)r.push(parseInt(n[o],10)|255^parseInt(s[o],10)),o++;return new this(r)}catch(e){throw new Error("ipaddr: the address does not have IPv4 CIDR format")}},p.IPv4.isIPv4=function(e){return null!==this.parser(e)},p.IPv4.isValid=function(e){try{return new this(this.parser(e)),!0}catch(e){return!1}},p.IPv4.isValidFourPartDecimal=function(e){return!(!p.IPv4.isValid(e)||!e.match(/^(0|[1-9]\d*)(\.(0|[1-9]\d*)){3}$/))},p.IPv4.networkAddressFromCIDR=function(e){let t,n,s,r,o;try{for(t=this.parseCIDR(e),s=t[0].toByteArray(),o=this.subnetMaskFromPrefixLength(t[1]).toByteArray(),r=[],n=0;n<4;)r.push(parseInt(s[n],10)&parseInt(o[n],10)),n++;return new this(r)}catch(e){throw new Error("ipaddr: the address does not have IPv4 CIDR format")}},p.IPv4.parse=function(e){const t=this.parser(e);if(null===t)throw new Error("ipaddr: string is not formatted like an IPv4 Address");return new this(t)},p.IPv4.parseCIDR=function(e){let t;if(t=e.match(/^(.+)\/(\d+)$/)){const e=parseInt(t[2]);if(e>=0&&e<=32){const n=[this.parse(t[1]),e];return Object.defineProperty(n,"toString",{value:function(){return this.join("/")}}),n}}throw new Error("ipaddr: string is not formatted like an IPv4 CIDR range")},p.IPv4.parser=function(e){let t,n,r;if(t=e.match(s.fourOctet))return function(){const e=t.slice(1,6),s=[];for(let t=0;t<e.length;t++)n=e[t],s.push(u(n));return s}();if(t=e.match(s.longValue)){if(r=u(t[1]),r>4294967295||r<0)throw new Error("ipaddr: address outside defined range");return function(){const e=[];let t;for(t=0;t<=24;t+=8)e.push(r>>t&255);return e}().reverse()}return(t=e.match(s.twoOctet))?function(){const e=t.slice(1,4),n=[];if(r=u(e[1]),r>16777215||r<0)throw new Error("ipaddr: address outside defined range");return n.push(u(e[0])),n.push(r>>16&255),n.push(r>>8&255),n.push(255&r),n}():(t=e.match(s.threeOctet))?function(){const e=t.slice(1,5),n=[];if(r=u(e[2]),r>65535||r<0)throw new Error("ipaddr: address outside defined range");return n.push(u(e[0])),n.push(u(e[1])),n.push(r>>8&255),n.push(255&r),n}():null},p.IPv4.subnetMaskFromPrefixLength=function(e){if((e=parseInt(e))<0||e>32)throw new Error("ipaddr: invalid IPv4 prefix length");const t=[0,0,0,0];let n=0;const s=Math.floor(e/8);for(;n<s;)t[n]=255,n++;return s<4&&(t[s]=Math.pow(2,e%8)-1<<8-e%8),new this(t)},p.IPv6=function(){function e(e,t){let n,s;if(16===e.length)for(this.parts=[],n=0;n<=14;n+=2)this.parts.push(e[n]<<8|e[n+1]);else{if(8!==e.length)throw new Error("ipaddr: ipv6 part count should be 8 or 16");this.parts=e}for(n=0;n<this.parts.length;n++)if(s=this.parts[n],!(0<=s&&s<=65535))throw new Error("ipaddr: ipv6 part should fit in 16 bits");t&&(this.zoneId=t)}return e.prototype.SpecialRanges={unspecified:[new e([0,0,0,0,0,0,0,0]),128],linkLocal:[new e([65152,0,0,0,0,0,0,0]),10],multicast:[new e([65280,0,0,0,0,0,0,0]),8],loopback:[new e([0,0,0,0,0,0,0,1]),128],uniqueLocal:[new e([64512,0,0,0,0,0,0,0]),7],ipv4Mapped:[new e([0,0,0,0,0,65535,0,0]),96],rfc6145:[new e([0,0,0,0,65535,0,0,0]),96],rfc6052:[new e([100,65435,0,0,0,0,0,0]),96],"6to4":[new e([8194,0,0,0,0,0,0,0]),16],teredo:[new e([8193,0,0,0,0,0,0,0]),32],reserved:[[new e([8193,3512,0,0,0,0,0,0]),32]]},e.prototype.isIPv4MappedAddress=function(){return"ipv4Mapped"===this.range()},e.prototype.kind=function(){return"ipv6"},e.prototype.match=function(e,t){let n;if(void 0===t&&(n=e,e=n[0],t=n[1]),"ipv6"!==e.kind())throw new Error("ipaddr: cannot match ipv6 address with non-ipv6 one");return d(this.parts,e.parts,16,t)},e.prototype.prefixLengthFromSubnetMask=function(){let e=0,t=!1;const n={0:16,32768:15,49152:14,57344:13,61440:12,63488:11,64512:10,65024:9,65280:8,65408:7,65472:6,65504:5,65520:4,65528:3,65532:2,65534:1,65535:0};let s,r;for(let o=7;o>=0;o-=1){if(s=this.parts[o],!(s in n))return null;if(r=n[s],t&&0!==r)return null;16!==r&&(t=!0),e+=r}return 128-e},e.prototype.range=function(){return p.subnetMatch(this,this.SpecialRanges)},e.prototype.toByteArray=function(){let e;const t=[],n=this.parts;for(let s=0;s<n.length;s++)e=n[s],t.push(e>>8),t.push(255&e);return t},e.prototype.toFixedLengthString=function(){const e=function(){const e=[];for(let t=0;t<this.parts.length;t++)e.push(h(this.parts[t].toString(16),4));return e}.call(this).join(":");let t="";return this.zoneId&&(t=`%${this.zoneId}`),e+t},e.prototype.toIPv4Address=function(){if(!this.isIPv4MappedAddress())throw new Error("ipaddr: trying to convert a generic ipv6 address to ipv4");const e=this.parts.slice(-2),t=e[0],n=e[1];return new p.IPv4([t>>8,255&t,n>>8,255&n])},e.prototype.toNormalizedString=function(){const e=function(){const e=[];for(let t=0;t<this.parts.length;t++)e.push(this.parts[t].toString(16));return e}.call(this).join(":");let t="";return this.zoneId&&(t=`%${this.zoneId}`),e+t},e.prototype.toRFC5952String=function(){const e=/((^|:)(0(:|$)){2,})/g,t=this.toNormalizedString();let n,s=0,r=-1;for(;n=e.exec(t);)n[0].length>r&&(s=n.index,r=n[0].length);return r<0?t:`${t.substring(0,s)}::${t.substring(s+r)}`},e.prototype.toString=function(){return this.toNormalizedString().replace(/((^|:)(0(:|$))+)/,"::")},e}(),p.IPv6.broadcastAddressFromCIDR=function(e){try{const t=this.parseCIDR(e),n=t[0].toByteArray(),s=this.subnetMaskFromPrefixLength(t[1]).toByteArray(),r=[];let o=0;for(;o<16;)r.push(parseInt(n[o],10)|255^parseInt(s[o],10)),o++;return new this(r)}catch(e){throw new Error(`ipaddr: the address does not have IPv6 CIDR format (${e})`)}},p.IPv6.isIPv6=function(e){return null!==this.parser(e)},p.IPv6.isValid=function(e){if("string"==typeof e&&-1===e.indexOf(":"))return!1;try{const t=this.parser(e);return new this(t.parts,t.zoneId),!0}catch(e){return!1}},p.IPv6.networkAddressFromCIDR=function(e){let t,n,s,r,o;try{for(t=this.parseCIDR(e),s=t[0].toByteArray(),o=this.subnetMaskFromPrefixLength(t[1]).toByteArray(),r=[],n=0;n<16;)r.push(parseInt(s[n],10)&parseInt(o[n],10)),n++;return new this(r)}catch(e){throw new Error(`ipaddr: the address does not have IPv6 CIDR format (${e})`)}},p.IPv6.parse=function(e){const t=this.parser(e);if(null===t.parts)throw new Error("ipaddr: string is not formatted like an IPv6 Address");return new this(t.parts,t.zoneId)},p.IPv6.parseCIDR=function(e){let t,n,s;if((n=e.match(/^(.+)\/(\d+)$/))&&(t=parseInt(n[2]),t>=0&&t<=128))return s=[this.parse(n[1]),t],Object.defineProperty(s,"toString",{value:function(){return this.join("/")}}),s;throw new Error("ipaddr: string is not formatted like an IPv6 CIDR range")},p.IPv6.parser=function(e){let t,n,s,r,o,i;if(s=e.match(c.deprecatedTransitional))return this.parser(`::ffff:${s[1]}`);if(c.native.test(e))return l(e,8);if((s=e.match(c.transitional))&&(i=s[6]||"",t=l(s[1].slice(0,-1)+i,6),t.parts)){for(o=[parseInt(s[2]),parseInt(s[3]),parseInt(s[4]),parseInt(s[5])],n=0;n<o.length;n++)if(r=o[n],!(0<=r&&r<=255))return null;return t.parts.push(o[0]<<8|o[1]),t.parts.push(o[2]<<8|o[3]),{parts:t.parts,zoneId:t.zoneId}}return null},p.IPv6.subnetMaskFromPrefixLength=function(e){if((e=parseInt(e))<0||e>128)throw new Error("ipaddr: invalid IPv6 prefix length");const t=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];let n=0;const s=Math.floor(e/8);for(;n<s;)t[n]=255,n++;return s<16&&(t[s]=Math.pow(2,e%8)-1<<8-e%8),new this(t)},p.fromByteArray=function(e){const t=e.length;if(4===t)return new p.IPv4(e);if(16===t)return new p.IPv6(e);throw new Error("ipaddr: the binary input is neither an IPv6 nor IPv4 address")},p.isValid=function(e){return p.IPv6.isValid(e)||p.IPv4.isValid(e)},p.parse=function(e){if(p.IPv6.isValid(e))return p.IPv6.parse(e);if(p.IPv4.isValid(e))return p.IPv4.parse(e);throw new Error("ipaddr: the address has neither IPv6 nor IPv4 format")},p.parseCIDR=function(e){try{return p.IPv6.parseCIDR(e)}catch(t){try{return p.IPv4.parseCIDR(e)}catch(e){throw new Error("ipaddr: the address has neither IPv6 nor IPv4 CIDR format")}}},p.process=function(e){const t=this.parse(e);return"ipv6"===t.kind()&&t.isIPv4MappedAddress()?t.toIPv4Address():t},p.subnetMatch=function(e,t,n){let s,r,o,i;for(r in null==n&&(n="unicast"),t)if(Object.prototype.hasOwnProperty.call(t,r))for(o=t[r],!o[0]||o[0]instanceof Array||(o=[o]),s=0;s<o.length;s++)if(i=o[s],e.kind()===i[0].kind()&&e.match.apply(e,i))return r;return n},e.exports?e.exports=p:t.ipaddr=p}(this)},9724:function(e){e.exports=function e(s,r){var o,i=0,a=0,c=r=r||0,l=s.length;do{if(c>=l||a>49)throw e.bytes=0,new RangeError("Could not decode varint");o=s[c++],i+=a<28?(o&n)<<a:(o&n)*Math.pow(2,a),a+=7}while(o>=t);return e.bytes=c-r,i};var t=128,n=127},40436:function(e){e.exports=function e(r,o,i){if(Number.MAX_SAFE_INTEGER&&r>Number.MAX_SAFE_INTEGER)throw e.bytes=0,new RangeError("Could not encode varint");o=o||[];var a=i=i||0;for(;r>=s;)o[i++]=255&r|t,r/=128;for(;r&n;)o[i++]=255&r|t,r>>>=7;return o[i]=0|r,e.bytes=i-a+1,o};var t=128,n=-128,s=Math.pow(2,31)},40024:function(e,t,n){e.exports={encode:n(40436),decode:n(9724),encodingLength:n(83974)}},83974:function(e){var t=Math.pow(2,7),n=Math.pow(2,14),s=Math.pow(2,21),r=Math.pow(2,28),o=Math.pow(2,35),i=Math.pow(2,42),a=Math.pow(2,49),c=Math.pow(2,56),l=Math.pow(2,63);e.exports=function(e){return e<t?1:e<n?2:e<s?3:e<r?4:e<o?5:e<i?6:e<a?7:e<c?8:e<l?9:10}},3666:function(e){"use strict";function t(e,t){t=t||{};this._head=0,this._tail=0,this._capacity=t.capacity,this._capacityMask=3,this._list=new Array(4),Array.isArray(e)&&this._fromArray(e)}t.prototype.peekAt=function(e){var t=e;if(t===(0|t)){var n=this.size();if(!(t>=n||t<-n))return t<0&&(t+=n),t=this._head+t&this._capacityMask,this._list[t]}},t.prototype.get=function(e){return this.peekAt(e)},t.prototype.peek=function(){if(this._head!==this._tail)return this._list[this._head]},t.prototype.peekFront=function(){return this.peek()},t.prototype.peekBack=function(){return this.peekAt(-1)},Object.defineProperty(t.prototype,"length",{get:function(){return this.size()}}),t.prototype.size=function(){return this._head===this._tail?0:this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)},t.prototype.unshift=function(e){if(void 0===e)return this.size();var t=this._list.length;return this._head=this._head-1+t&this._capacityMask,this._list[this._head]=e,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.pop(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)},t.prototype.shift=function(){var e=this._head;if(e!==this._tail){var t=this._list[e];return this._list[e]=void 0,this._head=e+1&this._capacityMask,e<2&&this._tail>1e4&&this._tail<=this._list.length>>>2&&this._shrinkArray(),t}},t.prototype.push=function(e){if(void 0===e)return this.size();var t=this._tail;return this._list[t]=e,this._tail=t+1&this._capacityMask,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.shift(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)},t.prototype.pop=function(){var e=this._tail;if(e!==this._head){var t=this._list.length;this._tail=e-1+t&this._capacityMask;var n=this._list[this._tail];return this._list[this._tail]=void 0,this._head<2&&e>1e4&&e<=t>>>2&&this._shrinkArray(),n}},t.prototype.removeOne=function(e){var t=e;if(t===(0|t)&&this._head!==this._tail){var n=this.size(),s=this._list.length;if(!(t>=n||t<-n)){t<0&&(t+=n),t=this._head+t&this._capacityMask;var r,o=this._list[t];if(e<n/2){for(r=e;r>0;r--)this._list[t]=this._list[t=t-1+s&this._capacityMask];this._list[t]=void 0,this._head=this._head+1+s&this._capacityMask}else{for(r=n-1-e;r>0;r--)this._list[t]=this._list[t=t+1+s&this._capacityMask];this._list[t]=void 0,this._tail=this._tail-1+s&this._capacityMask}return o}}},t.prototype.remove=function(e,t){var n,s=e,r=t;if(s===(0|s)&&this._head!==this._tail){var o=this.size(),i=this._list.length;if(!(s>=o||s<-o||t<1)){if(s<0&&(s+=o),1===t||!t)return(n=new Array(1))[0]=this.removeOne(s),n;if(0===s&&s+t>=o)return n=this.toArray(),this.clear(),n;var a;for(s+t>o&&(t=o-s),n=new Array(t),a=0;a<t;a++)n[a]=this._list[this._head+s+a&this._capacityMask];if(s=this._head+s&this._capacityMask,e+t===o){for(this._tail=this._tail-t+i&this._capacityMask,a=t;a>0;a--)this._list[s=s+1+i&this._capacityMask]=void 0;return n}if(0===e){for(this._head=this._head+t+i&this._capacityMask,a=t-1;a>0;a--)this._list[s=s+1+i&this._capacityMask]=void 0;return n}if(s<o/2){for(this._head=this._head+e+t+i&this._capacityMask,a=e;a>0;a--)this.unshift(this._list[s=s-1+i&this._capacityMask]);for(s=this._head-1+i&this._capacityMask;r>0;)this._list[s=s-1+i&this._capacityMask]=void 0,r--;e<0&&(this._tail=s)}else{for(this._tail=s,s=s+t+i&this._capacityMask,a=o-(t+e);a>0;a--)this.push(this._list[s++]);for(s=this._tail;r>0;)this._list[s=s+1+i&this._capacityMask]=void 0,r--}return this._head<2&&this._tail>1e4&&this._tail<=i>>>2&&this._shrinkArray(),n}}},t.prototype.splice=function(e,t){var n=e;if(n===(0|n)){var s=this.size();if(n<0&&(n+=s),!(n>s)){if(arguments.length>2){var r,o,i,a=arguments.length,c=this._list.length,l=2;if(!s||n<s/2){for(o=new Array(n),r=0;r<n;r++)o[r]=this._list[this._head+r&this._capacityMask];for(0===t?(i=[],n>0&&(this._head=this._head+n+c&this._capacityMask)):(i=this.remove(n,t),this._head=this._head+n+c&this._capacityMask);a>l;)this.unshift(arguments[--a]);for(r=n;r>0;r--)this.unshift(o[r-1])}else{var d=(o=new Array(s-(n+t))).length;for(r=0;r<d;r++)o[r]=this._list[this._head+n+t+r&this._capacityMask];for(0===t?(i=[],n!=s&&(this._tail=this._head+n+c&this._capacityMask)):(i=this.remove(n,t),this._tail=this._tail-d+c&this._capacityMask);l<a;)this.push(arguments[l++]);for(r=0;r<d;r++)this.push(o[r])}return i}return this.remove(n,t)}}},t.prototype.clear=function(){this._head=0,this._tail=0},t.prototype.isEmpty=function(){return this._head===this._tail},t.prototype.toArray=function(){return this._copyArray(!1)},t.prototype._fromArray=function(e){for(var t=0;t<e.length;t++)this.push(e[t])},t.prototype._copyArray=function(e){var t,n=[],s=this._list,r=s.length;if(e||this._head>this._tail){for(t=this._head;t<r;t++)n.push(s[t]);for(t=0;t<this._tail;t++)n.push(s[t])}else for(t=this._head;t<this._tail;t++)n.push(s[t]);return n},t.prototype._growArray=function(){this._head&&(this._list=this._copyArray(!0),this._head=0),this._tail=this._list.length,this._list.length<<=1,this._capacityMask=this._capacityMask<<1|1},t.prototype._shrinkArray=function(){this._list.length>>>=1,this._capacityMask>>>=1},e.exports=t},26021:function(e,t,n){"use strict";e.exports=n(12357)},12357:function(e,t,n){"use strict";var s=t;function r(){s.util._configure(),s.Writer._configure(s.BufferWriter),s.Reader._configure(s.BufferReader)}s.build="minimal",s.Writer=n(1336),s.BufferWriter=n(97337),s.Reader=n(55932),s.BufferReader=n(76573),s.util=n(44932),s.rpc=n(36396),s.roots=n(1022),s.configure=r,r()},55932:function(e,t,n){"use strict";e.exports=c;var s,r=n(44932),o=r.LongBits,i=r.utf8;function a(e,t){return RangeError("index out of range: "+e.pos+" + "+(t||1)+" > "+e.len)}function c(e){this.buf=e,this.pos=0,this.len=e.length}var l,d="undefined"!=typeof Uint8Array?function(e){if(e instanceof Uint8Array||Array.isArray(e))return new c(e);throw Error("illegal buffer")}:function(e){if(Array.isArray(e))return new c(e);throw Error("illegal buffer")},u=function(){return r.Buffer?function(e){return(c.create=function(e){return r.Buffer.isBuffer(e)?new s(e):d(e)})(e)}:d};function h(){var e=new o(0,0),t=0;if(!(this.len-this.pos>4)){for(;t<3;++t){if(this.pos>=this.len)throw a(this);if(e.lo=(e.lo|(127&this.buf[this.pos])<<7*t)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(127&this.buf[this.pos++])<<7*t)>>>0,e}for(;t<4;++t)if(e.lo=(e.lo|(127&this.buf[this.pos])<<7*t)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(127&this.buf[this.pos])<<28)>>>0,e.hi=(e.hi|(127&this.buf[this.pos])>>4)>>>0,this.buf[this.pos++]<128)return e;if(t=0,this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(127&this.buf[this.pos])<<7*t+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw a(this);if(e.hi=(e.hi|(127&this.buf[this.pos])<<7*t+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}function p(e,t){return(e[t-4]|e[t-3]<<8|e[t-2]<<16|e[t-1]<<24)>>>0}function f(){if(this.pos+8>this.len)throw a(this,8);return new o(p(this.buf,this.pos+=4),p(this.buf,this.pos+=4))}c.create=u(),c.prototype._slice=r.Array.prototype.subarray||r.Array.prototype.slice,c.prototype.uint32=(l=4294967295,function(){if(l=(127&this.buf[this.pos])>>>0,this.buf[this.pos++]<128)return l;if(l=(l|(127&this.buf[this.pos])<<7)>>>0,this.buf[this.pos++]<128)return l;if(l=(l|(127&this.buf[this.pos])<<14)>>>0,this.buf[this.pos++]<128)return l;if(l=(l|(127&this.buf[this.pos])<<21)>>>0,this.buf[this.pos++]<128)return l;if(l=(l|(15&this.buf[this.pos])<<28)>>>0,this.buf[this.pos++]<128)return l;if((this.pos+=5)>this.len)throw this.pos=this.len,a(this,10);return l}),c.prototype.int32=function(){return 0|this.uint32()},c.prototype.sint32=function(){var e=this.uint32();return e>>>1^-(1&e)|0},c.prototype.bool=function(){return 0!==this.uint32()},c.prototype.fixed32=function(){if(this.pos+4>this.len)throw a(this,4);return p(this.buf,this.pos+=4)},c.prototype.sfixed32=function(){if(this.pos+4>this.len)throw a(this,4);return 0|p(this.buf,this.pos+=4)},c.prototype.float=function(){if(this.pos+4>this.len)throw a(this,4);var e=r.float.readFloatLE(this.buf,this.pos);return this.pos+=4,e},c.prototype.double=function(){if(this.pos+8>this.len)throw a(this,4);var e=r.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,e},c.prototype.bytes=function(){var e=this.uint32(),t=this.pos,n=this.pos+e;if(n>this.len)throw a(this,e);return this.pos+=e,Array.isArray(this.buf)?this.buf.slice(t,n):t===n?new this.buf.constructor(0):this._slice.call(this.buf,t,n)},c.prototype.string=function(){var e=this.bytes();return i.read(e,0,e.length)},c.prototype.skip=function(e){if("number"==typeof e){if(this.pos+e>this.len)throw a(this,e);this.pos+=e}else do{if(this.pos>=this.len)throw a(this)}while(128&this.buf[this.pos++]);return this},c.prototype.skipType=function(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;4!=(e=7&this.uint32());)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+e+" at offset "+this.pos)}return this},c._configure=function(e){s=e,c.create=u(),s._configure();var t=r.Long?"toLong":"toNumber";r.merge(c.prototype,{int64:function(){return h.call(this)[t](!1)},uint64:function(){return h.call(this)[t](!0)},sint64:function(){return h.call(this).zzDecode()[t](!1)},fixed64:function(){return f.call(this)[t](!0)},sfixed64:function(){return f.call(this)[t](!1)}})}},76573:function(e,t,n){"use strict";e.exports=o;var s=n(55932);(o.prototype=Object.create(s.prototype)).constructor=o;var r=n(44932);function o(e){s.call(this,e)}o._configure=function(){r.Buffer&&(o.prototype._slice=r.Buffer.prototype.slice)},o.prototype.string=function(){var e=this.uint32();return this.buf.utf8Slice?this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+e,this.len)):this.buf.toString("utf-8",this.pos,this.pos=Math.min(this.pos+e,this.len))},o._configure()},1022:function(e){"use strict";e.exports={}},36396:function(e,t,n){"use strict";t.Service=n(73064)},73064:function(e,t,n){"use strict";e.exports=r;var s=n(44932);function r(e,t,n){if("function"!=typeof e)throw TypeError("rpcImpl must be a function");s.EventEmitter.call(this),this.rpcImpl=e,this.requestDelimited=Boolean(t),this.responseDelimited=Boolean(n)}(r.prototype=Object.create(s.EventEmitter.prototype)).constructor=r,r.prototype.rpcCall=function e(t,n,r,o,i){if(!o)throw TypeError("request must be specified");var a=this;if(!i)return s.asPromise(e,a,t,n,r,o);if(a.rpcImpl)try{return a.rpcImpl(t,n[a.requestDelimited?"encodeDelimited":"encode"](o).finish(),(function(e,n){if(e)return a.emit("error",e,t),i(e);if(null!==n){if(!(n instanceof r))try{n=r[a.responseDelimited?"decodeDelimited":"decode"](n)}catch(e){return a.emit("error",e,t),i(e)}return a.emit("data",n,t),i(null,n)}a.end(!0)}))}catch(e){return a.emit("error",e,t),void setTimeout((function(){i(e)}),0)}else setTimeout((function(){i(Error("already ended"))}),0)},r.prototype.end=function(e){return this.rpcImpl&&(e||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this}},71452:function(e,t,n){"use strict";e.exports=r;var s=n(44932);function r(e,t){this.lo=e>>>0,this.hi=t>>>0}var o=r.zero=new r(0,0);o.toNumber=function(){return 0},o.zzEncode=o.zzDecode=function(){return this},o.length=function(){return 1};var i=r.zeroHash="\0\0\0\0\0\0\0\0";r.fromNumber=function(e){if(0===e)return o;var t=e<0;t&&(e=-e);var n=e>>>0,s=(e-n)/4294967296>>>0;return t&&(s=~s>>>0,n=~n>>>0,++n>4294967295&&(n=0,++s>4294967295&&(s=0))),new r(n,s)},r.from=function(e){if("number"==typeof e)return r.fromNumber(e);if(s.isString(e)){if(!s.Long)return r.fromNumber(parseInt(e,10));e=s.Long.fromString(e)}return e.low||e.high?new r(e.low>>>0,e.high>>>0):o},r.prototype.toNumber=function(e){if(!e&&this.hi>>>31){var t=1+~this.lo>>>0,n=~this.hi>>>0;return t||(n=n+1>>>0),-(t+4294967296*n)}return this.lo+4294967296*this.hi},r.prototype.toLong=function(e){return s.Long?new s.Long(0|this.lo,0|this.hi,Boolean(e)):{low:0|this.lo,high:0|this.hi,unsigned:Boolean(e)}};var a=String.prototype.charCodeAt;r.fromHash=function(e){return e===i?o:new r((a.call(e,0)|a.call(e,1)<<8|a.call(e,2)<<16|a.call(e,3)<<24)>>>0,(a.call(e,4)|a.call(e,5)<<8|a.call(e,6)<<16|a.call(e,7)<<24)>>>0)},r.prototype.toHash=function(){return String.fromCharCode(255&this.lo,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,255&this.hi,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},r.prototype.zzEncode=function(){var e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this},r.prototype.zzDecode=function(){var e=-(1&this.lo);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this},r.prototype.length=function(){var e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return 0===n?0===t?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:n<128?9:10}},44932:function(e,t,n){"use strict";var s=t;function r(e,t,n){for(var s=Object.keys(t),r=0;r<s.length;++r)void 0!==e[s[r]]&&n||(e[s[r]]=t[s[r]]);return e}function o(e){function t(e,n){if(!(this instanceof t))return new t(e,n);Object.defineProperty(this,"message",{get:function(){return e}}),Error.captureStackTrace?Error.captureStackTrace(this,t):Object.defineProperty(this,"stack",{value:(new Error).stack||""}),n&&r(this,n)}return(t.prototype=Object.create(Error.prototype)).constructor=t,Object.defineProperty(t.prototype,"name",{get:function(){return e}}),t.prototype.toString=function(){return this.name+": "+this.message},t}s.asPromise=n(18045),s.base64=n(8839),s.EventEmitter=n(24358),s.float=n(49410),s.inquire=n(84153),s.utf8=n(81447),s.pool=n(99390),s.LongBits=n(71452),s.isNode=Boolean(void 0!==n.g&&n.g&&n.g.process&&n.g.process.versions&&n.g.process.versions.node),s.global=s.isNode&&n.g||"undefined"!=typeof window&&window||"undefined"!=typeof self&&self||this,s.emptyArray=Object.freeze?Object.freeze([]):[],s.emptyObject=Object.freeze?Object.freeze({}):{},s.isInteger=Number.isInteger||function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e},s.isString=function(e){return"string"==typeof e||e instanceof String},s.isObject=function(e){return e&&"object"==typeof e},s.isset=s.isSet=function(e,t){var n=e[t];return!(null==n||!e.hasOwnProperty(t))&&("object"!=typeof n||(Array.isArray(n)?n.length:Object.keys(n).length)>0)},s.Buffer=function(){try{var e=s.inquire("buffer").Buffer;return e.prototype.utf8Write?e:null}catch(e){return null}}(),s._Buffer_from=null,s._Buffer_allocUnsafe=null,s.newBuffer=function(e){return"number"==typeof e?s.Buffer?s._Buffer_allocUnsafe(e):new s.Array(e):s.Buffer?s._Buffer_from(e):"undefined"==typeof Uint8Array?e:new Uint8Array(e)},s.Array="undefined"!=typeof Uint8Array?Uint8Array:Array,s.Long=s.global.dcodeIO&&s.global.dcodeIO.Long||s.global.Long||s.inquire("long"),s.key2Re=/^true|false|0|1$/,s.key32Re=/^-?(?:0|[1-9][0-9]*)$/,s.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,s.longToHash=function(e){return e?s.LongBits.from(e).toHash():s.LongBits.zeroHash},s.longFromHash=function(e,t){var n=s.LongBits.fromHash(e);return s.Long?s.Long.fromBits(n.lo,n.hi,t):n.toNumber(Boolean(t))},s.merge=r,s.lcFirst=function(e){return e.charAt(0).toLowerCase()+e.substring(1)},s.newError=o,s.ProtocolError=o("ProtocolError"),s.oneOfGetter=function(e){for(var t={},n=0;n<e.length;++n)t[e[n]]=1;return function(){for(var e=Object.keys(this),n=e.length-1;n>-1;--n)if(1===t[e[n]]&&void 0!==this[e[n]]&&null!==this[e[n]])return e[n]}},s.oneOfSetter=function(e){return function(t){for(var n=0;n<e.length;++n)e[n]!==t&&delete this[e[n]]}},s.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},s._configure=function(){var e=s.Buffer;e?(s._Buffer_from=e.from!==Uint8Array.from&&e.from||function(t,n){return new e(t,n)},s._Buffer_allocUnsafe=e.allocUnsafe||function(t){return new e(t)}):s._Buffer_from=s._Buffer_allocUnsafe=null}},1336:function(e,t,n){"use strict";e.exports=u;var s,r=n(44932),o=r.LongBits,i=r.base64,a=r.utf8;function c(e,t,n){this.fn=e,this.len=t,this.next=void 0,this.val=n}function l(){}function d(e){this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}function u(){this.len=0,this.head=new c(l,0,0),this.tail=this.head,this.states=null}var h=function(){return r.Buffer?function(){return(u.create=function(){return new s})()}:function(){return new u}};function p(e,t,n){t[n]=255&e}function f(e,t){this.len=e,this.next=void 0,this.val=t}function y(e,t,n){for(;e.hi;)t[n++]=127&e.lo|128,e.lo=(e.lo>>>7|e.hi<<25)>>>0,e.hi>>>=7;for(;e.lo>127;)t[n++]=127&e.lo|128,e.lo=e.lo>>>7;t[n++]=e.lo}function g(e,t,n){t[n]=255&e,t[n+1]=e>>>8&255,t[n+2]=e>>>16&255,t[n+3]=e>>>24}u.create=h(),u.alloc=function(e){return new r.Array(e)},r.Array!==Array&&(u.alloc=r.pool(u.alloc,r.Array.prototype.subarray)),u.prototype._push=function(e,t,n){return this.tail=this.tail.next=new c(e,t,n),this.len+=t,this},f.prototype=Object.create(c.prototype),f.prototype.fn=function(e,t,n){for(;e>127;)t[n++]=127&e|128,e>>>=7;t[n]=e},u.prototype.uint32=function(e){return this.len+=(this.tail=this.tail.next=new f((e>>>=0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this},u.prototype.int32=function(e){return e<0?this._push(y,10,o.fromNumber(e)):this.uint32(e)},u.prototype.sint32=function(e){return this.uint32((e<<1^e>>31)>>>0)},u.prototype.uint64=function(e){var t=o.from(e);return this._push(y,t.length(),t)},u.prototype.int64=u.prototype.uint64,u.prototype.sint64=function(e){var t=o.from(e).zzEncode();return this._push(y,t.length(),t)},u.prototype.bool=function(e){return this._push(p,1,e?1:0)},u.prototype.fixed32=function(e){return this._push(g,4,e>>>0)},u.prototype.sfixed32=u.prototype.fixed32,u.prototype.fixed64=function(e){var t=o.from(e);return this._push(g,4,t.lo)._push(g,4,t.hi)},u.prototype.sfixed64=u.prototype.fixed64,u.prototype.float=function(e){return this._push(r.float.writeFloatLE,4,e)},u.prototype.double=function(e){return this._push(r.float.writeDoubleLE,8,e)};var m=r.Array.prototype.set?function(e,t,n){t.set(e,n)}:function(e,t,n){for(var s=0;s<e.length;++s)t[n+s]=e[s]};u.prototype.bytes=function(e){var t=e.length>>>0;if(!t)return this._push(p,1,0);if(r.isString(e)){var n=u.alloc(t=i.length(e));i.decode(e,n,0),e=n}return this.uint32(t)._push(m,t,e)},u.prototype.string=function(e){var t=a.length(e);return t?this.uint32(t)._push(a.write,t,e):this._push(p,1,0)},u.prototype.fork=function(){return this.states=new d(this),this.head=this.tail=new c(l,0,0),this.len=0,this},u.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new c(l,0,0),this.len=0),this},u.prototype.ldelim=function(){var e=this.head,t=this.tail,n=this.len;return this.reset().uint32(n),n&&(this.tail.next=e.next,this.tail=t,this.len+=n),this},u.prototype.finish=function(){for(var e=this.head.next,t=this.constructor.alloc(this.len),n=0;e;)e.fn(e.val,t,n),n+=e.len,e=e.next;return t},u._configure=function(e){s=e,u.create=h(),s._configure()}},97337:function(e,t,n){"use strict";e.exports=o;var s=n(1336);(o.prototype=Object.create(s.prototype)).constructor=o;var r=n(44932);function o(){s.call(this)}function i(e,t,n){e.length<40?r.utf8.write(e,t,n):t.utf8Write?t.utf8Write(e,n):t.write(e,n)}o._configure=function(){o.alloc=r._Buffer_allocUnsafe,o.writeBytesBuffer=r.Buffer&&r.Buffer.prototype instanceof Uint8Array&&"set"===r.Buffer.prototype.set.name?function(e,t,n){t.set(e,n)}:function(e,t,n){if(e.copy)e.copy(t,n,0,e.length);else for(var s=0;s<e.length;)t[n++]=e[s++]}},o.prototype.bytes=function(e){r.isString(e)&&(e=r._Buffer_from(e,"base64"));var t=e.length>>>0;return this.uint32(t),t&&this._push(o.writeBytesBuffer,t,e),this},o.prototype.string=function(e){var t=r.Buffer.byteLength(e);return this.uint32(t),t&&this._push(i,t,e),this},o._configure()},7913:function(e){e.exports=function e(s,r){var o,i=0,a=0,c=r=r||0,l=s.length;do{if(c>=l||a>49)throw e.bytes=0,new RangeError("Could not decode varint");o=s[c++],i+=a<28?(o&n)<<a:(o&n)*Math.pow(2,a),a+=7}while(o>=t);return e.bytes=c-r,i};var t=128,n=127},3451:function(e){e.exports=function e(r,o,i){if(Number.MAX_SAFE_INTEGER&&r>Number.MAX_SAFE_INTEGER)throw e.bytes=0,new RangeError("Could not encode varint");o=o||[];var a=i=i||0;for(;r>=s;)o[i++]=255&r|t,r/=128;for(;r&n;)o[i++]=255&r|t,r>>>=7;return o[i]=0|r,e.bytes=i-a+1,o};var t=128,n=-128,s=Math.pow(2,31)},98343:function(e,t,n){e.exports={encode:n(3451),decode:n(7913),encodingLength:n(21975)}},21975:function(e){var t=Math.pow(2,7),n=Math.pow(2,14),s=Math.pow(2,21),r=Math.pow(2,28),o=Math.pow(2,35),i=Math.pow(2,42),a=Math.pow(2,49),c=Math.pow(2,56),l=Math.pow(2,63);e.exports=function(e){return e<t?1:e<n?2:e<s?3:e<r?4:e<o?5:e<i?6:e<a?7:e<c?8:e<l?9:10}},87726:function(e){e.exports=function e(s,r){var o,i=0,a=0,c=r=r||0,l=s.length;do{if(c>=l||a>49)throw e.bytes=0,new RangeError("Could not decode varint");o=s[c++],i+=a<28?(o&n)<<a:(o&n)*Math.pow(2,a),a+=7}while(o>=t);return e.bytes=c-r,i};var t=128,n=127},98946:function(e){e.exports=function e(r,o,i){if(Number.MAX_SAFE_INTEGER&&r>Number.MAX_SAFE_INTEGER)throw e.bytes=0,new RangeError("Could not encode varint");o=o||[];var a=i=i||0;for(;r>=s;)o[i++]=255&r|t,r/=128;for(;r&n;)o[i++]=255&r|t,r>>>=7;return o[i]=0|r,e.bytes=i-a+1,o};var t=128,n=-128,s=Math.pow(2,31)},2130:function(e,t,n){e.exports={encode:n(98946),decode:n(87726),encodingLength:n(96984)}},96984:function(e){var t=Math.pow(2,7),n=Math.pow(2,14),s=Math.pow(2,21),r=Math.pow(2,28),o=Math.pow(2,35),i=Math.pow(2,42),a=Math.pow(2,49),c=Math.pow(2,56),l=Math.pow(2,63);e.exports=function(e){return e<t?1:e<n?2:e<s?3:e<r?4:e<o?5:e<i?6:e<a?7:e<c?8:e<l?9:10}},19412:function(e){"use strict";e.exports=async function*(e,t={}){const n=e.getReader();try{for(;;){const e=await n.read();if(e.done)return;yield e.value}}finally{!0!==t.preventCancel&&n.cancel(),n.releaseLock()}}},43700:function(e){"use strict";e.exports=async e=>{const t=[];for await(const n of e)t.push(n);return t}},28493:function(e,t,n){"use strict";var s=n(65606);const r=n(4866),o="object"==typeof window&&"object"==typeof document&&9===document.nodeType,i=r(),a=o&&!i,c=i&&!o,l=i&&o,d=void 0!==s&&void 0!==s.release&&"node"===s.release.name&&!i,u="function"==typeof importScripts&&"undefined"!=typeof self&&"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope,h=void 0!==s&&void 0!==s.env&&!1,p="undefined"!=typeof navigator&&"ReactNative"===navigator.product;e.exports={isTest:h,isElectron:i,isElectronMain:c,isElectronRenderer:l,isNode:d,isBrowser:a,isWebWorker:u,isEnvWithDom:o,isReactNative:p}},80868:function(e,t,n){"use strict";e.exports=n(90750)},68086:function(e,t,n){"use strict";const s=n(93431);async function*r(e,t){const n=new s,r=await n.get(e,t);yield*r.iterator()}e.exports=(e,t)=>({path:decodeURIComponent(new URL(e).pathname.split("/").pop()||""),content:r(e,t)})},93431:function(e,t,n){"use strict";const{fetch:s,Request:r,Headers:o}=n(12537),{TimeoutError:i,HTTPError:a}=n(69505),c=n(6864).bind({ignoreUndefined:!0}),{URL:l,URLSearchParams:d}=n(26438),u=n(44708),h=n(19412),{isBrowser:p,isWebWorker:f}=n(28493),y=n(43700),g={throwHttpErrors:!0,credentials:"same-origin"};class m{constructor(e={}){this.opts=c(g,e)}async fetch(e,t={}){const n=c(this.opts,t),g=new o(n.headers);if("string"!=typeof e&&!(e instanceof l||e instanceof r))throw new TypeError("`resource` must be a string, URL, or Request");const m=new l(e.toString(),n.base),{searchParams:_,transformSearchParams:E,json:v}=n;_&&(m.search="function"==typeof E?E(new d(n.searchParams)):new d(n.searchParams)),v&&(n.body=JSON.stringify(n.json),g.set("content-type","application/json"));const S=new AbortController,k=u([S.signal,n.signal]);null!=globalThis.ReadableStream&&n.body instanceof globalThis.ReadableStream&&(p||f)&&(n.body=new Blob(await y(h(n.body))));const R=await((e,t,n)=>{if(void 0===t)return e;const s=Date.now(),r=()=>Date.now()-s>=t;return new Promise(((s,o)=>{const a=setTimeout((()=>{r()&&(o(new i),n.abort())}),t),c=e=>t=>{clearTimeout(a),r()?o(new i):e(t)};e.then(c(s),c(o))}))})(s(m.toString(),{...n,signal:k,timeout:void 0,headers:g,duplex:"half"}),n.timeout,S);if(!R.ok&&n.throwHttpErrors)throw n.handleError&&await n.handleError(R),new a(R);return R.iterator=async function*(){yield*b(R.body)},R.ndjson=async function*(){for await(const e of w(R.iterator()))t.transform?yield t.transform(e):yield e},R}post(e,t={}){return this.fetch(e,{...t,method:"POST"})}get(e,t={}){return this.fetch(e,{...t,method:"GET"})}put(e,t={}){return this.fetch(e,{...t,method:"PUT"})}delete(e,t={}){return this.fetch(e,{...t,method:"DELETE"})}options(e,t={}){return this.fetch(e,{...t,method:"OPTIONS"})}}const w=async function*(e){const t=new TextDecoder;let n="";for await(const s of e){n+=t.decode(s,{stream:!0});const e=n.split(/\r?\n/);for(let t=0;t<e.length-1;t++){const n=e[t].trim();n.length>0&&(yield JSON.parse(n))}n=e[e.length-1]}n+=t.decode(),n=n.trim(),0!==n.length&&(yield JSON.parse(n))},b=e=>{if(_(e))return e;if(v(e)){const t=e[Symbol.asyncIterator]();return{[Symbol.asyncIterator]:()=>({next:t.next.bind(t),return:n=>(e.destroy(),"function"==typeof t.return?t.return():Promise.resolve({done:!0,value:n}))})}}if(E(e)){const t=e.getReader();return async function*(){try{for(;;){const{done:e,value:n}=await t.read();if(e)return;n&&(yield n)}}finally{t.releaseLock()}}()}throw new TypeError("Body can't be converted to AsyncIterable")},_=e=>"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.asyncIterator],E=e=>e&&"function"==typeof e.getReader,v=e=>Object.prototype.hasOwnProperty.call(e,"readable")&&Object.prototype.hasOwnProperty.call(e,"writable");m.HTTPError=a,m.TimeoutError=i,m.streamToAsyncIterator=b,m.post=(e,t)=>new m(t).post(e,t),m.get=(e,t)=>new m(t).get(e,t),m.put=(e,t)=>new m(t).put(e,t),m.delete=(e,t)=>new m(t).delete(e,t),m.options=(e,t)=>new m(t).options(e,t),e.exports=m},69505:function(e,t){"use strict";class n extends Error{constructor(e="Request timed out"){super(e),this.name="TimeoutError"}}t.TimeoutError=n;class s extends Error{constructor(e="The operation was aborted."){super(e),this.name="AbortError"}}t.AbortError=s;class r extends Error{constructor(e){super(e.statusText),this.name="HTTPError",this.response=e}}t.HTTPError=r},12537:function(e,t,n){"use strict";const{TimeoutError:s,AbortError:r}=n(69505),{Response:o,Request:i,Headers:a,default:c}=n(80868),l=c,d=e=>{const t=new a;for(const n of e.trim().split(/[\r\n]+/)){const e=n.indexOf(": ");e>0&&t.set(n.slice(0,e),n.slice(e+1))}return t};class u extends o{constructor(e,t,n){super(t,n),Object.defineProperty(this,"url",{value:e})}}e.exports={fetch:(e,t={})=>null!=t.onUploadProgress?((e,t={})=>{const n=new XMLHttpRequest;n.open(t.method||"GET",e.toString(),!0);const{timeout:i,headers:c}=t;if(i&&i>0&&i<1/0&&(n.timeout=i),null!=t.overrideMimeType&&n.overrideMimeType(t.overrideMimeType),c)for(const[e,t]of new a(c))n.setRequestHeader(e,t);return t.signal&&(t.signal.onabort=()=>n.abort()),t.onUploadProgress&&(n.upload.onprogress=t.onUploadProgress),n.responseType="arraybuffer",new Promise(((e,i)=>{const a=t=>{switch(t.type){case"error":e(o.error());break;case"load":e(new u(n.responseURL,n.response,{status:n.status,statusText:n.statusText,headers:d(n.getAllResponseHeaders())}));break;case"timeout":i(new s);break;case"abort":i(new r)}};n.onerror=a,n.onload=a,n.ontimeout=a,n.onabort=a,n.send(t.body)}))})(e,t):l(e,t),Request:i,Headers:a}},83192:function(e){"use strict";var t=/^(?:[a-z0-9](?:[a-z0-9\-]{0,61}[a-z0-9])?\.){0,126}(?:[a-z0-9](?:[a-z0-9\-]{0,61}[a-z0-9]))\.?$/i;e.exports=function(e,n){if(null==n&&(n=!1),e.length<2)return!1;if(e.length>255)return!1;var s=e[e.length-1];if(n){if("."!==s)return!1}else if("."===s)return!1;return t.test(e)}},4866:function(e,t,n){var s=n(65606);e.exports=function(){return"undefined"!=typeof window&&"object"==typeof window.process&&"renderer"===window.process.type||(!(void 0===s||"object"!=typeof s.versions||!s.versions.electron)||"object"==typeof navigator&&"string"==typeof navigator.userAgent&&navigator.userAgent.indexOf("Electron")>=0)}},21956:function(e){e.exports=function e(s,r){var o,i=0,a=0,c=r=r||0,l=s.length;do{if(c>=l||a>49)throw e.bytes=0,new RangeError("Could not decode varint");o=s[c++],i+=a<28?(o&n)<<a:(o&n)*Math.pow(2,a),a+=7}while(o>=t);return e.bytes=c-r,i};var t=128,n=127},57036:function(e){e.exports=function e(r,o,i){if(Number.MAX_SAFE_INTEGER&&r>Number.MAX_SAFE_INTEGER)throw e.bytes=0,new RangeError("Could not encode varint");o=o||[];var a=i=i||0;for(;r>=s;)o[i++]=255&r|t,r/=128;for(;r&n;)o[i++]=255&r|t,r>>>=7;return o[i]=0|r,e.bytes=i-a+1,o};var t=128,n=-128,s=Math.pow(2,31)},79344:function(e,t,n){e.exports={encode:n(57036),decode:n(21956),encodingLength:n(16206)}},16206:function(e){var t=Math.pow(2,7),n=Math.pow(2,14),s=Math.pow(2,21),r=Math.pow(2,28),o=Math.pow(2,35),i=Math.pow(2,42),a=Math.pow(2,49),c=Math.pow(2,56),l=Math.pow(2,63);e.exports=function(e){return e<t?1:e<n?2:e<s?3:e<r?4:e<o?5:e<i?6:e<a?7:e<c?8:e<l?9:10}},22604:function(e){"use strict";e.exports={RTLD_LAZY:1,RTLD_NOW:2,RTLD_GLOBAL:256,RTLD_LOCAL:0,RTLD_DEEPBIND:8,E2BIG:7,EACCES:13,EADDRINUSE:98,EADDRNOTAVAIL:99,EAFNOSUPPORT:97,EAGAIN:11,EALREADY:114,EBADF:9,EBADMSG:74,EBUSY:16,ECANCELED:125,ECHILD:10,ECONNABORTED:103,ECONNREFUSED:111,ECONNRESET:104,EDEADLK:35,EDESTADDRREQ:89,EDOM:33,EDQUOT:122,EEXIST:17,EFAULT:14,EFBIG:27,EHOSTUNREACH:113,EIDRM:43,EILSEQ:84,EINPROGRESS:115,EINTR:4,EINVAL:22,EIO:5,EISCONN:106,EISDIR:21,ELOOP:40,EMFILE:24,EMLINK:31,EMSGSIZE:90,EMULTIHOP:72,ENAMETOOLONG:36,ENETDOWN:100,ENETRESET:102,ENETUNREACH:101,ENFILE:23,ENOBUFS:105,ENODATA:61,ENODEV:19,ENOENT:2,ENOEXEC:8,ENOLCK:37,ENOLINK:67,ENOMEM:12,ENOMSG:42,ENOPROTOOPT:92,ENOSPC:28,ENOSR:63,ENOSTR:60,ENOSYS:38,ENOTCONN:107,ENOTDIR:20,ENOTEMPTY:39,ENOTSOCK:88,ENOTSUP:95,ENOTTY:25,ENXIO:6,EOPNOTSUPP:95,EOVERFLOW:75,EPERM:1,EPIPE:32,EPROTO:71,EPROTONOSUPPORT:93,EPROTOTYPE:91,ERANGE:34,EROFS:30,ESPIPE:29,ESRCH:3,ESTALE:116,ETIME:62,ETIMEDOUT:110,ETXTBSY:26,EWOULDBLOCK:11,EXDEV:18,PRIORITY_LOW:19,PRIORITY_BELOW_NORMAL:10,PRIORITY_NORMAL:0,PRIORITY_ABOVE_NORMAL:-7,PRIORITY_HIGH:-14,PRIORITY_HIGHEST:-20,SIGHUP:1,SIGINT:2,SIGQUIT:3,SIGILL:4,SIGTRAP:5,SIGABRT:6,SIGIOT:6,SIGBUS:7,SIGFPE:8,SIGKILL:9,SIGUSR1:10,SIGSEGV:11,SIGUSR2:12,SIGPIPE:13,SIGALRM:14,SIGTERM:15,SIGCHLD:17,SIGSTKFLT:16,SIGCONT:18,SIGSTOP:19,SIGTSTP:20,SIGTTIN:21,SIGTTOU:22,SIGURG:23,SIGXCPU:24,SIGXFSZ:25,SIGVTALRM:26,SIGPROF:27,SIGWINCH:28,SIGIO:29,SIGPOLL:29,SIGPWR:30,SIGSYS:31,UV_FS_SYMLINK_DIR:1,UV_FS_SYMLINK_JUNCTION:2,O_RDONLY:0,O_WRONLY:1,O_RDWR:2,UV_DIRENT_UNKNOWN:0,UV_DIRENT_FILE:1,UV_DIRENT_DIR:2,UV_DIRENT_LINK:3,UV_DIRENT_FIFO:4,UV_DIRENT_SOCKET:5,UV_DIRENT_CHAR:6,UV_DIRENT_BLOCK:7,S_IFMT:61440,S_IFREG:32768,S_IFDIR:16384,S_IFCHR:8192,S_IFBLK:24576,S_IFIFO:4096,S_IFLNK:40960,S_IFSOCK:49152,O_CREAT:64,O_EXCL:128,UV_FS_O_FILEMAP:0,O_NOCTTY:256,O_TRUNC:512,O_APPEND:1024,O_DIRECTORY:65536,O_NOATIME:262144,O_NOFOLLOW:131072,O_SYNC:1052672,O_DSYNC:4096,O_DIRECT:16384,O_NONBLOCK:2048,S_IRWXU:448,S_IRUSR:256,S_IWUSR:128,S_IXUSR:64,S_IRWXG:56,S_IRGRP:32,S_IWGRP:16,S_IXGRP:8,S_IRWXO:7,S_IROTH:4,S_IWOTH:2,S_IXOTH:1,F_OK:0,R_OK:4,W_OK:2,X_OK:1,UV_FS_COPYFILE_EXCL:1,COPYFILE_EXCL:1,UV_FS_COPYFILE_FICLONE:2,COPYFILE_FICLONE:2,UV_FS_COPYFILE_FICLONE_FORCE:4,COPYFILE_FICLONE_FORCE:4,OPENSSL_VERSION_NUMBER:805306496,SSL_OP_ALL:2147485776,SSL_OP_ALLOW_NO_DHE_KEX:1024,SSL_OP_ALLOW_UNSAFE_LEGACY_RENEGOTIATION:262144,SSL_OP_CIPHER_SERVER_PREFERENCE:4194304,SSL_OP_CISCO_ANYCONNECT:32768,SSL_OP_COOKIE_EXCHANGE:8192,SSL_OP_CRYPTOPRO_TLSEXT_BUG:2147483648,SSL_OP_DONT_INSERT_EMPTY_FRAGMENTS:2048,SSL_OP_EPHEMERAL_RSA:0,SSL_OP_LEGACY_SERVER_CONNECT:4,SSL_OP_MICROSOFT_BIG_SSLV3_BUFFER:0,SSL_OP_MICROSOFT_SESS_ID_BUG:0,SSL_OP_MSIE_SSLV2_RSA_PADDING:0,SSL_OP_NETSCAPE_CA_DN_BUG:0,SSL_OP_NETSCAPE_CHALLENGE_BUG:0,SSL_OP_NETSCAPE_DEMO_CIPHER_CHANGE_BUG:0,SSL_OP_NETSCAPE_REUSE_CIPHER_CHANGE_BUG:0,SSL_OP_NO_COMPRESSION:131072,SSL_OP_NO_ENCRYPT_THEN_MAC:524288,SSL_OP_NO_QUERY_MTU:4096,SSL_OP_NO_RENEGOTIATION:1073741824,SSL_OP_NO_SESSION_RESUMPTION_ON_RENEGOTIATION:65536,SSL_OP_NO_SSLv2:0,SSL_OP_NO_SSLv3:33554432,SSL_OP_NO_TICKET:16384,SSL_OP_NO_TLSv1:67108864,SSL_OP_NO_TLSv1_1:268435456,SSL_OP_NO_TLSv1_2:134217728,SSL_OP_NO_TLSv1_3:536870912,SSL_OP_PKCS1_CHECK_1:0,SSL_OP_PKCS1_CHECK_2:0,SSL_OP_PRIORITIZE_CHACHA:2097152,SSL_OP_SINGLE_DH_USE:0,SSL_OP_SINGLE_ECDH_USE:0,SSL_OP_SSLEAY_080_CLIENT_DH_BUG:0,SSL_OP_SSLREF2_REUSE_CERT_TYPE_BUG:0,SSL_OP_TLS_BLOCK_PADDING_BUG:0,SSL_OP_TLS_D5_BUG:0,SSL_OP_TLS_ROLLBACK_BUG:8388608,ENGINE_METHOD_RSA:1,ENGINE_METHOD_DSA:2,ENGINE_METHOD_DH:4,ENGINE_METHOD_RAND:8,ENGINE_METHOD_EC:2048,ENGINE_METHOD_CIPHERS:64,ENGINE_METHOD_DIGESTS:128,ENGINE_METHOD_PKEY_METHS:512,ENGINE_METHOD_PKEY_ASN1_METHS:1024,ENGINE_METHOD_ALL:65535,ENGINE_METHOD_NONE:0,DH_CHECK_P_NOT_SAFE_PRIME:2,DH_CHECK_P_NOT_PRIME:1,DH_UNABLE_TO_CHECK_GENERATOR:4,DH_NOT_SUITABLE_GENERATOR:8,ALPN_ENABLED:1,RSA_PKCS1_PADDING:1,RSA_NO_PADDING:3,RSA_PKCS1_OAEP_PADDING:4,RSA_X931_PADDING:5,RSA_PKCS1_PSS_PADDING:6,RSA_PSS_SALTLEN_DIGEST:-1,RSA_PSS_SALTLEN_MAX_SIGN:-2,RSA_PSS_SALTLEN_AUTO:-2,defaultCoreCipherList:"TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384:DHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA256:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!SRP:!CAMELLIA",TLS1_VERSION:769,TLS1_1_VERSION:770,TLS1_2_VERSION:771,TLS1_3_VERSION:772,POINT_CONVERSION_COMPRESSED:2,POINT_CONVERSION_UNCOMPRESSED:4,POINT_CONVERSION_HYBRID:6,defaultCipherList:"TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384:DHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA256:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!SRP:!CAMELLIA"}},52579:function(e){"use strict";const t=65536;e.exports=function(e){const n=new Uint8Array(e);let s=0;if(e>0)if(e>t)for(;s<e;)s+t>e?(crypto.getRandomValues(n.subarray(s,s+(e-s))),s+=e-s):(crypto.getRandomValues(n.subarray(s,s+t)),s+=t);else crypto.getRandomValues(n);return n}},26438:function(e,t,n){"use strict";const{URLWithLegacySupport:s,format:r,URLSearchParams:o,defaultBase:i}=n(17911),a=n(52331);e.exports={URL:s,URLSearchParams:o,format:r,relative:a,defaultBase:i}},52331:function(e,t,n){"use strict";const{URLWithLegacySupport:s,format:r}=n(17911);e.exports=(e,t={},n={},o)=>{let i,a=t.protocol?t.protocol.replace(":",""):"http";a=(n[a]||o||a)+":";try{i=new s(e)}catch(e){i={}}const c=Object.assign({},t,{protocol:a||i.protocol,host:t.host||i.host});return new s(e,r(c)).toString()}},17911:function(e){"use strict";const t="undefined"!=typeof navigator&&"ReactNative"===navigator.product;const n=self.URL,s=t?"http://localhost":self.location?self.location.protocol+"//"+self.location.host:"";e.exports={URLWithLegacySupport:class{constructor(e="",t=s){this.super=new n(e,t),this.path=this.pathname+this.search,this.auth=this.username&&this.password?this.username+":"+this.password:null,this.query=this.search&&this.search.startsWith("?")?this.search.slice(1):null}get hash(){return this.super.hash}get host(){return this.super.host}get hostname(){return this.super.hostname}get href(){return this.super.href}get origin(){return this.super.origin}get password(){return this.super.password}get pathname(){return this.super.pathname}get port(){return this.super.port}get protocol(){return this.super.protocol}get search(){return this.super.search}get searchParams(){return this.super.searchParams}get username(){return this.super.username}set hash(e){this.super.hash=e}set host(e){this.super.host=e}set hostname(e){this.super.hostname=e}set href(e){this.super.href=e}set password(e){this.super.password=e}set pathname(e){this.super.pathname=e}set port(e){this.super.port=e}set protocol(e){this.super.protocol=e}set search(e){this.super.search=e}set username(e){this.super.username=e}static createObjectURL(e){return n.createObjectURL(e)}static revokeObjectURL(e){n.revokeObjectURL(e)}toJSON(){return this.super.toJSON()}toString(){return this.super.toString()}format(){return this.toString()}},URLSearchParams:self.URLSearchParams,defaultBase:s,format:function(e){if("string"==typeof e){return new n(e).toString()}if(!(e instanceof n)){const t=e.username&&e.password?`${e.username}:${e.password}@`:"",n=e.auth?e.auth+"@":"",s=e.port?":"+e.port:"",r=e.protocol?e.protocol+"//":"",o=e.host||"",i=e.hostname||"",a=e.search||(e.query?"?"+e.query:""),c=e.hash||"",l=e.pathname||"";return`${r}${t||n}${o||i+s}${e.path||l+a}${c}`}}}},69054:function(e,t,n){e.exports=n(28347),e.exports.parse=n(28347),e.exports.stringify=n(76499)},28347:function(e){e.exports=e=>async function*(){const t=/\r?\n/,n=new TextDecoder("utf8");let s="";for await(let r of e){"string"==typeof r&&(r=(new TextEncoder).encode(r)),s+=n.decode(r,{stream:!0});const e=s.split(t);s=e.pop();for(let t=0;t<e.length;t++)yield JSON.parse(e[t])}s+=n.decode(),s&&(yield JSON.parse(s))}()},76499:function(e){e.exports=e=>async function*(){for await(const t of e)yield JSON.stringify(t)+"\n"}()},29760:function(e,t,n){"use strict";n.d(t,{A:function(){return s}});var s=function(e,t,n){var s=null,r=null,o=function(){s&&(clearTimeout(s),r=null,s=null)},i=function(){if(!t)return e.apply(this,arguments);var i=this,a=arguments,c=n&&!s;return o(),r=function(){e.apply(i,a)},s=setTimeout((function(){if(s=null,!c){var e=r;return r=null,e()}}),t),c?r():void 0};return i.cancel=o,i.flush=function(){var e=r;o(),e&&e()},i}},33169:function(e,t,n){var s,r,o;r=[n(26021)],void 0===(o="function"==typeof(s=function(e){"use strict";var t=e.Reader,n=e.Writer,s=e.util,r=e.roots.default||(e.roots.default={});return r.RPC=function(){function o(e){if(this.subscriptions=[],this.messages=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}var i;return o.prototype.subscriptions=s.emptyArray,o.prototype.messages=s.emptyArray,o.prototype.control=null,Object.defineProperty(o.prototype,"_control",{get:s.oneOfGetter(i=["control"]),set:s.oneOfSetter(i)}),o.encode=function(e,t){if(t||(t=n.create()),null!=e.subscriptions&&e.subscriptions.length)for(var s=0;s<e.subscriptions.length;++s)r.RPC.SubOpts.encode(e.subscriptions[s],t.uint32(10).fork()).ldelim();if(null!=e.messages&&e.messages.length)for(s=0;s<e.messages.length;++s)r.RPC.Message.encode(e.messages[s],t.uint32(18).fork()).ldelim();return null!=e.control&&Object.hasOwnProperty.call(e,"control")&&r.RPC.ControlMessage.encode(e.control,t.uint32(26).fork()).ldelim(),t},o.decode=function(e,n){e instanceof t||(e=t.create(e));for(var s=void 0===n?e.len:e.pos+n,o=new r.RPC;e.pos<s;){var i=e.uint32();switch(i>>>3){case 1:o.subscriptions&&o.subscriptions.length||(o.subscriptions=[]),o.subscriptions.push(r.RPC.SubOpts.decode(e,e.uint32()));break;case 2:o.messages&&o.messages.length||(o.messages=[]),o.messages.push(r.RPC.Message.decode(e,e.uint32()));break;case 3:o.control=r.RPC.ControlMessage.decode(e,e.uint32());break;default:e.skipType(7&i)}}return o},o.fromObject=function(e){if(e instanceof r.RPC)return e;var t=new r.RPC;if(e.subscriptions){if(!Array.isArray(e.subscriptions))throw TypeError(".RPC.subscriptions: array expected");t.subscriptions=[];for(var n=0;n<e.subscriptions.length;++n){if("object"!=typeof e.subscriptions[n])throw TypeError(".RPC.subscriptions: object expected");t.subscriptions[n]=r.RPC.SubOpts.fromObject(e.subscriptions[n])}}if(e.messages){if(!Array.isArray(e.messages))throw TypeError(".RPC.messages: array expected");for(t.messages=[],n=0;n<e.messages.length;++n){if("object"!=typeof e.messages[n])throw TypeError(".RPC.messages: object expected");t.messages[n]=r.RPC.Message.fromObject(e.messages[n])}}if(null!=e.control){if("object"!=typeof e.control)throw TypeError(".RPC.control: object expected");t.control=r.RPC.ControlMessage.fromObject(e.control)}return t},o.toObject=function(e,t){t||(t={});var n={};if((t.arrays||t.defaults)&&(n.subscriptions=[],n.messages=[]),e.subscriptions&&e.subscriptions.length){n.subscriptions=[];for(var s=0;s<e.subscriptions.length;++s)n.subscriptions[s]=r.RPC.SubOpts.toObject(e.subscriptions[s],t)}if(e.messages&&e.messages.length)for(n.messages=[],s=0;s<e.messages.length;++s)n.messages[s]=r.RPC.Message.toObject(e.messages[s],t);return null!=e.control&&e.hasOwnProperty("control")&&(n.control=r.RPC.ControlMessage.toObject(e.control,t),t.oneofs&&(n._control="control")),n},o.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},o.SubOpts=function(){function o(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}var i;return o.prototype.subscribe=null,o.prototype.topic=null,Object.defineProperty(o.prototype,"_subscribe",{get:s.oneOfGetter(i=["subscribe"]),set:s.oneOfSetter(i)}),Object.defineProperty(o.prototype,"_topic",{get:s.oneOfGetter(i=["topic"]),set:s.oneOfSetter(i)}),o.encode=function(e,t){return t||(t=n.create()),null!=e.subscribe&&Object.hasOwnProperty.call(e,"subscribe")&&t.uint32(8).bool(e.subscribe),null!=e.topic&&Object.hasOwnProperty.call(e,"topic")&&t.uint32(18).string(e.topic),t},o.decode=function(e,n){e instanceof t||(e=t.create(e));for(var s=void 0===n?e.len:e.pos+n,o=new r.RPC.SubOpts;e.pos<s;){var i=e.uint32();switch(i>>>3){case 1:o.subscribe=e.bool();break;case 2:o.topic=e.string();break;default:e.skipType(7&i)}}return o},o.fromObject=function(e){if(e instanceof r.RPC.SubOpts)return e;var t=new r.RPC.SubOpts;return null!=e.subscribe&&(t.subscribe=Boolean(e.subscribe)),null!=e.topic&&(t.topic=String(e.topic)),t},o.toObject=function(e,t){t||(t={});var n={};return null!=e.subscribe&&e.hasOwnProperty("subscribe")&&(n.subscribe=e.subscribe,t.oneofs&&(n._subscribe="subscribe")),null!=e.topic&&e.hasOwnProperty("topic")&&(n.topic=e.topic,t.oneofs&&(n._topic="topic")),n},o.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},o}(),o.Message=function(){function o(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}var i;return o.prototype.from=null,o.prototype.data=null,o.prototype.seqno=null,o.prototype.topic="",o.prototype.signature=null,o.prototype.key=null,Object.defineProperty(o.prototype,"_from",{get:s.oneOfGetter(i=["from"]),set:s.oneOfSetter(i)}),Object.defineProperty(o.prototype,"_data",{get:s.oneOfGetter(i=["data"]),set:s.oneOfSetter(i)}),Object.defineProperty(o.prototype,"_seqno",{get:s.oneOfGetter(i=["seqno"]),set:s.oneOfSetter(i)}),Object.defineProperty(o.prototype,"_signature",{get:s.oneOfGetter(i=["signature"]),set:s.oneOfSetter(i)}),Object.defineProperty(o.prototype,"_key",{get:s.oneOfGetter(i=["key"]),set:s.oneOfSetter(i)}),o.encode=function(e,t){return t||(t=n.create()),null!=e.from&&Object.hasOwnProperty.call(e,"from")&&t.uint32(10).bytes(e.from),null!=e.data&&Object.hasOwnProperty.call(e,"data")&&t.uint32(18).bytes(e.data),null!=e.seqno&&Object.hasOwnProperty.call(e,"seqno")&&t.uint32(26).bytes(e.seqno),t.uint32(34).string(e.topic),null!=e.signature&&Object.hasOwnProperty.call(e,"signature")&&t.uint32(42).bytes(e.signature),null!=e.key&&Object.hasOwnProperty.call(e,"key")&&t.uint32(50).bytes(e.key),t},o.decode=function(e,n){e instanceof t||(e=t.create(e));for(var o=void 0===n?e.len:e.pos+n,i=new r.RPC.Message;e.pos<o;){var a=e.uint32();switch(a>>>3){case 1:i.from=e.bytes();break;case 2:i.data=e.bytes();break;case 3:i.seqno=e.bytes();break;case 4:i.topic=e.string();break;case 5:i.signature=e.bytes();break;case 6:i.key=e.bytes();break;default:e.skipType(7&a)}}if(!i.hasOwnProperty("topic"))throw s.ProtocolError("missing required 'topic'",{instance:i});return i},o.fromObject=function(e){if(e instanceof r.RPC.Message)return e;var t=new r.RPC.Message;return null!=e.from&&("string"==typeof e.from?s.base64.decode(e.from,t.from=s.newBuffer(s.base64.length(e.from)),0):e.from.length&&(t.from=e.from)),null!=e.data&&("string"==typeof e.data?s.base64.decode(e.data,t.data=s.newBuffer(s.base64.length(e.data)),0):e.data.length&&(t.data=e.data)),null!=e.seqno&&("string"==typeof e.seqno?s.base64.decode(e.seqno,t.seqno=s.newBuffer(s.base64.length(e.seqno)),0):e.seqno.length&&(t.seqno=e.seqno)),null!=e.topic&&(t.topic=String(e.topic)),null!=e.signature&&("string"==typeof e.signature?s.base64.decode(e.signature,t.signature=s.newBuffer(s.base64.length(e.signature)),0):e.signature.length&&(t.signature=e.signature)),null!=e.key&&("string"==typeof e.key?s.base64.decode(e.key,t.key=s.newBuffer(s.base64.length(e.key)),0):e.key.length&&(t.key=e.key)),t},o.toObject=function(e,t){t||(t={});var n={};return t.defaults&&(n.topic=""),null!=e.from&&e.hasOwnProperty("from")&&(n.from=t.bytes===String?s.base64.encode(e.from,0,e.from.length):t.bytes===Array?Array.prototype.slice.call(e.from):e.from,t.oneofs&&(n._from="from")),null!=e.data&&e.hasOwnProperty("data")&&(n.data=t.bytes===String?s.base64.encode(e.data,0,e.data.length):t.bytes===Array?Array.prototype.slice.call(e.data):e.data,t.oneofs&&(n._data="data")),null!=e.seqno&&e.hasOwnProperty("seqno")&&(n.seqno=t.bytes===String?s.base64.encode(e.seqno,0,e.seqno.length):t.bytes===Array?Array.prototype.slice.call(e.seqno):e.seqno,t.oneofs&&(n._seqno="seqno")),null!=e.topic&&e.hasOwnProperty("topic")&&(n.topic=e.topic),null!=e.signature&&e.hasOwnProperty("signature")&&(n.signature=t.bytes===String?s.base64.encode(e.signature,0,e.signature.length):t.bytes===Array?Array.prototype.slice.call(e.signature):e.signature,t.oneofs&&(n._signature="signature")),null!=e.key&&e.hasOwnProperty("key")&&(n.key=t.bytes===String?s.base64.encode(e.key,0,e.key.length):t.bytes===Array?Array.prototype.slice.call(e.key):e.key,t.oneofs&&(n._key="key")),n},o.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},o}(),o.ControlMessage=function(){function o(e){if(this.ihave=[],this.iwant=[],this.graft=[],this.prune=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return o.prototype.ihave=s.emptyArray,o.prototype.iwant=s.emptyArray,o.prototype.graft=s.emptyArray,o.prototype.prune=s.emptyArray,o.encode=function(e,t){if(t||(t=n.create()),null!=e.ihave&&e.ihave.length)for(var s=0;s<e.ihave.length;++s)r.RPC.ControlIHave.encode(e.ihave[s],t.uint32(10).fork()).ldelim();if(null!=e.iwant&&e.iwant.length)for(s=0;s<e.iwant.length;++s)r.RPC.ControlIWant.encode(e.iwant[s],t.uint32(18).fork()).ldelim();if(null!=e.graft&&e.graft.length)for(s=0;s<e.graft.length;++s)r.RPC.ControlGraft.encode(e.graft[s],t.uint32(26).fork()).ldelim();if(null!=e.prune&&e.prune.length)for(s=0;s<e.prune.length;++s)r.RPC.ControlPrune.encode(e.prune[s],t.uint32(34).fork()).ldelim();return t},o.decode=function(e,n){e instanceof t||(e=t.create(e));for(var s=void 0===n?e.len:e.pos+n,o=new r.RPC.ControlMessage;e.pos<s;){var i=e.uint32();switch(i>>>3){case 1:o.ihave&&o.ihave.length||(o.ihave=[]),o.ihave.push(r.RPC.ControlIHave.decode(e,e.uint32()));break;case 2:o.iwant&&o.iwant.length||(o.iwant=[]),o.iwant.push(r.RPC.ControlIWant.decode(e,e.uint32()));break;case 3:o.graft&&o.graft.length||(o.graft=[]),o.graft.push(r.RPC.ControlGraft.decode(e,e.uint32()));break;case 4:o.prune&&o.prune.length||(o.prune=[]),o.prune.push(r.RPC.ControlPrune.decode(e,e.uint32()));break;default:e.skipType(7&i)}}return o},o.fromObject=function(e){if(e instanceof r.RPC.ControlMessage)return e;var t=new r.RPC.ControlMessage;if(e.ihave){if(!Array.isArray(e.ihave))throw TypeError(".RPC.ControlMessage.ihave: array expected");t.ihave=[];for(var n=0;n<e.ihave.length;++n){if("object"!=typeof e.ihave[n])throw TypeError(".RPC.ControlMessage.ihave: object expected");t.ihave[n]=r.RPC.ControlIHave.fromObject(e.ihave[n])}}if(e.iwant){if(!Array.isArray(e.iwant))throw TypeError(".RPC.ControlMessage.iwant: array expected");for(t.iwant=[],n=0;n<e.iwant.length;++n){if("object"!=typeof e.iwant[n])throw TypeError(".RPC.ControlMessage.iwant: object expected");t.iwant[n]=r.RPC.ControlIWant.fromObject(e.iwant[n])}}if(e.graft){if(!Array.isArray(e.graft))throw TypeError(".RPC.ControlMessage.graft: array expected");for(t.graft=[],n=0;n<e.graft.length;++n){if("object"!=typeof e.graft[n])throw TypeError(".RPC.ControlMessage.graft: object expected");t.graft[n]=r.RPC.ControlGraft.fromObject(e.graft[n])}}if(e.prune){if(!Array.isArray(e.prune))throw TypeError(".RPC.ControlMessage.prune: array expected");for(t.prune=[],n=0;n<e.prune.length;++n){if("object"!=typeof e.prune[n])throw TypeError(".RPC.ControlMessage.prune: object expected");t.prune[n]=r.RPC.ControlPrune.fromObject(e.prune[n])}}return t},o.toObject=function(e,t){t||(t={});var n={};if((t.arrays||t.defaults)&&(n.ihave=[],n.iwant=[],n.graft=[],n.prune=[]),e.ihave&&e.ihave.length){n.ihave=[];for(var s=0;s<e.ihave.length;++s)n.ihave[s]=r.RPC.ControlIHave.toObject(e.ihave[s],t)}if(e.iwant&&e.iwant.length)for(n.iwant=[],s=0;s<e.iwant.length;++s)n.iwant[s]=r.RPC.ControlIWant.toObject(e.iwant[s],t);if(e.graft&&e.graft.length)for(n.graft=[],s=0;s<e.graft.length;++s)n.graft[s]=r.RPC.ControlGraft.toObject(e.graft[s],t);if(e.prune&&e.prune.length)for(n.prune=[],s=0;s<e.prune.length;++s)n.prune[s]=r.RPC.ControlPrune.toObject(e.prune[s],t);return n},o.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},o}(),o.ControlIHave=function(){function o(e){if(this.messageIDs=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}var i;return o.prototype.topicID=null,o.prototype.messageIDs=s.emptyArray,Object.defineProperty(o.prototype,"_topicID",{get:s.oneOfGetter(i=["topicID"]),set:s.oneOfSetter(i)}),o.encode=function(e,t){if(t||(t=n.create()),null!=e.topicID&&Object.hasOwnProperty.call(e,"topicID")&&t.uint32(10).string(e.topicID),null!=e.messageIDs&&e.messageIDs.length)for(var s=0;s<e.messageIDs.length;++s)t.uint32(18).bytes(e.messageIDs[s]);return t},o.decode=function(e,n){e instanceof t||(e=t.create(e));for(var s=void 0===n?e.len:e.pos+n,o=new r.RPC.ControlIHave;e.pos<s;){var i=e.uint32();switch(i>>>3){case 1:o.topicID=e.string();break;case 2:o.messageIDs&&o.messageIDs.length||(o.messageIDs=[]),o.messageIDs.push(e.bytes());break;default:e.skipType(7&i)}}return o},o.fromObject=function(e){if(e instanceof r.RPC.ControlIHave)return e;var t=new r.RPC.ControlIHave;if(null!=e.topicID&&(t.topicID=String(e.topicID)),e.messageIDs){if(!Array.isArray(e.messageIDs))throw TypeError(".RPC.ControlIHave.messageIDs: array expected");t.messageIDs=[];for(var n=0;n<e.messageIDs.length;++n)"string"==typeof e.messageIDs[n]?s.base64.decode(e.messageIDs[n],t.messageIDs[n]=s.newBuffer(s.base64.length(e.messageIDs[n])),0):e.messageIDs[n].length&&(t.messageIDs[n]=e.messageIDs[n])}return t},o.toObject=function(e,t){t||(t={});var n={};if((t.arrays||t.defaults)&&(n.messageIDs=[]),null!=e.topicID&&e.hasOwnProperty("topicID")&&(n.topicID=e.topicID,t.oneofs&&(n._topicID="topicID")),e.messageIDs&&e.messageIDs.length){n.messageIDs=[];for(var r=0;r<e.messageIDs.length;++r)n.messageIDs[r]=t.bytes===String?s.base64.encode(e.messageIDs[r],0,e.messageIDs[r].length):t.bytes===Array?Array.prototype.slice.call(e.messageIDs[r]):e.messageIDs[r]}return n},o.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},o}(),o.ControlIWant=function(){function o(e){if(this.messageIDs=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return o.prototype.messageIDs=s.emptyArray,o.encode=function(e,t){if(t||(t=n.create()),null!=e.messageIDs&&e.messageIDs.length)for(var s=0;s<e.messageIDs.length;++s)t.uint32(10).bytes(e.messageIDs[s]);return t},o.decode=function(e,n){e instanceof t||(e=t.create(e));for(var s=void 0===n?e.len:e.pos+n,o=new r.RPC.ControlIWant;e.pos<s;){var i=e.uint32();i>>>3==1?(o.messageIDs&&o.messageIDs.length||(o.messageIDs=[]),o.messageIDs.push(e.bytes())):e.skipType(7&i)}return o},o.fromObject=function(e){if(e instanceof r.RPC.ControlIWant)return e;var t=new r.RPC.ControlIWant;if(e.messageIDs){if(!Array.isArray(e.messageIDs))throw TypeError(".RPC.ControlIWant.messageIDs: array expected");t.messageIDs=[];for(var n=0;n<e.messageIDs.length;++n)"string"==typeof e.messageIDs[n]?s.base64.decode(e.messageIDs[n],t.messageIDs[n]=s.newBuffer(s.base64.length(e.messageIDs[n])),0):e.messageIDs[n].length&&(t.messageIDs[n]=e.messageIDs[n])}return t},o.toObject=function(e,t){t||(t={});var n={};if((t.arrays||t.defaults)&&(n.messageIDs=[]),e.messageIDs&&e.messageIDs.length){n.messageIDs=[];for(var r=0;r<e.messageIDs.length;++r)n.messageIDs[r]=t.bytes===String?s.base64.encode(e.messageIDs[r],0,e.messageIDs[r].length):t.bytes===Array?Array.prototype.slice.call(e.messageIDs[r]):e.messageIDs[r]}return n},o.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},o}(),o.ControlGraft=function(){function o(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}var i;return o.prototype.topicID=null,Object.defineProperty(o.prototype,"_topicID",{get:s.oneOfGetter(i=["topicID"]),set:s.oneOfSetter(i)}),o.encode=function(e,t){return t||(t=n.create()),null!=e.topicID&&Object.hasOwnProperty.call(e,"topicID")&&t.uint32(10).string(e.topicID),t},o.decode=function(e,n){e instanceof t||(e=t.create(e));for(var s=void 0===n?e.len:e.pos+n,o=new r.RPC.ControlGraft;e.pos<s;){var i=e.uint32();i>>>3==1?o.topicID=e.string():e.skipType(7&i)}return o},o.fromObject=function(e){if(e instanceof r.RPC.ControlGraft)return e;var t=new r.RPC.ControlGraft;return null!=e.topicID&&(t.topicID=String(e.topicID)),t},o.toObject=function(e,t){t||(t={});var n={};return null!=e.topicID&&e.hasOwnProperty("topicID")&&(n.topicID=e.topicID,t.oneofs&&(n._topicID="topicID")),n},o.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},o}(),o.ControlPrune=function(){function o(e){if(this.peers=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}var i;return o.prototype.topicID=null,o.prototype.peers=s.emptyArray,o.prototype.backoff=null,Object.defineProperty(o.prototype,"_topicID",{get:s.oneOfGetter(i=["topicID"]),set:s.oneOfSetter(i)}),Object.defineProperty(o.prototype,"_backoff",{get:s.oneOfGetter(i=["backoff"]),set:s.oneOfSetter(i)}),o.encode=function(e,t){if(t||(t=n.create()),null!=e.topicID&&Object.hasOwnProperty.call(e,"topicID")&&t.uint32(10).string(e.topicID),null!=e.peers&&e.peers.length)for(var s=0;s<e.peers.length;++s)r.RPC.PeerInfo.encode(e.peers[s],t.uint32(18).fork()).ldelim();return null!=e.backoff&&Object.hasOwnProperty.call(e,"backoff")&&t.uint32(24).uint64(e.backoff),t},o.decode=function(e,n){e instanceof t||(e=t.create(e));for(var s=void 0===n?e.len:e.pos+n,o=new r.RPC.ControlPrune;e.pos<s;){var i=e.uint32();switch(i>>>3){case 1:o.topicID=e.string();break;case 2:o.peers&&o.peers.length||(o.peers=[]),o.peers.push(r.RPC.PeerInfo.decode(e,e.uint32()));break;case 3:o.backoff=e.uint64();break;default:e.skipType(7&i)}}return o},o.fromObject=function(e){if(e instanceof r.RPC.ControlPrune)return e;var t=new r.RPC.ControlPrune;if(null!=e.topicID&&(t.topicID=String(e.topicID)),e.peers){if(!Array.isArray(e.peers))throw TypeError(".RPC.ControlPrune.peers: array expected");t.peers=[];for(var n=0;n<e.peers.length;++n){if("object"!=typeof e.peers[n])throw TypeError(".RPC.ControlPrune.peers: object expected");t.peers[n]=r.RPC.PeerInfo.fromObject(e.peers[n])}}return null!=e.backoff&&(s.Long?(t.backoff=s.Long.fromValue(e.backoff)).unsigned=!0:"string"==typeof e.backoff?t.backoff=parseInt(e.backoff,10):"number"==typeof e.backoff?t.backoff=e.backoff:"object"==typeof e.backoff&&(t.backoff=new s.LongBits(e.backoff.low>>>0,e.backoff.high>>>0).toNumber(!0))),t},o.toObject=function(e,t){t||(t={});var n={};if((t.arrays||t.defaults)&&(n.peers=[]),null!=e.topicID&&e.hasOwnProperty("topicID")&&(n.topicID=e.topicID,t.oneofs&&(n._topicID="topicID")),e.peers&&e.peers.length){n.peers=[];for(var o=0;o<e.peers.length;++o)n.peers[o]=r.RPC.PeerInfo.toObject(e.peers[o],t)}return null!=e.backoff&&e.hasOwnProperty("backoff")&&("number"==typeof e.backoff?n.backoff=t.longs===String?String(e.backoff):e.backoff:n.backoff=t.longs===String?s.Long.prototype.toString.call(e.backoff):t.longs===Number?new s.LongBits(e.backoff.low>>>0,e.backoff.high>>>0).toNumber(!0):e.backoff,t.oneofs&&(n._backoff="backoff")),n},o.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},o}(),o.PeerInfo=function(){function o(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}var i;return o.prototype.peerID=null,o.prototype.signedPeerRecord=null,Object.defineProperty(o.prototype,"_peerID",{get:s.oneOfGetter(i=["peerID"]),set:s.oneOfSetter(i)}),Object.defineProperty(o.prototype,"_signedPeerRecord",{get:s.oneOfGetter(i=["signedPeerRecord"]),set:s.oneOfSetter(i)}),o.encode=function(e,t){return t||(t=n.create()),null!=e.peerID&&Object.hasOwnProperty.call(e,"peerID")&&t.uint32(10).bytes(e.peerID),null!=e.signedPeerRecord&&Object.hasOwnProperty.call(e,"signedPeerRecord")&&t.uint32(18).bytes(e.signedPeerRecord),t},o.decode=function(e,n){e instanceof t||(e=t.create(e));for(var s=void 0===n?e.len:e.pos+n,o=new r.RPC.PeerInfo;e.pos<s;){var i=e.uint32();switch(i>>>3){case 1:o.peerID=e.bytes();break;case 2:o.signedPeerRecord=e.bytes();break;default:e.skipType(7&i)}}return o},o.fromObject=function(e){if(e instanceof r.RPC.PeerInfo)return e;var t=new r.RPC.PeerInfo;return null!=e.peerID&&("string"==typeof e.peerID?s.base64.decode(e.peerID,t.peerID=s.newBuffer(s.base64.length(e.peerID)),0):e.peerID.length&&(t.peerID=e.peerID)),null!=e.signedPeerRecord&&("string"==typeof e.signedPeerRecord?s.base64.decode(e.signedPeerRecord,t.signedPeerRecord=s.newBuffer(s.base64.length(e.signedPeerRecord)),0):e.signedPeerRecord.length&&(t.signedPeerRecord=e.signedPeerRecord)),t},o.toObject=function(e,t){t||(t={});var n={};return null!=e.peerID&&e.hasOwnProperty("peerID")&&(n.peerID=t.bytes===String?s.base64.encode(e.peerID,0,e.peerID.length):t.bytes===Array?Array.prototype.slice.call(e.peerID):e.peerID,t.oneofs&&(n._peerID="peerID")),null!=e.signedPeerRecord&&e.hasOwnProperty("signedPeerRecord")&&(n.signedPeerRecord=t.bytes===String?s.base64.encode(e.signedPeerRecord,0,e.signedPeerRecord.length):t.bytes===Array?Array.prototype.slice.call(e.signedPeerRecord):e.signedPeerRecord,t.oneofs&&(n._signedPeerRecord="signedPeerRecord")),n},o.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},o}(),o}(),r})?s.apply(t,r):s)||(e.exports=o)},74868:function(e,t,n){"use strict";n.r(t),n.d(t,{code:function(){return l},decode:function(){return u},encode:function(){return d},name:function(){return c}});var s=n(16668),r=n(75946);const o=42;const i={float64:!0,typeEncoders:{Object:function(e){if(e.asCID!==e&&e["/"]!==e.bytes)return null;const t=r.TO.asCID(e);if(!t)return null;const n=new Uint8Array(t.bytes.byteLength+1);return n.set(t.bytes,1),[new s.ou(s.ZU.tag,o),new s.ou(s.ZU.bytes,n)]},undefined:function(){throw new Error("`undefined` is not supported by the IPLD Data Model and cannot be encoded")},number:function(e){if(Number.isNaN(e))throw new Error("`NaN` is not supported by the IPLD Data Model and cannot be encoded");if(e===1/0||e===-1/0)throw new Error("`Infinity` and `-Infinity` is not supported by the IPLD Data Model and cannot be encoded");return null}}};const a={allowIndefinite:!1,coerceUndefinedToNull:!0,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};a.tags[o]=function(e){if(0!==e[0])throw new Error("Invalid CID for CBOR tag 42; expected leading 0x00");return r.TO.decode(e.subarray(1))};const c="dag-cbor",l=113,d=e=>s.lF(e,i),u=e=>s.D4(e,a)},75294:function(e,t,n){"use strict";n.r(t),n.d(t,{code:function(){return h},decode:function(){return f},encode:function(){return p},format:function(){return y},name:function(){return u},parse:function(){return m},stringify:function(){return y}});var s=n(36414),r=n(34664),o=n(16668),i=n(70263);function a(e){const t=r.base64.encode(e).slice(1);return[new o.ou(o.ZU.map,1/0,1),new o.ou(o.ZU.string,"/",1),new o.ou(o.ZU.map,1/0,1),new o.ou(o.ZU.string,"bytes",5),new o.ou(o.ZU.string,t,t.length),new o.ou(o.ZU.break,void 0,1),new o.ou(o.ZU.break,void 0,1)]}const c={typeEncoders:{Object:function(e){if(e.asCID!==e&&e["/"]!==e.bytes)return null;const t=s.TO.asCID(e);if(!t)return null;const n=t.toString();return[new o.ou(o.ZU.map,1/0,1),new o.ou(o.ZU.string,"/",1),new o.ou(o.ZU.string,n,n.length),new o.ou(o.ZU.break,void 0,1)]},Uint8Array:a,Buffer:a,undefined:function(){throw new Error("`undefined` is not supported by the IPLD Data Model and cannot be encoded")},number:function(e){if(Number.isNaN(e))throw new Error("`NaN` is not supported by the IPLD Data Model and cannot be encoded");if(e===1/0||e===-1/0)throw new Error("`Infinity` and `-Infinity` is not supported by the IPLD Data Model and cannot be encoded");return null}}};class l extends i._F{constructor(e,t){super(e,t),this.tokenBuffer=[]}done(){return 0===this.tokenBuffer.length&&super.done()}_next(){return this.tokenBuffer.length>0?this.tokenBuffer.pop():super.next()}next(){const e=this._next();if(e.type===o.ZU.map){const e=this._next();if(e.type===o.ZU.string&&"/"===e.value){const e=this._next();if(e.type===o.ZU.string){if(this._next().type!==o.ZU.break)throw new Error("Invalid encoded CID form");return this.tokenBuffer.push(e),new o.ou(o.ZU.tag,42,0)}if(e.type===o.ZU.map){const e=this._next();if(e.type===o.ZU.string&&"bytes"===e.value){const e=this._next();if(e.type===o.ZU.string){for(let e=0;e<2;e++){if(this._next().type!==o.ZU.break)throw new Error("Invalid encoded Bytes form")}const t=r.base64.decode(`m${e.value}`);return new o.ou(o.ZU.bytes,t,e.value.length)}this.tokenBuffer.push(e)}this.tokenBuffer.push(e)}this.tokenBuffer.push(e)}this.tokenBuffer.push(e)}return e}}const d={allowIndefinite:!1,allowUndefined:!1,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};d.tags[42]=s.TO.parse;const u="dag-json",h=297,p=e=>i.lF(e,c),f=e=>{const t=Object.assign(d,{tokenizer:new l(e,d)});return i.D4(e,t)},y=e=>g.decode(p(e)),g=new TextDecoder,m=e=>f(w.encode(e)),w=new TextEncoder},24400:function(e,t,n){"use strict";n.r(t),n.d(t,{code:function(){return A},createLink:function(){return I},createNode:function(){return T},decode:function(){return O},encode:function(){return D},name:function(){return P},prepare:function(){return k},validate:function(){return R}});var s=n(75946);const r=new TextDecoder;function o(e,t){let n=0;for(let s=0;;s+=7){if(s>=64)throw new Error("protobuf: varint overflow");if(t>=e.length)throw new Error("protobuf: unexpected end of data");const r=e[t++];if(n+=s<28?(127&r)<<s:(127&r)*2**s,r<128)break}return[n,t]}function i(e,t){let n;[n,t]=o(e,t);const s=t+n;if(n<0||s<0)throw new Error("protobuf: invalid length");if(s>e.length)throw new Error("protobuf: unexpected end of data");return[e.subarray(t,s),s]}function a(e,t){let n;return[n,t]=o(e,t),[7&n,n>>3,t]}function c(e){const t={},n=e.length;let s=0;for(;s<n;){let n,c;if([n,c,s]=a(e,s),1===c){if(t.Hash)throw new Error("protobuf: (PBLink) duplicate Hash section");if(2!==n)throw new Error(`protobuf: (PBLink) wrong wireType (${n}) for Hash`);if(void 0!==t.Name)throw new Error("protobuf: (PBLink) invalid order, found Name before Hash");if(void 0!==t.Tsize)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Hash");[t.Hash,s]=i(e,s)}else if(2===c){if(void 0!==t.Name)throw new Error("protobuf: (PBLink) duplicate Name section");if(2!==n)throw new Error(`protobuf: (PBLink) wrong wireType (${n}) for Name`);if(void 0!==t.Tsize)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Name");let o;[o,s]=i(e,s),t.Name=r.decode(o)}else{if(3!==c)throw new Error(`protobuf: (PBLink) invalid fieldNumber, expected 1, 2 or 3, got ${c}`);if(void 0!==t.Tsize)throw new Error("protobuf: (PBLink) duplicate Tsize section");if(0!==n)throw new Error(`protobuf: (PBLink) wrong wireType (${n}) for Tsize`);[t.Tsize,s]=o(e,s)}}if(s>n)throw new Error("protobuf: (PBLink) unexpected end of data");return t}const l=new TextEncoder,d=2**32,u=2**31;function h(e,t){let n=t.length;if("number"==typeof e.Tsize){if(e.Tsize<0)throw new Error("Tsize cannot be negative");if(!Number.isSafeInteger(e.Tsize))throw new Error("Tsize too large for encoding");n=y(t,n,e.Tsize)-1,t[n]=24}if("string"==typeof e.Name){const s=l.encode(e.Name);n-=s.length,t.set(s,n),n=y(t,n,s.length)-1,t[n]=18}return e.Hash&&(n-=e.Hash.length,t.set(e.Hash,n),n=y(t,n,e.Hash.length)-1,t[n]=10),t.length-n}function p(e){const t=function(e){let t=0;if(e.Data){const n=e.Data.length;t+=1+n+g(n)}if(e.Links)for(const n of e.Links){const e=f(n);t+=1+e+g(e)}return t}(e),n=new Uint8Array(t);let s=t;if(e.Data&&(s-=e.Data.length,n.set(e.Data,s),s=y(n,s,e.Data.length)-1,n[s]=10),e.Links)for(let t=e.Links.length-1;t>=0;t--){const r=h(e.Links[t],n.subarray(0,s));s-=r,s=y(n,s,r)-1,n[s]=18}return n}function f(e){let t=0;if(e.Hash){const n=e.Hash.length;t+=1+n+g(n)}if("string"==typeof e.Name){const n=l.encode(e.Name).length;t+=1+n+g(n)}return"number"==typeof e.Tsize&&(t+=1+g(e.Tsize)),t}function y(e,t,n){const s=t-=g(n);for(;n>=u;)e[t++]=127&n|128,n/=128;for(;n>=128;)e[t++]=127&n|128,n>>>=7;return e[t]=n,s}function g(e){return e%2==0&&e++,Math.floor((function(e){let t=0;e>=d&&(e=Math.floor(e/d),t=32);e>=65536&&(e>>>=16,t+=16);e>=256&&(e>>>=8,t+=8);return t+m[e]}(e)+6)/7)}const m=[0,1,2,2,3,3,3,3,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8],w=["Data","Links"],b=["Hash","Name","Tsize"],_=new TextEncoder;function E(e,t){if(e===t)return 0;const n=e.Name?_.encode(e.Name):[],s=t.Name?_.encode(t.Name):[];let r=n.length,o=s.length;for(let e=0,t=Math.min(r,o);e<t;++e)if(n[e]!==s[e]){r=n[e],o=s[e];break}return r<o?-1:o<r?1:0}function v(e,t){return!Object.keys(e).some((e=>!t.includes(e)))}function S(e){if("object"==typeof e.asCID){const t=s.TO.asCID(e);if(!t)throw new TypeError("Invalid DAG-PB form");return{Hash:t}}if("object"!=typeof e||Array.isArray(e))throw new TypeError("Invalid DAG-PB form");const t={};if(e.Hash){let n=s.TO.asCID(e.Hash);try{n||("string"==typeof e.Hash?n=s.TO.parse(e.Hash):e.Hash instanceof Uint8Array&&(n=s.TO.decode(e.Hash)))}catch(e){throw new TypeError(`Invalid DAG-PB form: ${e.message}`)}n&&(t.Hash=n)}if(!t.Hash)throw new TypeError("Invalid DAG-PB form");return"string"==typeof e.Name&&(t.Name=e.Name),"number"==typeof e.Tsize&&(t.Tsize=e.Tsize),t}function k(e){if((e instanceof Uint8Array||"string"==typeof e)&&(e={Data:e}),"object"!=typeof e||Array.isArray(e))throw new TypeError("Invalid DAG-PB form");const t={};if(void 0!==e.Data)if("string"==typeof e.Data)t.Data=_.encode(e.Data);else{if(!(e.Data instanceof Uint8Array))throw new TypeError("Invalid DAG-PB form");t.Data=e.Data}if(void 0!==e.Links){if(!Array.isArray(e.Links))throw new TypeError("Invalid DAG-PB form");t.Links=e.Links.map(S),t.Links.sort(E)}else t.Links=[];return t}function R(e){if(!e||"object"!=typeof e||Array.isArray(e)||e instanceof Uint8Array||e["/"]&&e["/"]===e.bytes)throw new TypeError("Invalid DAG-PB form");if(!v(e,w))throw new TypeError("Invalid DAG-PB form (extraneous properties)");if(void 0!==e.Data&&!(e.Data instanceof Uint8Array))throw new TypeError("Invalid DAG-PB form (Data must be bytes)");if(!Array.isArray(e.Links))throw new TypeError("Invalid DAG-PB form (Links must be a list)");for(let t=0;t<e.Links.length;t++){const n=e.Links[t];if(!n||"object"!=typeof n||Array.isArray(n)||n instanceof Uint8Array||n["/"]&&n["/"]===n.bytes)throw new TypeError("Invalid DAG-PB form (bad link)");if(!v(n,b))throw new TypeError("Invalid DAG-PB form (extraneous properties on link)");if(void 0===n.Hash)throw new TypeError("Invalid DAG-PB form (link must have a Hash)");if(null==n.Hash||!n.Hash["/"]||n.Hash["/"]!==n.Hash.bytes)throw new TypeError("Invalid DAG-PB form (link Hash must be a CID)");if(void 0!==n.Name&&"string"!=typeof n.Name)throw new TypeError("Invalid DAG-PB form (link Name must be a string)");if(void 0!==n.Tsize){if("number"!=typeof n.Tsize||n.Tsize%1!=0)throw new TypeError("Invalid DAG-PB form (link Tsize must be an integer)");if(n.Tsize<0)throw new TypeError("Invalid DAG-PB form (link Tsize cannot be negative)")}if(t>0&&-1===E(n,e.Links[t-1]))throw new TypeError("Invalid DAG-PB form (links must be sorted by Name bytes)")}}function T(e,t=[]){return k({Data:e,Links:t})}function I(e,t,n){return S({Hash:n,Name:e,Tsize:t})}const P="dag-pb",A=112;function D(e){R(e);const t={};return e.Links&&(t.Links=e.Links.map((e=>{const t={};return e.Hash&&(t.Hash=e.Hash.bytes),void 0!==e.Name&&(t.Name=e.Name),void 0!==e.Tsize&&(t.Tsize=e.Tsize),t}))),e.Data&&(t.Data=e.Data),p(t)}function O(e){const t=function(e){const t=e.length;let n,s,r=0,o=!1;for(;r<t;){let t,l;if([t,l,r]=a(e,r),2!==t)throw new Error(`protobuf: (PBNode) invalid wireType, expected 2, got ${t}`);if(1===l){if(s)throw new Error("protobuf: (PBNode) duplicate Data section");[s,r]=i(e,r),n&&(o=!0)}else{if(2!==l)throw new Error(`protobuf: (PBNode) invalid fieldNumber, expected 1 or 2, got ${l}`);{if(o)throw new Error("protobuf: (PBNode) duplicate Links section");let t;n||(n=[]),[t,r]=i(e,r),n.push(c(t))}}}if(r>t)throw new Error("protobuf: (PBNode) unexpected end of data");const l={};return s&&(l.Data=s),l.Links=n||[],l}(e),n={};return t.Data&&(n.Data=t.Data),t.Links&&(n.Links=t.Links.map((e=>{const t={};try{t.Hash=s.TO.decode(e.Hash)}catch(e){}if(!t.Hash)throw new Error("Invalid Hash field found in link, expected CID");return void 0!==e.Name&&(t.Name=e.Name),void 0!==e.Tsize&&(t.Tsize=e.Tsize),t}))),n}},23975:function(e,t){"use strict";const n="[a-fA-F\\d:]",s=e=>e&&e.includeBoundaries?`(?:(?<=\\s|^)(?=${n})|(?<=${n})(?=\\s|$))`:"",r="(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}",o="[a-fA-F\\d]{1,4}",i=`\n(?:\n(?:${o}:){7}(?:${o}|:)|                                    // 1:2:3:4:5:6:7::  1:2:3:4:5:6:7:8\n(?:${o}:){6}(?:${r}|:${o}|:)|                             // 1:2:3:4:5:6::    1:2:3:4:5:6::8   1:2:3:4:5:6::8  1:2:3:4:5:6::1.2.3.4\n(?:${o}:){5}(?::${r}|(?::${o}){1,2}|:)|                   // 1:2:3:4:5::      1:2:3:4:5::7:8   1:2:3:4:5::8    1:2:3:4:5::7:1.2.3.4\n(?:${o}:){4}(?:(?::${o}){0,1}:${r}|(?::${o}){1,3}|:)| // 1:2:3:4::        1:2:3:4::6:7:8   1:2:3:4::8      1:2:3:4::6:7:1.2.3.4\n(?:${o}:){3}(?:(?::${o}){0,2}:${r}|(?::${o}){1,4}|:)| // 1:2:3::          1:2:3::5:6:7:8   1:2:3::8        1:2:3::5:6:7:1.2.3.4\n(?:${o}:){2}(?:(?::${o}){0,3}:${r}|(?::${o}){1,5}|:)| // 1:2::            1:2::4:5:6:7:8   1:2::8          1:2::4:5:6:7:1.2.3.4\n(?:${o}:){1}(?:(?::${o}){0,4}:${r}|(?::${o}){1,6}|:)| // 1::              1::3:4:5:6:7:8   1::8            1::3:4:5:6:7:1.2.3.4\n(?::(?:(?::${o}){0,5}:${r}|(?::${o}){1,7}|:))             // ::2:3:4:5:6:7:8  ::2:3:4:5:6:7:8  ::8             ::1.2.3.4\n)(?:%[0-9a-zA-Z]{1,})?                                             // %eth0            %1\n`.replace(/\s*\/\/.*$/gm,"").replace(/\n/g,"").trim(),a=new RegExp(`(?:^${r}$)|(?:^${i}$)`),c=new RegExp(`^${r}$`),l=new RegExp(`^${i}$`),d=e=>e&&e.exact?a:new RegExp(`(?:${s(e)}${r}${s(e)})|(?:${s(e)}${i}${s(e)})`,"g");d.v4=e=>e&&e.exact?c:new RegExp(`${s(e)}${r}${s(e)}`,"g"),d.v6=e=>e&&e.exact?l:new RegExp(`${s(e)}${i}${s(e)}`,"g"),t.A=d},98308:function(e,t,n){"use strict";n.d(t,{T:function(){return et}});var s=n(97101);var r=function(e,t){if(null!=e[Symbol.asyncIterator])return async function*(){for await(const n of e)await t(n),yield n}();const n=(0,s.A)(e),{value:r,done:o}=n.next();if(!0===o)return function*(){}();const i=t(r);if("function"==typeof i?.then)return async function*(){yield r;for await(const e of n)await t(e),yield e}();const a=t;return function*(){yield r;for(const e of n)a(e),yield e}()};var o=function(e,t){if(e.length>=255)throw new TypeError("Alphabet too long");for(var n=new Uint8Array(256),s=0;s<n.length;s++)n[s]=255;for(var r=0;r<e.length;r++){var o=e.charAt(r),i=o.charCodeAt(0);if(255!==n[i])throw new TypeError(o+" is ambiguous");n[i]=r}var a=e.length,c=e.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function u(e){if("string"!=typeof e)throw new TypeError("Expected String");if(0===e.length)return new Uint8Array;var t=0;if(" "!==e[t]){for(var s=0,r=0;e[t]===c;)s++,t++;for(var o=(e.length-t)*l+1>>>0,i=new Uint8Array(o);e[t];){var d=n[e.charCodeAt(t)];if(255===d)return;for(var u=0,h=o-1;(0!==d||u<r)&&-1!==h;h--,u++)d+=a*i[h]>>>0,i[h]=d%256>>>0,d=d/256>>>0;if(0!==d)throw new Error("Non-zero carry");r=u,t++}if(" "!==e[t]){for(var p=o-r;p!==o&&0===i[p];)p++;for(var f=new Uint8Array(s+(o-p)),y=s;p!==o;)f[y++]=i[p++];return f}}}return{encode:function(t){if(t instanceof Uint8Array||(ArrayBuffer.isView(t)?t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):Array.isArray(t)&&(t=Uint8Array.from(t))),!(t instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(0===t.length)return"";for(var n=0,s=0,r=0,o=t.length;r!==o&&0===t[r];)r++,n++;for(var i=(o-r)*d+1>>>0,l=new Uint8Array(i);r!==o;){for(var u=t[r],h=0,p=i-1;(0!==u||h<s)&&-1!==p;p--,h++)u+=256*l[p]>>>0,l[p]=u%a>>>0,u=u/a>>>0;if(0!==u)throw new Error("Non-zero carry");s=h,r++}for(var f=i-s;f!==i&&0===l[f];)f++;for(var y=c.repeat(n);f<i;++f)y+=e.charAt(l[f]);return y},decodeUnsafe:u,decode:function(e){var n=u(e);if(n)return n;throw new Error(`Non-${t} character`)}}};new Uint8Array(0);const i=e=>{if(e instanceof Uint8Array&&"Uint8Array"===e.constructor.name)return e;if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);throw new Error("Unknown type, must be binary type")};class a{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}}class c{constructor(e,t,n){if(this.name=e,this.prefix=t,void 0===t.codePointAt(0))throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if("string"==typeof e){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}throw Error("Can only multibase decode strings")}or(e){return d(this,e)}}class l{constructor(e){this.decoders=e}or(e){return d(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}const d=(e,t)=>new l({...e.decoders||{[e.prefix]:e},...t.decoders||{[t.prefix]:t}});class u{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new a(e,t,n),this.decoder=new c(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}const h=({name:e,prefix:t,encode:n,decode:s})=>new u(e,t,n,s),p=({prefix:e,name:t,alphabet:n})=>{const{encode:s,decode:r}=o(n,t);return h({prefix:e,name:t,encode:s,decode:e=>i(r(e))})},f=({name:e,prefix:t,bitsPerChar:n,alphabet:s})=>h({prefix:t,name:e,encode:e=>((e,t,n)=>{const s="="===t[t.length-1],r=(1<<n)-1;let o="",i=0,a=0;for(let s=0;s<e.length;++s)for(a=a<<8|e[s],i+=8;i>n;)i-=n,o+=t[r&a>>i];if(i&&(o+=t[r&a<<n-i]),s)for(;o.length*n&7;)o+="=";return o})(e,s,n),decode:t=>((e,t,n,s)=>{const r={};for(let e=0;e<t.length;++e)r[t[e]]=e;let o=e.length;for(;"="===e[o-1];)--o;const i=new Uint8Array(o*n/8|0);let a=0,c=0,l=0;for(let t=0;t<o;++t){const o=r[e[t]];if(void 0===o)throw new SyntaxError(`Non-${s} character`);c=c<<n|o,a+=n,a>=8&&(a-=8,i[l++]=255&c>>a)}if(a>=n||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return i})(t,s,n,e)}),y=f({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),g=(f({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),f({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),f({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),f({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),f({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),f({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),f({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),f({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),p({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}));p({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var m=function e(t,n,s){n=n||[];var r=s=s||0;for(;t>=_;)n[s++]=255&t|w,t/=128;for(;t&b;)n[s++]=255&t|w,t>>>=7;return n[s]=0|t,e.bytes=s-r+1,n},w=128,b=-128,_=Math.pow(2,31);var E=function e(t,n){var s,r=0,o=0,i=n=n||0,a=t.length;do{if(i>=a)throw e.bytes=0,new RangeError("Could not decode varint");s=t[i++],r+=o<28?(s&S)<<o:(s&S)*Math.pow(2,o),o+=7}while(s>=v);return e.bytes=i-n,r},v=128,S=127;var k=Math.pow(2,7),R=Math.pow(2,14),T=Math.pow(2,21),I=Math.pow(2,28),P=Math.pow(2,35),A=Math.pow(2,42),D=Math.pow(2,49),O=Math.pow(2,56),N=Math.pow(2,63),L={encode:m,decode:E,encodingLength:function(e){return e<k?1:e<R?2:e<T?3:e<I?4:e<P?5:e<A?6:e<D?7:e<O?8:e<N?9:10}};const M=(e,t=0)=>[L.decode(e,t),L.decode.bytes],C=(e,t,n=0)=>(L.encode(e,t,n),t),x=e=>L.encodingLength(e),B=(e,t)=>{const n=t.byteLength,s=x(e),r=s+x(n),o=new Uint8Array(r+n);return C(e,o,0),C(n,o,s),o.set(t,r),new z(e,n,t,o)};class z{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}}const U=(e,t)=>{const{bytes:n,version:s}=e;return 0===s?V(n,j(e),t||g.encoder):K(n,j(e),t||y.encoder)},F=new WeakMap,j=e=>{const t=F.get(e);if(null==t){const t=new Map;return F.set(e,t),t}return t};class H{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==q)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==G)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return H.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=B(e,t);return H.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return H.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&((e,t)=>{if(e===t)return!0;{const n=t;return e.code===n.code&&e.size===n.size&&n.bytes instanceof Uint8Array&&((e,t)=>{if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(let n=0;n<e.byteLength;n++)if(e[n]!==t[n])return!1;return!0})(e.bytes,n.bytes)}})(e.multihash,n.multihash)}toString(e){return U(this,e)}toJSON(){return{"/":U(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(null==e)return null;const t=e;if(t instanceof H)return t;if(null!=t["/"]&&t["/"]===t.bytes||t.asCID===t){const{version:e,code:n,multihash:s,bytes:r}=t;return new H(e,n,s,r||W(e,n,s.bytes))}if(!0===t[Y]){const{version:e,multihash:n,code:s}=t,r=(e=>{const t=i(e),[n,s]=M(t),[r,o]=M(t.subarray(s)),a=t.subarray(s+o);if(a.byteLength!==r)throw new Error("Incorrect length");return new z(n,r,a,t)})(n);return H.create(e,s,r)}return null}static create(e,t,n){if("number"!=typeof t)throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:if(t!==q)throw new Error(`Version 0 CID must use dag-pb (code: ${q}) block encoding`);return new H(e,t,n,n.bytes);case 1:{const s=W(e,t,n.bytes);return new H(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return H.create(0,q,e)}static createV1(e,t){return H.create(1,e,t)}static decode(e){const[t,n]=H.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=H.inspectBytes(e),n=t.size-t.multihashSize,s=i(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const r=s.subarray(t.multihashSize-t.digestSize),o=new z(t.multihashCode,t.digestSize,r,s);return[0===t.version?H.createV0(o):H.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[n,s]=M(e.subarray(t));return t+=s,n};let s=n(),r=q;if(18===s?(s=0,t=0):r=n(),0!==s&&1!==s)throw new RangeError(`Invalid CID version ${s}`);const o=t,i=n(),a=n(),c=t+a;return{version:s,codec:r,multihashCode:i,digestSize:a,multihashSize:c-o,size:c}}static parse(e,t){const[n,s]=$(e,t),r=H.decode(s);if(0===r.version&&"Q"!==e[0])throw Error("Version 0 CID string must not include multibase prefix");return j(r).set(n,e),r}}const $=(e,t)=>{switch(e[0]){case"Q":{const n=t||g;return[g.prefix,n.decode(`${g.prefix}${e}`)]}case g.prefix:{const n=t||g;return[g.prefix,n.decode(e)]}case y.prefix:{const n=t||y;return[y.prefix,n.decode(e)]}default:if(null==t)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[e[0],t.decode(e)]}},V=(e,t,n)=>{const{prefix:s}=n;if(s!==g.prefix)throw Error(`Cannot string encode V0 in ${n.name} encoding`);const r=t.get(s);if(null==r){const r=n.encode(e).slice(1);return t.set(s,r),r}return r},K=(e,t,n)=>{const{prefix:s}=n,r=t.get(s);if(null==r){const r=n.encode(e);return t.set(s,r),r}return r},q=112,G=18,W=(e,t,n)=>{const s=x(e),r=s+x(t),o=new Uint8Array(r+n.byteLength);return C(e,o,0),C(t,o,s),o.set(n,r),o},Y=Symbol.for("@ipld/js-cid/CID");var X=n(90994),Q=n(70202);const J=({name:e,code:t,encode:n})=>new Z(e,t,n);class Z{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?B(this.code,t):t.then((e=>B(this.code,e)))}throw Error("Unknown type, must be binary type")}}const ee=e=>async t=>new Uint8Array(await crypto.subtle.digest(e,t)),te=J({name:"sha2-256",code:18,encode:ee("SHA-256")});J({name:"sha2-512",code:19,encode:ee("SHA-512")});var ne=n(46163),se=n(17833);const re=f({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6});f({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),f({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),f({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});se.formatters.b=e=>null==e?"undefined":g.baseEncode(e),se.formatters.t=e=>null==e?"undefined":y.baseEncode(e),se.formatters.m=e=>null==e?"undefined":re.baseEncode(e),se.formatters.p=e=>null==e?"undefined":e.toString(),se.formatters.c=e=>null==e?"undefined":e.toString(),se.formatters.k=e=>null==e?"undefined":e.toString(),se.formatters.a=e=>null==e?"undefined":e.toString();var oe=n(94145);class ie{_refCounter;cid;priority;wantType;constructor(e,t,n){this._refCounter=1,this.cid=e,this.priority=t??1,this.wantType=n}inc(){this._refCounter+=1}dec(){this._refCounter=Math.max(0,this._refCounter-1)}hasRefs(){return this._refCounter>0}get[Symbol.toStringTag](){return`WantlistEntry <key: ${this.cid.toString(g)}, priority: ${this.priority}, refs: ${this._refCounter}>`}equals(e){return this._refCounter===e._refCounter&&this.cid.equals(e.cid)&&this.priority===e.priority&&this.wantType===e.wantType}}class ae{entry;cancel;sendDontHave;constructor(e,t,n,s,r){this.entry=new ie(e,t,n),this.cancel=Boolean(s),this.sendDontHave=Boolean(r)}get cid(){return this.entry.cid}set cid(e){this.entry.cid=e}get priority(){return this.entry.priority}set priority(e){this.entry.priority=e}get wantType(){return this.entry.wantType}set wantType(e){this.entry.wantType=e}get[Symbol.toStringTag](){return`BitswapMessageEntry ${this.cid.toString(g)} <cancel: ${this.cancel}, priority: ${this.priority}>`}equals(e){return this.cancel===e.cancel&&this.sendDontHave===e.sendDontHave&&this.wantType===e.wantType&&this.entry.equals(e.entry)}}const ce=(e,t)=>{const n=["bitswap"];return null!=t&&n.push(t),null!=e&&n.push(`${e.toString().slice(0,8)}`),function(e){let t=function(e){const t=()=>{};return t.enabled=!1,t.color="",t.diff=0,t.log=()=>{},t.namespace=e,t.destroy=()=>!0,t.extend=()=>t,t}(`${e}:trace`);return se.enabled(`${e}:trace`)&&null!=se.names.map((e=>e.toString())).find((e=>e.includes(":trace")))&&(t=se(`${e}:trace`)),Object.assign(se(e),{error:se(`${e}:error`),trace:t})}(n.join(":"))},le=(e,t)=>{if(e.size!==t.size)return!1;for(const[n,s]of e){const e=t.get(n);if(void 0===e)return!1;if(s instanceof Uint8Array&&e instanceof Uint8Array&&!(0,oe.a)(s,e))return!1;if(s instanceof ae&&e instanceof ae&&!s.equals(e))return!1}return!0};var de=n(40024);var ue,he=function(e){let t=new Uint8Array(e.reduce(((e,t)=>e+de.encodingLength(t)),0)),n=0;for(const s of e)t=de.encode(s,t,n),n+=de.encodingLength(s);return t},pe=n(59110);!function(e){let t,n,s,r,o,i;!function(t){let n,s,r,o;!function(e){e.Block="Block",e.Have="Have"}(n=t.WantType||(t.WantType={})),function(e){e[e.Block=0]="Block",e[e.Have=1]="Have"}(s||(s={})),function(e){e.codec=()=>(0,pe.eG)(s)}(n=t.WantType||(t.WantType={})),function(t){let r;t.codec=()=>(null==r&&(r=(0,pe.iU)(((t,n,r={})=>{!1!==r.lengthDelimited&&n.fork(),null!=t.block&&t.block.byteLength>0&&(n.uint32(10),n.bytes(t.block)),null!=t.priority&&0!==t.priority&&(n.uint32(16),n.int32(t.priority)),null!=t.cancel&&!1!==t.cancel&&(n.uint32(24),n.bool(t.cancel)),null!=t.wantType&&0!==s[t.wantType]&&(n.uint32(32),e.Wantlist.WantType.codec().encode(t.wantType,n)),null!=t.sendDontHave&&!1!==t.sendDontHave&&(n.uint32(40),n.bool(t.sendDontHave)),!1!==r.lengthDelimited&&n.ldelim()}),((t,s)=>{const r={block:new Uint8Array(0),priority:0,cancel:!1,wantType:n.Block,sendDontHave:!1},o=null==s?t.len:t.pos+s;for(;t.pos<o;){const n=t.uint32();switch(n>>>3){case 1:r.block=t.bytes();break;case 2:r.priority=t.int32();break;case 3:r.cancel=t.bool();break;case 4:r.wantType=e.Wantlist.WantType.codec().decode(t);break;case 5:r.sendDontHave=t.bool();break;default:t.skipType(7&n)}}return r}))),r),t.encode=e=>(0,pe.mH)(e,t.codec()),t.decode=e=>(0,pe.Y8)(e,t.codec())}(r=t.Entry||(t.Entry={})),t.codec=()=>(null==o&&(o=(0,pe.iU)(((t,n,s={})=>{if(!1!==s.lengthDelimited&&n.fork(),null!=t.entries)for(const s of t.entries)n.uint32(10),e.Wantlist.Entry.codec().encode(s,n);null!=t.full&&!1!==t.full&&(n.uint32(16),n.bool(t.full)),!1!==s.lengthDelimited&&n.ldelim()}),((t,n)=>{const s={entries:[],full:!1},r=null==n?t.len:t.pos+n;for(;t.pos<r;){const n=t.uint32();switch(n>>>3){case 1:s.entries.push(e.Wantlist.Entry.codec().decode(t,t.uint32()));break;case 2:s.full=t.bool();break;default:t.skipType(7&n)}}return s}))),o),t.encode=e=>(0,pe.mH)(e,t.codec()),t.decode=e=>(0,pe.Y8)(e,t.codec())}(t=e.Wantlist||(e.Wantlist={})),function(e){let t;e.codec=()=>(null==t&&(t=(0,pe.iU)(((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.prefix&&e.prefix.byteLength>0&&(t.uint32(10),t.bytes(e.prefix)),null!=e.data&&e.data.byteLength>0&&(t.uint32(18),t.bytes(e.data)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={prefix:new Uint8Array(0),data:new Uint8Array(0)},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();switch(t>>>3){case 1:n.prefix=e.bytes();break;case 2:n.data=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>(0,pe.mH)(t,e.codec()),e.decode=t=>(0,pe.Y8)(t,e.codec())}(n=e.Block||(e.Block={})),function(e){e.Have="Have",e.DontHave="DontHave"}(s=e.BlockPresenceType||(e.BlockPresenceType={})),function(e){e[e.Have=0]="Have",e[e.DontHave=1]="DontHave"}(r||(r={})),function(e){e.codec=()=>(0,pe.eG)(r)}(s=e.BlockPresenceType||(e.BlockPresenceType={})),function(t){let n;t.codec=()=>(null==n&&(n=(0,pe.iU)(((t,n,s={})=>{!1!==s.lengthDelimited&&n.fork(),null!=t.cid&&t.cid.byteLength>0&&(n.uint32(10),n.bytes(t.cid)),null!=t.type&&0!==r[t.type]&&(n.uint32(16),e.BlockPresenceType.codec().encode(t.type,n)),!1!==s.lengthDelimited&&n.ldelim()}),((t,n)=>{const r={cid:new Uint8Array(0),type:s.Have},o=null==n?t.len:t.pos+n;for(;t.pos<o;){const n=t.uint32();switch(n>>>3){case 1:r.cid=t.bytes();break;case 2:r.type=e.BlockPresenceType.codec().decode(t);break;default:t.skipType(7&n)}}return r}))),n),t.encode=e=>(0,pe.mH)(e,t.codec()),t.decode=e=>(0,pe.Y8)(e,t.codec())}(o=e.BlockPresence||(e.BlockPresence={})),e.codec=()=>(null==i&&(i=(0,pe.iU)(((t,n,s={})=>{if(!1!==s.lengthDelimited&&n.fork(),null!=t.wantlist&&(n.uint32(10),e.Wantlist.codec().encode(t.wantlist,n)),null!=t.blocks)for(const e of t.blocks)n.uint32(18),n.bytes(e);if(null!=t.payload)for(const s of t.payload)n.uint32(26),e.Block.codec().encode(s,n);if(null!=t.blockPresences)for(const s of t.blockPresences)n.uint32(34),e.BlockPresence.codec().encode(s,n);null!=t.pendingBytes&&0!==t.pendingBytes&&(n.uint32(40),n.int32(t.pendingBytes)),!1!==s.lengthDelimited&&n.ldelim()}),((t,n)=>{const s={blocks:[],payload:[],blockPresences:[],pendingBytes:0},r=null==n?t.len:t.pos+n;for(;t.pos<r;){const n=t.uint32();switch(n>>>3){case 1:s.wantlist=e.Wantlist.codec().decode(t,t.uint32());break;case 2:s.blocks.push(t.bytes());break;case 3:s.payload.push(e.Block.codec().decode(t,t.uint32()));break;case 4:s.blockPresences.push(e.BlockPresence.codec().decode(t,t.uint32()));break;case 5:s.pendingBytes=t.int32();break;default:t.skipType(7&n)}}return s}))),i),e.encode=t=>(0,pe.mH)(t,e.codec()),e.decode=t=>(0,pe.Y8)(t,e.codec())}(ue||(ue={}));class fe{static Entry=ae;static WantType={Block:ue.Wantlist.WantType.Block,Have:ue.Wantlist.WantType.Have};static BlockPresenceType={Have:ue.BlockPresenceType.Have,DontHave:ue.BlockPresenceType.DontHave};static deserialize=async(e,t)=>{const n=ue.decode(e),s=!0===n.wantlist?.full,r=new fe(s);return n.wantlist?.entries.forEach((e=>{if(null==e.block)return;const t=H.decode(e.block);r.addEntry(t,e.priority??0,e.wantType,Boolean(e.cancel),Boolean(e.sendDontHave))})),n.blockPresences.forEach((e=>{if(null==e.cid)return;const t=H.decode(e.cid);e.type===fe.BlockPresenceType.Have?r.addHave(t):r.addDontHave(t)})),n.blocks.length>0?(await Promise.all(n.blocks.map((async e=>{const t=await te.digest(e),n=H.createV0(t);r.addBlock(n,e)}))),r):n.payload.length>0?(await Promise.all(n.payload.map((async e=>{if(null==e.prefix||null==e.data)return;const n=ne(e.prefix),s=n[0],o=n[1],i=n[2],a=i===te.code?te:await(t?.getHasher(i));if(null==a)throw new Q.Ak("Unknown hash algorithm","ERR_UNKNOWN_HASH_ALG");const c=await a.digest(e.data),l=H.create(s,o,c);r.addBlock(l,e.data)}))),r.setPendingBytes(n.pendingBytes),r):r};static blockPresenceSize=e=>e.bytes.length+1;full;wantlist;blocks;blockPresences;pendingBytes;constructor(e){this.full=e,this.wantlist=new Map,this.blocks=new Map,this.blockPresences=new Map,this.pendingBytes=0}get empty(){return 0===this.blocks.size&&0===this.wantlist.size&&0===this.blockPresences.size}addEntry(e,t,n,s,r){null==n&&(n=fe.WantType.Block);const o=e.toString(g),i=this.wantlist.get(o);null!=i?(i.wantType===n&&(i.priority=t),!0===s&&(i.cancel=Boolean(s)),!0===r&&(i.sendDontHave=Boolean(r)),n===fe.WantType.Block&&i.wantType===fe.WantType.Have&&(i.wantType=n)):this.wantlist.set(o,new ae(e,t,n,s,r))}addBlock(e,t){const n=e.toString(g);this.blocks.set(n,t)}addHave(e){const t=e.toString(g);this.blockPresences.has(t)||this.blockPresences.set(t,fe.BlockPresenceType.Have)}addDontHave(e){const t=e.toString(g);this.blockPresences.has(t)||this.blockPresences.set(t,fe.BlockPresenceType.DontHave)}cancel(e){const t=e.toString(g);this.wantlist.delete(t),this.addEntry(e,0,fe.WantType.Block,!0,!1)}setPendingBytes(e){this.pendingBytes=e}serializeToBitswap100(){return ue.encode({wantlist:{entries:Array.from(this.wantlist.values()).map((e=>({block:e.cid.bytes,priority:Number(e.priority),cancel:Boolean(e.cancel),wantType:ue.Wantlist.WantType.Block,sendDontHave:!1}))),full:Boolean(this.full)},blocks:Array.from(this.blocks.values())})}serializeToBitswap110(){const e={wantlist:{entries:Array.from(this.wantlist.values()).map((e=>({block:e.cid.bytes,priority:Number(e.priority),wantType:e.wantType,cancel:Boolean(e.cancel),sendDontHave:Boolean(e.sendDontHave)}))),full:Boolean(this.full)},blockPresences:[],payload:[],pendingBytes:this.pendingBytes,blocks:[]};for(const[t,n]of this.blocks.entries()){const s=H.parse(t),r=s.version,o=s.code,i=s.multihash.code,a=s.multihash.digest.length,c=he([r,o,i,a]);e.payload.push({prefix:c,data:n})}for(const[t,n]of this.blockPresences)e.blockPresences.push({cid:H.parse(t).bytes,type:n});return this.pendingBytes>0&&(e.pendingBytes=this.pendingBytes),ue.encode(e)}equals(e){return!!(this.full===e.full&&this.pendingBytes===e.pendingBytes&&le(this.wantlist,e.wantlist)&&le(this.blocks,e.blocks)&&le(this.blockPresences,e.blockPresences))}get[Symbol.toStringTag](){const e=Array.from(this.wantlist.keys()),t=Array.from(this.blocks.keys());return`BitswapMessage <full: ${this.full}, list: ${e}, blocks: ${t}>`}}const ye=ue.Wantlist.WantType.Block,ge=ue.Wantlist.WantType.Have;class me{static Entry=ie;set;_stats;constructor(e,t){this.set=null!=t?(0,X.n)({name:"ipfs_bitswap_wantlist",metrics:t.metrics}):new Map,this._stats=e}get length(){return this.set.size}add(e,t,n){const s=e.toString(g),r=this.set.get(s);null!=r?(r.inc(),r.priority=t,r.wantType===ge&&n===ye&&(r.wantType=n)):(this.set.set(s,new ie(e,t,n)),null!=this._stats&&this._stats.push(void 0,"wantListSize",1))}remove(e){const t=e.toString(g),n=this.set.get(t);null!=n&&(n.dec(),n.hasRefs()||(this.set.delete(t),null!=this._stats&&this._stats.push(void 0,"wantListSize",-1)))}removeForce(e){this.set.has(e)&&this.set.delete(e)}forEach(e){this.set.forEach(e)}entries(){return this.set.entries()}sortedEntries(){return new Map((e=e=>e[1].key,t=Array.from(this.set.entries()),Array.prototype.slice.call(t,0).sort(((t,n)=>{const s=e(t),r=e(n);return s<r?-1:s>r?1:0}))));var e,t}contains(e){const t=e.toString(g);return this.set.has(t)}get(e){const t=e.toString(g);return this.set.get(t)}}class we{partner;wantlist;exchangeCount;accounting;lastExchange;constructor(e){this.partner=e,this.wantlist=new me,this.exchangeCount=0,this.accounting={bytesSent:0,bytesRecv:0}}sentBytes(e){this.exchangeCount++,this.lastExchange=(new Date).getTime(),this.accounting.bytesSent+=e}receivedBytes(e){this.exchangeCount++,this.lastExchange=(new Date).getTime(),this.accounting.bytesRecv+=e}wants(e,t,n){this.wantlist.add(e,t,n)}cancelWant(e){this.wantlist.remove(e)}wantlistContains(e){return this.wantlist.get(e)}debtRatio(){return this.accounting.bytesSent/(this.accounting.bytesRecv+1)}}class be extends Map{_cmp;_keys;constructor(e,t){super(),this._cmp=t??this._defaultSort,this._keys=[];for(const[t,n]of e??[])this.set(t,n)}update(e){if(e<0||e>=this._keys.length)return;const t=this._keys[e];this._keys.splice(e,1);const n=this._find(t);this._keys.splice(n,0,t)}set(e,t){if(this.has(e)){const t=this.indexOf(e);this._keys.splice(t,1)}super.set(e,t);const n=this._find(e);return this._keys.splice(n,0,e),this}clear(){super.clear(),this._keys=[]}delete(e){if(!this.has(e))return!1;const t=this.indexOf(e);return this._keys.splice(t,1),super.delete(e)}indexOf(e){if(!this.has(e))return-1;const t=this._find(e);if(this._keys[t]===e)return t;for(let n=1;n<this._keys.length;n++){if(this._keys[t+n]===e)return t+n;if(this._keys[t-n]===e)return t-n}return-1}_find(e){let t=0,n=this._keys.length;for(;t<n;){const s=t+n>>>1,r=this._kCmp(this._keys[s],e);if(r<0)t=s+1;else{if(!(r>0))return s;n=s}}return t}*keys(){for(const e of this._keys)yield e}*values(){for(const e of this._keys)yield this.get(e)}*entries(){for(const e of this._keys)yield[e,this.get(e)]}*[Symbol.iterator](){yield*this.entries()}forEach(e,t=this){if(null!=e)for(const n of this._keys){const s=this.get(n);if(null==s)throw new Error("Value cannot be undefined");e.apply(t,[[n,s]])}}_defaultSort(e,t){return e[0]<t[0]?-1:t[0]<e[0]?1:0}_kCmp(e,t){return this._cmp([e,this.get(e)],[t,this.get(t)])}}const _e={hasNewInfo:()=>!1,merge(){}};class Ee{_taskMerger;_byPeer;constructor(e=_e){this._taskMerger=e,this._byPeer=new be([],ve.compare)}pushTasks(e,t){let n=this._byPeer.get(e.toString());null==n&&(n=new ve(e,this._taskMerger)),n.pushTasks(t),this._byPeer.set(e.toString(),n)}popTasks(e){const t=this._head();if(void 0===t)return{tasks:[],pendingSize:0};const{tasks:n,pendingSize:s}=t.popTasks(e);if(0===n.length)return{tasks:n,pendingSize:s};const r=t.peerId;return t.isIdle()?this._byPeer.delete(r.toString()):this._byPeer.update(0),{peerId:r,tasks:n,pendingSize:s}}_head(){if(0!==this._byPeer.size)for(const[,e]of this._byPeer)return e}remove(e,t){const n=this._byPeer.get(t.toString());n?.remove(e)}tasksDone(e,t){const n=this._byPeer.get(e.toString());if(null==n)return;const s=this._byPeer.indexOf(e.toString());for(const e of t)n.taskDone(e);this._byPeer.update(s)}}class ve{peerId;_taskMerger;_activeTotalSize;_pending;_active;constructor(e,t){this.peerId=e,this._taskMerger=t,this._activeTotalSize=0,this._pending=new Se,this._active=new Set}pushTasks(e){for(const t of e)this._pushTask(t)}_pushTask(e){if(!this._taskHasMoreInfoThanActiveTasks(e))return;const t=this._pending.get(e.topic);if(null!=t)return e.priority>t.priority&&this._pending.updatePriority(e.topic,e.priority),void this._taskMerger.merge(e,t);this._pending.add(e)}_taskHasMoreInfoThanActiveTasks(e){const t=[];for(const n of this._active)n.topic===e.topic&&t.push(n);return 0===t.length||this._taskMerger.hasNewInfo(e,t)}popTasks(e){let t=0;const n=[],s=this._pending.tasks();for(let r=0;r<s.length&&t<e;r++){const e=s[r];n.push(e),t+=e.size,this._pending.delete(e.topic),this._activeTotalSize+=e.size,this._active.add(e)}return{tasks:n,pendingSize:this._pending.totalSize}}taskDone(e){this._active.has(e)&&(this._activeTotalSize-=e.size,this._active.delete(e))}remove(e){this._pending.delete(e)}isIdle(){return 0===this._pending.length&&0===this._active.size}static compare(e,t){return 0===e[1]._pending.length?1:0===t[1]._pending.length?-1:e[1]._activeTotalSize===t[1]._activeTotalSize?t[1]._pending.length-e[1]._pending.length:e[1]._activeTotalSize-t[1]._activeTotalSize}}class Se{_tasks;constructor(){this._tasks=new be([],this._compare)}get length(){return this._tasks.size}get totalSize(){return[...this._tasks.values()].reduce(((e,t)=>e+t.task.size),0)}get(e){return this._tasks?.get(e)?.task}add(e){this._tasks.set(e.topic,{created:Date.now(),task:e})}delete(e){this._tasks.delete(e)}tasks(){return[...this._tasks.values()].map((e=>e.task))}updatePriority(e,t){const n=this._tasks.get(e);if(null==n)return;const s=this._tasks.indexOf(e);n.task.priority=t,this._tasks.update(s)}_compare(e,t){return e[1].task.priority===t[1].task.priority?e[1].created-t[1].created:t[1].task.priority-e[1].task.priority}}const ke={hasNewInfo(e,t){let n=!1,s=!1;for(const e of t)e.data.haveBlock&&(n=!0),e.data.isWantBlock&&(s=!0);return!(s||!e.data.isWantBlock)||!(n||!e.data.haveBlock)},merge(e,t){const n=e.data,s=t.data;!s.haveBlock&&n.haveBlock&&(s.haveBlock=n.haveBlock,s.blockSize=n.blockSize),!s.isWantBlock&&n.isWantBlock&&(s.isWantBlock=!0,s.haveBlock&&!n.haveBlock||(s.haveBlock=n.haveBlock,t.size=e.size)),s.isWantBlock&&s.haveBlock&&(t.size=s.blockSize)}},Re=fe.WantType;class Te{_log;blockstore;network;_stats;_opts;ledgerMap;_running;_requestQueue;constructor(e,t,n,s,r,o={}){this._log=ce(e,"engine"),this.blockstore=t,this.network=n,this._stats=s,this._opts=this._processOpts(o),this.ledgerMap=(0,X.n)({name:"ipfs_bitswap_ledger_map",metrics:r.metrics}),this._running=!1,this._requestQueue=new Ee(ke)}_processOpts(e){return{maxSizeReplaceHasWithBlock:1024,targetMessageSize:16384,...e}}_scheduleProcessTasks(){setTimeout((()=>{this._processTasks().catch((e=>{this._log.error("error processing stats",e)}))}))}async _processTasks(){if(!this._running)return;const{peerId:e,tasks:t,pendingSize:n}=this._requestQueue.popTasks(this._opts.targetMessageSize);if(0===t.length)return;const s=new fe(!1);s.setPendingBytes(n);const r=[],o=new Map;for(const e of t){const t=H.parse(e.topic);e.data.haveBlock?e.data.isWantBlock?(r.push(t),o.set(e.topic,e.data)):s.addHave(t):s.addDontHave(t)}const i=await this._getBlocks(r);for(const[e,t]of o){const n=H.parse(e),r=i.get(e);null!=r?s.addBlock(n,r):t.sendDontHave&&s.addDontHave(n)}if(s.empty)return null!=e&&this._requestQueue.tasksDone(e,t),void this._scheduleProcessTasks();try{null!=e&&await this.network.sendMessage(e,s);for(const[t,n]of i.entries())null!=e&&this.messageSent(e,H.parse(t),n)}catch(e){this._log.error(e)}null!=e&&this._requestQueue.tasksDone(e,t),this._scheduleProcessTasks()}wantlistForPeer(e){const t=e.toString(),n=this.ledgerMap.get(t);return null!=n?n.wantlist.sortedEntries():new Map}ledgerForPeer(e){const t=e.toString(),n=this.ledgerMap.get(t);if(null!=n)return{peer:n.partner,value:n.debtRatio(),sent:n.accounting.bytesSent,recv:n.accounting.bytesRecv,exchanged:n.exchangeCount}}peers(){return Array.from(this.ledgerMap.values()).map((e=>e.partner))}receivedBlocks(e){if(0!==e.length){for(const t of this.ledgerMap.values())for(const{cid:n,block:s}of e){const e=t.wantlistContains(n);if(null==e)continue;const r=s.length,o=this._sendAsBlock(e.wantType,r);let i=r;o||(i=fe.blockPresenceSize(e.cid)),this._requestQueue.pushTasks(t.partner,[{topic:e.cid.toString(g),priority:e.priority,size:i,data:{blockSize:r,isWantBlock:o,haveBlock:!0,sendDontHave:!1}}])}this._scheduleProcessTasks()}}async messageReceived(e,t){const n=this._findOrCreate(e);if(t.empty)return;if(t.full&&(n.wantlist=new me),this._updateBlockAccounting(t.blocks,n),0===t.wantlist.size)return void this._scheduleProcessTasks();const s=[],r=[];t.wantlist.forEach((e=>{e.cancel?(n.cancelWant(e.cid),s.push(e.cid)):(n.wants(e.cid,e.priority,e.wantType),r.push(e))})),this._cancelWants(e,s),await this._addWants(e,r),this._scheduleProcessTasks()}_cancelWants(e,t){for(const n of t)this._requestQueue.remove(n.toString(g),e)}async _addWants(e,t){const n=await this._getBlockSizes(t.map((e=>e.cid))),s=[];for(const r of t){const t=r.cid.toString(g),o=n.get(t);if(null==o)r.sendDontHave&&s.push({topic:t,priority:r.priority,size:fe.blockPresenceSize(r.cid),data:{isWantBlock:r.wantType===Re.Block,blockSize:0,haveBlock:!1,sendDontHave:r.sendDontHave}});else{const e=this._sendAsBlock(r.wantType,o);let n=o;e||(n=fe.blockPresenceSize(r.cid)),s.push({topic:t,priority:r.priority,size:n,data:{isWantBlock:e,blockSize:o,haveBlock:!0,sendDontHave:r.sendDontHave}})}this._requestQueue.pushTasks(e,s)}}_sendAsBlock(e,t){return e===Re.Block||t<=this._opts.maxSizeReplaceHasWithBlock}async _getBlockSizes(e){const t=await this._getBlocks(e);return new Map([...t].map((([e,t])=>[e,t.length])))}async _getBlocks(e){const t=new Map;return await Promise.all(e.map((async e=>{try{const n=await this.blockstore.get(e);t.set(e.toString(g),n)}catch(t){"ERR_NOT_FOUND"!==t.code&&this._log.error("failed to query blockstore for %s: %s",e,t)}}))),t}_updateBlockAccounting(e,t){for(const n of e.values())this._log("got block (%s bytes)",n.length),t.receivedBytes(n.length)}messageSent(e,t,n){const s=this._findOrCreate(e);s.sentBytes(n.length),s.wantlist.remove(t)}numBytesSentTo(e){return this._findOrCreate(e).accounting.bytesSent}numBytesReceivedFrom(e){return this._findOrCreate(e).accounting.bytesRecv}peerDisconnected(e){this.ledgerMap.delete(e.toString())}_findOrCreate(e){const t=e.toString(),n=this.ledgerMap.get(t);if(null!=n)return n;const s=new we(e);return this.ledgerMap.set(t,s),null!=this._stats&&this._stats.push(t,"peerCount",1),s}start(){this._running=!0}stop(){this._running=!1}}var Ie=n(8306),Pe=n(89754);var Ae=function(e,t){if(null!=e[Symbol.asyncIterator])return async function*(){for await(const n of e)yield t(n)}();const n=(0,s.A)(e),{value:r,done:o}=n.next();if(!0===o)return function*(){}();const i=t(r);if("function"==typeof i.then)return async function*(){yield await i;for await(const e of n)yield t(e)}();const a=t;return function*(){yield i;for(const e of n)yield a(e)}()},De=n(81033);var Oe=function(e,t){return null!=e[Symbol.asyncIterator]?async function*(){let n=0;if(!(t<1))for await(const s of e)if(yield s,n++,n===t)return}():function*(){let n=0;if(!(t<1))for(const s of e)if(yield s,n++,n===t)return}()},Ne=n(55433),Le=n(42686);const Me=Math.pow(2,31)-1,Ce="/ipfs/bitswap/1.0.0",xe="/ipfs/bitswap/1.1.0",Be="/ipfs/bitswap/1.2.0";class ze{_log;_libp2p;_bitswap;_protocols;_stats;_running;_hashLoader;_maxInboundStreams;_maxOutboundStreams;_incomingStreamTimeout;_registrarIds;constructor(e,t,n,s={}){this._log=ce(e.peerId,"network"),this._libp2p=e,this._bitswap=t,this._protocols=[Ce],!0!==s.b100Only&&(this._protocols.unshift(xe),this._protocols.unshift(Be)),this._stats=n,this._running=!1,this._onPeerConnect=this._onPeerConnect.bind(this),this._onPeerDisconnect=this._onPeerDisconnect.bind(this),this._onConnection=this._onConnection.bind(this),this._hashLoader=s.hashLoader??{async getHasher(){throw new Error("Not implemented")}},this._maxInboundStreams=s.maxInboundStreams??1024,this._maxOutboundStreams=s.maxOutboundStreams??1024,this._incomingStreamTimeout=s.incomingStreamTimeout??3e4}async start(){this._running=!0,await this._libp2p.handle(this._protocols,this._onConnection,{maxInboundStreams:this._maxInboundStreams,maxOutboundStreams:this._maxOutboundStreams});const e={onConnect:this._onPeerConnect,onDisconnect:this._onPeerDisconnect};this._registrarIds=[];for(const t of this._protocols)this._registrarIds.push(await this._libp2p.register(t,e));this._libp2p.getConnections().forEach((e=>{this._onPeerConnect(e.remotePeer)}))}async stop(){if(this._running=!1,await this._libp2p.unhandle(this._protocols),null!=this._registrarIds){for(const e of this._registrarIds)this._libp2p.unregister(e);this._registrarIds=[]}}_onConnection(e){if(!this._running)return;const{stream:t,connection:n}=e,s=new Le.TimeoutController(this._incomingStreamTimeout);Promise.resolve().then((async()=>{this._log("incoming new bitswap %s connection from %p",t.protocol,n.remotePeer);const e=()=>{t.abort(new Q.Ak("Incoming Bitswap stream timed out","ERR_TIMEOUT"))};let s=AbortSignal.timeout(this._incomingStreamTimeout);s.addEventListener("abort",e),await(0,De.F)(t,(e=>Pe.D(e)),(async t=>{for await(const r of t){try{const e=await fe.deserialize(r.subarray(),this._hashLoader);await this._bitswap._receiveMessage(n.remotePeer,e)}catch(e){this._bitswap._receiveError(e);break}s.removeEventListener("abort",e),s=AbortSignal.timeout(this._incomingStreamTimeout),s.addEventListener("abort",e)}})),await t.close({signal:s})})).catch((e=>{this._log(e),t.abort(e)})).finally((()=>{s.clear()}))}_onPeerConnect(e){this._bitswap._onPeerConnected(e)}_onPeerDisconnect(e){this._bitswap._onPeerDisconnected(e)}findProviders(e,t={}){return t.onProgress?.(new Ne.j("bitswap:network:find-providers",e)),this._libp2p.contentRouting.findProviders(e,t)}async findAndConnect(e,t){await(0,Ie.A)(Oe(Ae(this.findProviders(e,t),(async e=>this.connectTo(e.id,t).catch((e=>{this._log.error(e)})))),3)).catch((e=>{this._log.error(e)}))}async provide(e,t={}){t.onProgress?.(new Ne.j("bitswap:network:provide",e)),await this._libp2p.contentRouting.provide(e,t)}async sendMessage(e,t,n={}){if(!this._running)throw new Error("network isn't running");const s=e.toString();this._log("sendMessage to %s",s,t),n.onProgress?.(new Ne.j("bitswap:network:send-wantlist",e)),await this._writeMessage(e,t,n),this._updateSentStats(e,t.blocks)}async connectTo(e,t={}){if(!this._running)throw new Error("network isn't running");return t.onProgress?.(new Ne.j("bitswap:network:dial",e)),this._libp2p.dial(e,t)}_updateSentStats(e,t){const n=e.toString();if(null!=this._stats){for(const e of t.values())this._stats.push(n,"dataSent",e.length);this._stats.push(n,"blocksSent",t.size)}}async _writeMessage(e,t,n={}){const s=await this._libp2p.dialProtocol(e,[Be,xe,Ce]);try{let e;switch(s.protocol){case Ce:e=t.serializeToBitswap100();break;case xe:case Be:e=t.serializeToBitswap110();break;default:throw new Error(`Unknown protocol: ${s.protocol}`)}await(0,De.F)([e],(e=>Pe.l(e)),s),await s.close()}catch(t){n.onProgress?.(new Ne.j("bitswap:network:send-wantlist:error",{peer:e,error:t})),this._log(t),s.abort(t)}}}var Ue=n(37007),Fe=n(98067);const je=e=>`unwant:${(0,Fe.d)(e.multihash.bytes,"base64")}`,He=e=>`block:${(0,Fe.d)(e.multihash.bytes,"base64")}`;class $e extends Ue.EventEmitter{_log;constructor(e){super(),this.setMaxListeners(1e3),this._log=ce(e,"notif")}hasBlock(e,t){const n=He(e);this._log(n),this.emit(n,t)}async wantBlock(e,t={}){if(null==e)throw new Error("Not a valid cid");const n=He(e),s=je(e);return this._log(`wantBlock:${e}`),new Promise(((r,o)=>{const i=()=>{this.removeListener(n,a),t.onProgress?.(new Ne.j("bitswap:want-block:unwant",e)),o(new Error(`Block for ${e} unwanted`))},a=n=>{this.removeListener(s,i),t.onProgress?.(new Ne.j("bitswap:want-block:block",e)),r(n)};this.once(s,i),this.once(n,a),t.signal?.addEventListener("abort",(()=>{this.removeListener(n,a),this.removeListener(s,i),o(new Error(`Want for ${e} aborted`))}))}))}unwantBlock(e){const t=je(e);this._log(t),this.emit(t)}}var Ve=n(84166);class Ke extends Ue.EventEmitter{_options;_queue;_stats;_frequencyLastTime;_frequencyAccumulators;_movingAverages;_enabled;_timeout;constructor(e,t){super(),this._options=t,this._queue=[],this._stats={},this._frequencyLastTime=Date.now(),this._frequencyAccumulators={},this._movingAverages={},this._update=this._update.bind(this),e.forEach((e=>{this._stats[e]=BigInt(0),this._movingAverages[e]={},this._options.movingAverageIntervals.forEach((t=>{(this._movingAverages[e][t]=Ve(t)).push(this._frequencyLastTime,0)}))})),this._enabled=this._options.enabled}enable(){this._enabled=!0}disable(){this._enabled=!1}stop(){null!=this._timeout&&clearTimeout(this._timeout)}get snapshot(){return Object.assign({},this._stats)}get movingAverages(){return Object.assign({},this._movingAverages)}push(e,t){this._enabled&&(this._queue.push([e,t,Date.now()]),this._resetComputeTimeout())}_resetComputeTimeout(){null!=this._timeout&&clearTimeout(this._timeout),this._timeout=setTimeout(this._update,this._nextTimeout())}_nextTimeout(){const e=this._queue.length/this._options.computeThrottleMaxQueueSize;return Math.max(this._options.computeThrottleTimeout*(1-e),0)}_update(){if(this._timeout=void 0,this._queue.length>0){let e;for(;this._queue.length>0;){const t=e=this._queue.shift();null!=t&&this._applyOp(t)}null!=e&&this._updateFrequency(e[2]),this.emit("update",this._stats)}}_updateFrequency(e){const t=e-this._frequencyLastTime;t>0&&Object.keys(this._stats).forEach((n=>{this._updateFrequencyFor(n,t,e)})),this._frequencyLastTime=e}_updateFrequencyFor(e,t,n){const s=this._frequencyAccumulators[e]??0;this._frequencyAccumulators[e]=0;const r=s/t*1e3;let o=this._movingAverages[e];null==o&&(o=this._movingAverages[e]={}),this._options.movingAverageIntervals.forEach((e=>{let t=o[e];null==t&&(t=o[e]=Ve(e)),t.push(n,r)}))}_applyOp(e){const t=e[0],n=e[1];if("number"!=typeof n)throw new Error(`invalid increment number: ${n}`);Object.prototype.hasOwnProperty.call(this._stats,t)||(this._stats[t]=BigInt(0)),this._stats[t]=BigInt(this._stats[t])+BigInt(n),null==this._frequencyAccumulators[t]&&(this._frequencyAccumulators[t]=0),this._frequencyAccumulators[t]+=n}}const qe={enabled:!1,computeThrottleTimeout:1e3,computeThrottleMaxQueueSize:1e3,movingAverageIntervals:[6e4,3e5,9e5]};class Ge extends Ue.EventEmitter{_initialCounters;_options;_enabled;_global;_peers;constructor(e,t=[],n=qe){super();const s=Object.assign({},qe,n);if("number"!=typeof s.computeThrottleTimeout)throw new Error("need computeThrottleTimeout");if("number"!=typeof s.computeThrottleMaxQueueSize)throw new Error("need computeThrottleMaxQueueSize");this._initialCounters=t,this._options=s,this._enabled=this._options.enabled,this._global=new Ke(t,s),this._global.on("update",(e=>this.emit("update",e))),this._peers=(0,X.n)({name:"ipfs_bitswap_stats_peers",metrics:e.metrics})}enable(){this._enabled=!0,this._options.enabled=!0,this._global.enable()}disable(){this._enabled=!1,this._options.enabled=!1,this._global.disable()}stop(){this._enabled=!1,this._global.stop();for(const e of this._peers)e[1].stop()}get snapshot(){return this._global.snapshot}get movingAverages(){return this._global.movingAverages}forPeer(e){const t=e.toString();return this._peers.get(t)}push(e,t,n){if(this._enabled&&(this._global.push(t,n),null!=e)){let s=this._peers.get(e);null==s&&(s=new Ke(this._initialCounters,this._options),this._peers.set(e,s)),s.push(t,n)}}disconnected(e){const t=e.toString(),n=this._peers.get(t);null!=n&&(n.stop(),this._peers.delete(t))}}var We=n(29760);class Ye{peerId;refcnt;network;_entries;_log;constructor(e,t,n){this.peerId=t,this.network=n,this.refcnt=1,this._entries=[],this._log=ce(e,"msgqueue"),this.sendEntries=(0,We.A)(this.sendEntries.bind(this),1)}addMessage(e,t={}){e.empty||this.send(e,t)}addEntries(e,t={}){this._entries=this._entries.concat(e),this.sendEntries(t)}sendEntries(e={}){if(0===this._entries.length)return;const t=new fe(!1);this._entries.forEach((e=>{!0===e.cancel?t.cancel(e.cid):t.addEntry(e.cid,e.priority)})),this._entries=[],this.addMessage(t,e)}async send(e,t={}){try{await this.network.connectTo(this.peerId,t)}catch(e){return void this._log.error("cant connect to peer %p: %s",this.peerId,e.message)}this._log("sending message to peer %p",this.peerId),this.network.sendMessage(this.peerId,e,t).catch((e=>{this._log.error("send error",e)}))}}class Xe{peers;wantlist;network;_peerId;_log;constructor(e,t,n,s){this.peers=(0,X.n)({name:"ipfs_bitswap_want_manager_peers",metrics:s.metrics}),this.wantlist=new me(n,s),this.network=t,this._peerId=e,this._log=ce(e,"want")}_addEntries(e,t,n,s={}){const r=e.map(((e,n)=>new fe.Entry(e,Me-n,fe.WantType.Block,t)));r.forEach((e=>{e.cancel?!0===n?this.wantlist.removeForce(e.cid.toString(g)):this.wantlist.remove(e.cid):(this._log("adding to wantlist"),this.wantlist.add(e.cid,e.priority))}));for(const e of this.peers.values())e.addEntries(r,s)}_startPeerHandler(e){let t=this.peers.get(e.toString());if(null!=t)return void t.refcnt++;t=new Ye(this._peerId,e,this.network);const n=new fe(!0);for(const e of this.wantlist.entries())n.addEntry(e[1].cid,e[1].priority);return t.addMessage(n),this.peers.set(e.toString(),t),t}_stopPeerHandler(e){const t=this.peers.get(e.toString());null!=t&&(t.refcnt--,t.refcnt>0||this.peers.delete(e.toString()))}wantBlocks(e,t={}){this._addEntries(e,!1,!1,t),t.signal?.addEventListener("abort",(()=>{this.cancelWants(e)}))}unwantBlocks(e){this._log("unwant blocks: %s",e.length),this._addEntries(e,!0,!0)}cancelWants(e){this._log("cancel wants: %s",e.length),this._addEntries(e,!0)}connectedPeers(){return Array.from(this.peers.keys())}connected(e){this._startPeerHandler(e)}disconnected(e){this._stopPeerHandler(e)}start(){}stop(){this.peers.forEach((e=>{this.disconnected(e.peerId)}))}}const Qe={maxInboundStreams:1024,maxOutboundStreams:1024,incomingStreamTimeout:3e4,hashLoader:{async getHasher(){throw new Error("Not implemented")}},statsEnabled:!1,statsComputeThrottleTimeout:1e3,statsComputeThrottleMaxQueueSize:1e3},Je=["blocksReceived","dataReceived","dupBlksReceived","dupDataReceived","blocksSent","dataSent","providesBufferLength","wantListLength","peerCount"];class Ze{_libp2p;_log;stats;network;blockstore;engine;wm;notifications;started;constructor(e,t,n={}){this._libp2p=e,this._log=ce(this.peerId),n=Object.assign({},Qe,n),this.stats=new Ge(e,Je,{enabled:n.statsEnabled,computeThrottleTimeout:n.statsComputeThrottleTimeout,computeThrottleMaxQueueSize:n.statsComputeThrottleMaxQueueSize}),this.network=new ze(e,this,this.stats,{hashLoader:n.hashLoader,maxInboundStreams:n.maxInboundStreams,maxOutboundStreams:n.maxOutboundStreams,incomingStreamTimeout:n.incomingStreamTimeout}),this.blockstore=t,this.engine=new Te(this.peerId,t,this.network,this.stats,e),this.wm=new Xe(this.peerId,this.network,this.stats,e),this.notifications=new $e(this.peerId),this.started=!1}isStarted(){return this.started}get peerId(){return this._libp2p.peerId}async _receiveMessage(e,t){try{await this.engine.messageReceived(e,t)}catch(e){this._log("failed to receive message",t)}if(0===t.blocks.size)return;const n=[];for(const[e,s]of t.blocks.entries()){const t=H.parse(e);n.push({wasWanted:this.wm.wantlist.contains(t),cid:t,data:s})}this.wm.cancelWants(n.filter((({wasWanted:e})=>e)).map((({cid:e})=>e))),await Promise.all(n.map((async({cid:t,wasWanted:n,data:s})=>{await this._handleReceivedBlock(e,t,s,n)})))}async _handleReceivedBlock(e,t,n,s){this._log("received block");const r=await this.blockstore.has(t);this._updateReceiveCounters(e.toString(),t,n,r),s&&await this.put(t,n)}_updateReceiveCounters(e,t,n,s){this.stats.push(e,"blocksReceived",1),this.stats.push(e,"dataReceived",n.length),s&&(this.stats.push(e,"dupBlksReceived",1),this.stats.push(e,"dupDataReceived",n.length))}_receiveError(e){this._log.error("ReceiveError",e)}_onPeerConnected(e){this.wm.connected(e)}_onPeerDisconnected(e){this.wm.disconnected(e),this.engine.peerDisconnected(e),this.stats.disconnected(e)}enableStats(){this.stats.enable()}disableStats(){this.stats.disable()}wantlistForPeer(e,t){return this.engine.wantlistForPeer(e)}ledgerForPeer(e){return this.engine.ledgerForPeer(e)}async want(e,t={}){const n=async(e,t)=>(this.wm.wantBlocks([e],t),this.notifications.wantBlock(e,t));let s=!1;const r=async(e,t)=>{try{return await this.blockstore.get(e,t)}catch(r){if("ERR_NOT_FOUND"!==r.code)throw r;return s||(s=!0,this.network.findAndConnect(e,t).catch((e=>{this._log.error(e)}))),await n(e,t)}},o=new AbortController,i=function(e){const t=new globalThis.AbortController;function n(){t.abort();for(const t of e)null!=t?.removeEventListener&&t.removeEventListener("abort",n)}for(const t of e){if(!0===t?.aborted){n();break}null!=t?.addEventListener&&t.addEventListener("abort",n)}const s=t.signal;return s.clear=function(){for(const t of e)null!=t?.removeEventListener&&t.removeEventListener("abort",n)},s}([o.signal,t.signal]);try{return await Promise.race([this.notifications.wantBlock(e,{...t,signal:i}),r(e,{...t,signal:i})])}finally{o.abort(),i.clear()}}unwant(e){const t=Array.isArray(e)?e:[e];this.wm.unwantBlocks(t),t.forEach((e=>{this.notifications.unwantBlock(e)}))}cancelWants(e){this.wm.cancelWants(Array.isArray(e)?e:[e])}async put(e,t,n){await this.blockstore.put(e,t),this.notify(e,t)}async*putMany(e,t){yield*this.blockstore.putMany(r(e,(({cid:e,block:t})=>{this.notify(e,t)})),t)}notify(e,t,n={}){this.notifications.hasBlock(e,t),this.engine.receivedBlocks([{cid:e,block:t}]),this.network.provide(e,n).catch((e=>{this._log.error("Failed to provide: %s",e.message)}))}getWantlist(){return this.wm.wantlist.entries()}get peers(){return this.engine.peers()}async start(){this.wm.start(),await this.network.start(),this.engine.start(),this.started=!0}async stop(){this.stats.stop(),this.wm.stop(),await this.network.stop(),this.engine.stop(),this.started=!1}}const et=(e,t,n={})=>new Ze(e,t,n)},65114:function(e,t,n){"use strict";n.d(t,{Zx:function(){return l},KF:function(){return d}});var s=n(66310),r=n(26946);const o=r.Reader,i=r.Writer,a=r.util,c=r.roots["ipfs-unixfs"]||(r.roots["ipfs-unixfs"]={});c.Data=(()=>{function e(e){if(this.blocksizes=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.Type=0,e.prototype.Data=a.newBuffer([]),e.prototype.filesize=a.Long?a.Long.fromBits(0,0,!0):0,e.prototype.blocksizes=a.emptyArray,e.prototype.hashType=a.Long?a.Long.fromBits(0,0,!0):0,e.prototype.fanout=a.Long?a.Long.fromBits(0,0,!0):0,e.prototype.mode=0,e.prototype.mtime=null,e.encode=function(e,t){if(t||(t=i.create()),t.uint32(8).int32(e.Type),null!=e.Data&&Object.hasOwnProperty.call(e,"Data")&&t.uint32(18).bytes(e.Data),null!=e.filesize&&Object.hasOwnProperty.call(e,"filesize")&&t.uint32(24).uint64(e.filesize),null!=e.blocksizes&&e.blocksizes.length)for(var n=0;n<e.blocksizes.length;++n)t.uint32(32).uint64(e.blocksizes[n]);return null!=e.hashType&&Object.hasOwnProperty.call(e,"hashType")&&t.uint32(40).uint64(e.hashType),null!=e.fanout&&Object.hasOwnProperty.call(e,"fanout")&&t.uint32(48).uint64(e.fanout),null!=e.mode&&Object.hasOwnProperty.call(e,"mode")&&t.uint32(56).uint32(e.mode),null!=e.mtime&&Object.hasOwnProperty.call(e,"mtime")&&c.UnixTime.encode(e.mtime,t.uint32(66).fork()).ldelim(),t},e.decode=function(e,t){e instanceof o||(e=o.create(e));for(var n=void 0===t?e.len:e.pos+t,s=new c.Data;e.pos<n;){var r=e.uint32();switch(r>>>3){case 1:s.Type=e.int32();break;case 2:s.Data=e.bytes();break;case 3:s.filesize=e.uint64();break;case 4:if(s.blocksizes&&s.blocksizes.length||(s.blocksizes=[]),2==(7&r))for(var i=e.uint32()+e.pos;e.pos<i;)s.blocksizes.push(e.uint64());else s.blocksizes.push(e.uint64());break;case 5:s.hashType=e.uint64();break;case 6:s.fanout=e.uint64();break;case 7:s.mode=e.uint32();break;case 8:s.mtime=c.UnixTime.decode(e,e.uint32());break;default:e.skipType(7&r)}}if(!s.hasOwnProperty("Type"))throw a.ProtocolError("missing required 'Type'",{instance:s});return s},e.fromObject=function(e){if(e instanceof c.Data)return e;var t=new c.Data;switch(e.Type){case"Raw":case 0:t.Type=0;break;case"Directory":case 1:t.Type=1;break;case"File":case 2:t.Type=2;break;case"Metadata":case 3:t.Type=3;break;case"Symlink":case 4:t.Type=4;break;case"HAMTShard":case 5:t.Type=5}if(null!=e.Data&&("string"==typeof e.Data?a.base64.decode(e.Data,t.Data=a.newBuffer(a.base64.length(e.Data)),0):e.Data.length&&(t.Data=e.Data)),null!=e.filesize&&(a.Long?(t.filesize=a.Long.fromValue(e.filesize)).unsigned=!0:"string"==typeof e.filesize?t.filesize=parseInt(e.filesize,10):"number"==typeof e.filesize?t.filesize=e.filesize:"object"==typeof e.filesize&&(t.filesize=new a.LongBits(e.filesize.low>>>0,e.filesize.high>>>0).toNumber(!0))),e.blocksizes){if(!Array.isArray(e.blocksizes))throw TypeError(".Data.blocksizes: array expected");t.blocksizes=[];for(var n=0;n<e.blocksizes.length;++n)a.Long?(t.blocksizes[n]=a.Long.fromValue(e.blocksizes[n])).unsigned=!0:"string"==typeof e.blocksizes[n]?t.blocksizes[n]=parseInt(e.blocksizes[n],10):"number"==typeof e.blocksizes[n]?t.blocksizes[n]=e.blocksizes[n]:"object"==typeof e.blocksizes[n]&&(t.blocksizes[n]=new a.LongBits(e.blocksizes[n].low>>>0,e.blocksizes[n].high>>>0).toNumber(!0))}if(null!=e.hashType&&(a.Long?(t.hashType=a.Long.fromValue(e.hashType)).unsigned=!0:"string"==typeof e.hashType?t.hashType=parseInt(e.hashType,10):"number"==typeof e.hashType?t.hashType=e.hashType:"object"==typeof e.hashType&&(t.hashType=new a.LongBits(e.hashType.low>>>0,e.hashType.high>>>0).toNumber(!0))),null!=e.fanout&&(a.Long?(t.fanout=a.Long.fromValue(e.fanout)).unsigned=!0:"string"==typeof e.fanout?t.fanout=parseInt(e.fanout,10):"number"==typeof e.fanout?t.fanout=e.fanout:"object"==typeof e.fanout&&(t.fanout=new a.LongBits(e.fanout.low>>>0,e.fanout.high>>>0).toNumber(!0))),null!=e.mode&&(t.mode=e.mode>>>0),null!=e.mtime){if("object"!=typeof e.mtime)throw TypeError(".Data.mtime: object expected");t.mtime=c.UnixTime.fromObject(e.mtime)}return t},e.toObject=function(e,t){t||(t={});var n={};if((t.arrays||t.defaults)&&(n.blocksizes=[]),t.defaults){if(n.Type=t.enums===String?"Raw":0,t.bytes===String?n.Data="":(n.Data=[],t.bytes!==Array&&(n.Data=a.newBuffer(n.Data))),a.Long){var s=new a.Long(0,0,!0);n.filesize=t.longs===String?s.toString():t.longs===Number?s.toNumber():s}else n.filesize=t.longs===String?"0":0;if(a.Long){s=new a.Long(0,0,!0);n.hashType=t.longs===String?s.toString():t.longs===Number?s.toNumber():s}else n.hashType=t.longs===String?"0":0;if(a.Long){s=new a.Long(0,0,!0);n.fanout=t.longs===String?s.toString():t.longs===Number?s.toNumber():s}else n.fanout=t.longs===String?"0":0;n.mode=0,n.mtime=null}if(null!=e.Type&&e.hasOwnProperty("Type")&&(n.Type=t.enums===String?c.Data.DataType[e.Type]:e.Type),null!=e.Data&&e.hasOwnProperty("Data")&&(n.Data=t.bytes===String?a.base64.encode(e.Data,0,e.Data.length):t.bytes===Array?Array.prototype.slice.call(e.Data):e.Data),null!=e.filesize&&e.hasOwnProperty("filesize")&&("number"==typeof e.filesize?n.filesize=t.longs===String?String(e.filesize):e.filesize:n.filesize=t.longs===String?a.Long.prototype.toString.call(e.filesize):t.longs===Number?new a.LongBits(e.filesize.low>>>0,e.filesize.high>>>0).toNumber(!0):e.filesize),e.blocksizes&&e.blocksizes.length){n.blocksizes=[];for(var r=0;r<e.blocksizes.length;++r)"number"==typeof e.blocksizes[r]?n.blocksizes[r]=t.longs===String?String(e.blocksizes[r]):e.blocksizes[r]:n.blocksizes[r]=t.longs===String?a.Long.prototype.toString.call(e.blocksizes[r]):t.longs===Number?new a.LongBits(e.blocksizes[r].low>>>0,e.blocksizes[r].high>>>0).toNumber(!0):e.blocksizes[r]}return null!=e.hashType&&e.hasOwnProperty("hashType")&&("number"==typeof e.hashType?n.hashType=t.longs===String?String(e.hashType):e.hashType:n.hashType=t.longs===String?a.Long.prototype.toString.call(e.hashType):t.longs===Number?new a.LongBits(e.hashType.low>>>0,e.hashType.high>>>0).toNumber(!0):e.hashType),null!=e.fanout&&e.hasOwnProperty("fanout")&&("number"==typeof e.fanout?n.fanout=t.longs===String?String(e.fanout):e.fanout:n.fanout=t.longs===String?a.Long.prototype.toString.call(e.fanout):t.longs===Number?new a.LongBits(e.fanout.low>>>0,e.fanout.high>>>0).toNumber(!0):e.fanout),null!=e.mode&&e.hasOwnProperty("mode")&&(n.mode=e.mode),null!=e.mtime&&e.hasOwnProperty("mtime")&&(n.mtime=c.UnixTime.toObject(e.mtime,t)),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,r.util.toJSONOptions)},e.DataType=function(){const e={},t=Object.create(e);return t[e[0]="Raw"]=0,t[e[1]="Directory"]=1,t[e[2]="File"]=2,t[e[3]="Metadata"]=3,t[e[4]="Symlink"]=4,t[e[5]="HAMTShard"]=5,t}(),e})(),c.UnixTime=(()=>{function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.Seconds=a.Long?a.Long.fromBits(0,0,!1):0,e.prototype.FractionalNanoseconds=0,e.encode=function(e,t){return t||(t=i.create()),t.uint32(8).int64(e.Seconds),null!=e.FractionalNanoseconds&&Object.hasOwnProperty.call(e,"FractionalNanoseconds")&&t.uint32(21).fixed32(e.FractionalNanoseconds),t},e.decode=function(e,t){e instanceof o||(e=o.create(e));for(var n=void 0===t?e.len:e.pos+t,s=new c.UnixTime;e.pos<n;){var r=e.uint32();switch(r>>>3){case 1:s.Seconds=e.int64();break;case 2:s.FractionalNanoseconds=e.fixed32();break;default:e.skipType(7&r)}}if(!s.hasOwnProperty("Seconds"))throw a.ProtocolError("missing required 'Seconds'",{instance:s});return s},e.fromObject=function(e){if(e instanceof c.UnixTime)return e;var t=new c.UnixTime;return null!=e.Seconds&&(a.Long?(t.Seconds=a.Long.fromValue(e.Seconds)).unsigned=!1:"string"==typeof e.Seconds?t.Seconds=parseInt(e.Seconds,10):"number"==typeof e.Seconds?t.Seconds=e.Seconds:"object"==typeof e.Seconds&&(t.Seconds=new a.LongBits(e.Seconds.low>>>0,e.Seconds.high>>>0).toNumber())),null!=e.FractionalNanoseconds&&(t.FractionalNanoseconds=e.FractionalNanoseconds>>>0),t},e.toObject=function(e,t){t||(t={});var n={};if(t.defaults){if(a.Long){var s=new a.Long(0,0,!1);n.Seconds=t.longs===String?s.toString():t.longs===Number?s.toNumber():s}else n.Seconds=t.longs===String?"0":0;n.FractionalNanoseconds=0}return null!=e.Seconds&&e.hasOwnProperty("Seconds")&&("number"==typeof e.Seconds?n.Seconds=t.longs===String?String(e.Seconds):e.Seconds:n.Seconds=t.longs===String?a.Long.prototype.toString.call(e.Seconds):t.longs===Number?new a.LongBits(e.Seconds.low>>>0,e.Seconds.high>>>0).toNumber():e.Seconds),null!=e.FractionalNanoseconds&&e.hasOwnProperty("FractionalNanoseconds")&&(n.FractionalNanoseconds=e.FractionalNanoseconds),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,r.util.toJSONOptions)},e})(),c.Metadata=(()=>{function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.MimeType="",e.encode=function(e,t){return t||(t=i.create()),null!=e.MimeType&&Object.hasOwnProperty.call(e,"MimeType")&&t.uint32(10).string(e.MimeType),t},e.decode=function(e,t){e instanceof o||(e=o.create(e));for(var n=void 0===t?e.len:e.pos+t,s=new c.Metadata;e.pos<n;){var r=e.uint32();if(r>>>3==1)s.MimeType=e.string();else e.skipType(7&r)}return s},e.fromObject=function(e){if(e instanceof c.Metadata)return e;var t=new c.Metadata;return null!=e.MimeType&&(t.MimeType=String(e.MimeType)),t},e.toObject=function(e,t){t||(t={});var n={};return t.defaults&&(n.MimeType=""),null!=e.MimeType&&e.hasOwnProperty("MimeType")&&(n.MimeType=e.MimeType),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,r.util.toJSONOptions)},e})(),parseInt("0644",8),parseInt("0755",8);function l(e){if(null!=e)return"number"==typeof e?4095&e:"0"===(e=e.toString()).substring(0,1)?4095&parseInt(e,8):4095&parseInt(e,10)}function d(e){if(null==e)return;let t;if(null!=e.secs&&(t={secs:e.secs,nsecs:e.nsecs}),null!=e.Seconds&&(t={secs:e.Seconds,nsecs:e.FractionalNanoseconds}),Array.isArray(e)&&(t={secs:e[0],nsecs:e[1]}),e instanceof Date){const n=e.getTime(),s=Math.floor(n/1e3);t={secs:s,nsecs:1e3*(n-1e3*s)}}if(Object.prototype.hasOwnProperty.call(t,"secs")){if(null!=t&&null!=t.nsecs&&(t.nsecs<0||t.nsecs>999999999))throw s(new Error("mtime-nsecs must be within the range [0,999999999]"),"ERR_INVALID_MTIME_NSECS");return t}}},66463:function(e,t,n){"use strict";async function s(e){const t=[];for await(const n of e)t.push(n);return t}n.d(t,{A:function(){return s}})},11363:function(e,t,n){"use strict";function s(e){const[t,n]=null!=e[Symbol.asyncIterator]?[e[Symbol.asyncIterator](),Symbol.asyncIterator]:[e[Symbol.iterator](),Symbol.iterator],s=[];return{peek:()=>t.next(),push:e=>{s.push(e)},next:()=>s.length>0?{done:!1,value:s.shift()}:t.next(),[n](){return this}}}n.d(t,{A:function(){return s}})},87144:function(e,t){"use strict";t.A=()=>{}},73394:function(e,t,n){"use strict";n.d(t,{M:function(){return l}});var s=n(66310),r=n(65385),o=n(11363),i=n(47390),a=n(56338),c=n(65114);async function*l(e,t){if("string"==typeof e||e instanceof String||(0,a.aY)(e)||(0,a.qf)(e)||e._readableState)throw s(new Error("Unexpected input: single item passed - if you are using ipfs.addAll, please use ipfs.add instead"),"ERR_UNEXPECTED_INPUT");if((0,a.H1)(e)&&(e=(0,r.A)(e)),Symbol.iterator in e||Symbol.asyncIterator in e){const n=(0,o.A)(e),{value:r,done:c}=await n.peek();if(c)return void(yield*[]);if(n.push(r),Number.isInteger(r))throw s(new Error("Unexpected input: single item passed - if you are using ipfs.addAll, please use ipfs.add instead"),"ERR_UNEXPECTED_INPUT");if(r._readableState)return void(yield*(0,i.A)(n,(e=>d({content:e},t))));if((0,a.aY)(r))return void(yield d({content:n},t));if((0,a.E$)(r)||r[Symbol.iterator]||r[Symbol.asyncIterator]||(0,a.H1)(r)||(0,a.qf)(r))return void(yield*(0,i.A)(n,(e=>d(e,t))))}if((0,a.E$)(e))throw s(new Error("Unexpected input: single item passed - if you are using ipfs.addAll, please use ipfs.add instead"),"ERR_UNEXPECTED_INPUT");throw s(new Error("Unexpected input: "+typeof e),"ERR_UNEXPECTED_INPUT")}async function d(e,t){const{path:n,mode:s,mtime:r,content:o}=e,i={path:n||"",mode:(0,c.Zx)(s),mtime:(0,c.KF)(r)};return o?i.content=await t(o):n||(i.content=await t(e)),i}},4117:function(e,t,n){"use strict";n.d(t,{S:function(){return h}});var s=n(66310),r=n(16676),o=n(65385),i=n(22909),a=n(11363),c=n(66463),l=n(47390),d=n(56338);async function*u(e){yield e}async function h(e){if((0,d.aY)(e))return u(p(e));if("string"==typeof e||e instanceof String)return u(p(e.toString()));if((0,d.qf)(e))return(0,i.A)(e);if((0,d.H1)(e)&&(e=(0,o.A)(e)),Symbol.iterator in e||Symbol.asyncIterator in e){const t=(0,a.A)(e),{value:n,done:s}=await t.peek();if(s)return u(new Uint8Array(0));if(t.push(n),Number.isInteger(n))return u(Uint8Array.from(await(0,c.A)(t)));if((0,d.aY)(n)||"string"==typeof n||n instanceof String)return(0,l.A)(t,p)}throw s(new Error(`Unexpected input: ${e}`),"ERR_UNEXPECTED_INPUT")}function p(e){return e instanceof Uint8Array?e:ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):e instanceof ArrayBuffer?new Uint8Array(e):Array.isArray(e)?Uint8Array.from(e):(0,r.s)(e.toString())}},43734:function(e,t,n){"use strict";n.d(t,{n:function(){return d}});var s=n(4117),r=n(66310),o=n(65385),i=n(11363),a=n(56338),c=n(65114);async function l(e,t){const{path:n,mode:s,mtime:r,content:o}=e,i={path:n||"",mode:(0,c.Zx)(s),mtime:(0,c.KF)(r)};return o?i.content=await t(o):n||(i.content=await t(e)),i}function d(e){return async function*(e,t){if(null==e)throw r(new Error(`Unexpected input: ${e}`),"ERR_UNEXPECTED_INPUT");if("string"==typeof e||e instanceof String)yield l(e.toString(),t);else if((0,a.aY)(e)||(0,a.qf)(e))yield l(e,t);else{if((0,a.H1)(e)&&(e=(0,o.A)(e)),Symbol.iterator in e||Symbol.asyncIterator in e){const n=(0,i.A)(e),{value:s,done:o}=await n.peek();if(o)return void(yield{content:[]});if(n.push(s),Number.isInteger(s)||(0,a.aY)(s)||"string"==typeof s||s instanceof String)return void(yield l(n,t));throw r(new Error("Unexpected input: multiple items passed - if you are using ipfs.add, please use ipfs.addAll instead"),"ERR_UNEXPECTED_INPUT")}if(!(0,a.E$)(e))throw r(new Error('Unexpected input: cannot convert "'+typeof e+'" into ImportCandidate'),"ERR_UNEXPECTED_INPUT");yield l(e,t)}}(e,s.S)}},56338:function(e,t,n){"use strict";function s(e){return ArrayBuffer.isView(e)||e instanceof ArrayBuffer}function r(e){return e.constructor&&("Blob"===e.constructor.name||"File"===e.constructor.name)&&"function"==typeof e.stream}function o(e){return"object"==typeof e&&(e.path||e.content)}n.d(t,{E$:function(){return o},H1:function(){return i},aY:function(){return s},qf:function(){return r}});const i=e=>e&&"function"==typeof e.getReader},46990:function(e,t,n){"use strict";n.d(t,{g:function(){return r}});const s=e=>Promise.reject(new Error(`No base found for "${e}"`));class r{constructor(e){this._basesByName={},this._basesByPrefix={},this._loadBase=e.loadBase||s;for(const t of e.bases)this.addBase(t)}addBase(e){if(this._basesByName[e.name]||this._basesByPrefix[e.prefix])throw new Error(`Codec already exists for codec "${e.name}"`);this._basesByName[e.name]=e,this._basesByPrefix[e.prefix]=e}removeBase(e){delete this._basesByName[e.name],delete this._basesByPrefix[e.prefix]}async getBase(e){if(this._basesByName[e])return this._basesByName[e];if(this._basesByPrefix[e])return this._basesByPrefix[e];const t=await this._loadBase(e);return null==this._basesByName[t.name]&&null==this._basesByPrefix[t.prefix]&&this.addBase(t),t}listBases(){return Object.values(this._basesByName)}}},26425:function(e,t,n){"use strict";n.d(t,{l:function(){return r}});const s=e=>Promise.reject(new Error(`No codec found for "${e}"`));class r{constructor(e){this._codecsByName={},this._codecsByCode={},this._loadCodec=e.loadCodec||s;for(const t of e.codecs)this.addCodec(t)}addCodec(e){if(this._codecsByName[e.name]||this._codecsByCode[e.code])throw new Error(`Resolver already exists for codec "${e.name}"`);this._codecsByName[e.name]=e,this._codecsByCode[e.code]=e}removeCodec(e){delete this._codecsByName[e.name],delete this._codecsByCode[e.code]}async getCodec(e){const t="string"==typeof e?this._codecsByName:this._codecsByCode;if(t[e])return t[e];const n=await this._loadCodec(e);return null==t[e]&&this.addCodec(n),n}listCodecs(){return Object.values(this._codecsByName)}}},74322:function(e,t,n){"use strict";n.d(t,{i:function(){return r}});const s=e=>Promise.reject(new Error(`No hasher found for "${e}"`));class r{constructor(e){this._hashersByName={},this._hashersByCode={},this._loadHasher=e.loadHasher||s;for(const t of e.hashers)this.addHasher(t)}addHasher(e){if(this._hashersByName[e.name]||this._hashersByCode[e.code])throw new Error(`Resolver already exists for codec "${e.name}"`);this._hashersByName[e.name]=e,this._hashersByCode[e.code]=e}removeHasher(e){delete this._hashersByName[e.name],delete this._hashersByCode[e.code]}async getHasher(e){const t="string"==typeof e?this._hashersByName:this._hashersByCode;if(t[e])return t[e];const n=await this._loadHasher(e);return null==t[e]&&this.addHasher(n),n}listHashers(){return Object.values(this._hashersByName)}}},96091:function(e,t,n){"use strict";n.d(t,{e:function(){return h}});var s=n(66310),r=n(11363),o=n(65385),i=n(66463),a=n(56338);async function c(e){if((0,a.aY)(e))return new Blob([e]);if("string"==typeof e||e instanceof String)return new Blob([e.toString()]);if((0,a.qf)(e))return e;if((0,a.H1)(e)&&(e=(0,o.A)(e)),Symbol.iterator in e||Symbol.asyncIterator in e){const t=(0,r.A)(e),{value:n,done:s}=await t.peek();if(s)return l(t);if(t.push(n),Number.isInteger(n))return new Blob([Uint8Array.from(await(0,i.A)(t))]);if((0,a.aY)(n)||"string"==typeof n||n instanceof String)return l(t)}throw s(new Error(`Unexpected input: ${e}`),"ERR_UNEXPECTED_INPUT")}async function l(e){const t=[];for await(const n of e)t.push(n);return new Blob(t)}var d=n(73394);function u(e){if(null!=e)return"string"==typeof e?e:e.toString(8).padStart(4,"0")}async function h(e,t,n={}){const s=[],r=new FormData;let o=0,i=0;for await(const{content:t,path:n,mode:l,mtime:h}of(a=e,(0,d.M)(a,c,!0))){let e="";o>0&&(e=`-${o}`);let a=(t?"file":"dir")+e;const c=[];if(null!=l&&c.push(`mode=${u(l)}`),null!=h){const{secs:e,nsecs:t}=h;c.push(`mtime=${e}`),null!=t&&c.push(`mtime-nsecs=${t}`)}if(c.length&&(a=`${a}?${c.join("&")}`),t){r.set(a,t,null!=n?encodeURIComponent(n):void 0);const e=i+t.size;s.push({name:n,start:i,end:e}),i=e}else{if(null==n)throw new Error("path or content or both must be set");r.set(a,new File([""],encodeURIComponent(n),{type:"application/x-directory"}))}o++}var a;return{total:i,parts:s,headers:n,body:r}}},775:function(e,t,n){"use strict";n.d(t,{n:function(){return i}});var s=n(66310),r=n(75946);function o(e){return null!=r.TO.asCID(e)}async function*i(e){if(null==e)throw s(new Error(`Unexpected input: ${e}`),"ERR_UNEXPECTED_INPUT");const t=r.TO.asCID(e);if(t)yield a({cid:t});else{if(!(e instanceof String||"string"==typeof e)){if(null!=e.cid||null!=e.path)return yield a(e);if(n=e,Symbol.iterator in n){const t=e[Symbol.iterator](),n=t.next();if(n.done)return t;if(o(n.value)){yield a({cid:n.value});for(const e of t)yield a({cid:e});return}if(n.value instanceof String||"string"==typeof n.value){yield a({path:n.value});for(const e of t)yield a({path:e});return}if(null!=n.value.cid||null!=n.value.path){yield a(n.value);for(const e of t)yield a(e);return}throw s(new Error("Unexpected input: "+typeof e),"ERR_UNEXPECTED_INPUT")}var n;if(function(e){return Symbol.asyncIterator in e}(e)){const t=e[Symbol.asyncIterator](),n=await t.next();if(n.done)return t;if(o(n.value)){yield a({cid:n.value});for await(const e of t)yield a({cid:e});return}if(n.value instanceof String||"string"==typeof n.value){yield a({path:n.value});for await(const e of t)yield a({path:e});return}if(null!=n.value.cid||null!=n.value.path){yield a(n.value);for await(const e of t)yield a(e);return}throw s(new Error("Unexpected input: "+typeof e),"ERR_UNEXPECTED_INPUT")}throw s(new Error("Unexpected input: "+typeof e),"ERR_UNEXPECTED_INPUT")}yield a({path:e})}}function a(e){const t=e.cid||`${e.path}`;if(!t)throw s(new Error("Unexpected input: Please path either a CID or an IPFS path"),"ERR_UNEXPECTED_INPUT");const n={path:t,recursive:!1!==e.recursive};return null!=e.metadata&&(n.metadata=e.metadata),n}},59246:function(e,t,n){"use strict";n.d(t,{O:function(){return o}});var s=n(2597),r=n(29141);function o(e){try{e=(0,r._)((0,s.HZ)(e))}catch(e){}return e=e.toString()}},84073:function(e,t,n){"use strict";n.d(t,{vt:function(){return EP}});var s={};n.r(s),n.d(s,{InvalidValueError:function(){return Vu},MissingRepoOptionsError:function(){return Ku},NonReversibleMigrationError:function(){return ju},NotInitializedRepoError:function(){return Hu},RequiredParameterError:function(){return $u}});var r={};n.r(r),n.d(r,{abortedError:function(){return iP},notFoundError:function(){return oP}});var o=n(5027),i=n(28493),a=n(64340),c=n(66310),l=n(26946);const d=l.Reader,u=l.Writer,h=l.util,p=l.roots["ipfs-unixfs"]||(l.roots["ipfs-unixfs"]={}),f=p.Data=(()=>{function e(e){if(this.blocksizes=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.Type=0,e.prototype.Data=h.newBuffer([]),e.prototype.filesize=h.Long?h.Long.fromBits(0,0,!0):0,e.prototype.blocksizes=h.emptyArray,e.prototype.hashType=h.Long?h.Long.fromBits(0,0,!0):0,e.prototype.fanout=h.Long?h.Long.fromBits(0,0,!0):0,e.prototype.mode=0,e.prototype.mtime=null,e.encode=function(e,t){if(t||(t=u.create()),t.uint32(8).int32(e.Type),null!=e.Data&&Object.hasOwnProperty.call(e,"Data")&&t.uint32(18).bytes(e.Data),null!=e.filesize&&Object.hasOwnProperty.call(e,"filesize")&&t.uint32(24).uint64(e.filesize),null!=e.blocksizes&&e.blocksizes.length)for(var n=0;n<e.blocksizes.length;++n)t.uint32(32).uint64(e.blocksizes[n]);return null!=e.hashType&&Object.hasOwnProperty.call(e,"hashType")&&t.uint32(40).uint64(e.hashType),null!=e.fanout&&Object.hasOwnProperty.call(e,"fanout")&&t.uint32(48).uint64(e.fanout),null!=e.mode&&Object.hasOwnProperty.call(e,"mode")&&t.uint32(56).uint32(e.mode),null!=e.mtime&&Object.hasOwnProperty.call(e,"mtime")&&p.UnixTime.encode(e.mtime,t.uint32(66).fork()).ldelim(),t},e.decode=function(e,t){e instanceof d||(e=d.create(e));for(var n=void 0===t?e.len:e.pos+t,s=new p.Data;e.pos<n;){var r=e.uint32();switch(r>>>3){case 1:s.Type=e.int32();break;case 2:s.Data=e.bytes();break;case 3:s.filesize=e.uint64();break;case 4:if(s.blocksizes&&s.blocksizes.length||(s.blocksizes=[]),2==(7&r))for(var o=e.uint32()+e.pos;e.pos<o;)s.blocksizes.push(e.uint64());else s.blocksizes.push(e.uint64());break;case 5:s.hashType=e.uint64();break;case 6:s.fanout=e.uint64();break;case 7:s.mode=e.uint32();break;case 8:s.mtime=p.UnixTime.decode(e,e.uint32());break;default:e.skipType(7&r)}}if(!s.hasOwnProperty("Type"))throw h.ProtocolError("missing required 'Type'",{instance:s});return s},e.fromObject=function(e){if(e instanceof p.Data)return e;var t=new p.Data;switch(e.Type){case"Raw":case 0:t.Type=0;break;case"Directory":case 1:t.Type=1;break;case"File":case 2:t.Type=2;break;case"Metadata":case 3:t.Type=3;break;case"Symlink":case 4:t.Type=4;break;case"HAMTShard":case 5:t.Type=5}if(null!=e.Data&&("string"==typeof e.Data?h.base64.decode(e.Data,t.Data=h.newBuffer(h.base64.length(e.Data)),0):e.Data.length&&(t.Data=e.Data)),null!=e.filesize&&(h.Long?(t.filesize=h.Long.fromValue(e.filesize)).unsigned=!0:"string"==typeof e.filesize?t.filesize=parseInt(e.filesize,10):"number"==typeof e.filesize?t.filesize=e.filesize:"object"==typeof e.filesize&&(t.filesize=new h.LongBits(e.filesize.low>>>0,e.filesize.high>>>0).toNumber(!0))),e.blocksizes){if(!Array.isArray(e.blocksizes))throw TypeError(".Data.blocksizes: array expected");t.blocksizes=[];for(var n=0;n<e.blocksizes.length;++n)h.Long?(t.blocksizes[n]=h.Long.fromValue(e.blocksizes[n])).unsigned=!0:"string"==typeof e.blocksizes[n]?t.blocksizes[n]=parseInt(e.blocksizes[n],10):"number"==typeof e.blocksizes[n]?t.blocksizes[n]=e.blocksizes[n]:"object"==typeof e.blocksizes[n]&&(t.blocksizes[n]=new h.LongBits(e.blocksizes[n].low>>>0,e.blocksizes[n].high>>>0).toNumber(!0))}if(null!=e.hashType&&(h.Long?(t.hashType=h.Long.fromValue(e.hashType)).unsigned=!0:"string"==typeof e.hashType?t.hashType=parseInt(e.hashType,10):"number"==typeof e.hashType?t.hashType=e.hashType:"object"==typeof e.hashType&&(t.hashType=new h.LongBits(e.hashType.low>>>0,e.hashType.high>>>0).toNumber(!0))),null!=e.fanout&&(h.Long?(t.fanout=h.Long.fromValue(e.fanout)).unsigned=!0:"string"==typeof e.fanout?t.fanout=parseInt(e.fanout,10):"number"==typeof e.fanout?t.fanout=e.fanout:"object"==typeof e.fanout&&(t.fanout=new h.LongBits(e.fanout.low>>>0,e.fanout.high>>>0).toNumber(!0))),null!=e.mode&&(t.mode=e.mode>>>0),null!=e.mtime){if("object"!=typeof e.mtime)throw TypeError(".Data.mtime: object expected");t.mtime=p.UnixTime.fromObject(e.mtime)}return t},e.toObject=function(e,t){t||(t={});var n={};if((t.arrays||t.defaults)&&(n.blocksizes=[]),t.defaults){if(n.Type=t.enums===String?"Raw":0,t.bytes===String?n.Data="":(n.Data=[],t.bytes!==Array&&(n.Data=h.newBuffer(n.Data))),h.Long){var s=new h.Long(0,0,!0);n.filesize=t.longs===String?s.toString():t.longs===Number?s.toNumber():s}else n.filesize=t.longs===String?"0":0;if(h.Long){s=new h.Long(0,0,!0);n.hashType=t.longs===String?s.toString():t.longs===Number?s.toNumber():s}else n.hashType=t.longs===String?"0":0;if(h.Long){s=new h.Long(0,0,!0);n.fanout=t.longs===String?s.toString():t.longs===Number?s.toNumber():s}else n.fanout=t.longs===String?"0":0;n.mode=0,n.mtime=null}if(null!=e.Type&&e.hasOwnProperty("Type")&&(n.Type=t.enums===String?p.Data.DataType[e.Type]:e.Type),null!=e.Data&&e.hasOwnProperty("Data")&&(n.Data=t.bytes===String?h.base64.encode(e.Data,0,e.Data.length):t.bytes===Array?Array.prototype.slice.call(e.Data):e.Data),null!=e.filesize&&e.hasOwnProperty("filesize")&&("number"==typeof e.filesize?n.filesize=t.longs===String?String(e.filesize):e.filesize:n.filesize=t.longs===String?h.Long.prototype.toString.call(e.filesize):t.longs===Number?new h.LongBits(e.filesize.low>>>0,e.filesize.high>>>0).toNumber(!0):e.filesize),e.blocksizes&&e.blocksizes.length){n.blocksizes=[];for(var r=0;r<e.blocksizes.length;++r)"number"==typeof e.blocksizes[r]?n.blocksizes[r]=t.longs===String?String(e.blocksizes[r]):e.blocksizes[r]:n.blocksizes[r]=t.longs===String?h.Long.prototype.toString.call(e.blocksizes[r]):t.longs===Number?new h.LongBits(e.blocksizes[r].low>>>0,e.blocksizes[r].high>>>0).toNumber(!0):e.blocksizes[r]}return null!=e.hashType&&e.hasOwnProperty("hashType")&&("number"==typeof e.hashType?n.hashType=t.longs===String?String(e.hashType):e.hashType:n.hashType=t.longs===String?h.Long.prototype.toString.call(e.hashType):t.longs===Number?new h.LongBits(e.hashType.low>>>0,e.hashType.high>>>0).toNumber(!0):e.hashType),null!=e.fanout&&e.hasOwnProperty("fanout")&&("number"==typeof e.fanout?n.fanout=t.longs===String?String(e.fanout):e.fanout:n.fanout=t.longs===String?h.Long.prototype.toString.call(e.fanout):t.longs===Number?new h.LongBits(e.fanout.low>>>0,e.fanout.high>>>0).toNumber(!0):e.fanout),null!=e.mode&&e.hasOwnProperty("mode")&&(n.mode=e.mode),null!=e.mtime&&e.hasOwnProperty("mtime")&&(n.mtime=p.UnixTime.toObject(e.mtime,t)),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,l.util.toJSONOptions)},e.DataType=function(){const e={},t=Object.create(e);return t[e[0]="Raw"]=0,t[e[1]="Directory"]=1,t[e[2]="File"]=2,t[e[3]="Metadata"]=3,t[e[4]="Symlink"]=4,t[e[5]="HAMTShard"]=5,t}(),e})(),y=(p.UnixTime=(()=>{function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.Seconds=h.Long?h.Long.fromBits(0,0,!1):0,e.prototype.FractionalNanoseconds=0,e.encode=function(e,t){return t||(t=u.create()),t.uint32(8).int64(e.Seconds),null!=e.FractionalNanoseconds&&Object.hasOwnProperty.call(e,"FractionalNanoseconds")&&t.uint32(21).fixed32(e.FractionalNanoseconds),t},e.decode=function(e,t){e instanceof d||(e=d.create(e));for(var n=void 0===t?e.len:e.pos+t,s=new p.UnixTime;e.pos<n;){var r=e.uint32();switch(r>>>3){case 1:s.Seconds=e.int64();break;case 2:s.FractionalNanoseconds=e.fixed32();break;default:e.skipType(7&r)}}if(!s.hasOwnProperty("Seconds"))throw h.ProtocolError("missing required 'Seconds'",{instance:s});return s},e.fromObject=function(e){if(e instanceof p.UnixTime)return e;var t=new p.UnixTime;return null!=e.Seconds&&(h.Long?(t.Seconds=h.Long.fromValue(e.Seconds)).unsigned=!1:"string"==typeof e.Seconds?t.Seconds=parseInt(e.Seconds,10):"number"==typeof e.Seconds?t.Seconds=e.Seconds:"object"==typeof e.Seconds&&(t.Seconds=new h.LongBits(e.Seconds.low>>>0,e.Seconds.high>>>0).toNumber())),null!=e.FractionalNanoseconds&&(t.FractionalNanoseconds=e.FractionalNanoseconds>>>0),t},e.toObject=function(e,t){t||(t={});var n={};if(t.defaults){if(h.Long){var s=new h.Long(0,0,!1);n.Seconds=t.longs===String?s.toString():t.longs===Number?s.toNumber():s}else n.Seconds=t.longs===String?"0":0;n.FractionalNanoseconds=0}return null!=e.Seconds&&e.hasOwnProperty("Seconds")&&("number"==typeof e.Seconds?n.Seconds=t.longs===String?String(e.Seconds):e.Seconds:n.Seconds=t.longs===String?h.Long.prototype.toString.call(e.Seconds):t.longs===Number?new h.LongBits(e.Seconds.low>>>0,e.Seconds.high>>>0).toNumber():e.Seconds),null!=e.FractionalNanoseconds&&e.hasOwnProperty("FractionalNanoseconds")&&(n.FractionalNanoseconds=e.FractionalNanoseconds),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,l.util.toJSONOptions)},e})(),p.Metadata=(()=>{function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.MimeType="",e.encode=function(e,t){return t||(t=u.create()),null!=e.MimeType&&Object.hasOwnProperty.call(e,"MimeType")&&t.uint32(10).string(e.MimeType),t},e.decode=function(e,t){e instanceof d||(e=d.create(e));for(var n=void 0===t?e.len:e.pos+t,s=new p.Metadata;e.pos<n;){var r=e.uint32();if(r>>>3==1)s.MimeType=e.string();else e.skipType(7&r)}return s},e.fromObject=function(e){if(e instanceof p.Metadata)return e;var t=new p.Metadata;return null!=e.MimeType&&(t.MimeType=String(e.MimeType)),t},e.toObject=function(e,t){t||(t={});var n={};return t.defaults&&(n.MimeType=""),null!=e.MimeType&&e.hasOwnProperty("MimeType")&&(n.MimeType=e.MimeType),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,l.util.toJSONOptions)},e})(),f),g=["raw","directory","file","metadata","symlink","hamt-sharded-directory"],m=["directory","hamt-sharded-directory"],w=parseInt("0644",8),b=parseInt("0755",8);function _(e){if(null!=e)return"number"==typeof e?4095&e:"0"===(e=e.toString()).substring(0,1)?4095&parseInt(e,8):4095&parseInt(e,10)}function E(e){if(null==e)return;let t;if(null!=e.secs&&(t={secs:e.secs,nsecs:e.nsecs}),null!=e.Seconds&&(t={secs:e.Seconds,nsecs:e.FractionalNanoseconds}),Array.isArray(e)&&(t={secs:e[0],nsecs:e[1]}),e instanceof Date){const n=e.getTime(),s=Math.floor(n/1e3);t={secs:s,nsecs:1e3*(n-1e3*s)}}if(Object.prototype.hasOwnProperty.call(t,"secs")){if(null!=t&&null!=t.nsecs&&(t.nsecs<0||t.nsecs>999999999))throw c(new Error("mtime-nsecs must be within the range [0,999999999]"),"ERR_INVALID_MTIME_NSECS");return t}}class v{static unmarshal(e){const t=y.decode(e),n=y.toObject(t,{defaults:!1,arrays:!0,longs:Number,objects:!1}),s=new v({type:g[n.Type],data:n.Data,blockSizes:n.blocksizes,mode:n.mode,mtime:n.mtime?{secs:n.mtime.Seconds,nsecs:n.mtime.FractionalNanoseconds}:void 0});return s._originalMode=n.mode||0,s}constructor(e={type:"file"}){const{type:t,data:n,blockSizes:s,hashType:r,fanout:o,mtime:i,mode:a}=e;if(t&&!g.includes(t))throw c(new Error("Type: "+t+" is not valid"),"ERR_INVALID_TYPE");this.type=t||"file",this.data=n,this.hashType=r,this.fanout=o,this.blockSizes=s||[],this._originalMode=0,this.mode=_(a),i&&(this.mtime=E(i),this.mtime&&!this.mtime.nsecs&&(this.mtime.nsecs=0))}set mode(e){this._mode=this.isDirectory()?b:w;const t=_(e);void 0!==t&&(this._mode=t)}get mode(){return this._mode}isDirectory(){return Boolean(this.type&&m.includes(this.type))}addBlockSize(e){this.blockSizes.push(e)}removeBlockSize(e){this.blockSizes.splice(e,1)}fileSize(){if(this.isDirectory())return 0;let e=0;return this.blockSizes.forEach((t=>{e+=t})),this.data&&(e+=this.data.length),e}marshal(){let e;switch(this.type){case"raw":e=y.DataType.Raw;break;case"directory":e=y.DataType.Directory;break;case"file":e=y.DataType.File;break;case"metadata":e=y.DataType.Metadata;break;case"symlink":e=y.DataType.Symlink;break;case"hamt-sharded-directory":e=y.DataType.HAMTShard;break;default:throw c(new Error("Type: "+e+" is not valid"),"ERR_INVALID_TYPE")}let t,n,s=this.data;if(this.data&&this.data.length||(s=void 0),null!=this.mode&&(t=4294963200&this._originalMode|(_(this.mode)||0),t!==w||this.isDirectory()||(t=void 0),t===b&&this.isDirectory()&&(t=void 0)),null!=this.mtime){const e=E(this.mtime);e&&(n={Seconds:e.secs,FractionalNanoseconds:e.nsecs},0===n.FractionalNanoseconds&&delete n.FractionalNanoseconds)}const r={Type:e,Data:s,filesize:this.isDirectory()?void 0:this.fileSize(),blocksizes:this.blockSizes,hashType:this.hashType,fanout:this.fanout,mode:t,mtime:n};return y.encode(r).finish()}}var S=n(24400),k=n(74868),R=n(75294),T=n(43259),I=n(97541),P=n(55195);class A extends Error{constructor(e="not initialized"){super(e),this.name="NotInitializedError",this.code=A.code}}A.code="ERR_NOT_INITIALIZED";class D extends Error{constructor(e="cannot initialize an initializing node"){super(e),this.name="AlreadyInitializingError",this.code=O.code}}D.code="ERR_ALREADY_INITIALIZING";class O extends Error{constructor(e="cannot re-initialize an initialized node"){super(e),this.name="AlreadyInitializedError",this.code=O.code}}O.code="ERR_ALREADY_INITIALIZED";class N extends Error{constructor(e="not started"){super(e),this.name="NotStartedError",this.code=N.code}}N.code="ERR_NOT_STARTED";class L extends Error{constructor(e="cannot start, already startin"){super(e),this.name="AlreadyStartingError",this.code=L.code}}L.code="ERR_ALREADY_STARTING";class M extends Error{constructor(e="cannot start, already started"){super(e),this.name="AlreadyStartedError",this.code=M.code}}M.code="ERR_ALREADY_STARTED";class C extends Error{constructor(e="not enabled"){super(e),this.name="NotEnabledError",this.code=C.code}}C.code="ERR_NOT_ENABLED";var x=n(16676),B=n(42686),z=n(32763),U=n(1987),F=n(52671),j=n(2597),H=n(71675),$=n(98067);const V=H.wM,K=H.w7,q=function(e){let t=0;if(e=e.toString().trim(),V(e)){const n=new Uint8Array(t+4);return e.split(/\./g).forEach((e=>{n[t++]=255&parseInt(e,10)})),n}if(K(e)){const n=e.split(":",8);let s;for(s=0;s<n.length;s++){let e;V(n[s])&&(e=q(n[s]),n[s]=(0,$.d)(e.slice(0,2),"base16")),null!=e&&++s<8&&n.splice(s,0,(0,$.d)(e.slice(2,4),"base16"))}if(""===n[0])for(;n.length<8;)n.unshift("0");else if(""===n[n.length-1])for(;n.length<8;)n.push("0");else if(n.length<8){for(s=0;s<n.length&&""!==n[s];s++);const e=[s,1];for(s=9-n.length;s>0;s--)e.push("0");n.splice.apply(n,e)}const r=new Uint8Array(t+16);for(s=0;s<n.length;s++){const e=parseInt(n[s],16);r[t++]=e>>8&255,r[t++]=255&e}return r}throw new Error("invalid ip address")},G=function(e,t=0,n){t=~~t,n=n??e.length-t;const s=new DataView(e.buffer);if(4===n){const s=[];for(let r=0;r<n;r++)s.push(e[t+r]);return s.join(".")}if(16===n){const e=[];for(let r=0;r<n;r+=2)e.push(s.getUint16(t+r).toString(16));return e.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""},W=-1,Y={},X={};function Q(e){if("number"==typeof e){if(null!=X[e])return X[e];throw new Error(`no protocol with code: ${e}`)}if("string"==typeof e){if(null!=Y[e])return Y[e];throw new Error(`no protocol with name: ${e}`)}throw new Error("invalid protocol id type: "+typeof e)}[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,W,"ip6zone"],[43,8,"ipcidr"],[53,W,"dns",!0],[54,W,"dns4",!0],[55,W,"dns6",!0],[56,W,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,W,"unix",!1,!0],[421,W,"ipfs"],[421,W,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,W,"garlic64"],[448,0,"tls"],[449,W,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,W,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[777,W,"memory"]].forEach((e=>{const t=function(e,t,n,s,r){return{code:e,size:t,name:n,resolvable:Boolean(s),path:Boolean(r)}}(...e);X[t.code]=t,Y[t.name]=t}));var J=n(75946),Z=n(79344),ee=n(44008);n(48874);Q("ip4"),Q("ip6"),Q("ipcidr");function te(e,t){switch(Q(e).code){case 4:case 41:return function(e){const t=G(e,0,e.length);if(null==t)throw new Error("ipBuff is required");if(!H.ei(t))throw new Error("invalid ip address");return t}(t);case 42:case 53:case 54:case 55:case 56:case 400:case 449:case 777:return le(t);case 6:case 273:case 33:case 132:return ae(t).toString();case 421:return function(e){const t=Z.decode(e),n=e.slice(Z.decode.bytes);if(n.length!==t)throw new Error("inconsistent lengths");return(0,$.d)(n,"base58btc")}(t);case 444:case 445:return de(t);case 466:return function(e){const t=Z.decode(e),n=e.slice(Z.decode.bytes);if(n.length!==t)throw new Error("inconsistent lengths");return"u"+(0,$.d)(n,"base64url")}(t);default:return(0,$.d)(t,"base16")}}function ne(e,t){switch(Q(e).code){case 4:case 41:return oe(t);case 42:case 53:case 54:case 55:case 56:case 400:case 449:case 777:return ce(t);case 6:case 273:case 33:case 132:return ie(parseInt(t,10));case 421:return function(e){let t;t="Q"===e[0]||"1"===e[0]?F.D4(z.base58btc.decode(`z${e}`)).bytes:J.TO.parse(e).multihash.bytes;const n=Uint8Array.from(Z.encode(t.length));return(0,ee.x)([n,t],n.length+t.length)}(t);case 444:return function(e){const t=e.split(":");if(2!==t.length)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(16!==t[0].length)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion address.`);const n=U.base32.decode("b"+t[0]),s=parseInt(t[1],10);if(s<1||s>65536)throw new Error("Port number is not in range(1, 65536)");const r=ie(s);return(0,ee.x)([n,r],n.length+r.length)}(t);case 445:return function(e){const t=e.split(":");if(2!==t.length)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(56!==t[0].length)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion3 address.`);const n=U.base32.decode(`b${t[0]}`),s=parseInt(t[1],10);if(s<1||s>65536)throw new Error("Port number is not in range(1, 65536)");const r=ie(s);return(0,ee.x)([n,r],n.length+r.length)}(t);case 466:return function(e){const t=re.decode(e),n=Uint8Array.from(Z.encode(t.length));return(0,ee.x)([n,t],n.length+t.length)}(t);default:return(0,x.s)(t,"base16")}}const se=Object.values(P.Fo).map((e=>e.decoder)),re=function(){let e=se[0].or(se[1]);return se.slice(2).forEach((t=>e=e.or(t))),e}();function oe(e){if(!H.ei(e))throw new Error("invalid ip address");return q(e)}function ie(e){const t=new ArrayBuffer(2);return new DataView(t).setUint16(0,e),new Uint8Array(t)}function ae(e){return new DataView(e.buffer).getUint16(e.byteOffset)}function ce(e){const t=(0,x.s)(e),n=Uint8Array.from(Z.encode(t.length));return(0,ee.x)([n,t],n.length+t.length)}function le(e){const t=Z.decode(e);if((e=e.slice(Z.decode.bytes)).length!==t)throw new Error("inconsistent lengths");return(0,$.d)(e)}function de(e){const t=e.slice(0,e.length-2),n=e.slice(e.length-2);return`${(0,$.d)(t,"base32")}:${ae(n)}`}function ue(e){return e.map((e=>{const t=Ee(e);return null!=e[1]?[t.code,te(t.code,e[1])]:[t.code]}))}function he(e){return me((0,ee.x)(e.map((e=>{const t=Ee(e);let n=Uint8Array.from(Z.encode(t.code));return e.length>1&&null!=e[1]&&(n=(0,ee.x)([n,e[1]])),n}))))}function pe(e,t){if(e.size>0)return e.size/8;if(0===e.size)return 0;return Z.decode(t)+(Z.decode.bytes??0)}function fe(e){const t=[];let n=0;for(;n<e.length;){const s=Z.decode(e,n),r=Z.decode.bytes??0,o=pe(Q(s),e.slice(n+r));if(0===o){t.push([s]),n+=r;continue}const i=e.slice(n+r,n+r+o);if(n+=o+r,n>e.length)throw _e("Invalid address Uint8Array: "+(0,$.d)(e,"base16"));t.push([s,i])}return t}function ye(e){return function(e){const t=[];return e.map((e=>{const n=Ee(e);return t.push(n.name),e.length>1&&null!=e[1]&&t.push(e[1]),null})),be(t.join("/"))}(ue(fe(e)))}function ge(e){const t=function(e){const t=[],n=e.split("/").slice(1);if(1===n.length&&""===n[0])return[];for(let s=0;s<n.length;s++){const r=n[s],o=Q(r);if(0!==o.size){if(s++,s>=n.length)throw _e("invalid address: "+e);if(!0===o.path){t.push([r,be(n.slice(s).join("/"))]);break}t.push([r,n[s]])}else t.push([r])}return t}(e=be(e));return he(t.map((e=>{Array.isArray(e)||(e=[e]);const t=Ee(e);return e.length>1?[t.code,ne(t.code,e[1])]:[t.code]})))}function me(e){const t=we(e);if(null!=t)throw t;return Uint8Array.from(e)}function we(e){try{fe(e)}catch(e){return e}}function be(e){return"/"+e.trim().split("/").filter((e=>e)).join("/")}function _e(e){return new Error("Error parsing address: "+e)}function Ee(e){return Q(e[0])}var ve=n(94145);var Se,ke,Re,Te,Ie=function(e,t,n,s){if("a"===n&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?s:"a"===n?s.call(e):s?s.value:t.get(e)},Pe=function(e,t,n,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(e,n):r?r.value=n:t.set(e,n),n};const Ae=Symbol.for("nodejs.util.inspect.custom"),De=[Q("dns").code,Q("dns4").code,Q("dns6").code,Q("dnsaddr").code],Oe=new Map,Ne=Symbol.for("@multiformats/js-multiaddr/multiaddr");function Le(e){return Boolean(e?.[Ne])}class Me{constructor(e){if(Se.set(this,void 0),ke.set(this,void 0),Re.set(this,void 0),this[Te]=!0,null==e&&(e=""),e instanceof Uint8Array)this.bytes=me(e);else if("string"==typeof e){if(e.length>0&&"/"!==e.charAt(0))throw new Error(`multiaddr "${e}" must start with a "/"`);this.bytes=ge(e)}else{if(!Le(e))throw new Error("addr must be a string, Buffer, or another Multiaddr");this.bytes=me(e.bytes)}}toString(){return null==Ie(this,Se,"f")&&Pe(this,Se,ye(this.bytes),"f"),Ie(this,Se,"f")}toJSON(){return this.toString()}toOptions(){let e,t,n,s,r="";const o=Q("tcp"),i=Q("udp"),a=Q("ip4"),c=Q("ip6"),l=Q("dns6"),d=Q("ip6zone");for(const[u,h]of this.stringTuples())u===d.code&&(r=`%${h??""}`),De.includes(u)&&(t=o.name,s=443,n=`${h??""}${r}`,e=u===l.code?6:4),u!==o.code&&u!==i.code||(t=Q(u).name,s=parseInt(h??"")),u!==a.code&&u!==c.code||(t=Q(u).name,n=`${h??""}${r}`,e=u===c.code?6:4);if(null==e||null==t||null==n||null==s)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:s}}protos(){return this.protoCodes().map((e=>Object.assign({},Q(e))))}protoCodes(){const e=[],t=this.bytes;let n=0;for(;n<t.length;){const s=Z.decode(t,n),r=Z.decode.bytes??0;n+=pe(Q(s),t.slice(n+r))+r,e.push(s)}return e}protoNames(){return this.protos().map((e=>e.name))}tuples(){return null==Ie(this,ke,"f")&&Pe(this,ke,fe(this.bytes),"f"),Ie(this,ke,"f")}stringTuples(){return null==Ie(this,Re,"f")&&Pe(this,Re,ue(this.tuples()),"f"),Ie(this,Re,"f")}encapsulate(e){return e=new Me(e),new Me(this.toString()+e.toString())}decapsulate(e){const t=e.toString(),n=this.toString(),s=n.lastIndexOf(t);if(s<0)throw new Error(`Address ${this.toString()} does not contain subaddress: ${e.toString()}`);return new Me(n.slice(0,s))}decapsulateCode(e){const t=this.tuples();for(let n=t.length-1;n>=0;n--)if(t[n][0]===e)return new Me(he(t.slice(0,n)));return this}getPeerId(){try{const e=this.stringTuples().filter((e=>e[0]===Y.ipfs.code)),t=e.pop();if(null!=t?.[1]){const e=t[1];return"Q"===e[0]||"1"===e[0]?(0,$.d)(z.base58btc.decode(`z${e}`),"base58btc"):(0,$.d)(J.TO.parse(e).multihash.bytes,"base58btc")}return null}catch(e){return null}}getPath(){let e=null;try{e=this.stringTuples().filter((e=>!0===Q(e[0]).path))[0][1],null==e&&(e=null)}catch{e=null}return e}equals(e){return(0,ve.a)(this.bytes,e.bytes)}async resolve(e){const t=this.protos().find((e=>e.resolvable));if(null==t)return[this];const n=Oe.get(t.name);if(null==n)throw c(new Error(`no available resolver for ${t.name}`),"ERR_NO_AVAILABLE_RESOLVER");return(await n(this,e)).map((e=>new Me(e)))}nodeAddress(){const e=this.toOptions();if("tcp"!==e.transport&&"udp"!==e.transport)throw new Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(e){const t=(e??this).protos();return 2===t.length&&((4===t[0].code||41===t[0].code)&&(6===t[1].code||273===t[1].code))}[(Se=new WeakMap,ke=new WeakMap,Re=new WeakMap,Te=Ne,Ae)](){return`Multiaddr(${ye(this.bytes)})`}}function Ce(e){return new Me(e)}const xe=at("dns4"),Be=at("dns6"),ze=at("dnsaddr"),Ue=it(at("dns"),ze,xe,Be),Fe=it(at("ip4"),at("ip6")),je=it(ot(Fe,at("tcp")),ot(Ue,at("tcp"))),He=ot(Fe,at("udp")),$e=ot(He,at("utp")),Ve=ot(He,at("quic")),Ke=it(ot(je,at("ws")),ot(Ue,at("ws"))),qe=it(ot(je,at("wss")),ot(Ue,at("wss")),ot(je,at("tls"),at("ws")),ot(Ue,at("tls"),at("ws"))),Ge=it(ot(je,at("http")),ot(Fe,at("http")),ot(Ue,at("http"))),We=it(ot(je,at("https")),ot(Fe,at("https")),ot(Ue,at("https"))),Ye=ot(He,at("webrtc"),at("certhash")),Xe=it(ot(Ye,at("p2p")),Ye),Qe=it(ot(Ke,at("p2p-webrtc-star"),at("p2p")),ot(qe,at("p2p-webrtc-star"),at("p2p")),ot(Ke,at("p2p-webrtc-star")),ot(qe,at("p2p-webrtc-star"))),Je=(it(ot(Ke,at("p2p-websocket-star"),at("p2p")),ot(qe,at("p2p-websocket-star"),at("p2p")),ot(Ke,at("p2p-websocket-star")),ot(qe,at("p2p-websocket-star"))),it(ot(Ge,at("p2p-webrtc-direct"),at("p2p")),ot(We,at("p2p-webrtc-direct"),at("p2p")),ot(Ge,at("p2p-webrtc-direct")),ot(We,at("p2p-webrtc-direct")))),Ze=it(Ke,qe,Ge,We,Qe,Je,je,$e,Ve,Ue,Xe),et=(it(ot(Ze,at("p2p-stardust"),at("p2p")),ot(Ze,at("p2p-stardust"))),it(ot(Ze,at("p2p")),Qe,Je,Xe,at("p2p"))),tt=it(ot(et,at("p2p-circuit"),et),ot(et,at("p2p-circuit")),ot(at("p2p-circuit"),et),ot(Ze,at("p2p-circuit")),ot(at("p2p-circuit"),Ze),at("p2p-circuit")),nt=()=>it(ot(tt,nt),tt),st=nt();it(ot(st,et,st),ot(et,st),ot(st,et),st,et);function rt(e){return function(t){let n;try{n=Ce(t)}catch(e){return!1}const s=e(n.protoNames());return null!==s&&(!0===s||!1===s?s:0===s.length)}}function ot(...e){function t(t){if(t.length<e.length)return null;let n=t;return e.some((e=>(n="function"==typeof e?e().partialMatch(t):e.partialMatch(t),Array.isArray(n)&&(t=n),null===n))),n}return{toString:function(){return"{ "+e.join(" ")+" }"},input:e,matches:rt(t),partialMatch:t}}function it(...e){function t(t){let n=null;return e.some((e=>{const s="function"==typeof e?e().partialMatch(t):e.partialMatch(t);return null!=s&&(n=s,!0)})),n}return{toString:function(){return"{ "+e.join(" ")+" }"},input:e,matches:rt(t),partialMatch:t}}function at(e){const t=e;return{toString:function(){return t},matches:function(e){let n;try{n=Ce(e)}catch(e){return!1}const s=n.protoNames();return 1===s.length&&s[0]===t},partialMatch:function(e){return 0===e.length?null:e[0]===t?e.slice(1):null}}}var ct=n(26438);const lt=/^\/(ip[fn]s)\/([^/?#]+)/,dt=/^https?:\/\/([^/]+)\.(ip[fn]s)\.[^/?]+/,ut=/^(([a-z0-9]|[a-z0-9][a-z0-9-]*[a-z0-9])\.)+([a-z0-9]|[a-z0-9][a-z0-9-]*[a-z0-9])$/;function ht(e){try{return yt(e)?Boolean(J.TO.parse(e)):e instanceof Uint8Array?Boolean(J.TO.decode(e)):Boolean(J.TO.asCID(e))}catch{return!1}}function pt(e,t,n=1,s=2){const r=gt(e);if(!1===r)return!1;const o=r.match(t);if(null==o)return!1;if("ipfs"!==o[n])return!1;let i=o[s];return null!=i&&t===dt&&(i=i.toLowerCase()),ht(i)}function ft(e,t,n=1,s=2){const r=gt(e);if(!1===r)return!1;const o=r.match(t);if(null==o)return!1;if("ipns"!==o[n])return!1;let i=o[s];if(null!=i&&t===dt){if(i=i.toLowerCase(),ht(i))return!0;try{!i.includes(".")&&i.includes("-")&&(i=i.replace(/--/g,"@").replace(/-/g,".").replace(/@/g,"-"));const{hostname:e}=new ct.URL(`http://${i}`);return ut.test(e)}catch(e){return!1}}return!0}function yt(e){return"string"==typeof e}function gt(e){return e instanceof Uint8Array?(0,$.d)(e,"base58btc"):!!yt(e)&&e}const mt=e=>pt(e,lt)||ft(e,lt),wt=e=>ft(e,lt);var bt=n(30256),_t=n(44708),Et=n(13742);class vt extends Error{constructor(e="request timed out"){super(e),this.name="TimeoutError",this.code=vt.code}}function St(e,t){return(...n)=>{const s=n[null==t?n.length-1:t];if(!s||!s.timeout)return e(...n);const r="string"==typeof s.timeout?(0,Et.A)(s.timeout):s.timeout,o=new B.TimeoutController(r);s.signal=(0,_t.anySignal)([s.signal,o.signal]);const i=e(...n),a=new Promise(((e,t)=>{o.signal.addEventListener("abort",(()=>{t(new vt)}))})),c=Date.now(),l=()=>{if(o.signal.aborted)throw new vt;if(Date.now()-c>r)throw o.abort(),new vt};return i[Symbol.asyncIterator]?async function*(){const e=i[Symbol.asyncIterator]();try{for(;;){const{value:t,done:n}=await Promise.race([e.next(),a]);if(n)break;l(),yield t}}catch(e){throw l(),e}finally{o.clear(),e.return&&e.return()}}():(async()=>{try{const e=await Promise.race([i,a]);return l(),e}catch(e){throw l(),e}finally{o.clear()}})()}}vt.code="ERR_TIMEOUT";const kt="/ipfs/";function Rt(e){if(e instanceof Uint8Array)try{e=J.TO.decode(e)}catch(e){throw c(e,"ERR_INVALID_CID")}let t=J.TO.asCID(e);if(t)return{cid:t,path:void 0};(e=e.toString()).startsWith(kt)&&(e=e.substring(kt.length));const n=e.split("/");let s;try{t=J.TO.parse(n.shift()||"")}catch(e){throw c(e,"ERR_INVALID_CID")}return n.length&&(s=`/${n.join("/")}`),{cid:t,path:s}}const Tt="This command must be run in online mode. Try running 'ipfs daemon' first.",It=new bt.U("/local/filesroot"),Pt=e=>e instanceof Uint8Array?J.TO.decode(e).toString():(0===(e=e.toString()).indexOf("/ipfs/")&&(e=e.substring("/ipfs/".length)),"/"===e.charAt(e.length-1)&&(e=e.substring(0,e.length-1)),e),At=async function(e,t,n,s={}){const{cid:r,path:o}=Rt(n);o&&(s.path=o);let i=r,a=s.path||"";if(a.startsWith("/")&&(a=a.substring(1)),s.path)try{for await(const{value:n,remainderPath:o}of Nt(r,s.path,t,e,{signal:s.signal})){if(!J.TO.asCID(n))break;a=o,i=n}}catch(e){throw e.message.startsWith("Object has no property")&&(e.message=`no link named "${a.split("/")[0]}" under ${i}`,e.code="ERR_NO_LINK"),e}return{cid:i,remainderPath:a||""}},Dt=e=>{if("file"!==e.type&&"directory"!==e.type&&"raw"!==e.type)throw new Error(`Unknown node type '${e.type}'`);const t={cid:e.cid,path:e.path,name:e.name,size:e.size,type:"file"};return"directory"===e.type&&(t.type="dir"),"file"===e.type&&(t.size=e.unixfs.fileSize()),"file"!==e.type&&"directory"!==e.type||(t.mode=e.unixfs.mode,void 0!==e.unixfs.mtime&&(t.mtime=e.unixfs.mtime)),t},Ot=St((async(e,t)=>await e)),Nt=async function*(e,t,n,s,r){const o=async e=>{const t=await n.getCodec(e.code),o=await s.blocks.get(e,r);return t.decode(o)},i=t.split("/").filter(Boolean);let a=await o(e),l=e;for(;i.length;){const n=i.shift();if(!n)throw c(new Error(`Could not resolve path "${t}"`),"ERR_INVALID_PATH");if(e.code===S.code&&Array.isArray(a.Links)){const e=a.Links.find((e=>e.Name===n));if(e){yield{value:e.Hash,remainderPath:i.join("/")},a=await o(e.Hash),l=e.Hash;continue}}if(!Object.prototype.hasOwnProperty.call(a,n))throw c(new Error(`no link named "${n}" under ${l}`),"ERR_NO_LINK");a=a[n],yield{value:a,remainderPath:i.join("/")},J.TO.asCID(a)&&(l=a,a=await o(a))}yield{value:a,remainderPath:""}};class Lt{static create({start:e,stop:t}){return new Lt(e,t)}static async start(e,t){const{state:n,activate:s}=e;switch(n.status){case"stopped":try{const n=s(t);e.state={status:"starting",ready:n};const r=await n;return e.state={status:"started",value:r},r}catch(t){throw e.state={status:"stopped"},t}case"starting":throw new L;case"started":throw new M;case"stopping":return await n.ready,await Lt.start(e,t);default:return Lt.panic(e)}}static async stop(e){const{state:t,deactivate:n}=e;switch(t.status){case"stopped":break;case"starting":try{await t.ready}catch(e){}return await Lt.stop(e);case"stopping":return await t.ready;case"started":n&&await n(t.value),e.state={status:"stopped"};break;default:Lt.panic(t)}}static try({state:e}){return"started"===e.status?e.value:null}static async use({state:e},t){switch(e.status){case"started":return e.value;case"starting":return await Ot(e.ready,t);default:throw new N}}static panic({state:e}){const t=JSON.stringify({status:e.status});throw RangeError(`Service in invalid state ${t}, should never happen if you see this please report a bug`)}constructor(e,t){this.activate=e,this.deactivate=t,this.state={status:"stopped"}}async use(e){return await Lt.use(this,e)}try(){return Lt.try(this)}}var Mt=n(40194);var Ct=n(84665),xt=n(93431);const Bt=new class{constructor(e){this.lru=Mt(e)}get(e){const t=this.lru.get(e);if(t)return t.expire&&t.expire<Date.now()?void this.lru.remove(e):t.value}set(e,t,n){this.lru.set(e,{value:t,expire:Date.now()+n})}has(e){return!!this.get(e)}remove(e){this.lru.remove(e)}clear(){this.lru.clear()}}(1e3),zt=6e4,Ut=new(Ct.A.default?Ct.A.default:Ct.A)({concurrency:4}),Ft=e=>{if(e.Path)return e.Path;throw new Error(e.Message)};function jt(){return St((async(e,t={recursive:!0})=>{if("string"!=typeof e)throw new Error("Invalid arguments, domain must be a string");return async function(e,t){return(async(e,t={})=>{const n=new URLSearchParams(t);n.set("arg",e);const s=n.toString();if(!t.nocache&&Bt.has(s)){const e=Bt.get(s);return Ft(e)}const r=await Ut.add((async()=>{const e=await xt.get("https://ipfs.io/api/v0/dns",{searchParams:n}),t=new URL(e.url).search.slice(1),s=await e.json();return Bt.set(t,s,zt),s}));return Ft(r)})(e,t)}(e=function(e){return e.endsWith(".eth")&&(e=e.replace(/.eth$/,".eth.link")),e}(e),t)}))}var Ht=n(17734);function $t({repo:e,codecs:t,bases:n,name:s}){return St((async function(r,o={}){if(!mt(r))throw new Error("invalid argument "+r);if(wt(r))for await(const e of s.resolve(r,o))r=e;const[,i,a,...c]=r.split("/"),l=o.cidBase?await n.getBase(o.cidBase):void 0,d=function(e){try{return(0,Ht.XL)(e).toBytes()}catch{return J.TO.parse(e).bytes}}(a);if(0===c.length){return`/${i}/${l?l.encoder.encode(d):a}`}const u=J.TO.decode(d);r=c.join("/");const h=Nt(u,r,t,e,o);let p=u,f=r;for await(const e of h)J.TO.asCID(e.value)&&(p=e.value,f=e.remainderPath);return`/ipfs/${p.toString(l&&l.encoder)}${f?"/"+f:""}`}))}var Vt=n(62808);var Kt=n(775);const qt={direct:"direct",recursive:"recursive",indirect:"indirect",all:"all"};function Gt(e,t,n){const s={type:e,cid:t};return n&&(s.metadata=n),s}class Wt{constructor({codecs:e,repo:t}){const n=function({repo:e,codecs:t}){return St((async function*(n,s={}){const r=async function*(){for await(const{path:s,recursive:r,metadata:o}of(0,Kt.n)(n)){const{cid:n}=await At(e,t,s),{reason:i}=await e.pins.isPinnedWithType(n,[qt.recursive,qt.direct]);if("recursive"===i&&!r)throw new Error(`${n} already pinned recursively`);r?await e.pins.pinRecursively(n,{metadata:o}):await e.pins.pinDirectly(n,{metadata:o}),yield n}};if(!Boolean(s.lock))return void(yield*r());const o=await e.gcLock.readLock();try{yield*r()}finally{o()}}))}({codecs:e,repo:t});this.addAll=n,this.add=function({addAll:e}){return(t,n={})=>{let s;const r=J.TO.asCID(t);return s=e(r?[{cid:r,...n}]:[{path:t.toString(),...n}],n),(0,Vt.A)(s)}}({addAll:n});const s=function({repo:e,codecs:t}){return St((async function*(n,s={}){const r=await e.gcLock.readLock();try{for await(const{path:s,recursive:r}of(0,Kt.n)(n)){const{cid:n}=await At(e,t,s),{pinned:o,reason:i}=await e.pins.isPinnedWithType(n,qt.all);if(!o)throw new Error(`${n} is not pinned`);switch(i){case qt.recursive:if(!r)throw new Error(`${n} is pinned recursively`);await e.pins.unpin(n),yield n;break;case qt.direct:await e.pins.unpin(n),yield n;break;default:throw new Error(`${n} is pinned indirectly under ${i}`)}}}finally{r()}}))}({codecs:e,repo:t});this.rmAll=s,this.rm=function({rmAll:e}){return async function(t,n={}){const s=await(0,Vt.A)(e([{path:t,...n}],n));if(!s)throw new Error("CID expected");return s}}({rmAll:s}),this.ls=function({repo:e,codecs:t}){return St((async function*(n={}){let s=qt.all;if(n.type&&(s=n.type,!Object.keys(qt).includes(s)))throw c(new Error("Invalid pin type"),"ERR_INVALID_PIN_TYPE");if(n.paths){let r=!1;for await(const{path:o}of(0,Kt.n)(n.paths)){const{cid:n}=await At(e,t,o),{reason:i,pinned:a,parent:l,metadata:d}=await e.pins.isPinnedWithType(n,s);if(!a)throw c(new Error(`path '${o}' is not pinned`),"ERR_NOT_PINNED");switch(i){case qt.direct:case qt.recursive:r=!0,yield Gt(i,n,d);break;default:r=!0,yield Gt(`${qt.indirect} through ${l}`,n,d)}}if(!r)throw new Error("No match found")}else{if(s===qt.recursive||s===qt.all)for await(const{cid:t,metadata:n}of e.pins.recursiveKeys())yield Gt(qt.recursive,t,n);if(s===qt.indirect||s===qt.all)for await(const t of e.pins.indirectKeys(n))yield Gt(qt.indirect,t);if(s===qt.direct||s===qt.all)for await(const{cid:t,metadata:n}of e.pins.directKeys())yield Gt(qt.direct,t,n)}}))}({codecs:e,repo:t}),this.remote={add:(e,t={})=>Promise.reject(new Error("Not implemented")),ls:async function*(e,t={}){return Promise.reject(new Error("Not implemented"))},rm:(e,t={})=>Promise.reject(new Error("Not implemented")),rmAll:(e,t={})=>Promise.reject(new Error("Not implemented")),service:{add:(e,t)=>Promise.reject(new Error("Not implemented")),rm:(e,t={})=>Promise.reject(new Error("Not implemented")),ls:(e={})=>Promise.reject(new Error("Not implemented"))}}}}var Yt=n(29296);function Xt(e){return e=e||new Error("Not Found"),c(e,"ERR_NOT_FOUND")}var Qt=n(5454),Jt=n(67643);const Zt="ERR_UNRECOGNIZED_VALIDITY",en="ERR_SIGNATURE_VERIFICATION",tn="ERR_UNDEFINED_PARAMETER";var nn=n(16237),sn=n(33158),rn=n(63449),on=n(60818),an=n(93610);an._configure(),nn._configure(sn),rn._configure(on);const cn=["uint64","int64","sint64","fixed64","sfixed64"];function ln(e){return function(e){for(const t of cn){if(null==e[t])continue;const n=e[t];e[t]=function(){return BigInt(n.call(this).toString())}}return e}(new nn(e))}function dn(){return function(e){for(const t of cn){if(null==e[t])continue;const n=e[t];e[t]=function(e){return n.call(this,e.toString())}}return e}(rn.create())}var un,hn;function pn(e,t,n,s){return{name:e,type:t,encode:n,decode:s}}!function(e){e[e.VARINT=0]="VARINT",e[e.BIT64=1]="BIT64",e[e.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",e[e.START_GROUP=3]="START_GROUP",e[e.END_GROUP=4]="END_GROUP",e[e.BIT32=5]="BIT32"}(un||(un={})),function(e){let t,n,s;!function(e){e.EOL="EOL"}(t=e.ValidityType||(e.ValidityType={})),function(e){e[e.EOL=0]="EOL"}(n||(n={})),function(e){e.codec=()=>function(e){function t(t){if(null==e[t.toString()])throw new Error("Invalid enum value");return e[t]}return pn("enum",un.VARINT,(function(e,n){const s=t(e);n.int32(s)}),(function(e){return t(e.int32())}))}(n)}(t=e.ValidityType||(e.ValidityType={})),e.codec=()=>(null==s&&(s=function(e,t){return pn("message",un.LENGTH_DELIMITED,e,t)}(((t,n,s={})=>{!1!==s.lengthDelimited&&n.fork(),null!=t.value&&(n.uint32(10),n.bytes(t.value)),null!=t.signature&&(n.uint32(18),n.bytes(t.signature)),null!=t.validityType&&(n.uint32(24),e.ValidityType.codec().encode(t.validityType,n)),null!=t.validity&&(n.uint32(34),n.bytes(t.validity)),null!=t.sequence&&(n.uint32(40),n.uint64(t.sequence)),null!=t.ttl&&(n.uint32(48),n.uint64(t.ttl)),null!=t.pubKey&&(n.uint32(58),n.bytes(t.pubKey)),null!=t.signatureV2&&(n.uint32(66),n.bytes(t.signatureV2)),null!=t.data&&(n.uint32(74),n.bytes(t.data)),!1!==s.lengthDelimited&&n.ldelim()}),((t,n)=>{const s={},r=null==n?t.len:t.pos+n;for(;t.pos<r;){const n=t.uint32();switch(n>>>3){case 1:s.value=t.bytes();break;case 2:s.signature=t.bytes();break;case 3:s.validityType=e.ValidityType.codec().decode(t);break;case 4:s.validity=t.bytes();break;case 5:s.sequence=t.uint64();break;case 6:s.ttl=t.uint64();break;case 7:s.pubKey=t.bytes();break;case 8:s.signatureV2=t.bytes();break;case 9:s.data=t.bytes();break;default:t.skipType(7&n)}}return s}))),s),e.encode=t=>function(e,t){const n=dn();return t.encode(e,n,{lengthDelimited:!1}),n.finish()}(t,e.codec()),e.decode=t=>function(e,t){const n=ln(e instanceof Uint8Array?e:e.subarray());return t.decode(n)}(t,e.codec())}(hn||(hn={}));var fn=n(16668);const yn=(0,a.vF)("ipns:utils"),gn=(0,x.s)("/ipns/");function mn(e){const t=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),n=String(e).trim().match(t);if(null==n)throw new Error("Invalid format");const s=parseInt(n[1],10),r=parseInt(n[2],10)-1,o=parseInt(n[3],10),i=parseInt(n[4],10),a=parseInt(n[5],10),c=parseInt(n[6],10),l=parseInt(n[7].slice(0,-6),10);return new Date(Date.UTC(s,r,o,i,a,c,l))}const wn=e=>{const t=(0,x.s)("ipns-signature:");return(0,ee.x)([t,e])},bn=e=>{const t=hn.decode(e);return null!=t.sequence&&(t.sequence=BigInt(t.sequence)),null!=t.ttl&&(t.ttl=BigInt(t.ttl)),{value:t.value??new Uint8Array(0),signature:t.signature??new Uint8Array(0),validityType:t.validityType??hn.ValidityType.EOL,validity:t.validity??new Uint8Array(0),sequence:t.sequence??0n,pubKey:t.pubKey,ttl:t.ttl??void 0,signatureV2:t.signatureV2,data:t.data}},_n=e=>(0,ee.x)([gn,e.toBytes()]),En=(0,a.vF)("ipns"),vn=I.identity.code,Sn="/ipns/",kn=Sn.length,Rn=async(e,t,n,s,r,o)=>{n=BigInt(n);const i=(0,x.s)(r.toString());if(null==e.privateKey)throw c(new Error("Missing private key"),"ERR_MISSING_PRIVATE_KEY");const a=await(0,Jt.unmarshalPrivateKey)(e.privateKey),l=await In(a,t,s,i),d=((e,t,n,s,r)=>{let o;if(n!==hn.ValidityType.EOL)throw c(new Error("Unknown validity type"),Zt);o=0;const i={Value:e,Validity:t,ValidityType:o,Sequence:s,TTL:r};return fn.lF(i)})(t,i,s,n,o),u=wn(d),h={value:t,signature:l,validityType:s,validity:i,sequence:n,ttl:o,signatureV2:await a.sign(u),data:d};if(null!=e.publicKey){const t=F.D4(e.toBytes());t.code===vn&&(0,ve.a)(e.publicKey,t.digest)||(h.pubKey=e.publicKey)}return En("ipns entry for %b created",t),h},Tn=e=>new bt.U(`/ipns/${(e=>U.base32upper.encode(e).slice(1))(e)}`),In=async(e,t,n,s)=>{try{const r=((e,t,n)=>{const s=(0,x.s)(t);return(0,ee.x)([e,n,s])})(t,n,s);return await e.sign(r)}catch(e){throw En.error("record signature creation failed",e),c(new Error("record signature creation failed"),"ERR_SIGNATURE_CREATION")}},Pn=(0,a.vF)("ipfs:ipns:publisher"),An=Xt().code,Dn=36e5;class On{constructor(e,t){this._routing=e,this._datastore=t}async publishWithEOL(e,t,n,s){const r=await this._updateOrCreateRecord(e,t,n,s);return this._putRecordToRouting(r,e,s)}publish(e,t,n){return this.publishWithEOL(e,t,Dn,n)}async _putRecordToRouting(e,t,n){if(!(0,Yt.Q)(t)){const e="peerId received is not valid";throw Pn.error(e),c(new Error(e),"ERR_INVALID_PEER_ID")}if(null==t.publicKey)throw c(new Error("Public key was missing"),"ERR_MISSING_PUBLIC_KEY");const s=_n(t);return await this._publishEntry(s,e,n),e}async _publishEntry(e,t,n){try{const s=await this._routing.put(e,t,n);return Pn(`ipns record for ${(0,$.d)(e,"base32")} was stored in the routing`),s}catch(t){const n=`ipns record for ${(0,$.d)(e,"base32")} could not be stored in the routing - ${t.stack}`;throw Pn.error(n),Pn.error(t),c(new Error(n),"ERR_PUTTING_TO_ROUTING")}}async _getPublished(e,t={}){if(!(0,Yt.Q)(e)){const e="peerId received is not valid";throw Pn.error(e),c(new Error(e),"ERR_INVALID_PEER_ID")}const n=!1!==t.checkRouting;try{const t=await this._datastore.get(Tn(e.toBytes()));return this._unmarshalData(t)}catch(t){if(t.code!==An){const t=`unexpected error getting the ipns record ${e.toString()} from datastore`;throw Pn.error(t),c(new Error(t),"ERR_UNEXPECTED_DATASTORE_RESPONSE")}if(!n)throw c(t,"ERR_NOT_FOUND_AND_CHECK_ROUTING_NOT_ENABLED");try{const t=_n(e),n=await this._routing.get(t);return this._unmarshalData(n)}catch(e){throw Pn.error(e),e}}}_unmarshalData(e){try{return bn(e)}catch(e){throw c(e,"ERR_INVALID_RECORD_DATA")}}async _updateOrCreateRecord(e,t,n,s){if(!(0,Yt.Q)(e)){const e="peerId received is not valid";throw Pn.error(e),c(new Error(e),"ERR_INVALID_PEER_ID")}const r={checkRouting:!0};let o;try{o=await this._getPublished(e,r)}catch(t){if(t.code!==An){const n=`unexpected error when determining the last published IPNS record for ${e.toString()} ${t.stack}`;throw Pn.error(n),c(new Error(n),"ERR_DETERMINING_PUBLISHED_RECORD")}}let i,a=0n;o&&void 0!==o.sequence&&(a=(0,ve.a)(o.value,t)?o.sequence:o.sequence+BigInt(1));try{i=await(async(e,t,n,s)=>{const r=new Qt(Date.now()+Number(s)),o=hn.ValidityType.EOL,[i,a]=s.toString().split("."),c=BigInt(i)*BigInt(1e5)+BigInt(a??"0");return await Rn(e,t,n,o,r,c)})(e,t,a,n)}catch(e){const n=`ipns record for ${t} could not be created`;throw Pn.error(e),c(new Error(n),"ERR_CREATING_IPNS_RECORD")}try{const n=(l=i,hn.encode(l));return await this._datastore.put(Tn(e.toBytes()),n,s),Pn(`ipns record for ${(0,$.d)(t,"base32")} was stored in the datastore`),n}catch(e){const n=`ipns record for ${t} could not be stored in the datastore`;throw Pn.error(n),c(new Error(n),"ERR_STORING_IN_DATASTORE")}var l}}On.defaultRecordLifetime=Dn;const Nn=(0,a.vF)("ipfs:ipns:republisher");class Ln{constructor(e,t,n,s,r={pass:""}){this._publisher=e,this._datastore=t,this._peerId=n,this._keychain=s,this._options=r,this._republishHandle=null}async start(){if(this._republishHandle)throw c(new Error("republisher is already running"),"ERR_REPUBLISH_ALREADY_RUNNING");const e={_task:null,_inflightTask:null,_timeoutId:null,runPeriodically:t=>{e._timeoutId=setTimeout((async()=>{e._timeoutId=null;try{e._inflightTask=e._task(),await e._inflightTask,e._task&&e.runPeriodically(t)}catch(e){Nn.error(e)}}),t())},cancel:async()=>{null!=e._timeoutId&&clearTimeout(e._timeoutId),e._task=null,await e._inflightTask}},{pass:t}=this._options;let n=!0;e._task=async()=>{const e=new B.TimeoutController(3e4);try{await this._republishEntries(this._peerId,t,{signal:e.signal})}finally{e.clear()}},e.runPeriodically((()=>n?(n=!1,this._options.initialBroadcastInterval||6e4):this._options.broadcastInterval||144e5)),this._republishHandle=e}async stop(){const e=this._republishHandle;if(!e)throw c(new Error("republisher is not running"),"ERR_REPUBLISH_NOT_RUNNING");this._republishHandle=null,await e.cancel()}async _republishEntries(e,t,n){try{await this._republishEntry(e,n)}catch(e){const t="cannot republish entry for the node's private key";return void Nn.error(t)}if(t)try{const e=await this._keychain.listKeys();for(const s of e){if("self"===s.name)continue;const e=await this._keychain.exportKey(s.name,t),r=await(0,Jt.importKey)(e,t),o=await(0,Ht.AX)(r.public.bytes,r.bytes);await this._republishEntry(o,n)}}catch(e){Nn.error(e)}}async _republishEntry(e,t){try{const n=await this._getPreviousValue(e);await this._publisher.publishWithEOL(e,n,864e5,t)}catch(e){if("ERR_NO_ENTRY_FOUND"===e.code)return;throw e}}async _getPreviousValue(e){if(!(0,Yt.Q)(e))throw c(new Error("invalid peer ID"),"ERR_INVALID_PEER_ID");try{const t=await this._datastore.get(Tn(e.toBytes()));if(!(t instanceof Uint8Array))throw c(new Error("found ipns record that we couldn't process"),"ERR_INVALID_IPNS_RECORD");try{return bn(t).value}catch(e){throw Nn.error(e),c(new Error("found ipns record that we couldn't convert to a value"),"ERR_INVALID_IPNS_RECORD")}}catch(t){if(t&&t.notFound)throw c(new Error(`no previous entry for record with id: ${e.toString()}`),"ERR_NO_ENTRY_FOUND");throw t}}}const Mn=(0,a.vF)("ipns:validator"),Cn=e=>{if(null==e.data)throw c(new Error("Record data is missing"),"ERR_INVALID_RECORD_DATA");const t=(e=>{const t=fn.D4(e);if(0!==t.ValidityType)throw c(new Error("Unknown validity type"),Zt);return t.ValidityType=hn.ValidityType.EOL,Number.isInteger(t.Sequence)&&(t.Sequence=BigInt(t.Sequence)),Number.isInteger(t.TTL)&&(t.TTL=BigInt(t.TTL)),t})(e.data);if(!(0,ve.a)(t.Value,e.value))throw c(new Error('Field "value" did not match between protobuf and CBOR'),en);if(!(0,ve.a)(t.Validity,e.validity))throw c(new Error('Field "validity" did not match between protobuf and CBOR'),en);if(t.ValidityType!==e.validityType)throw c(new Error('Field "validityType" did not match between protobuf and CBOR'),en);if(t.Sequence!==e.sequence)throw c(new Error('Field "sequence" did not match between protobuf and CBOR'),en);if(t.TTL!==e.ttl)throw c(new Error('Field "ttl" did not match between protobuf and CBOR'),en)},xn=async(e,t)=>{const n=(e=>(0,Ht.nu)(e.slice(gn.length)))(e),s=bn(t),r=await(async(e,t)=>{if(null==t||null==e){const e=new Error("one or more of the provided parameters are not defined");throw yn.error(e),c(e,tn)}let n;if(null!=t.pubKey){try{n=(0,Jt.unmarshalPublicKey)(t.pubKey)}catch(e){throw yn.error(e),e}if(!(await(0,Ht.AX)(t.pubKey)).equals(e))throw c(new Error("Embedded public key did not match PeerID"),"ERR_INVALID_EMBEDDED_KEY")}else null!=e.publicKey&&(n=(0,Jt.unmarshalPublicKey)(e.publicKey));if(null!=n)return n;throw c(new Error("no public key is available"),tn)})(n,s);await(async(e,t)=>{const{value:n,validityType:s,validity:r}=t;let o,i,a;if(null==t.signatureV2||null==t.data)throw c(new Error("missing data or signatureV2"),en);i=t.signatureV2,o=wn(t.data),Cn(t);try{a=await e.verify(o,i)}catch(e){a=!1}if(!a)throw Mn.error("record signature verification failed"),c(new Error("record signature verification failed"),en);if(null!=r&&s===hn.ValidityType.EOL){let e;try{e=mn((0,$.d)(r))}catch(e){throw Mn.error("unrecognized validity format (not an rfc3339 format)"),c(new Error("unrecognized validity format (not an rfc3339 format)"),"ERR_UNRECOGNIZED_FORMAT")}if(e.getTime()<Date.now())throw Mn.error("record has expired"),c(new Error("record has expired"),"ERR_IPNS_EXPIRED_RECORD")}else if(null!=s)throw Mn.error("unrecognized validity type"),c(new Error("unrecognized validity type"),Zt);Mn("ipns entry for %b is valid",n)})(r,s)},Bn=(0,a.vF)("ipfs:ipns:resolver"),zn=Xt().code;class Un{constructor(e){this._routing=e}async resolve(e,t={}){if("string"!=typeof e)throw c(new Error("invalid name"),"ERR_INVALID_NAME");const n=t.recursive&&"true"===t.recursive.toString(),s=e.split("/");if(3!==s.length||""!==s[0])throw c(new Error("invalid name"),"ERR_INVALID_NAME");const r=s[2];let o=1/0;n&&(o=32);const i=await this.resolver(r,o,t);return Bn(`${e} was locally resolved correctly`),i}async resolver(e,t,n){if(0===t){const e="could not resolve name (recursion limit of 32 exceeded)";throw Bn.error(e),c(new Error(e),"ERR_RESOLVE_RECURSION_LIMIT")}const s=await this._resolveName(e,n),r=s.split("/");return"ipfs"!==r[1]&&t?this.resolver(r[2],t-1,n):s}async _resolveName(e,t){const n=(0,Ht.XL)(e),s=_n(n);let r;try{r=await this._routing.get(s,t)}catch(t){if(Bn.error("could not get record from routing",t),t.code===zn)throw c(new Error(`record requested for ${e} was not found in the network`),"ERR_NO_RECORD_FOUND");throw c(new Error(`unexpected error getting the ipns record ${n.toString()}`),"ERR_UNEXPECTED_ERROR_GETTING_RECORD")}return this._validateRecord(n,r)}async _validateRecord(e,t){await xn((0,ee.x)([(0,x.s)("/ipns/"),e.toBytes()]),t);const n=bn(t);return(0,$.d)(n.value)}}class Fn{constructor(e){this.lru=Mt(e)}get(e){const t=this.lru.get(e);if(t)return t.expire&&t.expire<Date.now()?void this.lru.remove(e):t.value}set(e,t,n){this.lru.set(e,{value:t,expire:Date.now()+n})}has(e){return!!this.get(e)}remove(e){this.lru.remove(e)}clear(){this.lru.clear()}}const jn=(0,a.vF)("ipfs:ipns");class Hn{constructor(e,t,n,s,r){this.publisher=new On(e,t),this.republisher=new Ln(this.publisher,t,n,s,r),this.resolver=new Un(e),this.cache=new Fn(1e3),this.routing=e}async publish(e,t,n=On.defaultRecordLifetime,s){try{await this.publisher.publishWithEOL(e,t,n,s),jn(`IPNS value ${(0,$.d)(t,"base32")} was published correctly`);const r=e.toString(),o=parseFloat(n),i=o<6e4?o:6e4;return this.cache.set(r,t,i),jn(`IPNS value ${(0,$.d)(t,"base32")} was cached correctly`),{name:r,value:t}}catch(e){throw jn.error(e),e}}async resolve(e,t={}){if("string"!=typeof e)throw c(new Error("name received is not valid"),"ERR_INVALID_NAME");if(!t.nocache&&!t.recursive){const t=e.split("/")[2],n=this.cache.get(t);if(n)return n}try{const n=await this.resolver.resolve(e,t);return jn(`IPNS record from ${e} was resolved correctly`),n}catch(e){throw jn.error(e),e}}async initializeKeyspace(e,t,n){return this.publish(e,t,On.defaultRecordLifetime,n)}}async function $n(e){const t=[];for await(const n of e)t.push(n);return t}const Vn=(e,t)=>async function*(){const n=await $n(e);yield*n.sort(t)}();var Kn=n(8306),qn=n(40506),Gn=n(66213);class Wn{open(){return Promise.reject(new Error(".open is not implemented"))}close(){return Promise.reject(new Error(".close is not implemented"))}put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(const{key:n,value:s}of e)await this.put(n,s,t),yield{key:n,value:s}}async*getMany(e,t={}){for await(const n of e)yield this.get(n,t)}async*deleteMany(e,t={}){for await(const n of e)await this.delete(n,t),yield n}batch(){let e=[],t=[];return{put(t,n){e.push({key:t,value:n})},delete(e){t.push(e)},commit:async n=>{await(0,Kn.A)(this.putMany(e,n)),e=[],await(0,Kn.A)(this.deleteMany(t,n)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let n=this._all(e,t);if(null!=e.prefix&&(n=(0,qn.A)(n,(t=>t.key.toString().startsWith(e.prefix)))),Array.isArray(e.filters)&&(n=e.filters.reduce(((e,t)=>(0,qn.A)(e,t)),n)),Array.isArray(e.orders)&&(n=e.orders.reduce(((e,t)=>Vn(e,t)),n)),null!=e.offset){let t=0;n=(0,qn.A)(n,(()=>t++>=e.offset))}return null!=e.limit&&(n=(0,Gn.A)(n,e.limit)),n}queryKeys(e,t){let n=this._allKeys(e,t);if(null!=e.prefix&&(n=(0,qn.A)(n,(t=>t.toString().startsWith(e.prefix)))),Array.isArray(e.filters)&&(n=e.filters.reduce(((e,t)=>(0,qn.A)(e,t)),n)),Array.isArray(e.orders)&&(n=e.orders.reduce(((e,t)=>Vn(e,t)),n)),null!=e.offset){let t=0;n=(0,qn.A)(n,(()=>t++>=e.offset))}return null!=e.limit&&(n=(0,Gn.A)(n,e.limit)),n}}var Yn=n(48651);const Xn=(0,a.vF)("datastore:core:tiered");class Qn extends Wn{constructor(e){super(),this.stores=e.slice()}async open(){try{await Promise.all(this.stores.map((e=>e.open())))}catch(e){throw function(e){return e=e||new Error("Cannot open database"),c(e,"ERR_DB_OPEN_FAILED")}(e)}}async put(e,t,n){try{await Promise.all(this.stores.map((s=>s.put(e,t,n))))}catch(e){throw function(e){return e=e||new Error("Write failed"),c(e,"ERR_DB_WRITE_FAILED")}(e)}}async get(e,t){for(const n of this.stores)try{const s=await n.get(e,t);if(s)return s}catch(e){Xn.error(e)}throw Xt()}async has(e,t){for(const n of this.stores)if(await n.has(e,t))return!0;return!1}async delete(e,t){try{await Promise.all(this.stores.map((n=>n.delete(e,t))))}catch(e){throw function(e){return e=e||new Error("Delete failed"),c(e,"ERR_DB_DELETE_FAILED")}(e)}}async*putMany(e,t={}){let n;const s=this.stores.map((e=>{const s=(0,Yn.N)({objectMode:!0});return(0,Kn.A)(e.putMany(s,t)).catch((e=>{n=e})),s}));try{for await(const t of e){if(n)throw n;s.forEach((e=>e.push(t))),yield t}}finally{s.forEach((e=>e.end()))}}async*deleteMany(e,t={}){let n;const s=this.stores.map((e=>{const s=(0,Yn.N)({objectMode:!0});return(0,Kn.A)(e.deleteMany(s,t)).catch((e=>{n=e})),s}));try{for await(const t of e){if(n)throw n;s.forEach((e=>e.push(t))),yield t}}finally{s.forEach((e=>e.end()))}}async close(){await Promise.all(this.stores.map((e=>e.close())))}batch(){const e=this.stores.map((e=>e.batch()));return{put:(t,n)=>{e.forEach((e=>e.put(t,n)))},delete:t=>{e.forEach((e=>e.delete(t)))},commit:async t=>{for(const n of e)await n.commit(t)}}}query(e,t){return this.stores[this.stores.length-1].query(e,t)}queryKeys(e,t){return this.stores[this.stores.length-1].queryKeys(e,t)}}var Jn=n(32144);const Zn=(e,t)=>{const n=t.map(((e,t)=>({entry:hn.decode(e),index:t})));return n.sort(((e,t)=>{if(null!=e.entry.signatureV2&&null==t.entry.signatureV2)return-1;if(null==e.entry.signatureV2&&null!=t.entry.signatureV2)return 1;const n=e.entry.sequence??0n,s=t.entry.sequence??0n;if(n>s)return-1;if(n<s)return 1;const r=e.entry.validity??new Uint8Array(0),o=t.entry.validity??new Uint8Array(0),i=mn((0,$.d)(r)),a=mn((0,$.d)(o));return i.getTime()>a.getTime()?-1:i.getTime()<a.getTime()?1:0})),n[0].index};var es=n(81070);const ts=(0,a.vF)("ipfs:ipns:pubsub");class ns{constructor(e,t,n){this._subscriptions={},this._handleSubscriptionKey=this._handleSubscriptionKey.bind(this),this._pubsubDs=new es.D(e,t,n,xn,Zn,this._handleSubscriptionKey)}async put(e,t,n){try{await this._pubsubDs.put(e,t,n)}catch(e){throw ts.error(e),e}}async get(e,t){let n,s;try{n=await this._pubsubDs.get(e,t)}catch(e){s=e}const r=e.slice(0,kn);if((0,$.d)(r)===Sn){const t=z.base58btc.encode(e).substring(1),n=z.base58btc.encode(e.slice(kn)).substring(1);this._subscriptions[t]=n,ts(`subscribed to pubsub topic ${t}, id ${n}`)}if(s)throw s;return n}_handleSubscriptionKey(e){e instanceof Uint8Array&&(e=(0,$.d)(e,"base58btc"));const t=this._subscriptions[e];if(!t)throw c(new Error(`key ${e} does not correspond to a subscription`),"ERR_INVALID_KEY");try{return _n((0,Ht.XL)(t))}catch(e){throw ts.error(e),e}}getSubscriptions(){return Object.values(this._subscriptions).filter(Boolean).map((e=>`${Sn}${e}`))}async cancel(e){if("string"!=typeof e)throw c(new Error("invalid subscription name"),"ERR_INVALID_SUBSCRIPTION_NAME");e.startsWith(Sn)&&(e=e.substring(kn));const t=Object.keys(this._subscriptions).find((t=>this._subscriptions[t]===e));if(!t)return{canceled:!1};const n=(0,x.s)(t);return this._pubsubDs.unsubscribe(n),delete this._subscriptions[t],ts(`unsubscribed pubsub ${t}: ${e}`),{canceled:!0}}}var ss=n(2057);const rs=(0,a.vF)("ipfs:ipns:offline-datastore");class os{constructor(e){this._datastore=e,this.stores=[]}async put(e,t,n){if(!(e instanceof Uint8Array))throw c(new Error("Offline datastore key must be a Uint8Array"),"ERR_INVALID_KEY");if(!(t instanceof Uint8Array))throw c(new Error("Offline datastore value must be a Uint8Array"),"ERR_INVALID_VALUE");let s;try{s=this._routingKey(e)}catch(e){throw rs.error(e),c(new Error("Not possible to generate the routing key"),"ERR_GENERATING_ROUTING_KEY")}const r=new ss.L(e,t,new Date);await this._datastore.put(s,r.serialize(),n)}async get(e,t){if(!(e instanceof Uint8Array))throw c(new Error("Offline datastore key must be a Uint8Array"),"ERR_INVALID_KEY");let n;try{n=this._routingKey(e)}catch(e){throw rs.error(e),c(new Error("Not possible to generate the routing key"),"ERR_GENERATING_ROUTING_KEY")}const s=await this._datastore.get(n,t);let r;try{r=ss.L.deserialize(s)}catch(e){throw rs.error(e),e}return r.value}_routingKey(e){return new bt.U("/dht/record/"+(0,$.d)(e,"base32"),!1)}}const is=(0,a.vF)("ipfs:ipns:dht-datastore");class as{constructor(e){this._dht=e}async put(e,t,n){try{await(0,Kn.A)(this._dht.put(e,t,n))}catch(e){throw is.error(e),e}}async get(e,t){for await(const n of this._dht.get(e,t))if("VALUE"===n.name)return n.value;throw Xt()}}const cs=(0,a.vF)("ipfs:components:ipns");class ls{constructor(e={pass:""}){this.options=e,this.offline=null,this.online=null}getIPNS(){const e=this.online||this.offline;if(e)return e;throw new A}get routing(){return this.getIPNS().routing}startOffline({repo:e,peerId:t,keychain:n}){if(null!=this.offline)throw new O;cs("initializing IPNS keyspace (offline)");const s=new os(e.datastore),r=new Hn(s,e.datastore,t,n,this.options);this.offline=r}async startOnline({libp2p:e,repo:t,peerId:n,keychain:s}){if(null!=this.online)throw new O;const r=function({libp2p:e,repo:t,peerId:n,options:s}){const r=[];let o;if(Jn(s,"EXPERIMENTAL.ipnsPubsub",!1)&&(o=new ns(e.pubsub,t.datastore,n),r.push(o)),!0!==Jn(s,"offline",!1)&&["dht","dhtclient","dhtserver"].includes(Jn(s,"config.Routing.Type","none"))&&r.push(new as(e.dht)),Jn(s,"offline",!1)||0===r.length){const e=new os(t.datastore);r.push(e)}return new Qn(r)}({libp2p:e,repo:t,peerId:n,options:this.options}),o=new Hn(r,t.datastore,n,s,this.options);await o.republisher.start(),this.online=o}async stop(){const e=this.online;e&&(await e.republisher.stop(),this.online=null)}publish(e,t,n,s){return this.getIPNS().publish(e,t,n,s)}resolve(e,t){return this.getIPNS().resolve(e,t)}initializeKeyspace(e,t,n){return this.getIPNS().initializeKeyspace(e,t,n)}}async function ds({ipns:e,repo:t,codecs:n},s,r){if(wt(s))return e.resolve(s);const{cid:o,path:i}=Rt(s);await(0,Kn.A)(Nt(o,i||"",n,t,r))}const us=(0,a.vF)("ipfs:name:publish");function hs({ipns:e,repo:t,codecs:n,peerId:s,isOnline:r,keychain:o}){const i=async e=>{let t;if("self"===e&&null!=s.privateKey)t=await(0,Jt.unmarshalPrivateKey)(s.privateKey);else try{const n=await o.exportKey(e,"temp");t=await(0,Jt.importKey)(n,"temp")}catch(e){throw us.error(e),c(e,"ERR_CANNOT_GET_KEY")}return(0,Ht.AX)(t.public.bytes,t.bytes)};return St((async function(s,o={}){const a=!(!1===o.resolve),l=o.lifetime||"24h",d=o.key||"self";if(!r())throw c(new Error(Tt),"OFFLINE_ERROR");try{s=(e=>{if(J.TO.asCID(e))return`/ipfs/${e}`;const t=e.toString();try{return`/ipfs/${J.TO.parse(t)}`}catch{}if(mt(t))return t;throw c(new Error(`invalid path: ${e}`),"ERR_BAD_PATH")})(s)}catch(e){throw us.error(e),e}let u=0;try{u=(0,Et.A)(l)||0,u=parseFloat(u.toFixed(6))}catch(e){throw us.error(e),e}const h=await Promise.all([i(d),a?ds({ipns:e,repo:t,codecs:n},s):Promise.resolve()]),p=(0,x.s)(s),f=await e.publish(h[0],p,u,o);return{name:f.name,value:(0,$.d)(f.value)}}))}var ps=n(51495),fs=n(83192);const ys=o.A.bind({ignoreUndefined:!0}),gs=(0,a.vF)("ipfs:name:resolve"),ms=(e,t)=>t.length>0?e+"/"+t.join("/"):e;function ws(e,t){if(!e||!t||!t.ipnsPubsub)throw c(new Error("IPNS pubsub subsystem is not enabled"),"ERR_IPNS_PUBSUB_NOT_ENABLED");if(e.routing instanceof ns)return e.routing;const n=(e.routing.stores||[]).find((e=>e instanceof ns));if(!n)throw c(new Error("IPNS pubsub datastore not found"),"ERR_PUBSUB_DATASTORE_NOT_FOUND");return n}class bs{constructor({ipns:e,options:t}){this.cancel=function({ipns:e,options:t}){const n=t.EXPERIMENTAL;return St((async function(t,s={}){return ws(e,n).cancel(t,s)}))}({ipns:e,options:t}),this.state=function({ipns:e,options:t}){const n=t.EXPERIMENTAL;return St((async function(t={}){try{return{enabled:Boolean(ws(e,n))}}catch(e){return{enabled:!1}}}))}({ipns:e,options:t}),this.subs=function({ipns:e,options:t}){const n=t.EXPERIMENTAL;return St((async function(t={}){return ws(e,n).getSubscriptions(t)}))}({ipns:e,options:t})}}class _s{constructor({dns:e,ipns:t,repo:n,codecs:s,peerId:r,isOnline:o,keychain:i,options:a}){this.publish=hs({ipns:t,repo:n,codecs:s,peerId:r,isOnline:o,keychain:i}),this.resolve=function({dns:e,ipns:t,isOnline:n,options:{offline:s}}){return St((async function*(r,o={}){if(o=ys({nocache:!1,recursive:!0},o),s&&o&&o.nocache)throw c(new Error("cannot specify both offline and nocache"),"ERR_NOCACHE_AND_OFFLINE");if(!n()&&!s)throw c(new Error(Tt),"OFFLINE_ERROR");let i=r.toString();i.startsWith("/ipns/")||(i=`/ipns/${i}`);let[a,l,...d]=i.slice(1).split("/");try{if("1"===l.substring(0,1)){const e=(0,Ht.XL)(l),t=F.D4(e.toBytes());l=J.TO.createV1(114,t).toString(ps.base36)}else{const e=J.TO.parse(l);1===e.version&&(l=e.toString(ps.base36))}}catch(t){if(fs(l))return void(yield ms(await e(l,o),d));throw gs.error(t),c(new Error("Invalid IPNS name"),"ERR_IPNS_INVALID_NAME")}const u=await t.resolve(`/${a}/${l}`,o);yield ms(u instanceof Uint8Array?(0,$.d)(u):u,d)}))}({dns:e,ipns:t,isOnline:o,options:a}),this.pubsub=new bs({ipns:t,options:a})}}const Es=Xt().code,vs={default:"<dst>",edges:"<src> -> <dst>"};function Ss({repo:e,codecs:t,resolve:n,preload:s}){return async function*(r,o={}){if(0===o.maxDepth)return;if(o.edges&&o.format&&o.format!==vs.default)throw new Error("Cannot set edges to true and also specify format");if(o.format=o.edges?vs.edges:o.format,"number"!=typeof o.maxDepth&&(o.maxDepth=o.recursive?1/0:1),o.timeout){const e=[new B.TimeoutController(o.timeout).signal];o.signal&&e.push(o.signal),o.signal=(0,_t.anySignal)(e)}const i=(Array.isArray(r)?r:[r]).map((e=>function(e,t,n){const{cid:s,path:r}=Rt(t);!1!==n.preload&&e(s);return`/ipfs/${s}${r||""}`}(s,e,o)));for(const s of i)try{yield*ks(n,e,t,s,o)}catch(e){yield{ref:"",err:e.message}}}}async function*ks(e,t,n,s,r){const o=await e(s,r),{cid:i}=Rt(o),a=null!=r.maxDepth?r.maxDepth:1/0,c=r.unique||!1;for await(const e of async function*(e,t,n,s,r,o){const i=new Set;async function*a(n,c){const l=c+1;if(!(l>s))try{for await(const s of async function*(e,t,n,s){const r=await e.blocks.get(n,s),o=await t.getCodec(n.code),i=o.decode(r),a=n.code===S.code,c=[];for(const[e,t]of Ts(i,c)){if(a){const n=e.match(/^Links\/(\d+)\/Hash$/);if(n){const e=Number(n[1]);if(e<i.Links.length){yield{name:i.Links[e].Name,cid:t};continue}}}yield{name:e,cid:t}}}(e,t,n.cid,o))yield{parent:n,node:s,isDuplicate:r&&i.has(s.cid.toString())},r&&i.add(s.cid.toString()),yield*a(s,l)}catch(e){throw e.code===Es&&(e.message=`Could not find object with CID: ${n.cid}`),e}}yield*a({cid:n},0)}(t,n,i,a,c,r))e.parent&&(e.isDuplicate||(yield{ref:Rs(e.parent.cid,e.node.cid,e.node.name,r.format)}))}function Rs(e,t,n="",s=vs.default){let r=s.replace(/<src>/g,e.toString());return r=r.replace(/<dst>/g,t.toString()),r=r.replace(/<linkname>/g,n),r}const Ts=function*(e,t){if(null!=e&&!(e instanceof Uint8Array)){for(const[n,s]of Object.entries(e)){const e=[...t,n];if(null!=s&&"object"==typeof s)if(Array.isArray(s))for(const[t,n]of s.entries()){const s=[...e,t],r=J.TO.asCID(n);r?yield[s.join("/"),r]:"object"==typeof n&&(yield*Ts(n,s))}else{const t=J.TO.asCID(s);t?yield[e.join("/"),t]:yield*Ts(s,e)}}return[]}};function Is({repo:e}){return St((async function*(t={}){for await(const n of e.blocks.queryKeys({},{signal:t.signal}))yield{ref:n.toString()}}))}function Ps({network:e}){return St((async function(t={}){const n=(await e.use(t)).bitswap,s=n.stat().snapshot;return{provideBufLen:parseInt(s.providesBufferLength.toString()),blocksReceived:BigInt(s.blocksReceived.toString()),wantlist:Array.from(n.getWantlist()).map((e=>e[1].cid)),peers:n.peers(),dupBlksReceived:BigInt(s.dupBlksReceived.toString()),dupDataReceived:BigInt(s.dupDataReceived.toString()),dataReceived:BigInt(s.dataReceived.toString()),blocksSent:BigInt(s.blocksSent.toString()),dataSent:BigInt(s.dataSent.toString())}}))}class As{constructor({network:e}){this.wantlist=function({network:e}){return St((async function(t={}){const{bitswap:n}=await e.use(t),s=n.getWantlist();return Array.from(s).map((e=>e[1].cid))}))}({network:e}),this.wantlistForPeer=function({network:e}){return St((async function(t,n={}){const{bitswap:s}=await e.use(n),r=s.wantlistForPeer(t);return Array.from(r).map((e=>e[1].cid))}))}({network:e}),this.unwant=function({network:e}){return St((async function(t,n={}){const{bitswap:s}=await e.use(n);return Array.isArray(t)||(t=[t]),s.unwant(t)}))}({network:e}),this.stat=Ps({network:e})}}const Ds=H.wM,Os=H.w7,Ns=function(e){let t=0;if(e=e.toString().trim(),Ds(e)){const n=new Uint8Array(t+4);return e.split(/\./g).forEach((e=>{n[t++]=255&parseInt(e,10)})),n}if(Os(e)){const n=e.split(":",8);let s;for(s=0;s<n.length;s++){let e;Ds(n[s])&&(e=Ns(n[s]),n[s]=(0,$.d)(e.slice(0,2),"base16")),null!=e&&++s<8&&n.splice(s,0,(0,$.d)(e.slice(2,4),"base16"))}if(""===n[0])for(;n.length<8;)n.unshift("0");else if(""===n[n.length-1])for(;n.length<8;)n.push("0");else if(n.length<8){for(s=0;s<n.length&&""!==n[s];s++);const e=[s,1];for(s=9-n.length;s>0;s--)e.push("0");n.splice.apply(n,e)}const r=new Uint8Array(t+16);for(s=0;s<n.length;s++){const e=parseInt(n[s],16);r[t++]=e>>8&255,r[t++]=255&e}return r}throw new Error("invalid ip address")},Ls=function(e,t=0,n){t=~~t,n=n??e.length-t;const s=new DataView(e.buffer);if(4===n){const s=[];for(let r=0;r<n;r++)s.push(e[t+r]);return s.join(".")}if(16===n){const e=[];for(let r=0;r<n;r+=2)e.push(s.getUint16(t+r).toString(16));return e.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""},Ms=-1,Cs={},xs={};function Bs(e){if("number"==typeof e){if(null!=xs[e])return xs[e];throw new Error(`no protocol with code: ${e}`)}if("string"==typeof e){if(null!=Cs[e])return Cs[e];throw new Error(`no protocol with name: ${e}`)}throw new Error("invalid protocol id type: "+typeof e)}[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,Ms,"ip6zone"],[43,8,"ipcidr"],[53,Ms,"dns",!0],[54,Ms,"dns4",!0],[55,Ms,"dns6",!0],[56,Ms,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,Ms,"unix",!1,!0],[421,Ms,"ipfs"],[421,Ms,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,Ms,"garlic64"],[448,0,"tls"],[449,Ms,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,Ms,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[777,Ms,"memory"]].forEach((e=>{const t=function(e,t,n,s,r){return{code:e,size:t,name:n,resolvable:Boolean(s),path:Boolean(r)}}(...e);xs[t.code]=t,Cs[t.name]=t}));var zs=n(98343);Bs("ip4"),Bs("ip6"),Bs("ipcidr");function Us(e,t){switch(Bs(e).code){case 4:case 41:return function(e){const t=Ls(e,0,e.length);if(null==t)throw new Error("ipBuff is required");if(!H.ei(t))throw new Error("invalid ip address");return t}(t);case 42:case 53:case 54:case 55:case 56:case 400:case 449:case 777:return Gs(t);case 6:case 273:case 33:case 132:return Ks(t).toString();case 421:return function(e){const t=zs.decode(e),n=e.slice(zs.decode.bytes);if(n.length!==t)throw new Error("inconsistent lengths");return(0,$.d)(n,"base58btc")}(t);case 444:case 445:return Ws(t);case 466:return function(e){const t=zs.decode(e),n=e.slice(zs.decode.bytes);if(n.length!==t)throw new Error("inconsistent lengths");return"u"+(0,$.d)(n,"base64url")}(t);default:return(0,$.d)(t,"base16")}}function Fs(e,t){switch(Bs(e).code){case 4:case 41:return $s(t);case 42:case 53:case 54:case 55:case 56:case 400:case 449:case 777:return qs(t);case 6:case 273:case 33:case 132:return Vs(parseInt(t,10));case 421:return function(e){let t;t="Q"===e[0]||"1"===e[0]?F.D4(z.base58btc.decode(`z${e}`)).bytes:J.TO.parse(e).multihash.bytes;const n=Uint8Array.from(zs.encode(t.length));return(0,ee.x)([n,t],n.length+t.length)}(t);case 444:return function(e){const t=e.split(":");if(2!==t.length)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(16!==t[0].length)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion address.`);const n=U.base32.decode("b"+t[0]),s=parseInt(t[1],10);if(s<1||s>65536)throw new Error("Port number is not in range(1, 65536)");const r=Vs(s);return(0,ee.x)([n,r],n.length+r.length)}(t);case 445:return function(e){const t=e.split(":");if(2!==t.length)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(56!==t[0].length)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion3 address.`);const n=U.base32.decode(`b${t[0]}`),s=parseInt(t[1],10);if(s<1||s>65536)throw new Error("Port number is not in range(1, 65536)");const r=Vs(s);return(0,ee.x)([n,r],n.length+r.length)}(t);case 466:return function(e){const t=Hs.decode(e),n=Uint8Array.from(zs.encode(t.length));return(0,ee.x)([n,t],n.length+t.length)}(t);default:return(0,x.s)(t,"base16")}}const js=Object.values(P.Fo).map((e=>e.decoder)),Hs=function(){let e=js[0].or(js[1]);return js.slice(2).forEach((t=>e=e.or(t))),e}();function $s(e){if(!H.ei(e))throw new Error("invalid ip address");return Ns(e)}function Vs(e){const t=new ArrayBuffer(2);return new DataView(t).setUint16(0,e),new Uint8Array(t)}function Ks(e){return new DataView(e.buffer).getUint16(e.byteOffset)}function qs(e){const t=(0,x.s)(e),n=Uint8Array.from(zs.encode(t.length));return(0,ee.x)([n,t],n.length+t.length)}function Gs(e){const t=zs.decode(e);if((e=e.slice(zs.decode.bytes)).length!==t)throw new Error("inconsistent lengths");return(0,$.d)(e)}function Ws(e){const t=e.slice(0,e.length-2),n=e.slice(e.length-2);return`${(0,$.d)(t,"base32")}:${Ks(n)}`}function Ys(e){return e.map((e=>{const t=or(e);return null!=e[1]?[t.code,Us(t.code,e[1])]:[t.code]}))}function Xs(e){return tr((0,ee.x)(e.map((e=>{const t=or(e);let n=Uint8Array.from(zs.encode(t.code));return e.length>1&&null!=e[1]&&(n=(0,ee.x)([n,e[1]])),n}))))}function Qs(e,t){if(e.size>0)return e.size/8;if(0===e.size)return 0;return zs.decode(t)+(zs.decode.bytes??0)}function Js(e){const t=[];let n=0;for(;n<e.length;){const s=zs.decode(e,n),r=zs.decode.bytes??0,o=Qs(Bs(s),e.slice(n+r));if(0===o){t.push([s]),n+=r;continue}const i=e.slice(n+r,n+r+o);if(n+=o+r,n>e.length)throw rr("Invalid address Uint8Array: "+(0,$.d)(e,"base16"));t.push([s,i])}return t}function Zs(e){return function(e){const t=[];return e.map((e=>{const n=or(e);return t.push(n.name),e.length>1&&null!=e[1]&&t.push(e[1]),null})),sr(t.join("/"))}(Ys(Js(e)))}function er(e){const t=function(e){const t=[],n=e.split("/").slice(1);if(1===n.length&&""===n[0])return[];for(let s=0;s<n.length;s++){const r=n[s],o=Bs(r);if(0!==o.size){if(s++,s>=n.length)throw rr("invalid address: "+e);if(!0===o.path){t.push([r,sr(n.slice(s).join("/"))]);break}t.push([r,n[s]])}else t.push([r])}return t}(e=sr(e));return Xs(t.map((e=>{Array.isArray(e)||(e=[e]);const t=or(e);return e.length>1?[t.code,Fs(t.code,e[1])]:[t.code]})))}function tr(e){const t=nr(e);if(null!=t)throw t;return Uint8Array.from(e)}function nr(e){try{Js(e)}catch(e){return e}}function sr(e){return"/"+e.trim().split("/").filter((e=>e)).join("/")}function rr(e){return new Error("Error parsing address: "+e)}function or(e){return Bs(e[0])}var ir,ar,cr,lr,dr=function(e,t,n,s){if("a"===n&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?s:"a"===n?s.call(e):s?s.value:t.get(e)},ur=function(e,t,n,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(e,n):r?r.value=n:t.set(e,n),n};const hr=Symbol.for("nodejs.util.inspect.custom"),pr=[Bs("dns").code,Bs("dns4").code,Bs("dns6").code,Bs("dnsaddr").code],fr=new Map,yr=Symbol.for("@multiformats/js-multiaddr/multiaddr");function gr(e){return Boolean(e?.[yr])}class mr{constructor(e){if(ir.set(this,void 0),ar.set(this,void 0),cr.set(this,void 0),this[lr]=!0,null==e&&(e=""),e instanceof Uint8Array)this.bytes=tr(e);else if("string"==typeof e){if(e.length>0&&"/"!==e.charAt(0))throw new Error(`multiaddr "${e}" must start with a "/"`);this.bytes=er(e)}else{if(!gr(e))throw new Error("addr must be a string, Buffer, or another Multiaddr");this.bytes=tr(e.bytes)}}toString(){return null==dr(this,ir,"f")&&ur(this,ir,Zs(this.bytes),"f"),dr(this,ir,"f")}toJSON(){return this.toString()}toOptions(){let e,t,n,s,r="";const o=Bs("tcp"),i=Bs("udp"),a=Bs("ip4"),c=Bs("ip6"),l=Bs("dns6"),d=Bs("ip6zone");for(const[u,h]of this.stringTuples())u===d.code&&(r=`%${h??""}`),pr.includes(u)&&(t=o.name,s=443,n=`${h??""}${r}`,e=u===l.code?6:4),u!==o.code&&u!==i.code||(t=Bs(u).name,s=parseInt(h??"")),u!==a.code&&u!==c.code||(t=Bs(u).name,n=`${h??""}${r}`,e=u===c.code?6:4);if(null==e||null==t||null==n||null==s)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:s}}protos(){return this.protoCodes().map((e=>Object.assign({},Bs(e))))}protoCodes(){const e=[],t=this.bytes;let n=0;for(;n<t.length;){const s=zs.decode(t,n),r=zs.decode.bytes??0;n+=Qs(Bs(s),t.slice(n+r))+r,e.push(s)}return e}protoNames(){return this.protos().map((e=>e.name))}tuples(){return null==dr(this,ar,"f")&&ur(this,ar,Js(this.bytes),"f"),dr(this,ar,"f")}stringTuples(){return null==dr(this,cr,"f")&&ur(this,cr,Ys(this.tuples()),"f"),dr(this,cr,"f")}encapsulate(e){return e=new mr(e),new mr(this.toString()+e.toString())}decapsulate(e){const t=e.toString(),n=this.toString(),s=n.lastIndexOf(t);if(s<0)throw new Error(`Address ${this.toString()} does not contain subaddress: ${e.toString()}`);return new mr(n.slice(0,s))}decapsulateCode(e){const t=this.tuples();for(let n=t.length-1;n>=0;n--)if(t[n][0]===e)return new mr(Xs(t.slice(0,n)));return this}getPeerId(){try{const e=this.stringTuples().filter((e=>e[0]===Cs.ipfs.code)),t=e.pop();if(null!=t?.[1]){const e=t[1];return"Q"===e[0]||"1"===e[0]?(0,$.d)(z.base58btc.decode(`z${e}`),"base58btc"):(0,$.d)(J.TO.parse(e).multihash.bytes,"base58btc")}return null}catch(e){return null}}getPath(){let e=null;try{e=this.stringTuples().filter((e=>!0===Bs(e[0]).path))[0][1],null==e&&(e=null)}catch{e=null}return e}equals(e){return(0,ve.a)(this.bytes,e.bytes)}async resolve(e){const t=this.protos().find((e=>e.resolvable));if(null==t)return[this];const n=fr.get(t.name);if(null==n)throw c(new Error(`no available resolver for ${t.name}`),"ERR_NO_AVAILABLE_RESOLVER");return(await n(this,e)).map((e=>new mr(e)))}nodeAddress(){const e=this.toOptions();if("tcp"!==e.transport&&"udp"!==e.transport)throw new Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(e){const t=(e??this).protos();return 2===t.length&&((4===t[0].code||41===t[0].code)&&(6===t[1].code||273===t[1].code))}[(ir=new WeakMap,ar=new WeakMap,cr=new WeakMap,lr=yr,hr)](){return`Multiaddr(${Zs(this.bytes)})`}}function wr(e){return new mr(e)}const br=Kr("dns4"),_r=Kr("dns6"),Er=Kr("dnsaddr"),vr=Vr(Kr("dns"),Er,br,_r),Sr=Vr(Kr("ip4"),Kr("ip6")),kr=Vr($r(Sr,Kr("tcp")),$r(vr,Kr("tcp"))),Rr=$r(Sr,Kr("udp")),Tr=$r(Rr,Kr("utp")),Ir=$r(Rr,Kr("quic")),Pr=Vr($r(kr,Kr("ws")),$r(vr,Kr("ws"))),Ar=Vr($r(kr,Kr("wss")),$r(vr,Kr("wss")),$r(kr,Kr("tls"),Kr("ws")),$r(vr,Kr("tls"),Kr("ws"))),Dr=Vr($r(kr,Kr("http")),$r(Sr,Kr("http")),$r(vr,Kr("http"))),Or=Vr($r(kr,Kr("https")),$r(Sr,Kr("https")),$r(vr,Kr("https"))),Nr=$r(Rr,Kr("webrtc"),Kr("certhash")),Lr=Vr($r(Nr,Kr("p2p")),Nr),Mr=Vr($r(Pr,Kr("p2p-webrtc-star"),Kr("p2p")),$r(Ar,Kr("p2p-webrtc-star"),Kr("p2p")),$r(Pr,Kr("p2p-webrtc-star")),$r(Ar,Kr("p2p-webrtc-star"))),Cr=(Vr($r(Pr,Kr("p2p-websocket-star"),Kr("p2p")),$r(Ar,Kr("p2p-websocket-star"),Kr("p2p")),$r(Pr,Kr("p2p-websocket-star")),$r(Ar,Kr("p2p-websocket-star"))),Vr($r(Dr,Kr("p2p-webrtc-direct"),Kr("p2p")),$r(Or,Kr("p2p-webrtc-direct"),Kr("p2p")),$r(Dr,Kr("p2p-webrtc-direct")),$r(Or,Kr("p2p-webrtc-direct")))),xr=Vr(Pr,Ar,Dr,Or,Mr,Cr,kr,Tr,Ir,vr,Lr),Br=(Vr($r(xr,Kr("p2p-stardust"),Kr("p2p")),$r(xr,Kr("p2p-stardust"))),Vr($r(xr,Kr("p2p")),Mr,Cr,Lr,Kr("p2p"))),zr=Vr($r(Br,Kr("p2p-circuit"),Br),$r(Br,Kr("p2p-circuit")),$r(Kr("p2p-circuit"),Br),$r(xr,Kr("p2p-circuit")),$r(Kr("p2p-circuit"),xr),Kr("p2p-circuit")),Ur=()=>Vr($r(zr,Ur),zr),Fr=Ur(),jr=Vr($r(Fr,Br,Fr),$r(Br,Fr),$r(Fr,Br),Fr,Br);function Hr(e){return function(t){let n;try{n=wr(t)}catch(e){return!1}const s=e(n.protoNames());return null!==s&&(!0===s||!1===s?s:0===s.length)}}function $r(...e){function t(t){if(t.length<e.length)return null;let n=t;return e.some((e=>(n="function"==typeof e?e().partialMatch(t):e.partialMatch(t),Array.isArray(n)&&(t=n),null===n))),n}return{toString:function(){return"{ "+e.join(" ")+" }"},input:e,matches:Hr(t),partialMatch:t}}function Vr(...e){function t(t){let n=null;return e.some((e=>{const s="function"==typeof e?e().partialMatch(t):e.partialMatch(t);return null!=s&&(n=s,!0)})),n}return{toString:function(){return"{ "+e.join(" ")+" }"},input:e,matches:Hr(t),partialMatch:t}}function Kr(e){const t=e;return{toString:function(){return t},matches:function(e){let n;try{n=wr(e)}catch(e){return!1}const s=n.protoNames();return 1===s.length&&s[0]===t},partialMatch:function(e){return 0===e.length?null:e[0]===t?e.slice(1):null}}}function qr(e){try{return jr.matches(e)}catch(e){return!1}}var Gr=()=>({Addresses:{Swarm:[],Announce:[],NoAnnounce:[],API:"",Gateway:"",RPC:"",Delegates:["/dns4/node0.delegate.ipfs.io/tcp/443/https","/dns4/node1.delegate.ipfs.io/tcp/443/https","/dns4/node2.delegate.ipfs.io/tcp/443/https","/dns4/node3.delegate.ipfs.io/tcp/443/https"]},Discovery:{MDNS:{Enabled:!1,Interval:10},webRTCStar:{Enabled:!0}},Bootstrap:["/dnsaddr/bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN","/dnsaddr/bootstrap.libp2p.io/p2p/QmbLHAnMoJPWSCR5Zhtx6BHJX9KiKNN6tpvbUcqanj75Nb","/dnsaddr/bootstrap.libp2p.io/p2p/QmZa1sAxajnQjVM8WjWXoMbmPd7NsWhfKsPkErzpm9wGkp","/dnsaddr/bootstrap.libp2p.io/p2p/QmQCU2EcMqAqQPR2i9bChDtGNJchTbq5TbXJJ16u19uLTa","/dnsaddr/bootstrap.libp2p.io/p2p/QmcZf59bWwK5XFi76CZX8cbJ4BhTzzA3gU1ZjYZcYW3dwt","/dns4/node0.preload.ipfs.io/tcp/443/wss/p2p/QmZMxNdpMkewiVZLMRxaNxUeZpDUb34pWjZ1kZvsd16Zic","/dns4/node1.preload.ipfs.io/tcp/443/wss/p2p/Qmbut9Ywz9YEDrz8ySBSgWyJk41Uvm2QJPhwDJzJyGFsD6","/dns4/node2.preload.ipfs.io/tcp/443/wss/p2p/QmV7gnbW5VTcJ3oyM2Xk1rdFBJ3kTkvxc87UFGsun29STS","/dns4/node3.preload.ipfs.io/tcp/443/wss/p2p/QmY7JB6MQXhxHvq7dBDh4HpbH29v4yE9JRadAVpndvzySN"],Pubsub:{Enabled:!0},Swarm:{ConnMgr:{LowWater:5,HighWater:20},DisableNatPortMap:!0},Routing:{Type:"dhtclient"}});class Wr{constructor({repo:e}){this.add=function({repo:e}){return St((async function(t,n={}){if(!qr(t))throw new Error(`${t} is not a valid Multiaddr`);const s=await e.config.getAll(n),r=s.Bootstrap||[];return r.push(t.toString()),s.Bootstrap=Array.from(new Set(r)).sort(((e,t)=>e.localeCompare(t))),await e.config.replace(s),{Peers:[t]}}))}({repo:e}),this.list=function({repo:e}){return St((async function(t={}){return{Peers:(await e.config.get("Bootstrap",t)||[]).map((e=>(0,j.HZ)(e)))}}))}({repo:e}),this.rm=function({repo:e}){return St((async function(t,n={}){if(!qr(t))throw new Error(`${t} is not a valid Multiaddr`);const s=await e.config.getAll(n);return s.Bootstrap=(s.Bootstrap||[]).filter((e=>e.toString()!==t.toString())),await e.config.replace(s),{Peers:[t]}}))}({repo:e}),this.clear=function({repo:e}){return St((async function(t={}){const n=await e.config.getAll(t),s=n.Bootstrap||[];return n.Bootstrap=[],await e.config.replace(n),{Peers:s.map((e=>(0,j.HZ)(e)))}}))}({repo:e}),this.reset=function({repo:e}){return St((async function(t={}){const n=await e.config.getAll(t);return n.Bootstrap=Gr().Bootstrap,await e.config.replace(n),{Peers:Gr().Bootstrap.map((e=>(0,j.HZ)(e)))}}))}({repo:e})}}var Yr=n(48209),Xr=n(47390),Qr=n(67631);const Jr=(...e)=>{let t;for(;e.length>0;)t=e.shift()(t);return t},Zr=e=>null!=e&&("function"==typeof e[Symbol.asyncIterator]||"function"==typeof e[Symbol.iterator]||"function"==typeof e.next),eo=e=>null!=e&&"function"==typeof e.sink&&Zr(e.source),to=e=>t=>{const n=e.sink(t);if(null!=n.then){const t=(0,Yn.N)({objectMode:!0});n.then((()=>{t.end()}),(e=>{t.end(e)}));const s=async function*(){yield*e.source,t.end()};return(0,Qr.A)(t,s())}return e.source};function no(e,...t){if(eo(e)){const t=e;e=()=>t.source}else if(Zr(e)){const t=e;e=()=>t}const n=[e,...t];if(n.length>1&&eo(n[n.length-1])&&(n[n.length-1]=n[n.length-1].sink),n.length>2)for(let e=1;e<n.length-1;e++)eo(n[e])&&(n[e]=to(n[e]));return Jr(...n)}function so(e){return e instanceof Uint8Array?J.TO.decode(e):J.TO.parse(e.toString())}class ro{constructor({codecs:e,hashers:t,preload:n,repo:s}){this.get=function({preload:e,repo:t}){return St((async function(n,s={}){return!1!==s.preload&&e(n),t.blocks.get(n,s)}))}({preload:n,repo:s}),this.put=function({codecs:e,hashers:t,repo:n,preload:s}){return St((async function(r,o={}){const i=o.pin?await n.gcLock.readLock():null;try{const i=null!=o.version?o.version:0,a=o.format||(0===i?"dag-pb":"raw"),c=await t.getHasher(o.mhtype||"sha2-256"),l=await c.digest(r),d=await e.getCodec(a),u=J.TO.create(i,d.code,l);return await n.blocks.put(u,r,{signal:o.signal}),!1!==o.preload&&s(u),!0===o.pin&&await n.pins.pinRecursively(u,{signal:o.signal}),u}finally{i&&i()}}))}({codecs:e,hashers:t,preload:n,repo:s}),this.rm=function({repo:e}){return St((async function*(t,n={}){Array.isArray(t)||(t=[t]);const s=await e.gcLock.writeLock();try{yield*no(t,(t=>(0,Xr.A)(t,(t=>async()=>{const s={cid:t=so(t)};try{if(!await e.blocks.has(t))throw c(new Error("block not found"),"ERR_BLOCK_NOT_FOUND");await e.blocks.delete(t)}catch(e){n.force||(e.message=`cannot remove ${t}: ${e.message}`,s.error=e)}return s}))),(e=>(0,Yr.A)(e,{concurrency:8})),(e=>(0,qn.A)(e,(()=>!n.quiet))))}finally{s()}}))}({repo:s}),this.stat=function({repo:e,preload:t}){return St((async function(n,s={}){return n=so(n),!1!==s.preload&&t(n),{cid:n,size:(await e.blocks.get(n)).length}}))}({preload:n,repo:s})}}var oo=n(43734);async function*io(e,t=1){let n=[];t<1&&(t=1);for await(const s of e)for(n.push(s);n.length>=t;)yield n.slice(0,t),n=n.slice(t);for(;n.length>0;)yield n.slice(0,t),n=n.slice(t)}async function*ao(e,t=1){for await(const n of io(e,t)){const e=n.map((async e=>await e().then((e=>({ok:!0,value:e})),(e=>({ok:!1,err:e})))));for(let t=0;t<e.length;t++){const n=await e[t];if(!n.ok)throw n.err;yield n.value}}}var co=n(40218),lo=n(7012);const uo={chunker:"fixed",strategy:"balanced",rawLeaves:!1,onlyHash:!1,reduceSingleLeafToSelf:!0,hasher:co.sha256,leafType:"file",cidVersion:0,progress:()=>()=>{},shardSplitThreshold:1e3,fileImportConcurrency:50,blockWriteConcurrency:10,minChunkSize:262144,maxChunkSize:262144,avgChunkSize:262144,window:16,polynomial:0x3df305dfb2a804,maxChildrenPerNode:174,layerRepeat:4,wrapWithDirectory:!1,recursive:!1,hidden:!1,timeout:void 0,hamtHashFn:async function(e){return(await lo.DK.encode(e)).slice(0,8).reverse()},hamtHashCode:34,hamtBucketBits:8};var ho=(e={})=>o.A.bind({ignoreUndefined:!0})(uo,e);const po=l.Reader,fo=l.Writer,yo=l.util,go=l.roots["ipfs-unixfs"]||(l.roots["ipfs-unixfs"]={}),mo=go.Data=(()=>{function e(e){if(this.blocksizes=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.Type=0,e.prototype.Data=yo.newBuffer([]),e.prototype.filesize=yo.Long?yo.Long.fromBits(0,0,!0):0,e.prototype.blocksizes=yo.emptyArray,e.prototype.hashType=yo.Long?yo.Long.fromBits(0,0,!0):0,e.prototype.fanout=yo.Long?yo.Long.fromBits(0,0,!0):0,e.prototype.mode=0,e.prototype.mtime=null,e.encode=function(e,t){if(t||(t=fo.create()),t.uint32(8).int32(e.Type),null!=e.Data&&Object.hasOwnProperty.call(e,"Data")&&t.uint32(18).bytes(e.Data),null!=e.filesize&&Object.hasOwnProperty.call(e,"filesize")&&t.uint32(24).uint64(e.filesize),null!=e.blocksizes&&e.blocksizes.length)for(var n=0;n<e.blocksizes.length;++n)t.uint32(32).uint64(e.blocksizes[n]);return null!=e.hashType&&Object.hasOwnProperty.call(e,"hashType")&&t.uint32(40).uint64(e.hashType),null!=e.fanout&&Object.hasOwnProperty.call(e,"fanout")&&t.uint32(48).uint64(e.fanout),null!=e.mode&&Object.hasOwnProperty.call(e,"mode")&&t.uint32(56).uint32(e.mode),null!=e.mtime&&Object.hasOwnProperty.call(e,"mtime")&&go.UnixTime.encode(e.mtime,t.uint32(66).fork()).ldelim(),t},e.decode=function(e,t){e instanceof po||(e=po.create(e));for(var n=void 0===t?e.len:e.pos+t,s=new go.Data;e.pos<n;){var r=e.uint32();switch(r>>>3){case 1:s.Type=e.int32();break;case 2:s.Data=e.bytes();break;case 3:s.filesize=e.uint64();break;case 4:if(s.blocksizes&&s.blocksizes.length||(s.blocksizes=[]),2==(7&r))for(var o=e.uint32()+e.pos;e.pos<o;)s.blocksizes.push(e.uint64());else s.blocksizes.push(e.uint64());break;case 5:s.hashType=e.uint64();break;case 6:s.fanout=e.uint64();break;case 7:s.mode=e.uint32();break;case 8:s.mtime=go.UnixTime.decode(e,e.uint32());break;default:e.skipType(7&r)}}if(!s.hasOwnProperty("Type"))throw yo.ProtocolError("missing required 'Type'",{instance:s});return s},e.fromObject=function(e){if(e instanceof go.Data)return e;var t=new go.Data;switch(e.Type){case"Raw":case 0:t.Type=0;break;case"Directory":case 1:t.Type=1;break;case"File":case 2:t.Type=2;break;case"Metadata":case 3:t.Type=3;break;case"Symlink":case 4:t.Type=4;break;case"HAMTShard":case 5:t.Type=5}if(null!=e.Data&&("string"==typeof e.Data?yo.base64.decode(e.Data,t.Data=yo.newBuffer(yo.base64.length(e.Data)),0):e.Data.length&&(t.Data=e.Data)),null!=e.filesize&&(yo.Long?(t.filesize=yo.Long.fromValue(e.filesize)).unsigned=!0:"string"==typeof e.filesize?t.filesize=parseInt(e.filesize,10):"number"==typeof e.filesize?t.filesize=e.filesize:"object"==typeof e.filesize&&(t.filesize=new yo.LongBits(e.filesize.low>>>0,e.filesize.high>>>0).toNumber(!0))),e.blocksizes){if(!Array.isArray(e.blocksizes))throw TypeError(".Data.blocksizes: array expected");t.blocksizes=[];for(var n=0;n<e.blocksizes.length;++n)yo.Long?(t.blocksizes[n]=yo.Long.fromValue(e.blocksizes[n])).unsigned=!0:"string"==typeof e.blocksizes[n]?t.blocksizes[n]=parseInt(e.blocksizes[n],10):"number"==typeof e.blocksizes[n]?t.blocksizes[n]=e.blocksizes[n]:"object"==typeof e.blocksizes[n]&&(t.blocksizes[n]=new yo.LongBits(e.blocksizes[n].low>>>0,e.blocksizes[n].high>>>0).toNumber(!0))}if(null!=e.hashType&&(yo.Long?(t.hashType=yo.Long.fromValue(e.hashType)).unsigned=!0:"string"==typeof e.hashType?t.hashType=parseInt(e.hashType,10):"number"==typeof e.hashType?t.hashType=e.hashType:"object"==typeof e.hashType&&(t.hashType=new yo.LongBits(e.hashType.low>>>0,e.hashType.high>>>0).toNumber(!0))),null!=e.fanout&&(yo.Long?(t.fanout=yo.Long.fromValue(e.fanout)).unsigned=!0:"string"==typeof e.fanout?t.fanout=parseInt(e.fanout,10):"number"==typeof e.fanout?t.fanout=e.fanout:"object"==typeof e.fanout&&(t.fanout=new yo.LongBits(e.fanout.low>>>0,e.fanout.high>>>0).toNumber(!0))),null!=e.mode&&(t.mode=e.mode>>>0),null!=e.mtime){if("object"!=typeof e.mtime)throw TypeError(".Data.mtime: object expected");t.mtime=go.UnixTime.fromObject(e.mtime)}return t},e.toObject=function(e,t){t||(t={});var n={};if((t.arrays||t.defaults)&&(n.blocksizes=[]),t.defaults){if(n.Type=t.enums===String?"Raw":0,t.bytes===String?n.Data="":(n.Data=[],t.bytes!==Array&&(n.Data=yo.newBuffer(n.Data))),yo.Long){var s=new yo.Long(0,0,!0);n.filesize=t.longs===String?s.toString():t.longs===Number?s.toNumber():s}else n.filesize=t.longs===String?"0":0;if(yo.Long){s=new yo.Long(0,0,!0);n.hashType=t.longs===String?s.toString():t.longs===Number?s.toNumber():s}else n.hashType=t.longs===String?"0":0;if(yo.Long){s=new yo.Long(0,0,!0);n.fanout=t.longs===String?s.toString():t.longs===Number?s.toNumber():s}else n.fanout=t.longs===String?"0":0;n.mode=0,n.mtime=null}if(null!=e.Type&&e.hasOwnProperty("Type")&&(n.Type=t.enums===String?go.Data.DataType[e.Type]:e.Type),null!=e.Data&&e.hasOwnProperty("Data")&&(n.Data=t.bytes===String?yo.base64.encode(e.Data,0,e.Data.length):t.bytes===Array?Array.prototype.slice.call(e.Data):e.Data),null!=e.filesize&&e.hasOwnProperty("filesize")&&("number"==typeof e.filesize?n.filesize=t.longs===String?String(e.filesize):e.filesize:n.filesize=t.longs===String?yo.Long.prototype.toString.call(e.filesize):t.longs===Number?new yo.LongBits(e.filesize.low>>>0,e.filesize.high>>>0).toNumber(!0):e.filesize),e.blocksizes&&e.blocksizes.length){n.blocksizes=[];for(var r=0;r<e.blocksizes.length;++r)"number"==typeof e.blocksizes[r]?n.blocksizes[r]=t.longs===String?String(e.blocksizes[r]):e.blocksizes[r]:n.blocksizes[r]=t.longs===String?yo.Long.prototype.toString.call(e.blocksizes[r]):t.longs===Number?new yo.LongBits(e.blocksizes[r].low>>>0,e.blocksizes[r].high>>>0).toNumber(!0):e.blocksizes[r]}return null!=e.hashType&&e.hasOwnProperty("hashType")&&("number"==typeof e.hashType?n.hashType=t.longs===String?String(e.hashType):e.hashType:n.hashType=t.longs===String?yo.Long.prototype.toString.call(e.hashType):t.longs===Number?new yo.LongBits(e.hashType.low>>>0,e.hashType.high>>>0).toNumber(!0):e.hashType),null!=e.fanout&&e.hasOwnProperty("fanout")&&("number"==typeof e.fanout?n.fanout=t.longs===String?String(e.fanout):e.fanout:n.fanout=t.longs===String?yo.Long.prototype.toString.call(e.fanout):t.longs===Number?new yo.LongBits(e.fanout.low>>>0,e.fanout.high>>>0).toNumber(!0):e.fanout),null!=e.mode&&e.hasOwnProperty("mode")&&(n.mode=e.mode),null!=e.mtime&&e.hasOwnProperty("mtime")&&(n.mtime=go.UnixTime.toObject(e.mtime,t)),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,l.util.toJSONOptions)},e.DataType=function(){const e={},t=Object.create(e);return t[e[0]="Raw"]=0,t[e[1]="Directory"]=1,t[e[2]="File"]=2,t[e[3]="Metadata"]=3,t[e[4]="Symlink"]=4,t[e[5]="HAMTShard"]=5,t}(),e})(),wo=(go.UnixTime=(()=>{function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.Seconds=yo.Long?yo.Long.fromBits(0,0,!1):0,e.prototype.FractionalNanoseconds=0,e.encode=function(e,t){return t||(t=fo.create()),t.uint32(8).int64(e.Seconds),null!=e.FractionalNanoseconds&&Object.hasOwnProperty.call(e,"FractionalNanoseconds")&&t.uint32(21).fixed32(e.FractionalNanoseconds),t},e.decode=function(e,t){e instanceof po||(e=po.create(e));for(var n=void 0===t?e.len:e.pos+t,s=new go.UnixTime;e.pos<n;){var r=e.uint32();switch(r>>>3){case 1:s.Seconds=e.int64();break;case 2:s.FractionalNanoseconds=e.fixed32();break;default:e.skipType(7&r)}}if(!s.hasOwnProperty("Seconds"))throw yo.ProtocolError("missing required 'Seconds'",{instance:s});return s},e.fromObject=function(e){if(e instanceof go.UnixTime)return e;var t=new go.UnixTime;return null!=e.Seconds&&(yo.Long?(t.Seconds=yo.Long.fromValue(e.Seconds)).unsigned=!1:"string"==typeof e.Seconds?t.Seconds=parseInt(e.Seconds,10):"number"==typeof e.Seconds?t.Seconds=e.Seconds:"object"==typeof e.Seconds&&(t.Seconds=new yo.LongBits(e.Seconds.low>>>0,e.Seconds.high>>>0).toNumber())),null!=e.FractionalNanoseconds&&(t.FractionalNanoseconds=e.FractionalNanoseconds>>>0),t},e.toObject=function(e,t){t||(t={});var n={};if(t.defaults){if(yo.Long){var s=new yo.Long(0,0,!1);n.Seconds=t.longs===String?s.toString():t.longs===Number?s.toNumber():s}else n.Seconds=t.longs===String?"0":0;n.FractionalNanoseconds=0}return null!=e.Seconds&&e.hasOwnProperty("Seconds")&&("number"==typeof e.Seconds?n.Seconds=t.longs===String?String(e.Seconds):e.Seconds:n.Seconds=t.longs===String?yo.Long.prototype.toString.call(e.Seconds):t.longs===Number?new yo.LongBits(e.Seconds.low>>>0,e.Seconds.high>>>0).toNumber():e.Seconds),null!=e.FractionalNanoseconds&&e.hasOwnProperty("FractionalNanoseconds")&&(n.FractionalNanoseconds=e.FractionalNanoseconds),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,l.util.toJSONOptions)},e})(),go.Metadata=(()=>{function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.MimeType="",e.encode=function(e,t){return t||(t=fo.create()),null!=e.MimeType&&Object.hasOwnProperty.call(e,"MimeType")&&t.uint32(10).string(e.MimeType),t},e.decode=function(e,t){e instanceof po||(e=po.create(e));for(var n=void 0===t?e.len:e.pos+t,s=new go.Metadata;e.pos<n;){var r=e.uint32();if(r>>>3==1)s.MimeType=e.string();else e.skipType(7&r)}return s},e.fromObject=function(e){if(e instanceof go.Metadata)return e;var t=new go.Metadata;return null!=e.MimeType&&(t.MimeType=String(e.MimeType)),t},e.toObject=function(e,t){t||(t={});var n={};return t.defaults&&(n.MimeType=""),null!=e.MimeType&&e.hasOwnProperty("MimeType")&&(n.MimeType=e.MimeType),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,l.util.toJSONOptions)},e})(),mo),bo=["raw","directory","file","metadata","symlink","hamt-sharded-directory"],_o=["directory","hamt-sharded-directory"],Eo=parseInt("0644",8),vo=parseInt("0755",8);function So(e){if(null!=e)return"number"==typeof e?4095&e:"0"===(e=e.toString()).substring(0,1)?4095&parseInt(e,8):4095&parseInt(e,10)}function ko(e){if(null==e)return;let t;if(null!=e.secs&&(t={secs:e.secs,nsecs:e.nsecs}),null!=e.Seconds&&(t={secs:e.Seconds,nsecs:e.FractionalNanoseconds}),Array.isArray(e)&&(t={secs:e[0],nsecs:e[1]}),e instanceof Date){const n=e.getTime(),s=Math.floor(n/1e3);t={secs:s,nsecs:1e3*(n-1e3*s)}}if(Object.prototype.hasOwnProperty.call(t,"secs")){if(null!=t&&null!=t.nsecs&&(t.nsecs<0||t.nsecs>999999999))throw c(new Error("mtime-nsecs must be within the range [0,999999999]"),"ERR_INVALID_MTIME_NSECS");return t}}class Ro{static unmarshal(e){const t=wo.decode(e),n=wo.toObject(t,{defaults:!1,arrays:!0,longs:Number,objects:!1}),s=new Ro({type:bo[n.Type],data:n.Data,blockSizes:n.blocksizes,mode:n.mode,mtime:n.mtime?{secs:n.mtime.Seconds,nsecs:n.mtime.FractionalNanoseconds}:void 0});return s._originalMode=n.mode||0,s}constructor(e={type:"file"}){const{type:t,data:n,blockSizes:s,hashType:r,fanout:o,mtime:i,mode:a}=e;if(t&&!bo.includes(t))throw c(new Error("Type: "+t+" is not valid"),"ERR_INVALID_TYPE");this.type=t||"file",this.data=n,this.hashType=r,this.fanout=o,this.blockSizes=s||[],this._originalMode=0,this.mode=So(a),i&&(this.mtime=ko(i),this.mtime&&!this.mtime.nsecs&&(this.mtime.nsecs=0))}set mode(e){this._mode=this.isDirectory()?vo:Eo;const t=So(e);void 0!==t&&(this._mode=t)}get mode(){return this._mode}isDirectory(){return Boolean(this.type&&_o.includes(this.type))}addBlockSize(e){this.blockSizes.push(e)}removeBlockSize(e){this.blockSizes.splice(e,1)}fileSize(){if(this.isDirectory())return 0;let e=0;return this.blockSizes.forEach((t=>{e+=t})),this.data&&(e+=this.data.length),e}marshal(){let e;switch(this.type){case"raw":e=wo.DataType.Raw;break;case"directory":e=wo.DataType.Directory;break;case"file":e=wo.DataType.File;break;case"metadata":e=wo.DataType.Metadata;break;case"symlink":e=wo.DataType.Symlink;break;case"hamt-sharded-directory":e=wo.DataType.HAMTShard;break;default:throw c(new Error("Type: "+e+" is not valid"),"ERR_INVALID_TYPE")}let t,n,s=this.data;if(this.data&&this.data.length||(s=void 0),null!=this.mode&&(t=4294963200&this._originalMode|(So(this.mode)||0),t!==Eo||this.isDirectory()||(t=void 0),t===vo&&this.isDirectory()&&(t=void 0)),null!=this.mtime){const e=ko(this.mtime);e&&(n={Seconds:e.secs,FractionalNanoseconds:e.nsecs},0===n.FractionalNanoseconds&&delete n.FractionalNanoseconds)}const r={Type:e,Data:s,filesize:this.isDirectory()?void 0:this.fileSize(),blocksizes:this.blockSizes,hashType:this.hashType,fanout:this.fanout,mode:t,mtime:n};return wo.encode(r).finish()}}var To=async(e,t,n)=>{n.codec||(n.codec=S),n.hasher||(n.hasher=co.sha256),void 0===n.cidVersion&&(n.cidVersion=1),n.codec===S&&n.hasher!==co.sha256&&(n.cidVersion=1);const s=await n.hasher.digest(e),r=J.TO.create(n.cidVersion,n.codec.code,s);return n.onlyHash||await t.put(r,e,{signal:n.signal}),r};var Io=async(e,t,n)=>{const s=new Ro({type:"directory",mtime:e.mtime,mode:e.mode}),r=(0,S.encode)((0,S.prepare)({Data:s.marshal()}));return{cid:await To(r,t,n),path:e.path,unixfs:s,size:r.length}},Po=n(79033);var Ao=async function(e,t){return t(await async function(e){const t=[];for await(const n of e)t.push(n);return t}(e))};async function Do(e,t,n){const s=[];for await(const r of io(e,n.maxChildrenPerNode))s.push(await t(r));return s.length>1?Do(s,t,n):s[0]}var Oo=function(e,t,n){return Do(e,t,n)};var No=async function(e,t,n){const s=new Mo(n.layerRepeat);let r=0,o=1,i=s;for await(const a of io(e,n.maxChildrenPerNode))i.isFull()&&(i!==s&&s.addChild(await i.reduce(t)),r&&r%n.layerRepeat==0&&o++,i=new Lo(o,n.layerRepeat,r),r++),i.append(a);return i&&i!==s&&s.addChild(await i.reduce(t)),s.reduce(t)};class Lo{constructor(e,t,n=0){this.maxDepth=e,this.layerRepeat=t,this.currentDepth=1,this.iteration=n,this.root=this.node=this.parent={children:[],depth:this.currentDepth,maxDepth:e,maxChildren:(this.maxDepth-this.currentDepth)*this.layerRepeat}}isFull(){if(!this.root.data)return!1;if(this.currentDepth<this.maxDepth&&this.node.maxChildren)return this._addNextNodeToParent(this.node),!1;const e=this._findParent(this.node,this.currentDepth);return!e||(this._addNextNodeToParent(e),!1)}_addNextNodeToParent(e){this.parent=e;const t={children:[],depth:e.depth+1,parent:e,maxDepth:this.maxDepth,maxChildren:Math.floor(e.children.length/this.layerRepeat)*this.layerRepeat};e.children.push(t),this.currentDepth=t.depth,this.node=t}append(e){this.node.data=e}reduce(e){return this._reduce(this.root,e)}async _reduce(e,t){let n=[];return e.children.length&&(n=await Promise.all(e.children.filter((e=>e.data)).map((e=>this._reduce(e,t))))),t((e.data||[]).concat(n))}_findParent(e,t){const n=e.parent;if(n&&0!==n.depth)return n.children.length!==n.maxChildren&&n.maxChildren?n:this._findParent(n,t)}}class Mo extends Lo{constructor(e){super(0,e),this.root.depth=0,this.currentDepth=1}addChild(e){this.root.children.push(e)}reduce(e){return e((this.root.data||[]).concat(this.root.children))}}var Co=async function*(e,t,n){for await(let s of e.content)yield async()=>{let r;n.progress(s.length,e.path);const o={codec:S,cidVersion:n.cidVersion,hasher:n.hasher,onlyHash:n.onlyHash};return n.rawLeaves?(o.codec=Po,o.cidVersion=1):(r=new Ro({type:n.leafType,data:s}),s=S.encode({Data:r.marshal(),Links:[]})),{cid:await To(s,t,o),unixfs:r,size:s.length}}};const xo={flat:Ao,balanced:Oo,trickle:No};var Bo=function(e,t,n){const s=xo[n.strategy];if(!s)throw c(new Error(`Unknown importer build strategy name: ${n.strategy}`),"ERR_BAD_STRATEGY");return s(async function*(e,t,n){let s,r,o=-1;r="function"==typeof n.bufferImporter?n.bufferImporter:Co;for await(const i of ao(r(e,t,n),n.blockWriteConcurrency))o++,0!==o?(1===o&&s&&(yield s,s=null),yield i):s=i;s&&(s.single=!0,yield s)}(e,t,n),((e,t,n)=>async function(s){if(1===s.length&&s[0].single&&n.reduceSingleLeafToSelf){const r=s[0];if(void 0!==e.mtime||void 0!==e.mode){let s=await t.get(r.cid);r.unixfs=new Ro({type:"file",mtime:e.mtime,mode:e.mode,data:s}),s=(0,S.encode)((0,S.prepare)({Data:r.unixfs.marshal()})),r.cid=await To(s,t,{...n,codec:S,hasher:n.hasher,cidVersion:n.cidVersion}),r.size=s.length}return{cid:r.cid,path:e.path,unixfs:r.unixfs,size:r.size}}const r=new Ro({type:"file",mtime:e.mtime,mode:e.mode}),o=s.filter((e=>!(e.cid.code!==Po.code||!e.size)||!(!e.unixfs||e.unixfs.data||!e.unixfs.fileSize())||Boolean(e.unixfs&&e.unixfs.data&&e.unixfs.data.length))).map((e=>e.cid.code===Po.code?(r.addBlockSize(e.size),{Name:"",Tsize:e.size,Hash:e.cid}):(e.unixfs&&e.unixfs.data?r.addBlockSize(e.unixfs.data.length):r.addBlockSize(e.unixfs&&e.unixfs.fileSize()||0),{Name:"",Tsize:e.size,Hash:e.cid}))),i={Data:r.marshal(),Links:o},a=(0,S.encode)((0,S.prepare)(i));return{cid:await To(a,t,n),path:e.path,unixfs:r,size:a.length+i.Links.reduce(((e,t)=>e+t.Tsize),0)}})(e,t,n),n)},zo=n(40859),Uo=n(76561);var Fo=async function*(e,t){let n,s,r;if(t.minChunkSize&&t.maxChunkSize&&t.avgChunkSize)r=t.avgChunkSize,n=t.minChunkSize,s=t.maxChunkSize;else{if(!t.avgChunkSize)throw c(new Error("please specify an average chunk size"),"ERR_INVALID_AVG_CHUNK_SIZE");r=t.avgChunkSize,n=r/3,s=r+r/2}if(n<16)throw c(new Error("rabin min must be greater than 16"),"ERR_INVALID_MIN_CHUNK_SIZE");s<n&&(s=n),r<n&&(r=n);const o=Math.floor(Math.log2(r));for await(const r of async function*(e,t){const n=await(0,Uo.create)(t.bits,t.min,t.max,t.window),s=new zo.I;for await(const t of e){s.append(t);const e=n.fingerprint(t);for(let t=0;t<e.length;t++){const n=e[t],r=s.slice(0,n);s.consume(n),yield r}}s.length&&(yield s.subarray(0))}(e,{min:n,max:s,bits:o,window:t.window,polynomial:t.polynomial}))yield r};var jo=async function*(e,t){let n=new zo.I,s=0,r=!1;const o=t.maxChunkSize;for await(const t of e)for(n.append(t),s+=t.length;s>=o;)if(yield n.slice(0,o),r=!0,o===n.length)n=new zo.I,s=0;else{const e=new zo.I;e.append(n.sublist(o)),n=e,s-=o}r&&!s||(yield n.subarray(0,s))};var Ho=async function*(e){for await(const t of e){if(void 0===t.length)throw c(new Error("Content was invalid"),"ERR_INVALID_CONTENT");if("string"==typeof t||t instanceof String)yield(0,x.s)(t.toString());else if(Array.isArray(t))yield Uint8Array.from(t);else{if(!(t instanceof Uint8Array))throw c(new Error("Content was invalid"),"ERR_INVALID_CONTENT");yield t}}};function $o(e){try{if(e instanceof Uint8Array)return async function*(){yield e}();if(t=e,Symbol.iterator in t)return async function*(){yield*e}();if(function(e){return Symbol.asyncIterator in e}(e))return e}catch{throw c(new Error("Content was invalid"),"ERR_INVALID_CONTENT")}var t;throw c(new Error("Content was invalid"),"ERR_INVALID_CONTENT")}var Vo=async function*(e,t,n){for await(const s of e)if(s.path&&("./"===s.path.substring(0,2)&&(n.wrapWithDirectory=!0),s.path=s.path.split("/").filter((e=>e&&"."!==e)).join("/")),s.content){let e,r;e="function"==typeof n.chunker?n.chunker:"rabin"===n.chunker?Fo:jo,r="function"==typeof n.chunkValidator?n.chunkValidator:Ho;const o={path:s.path,mtime:s.mtime,mode:s.mode,content:e(r($o(s.content),n),n)};yield()=>Bo(o,t,n)}else{if(!s.path)throw new Error("Import candidate must have content or path or both");{const e={path:s.path,mtime:s.mtime,mode:s.mode};yield()=>Io(e,t,n)}}};var Ko=class{constructor(e,t){this.options=t||{},this.root=e.root,this.dir=e.dir,this.path=e.path,this.dirty=e.dirty,this.flat=e.flat,this.parent=e.parent,this.parentKey=e.parentKey,this.unixfs=e.unixfs,this.mode=e.mode,this.mtime=e.mtime,this.cid=void 0,this.size=void 0}async put(e,t){}get(e){return Promise.resolve(this)}async*eachChildSeries(){}async*flush(e){}};var qo=class extends Ko{constructor(e,t){super(e,t),this._children={}}async put(e,t){this.cid=void 0,this.size=void 0,this._children[e]=t}get(e){return Promise.resolve(this._children[e])}childCount(){return Object.keys(this._children).length}directChildrenCount(){return this.childCount()}onlyChild(){return this._children[Object.keys(this._children)[0]]}async*eachChildSeries(){const e=Object.keys(this._children);for(let t=0;t<e.length;t++){const n=e[t];yield{key:n,child:this._children[n]}}}async*flush(e){const t=Object.keys(this._children),n=[];for(let s=0;s<t.length;s++){let r=this._children[t[s]];if(r instanceof Ko)for await(const t of r.flush(e))r=t,yield r;null!=r.size&&r.cid&&n.push({Name:t[s],Tsize:r.size,Hash:r.cid})}const s=new Ro({type:"directory",mtime:this.mtime,mode:this.mode}),r={Data:s.marshal(),Links:n},o=(0,S.encode)((0,S.prepare)(r)),i=await To(o,e,this.options),a=o.length+r.Links.reduce(((e,t)=>e+(null==t.Tsize?0:t.Tsize)),0);this.cid=i,this.size=a,yield{cid:i,unixfs:s,path:this.path,size:a}}},Go=n(16324);var Wo=class extends Ko{constructor(e,t){super(e,t),this._bucket=(0,Go.T)({hashFn:t.hamtHashFn,bits:t.hamtBucketBits})}async put(e,t){await this._bucket.put(e,t)}get(e){return this._bucket.get(e)}childCount(){return this._bucket.leafCount()}directChildrenCount(){return this._bucket.childrenCount()}onlyChild(){return this._bucket.onlyChild()}async*eachChildSeries(){for await(const{key:e,value:t}of this._bucket.eachLeafSeries())yield{key:e,child:t}}async*flush(e){for await(const t of Yo(this._bucket,e,this,this.options))yield{...t,path:this.path}}};async function*Yo(e,t,n,s){const r=e._children,o=[];let i=0;for(let e=0;e<r.length;e++){const n=r.get(e);if(!n)continue;const a=e.toString(16).toUpperCase().padStart(2,"0");if(n instanceof Go.f){let e;for await(const r of await Yo(n,t,null,s))e=r;if(!e)throw new Error("Could not flush sharded directory, no subshard found");o.push({Name:a,Tsize:e.size,Hash:e.cid}),i+=e.size}else if("function"==typeof n.value.flush){const e=n.value;let s;for await(const n of e.flush(t))s=n,yield s;const r=a+n.key;o.push({Name:r,Tsize:s.size,Hash:s.cid}),i+=s.size}else{const e=n.value;if(!e.cid)continue;const t=a+n.key,s=e.size;o.push({Name:t,Tsize:s,Hash:e.cid}),i+=s}}const a=Uint8Array.from(r.bitField().reverse()),c=new Ro({type:"hamt-sharded-directory",data:a,fanout:e.tableSize(),hashType:s.hamtHashCode,mtime:n&&n.mtime,mode:n&&n.mode}),l={Data:c.marshal(),Links:o},d=(0,S.encode)((0,S.prepare)(l)),u=await To(d,t,s),h=d.length+i;yield{cid:u,unixfs:c,size:h}}var Xo=async function e(t,n,s,r){let o=n;n instanceof qo&&n.directChildrenCount()>=s&&(o=await async function(e,t){const n=new Wo({root:e.root,dir:!0,parent:e.parent,parentKey:e.parentKey,path:e.path,dirty:e.dirty,flat:!1,mtime:e.mtime,mode:e.mode},t);for await(const{key:t,child:s}of e.eachChildSeries())await n.put(t,s);return n}(n,r));const i=o.parent;if(i){if(o!==n){if(t&&(t.parent=o),!o.parentKey)throw new Error("No parent key found");await i.put(o.parentKey,o)}return e(o,i,s,r)}return o};var Qo=(e="")=>(e.trim().match(/([^\\/]|\\\/)+/g)||[]).filter(Boolean);async function Jo(e,t,n){const s=Qo(e.path||""),r=s.length-1;let o=t,i="";for(let a=0;a<s.length;a++){const c=s[a];i+=`${i?"/":""}${c}`;const l=a===r;if(o.dirty=!0,o.cid=void 0,o.size=void 0,l)await o.put(c,e),t=await Xo(null,o,n.shardSplitThreshold,n);else{let e=await o.get(c);e&&e instanceof Ko||(e=new qo({root:!1,dir:!0,parent:o,parentKey:c,path:i,dirty:!0,flat:!0,mtime:e&&e.unixfs&&e.unixfs.mtime,mode:e&&e.unixfs&&e.unixfs.mode},n)),await o.put(c,e),o=e}}return t}async function*Zo(e,t){e instanceof Ko?yield*e.flush(t):e&&e.unixfs&&e.unixfs.isDirectory()&&(yield e)}var ei=async function*(e,t,n){let s=new qo({root:!0,dir:!0,path:"",dirty:!0,flat:!0},n);for await(const t of e)t&&(s=await Jo(t,s,n),t.unixfs&&t.unixfs.isDirectory()||(yield t));if(n.wrapWithDirectory)yield*Zo(s,t);else for await(const e of s.eachChildSeries())e&&(yield*Zo(e.child,t))};async function*ti(e,t,n={}){const s=ho(n);let r,o,i;r="function"==typeof n.dagBuilder?n.dagBuilder:Vo,o="function"==typeof n.treeBuilder?n.treeBuilder:ei,i=Symbol.asyncIterator in e||Symbol.iterator in e?e:[e];for await(const e of o(ao(r(i,t,s),s.fileImportConcurrency),t,s))yield{cid:e.cid,path:e.path,unixfs:e.unixfs,size:e.size}}var ni=n(4117),si=n(73394);const ri=e=>{if(e){if(e.startsWith("size-")){const t=e.split("-")[1],n=parseInt(t);if(isNaN(n))throw new Error("Chunker parameter size must be an integer");return{chunker:"fixed",maxChunkSize:n}}if(e.startsWith("rabin"))return{chunker:"rabin",...oi(e)};throw new Error(`Unrecognized chunker option: ${e}`)}return{chunker:"fixed"}},oi=e=>{const t={},n=e.split("-");switch(n.length){case 1:t.avgChunkSize=262144;break;case 2:t.avgChunkSize=ii(n[1],"avg");break;case 4:t.minChunkSize=ii(n[1],"min"),t.avgChunkSize=ii(n[2],"avg"),t.maxChunkSize=ii(n[3],"max");break;default:throw new Error('Incorrect chunker format (expected "rabin" "rabin-[avg]" or "rabin-[min]-[avg]-[max]"')}return t},ii=(e,t)=>{const n=parseInt(e);if(isNaN(n))throw new Error(`Chunker parameter ${t} must be an integer`);return n},ai=o.A.bind({ignoreUndefined:!0});function ci({repo:e,preload:t,hashers:n,options:s}){const r=s&&s.sharding;return St((async function*(s,o={}){const i=ai({shardSplitThreshold:r?1e3:1/0,strategy:"balanced"},o,{...ri(o.chunker)});i.hashAlg&&"sha2-256"!==i.hashAlg&&1!==i.cidVersion&&(i.cidVersion=1),i.trickle&&(i.strategy="trickle"),"trickle"===i.strategy&&(i.leafType="raw",i.reduceSingleLeafToSelf=!1),i.cidVersion>0&&void 0===i.rawLeaves&&(i.rawLeaves=!0),void 0!==i.hashAlg&&void 0===i.rawLeaves&&(i.rawLeaves=!0),delete i.trickle;const a={};if(i.progress){const e=i.progress;i.progress=(t,n)=>{a[n]||(a[n]=0),a[n]+=t,e(a[n],n)}}let c;null!=i.hashAlg&&(c=await n.getHasher(i.hashAlg));const l=no((d=s,(0,si.M)(d,ni.S)),(t=>ti(t,e.blocks,{...i,hasher:c,pin:!1})),function(e){async function*t(t){for await(const n of t){let t=n.cid;1===e.cidVersion&&(t=t.toV1());let s=n.path?n.path:t.toString();e.wrapWithDirectory&&!n.path&&(s=""),yield{path:s,cid:t,size:n.size,mode:n.unixfs&&n.unixfs.mode,mtime:n.unixfs&&n.unixfs.mtime}}}return t}(i),function(e,t){async function*n(n){for await(const s of n){(!s.path||t.wrapWithDirectory?""===s.path:!s.path.includes("/"))&&!t.onlyHash&&!1!==t.preload&&e(s.cid),yield s}}return n}(t,i),function(e,t){async function*n(n){for await(const s of n){const n=!(s.path&&s.path.includes("/"));(null==t.pin||t.pin)&&n&&!t.onlyHash&&await e.pins.pinRecursively(s.cid),yield s}}return n}(e,i));var d;const u=await e.gcLock.readLock();try{for await(const e of l){const t=e.path??e.cid.toString();delete a[t],yield{...e,path:t}}}finally{u()}}))}const li=l.Reader,di=l.Writer,ui=l.util,hi=l.roots["ipfs-unixfs"]||(l.roots["ipfs-unixfs"]={}),pi=hi.Data=(()=>{function e(e){if(this.blocksizes=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.Type=0,e.prototype.Data=ui.newBuffer([]),e.prototype.filesize=ui.Long?ui.Long.fromBits(0,0,!0):0,e.prototype.blocksizes=ui.emptyArray,e.prototype.hashType=ui.Long?ui.Long.fromBits(0,0,!0):0,e.prototype.fanout=ui.Long?ui.Long.fromBits(0,0,!0):0,e.prototype.mode=0,e.prototype.mtime=null,e.encode=function(e,t){if(t||(t=di.create()),t.uint32(8).int32(e.Type),null!=e.Data&&Object.hasOwnProperty.call(e,"Data")&&t.uint32(18).bytes(e.Data),null!=e.filesize&&Object.hasOwnProperty.call(e,"filesize")&&t.uint32(24).uint64(e.filesize),null!=e.blocksizes&&e.blocksizes.length)for(var n=0;n<e.blocksizes.length;++n)t.uint32(32).uint64(e.blocksizes[n]);return null!=e.hashType&&Object.hasOwnProperty.call(e,"hashType")&&t.uint32(40).uint64(e.hashType),null!=e.fanout&&Object.hasOwnProperty.call(e,"fanout")&&t.uint32(48).uint64(e.fanout),null!=e.mode&&Object.hasOwnProperty.call(e,"mode")&&t.uint32(56).uint32(e.mode),null!=e.mtime&&Object.hasOwnProperty.call(e,"mtime")&&hi.UnixTime.encode(e.mtime,t.uint32(66).fork()).ldelim(),t},e.decode=function(e,t){e instanceof li||(e=li.create(e));for(var n=void 0===t?e.len:e.pos+t,s=new hi.Data;e.pos<n;){var r=e.uint32();switch(r>>>3){case 1:s.Type=e.int32();break;case 2:s.Data=e.bytes();break;case 3:s.filesize=e.uint64();break;case 4:if(s.blocksizes&&s.blocksizes.length||(s.blocksizes=[]),2==(7&r))for(var o=e.uint32()+e.pos;e.pos<o;)s.blocksizes.push(e.uint64());else s.blocksizes.push(e.uint64());break;case 5:s.hashType=e.uint64();break;case 6:s.fanout=e.uint64();break;case 7:s.mode=e.uint32();break;case 8:s.mtime=hi.UnixTime.decode(e,e.uint32());break;default:e.skipType(7&r)}}if(!s.hasOwnProperty("Type"))throw ui.ProtocolError("missing required 'Type'",{instance:s});return s},e.fromObject=function(e){if(e instanceof hi.Data)return e;var t=new hi.Data;switch(e.Type){case"Raw":case 0:t.Type=0;break;case"Directory":case 1:t.Type=1;break;case"File":case 2:t.Type=2;break;case"Metadata":case 3:t.Type=3;break;case"Symlink":case 4:t.Type=4;break;case"HAMTShard":case 5:t.Type=5}if(null!=e.Data&&("string"==typeof e.Data?ui.base64.decode(e.Data,t.Data=ui.newBuffer(ui.base64.length(e.Data)),0):e.Data.length&&(t.Data=e.Data)),null!=e.filesize&&(ui.Long?(t.filesize=ui.Long.fromValue(e.filesize)).unsigned=!0:"string"==typeof e.filesize?t.filesize=parseInt(e.filesize,10):"number"==typeof e.filesize?t.filesize=e.filesize:"object"==typeof e.filesize&&(t.filesize=new ui.LongBits(e.filesize.low>>>0,e.filesize.high>>>0).toNumber(!0))),e.blocksizes){if(!Array.isArray(e.blocksizes))throw TypeError(".Data.blocksizes: array expected");t.blocksizes=[];for(var n=0;n<e.blocksizes.length;++n)ui.Long?(t.blocksizes[n]=ui.Long.fromValue(e.blocksizes[n])).unsigned=!0:"string"==typeof e.blocksizes[n]?t.blocksizes[n]=parseInt(e.blocksizes[n],10):"number"==typeof e.blocksizes[n]?t.blocksizes[n]=e.blocksizes[n]:"object"==typeof e.blocksizes[n]&&(t.blocksizes[n]=new ui.LongBits(e.blocksizes[n].low>>>0,e.blocksizes[n].high>>>0).toNumber(!0))}if(null!=e.hashType&&(ui.Long?(t.hashType=ui.Long.fromValue(e.hashType)).unsigned=!0:"string"==typeof e.hashType?t.hashType=parseInt(e.hashType,10):"number"==typeof e.hashType?t.hashType=e.hashType:"object"==typeof e.hashType&&(t.hashType=new ui.LongBits(e.hashType.low>>>0,e.hashType.high>>>0).toNumber(!0))),null!=e.fanout&&(ui.Long?(t.fanout=ui.Long.fromValue(e.fanout)).unsigned=!0:"string"==typeof e.fanout?t.fanout=parseInt(e.fanout,10):"number"==typeof e.fanout?t.fanout=e.fanout:"object"==typeof e.fanout&&(t.fanout=new ui.LongBits(e.fanout.low>>>0,e.fanout.high>>>0).toNumber(!0))),null!=e.mode&&(t.mode=e.mode>>>0),null!=e.mtime){if("object"!=typeof e.mtime)throw TypeError(".Data.mtime: object expected");t.mtime=hi.UnixTime.fromObject(e.mtime)}return t},e.toObject=function(e,t){t||(t={});var n={};if((t.arrays||t.defaults)&&(n.blocksizes=[]),t.defaults){if(n.Type=t.enums===String?"Raw":0,t.bytes===String?n.Data="":(n.Data=[],t.bytes!==Array&&(n.Data=ui.newBuffer(n.Data))),ui.Long){var s=new ui.Long(0,0,!0);n.filesize=t.longs===String?s.toString():t.longs===Number?s.toNumber():s}else n.filesize=t.longs===String?"0":0;if(ui.Long){s=new ui.Long(0,0,!0);n.hashType=t.longs===String?s.toString():t.longs===Number?s.toNumber():s}else n.hashType=t.longs===String?"0":0;if(ui.Long){s=new ui.Long(0,0,!0);n.fanout=t.longs===String?s.toString():t.longs===Number?s.toNumber():s}else n.fanout=t.longs===String?"0":0;n.mode=0,n.mtime=null}if(null!=e.Type&&e.hasOwnProperty("Type")&&(n.Type=t.enums===String?hi.Data.DataType[e.Type]:e.Type),null!=e.Data&&e.hasOwnProperty("Data")&&(n.Data=t.bytes===String?ui.base64.encode(e.Data,0,e.Data.length):t.bytes===Array?Array.prototype.slice.call(e.Data):e.Data),null!=e.filesize&&e.hasOwnProperty("filesize")&&("number"==typeof e.filesize?n.filesize=t.longs===String?String(e.filesize):e.filesize:n.filesize=t.longs===String?ui.Long.prototype.toString.call(e.filesize):t.longs===Number?new ui.LongBits(e.filesize.low>>>0,e.filesize.high>>>0).toNumber(!0):e.filesize),e.blocksizes&&e.blocksizes.length){n.blocksizes=[];for(var r=0;r<e.blocksizes.length;++r)"number"==typeof e.blocksizes[r]?n.blocksizes[r]=t.longs===String?String(e.blocksizes[r]):e.blocksizes[r]:n.blocksizes[r]=t.longs===String?ui.Long.prototype.toString.call(e.blocksizes[r]):t.longs===Number?new ui.LongBits(e.blocksizes[r].low>>>0,e.blocksizes[r].high>>>0).toNumber(!0):e.blocksizes[r]}return null!=e.hashType&&e.hasOwnProperty("hashType")&&("number"==typeof e.hashType?n.hashType=t.longs===String?String(e.hashType):e.hashType:n.hashType=t.longs===String?ui.Long.prototype.toString.call(e.hashType):t.longs===Number?new ui.LongBits(e.hashType.low>>>0,e.hashType.high>>>0).toNumber(!0):e.hashType),null!=e.fanout&&e.hasOwnProperty("fanout")&&("number"==typeof e.fanout?n.fanout=t.longs===String?String(e.fanout):e.fanout:n.fanout=t.longs===String?ui.Long.prototype.toString.call(e.fanout):t.longs===Number?new ui.LongBits(e.fanout.low>>>0,e.fanout.high>>>0).toNumber(!0):e.fanout),null!=e.mode&&e.hasOwnProperty("mode")&&(n.mode=e.mode),null!=e.mtime&&e.hasOwnProperty("mtime")&&(n.mtime=hi.UnixTime.toObject(e.mtime,t)),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,l.util.toJSONOptions)},e.DataType=function(){const e={},t=Object.create(e);return t[e[0]="Raw"]=0,t[e[1]="Directory"]=1,t[e[2]="File"]=2,t[e[3]="Metadata"]=3,t[e[4]="Symlink"]=4,t[e[5]="HAMTShard"]=5,t}(),e})(),fi=(hi.UnixTime=(()=>{function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.Seconds=ui.Long?ui.Long.fromBits(0,0,!1):0,e.prototype.FractionalNanoseconds=0,e.encode=function(e,t){return t||(t=di.create()),t.uint32(8).int64(e.Seconds),null!=e.FractionalNanoseconds&&Object.hasOwnProperty.call(e,"FractionalNanoseconds")&&t.uint32(21).fixed32(e.FractionalNanoseconds),t},e.decode=function(e,t){e instanceof li||(e=li.create(e));for(var n=void 0===t?e.len:e.pos+t,s=new hi.UnixTime;e.pos<n;){var r=e.uint32();switch(r>>>3){case 1:s.Seconds=e.int64();break;case 2:s.FractionalNanoseconds=e.fixed32();break;default:e.skipType(7&r)}}if(!s.hasOwnProperty("Seconds"))throw ui.ProtocolError("missing required 'Seconds'",{instance:s});return s},e.fromObject=function(e){if(e instanceof hi.UnixTime)return e;var t=new hi.UnixTime;return null!=e.Seconds&&(ui.Long?(t.Seconds=ui.Long.fromValue(e.Seconds)).unsigned=!1:"string"==typeof e.Seconds?t.Seconds=parseInt(e.Seconds,10):"number"==typeof e.Seconds?t.Seconds=e.Seconds:"object"==typeof e.Seconds&&(t.Seconds=new ui.LongBits(e.Seconds.low>>>0,e.Seconds.high>>>0).toNumber())),null!=e.FractionalNanoseconds&&(t.FractionalNanoseconds=e.FractionalNanoseconds>>>0),t},e.toObject=function(e,t){t||(t={});var n={};if(t.defaults){if(ui.Long){var s=new ui.Long(0,0,!1);n.Seconds=t.longs===String?s.toString():t.longs===Number?s.toNumber():s}else n.Seconds=t.longs===String?"0":0;n.FractionalNanoseconds=0}return null!=e.Seconds&&e.hasOwnProperty("Seconds")&&("number"==typeof e.Seconds?n.Seconds=t.longs===String?String(e.Seconds):e.Seconds:n.Seconds=t.longs===String?ui.Long.prototype.toString.call(e.Seconds):t.longs===Number?new ui.LongBits(e.Seconds.low>>>0,e.Seconds.high>>>0).toNumber():e.Seconds),null!=e.FractionalNanoseconds&&e.hasOwnProperty("FractionalNanoseconds")&&(n.FractionalNanoseconds=e.FractionalNanoseconds),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,l.util.toJSONOptions)},e})(),hi.Metadata=(()=>{function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.MimeType="",e.encode=function(e,t){return t||(t=di.create()),null!=e.MimeType&&Object.hasOwnProperty.call(e,"MimeType")&&t.uint32(10).string(e.MimeType),t},e.decode=function(e,t){e instanceof li||(e=li.create(e));for(var n=void 0===t?e.len:e.pos+t,s=new hi.Metadata;e.pos<n;){var r=e.uint32();if(r>>>3==1)s.MimeType=e.string();else e.skipType(7&r)}return s},e.fromObject=function(e){if(e instanceof hi.Metadata)return e;var t=new hi.Metadata;return null!=e.MimeType&&(t.MimeType=String(e.MimeType)),t},e.toObject=function(e,t){t||(t={});var n={};return t.defaults&&(n.MimeType=""),null!=e.MimeType&&e.hasOwnProperty("MimeType")&&(n.MimeType=e.MimeType),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,l.util.toJSONOptions)},e})(),pi),yi=["raw","directory","file","metadata","symlink","hamt-sharded-directory"],gi=["directory","hamt-sharded-directory"],mi=parseInt("0644",8),wi=parseInt("0755",8);function bi(e){if(null!=e)return"number"==typeof e?4095&e:"0"===(e=e.toString()).substring(0,1)?4095&parseInt(e,8):4095&parseInt(e,10)}function _i(e){if(null==e)return;let t;if(null!=e.secs&&(t={secs:e.secs,nsecs:e.nsecs}),null!=e.Seconds&&(t={secs:e.Seconds,nsecs:e.FractionalNanoseconds}),Array.isArray(e)&&(t={secs:e[0],nsecs:e[1]}),e instanceof Date){const n=e.getTime(),s=Math.floor(n/1e3);t={secs:s,nsecs:1e3*(n-1e3*s)}}if(Object.prototype.hasOwnProperty.call(t,"secs")){if(null!=t&&null!=t.nsecs&&(t.nsecs<0||t.nsecs>999999999))throw c(new Error("mtime-nsecs must be within the range [0,999999999]"),"ERR_INVALID_MTIME_NSECS");return t}}class Ei{static unmarshal(e){const t=fi.decode(e),n=fi.toObject(t,{defaults:!1,arrays:!0,longs:Number,objects:!1}),s=new Ei({type:yi[n.Type],data:n.Data,blockSizes:n.blocksizes,mode:n.mode,mtime:n.mtime?{secs:n.mtime.Seconds,nsecs:n.mtime.FractionalNanoseconds}:void 0});return s._originalMode=n.mode||0,s}constructor(e={type:"file"}){const{type:t,data:n,blockSizes:s,hashType:r,fanout:o,mtime:i,mode:a}=e;if(t&&!yi.includes(t))throw c(new Error("Type: "+t+" is not valid"),"ERR_INVALID_TYPE");this.type=t||"file",this.data=n,this.hashType=r,this.fanout=o,this.blockSizes=s||[],this._originalMode=0,this.mode=bi(a),i&&(this.mtime=_i(i),this.mtime&&!this.mtime.nsecs&&(this.mtime.nsecs=0))}set mode(e){this._mode=this.isDirectory()?wi:mi;const t=bi(e);void 0!==t&&(this._mode=t)}get mode(){return this._mode}isDirectory(){return Boolean(this.type&&gi.includes(this.type))}addBlockSize(e){this.blockSizes.push(e)}removeBlockSize(e){this.blockSizes.splice(e,1)}fileSize(){if(this.isDirectory())return 0;let e=0;return this.blockSizes.forEach((t=>{e+=t})),this.data&&(e+=this.data.length),e}marshal(){let e;switch(this.type){case"raw":e=fi.DataType.Raw;break;case"directory":e=fi.DataType.Directory;break;case"file":e=fi.DataType.File;break;case"metadata":e=fi.DataType.Metadata;break;case"symlink":e=fi.DataType.Symlink;break;case"hamt-sharded-directory":e=fi.DataType.HAMTShard;break;default:throw c(new Error("Type: "+e+" is not valid"),"ERR_INVALID_TYPE")}let t,n,s=this.data;if(this.data&&this.data.length||(s=void 0),null!=this.mode&&(t=4294963200&this._originalMode|(bi(this.mode)||0),t!==mi||this.isDirectory()||(t=void 0),t===wi&&this.isDirectory()&&(t=void 0)),null!=this.mtime){const e=_i(this.mtime);e&&(n={Seconds:e.secs,FractionalNanoseconds:e.nsecs},0===n.FractionalNanoseconds&&delete n.FractionalNanoseconds)}const r={Type:e,Data:s,filesize:this.isDirectory()?void 0:this.fileSize(),blocksizes:this.blockSizes,hashType:this.hashType,fanout:this.fanout,mode:t,mtime:n};return fi.encode(r).finish()}}const vi=async function(e){return(await lo.DK.encode(e)).slice(0,8).reverse()},Si=e=>e.toString(16).toUpperCase().padStart(2,"0").substring(0,2),ki=async(e,t,n,s,r)=>{if(!s){const e=(0,Go.T)({hashFn:vi});s={rootBucket:e,hamtDepth:1,lastBucket:e}}await((e,t,n)=>Promise.all(e.map((e=>{if(null==e.Name)throw new Error("Unexpected Link without a Name");if(2===e.Name.length){const s=parseInt(e.Name,16);return t._putObjectAt(s,new Go.f({hash:n._options.hash,bits:n._options.bits},t,s))}return n.put(e.Name.substring(2),!0)}))))(e.Links,s.lastBucket,s.rootBucket);const o=await s.rootBucket._findNewBucketAndPos(t);let i=Si(o.pos);const a=(e=>{let t=e.bucket;const n=[];for(;t._parent;)n.push(t),t=t._parent;return n.push(t),n.reverse()})(o);a.length>s.hamtDepth&&(s.lastBucket=a[s.hamtDepth],i=Si(s.lastBucket._posAtParent));const c=e.Links.find((e=>{if(null==e.Name)return!1;const n=e.Name.substring(0,2),s=e.Name.substring(2);return n===i&&(!s||s===t)}));if(!c)return null;if(null!=c.Name&&c.Name.substring(2)===t)return c.Hash;s.hamtDepth++;const l=await n.get(c.Hash,r);return e=(0,S.decode)(l),ki(e,t,n,s,r)};var Ri=ki;var Ti=function(e,t,n,s){const r=t+e.length;return n>=r||s<t?new Uint8Array(0):(s>=t&&s<r&&(e=e.subarray(0,s-t)),n>=t&&n<r&&(e=e.subarray(n-t)),e)};var Ii=(e,t,n)=>{if(t||(t=0),t<0)throw c(new Error("Offset must be greater than or equal to 0"),"ERR_INVALID_PARAMS");if(t>e)throw c(new Error("Offset must be less than the file size"),"ERR_INVALID_PARAMS");if(n||0===n||(n=e-t),n<0)throw c(new Error("Length must be greater than or equal to 0"),"ERR_INVALID_PARAMS");return t+n>e&&(n=e-t),{offset:t,length:n}};const Pi=(...e)=>{let t;for(;e.length>0;)t=e.shift()(t);return t},Ai=e=>null!=e&&("function"==typeof e[Symbol.asyncIterator]||"function"==typeof e[Symbol.iterator]||"function"==typeof e.next),Di=e=>null!=e&&"function"==typeof e.sink&&Ai(e.source),Oi=e=>t=>{const n=e.sink(t);if(null!=n.then){const t=(0,Yn.N)({objectMode:!0});n.then((()=>{t.end()}),(e=>{t.end(e)}));const s=async function*(){yield*e.source,t.end()};return(0,Qr.A)(t,s())}return e.source};async function Ni(e,t,n,s,r,o,i,a){if(t instanceof Uint8Array)return void n.push(Ti(t,s,r,o));if(null==t.Data)throw c(new Error("no data in PBNode"),"ERR_NOT_UNIXFS");let l;try{l=Ei.unmarshal(t.Data)}catch(e){throw c(e,"ERR_NOT_UNIXFS")}if(null!=l.data){const e=l.data,t=Ti(e,s,r,o);n.push(t),s+=t.byteLength}const d=[];for(let e=0;e<t.Links.length;e++){const n=t.Links[e],i=s,a=i+l.blockSizes[e];if((r>=i&&r<a||o>=i&&o<=a||r<i&&o>a)&&d.push({link:n,blockStart:s}),(s=a)>o)break}await function(e,...t){if(Di(e)){const t=e;e=()=>t.source}else if(Ai(e)){const t=e;e=()=>t}const n=[e,...t];if(n.length>1&&Di(n[n.length-1])&&(n[n.length-1]=n[n.length-1].sink),n.length>2)for(let e=1;e<n.length-1;e++)Di(n[e])&&(n[e]=Oi(n[e]));return Pi(...n)}(d,(t=>(0,Xr.A)(t,(t=>async()=>{const n=await e.get(t.link.Hash,{signal:a.signal});return{...t,block:n}}))),(e=>(0,Yr.A)(e,{ordered:!0})),(async t=>{for await(const{link:s,block:l,blockStart:d}of t){let t;switch(s.Hash.code){case S.code:t=S.decode(l);break;case Po.code:t=l;break;default:return void n.end(c(new Error(`Unsupported codec: ${s.Hash.code}`),"ERR_NOT_UNIXFS"))}i.add((async()=>{await Ni(e,t,n,d,r,o,i,a)}))}}))}var Li=(e,t,n,s,r,o,i)=>async function*(e={}){const s=n.fileSize();if(void 0===s)throw new Error("File was a directory");const{offset:r,length:o}=Ii(s,e.offset,e.length);if(0===o)return;const a=new Ct.A({concurrency:1}),c=(0,Yn.N)();a.add((async()=>{await Ni(i,t,c,0,r,r+o,a,e)})),a.on("error",(e=>{c.end(e)}));let l=0;for await(const e of c)null!=e&&(l+=e.byteLength,l===o&&c.end(),yield e)};var Mi=(e,t,n,s,r,o,i)=>async function*(e={}){const n=e.offset||0,a=e.length||t.Links.length,c=t.Links.slice(n,a);for(const t of c){const n=await r(t.Hash,t.Name||"",`${s}/${t.Name||""}`,[],o+1,i,e);n.entry&&(yield n.entry)}};async function*Ci(e,t,n,s,r,o){const i=e.Links;for(const a of i){const i=null!=a.Name?a.Name.substring(2):null;if(i){const e=await n(a.Hash,i,`${t}/${i}`,[],s+1,r,o);yield e.entry}else{const i=await r.get(a.Hash);e=(0,S.decode)(i);for await(const i of Ci(e,t,n,s,r,o))yield i}}}var xi=(e,t,n,s,r,o,i)=>function(e={}){return Ci(t,s,r,o,i,e)};const Bi={raw:Li,file:Li,directory:Mi,"hamt-sharded-directory":xi,metadata:(e,t,n,s,r,o,i)=>()=>[],symlink:(e,t,n,s,r,o,i)=>()=>[]};var zi=async(e,t,n,s,r,o,i,a)=>{const l=await i.get(e,a),d=(0,S.decode)(l);let u,h;if(t||(t=e.toString()),null==d.Data)throw c(new Error("no data in PBNode"),"ERR_NOT_UNIXFS");try{u=Ei.unmarshal(d.Data)}catch(e){throw c(e,"ERR_NOT_UNIXFS")}if(n||(n=t),s.length){let e;if(e=u&&"hamt-sharded-directory"===u.type?await Ri(d,s[0],i):((e,t)=>{const n=e.Links.find((e=>e.Name===t));return n&&n.Hash})(d,s[0]),!e)throw c(new Error("file does not exist"),"ERR_NOT_FOUND");const t=s.shift();h={cid:e,toResolve:s,name:t||"",path:`${n}/${t}`}}return{entry:{type:u.isDirectory()?"directory":"file",name:t,path:n,cid:e,content:Bi[u.type](e,d,u,n,r,o,i),unixfs:u,depth:o,node:d,size:u.fileSize()},next:h}};var Ui=async(e,t,n,s,r,o,i,a)=>{if(s.length)throw c(new Error(`No link named ${n} found in raw node ${e}`),"ERR_NOT_FOUND");const l=await i.get(e,a);return{entry:{type:"raw",name:t,path:n,cid:e,content:(d=l,async function*(e={}){const{offset:t,length:n}=Ii(d.length,e.offset,e.length);yield Ti(d,0,t,t+n)}),depth:o,size:l.length,node:l}};var d};var Fi=async(e,t,n,s,r,o,i,a)=>{const l=await i.get(e),d=k.decode(l);let u=d,h=n;for(;s.length;){const r=s[0];if(!(r in u))throw c(new Error(`No property named ${r} found in cbor node ${e}`),"ERR_NO_PROP");{s.shift(),h=`${h}/${r}`;const i=J.TO.asCID(u[r]);if(i)return{entry:{type:"object",name:t,path:n,cid:e,node:l,depth:o,size:l.length,content:async function*(){yield d}},next:{cid:i,name:r,path:h,toResolve:s}};u=u[r]}}return{entry:{type:"object",name:t,path:n,cid:e,node:l,depth:o,size:l.length,content:async function*(){yield d}}}};var ji=async(e,t,n,s,r,o,i,a)=>{if(s.length)throw c(new Error(`No link named ${n} found in raw node ${e}`),"ERR_NOT_FOUND");const l=await F.D4(e.multihash.bytes);return{entry:{type:"identity",name:t,path:n,cid:e,content:(d=l.digest,async function*(e={}){const{offset:t,length:n}=Ii(d.length,e.offset,e.length);yield Ti(d,0,t,t+n)}),depth:o,size:l.digest.length,node:l.digest}};var d};const Hi={[S.code]:zi,[Po.code]:Ui,[k.code]:Fi,[I.identity.code]:ji};var $i=function e(t,n,s,r,o,i,a){const l=Hi[t.code];if(!l)throw c(new Error(`No resolver for code ${t.code}`),"ERR_NO_RESOLVER");return l(t,n,s,r,e,o,i,a)};const Vi=e=>{if(e instanceof Uint8Array)return{cid:J.TO.decode(e),toResolve:[]};const t=J.TO.asCID(e);if(t)return{cid:t,toResolve:[]};if("string"==typeof e){0===e.indexOf("/ipfs/")&&(e=e.substring(6));const t=((e="")=>(e.trim().match(/([^\\^/]|\\\/)+/g)||[]).filter(Boolean))(e);return{cid:J.TO.parse(t[0]),toResolve:t.slice(1)}}throw c(new Error(`Unknown path type ${e}`),"ERR_BAD_PATH")};async function*Ki(e,t,n={}){let{cid:s,toResolve:r}=Vi(e),o=s.toString(),i=o;const a=r.length;for(;;){const l=await $i(s,o,i,r,a,t,n);if(!l.entry&&!l.next)throw c(new Error(`Could not resolve ${e}`),"ERR_NOT_FOUND");if(l.entry&&(yield l.entry),!l.next)return;r=l.next.toResolve,s=l.next.cid,o=l.next.name,i=l.next.path}}async function qi(e,t,n={}){const s=await(0,Vt.A)(Ki(e,t,n));if(!s)throw c(new Error(`Could not resolve ${e}`),"ERR_NOT_FOUND");return s}async function*Gi(e,t,n={}){const s=await qi(e,t,n);if(s&&(yield s,"directory"===s.type))for await(const e of async function*e(t,n){for await(const s of t.content(n))yield s,s instanceof Uint8Array||"directory"===s.type&&(yield*e(s,n))}(s,n))yield e}"0".charCodeAt(0),(0,x.s)("ustar\0","binary"),(0,x.s)("ustar ","binary"),(0,x.s)(" \0","binary");var Wi=n(22845);var Yi=n(22604);async function Xi(e){let t=new Uint8Array(0);for await(const n of e)t=(0,ee.x)([t,n],t.length+n.length);return t}const Qi="0".charCodeAt(0),Ji=(0,x.s)("ustar\0","binary"),Zi=(0,x.s)("00","binary"),ea=parseInt("7777",8),ta=257,na=263,sa=function(e){switch(e){case"file":default:return 0;case"link":return 1;case"symlink":return 2;case"character-device":return 3;case"block-device":return 4;case"directory":return 5;case"fifo":return 6;case"contiguous-file":return 7;case"pax-header":return 72}},ra=function(e){let t=256;for(let n=0;n<148;n++)t+=e[n];for(let n=156;n<512;n++)t+=e[n];return t},oa=function(e,t){const n=e.toString(8);return n.length>t?(0,x.s)("7777777777777777777".slice(0,t)+" "):(0,x.s)("0000000000000000000".slice(0,t-n.length)+n+" ")},ia=function(e){const t=(0,x.s)(e).byteLength;let n=Math.floor(Math.log(t)/Math.log(10))+1;return t+n>=Math.pow(10,n)&&n++,`${t+n}${e}`};function aa(e){const t=new Uint8Array(512);let n=e.name,s="";if(5===e.typeflag&&"/"!==n[n.length-1]&&(n+="/"),(0,x.s)(n).byteLength!==n.length)return null;for(;(0,x.s)(n).byteLength>100;){const e=n.indexOf("/");if(-1===e)return null;s+=""!==s?"/"+n.slice(0,e):n.slice(0,e),n=n.slice(e+1)}return(0,x.s)(n).byteLength>100||(0,x.s)(s).byteLength>155||null!=e.linkname&&(0,x.s)(e.linkname).byteLength>100?null:(t.set((0,x.s)(n),0),t.set(oa(e.mode&ea,6),100),t.set(oa(e.uid,6),108),t.set(oa(e.gid,6),116),t.set(oa(e.size,11),124),t.set(oa(e.mtime.getTime()/1e3|0,11),136),t[156]=Qi+sa(e.type),null!=e.linkname&&t.set((0,x.s)(e.linkname),157),t.set(Ji,ta),t.set(Zi,na),null!=e.uname&&t.set((0,x.s)(e.uname),265),null!=e.gname&&t.set((0,x.s)(e.gname),297),t.set(oa(e.devmajor??0,6),329),t.set(oa(e.devminor??0,6),337),null!=s&&t.set((0,x.s)(s),345),t.set(oa(ra(t),6),148),t)}const{S_IFMT:ca,S_IFBLK:la,S_IFCHR:da,S_IFDIR:ua,S_IFIFO:ha,S_IFLNK:pa}=Yi,fa=parseInt("755",8),ya=parseInt("644",8),ga=new Uint8Array(1024);function ma(e=0){switch(e&ca){case la:return"block-device";case da:return"character-device";case ua:return"directory";case ha:return"fifo";case pa:return"symlink";default:return"file"}}function wa(e){return 0!==(e&=511)?ga.subarray(0,512-e):new Uint8Array(0)}function ba(e){if(null==e.pax){const t=aa(e);if(null!=t)return t}return function(e){const t=function(e){let t="";null!=e.name&&(t+=ia(" path="+e.name+"\n")),null!=e.linkname&&(t+=ia(" linkpath="+e.linkname+"\n"));const n=e.pax;if(null!=n)for(const e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t+=ia(" "+e+"="+n[e]+"\n"));return(0,x.s)(t)}(e),n={name:"PaxHeader",mode:e.mode,uid:e.uid,gid:e.gid,size:t.length,mtime:e.mtime,type:"pax-header",linkname:e.linkname,uname:e.uname,gname:e.gname,devmajor:e.devmajor,devminor:e.devminor};return new zo.I(aa(n)??new Uint8Array(0),t,wa(t.length),aa({...n,size:e.size,type:e.type})??new Uint8Array(0)).subarray()}(e)}function _a(){return async function*(e){for await(let{header:t,body:n}of e){const e={...t,size:"symlink"===t.type?0:t.size??0,type:t.type??ma(t.mode),mode:t.mode??("directory"===t.type?fa:ya),uid:t.uid??0,gid:t.gid??0,mtime:t.mtime??new Date};if("string"==typeof n&&(n=(0,x.s)(n)),n instanceof Uint8Array||(0,zo.S)(n)){e.size=n.length,yield ba(e),yield(0,zo.S)(n)?n.subarray():n,yield wa(e.size);continue}if("symlink"===e.type&&null==e.linkname){if(null==n)throw new Error("type was symlink but no linkname or body specified");e.linkname=(0,$.d)(await Xi(n)),yield ba(e);continue}if(yield ba(e),"file"!==e.type&&"contiguous-file"!==e.type)continue;let s=0;for await(const e of n??[])s+=e.length,yield(0,zo.S)(e)?e.subarray():e;if(s!==e.size)throw new Error(`size mismatch, wrote ${s} of ${e.size} bytes`);yield wa(e.size)}yield ga}}var Ea=n(75616);class va{constructor({preload:e,repo:t,hashers:n,options:s}){const r=ci({preload:e,repo:t,options:s,hashers:n});this.addAll=r,this.add=function({addAll:e}){return async function(t,n={}){const s=await(0,Vt.A)(e((0,oo.n)(t),n));if(null==s)throw Error("Failed to add a file, if you see this please report a bug");return s}}({addAll:r}),this.cat=function({repo:e,preload:t}){return St((async function*(n,s={}){if(n=Pt(n),!1!==s.preload){const e=n.split("/");t(J.TO.parse(e[0]))}const r=await qi(n,e.blocks,s);if("directory"===r.type)throw new Error("this dag node is a directory");if(!r.content)throw new Error("this dag node has no content");yield*r.content(s)}))}({repo:t,preload:e}),this.get=function({repo:e,preload:t}){return St((async function*(n,s={}){if(null!=s.compressionLevel&&(s.compressionLevel<-1||s.compressionLevel>9))throw c(new Error("Compression level must be between -1 and 9"),"ERR_INVALID_PARAMS");if(!1!==s.preload){let e;try{e=Pt(n).split("/")}catch(e){throw c(e,"ERR_INVALID_PATH")}t(J.TO.parse(e[0]))}const r=J.TO.asCID(n)||n,o=await qi(r,e.blocks,s);if("file"===o.type||"raw"===o.type){const e=[];return s.compress&&!0!==s.archive?e.push(o.content):e.push([{header:{name:o.path,mode:"file"===o.type&&o.unixfs.mode,mtime:"file"===o.type&&o.unixfs.mtime?new Date(1e3*o.unixfs.mtime.secs):void 0,size:o.size,type:"file"},body:o.content()}],_a()),s.compress&&e.push((async function*(e){const t=await Xi(e);yield Ea.Ay.gzip(t,{level:s.compressionLevel||6})})),void(yield*no(...e))}if("directory"!==o.type)throw c(new Error("Not a UnixFS node"),"ERR_NOT_UNIXFS");{const t=[Gi(r,e.blocks,s),async function*(e){for await(const t of e){const e={header:{name:t.path,size:t.size}};if("file"===t.type)e.header.type="file",e.header.mode=null!=t.unixfs.mode?t.unixfs.mode:void 0,e.header.mtime=t.unixfs.mtime?new Date(1e3*t.unixfs.mtime.secs):void 0,e.body=t.content();else if("raw"===t.type)e.header.type="file",e.body=t.content();else{if("directory"!==t.type)throw c(new Error("Not a UnixFS node"),"ERR_NOT_UNIXFS");e.header.type="directory",e.header.mode=null!=t.unixfs.mode?t.unixfs.mode:void 0,e.header.mtime=t.unixfs.mtime?new Date(1e3*t.unixfs.mtime.secs):void 0}yield e}},_a()];if(s.compress){if(!s.archive)throw c(new Error("file is not regular"),"ERR_INVALID_PATH");s.compress&&t.push((async function*(e){const t=await Xi(e);yield Ea.Ay.gzip(t,{level:s.compressionLevel||6})}))}yield*no(...t)}}))}({repo:t,preload:e}),this.ls=function({repo:e,preload:t}){return St((async function*(n,s={}){const r=Pt(n),o=r.split("/");!1!==s.preload&&t(J.TO.parse(o[0]));const i=J.TO.asCID(r)||r,a=await qi(i,e.blocks,s);if("file"!==a.type){if("directory"!==a.type)throw c(new Error(`Unknown UnixFS type ${a.type}`),"ERR_UNKNOWN_UNIXFS_TYPE");for await(const e of a.content())yield Dt(e)}else yield Dt(a)}))}({repo:t,preload:e})}}const Sa="0.18.0";const ka=(0,a.vF)("ipfs:components:id");function Ra({peerId:e,network:t}){return St((async function(n={}){const s=t.try();if(!s){if(n.peerId)throw new N;if(null==e.publicKey)throw c(new Error("Public key missing"),"ERR_MISSING_PUBLIC_KEY");return{id:e,publicKey:(0,$.d)(e.publicKey,"base64pad"),addresses:[],agentVersion:`js-ipfs/${Sa}`,protocolVersion:"9000",protocols:[]}}const{libp2p:r}=s,o=n.peerId?n.peerId:e,i=await async function(e,t,n){let s=await t.peerStore.get(e);s||(s=await async function(e,t,n){if(null==t.dht)throw c(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");for await(const s of t.dht.findPeer(e,n))if("FINAL_PEER"===s.name)break;const s=await t.peerStore.get(e);if(!s)throw c(new Error("Could not find peer"),"ERR_NOT_FOUND");return s}(e,t,n));let r=e.publicKey?e.publicKey:await t.peerStore.keyBook.get(e);if(null==r)try{r=await t.getPublicKey(e,n)}catch(t){ka.error("Could not load public key for",e.toString(),t)}return{...s,publicKey:r,metadata:s.metadata||new Map,addresses:s.addresses.map((e=>e.multiaddr))}}(o,r,n),a=(0,$.d)(i.metadata.get("AgentVersion")||new Uint8Array),l=(0,$.d)(i.metadata.get("ProtocolVersion")||new Uint8Array),d=i.id.toString();return{id:o,publicKey:i.publicKey?(0,$.d)(i.publicKey,"base64pad"):"",addresses:(i.addresses||[]).map((e=>{const t=e.toString();return t.endsWith(`/p2p/${d}`)?t:`${t}/p2p/${d}`})).sort().map((e=>(0,j.HZ)(e))),agentVersion:a,protocolVersion:l,protocols:(i.protocols||[]).sort()}}))}var Ta=function(e,t,n){var s,r,o;Array.isArray(t)&&(s=t.slice(0));"string"==typeof t&&(s=t.split("."));"symbol"==typeof t&&(s=[t]);if(!Array.isArray(s))throw new Error("props arg must be an array, a string or a symbol");if(!(r=s.pop()))return!1;Ia(r);for(;o=s.shift();)if(Ia(o),void 0===e[o]&&(e[o]={}),!(e=e[o])||"object"!=typeof e)return!1;return e[r]=n,!0};function Ia(e){if("__proto__"==e||"constructor"==e||"prototype"==e)throw new Error("setting of prototype values not supported")}const Pa={server:{description:"Recommended for nodes with public IPv4 address (servers, VPSes, etc.), disables host and content discovery and UPnP in local networks.",transform:e=>(Ta(e,"Discovery.MDNS.Enabled",!1),Ta(e,"Discovery.webRTCStar.Enabled",!1),e.Swarm={...e.Swarm||{},DisableNatPortMap:!0},e)},"local-discovery":{description:"Sets default values to fields affected by `server` profile, enables discovery and UPnP in local networks.",transform:e=>(Ta(e,"Discovery.MDNS.Enabled",!0),Ta(e,"Discovery.webRTCStar.Enabled",!0),Ta(e,"Swarm",{...e.Swarm||{},DisableNatPortMap:!1}),e)},test:{description:"Reduces external interference, useful for running ipfs in test environments. Note that with these settings node won't be able to talk to the rest of the network without manual bootstrap.",transform:e=>{const t=Gr();return Ta(e,"Addresses.API",t.Addresses.API?"/ip4/127.0.0.1/tcp/0":""),Ta(e,"Addresses.Gateway",t.Addresses.Gateway?"/ip4/127.0.0.1/tcp/0":""),Ta(e,"Addresses.Swarm",t.Addresses.Swarm.length?["/ip4/127.0.0.1/tcp/0"]:[]),Ta(e,"Addresses.Delegates",[]),Ta(e,"Bootstrap",[]),Ta(e,"Discovery.MDNS.Enabled",!1),Ta(e,"Discovery.webRTCStar.Enabled",!1),Ta(e,"Swarm",{...e.Swarm||{},DisableNatPortMap:!0}),e}},"default-networking":{description:"Restores default network settings. Inverse profile of the `test` profile.",transform:e=>{const t=Gr();return Ta(e,"Addresses.API",t.Addresses.API),Ta(e,"Addresses.Gateway",t.Addresses.Gateway),Ta(e,"Addresses.Swarm",t.Addresses.Swarm),Ta(e,"Addresses.Delegates",t.Addresses.Delegates),Ta(e,"Bootstrap",t.Bootstrap),Ta(e,"Discovery.MDNS.Enabled",t.Discovery.MDNS.Enabled),Ta(e,"Discovery.webRTCStar.Enabled",t.Discovery.webRTCStar.Enabled),Ta(e,"Swarm",{...e.Swarm||{},DisableNatPortMap:!1}),e}},lowpower:{description:"Reduces daemon overhead on the system. May affect node functionality,performance of content discovery and data fetching may be degraded. Recommended for low power systems.",transform:e=>{const t=e.Swarm||{},n=t.ConnMgr||{};return n.LowWater=20,n.HighWater=40,t.ConnMgr=n,e.Swarm=t,e}},"default-power":{description:'Inverse of "lowpower" profile.',transform:e=>{const t=Gr();return e.Swarm=t.Swarm,e}}},Aa=(0,a.vF)("ipfs:core:config");async function Da(e){return Object.keys(Pa).map((e=>({name:e,description:Pa[e].description})))}var Oa=n(89103),Na=n(32669);function La(e){const t=(0,k.encode)({version:1,roots:e}),n=Na.encode(t.length),s=new Uint8Array(n.length+t.length);return s.set(n,0),s.set(t,n.length),s}function Ma(){}const Ca={Null:e=>null===e,Int:e=>Number.isInteger(e),Float:e=>"number"==typeof e&&Number.isFinite(e),String:e=>"string"==typeof e,Bool:e=>"boolean"==typeof e,Bytes:e=>e instanceof Uint8Array,Link:e=>!Ca.Null(e)&&"object"==typeof e&&e.asCID===e,List:e=>Array.isArray(e),Map:e=>!Ca.Null(e)&&"object"==typeof e&&e.asCID!==e&&!Ca.List(e)&&!Ca.Bytes(e)},xa={Int:Ca.Int,"CarHeader > version":e=>xa.Int(e),"CarHeader > roots (anon) > valueType (anon)":Ca.Link,"CarHeader > roots (anon)":e=>Ca.List(e)&&Array.prototype.every.call(e,xa["CarHeader > roots (anon) > valueType (anon)"]),"CarHeader > roots":e=>xa["CarHeader > roots (anon)"](e),CarHeader:e=>{const t=e&&Object.keys(e);return Ca.Map(e)&&["version"].every((e=>t.includes(e)))&&Object.entries(e).every((([e,t])=>xa["CarHeader > "+e]&&xa["CarHeader > "+e](t)))}},Ba=xa.CarHeader,za={SHA2_256:18,LENGTH:32,DAG_PB:112},Ua=40;function Fa(e,t){if(!e.length)throw new Error("Unexpected end of data");const n=Na.decode(e);return t.seek(Na.decode.bytes),n}async function ja(e,t){const n=Fa(await e.upTo(8),e);if(0===n)throw new Error("Invalid CAR header (zero length)");const s=await e.exactly(n,!0),r=(0,k.decode)(s);if(!Ba(r))throw new Error("Invalid CAR header format");if(1!==r.version&&2!==r.version||void 0!==t&&r.version!==t)throw new Error(`Invalid CAR version: ${r.version}${void 0!==t?` (expected ${t})`:""}`);const o=Array.isArray(r.roots);if(1===r.version&&!o||2===r.version&&o)throw new Error("Invalid CAR header format");if(1===r.version)return r;const i=function(e){const t=new DataView(e.buffer,e.byteOffset,e.byteLength);let n=0;return{version:2,characteristics:[t.getBigUint64(n,!0),t.getBigUint64(n+=8,!0)],dataOffset:Number(t.getBigUint64(n+=8,!0)),dataSize:Number(t.getBigUint64(n+=8,!0)),indexOffset:Number(t.getBigUint64(n+=8,!0))}}(await e.exactly(Ua,!0));e.seek(i.dataOffset-e.pos);const a=await ja(e,1);return Object.assign(a,i)}async function Ha(e){const t=await e.exactly(2,!1);if(t[0]===za.SHA2_256&&t[1]===za.LENGTH){const t=await e.exactly(34,!0),n=F.D4(t);return J.TO.create(0,za.DAG_PB,n)}const n=Fa(await e.upTo(8),e);if(1!==n)throw new Error(`Unexpected CID version (${n})`);const s=Fa(await e.upTo(8),e),r=await e.exactly(function(e){Na.decode(e);const t=Na.decode.bytes,n=Na.decode(e.subarray(Na.decode.bytes));return t+Na.decode.bytes+n}(await e.upTo(8)),!0),o=F.D4(r);return J.TO.create(n,s,o)}async function $a(e){const t=e.pos;let n=Fa(await e.upTo(8),e);if(0===n)throw new Error("Invalid CAR section (zero length)");n+=e.pos-t;return{cid:await Ha(e),length:n,blockLength:n-Number(e.pos-t)}}async function Va(e){const{cid:t,blockLength:n}=await $a(e);return{bytes:await e.exactly(n,!0),cid:t}}async function Ka(e){const t=e.pos,{cid:n,length:s,blockLength:r}=await $a(e),o={cid:n,length:s,blockLength:r,offset:t,blockOffset:e.pos};return e.seek(o.blockLength),o}function qa(e){const t=(async()=>{const t=await ja(e);if(2===t.version){const n=e.pos-t.dataOffset;e=function(e,t){let n=0;return{async upTo(s){let r=await e.upTo(s);return r.length+n>t&&(r=r.subarray(0,t-n)),r},async exactly(s,r=!1){const o=await e.exactly(s,r);if(o.length+n>t)throw new Error("Unexpected end of data");return r&&(n+=s),o},seek(t){n+=t,e.seek(t)},get pos(){return e.pos}}}(e,t.dataSize-n)}return t})();return{header:()=>t,async*blocks(){for(await t;(await e.upTo(8)).length>0;)yield await Va(e)},async*blocksIndex(){for(await t;(await e.upTo(8)).length>0;)yield await Ka(e)}}}function Ga(e){let t=0;return{upTo:async n=>e.subarray(t,t+Math.min(n,e.length-t)),async exactly(n,s=!1){if(n>e.length-t)throw new Error("Unexpected end of data");const r=e.subarray(t,t+n);return s&&(t+=n),r},seek(e){t+=e},get pos(){return t}}}function Wa(e){const t=e[Symbol.asyncIterator]();return function(e){let t=0,n=0,s=0,r=new Uint8Array(0);const o=async t=>{n=r.length-s;const o=[r.subarray(s)];for(;n<t;){const t=await e();if(null==t)break;n<0?t.length>n&&o.push(t.subarray(-n)):o.push(t),n+=t.length}r=new Uint8Array(o.reduce(((e,t)=>e+t.length),0));let i=0;for(const e of o)r.set(e,i),i+=e.length;s=0};return{upTo:async e=>(r.length-s<e&&await o(e),r.subarray(s,s+Math.min(r.length-s,e))),async exactly(e,n=!1){if(r.length-s<e&&await o(e),r.length-s<e)throw new Error("Unexpected end of data");const i=r.subarray(s,s+e);return n&&(t+=e,s+=e),i},seek(e){t+=e,s+=e},get pos(){return t}}}((async function(){const e=await t.next();return e.done?null:e.value}))}class Ya{constructor(e,t){this._encoder=t,this._mutex=t.setRoots(e),this._ended=!1}async put(e){if(!(e.bytes instanceof Uint8Array&&e.cid))throw new TypeError("Can only write {cid, bytes} objects");if(this._ended)throw new Error("Already closed");const t=J.TO.asCID(e.cid);if(!t)throw new TypeError("Can only write {cid, bytes} objects");return this._mutex=this._mutex.then((()=>this._encoder.writeBlock({cid:t,bytes:e.bytes}))),this._mutex}async close(){if(this._ended)throw new Error("Already closed");return await this._mutex,this._ended=!0,this._encoder.close()}static create(e){e=function(e){if(void 0===e)return[];if(!Array.isArray(e)){const t=J.TO.asCID(e);if(!t)throw new TypeError("roots must be a single CID or an array of CIDs");return[t]}const t=[];for(const n of e){const e=J.TO.asCID(n);if(!e)throw new TypeError("roots must be a single CID or an array of CIDs");t.push(e)}return t}(e);const{encoder:t,iterator:n}=Qa();return{writer:new Ya(e,t),out:new Xa(n)}}static createAppender(){const{encoder:e,iterator:t}=Qa();e.setRoots=()=>Promise.resolve();return{writer:new Ya([],e),out:new Xa(t)}}static async updateRootsInBytes(e,t){const n=Ga(e);await ja(n);const s=La(t);if(Number(n.pos)!==s.length)throw new Error(`updateRoots() can only overwrite a header of the same length (old header is ${n.pos} bytes, new header is ${s.length} bytes)`);return e.set(s,0),e}}class Xa{constructor(e){this._iterator=e}[Symbol.asyncIterator](){if(this._iterating)throw new Error("Multiple iterator not supported");return this._iterating=!0,this._iterator}}function Qa(){const e=function(){const e=[];let t=null,n=Ma,s=!1,r=null,o=Ma;const i=()=>(t||(t=new Promise((e=>{n=()=>{t=null,n=Ma,e()}}))),t),a={write(t){e.push(t);const n=i();return o(),n},async end(){s=!0;const e=i();o(),await e}},c={async next(){const t=e.shift();return t?(0===e.length&&n(),{done:!1,value:t}):s?(n(),{done:!0,value:void 0}):(r||(r=new Promise((e=>{o=()=>(r=null,o=Ma,e(c.next()))}))),r)}};return{writer:a,iterator:c}}(),{writer:t,iterator:n}=e,s=function(e){return{async setRoots(t){const n=La(t);await e.write(n)},async writeBlock(t){const{cid:n,bytes:s}=t;await e.write(new Uint8Array(Na.encode(n.bytes.length+s.length))),await e.write(n.bytes),s.length&&await e.write(s)},async close(){await e.end()}}}(t);return{encoder:s,iterator:n}}var Ja=n(20628),Za=n(3796);const ec=(0,a.vF)("ipfs:components:dag:import"),tc=[Po.code,Ja.code];function nc({repo:e,preload:t,codecs:n}){return St((async function*(s,r={}){!1!==r.preload&&t(s);const o=J.TO.asCID(s);if(!o)throw new Error(`Unexpected error converting CID type: ${s}`);ec(`Exporting ${o} as car`);const{writer:i,out:a}=await Ya.create([o]);let c=null;(async()=>{try{const t=function(e,t,n,s){return async r=>{const o=await s.getCodec(r.code);if(!o)throw new Error(`Can't decode links in block with codec 0x${r.code.toString(16)} to form complete DAG`);const i=await e.blocks.get(r,n);return ec(`Adding block ${r} to car`),await t.put({cid:r,bytes:i}),tc.includes(r.code)?null:(0,Oa.Lu)({bytes:i,cid:r,codec:o})}}(e,i,{signal:r.signal,timeout:r.timeout},n);await(0,Za.G)({cid:o,load:t})}catch(e){c=e}finally{i.close()}})();for await(const e of a){if(c)break;yield e}if(c)throw c}))}var sc=n(89230);class rc{constructor(e,t,n){this._version=e,this._roots=t,this._iterable=n,this._decoded=!1}get version(){return this._version}async getRoots(){return this._roots}}class oc extends rc{[Symbol.asyncIterator](){if(this._decoded)throw new Error("Cannot decode more than once");if(!this._iterable)throw new Error("Block iterable not found");return this._decoded=!0,this._iterable[Symbol.asyncIterator]()}static async fromBytes(e){const{version:t,roots:n,iterator:s}=await ac(e);return new oc(t,n,s)}static async fromIterable(e){const{version:t,roots:n,iterator:s}=await cc(e);return new oc(t,n,s)}}class ic extends rc{[Symbol.asyncIterator](){if(this._decoded)throw new Error("Cannot decode more than once");if(!this._iterable)throw new Error("Block iterable not found");this._decoded=!0;const e=this._iterable[Symbol.asyncIterator]();return{async next(){const t=await e.next();return t.done?t:{done:!1,value:t.value.cid}}}}static async fromBytes(e){const{version:t,roots:n,iterator:s}=await ac(e);return new ic(t,n,s)}static async fromIterable(e){const{version:t,roots:n,iterator:s}=await cc(e);return new ic(t,n,s)}}async function ac(e){if(!(e instanceof Uint8Array))throw new TypeError("fromBytes() requires a Uint8Array");return lc(Ga(e))}async function cc(e){if(!e||"function"!=typeof e[Symbol.asyncIterator])throw new TypeError("fromIterable() requires an async iterable");return lc(Wa(e))}async function lc(e){const t=qa(e),{version:n,roots:s}=await t.header();return{version:n,roots:s,iterator:t.blocks()}}const dc=(0,a.vF)("ipfs:components:dag:import");function uc({repo:e}){return St((async function*(t,n={}){const s=await e.gcLock.readLock();try{const s={signal:n.signal,timeout:n.timeout},r=function(e){const[t,n]=null!=e[Symbol.asyncIterator]?[e[Symbol.asyncIterator](),Symbol.asyncIterator]:[e[Symbol.iterator](),Symbol.iterator],s=[];return{peek:()=>t.next(),push:e=>{s.push(e)},next:()=>s.length>0?{done:!1,value:s.shift()}:t.next(),[n](){return this}}}(t),{value:o,done:i}=await r.peek();if(i)return;let a;o&&r.push(o),a=o instanceof Uint8Array?[r]:r;for await(const t of a){const r=await hc(e,s,t);if(!1!==n.pinRoots)for(const t of r){let n="";try{await e.blocks.has(t)?(dc(`Pinning root ${t}`),await e.pins.pinRecursively(t)):n="blockstore: block not found"}catch(e){n=e.message}yield{root:{cid:t,pinErrorMsg:n}}}}}finally{s()}}))}async function hc(e,t,n){const s=await oc.fromIterable(n),r=await s.getRoots();return await(0,Kn.A)(e.blocks.putMany((0,Xr.A)(s,(({cid:e,bytes:t})=>(dc(`Import block ${e}`),{key:e,value:t}))),{signal:t.signal})),r}class pc{constructor({repo:e,codecs:t,hashers:n,preload:s}){this.export=nc({repo:e,preload:s,codecs:t}),this.get=function({codecs:e,repo:t,preload:n}){return St((async function(s,r={}){if(!1!==r.preload&&n(s),r.path){const n=r.localResolve?await(0,sc.A)(Nt(s,r.path,e,t,r)):await(0,Vt.A)(Nt(s,r.path,e,t,r));if(!n)throw c(new Error("Not found"),"ERR_NOT_FOUND");return n}const o=await e.getCodec(s.code),i=await t.blocks.get(s,r);return{value:o.decode(i),remainderPath:""}}))}({codecs:t,repo:e,preload:s}),this.import=uc({repo:e}),this.resolve=function({repo:e,codecs:t,preload:n}){return St((async function(s,r={}){const{cid:o}=Rt(s);return!1!==r.preload&&n(o),At(e,t,s,r)}))}({repo:e,codecs:t,preload:s}),this.put=function({repo:e,codecs:t,hashers:n,preload:s}){return St((async function(r,o={}){const i=o.pin?await e.gcLock.readLock():null;try{const i=await t.getCodec(o.storeCodec||"dag-cbor");if(!i)throw new Error(`Unknown storeCodec ${o.storeCodec}, please configure additional BlockCodecs for this IPFS instance`);if(o.inputCodec){if(!(r instanceof Uint8Array))throw new Error("Can only inputCodec on raw bytes that can be decoded");const e=await t.getCodec(o.inputCodec);if(!e)throw new Error(`Unknown inputCodec ${o.inputCodec}, please configure additional BlockCodecs for this IPFS instance`);r=e.decode(r)}const a=null!=o.version?o.version:1,c=await n.getHasher(o.hashAlg||"sha2-256");if(!c)throw new Error(`Unknown hash algorithm ${o.hashAlg}, please configure additional MultihashHashers for this IPFS instance`);const l=i.encode(r),d=await c.digest(l),u=J.TO.create(a,i.code,d);return await e.blocks.put(u,l,{signal:o.signal}),o.pin&&await e.pins.pinRecursively(u),!1!==o.preload&&s(u),u}finally{i&&i()}}))}({repo:e,codecs:t,hashers:n,preload:s})}}var fc=n(29141),yc=n(62593);const gc=(0,a.vF)("ipfs:preload"),mc=new(Ct.A.default?Ct.A.default:Ct.A)({concurrency:4});function wc(e,t={}){return gc(e),mc.add((async()=>{const n=(await xt.post(e,{signal:t.signal})).body.getReader();try{for(;;){const{done:e}=await n.read();if(e)return}}finally{n.releaseLock()}}))}const bc=(0,a.vF)("ipfs:preload");function _c(e={}){if(e.enabled=Boolean(e.enabled),e.addresses=e.addresses||[],e.cache=e.cache||1e3,!e.enabled||!e.addresses.length){bc("preload disabled");const e=()=>{};return Object.assign(e,{start:()=>{},stop:()=>{}})}let t=!0,n=[];const s=e.addresses.map((e=>(0,fc._)(e))),r=Mt(e.cache),o=async e=>{try{if(t)throw new Error(`preload ${e} but preloader is not started`);const o=e.toString();if(r.has(o))return;r.set(o,!0);const i=(0,yc.A)(s);let a=!1;const c=Date.now();for(const e of i){if(t)throw new Error(`preload aborted for ${o}`);let s;try{s=new AbortController,n=n.concat(s),await wc(`${e}/api/v0/refs?r=true&arg=${encodeURIComponent(o)}`,{signal:s.signal}),a=!0}catch(e){"aborted"!==e.type&&bc.error(e)}finally{n=n.filter((e=>e!==s))}if(a)break}bc(`${a?"":"un"}successfully preloaded ${o} in ${Date.now()-c}ms`)}catch(e){bc.error(e)}};return o.start=()=>{t=!1},o.stop=()=>{t=!0,bc(`aborting ${n.length} pending preload request(s)`),n.forEach((e=>e.abort())),n=[]},o}const Ec=(0,a.vF)("ipfs:mfs-preload");var vc=n(56742);let Sc;function kc(e=!1){if(Sc)return Sc;const t=(0,vc.A)({singleProcess:e});return Sc={readLock:e=>async(...n)=>{const s=await t.readLock();try{return await e.apply(null,n)}finally{s()}},writeLock:e=>async(...n)=>{const s=await t.writeLock();try{return await e.apply(null,n)}finally{s()}}},Sc}const Rc=(0,a.vF)("ipfs:mfs:utils:with-mfs-root");async function Tc(e,t){if(t&&t.signal&&t.signal.aborted)throw c(new Error("Request aborted"),"ERR_ABORTED",{name:"Aborted"});let n;await e.repo.datastore.open();try{const t=await e.repo.datastore.get(It);n=J.TO.decode(t)}catch(s){if("ERR_NOT_FOUND"!==s.code)throw s;Rc("Creating new MFS root");const r=S.encode({Data:new v({type:"directory"}).marshal(),Links:[]}),o=await co.sha256.digest(r);if(n=J.TO.createV0(o),await e.repo.blocks.put(n,r),t&&t.signal&&t.signal.aborted)throw c(new Error("Request aborted"),"ERR_ABORTED",{name:"Aborted"});await e.repo.datastore.put(It,n.bytes)}return Rc(`Loaded MFS root /ipfs/${n}`),n}function Ic(e=""){return(e.trim().match(/([^\\^/]|\\\/)+/g)||[]).filter(Boolean)}const Pc="ipfs",Ac=async(e,t,n)=>{const s=await Tc(e,n);let r={entryType:"file"},o="";if(o=J.TO.asCID(t)?`/ipfs/${t}`:t.toString(),o=o.trim(),o=o.replace(/(\/\/+)/g,"/"),o.endsWith("/")&&o.length>1&&(o=o.substring(0,o.length-1)),!o)throw c(new Error("paths must not be empty"),"ERR_NO_PATH");if("/"!==o.substring(0,1))throw c(new Error("paths must start with a leading slash"),"ERR_INVALID_PATH");"/"===o.substring(o.length-1)&&(o=o.substring(0,o.length-1));const i=Ic(o);if(i[0]===Pc){let e;e=2===i.length?`/${i.join("/")}`:`/${i.slice(0,i.length-1).join("/")}`,r={type:"ipfs",depth:i.length-2,entryType:"file",mfsPath:`/${i.join("/")}`,mfsDirectory:e,parts:i,path:`/${i.join("/")}`,name:i[i.length-1]}}else{const e=`/${Pc}/${s}${i.length?"/"+i.join("/"):""}`,t=`/${Pc}/${s}/${i.slice(0,i.length-1).join("/")}`;r={type:"mfs",depth:i.length,entryType:"file",mfsDirectory:t,mfsPath:e,parts:i,path:`/${i.join("/")}`,name:i[i.length-1]}}const a="mfs"===r.type?r.mfsPath:r.path;try{const t=await qi(a,e.repo.blocks,n);r.cid=t.cid,r.mfsPath=`/ipfs/${t.path}`,r.entryType=t.type,r.content=t.content,"file"!==r.entryType&&"directory"!==r.entryType||"file"!==t.type&&"directory"!==t.type||(r.unixfs=t.unixfs)}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}return r.exists=Boolean(r.cid),r},Dc=o.A.bind({ignoreUndefined:!0}),Oc=(0,a.vF)("ipfs:mfs:stat"),Nc={withLocal:!1};function Lc(e){return St((async function(t,n={}){n=Dc(Nc,n),Oc(`Fetching stats for ${t}`);const{type:s,cid:r,mfsPath:o}=await Ac(e,t,n),i="ipfs"===s&&r?r:o;let a;try{a=await qi(i,e.repo.blocks)}catch(e){if("ERR_NOT_FOUND"===e.code)throw c(new Error(`${t} does not exist`),"ERR_NOT_FOUND");throw e}if(!Mc[a.type])throw new Error(`Cannot stat codec ${a.cid.code}`);return Mc[a.type](a)}))}const Mc={raw:e=>({cid:e.cid,size:e.node.length,cumulativeSize:e.node.length,blocks:0,type:"file",local:void 0,sizeLocal:void 0,withLocality:!1}),file:e=>{const t={cid:e.cid,type:"file",size:e.unixfs.fileSize(),cumulativeSize:S.encode(e.node).length+(e.node.Links||[]).reduce(((e,t)=>e+(t.Tsize||0)),0),blocks:e.unixfs.blockSizes.length,local:void 0,sizeLocal:void 0,withLocality:!1,mode:e.unixfs.mode};return e.unixfs.mtime&&(t.mtime=e.unixfs.mtime),t},directory:e=>{const t={cid:e.cid,type:"directory",size:0,cumulativeSize:S.encode(e.node).length+(e.node.Links||[]).reduce(((e,t)=>e+(t.Tsize||0)),0),blocks:e.node.Links.length,local:void 0,sizeLocal:void 0,withLocality:!1,mode:e.unixfs.mode};return e.unixfs.mtime&&(t.mtime=e.unixfs.mtime),t},object:e=>({cid:e.cid,size:e.node.length,cumulativeSize:e.node.length,type:"file",blocks:0,local:void 0,sizeLocal:void 0,withLocality:!1}),identity:e=>({cid:e.cid,size:e.node.length,cumulativeSize:e.node.length,blocks:0,type:"file",local:void 0,sizeLocal:void 0,withLocality:!1})},Cc=(0,a.vF)("ipfs:mfs:utils:to-trail");async function xc(e,t){Cc(`Creating trail for path ${t}`);const n=[];for await(const s of Ki(t,e.repo.blocks))n.push({name:s.name,cid:s.cid,size:s.size,type:s.type});return n}const Bc=async(e,t,n)=>{n.codec||(n.codec=S),n.hasher||(n.hasher=co.sha256),void 0===n.cidVersion&&(n.cidVersion=1),n.codec===S&&n.hasher!==co.sha256&&(n.cidVersion=1);const s=await n.hasher.digest(e),r=J.TO.create(n.cidVersion,n.codec.code,s);return n.onlyHash||await t.put(r,e,{signal:n.signal}),r},zc=lo.DK.code;async function Uc(e){return(await lo.DK.encode(e)).subarray(0,8).reverse()}class Fc{constructor(e,t){this.options=t||{},this.root=e.root,this.dir=e.dir,this.path=e.path,this.dirty=e.dirty,this.flat=e.flat,this.parent=e.parent,this.parentKey=e.parentKey,this.unixfs=e.unixfs,this.mode=e.mode,this.mtime=e.mtime,this.cid=void 0,this.size=void 0}async put(e,t){}get(e){return Promise.resolve(this)}async*eachChildSeries(){}async*flush(e){}}class jc extends Fc{constructor(e,t){super(e,t),this._bucket=(0,Go.T)({hashFn:Uc,bits:8})}async put(e,t){await this._bucket.put(e,t)}get(e){return this._bucket.get(e)}childCount(){return this._bucket.leafCount()}directChildrenCount(){return this._bucket.childrenCount()}onlyChild(){return this._bucket.onlyChild()}async*eachChildSeries(){for await(const{key:e,value:t}of this._bucket.eachLeafSeries())yield{key:e,child:t}}async*flush(e){yield*Hc(this._bucket,e,this,this.options)}}async function*Hc(e,t,n,s){const r=e._children,o=[];let i=0;for(let e=0;e<r.length;e++){const n=r.get(e);if(!n)continue;const a=e.toString(16).toUpperCase().padStart(2,"0");if(n instanceof Go.f){let e;for await(const r of await Hc(n,t,null,s))e=r;if(!e)throw new Error("Could not flush sharded directory, no subshard found");o.push({Name:a,Tsize:e.size,Hash:e.cid}),i+=e.size}else if("function"==typeof n.value.flush){const e=n.value;let s;for await(const n of e.flush(t))s=n,yield s;const r=a+n.key;o.push({Name:r,Tsize:s.size,Hash:s.cid}),i+=s.size}else{const e=n.value;if(!e.cid)continue;const t=a+n.key,s=e.size;o.push({Name:t,Tsize:s,Hash:e.cid}),i+=s}}const a=Uint8Array.from(r.bitField().reverse()),c={Data:new v({type:"hamt-sharded-directory",data:a,fanout:e.tableSize(),hashType:zc,mtime:n&&n.mtime,mode:n&&n.mode}).marshal(),Links:o},l=(0,S.encode)((0,S.prepare)(c)),d=await Bc(l,t,s),u=l.length+i;yield{cid:d,node:c,size:u}}const $c=(0,a.vF)("ipfs:mfs:core:utils:hamt-utils"),Vc=async(e,t,n,s)=>{if(!s.parent.Data)throw new Error("Could not update HAMT directory because parent had no data");const r=Uint8Array.from(n._children.bitField().reverse()),o=v.unmarshal(s.parent.Data),i=new v({type:"hamt-sharded-directory",data:r,fanout:n.tableSize(),hashType:zc,mode:o.mode,mtime:o.mtime}),a=await e.hashers.getHasher(s.hashAlg),c={Data:i.marshal(),Links:t.sort(((e,t)=>(e.Name||"").localeCompare(t.Name||"")))},l=S.encode(c),d=await a.digest(l),u=J.TO.create(s.cidVersion,S.code,d);return s.flush&&await e.repo.blocks.put(u,l),{node:c,cid:u,size:t.reduce(((e,t)=>e+(t.Tsize||0)),l.length)}},Kc=async(e,t,n,s,r)=>{const o=new Go.f({hash:n._options.hash,bits:n._options.bits},s,r);return s._putObjectAt(r,o),await Gc(e,t,o,n),o},qc=async e=>{const t=(0,Go.T)({hashFn:Uc,bits:8});return await Promise.all(e.map((async e=>{const n=e.Name||"";if(2===n.length){const e=parseInt(n,16),s=new Go.f({hash:t._options.hash,bits:t._options.bits},t,e);return t._putObjectAt(e,s),Promise.resolve()}return t.put(n.substring(2),{size:e.Tsize,cid:e.Hash})}))),t},Gc=async(e,t,n,s)=>{await Promise.all(t.map((async t=>{const r=t.Name||"";if(2===r.length){$c("Populating sub bucket",r);const o=parseInt(r,16),i=await e.repo.blocks.get(t.Hash),a=S.decode(i),c=new Go.f({hash:s._options.hash,bits:s._options.bits},n,o);return n._putObjectAt(o,c),await Gc(e,a.Links,c,s),Promise.resolve()}return s.put(r.substring(2),{size:t.Tsize,cid:t.Hash})})))},Wc=e=>e.toString(16).toUpperCase().padStart(2,"0").substring(0,2),Yc=(0,a.vF)("ipfs:mfs:core:utils:add-link");async function Xc(e,t){let n=t.parent;if(t.parentCid){const s=J.TO.asCID(t.parentCid);if(null===s)throw c(new Error("Invalid CID passed to addLink"),"EINVALIDPARENTCID");if(s.code!==S.code)throw c(new Error("Unsupported codec. Only DAG-PB is supported"),"EINVALIDPARENTCID");Yc(`Loading parent node ${s}`);const r=await e.repo.blocks.get(s);n=S.decode(r)}if(!n)throw c(new Error("No parent node or CID passed to addLink"),"EINVALIDPARENT");if(!t.cid)throw c(new Error("No child cid passed to addLink"),"EINVALIDCHILDCID");if(!t.name)throw c(new Error("No child name passed to addLink"),"EINVALIDCHILDNAME");if(!t.size&&0!==t.size)throw c(new Error("No child size passed to addLink"),"EINVALIDCHILDSIZE");if(!n.Data)throw c(new Error("Parent node with no data passed to addLink"),"ERR_INVALID_PARENT");const s=v.unmarshal(n.Data);return"hamt-sharded-directory"===s.type?(Yc("Adding link to sharded directory"),Zc(e,{...t,parent:n})):n.Links.length>=t.shardSplitThreshold?(Yc("Converting directory to sharded directory"),Qc(e,{...t,parent:n,mtime:s.mtime,mode:s.mode})):(Yc(`Adding ${t.name} (${t.cid}) to regular directory`),Jc(e,{...t,parent:n}))}const Qc=async(e,t)=>{const n=await(async(e,t,n={})=>{const s=new jc({root:!0,dir:!0,parent:void 0,parentKey:void 0,path:"",dirty:!0,flat:!1,mtime:n.mtime,mode:n.mode},n);for(let e=0;e<t.length;e++)await s._bucket.put(t[e].name,{size:t[e].size,cid:t[e].cid});const r=await(0,Vt.A)(s.flush(e.repo.blocks));if(!r)throw new Error("Flushing shard yielded no result");return r})(e,t.parent.Links.map((e=>({name:e.Name||"",size:e.Tsize||0,cid:e.Hash}))).concat({name:t.name,size:t.size,cid:t.cid}),t);return Yc(`Converted directory to sharded directory ${n.cid}`),n},Jc=async(e,t)=>{const n=t.parent.Links.filter((e=>e.Name!==t.name));if(n.push({Name:t.name,Tsize:t.size,Hash:t.cid}),!t.parent.Data)throw c(new Error("Parent node with no data passed to addToDirectory"),"ERR_INVALID_PARENT");const s=v.unmarshal(t.parent.Data);let r;if(s.mtime){const e=Date.now(),t=Math.floor(e/1e3);s.mtime={secs:t,nsecs:1e3*(e-1e3*t)},r=s.marshal()}else r=t.parent.Data;t.parent=S.prepare({Data:r,Links:n});const o=await e.hashers.getHasher(t.hashAlg),i=S.encode(t.parent),a=await o.digest(i),l=J.TO.create(t.cidVersion,S.code,a);return t.flush&&await e.repo.blocks.put(l,i),{node:t.parent,cid:l,size:i.length}},Zc=async(e,t)=>{const{shard:n,path:s}=await el(e,t),r=await(0,Vt.A)(n.flush(e.repo.blocks));if(!r)throw new Error("No result from flushing shard");const o=await e.repo.blocks.get(r.cid),i=S.decode(o),a=t.parent.Links.filter((e=>(e.Name||"").substring(0,2)!==s[0].prefix)),c=i.Links.find((e=>(e.Name||"").substring(0,2)===s[0].prefix));if(!c)throw new Error(`No link found with prefix ${s[0].prefix}`);return a.push(c),Vc(e,a,s[0].bucket,t)},el=async(e,t)=>{const n={name:t.name,cid:t.cid,size:t.size};if(!t.parent.Data)throw c(new Error("Parent node with no data passed to addFileToShardedDirectory"),"ERR_INVALID_PARENT");const s=await qc(t.parent.Links),r=v.unmarshal(t.parent.Data),o=new jc({root:!0,dir:!0,parent:void 0,parentKey:void 0,path:"",dirty:!0,flat:!1,mode:r.mode},t);o._bucket=s,r.mtime&&(o.mtime={secs:Math.round(Date.now()/1e3)});const i=await s._findNewBucketAndPos(n.name),a=tl(i);a[0].node=t.parent;let l=0;for(;l<a.length;){const t=a[l];l++;const r=t.node;if(!r)throw new Error("Segment had no node");const o=r.Links.find((e=>(e.Name||"").substring(0,2)===t.prefix));if(!o){Yc(`Link ${t.prefix}${n.name} will be added`),l=a.length;break}if(o.Name===`${t.prefix}${n.name}`){Yc(`Link ${t.prefix}${n.name} will be replaced`),l=a.length;break}if((o.Name||"").length>2){Yc(`Link ${o.Name} ${o.Hash} will be replaced with a subshard`),l=a.length;break}Yc(`Found subshard ${t.prefix}`);const i=await e.repo.blocks.get(o.Hash),c=S.decode(i);if(!a[l]){Yc(`Loaded new subshard ${t.prefix}`),await Kc(e,c.Links,s,t.bucket,parseInt(t.prefix,16));const r=await s._findNewBucketAndPos(n.name);a.push({bucket:r.bucket,prefix:Wc(r.pos),node:c});break}const d=a[l];await Gc(e,c.Links,d.bucket,s),d.node=c}return await o._bucket.put(n.name,{size:n.size,cid:n.cid}),{shard:o,path:a}},tl=e=>{const t=[{bucket:e.bucket,prefix:Wc(e.pos)}];let n=e.bucket._parent,s=e.bucket._posAtParent;for(;n;)t.push({bucket:n,prefix:Wc(s)}),s=n._posAtParent,n=n._parent;return t.reverse(),t},nl=(0,a.vF)("ipfs:mfs:utils:update-tree"),sl={shardSplitThreshold:1e3};async function rl(e,t,n){n=Object.assign({},sl,n),nl("Trail",t),t=t.slice().reverse();let s,r=0;for await(const o of e.repo.blocks.getMany(t.map((e=>e.cid)))){const i=(0,S.decode)(o),a=t[r].cid,c=t[r].name;if(r++,!s){s={cid:a,name:c,size:o.length};continue}const l=await Xc(e,{parent:i,name:s.name,cid:s.cid,size:s.size,flush:n.flush,shardSplitThreshold:n.shardSplitThreshold,hashAlg:n.hashAlg,cidVersion:n.cidVersion});s={cid:l.cid,name:c,size:l.size}}const{cid:o}=s;return nl(`Final CID ${o}`),o}const ol=(0,a.vF)("ipfs:mfs:utils:update-mfs-root");async function il(e,t,n){if(n&&n.signal&&n.signal.aborted)throw c(new Error("Request aborted"),"ERR_ABORTED",{name:"Aborted"});return ol(`New MFS root will be ${t}`),await e.repo.datastore.put(It,t.bytes),t}const al=o.A.bind({ignoreUndefined:!0}),cl=(0,a.vF)("ipfs:mfs:mkdir"),ll={parents:!1,hashAlg:"sha2-256",cidVersion:0,shardSplitThreshold:1e3,flush:!0};function dl(e){return St((async function(t,n={}){const s=al(ll,n);if(!t)throw new Error("no path given to Mkdir");if("/"===(t=t.trim())){if(s.parents)return;throw c(new Error("cannot create directory '/': Already exists"),"ERR_INVALID_PATH")}if("/"!==t.substring(0,1))throw c(new Error("paths must start with a leading slash"),"ERR_INVALID_PATH");cl(`Creating ${t}`);const r=Ic(t);if("ipfs"===r[0])throw c(new Error("path cannot have the prefix 'ipfs'"),"ERR_INVALID_PATH");const o=await Tc(e,s);let i;const a=[],l=await async function(e,t,n){const s=new v({type:t,mode:n.mode,mtime:n.mtime}),r=await e.hashers.getHasher(n.hashAlg),o={Data:s.marshal(),Links:[]},i=S.encode(o),a=await r.digest(i),c=J.TO.create(n.cidVersion,S.code,a);return n.flush&&await e.repo.blocks.put(c,i),{cid:c,node:o}}(e,"directory",s);for(let n=0;n<=r.length;n++){const d=r.slice(0,n),u=`/ipfs/${o}/${d.join("/")}`;try{if(i=await qi(u,e.repo.blocks),"file"!==i.type&&"directory"!==i.type)throw c(new Error(`${t} was not a UnixFS node`),"ERR_NOT_UNIXFS");if(n===r.length){if(s.parents)return;throw c(new Error("file already exists"),"ERR_ALREADY_EXISTS")}a.push({name:i.name,cid:i.cid})}catch(t){if("ERR_NOT_FOUND"!==t.code)throw t;if(n<r.length&&!s.parents)throw c(new Error(`Intermediate directory path ${u} does not exist, use the -p flag to create it`),"ERR_NOT_FOUND");await ul(e,d[d.length-1],l,a[a.length-1],a,s)}}const d=await rl(e,a,s);await il(e,d,s)}))}const ul=async(e,t,n,s,r,o)=>{cl(`Adding empty dir called ${t} to ${s.cid}`);const i=await Xc(e,{parent:s.node,parentCid:s.cid,size:0,cid:n.cid,name:t,hashAlg:o.hashAlg,cidVersion:o.cidVersion,flush:o.flush,shardSplitThreshold:o.shardSplitThreshold});r[r.length-1].cid=i.cid,r.push({name:t,cid:n.cid})},hl=o.A.bind({ignoreUndefined:!0}),pl=(0,a.vF)("ipfs:mfs:cp"),fl={parents:!1,flush:!0,hashAlg:"sha2-256",cidVersion:0,shardSplitThreshold:1e3};function yl(e){return St((async function(t,n,s={}){const r=hl(fl,s);Array.isArray(t)||(t=[t]);const o=await Promise.all(t.map((t=>Ac(e,t,r))));let i=await Ac(e,n,r);if(!o.length||!i)throw c(new Error("Please supply at least one source"),"ERR_INVALID_PARAMS");const a=o.find((e=>!e.exists));if(a)throw c(new Error(`${a.path} does not exist`),"ERR_INVALID_PARAMS");const l=gl(i);if(i.exists){if(pl("Destination exists"),1===o.length&&!l)throw c(new Error("directory already has entry by that name"),"ERR_ALREADY_EXISTS")}else if(pl("Destination does not exist"),o.length>1){if(!r.parents)throw c(new Error("destination did not exist, pass -p to create intermediate directories"),"ERR_INVALID_PARAMS");await dl(e)(i.path,r),i=await Ac(e,i.path,r)}else if(i.parts.length>1){const t=`/${i.parts.slice(0,-1).join("/")}`;try{await Lc(e)(t,r)}catch(n){if("ERR_NOT_FOUND"!==n.code)throw n;if(!r.parents)throw c(new Error("destination did not exist, pass -p to create intermediate directories"),"ERR_INVALID_PARAMS");await dl(e)(t,r),i=await Ac(e,i.path,r)}}const d=gl(i)?i.mfsPath:i.mfsDirectory,u=await xc(e,d);if(1===o.length){const t=o.pop();if(!t)throw c(new Error("could not find source"),"ERR_INVALID_PARAMS");const n=l?t.name:i.name;return pl(`Only one source, copying to destination ${l?"directory":"file"} ${n}`),ml(e,t,n,u,r)}return pl("Multiple sources, wrapping in a directory"),wl(e,o,i,u,r)}))}const gl=e=>e.unixfs&&e.unixfs.type&&e.unixfs.type.includes("directory"),ml=async(e,t,n,s,r)=>{let o=s.pop();if(!o)throw c(new Error("destination had no parent"),"ERR_INVALID_PARAMS");o=await bl(e,t,n,o,r),s.push(o);const i=await rl(e,s,r);await il(e,i,r)},wl=async(e,t,n,s,r)=>{for(let s=0;s<t.length;s++){const o=t[s];n=await bl(e,o,o.name,n,r)}s[s.length-1]=n;const o=await rl(e,s,r);await il(e,o,r)},bl=async(e,t,n,s,r)=>{const o=await e.repo.blocks.get(t.cid),{node:i,cid:a,size:c}=await Xc(e,{parentCid:s.cid,size:o.length,cid:t.cid,name:n,hashAlg:r.hashAlg,cidVersion:r.cidVersion,flush:r.flush,shardSplitThreshold:r.shardSplitThreshold});return s.node=i,s.cid=a,s.size=c,s},_l=(0,a.vF)("ipfs:mfs:core:utils:remove-link");const El=async(e,t)=>{t.parent.Links=t.parent.Links.filter((e=>e.Name!==t.name));const n=await S.encode(t.parent),s=await e.hashers.getHasher(t.hashAlg),r=await s.digest(n),o=J.TO.create(t.cidVersion,S.code,r);return await e.repo.blocks.put(o,n),_l(`Updated regular directory ${o}`),{node:t.parent,cid:o}},vl=async(e,t)=>{const{rootBucket:n,path:s}=await(async(e,t,n)=>{const s=await qc(n.Links),r=await s._findNewBucketAndPos(t),o=[{bucket:r.bucket,prefix:Wc(r.pos)}];let i=r.bucket;for(;i!==s;)o.push({bucket:i,prefix:Wc(i._posAtParent)}),i=i._parent;o.reverse(),o[0].node=n;for(let n=0;n<o.length;n++){const r=o[n];if(!r.node)throw new Error("Could not generate HAMT path");const i=r.node.Links.filter((e=>(e.Name||"").substring(0,2)===r.prefix)).pop();if(!i){$c(`Link ${r.prefix}${t} will be added`);continue}if(i.Name===`${r.prefix}${t}`){$c(`Link ${r.prefix}${t} will be replaced`);continue}$c(`Found subshard ${r.prefix}`);const a=await e.repo.blocks.get(i.Hash),c=S.decode(a);if(!o[n+1]){$c(`Loaded new subshard ${r.prefix}`),await Kc(e,c.Links,s,r.bucket,parseInt(r.prefix,16));const n=await s._findNewBucketAndPos(t);o.push({bucket:n.bucket,prefix:Wc(n.pos),node:c});continue}const l=o[n+1];await Gc(e,c.Links,l.bucket,s),l.node=c}return await s.put(t,!0),o.reverse(),{rootBucket:s,path:o}})(e,t.name,t.parent);await n.del(t.name);const{node:r}=await Sl(e,s,t.name,t);return Vc(e,r.Links,n,t)},Sl=async(e,t,n,s)=>{const r=t.pop();if(!r)throw c(new Error("Could not find parent"),"EINVALIDPARENT");const{bucket:o,prefix:i,node:a}=r;if(!a)throw c(new Error("Could not find parent"),"EINVALIDPARENT");const l=a.Links.find((e=>(e.Name||"").substring(0,2)===i));if(!l)throw c(new Error(`No link found with prefix ${i} for file ${n}`),"ERR_NOT_FOUND");if(l.Name===`${i}${n}`){_l(`Removing existing link ${l.Name}`);const t=a.Links.filter((e=>e.Name!==l.Name));return await o.del(n),Vc(e,t,o,s)}_l(`Descending into sub-shard ${l.Name} for ${i}${n}`);const d=await Sl(e,t,n,s);let u=d.cid,h=d.size,p=i;if(1===d.node.Links.length){_l(`Removing subshard for ${i}`);const e=d.node.Links[0];p=`${i}${(e.Name||"").substring(2)}`,u=e.Hash,h=e.Tsize||0}return _l(`Updating shard ${i} with name ${p}`),kl(e,o,a,i,p,h,u,s)},kl=(e,t,n,s,r,o,i,a)=>{const c=n.Links.filter((e=>e.Name!==s));return c.push({Name:r,Tsize:o,Hash:i}),Vc(e,c,t,a)},Rl=o.A.bind({ignoreUndefined:!0}),Tl={recursive:!1,cidVersion:0,hashAlg:"sha2-256",flush:!0,shardSplitThreshold:1e3};function Il(e){return St((async function(t,n={}){const s=Rl(Tl,n);Array.isArray(t)||(t=[t]);const r=await Promise.all(t.map((t=>Ac(e,t,s))));if(!r.length)throw c(new Error("Please supply at least one path to remove"),"ERR_INVALID_PARAMS");r.forEach((e=>{if("/"===e.path)throw c(new Error("Cannot delete root"),"ERR_INVALID_PARAMS")}));for(const t of r)await Pl(e,t.path,s)}))}const Pl=async(e,t,n)=>{const s=await Ac(e,t,n),r=await xc(e,s.mfsPath),o=r[r.length-1];r.pop();const i=r[r.length-1];if(!i)throw c(new Error(`${t} does not exist`),"ERR_NOT_FOUND");if("directory"===o.type&&!n.recursive)throw c(new Error(`${t} is a directory, use -r to remove directories`),"ERR_WAS_DIR");const{cid:a}=await async function(e,t){let n=t.parent;if(t.parentCid){const s=J.TO.asCID(t.parentCid);if(null===s)throw c(new Error("Invalid CID passed to removeLink"),"EINVALIDPARENTCID");_l(`Loading parent node ${s}`);const r=await e.repo.blocks.get(s);n=S.decode(r)}if(!n)throw c(new Error("No parent node or CID passed to removeLink"),"EINVALIDPARENT");if(!t.name)throw c(new Error("No child name passed to removeLink"),"EINVALIDCHILDNAME");if(!n.Data)throw c(new Error("Parent node had no data"),"ERR_INVALID_NODE");return"hamt-sharded-directory"===v.unmarshal(n.Data).type?(_l(`Removing ${t.name} from sharded directory`),vl(e,{...t,parent:n})):(_l(`Removing link ${t.name} regular directory`),El(e,{...t,parent:n}))}(e,{parentCid:i.cid,name:o.name,hashAlg:n.hashAlg,cidVersion:n.cidVersion,flush:n.flush,shardSplitThreshold:n.shardSplitThreshold});i.cid=a;const l=await rl(e,r,n);await il(e,l,n)},Al=o.A.bind({ignoreUndefined:!0}),Dl=(0,a.vF)("ipfs:mfs:touch"),Ol={flush:!0,shardSplitThreshold:1e3,hashAlg:"sha2-256",cidVersion:0,recursive:!1};function Nl(e,t,n){t||(t=0);const s=e.match(/^(u?g?o?a?)(-?\+?=?)?(r?w?x?X?s?t?)$/);if(!s)throw new Error(`Invalid file mode: ${e}`);let[,r,o,i]=s;"a"!==r&&r||(r="ugo");let a=function(e,t,n){let s=0;return(e.includes("x")||e.includes("X")&&(n||1&t||8&t||64&t))&&(s+=1),e.includes("w")&&(s+=2),e.includes("r")&&(s+=4),s}(i,t,n);return a=function(e,t){let n=0;return e.includes("u")&&(n+=t<<6),e.includes("g")&&(n+=t<<3),e.includes("o")&&(n+=t),n}(r,a),a=function(e,t,n){return t.includes("t")&&(n+=parseInt("1000",8)),t.includes("s")&&(e.includes("u")&&(n+=parseInt("4000",8)),e.includes("g")&&(n+=parseInt("2000",8))),n}(r,i,a),"="===o?(r.includes("u")&&(t&=parseInt("7077",8),t|=a),r.includes("g")&&(t&=parseInt("7707",8),t|=a),r.includes("o")&&(t&=parseInt("7770",8),t|=a),t):"+"===o?a|t:"-"===o?a^t:t}function Ll(e,t){if(e instanceof String||"string"==typeof e){const n=`${e}`;e=n.match(/^\d+$/g)?parseInt(n,8):0+n.split(",").reduce(((e,n)=>Nl(n,e,t.isDirectory())),t.mode||0)}return e}const Ml=o.A.bind({ignoreUndefined:!0}),Cl={};const xl=o.A.bind({ignoreUndefined:!0}),Bl={parents:!1,flush:!0,cidVersion:0,hashAlg:"sha2-256",shardSplitThreshold:1e3};const zl=o.A.bind({ignoreUndefined:!0}),Ul=(0,a.vF)("ipfs:mfs:touch"),Fl={flush:!0,shardSplitThreshold:1e3,cidVersion:0,hashAlg:"sha2-256"};const jl=o.A.bind({ignoreUndefined:!0}),Hl={offset:0,length:1/0};var $l=n(65385);const Vl=(0,a.vF)("ipfs:mfs:utils:to-async-iterator");const Kl=o.A.bind({ignoreUndefined:!0}),ql=(0,a.vF)("ipfs:mfs:write"),Gl={offset:0,length:1/0,create:!1,truncate:!1,rawLeaves:!1,reduceSingleLeafToSelf:!1,cidVersion:0,hashAlg:"sha2-256",parents:!1,progress:(e,t)=>{},strategy:"trickle",flush:!0,leafType:"raw",shardSplitThreshold:1e3};const Wl=async(e,t,n,s,r)=>{const o=await Yl(e,n,s,r);await kc().writeLock((async()=>{const n=Ic(t),s=n.pop();if(null==s)throw c(new Error("source does not exist"),"ERR_NO_EXIST");let i=!1;try{await Lc(e)(`/${n.join("/")}`,r),i=!0}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}i||await dl(e)(`/${n.join("/")}`,r);const a=await Ac(e,t,r),l=await xc(e,a.mfsDirectory),d=l[l.length-1];if(!d)throw c(new Error("directory does not exist"),"ERR_NO_EXIST");if(!d.type||!d.type.includes("directory"))throw c(new Error(`cannot write to ${d.name}: Not a directory`),"ERR_NOT_A_DIRECTORY");const u=await e.repo.blocks.get(d.cid),h=(0,S.decode)(u),p=await Xc(e,{parent:h,name:s,cid:o.cid,size:o.size,flush:r.flush,shardSplitThreshold:r.shardSplitThreshold,hashAlg:r.hashAlg,cidVersion:r.cidVersion});d.cid=p.cid;const f=await rl(e,l,r);await il(e,f,r)}))()},Yl=async(e,t,n,s)=>{n.exists?ql(`Overwriting file ${n.cid} offset ${s.offset} length ${s.length}`):ql(`Writing file offset ${s.offset} length ${s.length}`);const r=[];if(s.offset>0)if(n.unixfs){if(ql(`Writing first ${s.offset} bytes of original file`),r.push((()=>n.content({offset:0,length:s.offset}))),n.unixfs.fileSize()<s.offset){const e=s.offset-n.unixfs.fileSize();ql(`Writing zeros for extra ${e} bytes`),r.push(Ql(e))}}else ql(`Writing zeros for first ${s.offset} bytes`),r.push(Ql(s.offset));r.push(Xl(t,s.length));const o=Zl(Jl(r),(e=>{if(n.unixfs&&!s.truncate){const t=n.unixfs.fileSize();if(t>e)return ql(`Writing last ${t-e} of ${t} bytes from original file starting at offset ${e}`),n.content({offset:e});ql("Not writing last bytes from original file")}return{[Symbol.asyncIterator]:async function*(){}}}));let i,a;void 0!==s.mode&&null!==s.mode?i=_(s.mode):n&&n.unixfs&&(i=n.unixfs.mode),null!=s.mtime?a=E(s.mtime):n&&n.unixfs&&(a=n.unixfs.mtime);const l=await e.hashers.getHasher(s.hashAlg),d=await(0,Vt.A)(ti([{content:o,mode:i,mtime:a}],e.repo.blocks,{progress:s.progress,hasher:l,cidVersion:s.cidVersion,strategy:s.strategy,rawLeaves:s.rawLeaves,reduceSingleLeafToSelf:s.reduceSingleLeafToSelf,leafType:s.leafType}));if(!d)throw c(new Error(`cannot write to ${parent.name}`),"ERR_COULD_NOT_WRITE");return ql(`Wrote ${d.cid}`),{cid:d.cid,size:d.size}},Xl=(e,t)=>async function*(){let n=0;for await(const s of e){if(n+=s.length,n>t)return void(yield s.subarray(0,t-n));yield s}},Ql=(e,t=262144)=>{const n=new Uint8Array(t);return Xl(async function*(){for(;;)yield n}(),e)},Jl=async function*(e){for(let t=0;t<e.length;t++)yield*e[t]()},Zl=async function*(e,t){let n=0;for await(const t of e)n+=t.length,yield t;for await(const e of t(n))n+=e.length,yield e},ed=e=>{const t={cid:e.cid,name:e.name,type:"directory"===e.type?"directory":"file",size:e.size};return"file"!==e.type&&"directory"!==e.type||(t.mode=e.unixfs.mode,t.mtime=e.unixfs.mtime),t};const td={stat:Lc},nd={chmod:function(e){return St((async function(t,n,s={}){const r=Al(Ol,s);Dl(`Fetching stats for ${t}`);const{cid:o,mfsDirectory:i,name:a}=await Ac(e,t,r);if(o.code!==S.code)throw c(new Error(`${t} was not a UnixFS node`),"ERR_NOT_UNIXFS");if(r.recursive){const s=await no((async function*(){for await(const s of Gi(o,e.repo.blocks)){if("file"!==s.type&&"directory"!==s.type)throw c(new Error(`${t} was not a UnixFS node`),"ERR_NOT_UNIXFS");s.unixfs.mode=Ll(n,s.unixfs);const e=S.prepare({Data:s.unixfs.marshal(),Links:s.node.Links});yield{path:s.path,content:e}}}),(t=>ti(t,e.repo.blocks,{...r,pin:!1,dagBuilder:async function*(e,t,n){for await(const s of e)yield async function(){const e=s.content,r=S.encode(e),o=await Bc(r,t,n);if(!e.Data)throw c(new Error(`${o} had no data`),"ERR_INVALID_NODE");const i=v.unmarshal(e.Data);return{cid:o,size:r.length,path:s.path,unixfs:i}}}})),(e=>(0,Vt.A)(e)));if(!s)throw c(new Error(`Could not chmod ${t}`),"ERR_COULD_NOT_CHMOD");return await Il(e)(t,r),void await yl(e)(`/ipfs/${s.cid}`,t,r)}const l=await e.repo.blocks.get(o),d=S.decode(l);if(!d.Data)throw c(new Error(`${o} had no data`),"ERR_INVALID_NODE");const u=v.unmarshal(d.Data);u.mode=Ll(n,u);const h=S.encode({Data:u.marshal(),Links:d.Links}),p=r.hashAlg||Ol.hashAlg,f=await e.hashers.getHasher(p),y=await f.digest(h),g=J.TO.create(r.cidVersion,S.code,y);r.flush&&await e.repo.blocks.put(g,h);const m=await xc(e,i),w=m[m.length-1],b=J.TO.decode(w.cid.bytes),_=await e.repo.blocks.get(b),E=S.decode(_),k=await Xc(e,{parent:E,name:a,cid:g,size:h.length,flush:r.flush,hashAlg:p,cidVersion:o.version,shardSplitThreshold:1/0});w.cid=k.cid;const R=await rl(e,m,r);await il(e,R,r)}))},cp:yl,flush:function(e){return St((async function(t,n={}){n=Ml(Cl,n);const{cid:s}=await Lc(e)(t,n);return s}))},mkdir:dl,mv:function(e){return St((async function(t,n,s={}){const r=xl(Bl,s);await yl(e)(t,n,r),await Il(e)(t,{...r,recursive:!0})}))},rm:Il,touch:function(e){return St((async function(t,n={}){const s=zl(Fl,n);s.mtime=s.mtime||new Date,Ul(`Touching ${t} mtime: ${s.mtime}`);const{cid:r,mfsDirectory:o,name:i,exists:a}=await Ac(e,t,s),l=n.hashAlg||Fl.hashAlg,d=await e.hashers.getHasher(l);let u,h,p=s.cidVersion;if(a){if(r.code!==S.code)throw c(new Error(`${t} was not a UnixFS node`),"ERR_NOT_UNIXFS");p=r.version;const n=await e.repo.blocks.get(r),o=S.decode(n);if(!o.Data)throw c(new Error(`${t} had no data`),"ERR_INVALID_NODE");const i=v.unmarshal(o.Data);i.mtime=s.mtime,u=S.encode({Data:i.marshal(),Links:o.Links});const a=await d.digest(u);h=J.TO.create(s.cidVersion,S.code,a),s.flush&&await e.repo.blocks.put(h,u)}else{const t=new v({type:"file",mtime:s.mtime});u=S.encode({Data:t.marshal(),Links:[]});const n=await d.digest(u);h=J.TO.create(s.cidVersion,S.code,n),s.flush&&await e.repo.blocks.put(h,u)}const f=await xc(e,o),y=f[f.length-1],g=y.cid,m=await e.repo.blocks.get(g),w=S.decode(m),b=await Xc(e,{parent:w,name:i,cid:h,size:u.length,flush:s.flush,shardSplitThreshold:s.shardSplitThreshold,hashAlg:s.hashAlg,cidVersion:p});y.cid=b.cid;const _=await rl(e,f,s);await il(e,_,s)}))}},sd={write:function(e){return St((async function(t,n,s={}){const r=Kl(Gl,s);let o,i,a;if(ql("Reading source, destination and parent"),await kc().readLock((async()=>{o=await function(e){if(!e)throw c(new Error("paths must start with a leading slash"),"ERR_INVALID_PATH");if(("string"==typeof e||e instanceof String)&&(Vl("Content was a string"),e=(0,x.s)(e.toString())),e.length)return Vl("Content was array-like"),{[Symbol.asyncIterator]:function*(){yield e}};if(e[Symbol.asyncIterator])return Vl("Content was an async iterator"),e;if(e[Symbol.iterator])return Vl("Content was an iterator"),e;if(global.Blob&&e instanceof global.Blob)return Vl("Content was an HTML5 Blob"),(0,$l.A)(e.stream());throw c(new Error(`Don't know how to convert ${e} into an async iterator`),"ERR_INVALID_PARAMS")}(n),i=await Ac(e,t,r),a=await Ac(e,i.mfsDirectory,r)}))(),ql("Read source, destination and parent"),!r.parents&&!a.exists)throw c(new Error("directory does not exist"),"ERR_NO_EXIST");if(null==o)throw c(new Error("could not create source"),"ERR_NO_SOURCE");if(null==i)throw c(new Error("could not create destination"),"ERR_NO_DESTINATION");if(!r.create&&!i.exists)throw c(new Error("file does not exist"),"ERR_NO_EXIST");if("file"!==i.entryType)throw c(new Error("not a file"),"ERR_NOT_A_FILE");return Wl(e,t,o,i,r)}))},read:function(e){return St((function(t,n={}){return n=jl(Hl,n),{[Symbol.asyncIterator]:async function*(){const s=await Ac(e,t,n),r=await qi(s.mfsPath,e.repo.blocks);if("file"!==r.type&&"raw"!==r.type)throw c(new Error(`${t} was not a file or raw bytes`),"ERR_NOT_FILE");if(!r.content)throw c(new Error(`Could not load content stream from ${t}`),"ERR_NO_CONTENT");for await(const e of r.content({offset:n.offset,length:n.length}))yield e}}}))},ls:function(e){return St((async function*(t,n={}){const s=await Ac(e,t,n),r=await qi(s.mfsPath,e.repo.blocks);"directory"!==r.type?yield ed(r):yield*(0,Xr.A)(r.content(n),ed)}))}},rd=({options:e,mfs:t,operations:n,lock:s})=>{Object.keys(n).forEach((r=>{t[r]=s(n[r](e))}))},od={repoOwner:!0,repo:null};function id({repo:e,preload:t,hashers:n,options:s}){const r=function(e){const{repoOwner:t}=Object.assign({},od||{},e),n=kc(t),s={};return rd({options:e,mfs:s,operations:td,lock:e=>n.readLock(e)}),rd({options:e,mfs:s,operations:nd,lock:e=>n.writeLock(e)}),Object.keys(sd).forEach((t=>{s[t]=sd[t](e)})),s}({repo:e,repoOwner:!1!==s.repoOwner,hashers:n}),o=e=>(...n)=>{const s=n.filter((e=>pt(e,lt)||ht(e)));if(s.length){const e=n[n.length-1];e&&!1!==e.preload&&s.forEach((e=>t(e)))}return e(...n)};return{...r,chmod:r.chmod,cp:o(r.cp),mkdir:r.mkdir,stat:o(r.stat),rm:r.rm,read:o(r.read),touch:r.touch,write:r.write,mv:o(r.mv),flush:r.flush,ls:o((async function*(...e){for await(const t of r.ls(...e))yield{...t,size:t.size||0}}))}}const ad="Ed25519";class cd{constructor({keychain:e}){this.gen=function({keychain:e}){return St(((t,n={type:ad,size:2048})=>e.createKey(t,n.type||ad,n.size||2048)))}({keychain:e}),this.list=function({keychain:e}){return St((()=>e.listKeys()))}({keychain:e}),this.rm=function({keychain:e}){return St((t=>e.removeKey(t)))}({keychain:e}),this.rename=function({keychain:e}){return St((async(t,n)=>{const s=await e.renameKey(t,n);return{was:t,now:s.name,id:s.id,overwrite:!1}}))}({keychain:e}),this.export=function({keychain:e}){return St(((t,n)=>e.exportKey(t,n)))}({keychain:e}),this.import=function({keychain:e}){return St(((t,n,s)=>e.importKey(t,n,s)))}({keychain:e}),this.info=function({keychain:e}){return St((t=>e.findKeyByName(t)))}({keychain:e})}}function ld({repo:e,preload:t}){return St((async function(n,s={}){!1!==s.preload&&t(n);const r=await e.blocks.get(n,s);return S.decode(r)}))}function dd(e,t=[]){for(const n in e){const s=e[n];if("/"===n&&1===Object.keys(e).length)try{t.push({Name:"",Tsize:0,Hash:J.TO.parse(s)});continue}catch(e){}const r=J.TO.asCID(s);r?t.push({Name:"",Tsize:0,Hash:r}):(Array.isArray(s)&&dd(s,t),s&&"object"==typeof s&&dd(s,t))}return t}function ud({repo:e,codecs:t}){return St((async function(n,s={}){const r=await t.getCodec(n.code),o=await e.blocks.get(n,s),i=r.decode(o);switch(n.code){case Po.code:return[];case S.code:return i.Links;case k.code:case R.code:return dd(i);default:throw new Error(`Cannot resolve links from codec ${n.code}`)}}))}function hd({repo:e,preload:t}){return St((async function(n,s={}){const r=await e.gcLock.readLock();try{const r=S.encode(n),o=await co.sha256.digest(r),i=J.TO.createV1(S.code,o);return await e.blocks.put(i,r,{signal:s.signal}),!1!==s.preload&&t(i),s.pin&&await e.pins.pinRecursively(i,{signal:s.signal}),i}finally{r()}}))}class pd{constructor({repo:e,preload:t}){this.addLink=function({repo:e,preload:t}){const n=ld({repo:e,preload:t}),s=hd({repo:e,preload:t});return St((async function(e,t,r={}){const o=await n(e,r);return s({...o,Links:o.Links.concat([t])},r)}))}({repo:e,preload:t}),this.appendData=function({repo:e,preload:t}){const n=ld({repo:e,preload:t}),s=hd({repo:e,preload:t});return St((async function(e,t,r={}){const o=await n(e,r),i=(0,ee.x)([o.Data||[],t]);return s({...o,Data:i},r)}))}({repo:e,preload:t}),this.rmLink=function({repo:e,preload:t}){const n=ld({repo:e,preload:t}),s=hd({repo:e,preload:t});return St((async function(e,t,r={}){const o=await n(e,r),i=("string"==typeof t?t:t.Name)||"";return o.Links=o.Links.filter((e=>e.Name!==i)),s(o,r)}))}({repo:e,preload:t}),this.setData=function({repo:e,preload:t}){const n=ld({repo:e,preload:t}),s=hd({repo:e,preload:t});return St((async function(e,t,r={}){const o=await n(e,r);return s({...o,Data:t},r)}))}({repo:e,preload:t})}}class fd{constructor({repo:e,codecs:t,preload:n}){this.data=function({repo:e,preload:t}){const n=ld({repo:e,preload:t});return St((async function(e,t={}){return(await n(e,t)).Data||new Uint8Array(0)}))}({repo:e,preload:n}),this.get=ld({repo:e,preload:n}),this.links=ud({repo:e,codecs:t}),this.new=function({repo:e,preload:t}){return St((async function(n={}){let s;if(n.template){if("unixfs-dir"!==n.template)throw new Error("unknown template");s=new v({type:"directory"}).marshal()}const r=S.encode({Data:s,Links:[]}),o=await co.sha256.digest(r),i=J.TO.createV0(o);return await e.blocks.put(i,r,{signal:n.signal}),!1!==n.preload&&t(i),i}))}({repo:e,preload:n}),this.put=hd({repo:e,preload:n}),this.stat=function({repo:e,preload:t}){const n=ld({repo:e,preload:t});return St((async function(e,t={}){const s=await n(e,t),r=S.encode(s).length,o=s.Links.reduce(((e,t)=>e+(t.Tsize||0)),0);return{Hash:e,NumLinks:s.Links.length,BlockSize:r,LinksSize:r-(s.Data||[]).length,DataSize:(s.Data||[]).length,CumulativeSize:r+o}}))}({repo:e,preload:n}),this.patch=new pd({repo:e,preload:n})}}const yd=(0,a.vF)("ipfs:repo:gc");function gd({repo:e}){return St((async function(t={}){const n=await e.stat();return{numObjects:BigInt(n.numObjects.toString()),repoSize:BigInt(n.repoSize.toString()),repoPath:n.repoPath,version:`${n.version}`,storageMax:BigInt(n.storageMax.toString())}}))}const md=12;class wd{constructor({repo:e,hashers:t}){this.gc=function({repo:e,hashers:t}){return St((async function*(n={}){const s=Date.now();let r;try{r=await Tc({repo:e,hashers:t},n),await e.pins.pinRecursively(r),yield*e.gc()}finally{r&&await e.pins.unpin(r)}yd(`Complete (${Date.now()-s}ms)`)}))}({repo:e,hashers:t}),this.stat=gd({repo:e}),this.version=function({repo:e}){return St((async function(t={}){try{await e._checkInitialized(t)}catch(e){if([/Key not found in database \[\/version\]/,/ENOENT/,/repo is not initialized yet/].some((t=>t.test(e.message))))return md;throw e}return e.version.get()}))}({repo:e}),this.setApiAddr=t=>e.apiAddr.set(t)}}function bd(e,t){return{totalIn:BigInt(0),totalOut:BigInt(0),rateIn:0,rateOut:0}}class _d{constructor({repo:e,network:t}){this.repo=gd({repo:e}),this.bw=function({network:e}){return St((async function*(t={}){const{libp2p:n}=await e.use(t);if(!t.poll)return void(yield bd());const s=t.interval||1e3;let r,o=-1;try{if(o="string"==typeof s?(0,Et.A)(s)||-1:s,!o||o<0)throw new Error("invalid duration")}catch(e){throw c(e,"ERR_INVALID_POLL_INTERVAL")}try{for(;;)yield bd(),await new Promise((e=>{r=setTimeout(e,o)}))}finally{clearTimeout(r)}}))}({network:t}),this.bitswap=Ps({network:t})}}var Ed=function(e,t,n){if(!e)return n;var s,r;Array.isArray(t)&&(s=t.slice(0));"string"==typeof t&&(s=t.split("."));"symbol"==typeof t&&(s=[t]);if(!Array.isArray(s))throw new Error("props arg must be an array, a string or a symbol");for(;s.length;){if(r=s.shift(),!e)return n;if(void 0===(e=e[r]))return n}return e};var vd=n(17833);async function Sd(e){let t=0;for await(const n of e)t++;return t}const kd=vd("ipfs:repo:migrator:migration-8");function Rd(e){return e.child?Rd(e.child):e}function Td(e){try{const t=U.base32.decode(`b${e.toString().toLowerCase().slice(1)}`),n=J.TO.decode(t).multihash.bytes,s=U.base32.encode(n).slice(1).toUpperCase();return new bt.U(`/${s}`,!1)}catch(t){return e}}function Id(e){try{const t=U.base32.decode(`b${e.toString().toLowerCase().slice(1)}`),n=F.D4(t),s=U.base32.encode(J.TO.createV1(Po.code,n).bytes).slice(1);return new bt.U(`/${s.toUpperCase()}`,!1)}catch{return e}}async function Pd(e,t,n){const s=e.blocks;await s.open();const r=Rd(s),o=await Sd(r.queryKeys({filters:[e=>n(e).toString()!==e.toString()]}));try{let e=0;for await(const s of r.query({})){const i=n(s.key);i.toString()!==s.key.toString()&&(e+=1,kd(`Migrating Block from ${s.key} to ${i}`,await r.has(s.key)),await r.delete(s.key),await r.put(i,s.value),t(e/o*100,`Migrated Block from ${s.key} to ${i}`))}}finally{await s.close()}}const Ad={version:8,description:"Transforms key names into base32 encoding and converts Block store to use bare multihashes encoded as base32",migrate:(e,t=(()=>{}))=>Pd(e,t,Td),revert:(e,t=(()=>{}))=>Pd(e,t,Id)},Dd=l.Reader,Od=l.Writer,Nd=(l.util,l.roots.default||(l.roots.default={})),Ld=Nd.ipfs=(()=>{const e={};return e.pin=function(){const e={};return e.Set=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.version=0,e.prototype.fanout=0,e.prototype.seed=0,e.encode=function(e,t){return t||(t=Od.create()),null!=e.version&&Object.hasOwnProperty.call(e,"version")&&t.uint32(8).uint32(e.version),null!=e.fanout&&Object.hasOwnProperty.call(e,"fanout")&&t.uint32(16).uint32(e.fanout),null!=e.seed&&Object.hasOwnProperty.call(e,"seed")&&t.uint32(29).fixed32(e.seed),t},e.decode=function(e,t){e instanceof Dd||(e=Dd.create(e));for(var n=void 0===t?e.len:e.pos+t,s=new Nd.ipfs.pin.Set;e.pos<n;){var r=e.uint32();switch(r>>>3){case 1:s.version=e.uint32();break;case 2:s.fanout=e.uint32();break;case 3:s.seed=e.fixed32();break;default:e.skipType(7&r)}}return s},e.fromObject=function(e){if(e instanceof Nd.ipfs.pin.Set)return e;var t=new Nd.ipfs.pin.Set;return null!=e.version&&(t.version=e.version>>>0),null!=e.fanout&&(t.fanout=e.fanout>>>0),null!=e.seed&&(t.seed=e.seed>>>0),t},e.toObject=function(e,t){t||(t={});var n={};return t.defaults&&(n.version=0,n.fanout=0,n.seed=0),null!=e.version&&e.hasOwnProperty("version")&&(n.version=e.version),null!=e.fanout&&e.hasOwnProperty("fanout")&&(n.fanout=e.fanout),null!=e.seed&&e.hasOwnProperty("seed")&&(n.seed=e.seed),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,l.util.toJSONOptions)},e}(),e}(),e})();var Md=n(19951),Cd=n(2130);const xd=new bt.U("/local/pins"),Bd=256,zd=8192,Ud=J.TO.parse("QmdfTbBqBPQ7VNxZEYEj14VmRuZBkqFbiwReogJgS1zR1n"),Fd="direct",jd="recursive";function Hd(e){return new bt.U(`/${U.base32.encode(e.multihash.bytes).toUpperCase().substring(1)}`)}var $d=n(2149);const Vd=Ld.pin.Set;async function*Kd(e,t){const n=function(e){const t=e.Data;if(!t)throw new Error("No data present");const n=Cd.decode(t),s=Cd.decode.bytes??0;if(s<=0)throw new Error("Invalid Set header length");if(s+n>t.length)throw new Error("Impossibly large set header length");const r=t.slice(s,n+s),o=Vd.toObject(Vd.decode(r),{defaults:!1,arrays:!0,longs:Number,objects:!1});if(1!==o.version)throw new Error(`Unsupported Set version: ${o.version}`);if(o.fanout>e.Links.length)throw new Error("Impossibly large fanout");return{header:o,data:t.slice(n+s)}}(t);let s=0;for(const r of t.Links){if(s<n.header.fanout){const t=r.Hash;if(!Ud.equals(t)){const n=await e.get(t),s=S.decode(n);yield*Kd(e,s)}}else yield r.Hash;s++}}async function*qd(e,t,n){const s=t.Links.find((e=>e.Name===n));if(!s)throw new Error("No link found with name "+n);const r=await e.get(s.Hash),o=S.decode(r);yield*Kd(e,o)}function Gd(e,t){return async function t(n,s){const r=Vd.encode({version:1,fanout:Bd,seed:s}).finish(),o=Cd.encode(r.length),i=(0,ee.x)([o,r]),a=[];for(let e=0;e<Bd;e++)a.push({Name:"",Tsize:1,Hash:Ud});if(n.length<=zd){const e=n.map((e=>({link:{Name:"",Tsize:1,Hash:e.key},data:e.data||new Uint8Array}))).sort(((e,t)=>(0,$d.U)(e.link.Hash.bytes,t.link.Hash.bytes))),t=a.concat(e.map((e=>e.link)));return{Data:(0,ee.x)([i,...e.map((e=>e.data))]),Links:t}}{const e=n.reduce(((e,t)=>{const n=function(e,t){const n=new Uint8Array(4);new DataView(n.buffer).setUint32(0,e,!0);const s=(0,x.s)(t.toString()),r=(0,ee.x)([n,s],n.byteLength+s.byteLength);return Md((0,$.d)(r))}(s,t.key)%Bd;return e[n]=n in e?e[n].concat([t]):[t],e}),[]);let r=0;for(const n of e){const e=await t(n,s+1);await c(e,r),r++}return{Data:i,Links:a}}async function c(t,n){const s=S.encode(t),r=await co.sha256.digest(s),o=J.TO.createV0(r);await e.put(o,s);const i=t.Links.reduce(((e,t)=>e+(t.Tsize||0)),0)+s.length;a[n]={Name:"",Tsize:i,Hash:o}}}(t,0)}async function Wd(e,t,n){const s=await Gd(e,n.map((e=>({key:e})))),r=S.encode(s),o=await co.sha256.digest(r),i=J.TO.createV0(o);await e.put(i,r);return{Name:t,Tsize:s.Links.reduce(((e,t)=>e+t.Tsize),0)+r.length,Hash:i}}async function Yd(e,t,n,s){if(!await t.has(xd))return;const r=await t.get(xd),o=J.TO.decode(r),i=await e.get(o),a=S.decode(i);let c=0;const l=await Sd(qd(e,a,jd))+await Sd(qd(e,a,Fd));for await(const t of qd(e,a,jd)){c++;const e={depth:1/0};0!==t.version&&(e.version=t.version),t.code!==S.code&&(e.codec=t.code),await n.put(Hd(t),fn.lF(e)),s(c/l*100,`Migrated recursive pin ${t}`)}for await(const t of qd(e,a,Fd)){c++;const e={depth:0};0!==t.version&&(e.version=t.version),t.code!==S.code&&(e.codec=t.code),await n.put(Hd(t),fn.lF(e)),s(c/l*100,`Migrated direct pin ${t}`)}await e.delete(o),await t.delete(xd)}async function Xd(e,t,n,s){const r=[],o=[];let i=0;const a=await Sd(n.queryKeys({}));for await(const{key:e,value:t}of n.query({})){i++;const n=fn.D4(t),c=J.TO.create(n.version||0,n.codec||S.code,F.D4(U.base32.decode("b"+e.toString().toLowerCase().split("/").pop())));0===n.depth?(s(i/a*100,`Reverted direct pin ${c}`),o.push(c)):(s(i/a*100,`Reverted recursive pin ${c}`),r.push(c))}s(100,"Updating pin root");const c={Links:[await Wd(e,Fd,o),await Wd(e,jd,r)]},l=S.encode(c),d=await co.sha256.digest(l),u=J.TO.createV0(d);await e.put(u,l),await t.put(xd,u.bytes)}async function Qd(e,t,n){const s=e.blocks,r=e.datastore,o=e.pins;await s.open(),await r.open(),await o.open();try{await n(s,r,o,t)}finally{await o.close(),await r.close(),await s.close()}}const Jd={version:9,description:"Migrates pins to datastore",migrate:(e,t=(()=>{}))=>Qd(e,t,Yd),revert:(e,t=(()=>{}))=>Qd(e,t,Xd)};function Zd(e){return e=e||new Error("Not Found"),c(e,"ERR_NOT_FOUND")}const eu=new bt.U("/config"),tu=new bt.U("/version");function nu(e){let t=e;for(;t.db||t.child;)if(t=t.db||t.child,"level-js"===t.type||"Level"===t.constructor.name)return t}function su(e){const t=e.get.bind(e),n=e.has.bind(e);return e.get=s=>async function(e,t,n,s){if(await n(e))return t(e);const r=nu(s);if(!r)throw Zd();return new Promise(((t,n)=>{const s=r.store("readonly").get(e.toString());s.transaction.onabort=()=>{n(s.transaction.error)},s.transaction.oncomplete=()=>{if(s.result)return t(s.result);n(Zd())}}))}(s,t,n,e),e.has=t=>async function(e,t,n){const s=await t(e);if(s)return s;const r=nu(n);return!!r&&new Promise(((t,n)=>{const s=r.store("readonly").get(e.toString());s.transaction.onabort=()=>{n(s.transaction.error)},s.transaction.oncomplete=()=>{t(Boolean(s.result))}}))}(t,n,e),e}function ru(e){return{...e,root:su(e.root),datastore:su(e.datastore),pins:su(e.pins),keys:su(e.keys)}}async function ou(e,t,n=(()=>{})){const s=nu(t);if(!s)return void n(`${e} did not need an upgrade`);n(`Upgrading ${e}`);await du(s,((e,t)=>[{type:"del",key:e},{type:"put",key:(0,x.s)(e),value:t}]))}async function iu(e,t,n=(()=>{})){const s=nu(t);if(!s)return void n(`${e} did not need a downgrade`);n(`Downgrading ${e}`);await du(s,((e,t)=>[{type:"del",key:e},{type:"put",key:(0,$.d)(e),value:t}]))}function au(e){return e.child?au(e.child):e}async function cu(e,t,n){const s=Object.entries(e).map((([e,t])=>({key:e,backend:au(t)}))).filter((({key:e,backend:t})=>"LevelDatastore"===t.constructor.name)).map((({key:e,backend:t})=>({name:e,store:t})));t(0,`Migrating ${s.length} dbs`);let r=0;const o=e=>{t(Math.round(r/s.length*100),e)};for(const{name:e,store:t}of s){await t.open();try{await n(e,t,o)}finally{r++,await t.close()}}t(100,`Migrated ${s.length} dbs`)}const lu={version:10,description:"Migrates datastore-level keys to binary",migrate:(e,t=(()=>{}))=>cu(e,t,ou),revert:(e,t=(()=>{}))=>cu(e,t,iu)};function du(e,t){return new Promise(((n,s)=>{const r=e.iterator();r._deserializeKey=r._deserializeValue=e=>e,function o(){const i=(i,a,c)=>{if(i||void 0===a){const e=e=>{e?s(e):n()};r.end(e)}else!function(t,n){const s=e.store("readwrite"),r=s.transaction;let o,i=0;r.onabort=()=>n(o||r.error||new Error("aborted by user")),r.oncomplete=()=>n(),function e(){const n=t[i++],a=n.key;let c;try{c="del"===n.type?s.delete(a):s.put(n.value,a)}catch(e){return o=e,void r.abort()}i<t.length&&(c.onsuccess=e)}()}(t(a,c),o)};r.next(i)}()}))}const uu=new bt.U("/local/filesroot");const hu={version:11,description:"Store mfs root in the datastore",migrate:async function(e,t=(()=>{})){if(t(100,"Migrating MFS root to repo datastore"),await e.root.open(),await e.datastore.open(),await e.root.has(uu)){const t=await e.root.get(uu);await e.datastore.put(uu,t),await e.root.delete(uu)}await e.datastore.close(),await e.root.close(),t(100,"Stored MFS root in repo datastore")},revert:async function(e,t=(()=>{})){if(t(100,"Migrating MFS root to repo root datastore"),await e.root.open(),await e.datastore.open(),await e.datastore.has(uu)){const t=await e.datastore.get(uu);await e.root.put(uu,t),await e.datastore.delete(uu)}await e.datastore.close(),await e.root.close(),t(100,"Stored MFS root in repo root datastore")}},pu=l.Reader,fu=l.Writer,yu=l.util,gu=l.roots.default||(l.roots.default={}),mu=gu.Protocols=(()=>{function e(e){if(this.protocols=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.protocols=yu.emptyArray,e.encode=function(e,t){if(t||(t=fu.create()),null!=e.protocols&&e.protocols.length)for(var n=0;n<e.protocols.length;++n)t.uint32(10).string(e.protocols[n]);return t},e.decode=function(e,t){e instanceof pu||(e=pu.create(e));for(var n=void 0===t?e.len:e.pos+t,s=new gu.Protocols;e.pos<n;){var r=e.uint32();if(r>>>3==1)s.protocols&&s.protocols.length||(s.protocols=[]),s.protocols.push(e.string());else e.skipType(7&r)}return s},e.fromObject=function(e){if(e instanceof gu.Protocols)return e;var t=new gu.Protocols;if(e.protocols){if(!Array.isArray(e.protocols))throw TypeError(".Protocols.protocols: array expected");t.protocols=[];for(var n=0;n<e.protocols.length;++n)t.protocols[n]=String(e.protocols[n])}return t},e.toObject=function(e,t){t||(t={});var n={};if((t.arrays||t.defaults)&&(n.protocols=[]),e.protocols&&e.protocols.length){n.protocols=[];for(var s=0;s<e.protocols.length;++s)n.protocols[s]=e.protocols[s]}return n},e.prototype.toJSON=function(){return this.constructor.toObject(this,l.util.toJSONOptions)},e})(),wu=l.Reader,bu=l.Writer,_u=l.util,Eu=l.roots.default||(l.roots.default={}),vu=Eu.Addresses=(()=>{function e(e){if(this.addrs=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.addrs=_u.emptyArray,e.prototype.certifiedRecord=null,e.encode=function(e,t){if(t||(t=bu.create()),null!=e.addrs&&e.addrs.length)for(var n=0;n<e.addrs.length;++n)Eu.Addresses.Address.encode(e.addrs[n],t.uint32(10).fork()).ldelim();return null!=e.certifiedRecord&&Object.hasOwnProperty.call(e,"certifiedRecord")&&Eu.Addresses.CertifiedRecord.encode(e.certifiedRecord,t.uint32(18).fork()).ldelim(),t},e.decode=function(e,t){e instanceof wu||(e=wu.create(e));for(var n=void 0===t?e.len:e.pos+t,s=new Eu.Addresses;e.pos<n;){var r=e.uint32();switch(r>>>3){case 1:s.addrs&&s.addrs.length||(s.addrs=[]),s.addrs.push(Eu.Addresses.Address.decode(e,e.uint32()));break;case 2:s.certifiedRecord=Eu.Addresses.CertifiedRecord.decode(e,e.uint32());break;default:e.skipType(7&r)}}return s},e.fromObject=function(e){if(e instanceof Eu.Addresses)return e;var t=new Eu.Addresses;if(e.addrs){if(!Array.isArray(e.addrs))throw TypeError(".Addresses.addrs: array expected");t.addrs=[];for(var n=0;n<e.addrs.length;++n){if("object"!=typeof e.addrs[n])throw TypeError(".Addresses.addrs: object expected");t.addrs[n]=Eu.Addresses.Address.fromObject(e.addrs[n])}}if(null!=e.certifiedRecord){if("object"!=typeof e.certifiedRecord)throw TypeError(".Addresses.certifiedRecord: object expected");t.certifiedRecord=Eu.Addresses.CertifiedRecord.fromObject(e.certifiedRecord)}return t},e.toObject=function(e,t){t||(t={});var n={};if((t.arrays||t.defaults)&&(n.addrs=[]),t.defaults&&(n.certifiedRecord=null),e.addrs&&e.addrs.length){n.addrs=[];for(var s=0;s<e.addrs.length;++s)n.addrs[s]=Eu.Addresses.Address.toObject(e.addrs[s],t)}return null!=e.certifiedRecord&&e.hasOwnProperty("certifiedRecord")&&(n.certifiedRecord=Eu.Addresses.CertifiedRecord.toObject(e.certifiedRecord,t)),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,l.util.toJSONOptions)},e.Address=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}let t;return e.prototype.multiaddr=_u.newBuffer([]),e.prototype.isCertified=null,Object.defineProperty(e.prototype,"_isCertified",{get:_u.oneOfGetter(t=["isCertified"]),set:_u.oneOfSetter(t)}),e.encode=function(e,t){return t||(t=bu.create()),null!=e.multiaddr&&Object.hasOwnProperty.call(e,"multiaddr")&&t.uint32(10).bytes(e.multiaddr),null!=e.isCertified&&Object.hasOwnProperty.call(e,"isCertified")&&t.uint32(16).bool(e.isCertified),t},e.decode=function(e,t){e instanceof wu||(e=wu.create(e));for(var n=void 0===t?e.len:e.pos+t,s=new Eu.Addresses.Address;e.pos<n;){var r=e.uint32();switch(r>>>3){case 1:s.multiaddr=e.bytes();break;case 2:s.isCertified=e.bool();break;default:e.skipType(7&r)}}return s},e.fromObject=function(e){if(e instanceof Eu.Addresses.Address)return e;var t=new Eu.Addresses.Address;return null!=e.multiaddr&&("string"==typeof e.multiaddr?_u.base64.decode(e.multiaddr,t.multiaddr=_u.newBuffer(_u.base64.length(e.multiaddr)),0):e.multiaddr.length&&(t.multiaddr=e.multiaddr)),null!=e.isCertified&&(t.isCertified=Boolean(e.isCertified)),t},e.toObject=function(e,t){t||(t={});var n={};return t.defaults&&(t.bytes===String?n.multiaddr="":(n.multiaddr=[],t.bytes!==Array&&(n.multiaddr=_u.newBuffer(n.multiaddr)))),null!=e.multiaddr&&e.hasOwnProperty("multiaddr")&&(n.multiaddr=t.bytes===String?_u.base64.encode(e.multiaddr,0,e.multiaddr.length):t.bytes===Array?Array.prototype.slice.call(e.multiaddr):e.multiaddr),null!=e.isCertified&&e.hasOwnProperty("isCertified")&&(n.isCertified=e.isCertified,t.oneofs&&(n._isCertified="isCertified")),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,l.util.toJSONOptions)},e}(),e.CertifiedRecord=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.seq=_u.Long?_u.Long.fromBits(0,0,!0):0,e.prototype.raw=_u.newBuffer([]),e.encode=function(e,t){return t||(t=bu.create()),null!=e.seq&&Object.hasOwnProperty.call(e,"seq")&&t.uint32(8).uint64(e.seq),null!=e.raw&&Object.hasOwnProperty.call(e,"raw")&&t.uint32(18).bytes(e.raw),t},e.decode=function(e,t){e instanceof wu||(e=wu.create(e));for(var n=void 0===t?e.len:e.pos+t,s=new Eu.Addresses.CertifiedRecord;e.pos<n;){var r=e.uint32();switch(r>>>3){case 1:s.seq=e.uint64();break;case 2:s.raw=e.bytes();break;default:e.skipType(7&r)}}return s},e.fromObject=function(e){if(e instanceof Eu.Addresses.CertifiedRecord)return e;var t=new Eu.Addresses.CertifiedRecord;return null!=e.seq&&(_u.Long?(t.seq=_u.Long.fromValue(e.seq)).unsigned=!0:"string"==typeof e.seq?t.seq=parseInt(e.seq,10):"number"==typeof e.seq?t.seq=e.seq:"object"==typeof e.seq&&(t.seq=new _u.LongBits(e.seq.low>>>0,e.seq.high>>>0).toNumber(!0))),null!=e.raw&&("string"==typeof e.raw?_u.base64.decode(e.raw,t.raw=_u.newBuffer(_u.base64.length(e.raw)),0):e.raw.length&&(t.raw=e.raw)),t},e.toObject=function(e,t){t||(t={});var n={};if(t.defaults){if(_u.Long){var s=new _u.Long(0,0,!0);n.seq=t.longs===String?s.toString():t.longs===Number?s.toNumber():s}else n.seq=t.longs===String?"0":0;t.bytes===String?n.raw="":(n.raw=[],t.bytes!==Array&&(n.raw=_u.newBuffer(n.raw)))}return null!=e.seq&&e.hasOwnProperty("seq")&&("number"==typeof e.seq?n.seq=t.longs===String?String(e.seq):e.seq:n.seq=t.longs===String?_u.Long.prototype.toString.call(e.seq):t.longs===Number?new _u.LongBits(e.seq.low>>>0,e.seq.high>>>0).toNumber(!0):e.seq),null!=e.raw&&e.hasOwnProperty("raw")&&(n.raw=t.bytes===String?_u.base64.encode(e.raw,0,e.raw.length):t.bytes===Array?Array.prototype.slice.call(e.raw):e.raw),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,l.util.toJSONOptions)},e}(),e})(),Su=l.Reader,ku=l.Writer,Ru=l.util,Tu=l.roots.default||(l.roots.default={}),Iu=Tu.Peer=(()=>{function e(e){if(this.addresses=[],this.protocols=[],this.metadata=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}let t;return e.prototype.addresses=Ru.emptyArray,e.prototype.protocols=Ru.emptyArray,e.prototype.metadata=Ru.emptyArray,e.prototype.pubKey=null,e.prototype.peerRecordEnvelope=null,Object.defineProperty(e.prototype,"_pubKey",{get:Ru.oneOfGetter(t=["pubKey"]),set:Ru.oneOfSetter(t)}),Object.defineProperty(e.prototype,"_peerRecordEnvelope",{get:Ru.oneOfGetter(t=["peerRecordEnvelope"]),set:Ru.oneOfSetter(t)}),e.encode=function(e,t){if(t||(t=ku.create()),null!=e.addresses&&e.addresses.length)for(var n=0;n<e.addresses.length;++n)Tu.Address.encode(e.addresses[n],t.uint32(10).fork()).ldelim();if(null!=e.protocols&&e.protocols.length)for(n=0;n<e.protocols.length;++n)t.uint32(18).string(e.protocols[n]);if(null!=e.metadata&&e.metadata.length)for(n=0;n<e.metadata.length;++n)Tu.Metadata.encode(e.metadata[n],t.uint32(26).fork()).ldelim();return null!=e.pubKey&&Object.hasOwnProperty.call(e,"pubKey")&&t.uint32(34).bytes(e.pubKey),null!=e.peerRecordEnvelope&&Object.hasOwnProperty.call(e,"peerRecordEnvelope")&&t.uint32(42).bytes(e.peerRecordEnvelope),t},e.decode=function(e,t){e instanceof Su||(e=Su.create(e));for(var n=void 0===t?e.len:e.pos+t,s=new Tu.Peer;e.pos<n;){var r=e.uint32();switch(r>>>3){case 1:s.addresses&&s.addresses.length||(s.addresses=[]),s.addresses.push(Tu.Address.decode(e,e.uint32()));break;case 2:s.protocols&&s.protocols.length||(s.protocols=[]),s.protocols.push(e.string());break;case 3:s.metadata&&s.metadata.length||(s.metadata=[]),s.metadata.push(Tu.Metadata.decode(e,e.uint32()));break;case 4:s.pubKey=e.bytes();break;case 5:s.peerRecordEnvelope=e.bytes();break;default:e.skipType(7&r)}}return s},e.fromObject=function(e){if(e instanceof Tu.Peer)return e;var t=new Tu.Peer;if(e.addresses){if(!Array.isArray(e.addresses))throw TypeError(".Peer.addresses: array expected");t.addresses=[];for(var n=0;n<e.addresses.length;++n){if("object"!=typeof e.addresses[n])throw TypeError(".Peer.addresses: object expected");t.addresses[n]=Tu.Address.fromObject(e.addresses[n])}}if(e.protocols){if(!Array.isArray(e.protocols))throw TypeError(".Peer.protocols: array expected");t.protocols=[];for(n=0;n<e.protocols.length;++n)t.protocols[n]=String(e.protocols[n])}if(e.metadata){if(!Array.isArray(e.metadata))throw TypeError(".Peer.metadata: array expected");t.metadata=[];for(n=0;n<e.metadata.length;++n){if("object"!=typeof e.metadata[n])throw TypeError(".Peer.metadata: object expected");t.metadata[n]=Tu.Metadata.fromObject(e.metadata[n])}}return null!=e.pubKey&&("string"==typeof e.pubKey?Ru.base64.decode(e.pubKey,t.pubKey=Ru.newBuffer(Ru.base64.length(e.pubKey)),0):e.pubKey.length&&(t.pubKey=e.pubKey)),null!=e.peerRecordEnvelope&&("string"==typeof e.peerRecordEnvelope?Ru.base64.decode(e.peerRecordEnvelope,t.peerRecordEnvelope=Ru.newBuffer(Ru.base64.length(e.peerRecordEnvelope)),0):e.peerRecordEnvelope.length&&(t.peerRecordEnvelope=e.peerRecordEnvelope)),t},e.toObject=function(e,t){t||(t={});var n={};if((t.arrays||t.defaults)&&(n.addresses=[],n.protocols=[],n.metadata=[]),e.addresses&&e.addresses.length){n.addresses=[];for(var s=0;s<e.addresses.length;++s)n.addresses[s]=Tu.Address.toObject(e.addresses[s],t)}if(e.protocols&&e.protocols.length){n.protocols=[];for(s=0;s<e.protocols.length;++s)n.protocols[s]=e.protocols[s]}if(e.metadata&&e.metadata.length){n.metadata=[];for(s=0;s<e.metadata.length;++s)n.metadata[s]=Tu.Metadata.toObject(e.metadata[s],t)}return null!=e.pubKey&&e.hasOwnProperty("pubKey")&&(n.pubKey=t.bytes===String?Ru.base64.encode(e.pubKey,0,e.pubKey.length):t.bytes===Array?Array.prototype.slice.call(e.pubKey):e.pubKey,t.oneofs&&(n._pubKey="pubKey")),null!=e.peerRecordEnvelope&&e.hasOwnProperty("peerRecordEnvelope")&&(n.peerRecordEnvelope=t.bytes===String?Ru.base64.encode(e.peerRecordEnvelope,0,e.peerRecordEnvelope.length):t.bytes===Array?Array.prototype.slice.call(e.peerRecordEnvelope):e.peerRecordEnvelope,t.oneofs&&(n._peerRecordEnvelope="peerRecordEnvelope")),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,l.util.toJSONOptions)},e})(),Pu=(Tu.Address=(()=>{function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}let t;return e.prototype.multiaddr=Ru.newBuffer([]),e.prototype.isCertified=null,Object.defineProperty(e.prototype,"_isCertified",{get:Ru.oneOfGetter(t=["isCertified"]),set:Ru.oneOfSetter(t)}),e.encode=function(e,t){return t||(t=ku.create()),null!=e.multiaddr&&Object.hasOwnProperty.call(e,"multiaddr")&&t.uint32(10).bytes(e.multiaddr),null!=e.isCertified&&Object.hasOwnProperty.call(e,"isCertified")&&t.uint32(16).bool(e.isCertified),t},e.decode=function(e,t){e instanceof Su||(e=Su.create(e));for(var n=void 0===t?e.len:e.pos+t,s=new Tu.Address;e.pos<n;){var r=e.uint32();switch(r>>>3){case 1:s.multiaddr=e.bytes();break;case 2:s.isCertified=e.bool();break;default:e.skipType(7&r)}}return s},e.fromObject=function(e){if(e instanceof Tu.Address)return e;var t=new Tu.Address;return null!=e.multiaddr&&("string"==typeof e.multiaddr?Ru.base64.decode(e.multiaddr,t.multiaddr=Ru.newBuffer(Ru.base64.length(e.multiaddr)),0):e.multiaddr.length&&(t.multiaddr=e.multiaddr)),null!=e.isCertified&&(t.isCertified=Boolean(e.isCertified)),t},e.toObject=function(e,t){t||(t={});var n={};return t.defaults&&(t.bytes===String?n.multiaddr="":(n.multiaddr=[],t.bytes!==Array&&(n.multiaddr=Ru.newBuffer(n.multiaddr)))),null!=e.multiaddr&&e.hasOwnProperty("multiaddr")&&(n.multiaddr=t.bytes===String?Ru.base64.encode(e.multiaddr,0,e.multiaddr.length):t.bytes===Array?Array.prototype.slice.call(e.multiaddr):e.multiaddr),null!=e.isCertified&&e.hasOwnProperty("isCertified")&&(n.isCertified=e.isCertified,t.oneofs&&(n._isCertified="isCertified")),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,l.util.toJSONOptions)},e})(),Tu.Metadata=(()=>{function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.key="",e.prototype.value=Ru.newBuffer([]),e.encode=function(e,t){return t||(t=ku.create()),null!=e.key&&Object.hasOwnProperty.call(e,"key")&&t.uint32(10).string(e.key),null!=e.value&&Object.hasOwnProperty.call(e,"value")&&t.uint32(18).bytes(e.value),t},e.decode=function(e,t){e instanceof Su||(e=Su.create(e));for(var n=void 0===t?e.len:e.pos+t,s=new Tu.Metadata;e.pos<n;){var r=e.uint32();switch(r>>>3){case 1:s.key=e.string();break;case 2:s.value=e.bytes();break;default:e.skipType(7&r)}}return s},e.fromObject=function(e){if(e instanceof Tu.Metadata)return e;var t=new Tu.Metadata;return null!=e.key&&(t.key=String(e.key)),null!=e.value&&("string"==typeof e.value?Ru.base64.decode(e.value,t.value=Ru.newBuffer(Ru.base64.length(e.value)),0):e.value.length&&(t.value=e.value)),t},e.toObject=function(e,t){t||(t={});var n={};return t.defaults&&(n.key="",t.bytes===String?n.value="":(n.value=[],t.bytes!==Array&&(n.value=Ru.newBuffer(n.value)))),null!=e.key&&e.hasOwnProperty("key")&&(n.key=e.key),null!=e.value&&e.hasOwnProperty("value")&&(n.value=t.bytes===String?Ru.base64.encode(e.value,0,e.value.length):t.bytes===Array?Array.prototype.slice.call(e.value):e.value),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,l.util.toJSONOptions)},e})(),l.Reader),Au=l.Writer,Du=l.util,Ou=l.roots.default||(l.roots.default={}),Nu=Ou.Envelope=(()=>{function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.publicKey=Du.newBuffer([]),e.prototype.payloadType=Du.newBuffer([]),e.prototype.payload=Du.newBuffer([]),e.prototype.signature=Du.newBuffer([]),e.encode=function(e,t){return t||(t=Au.create()),null!=e.publicKey&&Object.hasOwnProperty.call(e,"publicKey")&&t.uint32(10).bytes(e.publicKey),null!=e.payloadType&&Object.hasOwnProperty.call(e,"payloadType")&&t.uint32(18).bytes(e.payloadType),null!=e.payload&&Object.hasOwnProperty.call(e,"payload")&&t.uint32(26).bytes(e.payload),null!=e.signature&&Object.hasOwnProperty.call(e,"signature")&&t.uint32(42).bytes(e.signature),t},e.decode=function(e,t){e instanceof Pu||(e=Pu.create(e));for(var n=void 0===t?e.len:e.pos+t,s=new Ou.Envelope;e.pos<n;){var r=e.uint32();switch(r>>>3){case 1:s.publicKey=e.bytes();break;case 2:s.payloadType=e.bytes();break;case 3:s.payload=e.bytes();break;case 5:s.signature=e.bytes();break;default:e.skipType(7&r)}}return s},e.fromObject=function(e){if(e instanceof Ou.Envelope)return e;var t=new Ou.Envelope;return null!=e.publicKey&&("string"==typeof e.publicKey?Du.base64.decode(e.publicKey,t.publicKey=Du.newBuffer(Du.base64.length(e.publicKey)),0):e.publicKey.length&&(t.publicKey=e.publicKey)),null!=e.payloadType&&("string"==typeof e.payloadType?Du.base64.decode(e.payloadType,t.payloadType=Du.newBuffer(Du.base64.length(e.payloadType)),0):e.payloadType.length&&(t.payloadType=e.payloadType)),null!=e.payload&&("string"==typeof e.payload?Du.base64.decode(e.payload,t.payload=Du.newBuffer(Du.base64.length(e.payload)),0):e.payload.length&&(t.payload=e.payload)),null!=e.signature&&("string"==typeof e.signature?Du.base64.decode(e.signature,t.signature=Du.newBuffer(Du.base64.length(e.signature)),0):e.signature.length&&(t.signature=e.signature)),t},e.toObject=function(e,t){t||(t={});var n={};return t.defaults&&(t.bytes===String?n.publicKey="":(n.publicKey=[],t.bytes!==Array&&(n.publicKey=Du.newBuffer(n.publicKey))),t.bytes===String?n.payloadType="":(n.payloadType=[],t.bytes!==Array&&(n.payloadType=Du.newBuffer(n.payloadType))),t.bytes===String?n.payload="":(n.payload=[],t.bytes!==Array&&(n.payload=Du.newBuffer(n.payload))),t.bytes===String?n.signature="":(n.signature=[],t.bytes!==Array&&(n.signature=Du.newBuffer(n.signature)))),null!=e.publicKey&&e.hasOwnProperty("publicKey")&&(n.publicKey=t.bytes===String?Du.base64.encode(e.publicKey,0,e.publicKey.length):t.bytes===Array?Array.prototype.slice.call(e.publicKey):e.publicKey),null!=e.payloadType&&e.hasOwnProperty("payloadType")&&(n.payloadType=t.bytes===String?Du.base64.encode(e.payloadType,0,e.payloadType.length):t.bytes===Array?Array.prototype.slice.call(e.payloadType):e.payloadType),null!=e.payload&&e.hasOwnProperty("payload")&&(n.payload=t.bytes===String?Du.base64.encode(e.payload,0,e.payload.length):t.bytes===Array?Array.prototype.slice.call(e.payload):e.payload),null!=e.signature&&e.hasOwnProperty("signature")&&(n.signature=t.bytes===String?Du.base64.encode(e.signature,0,e.signature.length):t.bytes===Array?Array.prototype.slice.call(e.signature):e.signature),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,l.util.toJSONOptions)},e})(),Lu=l.Reader,Mu=l.Writer,Cu=l.util,xu=l.roots.default||(l.roots.default={}),Bu=xu.PeerRecord=(()=>{function e(e){if(this.addresses=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.peerId=Cu.newBuffer([]),e.prototype.seq=Cu.Long?Cu.Long.fromBits(0,0,!0):0,e.prototype.addresses=Cu.emptyArray,e.encode=function(e,t){if(t||(t=Mu.create()),null!=e.peerId&&Object.hasOwnProperty.call(e,"peerId")&&t.uint32(10).bytes(e.peerId),null!=e.seq&&Object.hasOwnProperty.call(e,"seq")&&t.uint32(16).uint64(e.seq),null!=e.addresses&&e.addresses.length)for(var n=0;n<e.addresses.length;++n)xu.PeerRecord.AddressInfo.encode(e.addresses[n],t.uint32(26).fork()).ldelim();return t},e.decode=function(e,t){e instanceof Lu||(e=Lu.create(e));for(var n=void 0===t?e.len:e.pos+t,s=new xu.PeerRecord;e.pos<n;){var r=e.uint32();switch(r>>>3){case 1:s.peerId=e.bytes();break;case 2:s.seq=e.uint64();break;case 3:s.addresses&&s.addresses.length||(s.addresses=[]),s.addresses.push(xu.PeerRecord.AddressInfo.decode(e,e.uint32()));break;default:e.skipType(7&r)}}return s},e.fromObject=function(e){if(e instanceof xu.PeerRecord)return e;var t=new xu.PeerRecord;if(null!=e.peerId&&("string"==typeof e.peerId?Cu.base64.decode(e.peerId,t.peerId=Cu.newBuffer(Cu.base64.length(e.peerId)),0):e.peerId.length&&(t.peerId=e.peerId)),null!=e.seq&&(Cu.Long?(t.seq=Cu.Long.fromValue(e.seq)).unsigned=!0:"string"==typeof e.seq?t.seq=parseInt(e.seq,10):"number"==typeof e.seq?t.seq=e.seq:"object"==typeof e.seq&&(t.seq=new Cu.LongBits(e.seq.low>>>0,e.seq.high>>>0).toNumber(!0))),e.addresses){if(!Array.isArray(e.addresses))throw TypeError(".PeerRecord.addresses: array expected");t.addresses=[];for(var n=0;n<e.addresses.length;++n){if("object"!=typeof e.addresses[n])throw TypeError(".PeerRecord.addresses: object expected");t.addresses[n]=xu.PeerRecord.AddressInfo.fromObject(e.addresses[n])}}return t},e.toObject=function(e,t){t||(t={});var n={};if((t.arrays||t.defaults)&&(n.addresses=[]),t.defaults)if(t.bytes===String?n.peerId="":(n.peerId=[],t.bytes!==Array&&(n.peerId=Cu.newBuffer(n.peerId))),Cu.Long){var s=new Cu.Long(0,0,!0);n.seq=t.longs===String?s.toString():t.longs===Number?s.toNumber():s}else n.seq=t.longs===String?"0":0;if(null!=e.peerId&&e.hasOwnProperty("peerId")&&(n.peerId=t.bytes===String?Cu.base64.encode(e.peerId,0,e.peerId.length):t.bytes===Array?Array.prototype.slice.call(e.peerId):e.peerId),null!=e.seq&&e.hasOwnProperty("seq")&&("number"==typeof e.seq?n.seq=t.longs===String?String(e.seq):e.seq:n.seq=t.longs===String?Cu.Long.prototype.toString.call(e.seq):t.longs===Number?new Cu.LongBits(e.seq.low>>>0,e.seq.high>>>0).toNumber(!0):e.seq),e.addresses&&e.addresses.length){n.addresses=[];for(var r=0;r<e.addresses.length;++r)n.addresses[r]=xu.PeerRecord.AddressInfo.toObject(e.addresses[r],t)}return n},e.prototype.toJSON=function(){return this.constructor.toObject(this,l.util.toJSONOptions)},e.AddressInfo=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.multiaddr=Cu.newBuffer([]),e.encode=function(e,t){return t||(t=Mu.create()),null!=e.multiaddr&&Object.hasOwnProperty.call(e,"multiaddr")&&t.uint32(10).bytes(e.multiaddr),t},e.decode=function(e,t){e instanceof Lu||(e=Lu.create(e));for(var n=void 0===t?e.len:e.pos+t,s=new xu.PeerRecord.AddressInfo;e.pos<n;){var r=e.uint32();if(r>>>3==1)s.multiaddr=e.bytes();else e.skipType(7&r)}return s},e.fromObject=function(e){if(e instanceof xu.PeerRecord.AddressInfo)return e;var t=new xu.PeerRecord.AddressInfo;return null!=e.multiaddr&&("string"==typeof e.multiaddr?Cu.base64.decode(e.multiaddr,t.multiaddr=Cu.newBuffer(Cu.base64.length(e.multiaddr)),0):e.multiaddr.length&&(t.multiaddr=e.multiaddr)),t},e.toObject=function(e,t){t||(t={});var n={};return t.defaults&&(t.bytes===String?n.multiaddr="":(n.multiaddr=[],t.bytes!==Array&&(n.multiaddr=Cu.newBuffer(n.multiaddr)))),null!=e.multiaddr&&e.hasOwnProperty("multiaddr")&&(n.multiaddr=t.bytes===String?Cu.base64.encode(e.multiaddr,0,e.multiaddr.length):t.bytes===Array?Array.prototype.slice.call(e.multiaddr):e.multiaddr),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,l.util.toJSONOptions)},e}(),e})();l.util.Long=void 0,l.configure();const zu={version:12,description:"Store each peerstore peer under a single datastore key",migrate:async function(e,t=(()=>{})){t(0,"Storing each peerstore key under a single datastore key"),await e.datastore.open();const n={},s=[];for await(const{key:t,value:r}of e.datastore.query({prefix:"/peers"})){s.push(t);const e=t.toString(),[,o,i,a,c]=e.split("/");if("peers"===o&&(["protos","addrs","metadata","keys"].includes(i)&&a))if(n[a]=n[a]||{addresses:[],protocols:[],metadata:[]},"protos"===i){const e=mu.decode(r);n[a].protocols=e.protocols.sort()}else if("addrs"===i){const e=vu.decode(r);n[a].addresses=e.addrs.sort(((e,t)=>(0,j.HZ)(e.multiaddr).toString().localeCompare((0,j.HZ)(t.multiaddr).toString()))),e.certifiedRecord&&e.certifiedRecord.raw&&(n[a].peerRecordEnvelope=e.certifiedRecord.raw)}else"metadata"===i?n[a].metadata.push({key:c,value:r}):"keys"===i&&(n[a].pubKey=r)}t(33,"Read peer data from store");for(const t of s)await e.datastore.delete(t);t(66,"Removed existing peer data from store");for(const t of Object.keys(n)){const s=n[t];s.metadata=s.metadata.sort(((e,t)=>e.key.localeCompare(t.key)));const r=Iu.encode(s).finish();await e.datastore.put(new bt.U(`/peers/${t}`),r)}await e.datastore.close(),t(100,"Stored each peerstore key under a single datastore key")},revert:async function(e,t=(()=>{})){t(0,"Storing each peerstore key under a multiple datastore keys"),await e.datastore.open();const n={},s=[];for await(const{key:t,value:r}of e.datastore.query({prefix:"/peers"})){s.push(t);const e=t.toString(),[,,o]=e.split("/");n[o]=Iu.decode(r)}t(33,"Read peer data from store");for(const t of s)await e.datastore.delete(t);t(66,"Removed existing peer data from store");for(const[t,s]of Object.entries(n)){if(s.protocols&&s.protocols.length>0&&await e.datastore.put(new bt.U(`/peers/protos/${t}`),mu.encode({protocols:s.protocols}).finish()),s.addresses&&s.addresses.length>0){const n=s.peerRecordEnvelope;let r;if(n){const e=Nu.decode(n);r={raw:n,seq:Bu.decode(e.payload).seq}}await e.datastore.put(new bt.U(`/peers/addrs/${t}`),vu.encode({addrs:s.addresses,certifiedRecord:r}).finish())}if(s.metadata&&s.metadata.length>0)for(const{key:n,value:r}of s.metadata)await e.datastore.put(new bt.U(`/peers/metadata/${t}/${n}`),r);s.pubKey&&await e.datastore.put(new bt.U(`/peers/keys/${t}`),s.pubKey)}await e.datastore.close(),t(100,"Stored each peerstore key under multiple datastore keys")}},Uu={description:"Empty migration.",migrate:()=>{},revert:()=>{},empty:!0};var Fu=[Object.assign({version:1},Uu),Object.assign({version:2},Uu),Object.assign({version:3},Uu),Object.assign({version:4},Uu),Object.assign({version:5},Uu),Object.assign({version:6},Uu),Object.assign({version:7},Uu),Ad,Jd,lu,hu,zu];class ju extends Error{constructor(e){super(e),this.name="NonReversibleMigrationError",this.code=ju.code,this.message=e}}ju.code="ERR_NON_REVERSIBLE_MIGRATION";class Hu extends Error{constructor(e){super(e),this.name="NotInitializedRepoError",this.code=Hu.code,this.message=e}}Hu.code="ERR_NOT_INITIALIZED_REPO";class $u extends Error{constructor(e){super(e),this.name="RequiredParameterError",this.code=$u.code,this.message=e}}$u.code="ERR_REQUIRED_PARAMETER";class Vu extends Error{constructor(e){super(e),this.name="InvalidValueError",this.code=Vu.code,this.message=e}}Vu.code="ERR_INVALID_VALUE";class Ku extends Error{constructor(e){super(e),this.name="MissingRepoOptionsError",this.code=Ku.code,this.message=e}}Ku.code="ERR_MISSING_REPO_OPTIONS";const qu=vd("ipfs:repo:migrator:repo:init");async function Gu(e){if(!await async function(e){if(!e)throw new Ku("Please pass repo options when trying to open a repo");const t=e.root;try{await t.open();const e=await t.has(tu),n=await t.has(eu);return!(!e||!n)||(qu(`Version entry present: ${e}`),qu(`Config entry present: ${n}`),!1)}catch(e){return qu("While checking if repo is initialized error was thrown: "+e.message),!1}finally{if(void 0!==t)try{await t.close()}catch{}}}(e))throw new Hu("Repo is not initialized!");const t=e.root;await t.open();try{return parseInt((0,$.d)(await t.get(tu)))}finally{await t.close()}}async function Wu(e,t){if(!t)throw new Ku("Please pass repo options when trying to open a repo");const n=t.root;await n.open(),await n.put(tu,(0,x.s)(String(e))),await n.close()}const Yu=vd("ipfs:repo:migrator");async function Xu(e,t,n,s,r={}){const o=r.ignoreLock??!1,i=r.onProgress,a=r.isDryRun??!1,c=r.migrations??Fu;if(!e)throw new Ju.RequiredParameterError("Path argument is required!");if(!n)throw new Ju.RequiredParameterError("repoOptions argument is required!");if(!s)throw new Ju.RequiredParameterError("toVersion argument is required!");if(!Number.isInteger(s)||s<=0)throw new Ju.InvalidValueError("Version has to be positive integer!");t=ru(t);const l=await Gu(t);if(l===s)return void Yu("Nothing to migrate.");if(l>s)throw new Ju.InvalidValueError(`Current repo's version (${l}) is higher then toVersion (${s}), you probably wanted to revert it?`);let d;Qu(c,l,s),a||o||(d=await n.repoLock.lock(e));try{for(const e of c){if(void 0!==s&&e.version>s)break;if(!(e.version<=l)){Yu(`Migrating version ${e.version}`);try{if(!a){let n=()=>{};i&&(n=(t,n)=>i(e.version,t.toFixed(2),n)),await e.migrate(t,n)}}catch(n){const s=e.version-1;throw Yu(`An exception was raised during execution of migration. Setting the repo's version to last successfully migrated version: ${s}`),await Wu(s,t),new Error(`During migration to version ${e.version} exception was raised: ${n.stack||n.message||n}`)}Yu(`Migrating to version ${e.version} finished`)}}a||await Wu(s||function(e){return e=e||Fu,Array.isArray(e)&&0!==e.length?e[e.length-1].version:0}(c),t),Yu("Repo successfully migrated",void 0!==s?`to version ${s}!`:"to latest version!")}finally{a||o||!d||await d.close()}}function Qu(e,t,n,s=!1){let r=0;for(const o of e){if(o.version>n)break;if(o.version>t){if(s&&!o.revert)throw new Ju.NonReversibleMigrationError(`It is not possible to revert to version ${t} because migration version ${o.version} is not reversible. Cancelling reversion.`);r++}}if(r!==n-t)throw new Ju.InvalidValueError(`The ipfs-repo-migrations package does not have all migration to migrate from version ${t} to ${n}`)}const Ju=s;var Zu=n(25508);class eh extends Error{constructor(e){super(e),this.name="LockExistsError",this.code=eh.code}}eh.code="ERR_LOCK_EXISTS";class th extends Error{constructor(e){super(e),this.name="NotFoundError",this.code=th.code}}th.code="ERR_NOT_FOUND";class nh extends Error{constructor(e){super(e),this.name="InvalidRepoVersionError",this.code=nh.code}}nh.code="ERR_INVALID_REPO_VERSION";const sh="ERR_REPO_NOT_INITIALIZED";async function rh(e,t,n){const s=await t(e);if(s)return s;const r=ih(n);return!!r&&new Promise(((t,n)=>{const s=r.store("readonly").get(e.toString());s.transaction.onabort=()=>{n(s.transaction.error)},s.transaction.oncomplete=()=>{t(Boolean(s.result))}}))}async function oh(e,t,n,s){if(await n(e))return t(e);const r=ih(s);if(!r)throw new th;return new Promise(((t,n)=>{const s=r.store("readonly").get(e.toString());s.transaction.onabort=()=>{n(s.transaction.error)},s.transaction.oncomplete=()=>{if(s.result)return t(s.result);n(new th)}}))}function ih(e){let t=e;for(;t.db||t.child;)if(t=t.db||t.child,"level-js"===t.type||"Level"===t.constructor.name)return t}const ah=vd("ipfs:repo:version"),ch=new bt.U("version");const lh=Ct.A.default?Ct.A.default:Ct.A,dh=new bt.U("config");var uh=n(53301),hh=n(63651);const ph=new uh.U("datastore_spec");const fh=new bt.U("api");function yh(e){const t=J.TO.asCID(e);if(null==t)throw c(new Error("Not a valid cid"),"ERR_INVALID_CID");return t.multihash.code!==I.identity.code?{isIdentity:!1}:{isIdentity:!0,digest:t.multihash.digest}}const gh=vd("ipfs:repo:lock:memory"),mh="repo.lock",wh={};const bh={lock:async function(e){const t=e+"/"+mh;if(gh("locking %s",t),!0===wh[t])throw new eh(`Lock already being held for file: ${t}`);return wh[t]=!0,{async close(){wh[t]&&delete wh[t]}}},locked:async function(e){const t=e+"/"+mh;return gh(`checking lock: ${t}`),Boolean(wh[t])}};var _h={autoMigrate:!0,onMigrationProgress:()=>{},repoOwner:!0,repoLock:bh},Eh={Spec:{type:"mount",mounts:[{mountpoint:"/blocks",type:"measure",prefix:"flatfs.datastore",child:{type:"flatfs",path:"blocks",sync:!0,shardFunc:"/repo/flatfs/shard/v1/next-to-last/2"}},{mountpoint:"/",type:"measure",prefix:"leveldb.datastore",child:{type:"levelds",path:"datastore",compression:"none"}}]}},vh=n(36414);function Sh(e){const t=vh.TO.asCID(e);if(null==t)throw c(new Error("Not a valid cid"),"ERR_INVALID_CID");const n=U.base32.encode(t.multihash.bytes);return new bt.U("/"+n.slice(1).toUpperCase(),!1)}function kh(e){return F.D4(U.base32.decode(`b${e.toString().toLowerCase().substring(1)}`))}const Rh=vd("ipfs:repo:utils:walk-dag");async function*Th(e,t,n,s){try{const r=await t.get(e,s),o=await n(e.code),i=(0,Oa.Lu)({bytes:r,cid:e,codec:o});for(const[,e]of i.links())yield e,yield*Th(e,t,n,s)}catch(t){throw Rh("Could not walk DAG for CID",e.toString(),t),t}}class Ih extends Map{constructor(e={}){if(super(),!(e.maxSize&&e.maxSize>0))throw new TypeError("`maxSize` must be a number greater than 0");if("number"==typeof e.maxAge&&0===e.maxAge)throw new TypeError("`maxAge` must be a number greater than 0");this.maxSize=e.maxSize,this.maxAge=e.maxAge||Number.POSITIVE_INFINITY,this.onEviction=e.onEviction,this.cache=new Map,this.oldCache=new Map,this._size=0}_emitEvictions(e){if("function"==typeof this.onEviction)for(const[t,n]of e)this.onEviction(t,n.value)}_deleteIfExpired(e,t){return"number"==typeof t.expiry&&t.expiry<=Date.now()&&("function"==typeof this.onEviction&&this.onEviction(e,t.value),this.delete(e))}_getOrDeleteIfExpired(e,t){if(!1===this._deleteIfExpired(e,t))return t.value}_getItemValue(e,t){return t.expiry?this._getOrDeleteIfExpired(e,t):t.value}_peek(e,t){const n=t.get(e);return this._getItemValue(e,n)}_set(e,t){this.cache.set(e,t),this._size++,this._size>=this.maxSize&&(this._size=0,this._emitEvictions(this.oldCache),this.oldCache=this.cache,this.cache=new Map)}_moveToRecent(e,t){this.oldCache.delete(e),this._set(e,t)}*_entriesAscending(){for(const e of this.oldCache){const[t,n]=e;if(!this.cache.has(t)){!1===this._deleteIfExpired(t,n)&&(yield e)}}for(const e of this.cache){const[t,n]=e;!1===this._deleteIfExpired(t,n)&&(yield e)}}get(e){if(this.cache.has(e)){const t=this.cache.get(e);return this._getItemValue(e,t)}if(this.oldCache.has(e)){const t=this.oldCache.get(e);if(!1===this._deleteIfExpired(e,t))return this._moveToRecent(e,t),t.value}}set(e,t,{maxAge:n=this.maxAge}={}){const s="number"==typeof n&&n!==Number.POSITIVE_INFINITY?Date.now()+n:void 0;this.cache.has(e)?this.cache.set(e,{value:t,expiry:s}):this._set(e,{value:t,expiry:s})}has(e){return this.cache.has(e)?!this._deleteIfExpired(e,this.cache.get(e)):!!this.oldCache.has(e)&&!this._deleteIfExpired(e,this.oldCache.get(e))}peek(e){return this.cache.has(e)?this._peek(e,this.cache):this.oldCache.has(e)?this._peek(e,this.oldCache):void 0}delete(e){const t=this.cache.delete(e);return t&&this._size--,this.oldCache.delete(e)||t}clear(){this.cache.clear(),this.oldCache.clear(),this._size=0}resize(e){if(!(e&&e>0))throw new TypeError("`maxSize` must be a number greater than 0");const t=[...this._entriesAscending()],n=t.length-e;n<0?(this.cache=new Map(t),this.oldCache=new Map,this._size=t.length):(n>0&&this._emitEvictions(t.slice(0,n)),this.oldCache=new Map(t.slice(n)),this.cache=new Map,this._size=0),this.maxSize=e}*keys(){for(const[e]of this)yield e}*values(){for(const[,e]of this)yield e}*[Symbol.iterator](){for(const e of this.cache){const[t,n]=e;!1===this._deleteIfExpired(t,n)&&(yield[t,n.value])}for(const e of this.oldCache){const[t,n]=e;if(!this.cache.has(t)){!1===this._deleteIfExpired(t,n)&&(yield[t,n.value])}}}*entriesDescending(){let e=[...this.cache];for(let t=e.length-1;t>=0;--t){const n=e[t],[s,r]=n;!1===this._deleteIfExpired(s,r)&&(yield[s,r.value])}e=[...this.oldCache];for(let t=e.length-1;t>=0;--t){const n=e[t],[s,r]=n;if(!this.cache.has(s)){!1===this._deleteIfExpired(s,r)&&(yield[s,r.value])}}}*entriesAscending(){for(const[e,t]of this._entriesAscending())yield[e,t.value]}get size(){if(!this._size)return this.oldCache.size;let e=0;for(const t of this.oldCache.keys())this.cache.has(t)||e++;return Math.min(this._size+e,this.maxSize)}entries(){return this.entriesAscending()}forEach(e,t=this){for(const[n,s]of this.entriesAscending())e.call(t,s,n,this)}get[Symbol.toStringTag](){return JSON.stringify([...this.entriesAscending()])}}class Ph{constructor({pinstore:e,blockstore:t,loadCodec:n}){this.pinstore=e,this.blockstore=t,this.loadCodec=n,this.log=vd("ipfs:repo:pin"),this.directPins=new Set,this.recursivePins=new Set}async pinDirectly(e,t={}){await this.blockstore.get(e,t);const n={depth:0};return 0!==e.version&&(n.version=e.version),e.code!==S.code&&(n.codec=e.code),t.metadata&&(n.metadata=t.metadata),this.pinstore.put(Sh(e),fn.lF(n))}unpin(e,t){return this.pinstore.delete(Sh(e),t)}async pinRecursively(e,t={}){await this.fetchCompleteDag(e,t);const n={depth:1/0};0!==e.version&&(n.version=e.version),e.code!==S.code&&(n.codec=e.code),t.metadata&&(n.metadata=t.metadata),await this.pinstore.put(Sh(e),fn.lF(n))}async*directKeys(e){for await(const e of this.pinstore.query({filters:[e=>0===fn.D4(e.value).depth]})){const t=fn.D4(e.value),n=t.version||0,s=null!=t.codec?t.codec:S.code,r=kh(e.key);yield{cid:J.TO.create(n,s,r),metadata:t.metadata}}}async*recursiveKeys(e){for await(const e of this.pinstore.query({filters:[e=>fn.D4(e.value).depth===1/0]})){const t=fn.D4(e.value),n=t.version||0,s=null!=t.codec?t.codec:S.code,r=kh(e.key);yield{cid:J.TO.create(n,s,r),metadata:t.metadata}}}async*indirectKeys(e){for await(const{cid:t}of this.recursiveKeys())for await(const n of Th(t,this.blockstore,this.loadCodec,e)){const e=[qt.recursive];(await this.isPinnedWithType(n,e)).pinned||(yield n)}}async isPinnedWithType(e,t,n){Array.isArray(t)||(t=[t]);const s=t.includes(qt.all),r=t.includes(qt.direct),o=t.includes(qt.recursive),i=t.includes(qt.indirect);if(o||r||s){const n=await(0,sc.A)(this.pinstore.query({prefix:Sh(e).toString(),filters:[e=>{if(s)return!0;const n=fn.D4(e.value);return t.includes(0===n.depth?qt.direct:qt.recursive)}],limit:1}));if(n){const t=fn.D4(n.value);return{cid:e,pinned:!0,reason:0===t.depth?qt.direct:qt.recursive,metadata:t.metadata}}}const a=this;if(s||i){const t=await(0,sc.A)(async function*(e,t){for await(const{cid:n}of t)for await(const t of Th(n,a.blockstore,a.loadCodec))if(t.equals(e))return void(yield n)}(e,this.recursiveKeys()));if(t)return{cid:e,pinned:!0,reason:qt.indirect,parent:t}}return{cid:e,pinned:!1}}async fetchCompleteDag(e,t={}){const n=new Ih({maxSize:t.cidCacheMaxSize??2048}),s=async(e,t)=>{if(n.has(e.toString()))return;n.set(e.toString(),!0);const r=await this.blockstore.get(e,t),o=await this.loadCodec(e.code),i=(0,Oa.Lu)({bytes:r,cid:e,codec:o});await Promise.all([...i.links()].map((([,e])=>s(e,t))))};await s(e,t)}static checkPinType(e){if("string"!=typeof e||!Object.keys(qt).includes(e))throw function(e){return c(new Error(`Invalid type '${e}', must be one of {direct, indirect, recursive, all}`),"ERR_INVALID_PIN_TYPE")}(e);return!0}}async function Ah(e,t){const{pinned:n,reason:s}=await t.isPinnedWithType(e,qt.all);if(n)throw c(new Error(`pinned: ${s}`),"ERR_BLOCK_PINNED")}const Dh=(...e)=>{let t;for(;e.length>0;)t=e.shift()(t);return t},Oh=e=>null!=e&&("function"==typeof e[Symbol.asyncIterator]||"function"==typeof e[Symbol.iterator]||"function"==typeof e.next),Nh=e=>null!=e&&"function"==typeof e.sink&&Oh(e.source),Lh=e=>t=>{const n=e.sink(t);if(null!=n.then){const t=(0,Yn.N)({objectMode:!0});n.then((()=>{t.end()}),(e=>{t.end(e)}));const s=async function*(){yield*e.source,t.end()};return(0,Qr.A)(t,s())}return e.source};const Mh=vd("ipfs:repo:gc"),Ch=(xh=xh||new Error("Not Found"),c(xh,"ERR_NOT_FOUND")).code;var xh;const Bh=256,zh=new bt.U("/local/filesroot");function Uh({gcLock:e,pins:t,blockstore:n,root:s,loadCodec:r}){return async function*(){const o=Date.now();Mh("Creating set of marked blocks");const i=await e.writeLock();try{const e=await async function({pins:e,blockstore:t,loadCodec:n,root:s}){const r=async function*(){let e;try{e=await s.get(zh)}catch(e){if(e.code===Ch)return void Mh("No blocks in MFS");throw e}const r=J.TO.decode(e);yield r,yield*Th(r,t,n)}(),o=(0,Qr.A)((0,Xr.A)(e.recursiveKeys(),(({cid:e})=>e)),e.indirectKeys(),(0,Xr.A)(e.directKeys(),(({cid:e})=>e)),r),i=new Set;for await(const e of(0,Qr.A)(o,r))i.add(U.base32.encode(e.multihash.bytes));return i}({pins:t,blockstore:n,root:s,loadCodec:r}),i=n.queryKeys({});yield*async function*({blockstore:e},t,n){let s=0,r=0;const o=async n=>async function(){s++;try{const s=U.base32.encode(n.multihash.bytes);if(t.has(s))return null;try{await e.delete(n),r++}catch(e){return{err:new Error(`Could not delete block with CID ${n}: ${e.message}`)}}return{cid:n}}catch(e){const t=`Could delete block with CID ${n}`;return Mh(t,e),{err:new Error(t+`: ${e.message}`)}}};yield*function(e,...t){if(Nh(e)){const t=e;e=()=>t.source}else if(Oh(e)){const t=e;e=()=>t}const n=[e,...t];if(n.length>1&&Nh(n[n.length-1])&&(n[n.length-1]=n[n.length-1].sink),n.length>2)for(let e=1;e<n.length-1;e++)Nh(n[e])&&(n[e]=Lh(n[e]));return Dh(...n)}(ao((0,Xr.A)(n,o),Bh),(e=>(0,qn.A)(e,Boolean))),Mh(`Marked set has ${t.size} unique blocks. Blockstore has ${s} blocks. Deleted ${r} blocks.`)}({blockstore:n},e,i),Mh(`Complete (${Date.now()-o}ms)`)}finally{i()}}}const Fh=vd("ipfs:repo"),jh=Number.MAX_SAFE_INTEGER;class Hh{constructor(e,t,n,s){if("string"!=typeof e)throw new Error("missing repo path");if("function"!=typeof t)throw new Error("missing codec loader");this.options=(0,o.A)(_h,s),this.closed=!0,this.path=e,this.root=n.root,this.datastore=n.datastore,this.keys=n.keys;const r=n.blocks,i=n.pins;this.pins=new Ph({pinstore:i,blockstore:r,loadCodec:t});const a=(l=this.pins,d=r,{open:()=>d.open(),close:()=>d.close(),query:(e,t)=>d.query(e,t),queryKeys:(e,t)=>d.queryKeys(e,t),get:async(e,t)=>d.get(e,t),async*getMany(e,t){yield*d.getMany(e,t)},async put(e,t,n){await d.put(e,t,n)},async*putMany(e,t){yield*d.putMany(e,t)},has:(e,t)=>d.has(e,t),delete:async(e,t)=>(await Ah(e,l),d.delete(e,t)),deleteMany:(e,t)=>d.deleteMany((0,Xr.A)(e,(async e=>(await Ah(e,l),e))),t),batch:()=>d.batch()});var l,d;this.blocks=function(e){return{open:()=>e.open(),close:()=>e.close(),query:(t,n)=>e.query(t,n),queryKeys:(t,n)=>e.queryKeys(t,n),async get(t,n){const s=yh(t);return s.isIdentity?Promise.resolve(s.digest):e.get(t,n)},async*getMany(e,t){for await(const n of e)yield this.get(n,t)},async put(t,n,s){const{isIdentity:r}=yh(t);r||await e.put(t,n,s)},async*putMany(t,n){const s=(0,Yn.N)({objectMode:!0});(globalThis.process&&globalThis.process.nextTick?globalThis.process.nextTick:globalThis.setImmediate||globalThis.setTimeout)((async()=>{try{await(0,Kn.A)(e.putMany(async function*(){for await(const{key:e,value:n}of t)yh(e).isIdentity||(yield{key:e,value:n}),s.push({key:e,value:n})}())),s.end()}catch(e){s.end(e)}})),yield*s},has(t,n){const{isIdentity:s}=yh(t);return s?Promise.resolve(!0):e.has(t,n)},delete(t,n){const{isIdentity:s}=yh(t);return s?Promise.resolve():e.delete(t,n)},deleteMany:(t,n)=>e.deleteMany((0,qn.A)(t,(e=>!yh(e).isIdentity)),n),batch(){const t=e.batch();return{put(e,n){const{isIdentity:s}=yh(e);s||t.put(e,n)},delete(e){const{isIdentity:n}=yh(e);n||t.delete(e)},commit:e=>t.commit(e)}}}}(a),this.version=function(e){return{exists:async()=>rh(ch,e.has.bind(e),e),async get(){const t=await oh(ch,e.get.bind(e),e.has.bind(e),e);return parseInt((0,$.d)(t),10)},set:t=>e.put(ch,(0,x.s)(String(t))),async check(e){const t=await this.get();return ah("comparing version: %s and %s",t,e),t===e||6===t&&7===e||6===e&&7===t}}}(this.root),this.config=function(e){const t=new lh({concurrency:1}),n={async getAll(t={}){const n=await oh(dh,e.get.bind(e),e.has.bind(e),e);return JSON.parse((0,$.d)(n))},async get(e,t={}){if(null==e)throw new th(`Key ${e} does not exist in config`);const n=await this.getAll(t),s=Ed(n,e);if(void 0===s)throw new th(`Key ${e} does not exist in config`);return s},set(e,n,r={}){if("string"!=typeof e&&!(e instanceof String))throw c(new Error("Invalid key type: "+typeof e),"ERR_INVALID_KEY");if(void 0===n||n instanceof Uint8Array)throw c(new Error("Invalid value type: "+typeof n),"ERR_INVALID_VALUE");return t.add((()=>s({key:e,value:n},r.signal)))},replace(e,n={}){if(!e||e instanceof Uint8Array)throw c(new Error("Invalid value type: "+typeof e),"ERR_INVALID_VALUE");return t.add((()=>s({key:void 0,value:e},n.signal)))},exists:async()=>rh(dh,e.has.bind(e),e)};return n;async function s(e,t){if(t&&t.aborted)return;const s=e.key,o=e.value;if(s){const e=await n.getAll();return"object"==typeof e&&null!==e&&Ta(e,s,o),r(e)}return r(o)}function r(t){const n=(0,x.s)(JSON.stringify(t,null,2));return e.put(dh,n)}}(this.root),this.spec=function(e){return{exists:()=>e.has(ph),async get(){const t=await e.get(ph);return JSON.parse((0,$.d)(t))},set:async t=>e.put(ph,(0,x.s)(JSON.stringify((0,hh.A)(t,{deep:!0}))))}}(this.root),this.apiAddr=function(e){return{async get(){const t=await e.get(fh);return t&&t.toString()},set:t=>e.put(fh,(0,x.s)(t.toString())),delete:()=>e.delete(fh)}}(this.root),this.gcLock=(0,vc.A)({name:e,singleProcess:!1!==this.options.repoOwner}),this.gc=Uh({gcLock:this.gcLock,pins:this.pins,blockstore:this.blocks,root:this.root,loadCodec:t})}async init(e){var t;Fh("initializing at: %s",this.path),await this._openRoot(),await this.config.replace((t=e,t.Datastore=Object.assign({},Eh,Ed(t,"datastore")),t)),await this.spec.set(function(e){const t={...Eh.Spec,...Ed(e,"Datastore.Spec")};return{type:t.type,mounts:t.mounts.map((e=>({mountpoint:e.mountpoint,type:e.child.type,path:e.child.path,shardFunc:e.child.shardFunc})))}}(e)),await this.version.set(md)}async isInitialized(){if(!this.closed)return!0;try{return await this._openRoot(),await this._checkInitialized(),await this.root.close(),!0}catch(e){return!1}}async open(){if(!this.closed)throw c(new Error("repo is already open"),"ERR_REPO_ALREADY_OPEN");Fh("opening at: %s",this.path);try{await this._openRoot(),await this._checkInitialized(),this._lockfile=await this._openLock(),Fh("acquired repo.lock");if(!await this.version.check(md)){if(!await this._isAutoMigrationEnabled())throw new nh("Incompatible repo versions. Automatic migrations disabled. Please migrate the repo manually.");await this._migrate(md,{root:this.root,datastore:this.datastore,pins:this.pins.pinstore,blocks:this.pins.blockstore,keys:this.keys})}Fh("creating datastore"),await this.datastore.open(),Fh("creating blocks"),await this.blocks.open(),Fh("creating keystore"),await this.keys.open(),Fh("creating pins"),await this.pins.pinstore.open(),this.closed=!1,Fh("all opened")}catch(e){if(this._lockfile)try{await this._closeLock(),this._lockfile=null}catch(e){Fh("error removing lock",e)}throw e}}async _openRoot(){try{await this.root.open()}catch(e){if("Already open"!==e.message)throw e}}async _openLock(){const e=await this.options.repoLock.lock(this.path);if("function"!=typeof e.close)throw c(new Error("Locks must have a close method"),"ERR_NO_CLOSE_FUNCTION");return e}_closeLock(){return this._lockfile&&this._lockfile.close()}async _checkInitialized(){let e;Fh("init check");try{[e]=await Promise.all([this.config.exists(),this.spec.exists(),this.version.exists()])}catch(e){if("ERR_NOT_FOUND"===e.code)throw c(new Error("repo is not initialized yet"),sh,{path:this.path});throw e}if(!e)throw c(new Error("repo is not initialized yet"),sh,{path:this.path})}async close(){if(this.closed)throw c(new Error("repo is already closed"),"ERR_REPO_ALREADY_CLOSED");Fh("closing at: %s",this.path);try{await this.apiAddr.delete()}catch(e){if(e.code!==sh&&!e.message.startsWith("ENOENT"))throw e}await Promise.all([this.root,this.blocks,this.keys,this.datastore,this.pins.pinstore].map((e=>e&&e.close()))),Fh("unlocking"),this.closed=!0,await this._closeLock()}exists(){return this.version.exists()}async stat(){if(this.datastore&&this.keys){const[e,t,n,s,r]=await Promise.all([this._storageMaxStat(),this._blockStat(),this.version.get(),$h(this.datastore),$h(this.keys)]),o=t.size+s+r;return{repoPath:this.path,storageMax:e,version:n,numObjects:t.count,repoSize:o}}throw c(new Error("repo is not initialized yet"),sh,{path:this.path})}async _isAutoMigrationEnabled(){if(void 0!==this.options.autoMigrate)return this.options.autoMigrate;let e;try{e=await this.config.get("repoAutoMigrate")}catch(t){if(t.code!==th.code)throw t;e=!0}return e}async _migrate(e,t){return await this.version.get()>e?(Fh(`reverting to version ${e}`),async function(e,t,n,s,r={}){const o=r.ignoreLock??!1,i=r.onProgress,a=r.isDryRun??!1,c=r.migrations??Fu;if(!e)throw new Ju.RequiredParameterError("Path argument is required!");if(!n)throw new Ju.RequiredParameterError("repoOptions argument is required!");if(!s)throw new Ju.RequiredParameterError("When reverting migrations, you have to specify to which version to revert!");if(!Number.isInteger(s)||s<=0)throw new Ju.InvalidValueError("Version has to be positive integer!");t=ru(t);const l=await Gu(t);if(l===s)return void Yu("Nothing to revert.");if(l<s)throw new Ju.InvalidValueError(`Current repo's version (${l}) is lower then toVersion (${s}), you probably wanted to migrate it?`);let d;Qu(c,s,l,!0),a||o||(d=await n.repoLock.lock(e)),Yu(`Reverting from version ${l} to ${s}`);try{const e=c.slice().reverse();for(const n of e){if(n.version<=s)break;if(!(n.version>l)){Yu(`Reverting migration version ${n.version}`);try{if(!a){let e=()=>{};i&&(e=(e,t)=>i(n.version,e.toFixed(2),t)),await n.revert(t,e)}}catch(e){const s=n.version;throw Yu(`An exception was raised during execution of migration. Setting the repo's version to last successfully reverted version: ${s}`),await Wu(s,t),e.message=`During reversion to version ${n.version} exception was raised: ${e.message}`,e}Yu(`Reverting to version ${n.version} finished`)}}a||await Wu(s,t),Yu(`All migrations successfully reverted to version ${s}!`)}finally{a||o||!d||await d.close()}}(this.path,t,this.options,e,{ignoreLock:!0,onProgress:this.options.onMigrationProgress})):(Fh(`migrating to version ${e}`),Xu(this.path,t,this.options,e,{ignoreLock:!0,onProgress:this.options.onMigrationProgress}))}async _storageMaxStat(){try{const e=await this.config.get("Datastore.StorageMax");return BigInt(Zu(e))}catch(e){return BigInt(jh)}}async _blockStat(){let e=BigInt(0),t=BigInt(0);if(this.blocks)for await(const{key:n,value:s}of this.blocks.query({}))e+=BigInt(1),t+=BigInt(s.byteLength),t+=BigInt(n.bytes.byteLength);return{count:e,size:t}}}async function $h(e){let t=BigInt(0);for await(const n of e.query({}))t+=BigInt(n.value.byteLength),t+=BigInt(n.key.uint8Array().byteLength);return t}var Vh=n(77618),Kh=n(20984);function qh(e,t,n){const s=n.path||"ipfs";return function(e,t,n,s){return new Hh(e,t,n,s)}(s,(e=>t.getCodec(e)),{root:new Vh.Q(s,{prefix:"",version:2}),blocks:new Kh.n(new Vh.Q(`${s}/blocks`,{prefix:"",version:2})),datastore:new Vh.Q(`${s}/datastore`,{prefix:"",version:2}),keys:new Vh.Q(`${s}/keys`,{prefix:"",version:2}),pins:new Vh.Q(`${s}/pins`,{prefix:"",version:2})},{autoMigrate:n.autoMigrate,onMigrationProgress:n.onMigrationProgress||e,repoLock:bh})}const Gh=e=>null!=e&&("function"==typeof e[Symbol.asyncIterator]||"function"==typeof e[Symbol.iterator]||"function"==typeof e.next),Wh=e=>null!=e&&"function"==typeof e.sink&&Gh(e.source),Yh=e=>t=>{const n=e.sink(t);if(null!=n.then){const t=(0,Yn.N)({objectMode:!0});n.then((()=>{t.end()}),(e=>{t.end(e)}));const s=async function*(){yield*e.source,t.end()};return(0,Qr.A)(t,s())}return e.source};function Xh(e,...t){if(Wh(e)){const t=e;e=()=>t.source}else if(Gh(e)){const t=e;e=()=>t}const n=[e,...t];if(n.length>1&&Wh(n[n.length-1])&&(n[n.length-1]=n[n.length-1].sink),n.length>2)for(let e=1;e<n.length-1;e++)Wh(n[e])&&(n[e]=Yh(n[e]));return((...e)=>{let t;for(;e.length>0;)t=e.shift()(t);return t})(...n)}var Qh=n(83583),Jh=n(8383),Zh=n(86595);class ep{constructor(e,t,n){this.gossip=e,this.msgs=new Map,this.history=[],this.notValidatedCount=0,this.msgIdToStrFn=n;for(let e=0;e<t;e++)this.history[e]=[]}get size(){return this.msgs.size}put(e,t,n=!1){const{msgIdStr:s}=e;return!this.msgs.has(s)&&(this.msgs.set(s,{message:t,validated:n,originatingPeers:new Set,iwantCounts:new Map}),this.history[0].push({...e,topic:t.topic}),n||this.notValidatedCount++,!0)}observeDuplicate(e,t){const n=this.msgs.get(e);n&&!n.validated&&n.originatingPeers.add(t)}get(e){return this.msgs.get(this.msgIdToStrFn(e))?.message}getWithIWantCount(e,t){const n=this.msgs.get(e);if(!n)return null;const s=(n.iwantCounts.get(t)??0)+1;return n.iwantCounts.set(t,s),{msg:n.message,count:s}}getGossipIDs(e){const t=new Map;for(let n=0;n<this.gossip;n++)this.history[n].forEach((n=>{const s=this.msgs.get(n.msgIdStr);if(s&&s.validated&&e.has(n.topic)){let e=t.get(n.topic);e||(e=[],t.set(n.topic,e)),e.push(n.msgId)}}));return t}validate(e){const t=this.msgs.get(e);if(!t)return null;t.validated||this.notValidatedCount--;const{message:n,originatingPeers:s}=t;return t.validated=!0,t.originatingPeers=new Set,{message:n,originatingPeers:s}}shift(){this.history[this.history.length-1].forEach((e=>{const t=this.msgs.get(e.msgIdStr);t&&(this.msgs.delete(e.msgIdStr),t.validated||this.notValidatedCount--)})),this.history.pop(),this.history.unshift([])}remove(e){const t=this.msgs.get(e);return t?(this.msgs.delete(e),t):null}}var tp=n(33169);const{RPC:np}=tp,sp="/floodsub/1.0.0",rp="/meshsub/1.0.0",op="/meshsub/1.1.0",ip=5e3;function ap(e){if(e.length<=1)return e;for(let t=0;t<e.length;t++){const n=Math.floor(Math.random()*Math.floor(e.length)),s=e[t];e[t]=e[n],e[n]=s}return e}function cp(e){return(0,$.d)(e,"base64")}var lp,dp,up,hp,pp,fp=n(17843);function yp(e){switch(e){case fp.z8.Ignore:return up.Ignore;case fp.z8.Reject:return up.Reject}}!function(e){e.StrictSign="StrictSign",e.StrictNoSign="StrictNoSign"}(lp||(lp={})),function(e){e[e.Signing=0]="Signing",e[e.Anonymous=1]="Anonymous"}(dp||(dp={})),function(e){e.Error="error",e.Ignore="ignore",e.Reject="reject",e.Blacklisted="blacklisted"}(up||(up={})),function(e){e.InvalidSignature="invalid_signature",e.InvalidSeqno="invalid_seqno",e.InvalidPeerId="invalid_peerid",e.SignaturePresent="signature_present",e.SeqnoPresent="seqno_present",e.FromPresent="from_present",e.TransformFailed="transform_failed"}(hp||(hp={})),function(e){e.duplicate="duplicate",e.invalid="invalid",e.valid="valid"}(pp||(pp={}));const gp="ERR_INVALID_PEER_SCORE_PARAMS";var mp=n(17729);const wp={topics:{},topicScoreCap:10,appSpecificScore:()=>0,appSpecificWeight:10,IPColocationFactorWeight:-5,IPColocationFactorThreshold:10,IPColocationFactorWhitelist:new Set,behaviourPenaltyWeight:-10,behaviourPenaltyThreshold:0,behaviourPenaltyDecay:.2,decayInterval:1e3,decayToZero:.1,retainScore:36e5},bp={topicWeight:.5,timeInMeshWeight:1,timeInMeshQuantum:1,timeInMeshCap:3600,firstMessageDeliveriesWeight:1,firstMessageDeliveriesDecay:.5,firstMessageDeliveriesCap:2e3,meshMessageDeliveriesWeight:-1,meshMessageDeliveriesDecay:.5,meshMessageDeliveriesCap:100,meshMessageDeliveriesThreshold:20,meshMessageDeliveriesWindow:10,meshMessageDeliveriesActivation:5e3,meshFailurePenaltyWeight:-1,meshFailurePenaltyDecay:.5,invalidMessageDeliveriesWeight:-1,invalidMessageDeliveriesDecay:.3};function _p(e={}){return{...wp,...e,topics:e.topics?Object.entries(e.topics).reduce(((e,[t,n])=>(e[t]=function(e={}){return{...bp,...e}}(n),e)),{}):{}}}function Ep(e){if(e.topicWeight<0)throw new mp.A("invalid topic weight; must be >= 0",gp);if(0===e.timeInMeshQuantum)throw new mp.A("invalid TimeInMeshQuantum; must be non zero",gp);if(e.timeInMeshWeight<0)throw new mp.A("invalid TimeInMeshWeight; must be positive (or 0 to disable)",gp);if(0!==e.timeInMeshWeight&&e.timeInMeshQuantum<=0)throw new mp.A("invalid TimeInMeshQuantum; must be positive",gp);if(0!==e.timeInMeshWeight&&e.timeInMeshCap<=0)throw new mp.A("invalid TimeInMeshCap; must be positive",gp);if(e.firstMessageDeliveriesWeight<0)throw new mp.A("invallid FirstMessageDeliveriesWeight; must be positive (or 0 to disable)",gp);if(0!==e.firstMessageDeliveriesWeight&&(e.firstMessageDeliveriesDecay<=0||e.firstMessageDeliveriesDecay>=1))throw new mp.A("invalid FirstMessageDeliveriesDecay; must be between 0 and 1",gp);if(0!==e.firstMessageDeliveriesWeight&&e.firstMessageDeliveriesCap<=0)throw new mp.A("invalid FirstMessageDeliveriesCap; must be positive",gp);if(e.meshMessageDeliveriesWeight>0)throw new mp.A("invalid MeshMessageDeliveriesWeight; must be negative (or 0 to disable)",gp);if(0!==e.meshMessageDeliveriesWeight&&(e.meshMessageDeliveriesDecay<=0||e.meshMessageDeliveriesDecay>=1))throw new mp.A("invalid MeshMessageDeliveriesDecay; must be between 0 and 1",gp);if(0!==e.meshMessageDeliveriesWeight&&e.meshMessageDeliveriesCap<=0)throw new mp.A("invalid MeshMessageDeliveriesCap; must be positive",gp);if(0!==e.meshMessageDeliveriesWeight&&e.meshMessageDeliveriesThreshold<=0)throw new mp.A("invalid MeshMessageDeliveriesThreshold; must be positive",gp);if(e.meshMessageDeliveriesWindow<0)throw new mp.A("invalid MeshMessageDeliveriesWindow; must be non-negative",gp);if(0!==e.meshMessageDeliveriesWeight&&e.meshMessageDeliveriesActivation<1e3)throw new mp.A("invalid MeshMessageDeliveriesActivation; must be at least 1s",gp);if(e.meshFailurePenaltyWeight>0)throw new mp.A("invalid MeshFailurePenaltyWeight; must be negative (or 0 to disable)",gp);if(0!==e.meshFailurePenaltyWeight&&(e.meshFailurePenaltyDecay<=0||e.meshFailurePenaltyDecay>=1))throw new mp.A("invalid MeshFailurePenaltyDecay; must be between 0 and 1",gp);if(e.invalidMessageDeliveriesWeight>0)throw new mp.A("invalid InvalidMessageDeliveriesWeight; must be negative (or 0 to disable)",gp);if(e.invalidMessageDeliveriesDecay<=0||e.invalidMessageDeliveriesDecay>=1)throw new mp.A("invalid InvalidMessageDeliveriesDecay; must be between 0 and 1",gp)}const vp={gossipThreshold:-10,publishThreshold:-50,graylistThreshold:-80,acceptPXThreshold:10,opportunisticGraftThreshold:20};function Sp(e={}){return{...vp,...e}}function kp(e,t,n,s){let r=0;Object.entries(t.topics).forEach((([e,t])=>{const s=n.topics[e];if(void 0===s)return;let o=0;if(t.inMesh){let e=t.meshTime/s.timeInMeshQuantum;e>s.timeInMeshCap&&(e=s.timeInMeshCap),o+=e*s.timeInMeshWeight}let i=t.firstMessageDeliveries;if(i>s.firstMessageDeliveriesCap&&(i=s.firstMessageDeliveriesCap),o+=i*s.firstMessageDeliveriesWeight,t.meshMessageDeliveriesActive&&t.meshMessageDeliveries<s.meshMessageDeliveriesThreshold){const e=s.meshMessageDeliveriesThreshold-t.meshMessageDeliveries;o+=e*e*s.meshMessageDeliveriesWeight}o+=t.meshFailurePenalty*s.meshFailurePenaltyWeight;o+=t.invalidMessageDeliveries*t.invalidMessageDeliveries*s.invalidMessageDeliveriesWeight,r+=o*s.topicWeight})),n.topicScoreCap>0&&r>n.topicScoreCap&&(r=n.topicScoreCap);const o=n.appSpecificScore(e);if(r+=o*n.appSpecificWeight,t.knownIPs.forEach((e=>{if(n.IPColocationFactorWhitelist.has(e))return;const t=s.get(e),o=t?t.size:0;if(o>n.IPColocationFactorThreshold){const e=o-n.IPColocationFactorThreshold;r+=e*e*n.IPColocationFactorWeight}})),t.behaviourPenalty>n.behaviourPenaltyThreshold){const e=t.behaviourPenalty-n.behaviourPenaltyThreshold;r+=e*e*n.behaviourPenaltyWeight}return r}var Rp,Tp=n(3666);!function(e){e[e.unknown=0]="unknown",e[e.valid=1]="valid",e[e.invalid=2]="invalid",e[e.ignored=3]="ignored"}(Rp||(Rp={}));class Ip{constructor(){this.records=new Map,this.queue=new Tp}ensureRecord(e){let t=this.records.get(e);if(t)return t;t={status:Rp.unknown,firstSeen:Date.now(),validated:0,peers:new Set},this.records.set(e,t);const n={msgId:e,expire:Date.now()+12e4};return this.queue.push(n),t}gc(){const e=Date.now();let t=this.queue.peekFront();for(;t&&t.expire<e;)this.records.delete(t.msgId),this.queue.shift(),t=this.queue.peekFront()}clear(){this.records.clear(),this.queue.clear()}}function Pp(e,t,n=(()=>!0)){const s=new Set;if(t<=0)return s;for(const r of e){if(s.size>=t)break;n(r)&&(s.add(r),e.delete(r))}return s}class Ap extends Map{constructor(e){super(),this.getDefault=e}getOrDefault(e){let t=super.get(e);return void 0===t&&(t=this.getDefault(),this.set(e,t)),t}}const Dp=(0,a.vF)("libp2p:gossipsub:score");class Op{constructor(e,t,n){this.params=e,this.metrics=t,this.peerStats=new Map,this.peerIPs=new Ap((()=>new Set)),this.scoreCache=new Map,this.deliveryRecords=new Ip,function(e){for(const[t,n]of Object.entries(e.topics))try{Ep(n)}catch(e){throw new mp.A(`invalid score parameters for topic ${t}: ${e.message}`,gp)}if(e.topicScoreCap<0)throw new mp.A("invalid topic score cap; must be positive (or 0 for no cap)",gp);if(null===e.appSpecificScore||void 0===e.appSpecificScore)throw new mp.A("missing application specific score function",gp);if(e.IPColocationFactorWeight>0)throw new mp.A("invalid IPColocationFactorWeight; must be negative (or 0 to disable)",gp);if(0!==e.IPColocationFactorWeight&&e.IPColocationFactorThreshold<1)throw new mp.A("invalid IPColocationFactorThreshold; must be at least 1",gp);if(e.behaviourPenaltyWeight>0)throw new mp.A("invalid BehaviourPenaltyWeight; must be negative (or 0 to disable)",gp);if(0!==e.behaviourPenaltyWeight&&(e.behaviourPenaltyDecay<=0||e.behaviourPenaltyDecay>=1))throw new mp.A("invalid BehaviourPenaltyDecay; must be between 0 and 1",gp);if(e.decayInterval<1e3)throw new mp.A("invalid DecayInterval; must be at least 1s",gp);if(e.decayToZero<=0||e.decayToZero>=1)throw new mp.A("invalid DecayToZero; must be between 0 and 1",gp)}(e),this.scoreCacheValidityMs=n.scoreCacheValidityMs,this.computeScore=n.computeScore??kp}get size(){return this.peerStats.size}start(){this._backgroundInterval?Dp("Peer score already running"):(this._backgroundInterval=setInterval((()=>this.background()),this.params.decayInterval),Dp("started"))}stop(){this._backgroundInterval?(clearInterval(this._backgroundInterval),delete this._backgroundInterval,this.peerIPs.clear(),this.peerStats.clear(),this.deliveryRecords.clear(),Dp("stopped")):Dp("Peer score already stopped")}background(){this.refreshScores(),this.deliveryRecords.gc()}dumpPeerScoreStats(){return Object.fromEntries(Array.from(this.peerStats.entries()).map((([e,t])=>[e,t])))}refreshScores(){const e=Date.now(),t=this.params.decayToZero;this.peerStats.forEach(((n,s)=>{n.connected?(Object.entries(n.topics).forEach((([n,s])=>{const r=this.params.topics[n];void 0!==r&&(s.firstMessageDeliveries*=r.firstMessageDeliveriesDecay,s.firstMessageDeliveries<t&&(s.firstMessageDeliveries=0),s.meshMessageDeliveries*=r.meshMessageDeliveriesDecay,s.meshMessageDeliveries<t&&(s.meshMessageDeliveries=0),s.meshFailurePenalty*=r.meshFailurePenaltyDecay,s.meshFailurePenalty<t&&(s.meshFailurePenalty=0),s.invalidMessageDeliveries*=r.invalidMessageDeliveriesDecay,s.invalidMessageDeliveries<t&&(s.invalidMessageDeliveries=0),s.inMesh&&(s.meshTime=e-s.graftTime,s.meshTime>r.meshMessageDeliveriesActivation&&(s.meshMessageDeliveriesActive=!0)))})),n.behaviourPenalty*=this.params.behaviourPenaltyDecay,n.behaviourPenalty<t&&(n.behaviourPenalty=0)):e>n.expire&&(this.removeIPsForPeer(s,n.knownIPs),this.peerStats.delete(s),this.scoreCache.delete(s))}))}score(e){this.metrics?.scoreFnCalls.inc();const t=this.peerStats.get(e);if(!t)return 0;const n=Date.now(),s=this.scoreCache.get(e);if(s&&s.cacheUntil>n)return s.score;this.metrics?.scoreFnRuns.inc();const r=this.computeScore(e,t,this.params,this.peerIPs),o=n+this.scoreCacheValidityMs;return s?(this.metrics?.scoreCachedDelta.observe(Math.abs(r-s.score)),s.score=r,s.cacheUntil=o):this.scoreCache.set(e,{score:r,cacheUntil:o}),r}addPenalty(e,t,n){const s=this.peerStats.get(e);s&&(s.behaviourPenalty+=t,this.metrics?.onScorePenalty(n))}addPeer(e){const t={connected:!0,expire:0,topics:{},knownIPs:new Set,behaviourPenalty:0};this.peerStats.set(e,t)}addIP(e,t){const n=this.peerStats.get(e);n&&n.knownIPs.add(t),this.peerIPs.getOrDefault(t).add(e)}removeIP(e,t){const n=this.peerStats.get(e);n&&n.knownIPs.delete(t);const s=this.peerIPs.get(t);s&&(s.delete(e),0===s.size&&this.peerIPs.delete(t))}removePeer(e){const t=this.peerStats.get(e);if(t){if(this.score(e)>0)return this.removeIPsForPeer(e,t.knownIPs),void this.peerStats.delete(e);Object.entries(t.topics).forEach((([e,t])=>{t.firstMessageDeliveries=0;const n=this.params.topics[e].meshMessageDeliveriesThreshold;if(t.inMesh&&t.meshMessageDeliveriesActive&&t.meshMessageDeliveries<n){const e=n-t.meshMessageDeliveries;t.meshFailurePenalty+=e*e}t.inMesh=!1,t.meshMessageDeliveriesActive=!1})),t.connected=!1,t.expire=Date.now()+this.params.retainScore}}graft(e,t){const n=this.peerStats.get(e);if(n){const e=this.getPtopicStats(n,t);e&&(e.inMesh=!0,e.graftTime=Date.now(),e.meshTime=0,e.meshMessageDeliveriesActive=!1)}}prune(e,t){const n=this.peerStats.get(e);if(n){const e=this.getPtopicStats(n,t);if(e){const n=this.params.topics[t].meshMessageDeliveriesThreshold;if(e.meshMessageDeliveriesActive&&e.meshMessageDeliveries<n){const t=n-e.meshMessageDeliveries;e.meshFailurePenalty+=t*t}e.meshMessageDeliveriesActive=!1,e.inMesh=!1}}}validateMessage(e){this.deliveryRecords.ensureRecord(e)}deliverMessage(e,t,n){this.markFirstMessageDelivery(e,n);const s=this.deliveryRecords.ensureRecord(t),r=Date.now();s.status===Rp.unknown?(s.status=Rp.valid,s.validated=r,s.peers.forEach((t=>{t!==e.toString()&&this.markDuplicateMessageDelivery(t,n)}))):Dp("unexpected delivery: message from %s was first seen %s ago and has delivery status %s",e,r-s.firstSeen,Rp[s.status])}rejectInvalidMessage(e,t){this.markInvalidMessageDelivery(e,t)}rejectMessage(e,t,n,s){switch(s){case up.Error:return void this.markInvalidMessageDelivery(e,n);case up.Blacklisted:return}const r=this.deliveryRecords.ensureRecord(t);if(r.status===Rp.unknown){if(s===up.Ignore)return r.status=Rp.ignored,void r.peers.clear();r.status=Rp.invalid,this.markInvalidMessageDelivery(e,n),r.peers.forEach((e=>{this.markInvalidMessageDelivery(e,n)})),r.peers.clear()}else Dp("unexpected rejection: message from %s was first seen %s ago and has delivery status %d",e,Date.now()-r.firstSeen,Rp[r.status])}duplicateMessage(e,t,n){const s=this.deliveryRecords.ensureRecord(t);if(!s.peers.has(e))switch(s.status){case Rp.unknown:s.peers.add(e);break;case Rp.valid:s.peers.add(e),this.markDuplicateMessageDelivery(e,n,s.validated);break;case Rp.invalid:this.markInvalidMessageDelivery(e,n);case Rp.ignored:}}markInvalidMessageDelivery(e,t){const n=this.peerStats.get(e);if(n){const e=this.getPtopicStats(n,t);e&&(e.invalidMessageDeliveries+=1)}}markFirstMessageDelivery(e,t){const n=this.peerStats.get(e);if(n){const e=this.getPtopicStats(n,t);if(e){let n=this.params.topics[t].firstMessageDeliveriesCap;e.firstMessageDeliveries=Math.min(n,e.firstMessageDeliveries+1),e.inMesh&&(n=this.params.topics[t].meshMessageDeliveriesCap,e.meshMessageDeliveries=Math.min(n,e.meshMessageDeliveries+1))}}}markDuplicateMessageDelivery(e,t,n){const s=this.peerStats.get(e);if(s){const e=void 0!==n?Date.now():0,r=this.getPtopicStats(s,t);if(r&&r.inMesh){const s=this.params.topics[t];if(void 0!==n){const r=e-n,o=r>s.meshMessageDeliveriesWindow;if(this.metrics?.onDuplicateMsgDelivery(t,r,o),o)return}const o=s.meshMessageDeliveriesCap;r.meshMessageDeliveries=Math.min(o,r.meshMessageDeliveries+1)}}}removeIPsForPeer(e,t){for(const n of t){const t=this.peerIPs.get(n);t&&(t.delete(e),0===t.size&&this.peerIPs.delete(n))}}getPtopicStats(e,t){let n=e.topics[t];return void 0!==n?n:void 0!==this.params.topics[t]?(n={inMesh:!1,graftTime:0,meshTime:0,firstMessageDeliveries:0,meshMessageDeliveries:0,meshMessageDeliveriesActive:!1,meshFailurePenalty:0,invalidMessageDeliveries:0},e.topics[t]=n,n):null}}class Np{constructor(e,t,n){this.gossipsubIWantFollowupMs=e,this.msgIdToStrFn=t,this.metrics=n,this.promises=new Map,this.requestMsByMsg=new Map,this.requestMsByMsgExpire=10*e}get size(){return this.promises.size}get requestMsByMsgSize(){return this.requestMsByMsg.size}addPromise(e,t){const n=t[Math.floor(Math.random()*t.length)],s=this.msgIdToStrFn(n);let r=this.promises.get(s);r||(r=new Map,this.promises.set(s,r));const o=Date.now();r.has(e)||(r.set(e,o+this.gossipsubIWantFollowupMs),this.metrics&&(this.metrics.iwantPromiseStarted.inc(1),this.requestMsByMsg.has(s)||this.requestMsByMsg.set(s,o)))}getBrokenPromises(){const e=Date.now(),t=new Map;let n=0;return this.promises.forEach(((s,r)=>{s.forEach(((r,o)=>{r<e&&(t.set(o,(t.get(o)??0)+1),s.delete(o),n++)})),s.size||this.promises.delete(r)})),this.metrics?.iwantPromiseBroken.inc(n),t}deliverMessage(e,t=!1){this.trackMessage(e);const n=this.promises.get(e);n&&(this.promises.delete(e),this.metrics&&(this.metrics.iwantPromiseResolved.inc(1),t&&this.metrics.iwantPromiseResolvedFromDuplicate.inc(1),this.metrics.iwantPromiseResolvedPeers.inc(n.size)))}rejectMessage(e,t){this.trackMessage(e),t!==up.Error&&this.promises.delete(e)}clear(){this.promises.clear()}prune(){const e=Date.now()-this.requestMsByMsgExpire;let t=0;for(const[n,s]of this.requestMsByMsg.entries()){if(!(s<e))break;this.requestMsByMsg.delete(n),t++}this.metrics?.iwantMessagePruned.inc(t)}trackMessage(e){if(this.metrics){const t=this.requestMsByMsg.get(e);void 0!==t&&(this.metrics.iwantPromiseDeliveryTime.observe((Date.now()-t)/1e3),this.requestMsByMsg.delete(e))}}}class Lp{constructor(e){this.entries=new Map,this.validityMs=e.validityMs}get size(){return this.entries.size}put(e,t){return!!this.entries.has(e)||(this.entries.set(e,{value:t,validUntilMs:Date.now()+this.validityMs}),!1)}prune(){const e=Date.now();for(const[t,n]of this.entries.entries()){if(!(n.validUntilMs<e))break;this.entries.delete(t)}}has(e){return this.entries.has(e)}get(e){const t=this.entries.get(e);return t&&t.validUntilMs>=Date.now()?t.value:void 0}clear(){this.entries.clear()}}var Mp,Cp,xp,Bp,zp,Up;!function(e){e.forward="forward",e.publish="publish"}(Mp||(Mp={})),function(e){e.Fanout="fanout",e.Random="random",e.Subscribed="subscribed",e.Outbound="outbound",e.NotEnough="not_enough",e.Opportunistic="opportunistic"}(Cp||(Cp={})),function(e){e.Dc="disconnected",e.BadScore="bad_score",e.Prune="prune",e.Unsub="unsubscribed",e.Excess="excess"}(xp||(xp={})),function(e){e.GraftBackoff="graft_backoff",e.BrokenPromise="broken_promise",e.MessageDeficit="message_deficit",e.IPColocation="IP_colocation"}(Bp||(Bp={})),function(e){e.LowScore="low_score",e.MaxIhave="max_ihave",e.MaxIasked="max_iasked"}(zp||(zp={})),function(e){e.graylist="graylist",e.publish="publish",e.gossip="gossip",e.mesh="mesh"}(Up||(Up={}));var Fp=n(18632);const jp=(0,x.s)("libp2p-pubsub:");var Hp=n(30174);function $p(e){if("signed"!==e.type)throw new Error("expected signed message type");if(null==e.sequenceNumber)throw Error("missing seqno field");return(0,Hp.vu)(e.from.toBytes(),e.sequenceNumber)}async function Vp(e){return await co.sha256.encode(e.data)}function Kp(e,t,n,s,r){let o=0;const i=new Map;if(Object.entries(t.topics).forEach((([e,t])=>{const s=r.get(e)??"unknown",a=n.topics[e];if(void 0===a)return;let c=i.get(s);c||(c={p1w:0,p2w:0,p3w:0,p3bw:0,p4w:0},i.set(s,c));let l=0,d=0,u=0,h=0,p=0;if(t.inMesh){l+=Math.max(t.meshTime/a.timeInMeshQuantum,a.timeInMeshCap)*a.timeInMeshWeight}let f=t.firstMessageDeliveries;if(f>a.firstMessageDeliveriesCap&&(f=a.firstMessageDeliveriesCap),d+=f*a.firstMessageDeliveriesWeight,t.meshMessageDeliveriesActive&&t.meshMessageDeliveries<a.meshMessageDeliveriesThreshold){const e=a.meshMessageDeliveriesThreshold-t.meshMessageDeliveries;u+=e*e*a.meshMessageDeliveriesWeight}h+=t.meshFailurePenalty*a.meshFailurePenaltyWeight;p+=t.invalidMessageDeliveries*t.invalidMessageDeliveries*a.invalidMessageDeliveriesWeight,o+=(l+d+u+h+p)*a.topicWeight,c.p1w+=l,c.p2w+=d,c.p3w+=u,c.p3bw+=h,c.p4w+=p})),n.topicScoreCap>0&&o>n.topicScoreCap){o=n.topicScoreCap;const e=n.topicScoreCap/o;for(const t of i.values())t.p1w*=e,t.p2w*=e,t.p3w*=e,t.p3bw*=e,t.p4w*=e}let a=0,c=0,l=0;a+=n.appSpecificScore(e)*n.appSpecificWeight,t.knownIPs.forEach((e=>{if(n.IPColocationFactorWhitelist.has(e))return;const t=s.get(e),r=t?t.size:0;if(r>n.IPColocationFactorThreshold){const e=r-n.IPColocationFactorThreshold;c+=e*e*n.IPColocationFactorWeight}}));return l+=t.behaviourPenalty*t.behaviourPenalty*n.behaviourPenaltyWeight,o+=a+c+l,{byTopic:i,p5w:a,p6w:c,p7w:l,score:o}}var qp=n(57805),Gp=n(44710),Wp=n(10167);const Yp=Math.pow(2,7),Xp=Math.pow(2,14),Qp=Math.pow(2,21),Jp=Math.pow(2,28),Zp=Math.pow(2,35),ef=Math.pow(2,42),tf=Math.pow(2,49),nf=Math.pow(2,56),sf=Math.pow(2,63),rf={encodingLength:e=>e<Yp?1:e<Xp?2:e<Qp?3:e<Jp?4:e<Zp?5:e<ef?6:e<tf?7:e<nf?8:e<sf?9:10,encode(e,t,n=0){if(null!=Number.MAX_SAFE_INTEGER&&e>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return null==t&&(t=(0,Wp.K)(rf.encodingLength(e))),Gp.R.fromNumber(e).toBytes(t,n),t},decode:(e,t=0)=>Gp.R.fromBytes(e,t).toNumber(!0)};const of=e=>{const t=rf.encodingLength(e),n=(s=t,null!=globalThis?.Buffer?.allocUnsafe?globalThis.Buffer.allocUnsafe(s):new Uint8Array(s));var s;return rf.encode(e,n),of.bytes=t,n};function af(e){const t=(e=e??{}).lengthEncoder??of;return async function*(e){for await(const n of e){const e=t(n.byteLength);e instanceof Uint8Array?yield e:yield*e,n instanceof Uint8Array?yield n:yield*n}}}of.bytes=0,af.single=(e,t)=>{const n=(t=t??{}).lengthEncoder??of;return new zo.I(n(e.byteLength),e)};var cf;!function(e){e[e.LENGTH=0]="LENGTH",e[e.DATA=1]="DATA"}(cf||(cf={}));const lf=e=>{const t=rf.decode(e);return lf.bytes=rf.encodingLength(t),t};function df(e){return async function*(t){const n=new zo.I;let s=cf.LENGTH,r=-1;const o=e?.lengthDecoder??lf,i=e?.maxLengthLength??8,a=e?.maxDataLength??4194304;for await(const l of t)for(n.append(l);n.byteLength>0;){if(s===cf.LENGTH)try{if(r=o(n),r<0)throw c(new Error("invalid message length"),"ERR_INVALID_MSG_LENGTH");if(r>a)throw c(new Error("message length too long"),"ERR_MSG_DATA_TOO_LONG");const t=o.bytes;n.consume(t),null!=e?.onLength&&e.onLength(r),s=cf.DATA}catch(e){if(e instanceof RangeError){if(n.byteLength>i)throw c(new Error("message length length too long"),"ERR_MSG_LENGTH_TOO_LONG");break}throw e}if(s===cf.DATA){if(n.byteLength<r)break;const t=n.sublist(0,r);n.consume(r),null!=e?.onData&&e.onData(t),yield t,s=cf.LENGTH}}if(n.byteLength>0)throw c(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}}lf.bytes=0,df.fromReader=(e,t)=>{let n=1;const s=async function*(){for(;;)try{const{done:t,value:s}=await e.next(n);if(!0===t)return;null!=s&&(yield s)}catch(e){if("ERR_UNDER_READ"===e.code)return{done:!0,value:null};throw e}finally{n=1}}();return df({...t??{},onLength:e=>{n=e}})(s)};class uf{constructor(e,t,n){this.rawStream=e,this.pushable=(0,Yn.N)({objectMode:!1}),this.closeController=new AbortController,this.maxBufferSize=n.maxBufferSize??1/0,Xh((0,qp.IV)(this.pushable,this.closeController.signal,{returnOnAbort:!0}),af(),this.rawStream).catch(t)}get protocol(){return this.rawStream.stat.protocol}push(e){if(this.pushable.readableLength>this.maxBufferSize)throw Error(`OutboundStream buffer full, size > ${this.maxBufferSize}`);this.pushable.push(e)}close(){this.closeController.abort(),this.pushable.return(),this.rawStream.close()}}class hf{constructor(e,t={}){this.rawStream=e,this.closeController=new AbortController,this.source=(0,qp.IV)(Xh(this.rawStream,df(t)),this.closeController.signal,{returnOnAbort:!0})}close(){this.closeController.abort(),this.rawStream.close()}}var pf=n(26021);const ff={maxSubscriptions:1/0,maxMessages:1/0,maxIhaveMessageIDs:1/0,maxIwantMessageIDs:1/0,maxControlMessages:1/0,maxPeerInfos:1/0};function yf(e,t){t={...t};const n=pf.Reader.create(e),s=e.length,r=void 0===s?n.len:n.pos+s,o={};for(;n.pos<r;){const e=n.uint32();switch(e>>>3){case 1:o.subscriptions&&o.subscriptions.length||(o.subscriptions=[]),o.subscriptions.length<t.maxSubscriptions?o.subscriptions.push(gf(n,n.uint32())):n.skipType(7&e);break;case 2:o.messages&&o.messages.length||(o.messages=[]),o.messages.length<t.maxMessages?o.messages.push(mf(n,n.uint32())):n.skipType(7&e);break;case 3:o.control=wf(n,n.uint32(),t);break;default:n.skipType(7&e)}}return o}function gf(e,t){const n=void 0===t?e.len:e.pos+t,s={};for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:s.subscribe=e.bool();break;case 2:s.topic=e.string();break;default:e.skipType(7&t)}}return s}function mf(e,t){const n=void 0===t?e.len:e.pos+t,s={};for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:s.from=e.bytes();break;case 2:s.data=e.bytes();break;case 3:s.seqno=e.bytes();break;case 4:s.topic=e.string();break;case 5:s.signature=e.bytes();break;case 6:s.key=e.bytes();break;default:e.skipType(7&t)}}if(!s.topic)throw Error("missing required 'topic'");return s}function wf(e,t,n){const s=void 0===t?e.len:e.pos+t,r={};for(;e.pos<s;){const t=e.uint32();switch(t>>>3){case 1:r.ihave&&r.ihave.length||(r.ihave=[]),r.ihave.length<n.maxControlMessages?r.ihave.push(bf(e,e.uint32(),n)):e.skipType(7&t);break;case 2:r.iwant&&r.iwant.length||(r.iwant=[]),r.iwant.length<n.maxControlMessages?r.iwant.push(_f(e,e.uint32(),n)):e.skipType(7&t);break;case 3:r.graft&&r.graft.length||(r.graft=[]),r.graft.length<n.maxControlMessages?r.graft.push(Ef(e,e.uint32())):e.skipType(7&t);break;case 4:r.prune&&r.prune.length||(r.prune=[]),r.prune.length<n.maxControlMessages?r.prune.push(vf(e,e.uint32(),n)):e.skipType(7&t);break;default:e.skipType(7&t)}}return r}function bf(e,t,n){const s=void 0===t?e.len:e.pos+t,r={};for(;e.pos<s;){const t=e.uint32();switch(t>>>3){case 1:r.topicID=e.string();break;case 2:r.messageIDs&&r.messageIDs.length||(r.messageIDs=[]),n.maxIhaveMessageIDs-- >0?r.messageIDs.push(e.bytes()):e.skipType(7&t);break;default:e.skipType(7&t)}}return r}function _f(e,t,n){const s=void 0===t?e.len:e.pos+t,r={};for(;e.pos<s;){const t=e.uint32();if(t>>>3==1)r.messageIDs&&r.messageIDs.length||(r.messageIDs=[]),n.maxIwantMessageIDs-- >0?r.messageIDs.push(e.bytes()):e.skipType(7&t);else e.skipType(7&t)}return r}function Ef(e,t){const n=void 0===t?e.len:e.pos+t,s={};for(;e.pos<n;){const t=e.uint32();if(t>>>3==1)s.topicID=e.string();else e.skipType(7&t)}return s}function vf(e,t,n){const s=void 0===t?e.len:e.pos+t,r={};for(;e.pos<s;){const t=e.uint32();switch(t>>>3){case 1:r.topicID=e.string();break;case 2:r.peers&&r.peers.length||(r.peers=[]),n.maxPeerInfos-- >0?r.peers.push(Sf(e,e.uint32())):e.skipType(7&t);break;case 3:r.backoff=e.uint64();break;default:e.skipType(7&t)}}return r}function Sf(e,t){const n=void 0===t?e.len:e.pos+t,s={};for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:s.peerID=e.bytes();break;case 2:s.signedPeerRecord=e.bytes();break;default:e.skipType(7&t)}}return s}var kf,Rf=n(4853);!function(e){e[e.ip4=4]="ip4",e[e.ip6=41]="ip6"}(kf||(kf={}));var Tf;!function(e){e[e.started=0]="started",e[e.stopped=1]="stopped"}(Tf||(Tf={}));class If extends Zh.b{constructor(e,t={}){super(),this.multicodecs=[op,rp],this.peers=new Set,this.streamsInbound=new Map,this.streamsOutbound=new Map,this.outboundInflightQueue=(0,Yn.N)({objectMode:!0}),this.direct=new Set,this.floodsubPeers=new Set,this.acceptFromWhitelist=new Map,this.topics=new Map,this.subscriptions=new Set,this.mesh=new Map,this.fanout=new Map,this.fanoutLastpub=new Map,this.gossip=new Map,this.control=new Map,this.peerhave=new Map,this.iasked=new Map,this.backoff=new Map,this.outbound=new Map,this.topicValidators=new Map,this.heartbeatTicks=0,this.directPeerInitial=null,this.status={code:Tf.stopped},this.heartbeatTimer=null,this.runHeartbeat=()=>{const e=this.metrics?.heartbeatDuration.startTimer();this.heartbeat().catch((e=>{this.log("Error running heartbeat",e)})).finally((()=>{if(null!=e&&e(),this.status.code===Tf.started){clearTimeout(this.status.heartbeatTimeout);let e=this.opts.heartbeatInterval-(Date.now()-this.status.hearbeatStartMs)%this.opts.heartbeatInterval;e<.25*this.opts.heartbeatInterval&&(e+=this.opts.heartbeatInterval,this.metrics?.heartbeatSkipped.inc()),this.status.heartbeatTimeout=setTimeout(this.runHeartbeat,e)}}))};const n={fallbackToFloodsub:!0,floodPublish:!0,doPX:!1,directPeers:[],D:6,Dlo:4,Dhi:12,Dscore:4,Dout:2,Dlazy:6,heartbeatInterval:1e3,fanoutTTL:6e4,mcacheLength:5,mcacheGossip:3,seenTTL:12e4,gossipsubIWantFollowupMs:3e3,prunePeers:16,pruneBackoff:6e4,graftFloodThreshold:1e4,opportunisticGraftPeers:2,opportunisticGraftTicks:60,directConnectTicks:300,...t,scoreParams:_p(t.scoreParams),scoreThresholds:Sp(t.scoreThresholds)};if(this.components=e,this.decodeRpcLimits=n.decodeRpcLimits??ff,this.globalSignaturePolicy=n.globalSignaturePolicy??fp.rv,n.fallbackToFloodsub&&this.multicodecs.push(sp),this.log=(0,a.vF)(n.debugName??"libp2p:gossipsub"),this.opts=n,this.direct=new Set(n.directPeers.map((e=>e.id.toString()))),this.seenCache=new Lp({validityMs:n.seenTTL}),this.publishedMessageIds=new Lp({validityMs:n.seenTTL}),t.msgIdFn)this.msgIdFn=t.msgIdFn;else switch(this.globalSignaturePolicy){case fp.rv:this.msgIdFn=$p;break;case fp.G$:this.msgIdFn=Vp}if(t.fastMsgIdFn&&(this.fastMsgIdFn=t.fastMsgIdFn,this.fastMsgIdCache=new Lp({validityMs:n.seenTTL})),this.msgIdToStrFn=t.msgIdToStrFn??cp,this.mcache=t.messageCache||new ep(n.mcacheGossip,n.mcacheLength,this.msgIdToStrFn),t.dataTransform&&(this.dataTransform=t.dataTransform),t.metricsRegister){if(!t.metricsTopicStrToLabel)throw Error("Must set metricsTopicStrToLabel with metrics");const e=Math.max(...Object.values(n.scoreParams.topics).map((e=>e.meshMessageDeliveriesWindow)),1e3),s=function(e,t,n){return{protocolsEnabled:e.gauge({name:"gossipsub_protocol",help:"Status of enabled protocols",labelNames:["protocol"]}),topicSubscriptionStatus:e.gauge({name:"gossipsub_topic_subscription_status",help:"Status of our subscription to this topic",labelNames:["topicStr"]}),topicPeersCount:e.gauge({name:"gossipsub_topic_peer_count",help:"Number of peers subscribed to each topic",labelNames:["topicStr"]}),meshPeerCounts:e.gauge({name:"gossipsub_mesh_peer_count",help:"Number of peers in our mesh",labelNames:["topicStr"]}),meshPeerInclusionEvents:e.gauge({name:"gossipsub_mesh_peer_inclusion_events_total",help:"Number of times we include peers in a topic mesh for different reasons",labelNames:["topic","reason"]}),meshPeerChurnEvents:e.gauge({name:"gossipsub_peer_churn_events_total",help:"Number of times we remove peers in a topic mesh for different reasons",labelNames:["topic","reason"]}),peersPerProtocol:e.gauge({name:"gossipsub_peers_per_protocol_count",help:"Peers connected for each topic",labelNames:["protocol"]}),heartbeatDuration:e.histogram({name:"gossipsub_heartbeat_duration_seconds",help:"The time it takes to complete one iteration of the heartbeat",buckets:[.01,.1,1]}),heartbeatSkipped:e.gauge({name:"gossipsub_heartbeat_skipped",help:"Heartbeat run took longer than heartbeat interval so next is skipped"}),asyncValidationResult:e.gauge({name:"gossipsub_async_validation_result_total",help:"Message validation result for each topic",labelNames:["topic","acceptance"]}),asyncValidationMcacheHit:e.gauge({name:"gossipsub_async_validation_mcache_hit_total",help:"Async validation result reported by the user layer",labelNames:["hit"]}),rpcRecvBytes:e.gauge({name:"gossipsub_rpc_recv_bytes_total",help:"RPC recv"}),rpcRecvCount:e.gauge({name:"gossipsub_rpc_recv_count_total",help:"RPC recv"}),rpcRecvSubscription:e.gauge({name:"gossipsub_rpc_recv_subscription_total",help:"RPC recv"}),rpcRecvMessage:e.gauge({name:"gossipsub_rpc_recv_message_total",help:"RPC recv"}),rpcRecvControl:e.gauge({name:"gossipsub_rpc_recv_control_total",help:"RPC recv"}),rpcRecvIHave:e.gauge({name:"gossipsub_rpc_recv_ihave_total",help:"RPC recv"}),rpcRecvIWant:e.gauge({name:"gossipsub_rpc_recv_iwant_total",help:"RPC recv"}),rpcRecvGraft:e.gauge({name:"gossipsub_rpc_recv_graft_total",help:"RPC recv"}),rpcRecvPrune:e.gauge({name:"gossipsub_rpc_recv_prune_total",help:"RPC recv"}),rpcRecvNotAccepted:e.gauge({name:"gossipsub_rpc_rcv_not_accepted_total",help:"Total count of RPC dropped because acceptFrom() == false"}),rpcSentBytes:e.gauge({name:"gossipsub_rpc_sent_bytes_total",help:"RPC sent"}),rpcSentCount:e.gauge({name:"gossipsub_rpc_sent_count_total",help:"RPC sent"}),rpcSentSubscription:e.gauge({name:"gossipsub_rpc_sent_subscription_total",help:"RPC sent"}),rpcSentMessage:e.gauge({name:"gossipsub_rpc_sent_message_total",help:"RPC sent"}),rpcSentControl:e.gauge({name:"gossipsub_rpc_sent_control_total",help:"RPC sent"}),rpcSentIHave:e.gauge({name:"gossipsub_rpc_sent_ihave_total",help:"RPC sent"}),rpcSentIWant:e.gauge({name:"gossipsub_rpc_sent_iwant_total",help:"RPC sent"}),rpcSentGraft:e.gauge({name:"gossipsub_rpc_sent_graft_total",help:"RPC sent"}),rpcSentPrune:e.gauge({name:"gossipsub_rpc_sent_prune_total",help:"RPC sent"}),msgPublishCount:e.gauge({name:"gossipsub_msg_publish_count_total",help:"Total count of msg published by topic",labelNames:["topic"]}),msgPublishPeers:e.gauge({name:"gossipsub_msg_publish_peers_total",help:"Total count of peers that we publish a msg to",labelNames:["topic"]}),msgPublishPeersByGroup:e.gauge({name:"gossipsub_msg_publish_peers_by_group",help:"Total count of peers (by group) that we publish a msg to",labelNames:["topic","peerGroup"]}),msgPublishBytes:e.gauge({name:"gossipsub_msg_publish_bytes_total",help:"Total count of msg publish data.length bytes",labelNames:["topic"]}),msgForwardCount:e.gauge({name:"gossipsub_msg_forward_count_total",help:"Total count of msg forwarded by topic",labelNames:["topic"]}),msgForwardPeers:e.gauge({name:"gossipsub_msg_forward_peers_total",help:"Total count of peers that we forward a msg to",labelNames:["topic"]}),msgReceivedPreValidation:e.gauge({name:"gossipsub_msg_received_prevalidation_total",help:"Total count of recv msgs before any validation",labelNames:["topic"]}),msgReceivedStatus:e.gauge({name:"gossipsub_msg_received_status_total",help:"Tracks distribution of recv msgs by duplicate, invalid, valid",labelNames:["topic","status"]}),msgReceivedInvalid:e.gauge({name:"gossipsub_msg_received_invalid_total",help:"Tracks specific reason of invalid",labelNames:["topic","error"]}),duplicateMsgDeliveryDelay:e.histogram({name:"gossisub_duplicate_msg_delivery_delay_seconds",help:"Time since the 1st duplicated message validated",labelNames:["topic"],buckets:[.25*n.maxMeshMessageDeliveriesWindowSec,.5*n.maxMeshMessageDeliveriesWindowSec,1*n.maxMeshMessageDeliveriesWindowSec,2*n.maxMeshMessageDeliveriesWindowSec,4*n.maxMeshMessageDeliveriesWindowSec]}),duplicateMsgLateDelivery:e.gauge({name:"gossisub_duplicate_msg_late_delivery_total",help:"Total count of late duplicate message delivery by topic, which triggers P3 penalty",labelNames:["topic"]}),duplicateMsgIgnored:e.gauge({name:"gossisub_ignored_published_duplicate_msgs_total",help:"Total count of published duplicate message ignored by topic",labelNames:["topic"]}),scoreFnCalls:e.gauge({name:"gossipsub_score_fn_calls_total",help:"Total times score() is called"}),scoreFnRuns:e.gauge({name:"gossipsub_score_fn_runs_total",help:"Total times score() call actually computed computeScore(), no cache"}),scoreCachedDelta:e.histogram({name:"gossipsub_score_cache_delta",help:"Delta of score between cached values that expired",buckets:[10,100,1e3]}),peersByScoreThreshold:e.gauge({name:"gossipsub_peers_by_score_threshold_count",help:"Current count of peers by score threshold",labelNames:["threshold"]}),score:e.avgMinMax({name:"gossipsub_score",help:"Avg min max of gossip scores",labelNames:["topic","p"]}),scoreWeights:e.avgMinMax({name:"gossipsub_score_weights",help:"Separate score weights",labelNames:["topic","p"]}),scorePerMesh:e.avgMinMax({name:"gossipsub_score_per_mesh",help:"Histogram of the scores for each mesh topic",labelNames:["topic"]}),scoringPenalties:e.gauge({name:"gossipsub_scoring_penalties_total",help:"A counter of the kind of penalties being applied to peers",labelNames:["penalty"]}),behaviourPenalty:e.histogram({name:"gossipsub_peer_stat_behaviour_penalty",help:"Current peer stat behaviour_penalty at each scrape",buckets:[.25*n.behaviourPenaltyThreshold,.5*n.behaviourPenaltyThreshold,1*n.behaviourPenaltyThreshold,2*n.behaviourPenaltyThreshold,4*n.behaviourPenaltyThreshold]}),ihaveRcvIgnored:e.gauge({name:"gossipsub_ihave_rcv_ignored_total",help:"Total received IHAVE messages that we ignore for some reason",labelNames:["reason"]}),ihaveRcvMsgids:e.gauge({name:"gossipsub_ihave_rcv_msgids_total",help:"Total received IHAVE messages by topic",labelNames:["topic"]}),ihaveRcvNotSeenMsgids:e.gauge({name:"gossipsub_ihave_rcv_not_seen_msgids_total",help:"Total messages per topic we do not have, not actual requests",labelNames:["topic"]}),iwantRcvMsgids:e.gauge({name:"gossipsub_iwant_rcv_msgids_total",help:"Total received IWANT messages by topic",labelNames:["topic"]}),iwantRcvDonthaveMsgids:e.gauge({name:"gossipsub_iwant_rcv_dont_have_msgids_total",help:"Total requested messageIDs that we do not have"}),iwantPromiseStarted:e.gauge({name:"gossipsub_iwant_promise_sent_total",help:"Total count of started IWANT promises"}),iwantPromiseResolved:e.gauge({name:"gossipsub_iwant_promise_resolved_total",help:"Total count of resolved IWANT promises"}),iwantPromiseResolvedFromDuplicate:e.gauge({name:"gossipsub_iwant_promise_resolved_from_duplicate_total",help:"Total count of resolved IWANT promises from duplicate messages"}),iwantPromiseResolvedPeers:e.gauge({name:"gossipsub_iwant_promise_resolved_peers",help:"Total count of peers we have asked IWANT promises that are resolved"}),iwantPromiseBroken:e.gauge({name:"gossipsub_iwant_promise_broken",help:"Total count of broken IWANT promises"}),iwantMessagePruned:e.gauge({name:"gossipsub_iwant_message_pruned",help:"Total count of pruned IWANT messages"}),iwantPromiseDeliveryTime:e.histogram({name:"gossipsub_iwant_promise_delivery_seconds",help:"Histogram of delivery time of resolved IWANT promises",buckets:[.5*n.gossipPromiseExpireSec,1*n.gossipPromiseExpireSec,2*n.gossipPromiseExpireSec,4*n.gossipPromiseExpireSec]}),cacheSize:e.gauge({name:"gossipsub_cache_size",help:"Unbounded cache sizes",labelNames:["cache"]}),mcacheSize:e.gauge({name:"gossipsub_mcache_size",help:"Current mcache msg count"}),mcacheNotValidatedCount:e.gauge({name:"gossipsub_mcache_not_validated_count",help:"Current mcache msg count not validated"}),fastMsgIdCacheCollision:e.gauge({name:"gossipsub_fastmsgid_cache_collision_total",help:"Total count of key collisions on fastmsgid cache put"}),newConnectionCount:e.gauge({name:"gossipsub_new_connection_total",help:"Total new connection by status",labelNames:["status"]}),topicStrToLabel:t,toTopic(e){return this.topicStrToLabel.get(e)??e},onJoin(e){this.topicSubscriptionStatus.set({topicStr:e},1),this.meshPeerCounts.set({topicStr:e},0)},onLeave(e){this.topicSubscriptionStatus.set({topicStr:e},0),this.meshPeerCounts.set({topicStr:e},0)},onAddToMesh(e,t,n){const s=this.toTopic(e);this.meshPeerInclusionEvents.inc({topic:s,reason:t},n)},onRemoveFromMesh(e,t,n){const s=this.toTopic(e);this.meshPeerChurnEvents.inc({topic:s,reason:t},n)},onReportValidationMcacheHit(e){this.asyncValidationMcacheHit.inc({hit:e?"hit":"miss"})},onReportValidation(e,t){const n=this.toTopic(e);this.asyncValidationResult.inc({topic:n,acceptance:t})},onScorePenalty(e){this.scoringPenalties.inc({penalty:e},1)},onIhaveRcv(e,t,n){const s=this.toTopic(e);this.ihaveRcvMsgids.inc({topic:s},t),this.ihaveRcvNotSeenMsgids.inc({topic:s},n)},onIwantRcv(e,t){for(const[t,n]of e){const e=this.toTopic(t);this.iwantRcvMsgids.inc({topic:e},n)}this.iwantRcvDonthaveMsgids.inc(t)},onForwardMsg(e,t){const n=this.toTopic(e);this.msgForwardCount.inc({topic:n},1),this.msgForwardPeers.inc({topic:n},t)},onPublishMsg(e,t,n,s){const r=this.toTopic(e);this.msgPublishCount.inc({topic:r},1),this.msgPublishBytes.inc({topic:r},n*s),this.msgPublishPeers.inc({topic:r},n),this.msgPublishPeersByGroup.inc({topic:r,peerGroup:"direct"},t.direct),this.msgPublishPeersByGroup.inc({topic:r,peerGroup:"floodsub"},t.floodsub),this.msgPublishPeersByGroup.inc({topic:r,peerGroup:"mesh"},t.mesh),this.msgPublishPeersByGroup.inc({topic:r,peerGroup:"fanout"},t.fanout)},onMsgRecvPreValidation(e){const t=this.toTopic(e);this.msgReceivedPreValidation.inc({topic:t},1)},onMsgRecvResult(e,t){const n=this.toTopic(e);this.msgReceivedStatus.inc({topic:n,status:t})},onMsgRecvInvalid(e,t){const n=this.toTopic(e),s=t.reason===up.Error?t.error:t.reason;this.msgReceivedInvalid.inc({topic:n,error:s},1)},onDuplicateMsgDelivery(e,t,n){if(this.duplicateMsgDeliveryDelay.observe(t/1e3),n){const t=this.toTopic(e);this.duplicateMsgLateDelivery.inc({topic:t},1)}},onPublishDuplicateMsg(e){const t=this.toTopic(e);this.duplicateMsgIgnored.inc({topic:t},1)},onRpcRecv(e,t){this.rpcRecvBytes.inc(t),this.rpcRecvCount.inc(1),e.subscriptions&&this.rpcRecvSubscription.inc(e.subscriptions.length),e.messages&&this.rpcRecvMessage.inc(e.messages.length),e.control&&(this.rpcRecvControl.inc(1),e.control.ihave&&this.rpcRecvIHave.inc(e.control.ihave.length),e.control.iwant&&this.rpcRecvIWant.inc(e.control.iwant.length),e.control.graft&&this.rpcRecvGraft.inc(e.control.graft.length),e.control.prune&&this.rpcRecvPrune.inc(e.control.prune.length))},onRpcSent(e,t){if(this.rpcSentBytes.inc(t),this.rpcSentCount.inc(1),e.subscriptions&&this.rpcSentSubscription.inc(e.subscriptions.length),e.messages&&this.rpcSentMessage.inc(e.messages.length),e.control){const t=e.control.ihave?.length??0,n=e.control.iwant?.length??0,s=e.control.graft?.length??0,r=e.control.prune?.length??0;t>0&&this.rpcSentIHave.inc(t),n>0&&this.rpcSentIWant.inc(n),s>0&&this.rpcSentGraft.inc(s),r>0&&this.rpcSentPrune.inc(r),(t>0||n>0||s>0||r>0)&&this.rpcSentControl.inc(1)}},registerScores(e,t){let n=0,s=0,r=0,o=0;for(const i of e)i>=t.graylistThreshold&&n++,i>=t.publishThreshold&&s++,i>=t.gossipThreshold&&r++,i>=0&&o++;this.peersByScoreThreshold.set({threshold:Up.graylist},n),this.peersByScoreThreshold.set({threshold:Up.publish},s),this.peersByScoreThreshold.set({threshold:Up.gossip},r),this.peersByScoreThreshold.set({threshold:Up.mesh},o),this.score.set(e)},registerScoreWeights(e){for(const[t,n]of e.byTopic)this.scoreWeights.set({topic:t,p:"p1"},n.p1w),this.scoreWeights.set({topic:t,p:"p2"},n.p2w),this.scoreWeights.set({topic:t,p:"p3"},n.p3w),this.scoreWeights.set({topic:t,p:"p3b"},n.p3bw),this.scoreWeights.set({topic:t,p:"p4"},n.p4w);this.scoreWeights.set({p:"p5"},e.p5w),this.scoreWeights.set({p:"p6"},e.p6w),this.scoreWeights.set({p:"p7"},e.p7w)},registerScorePerMesh(e,t){const n=new Map;e.forEach(((e,t)=>{const s=this.topicStrToLabel.get(t)??"unknown";let r=n.get(s);r||(r=new Set,n.set(s,r)),e.forEach((e=>r?.add(e)))}));for(const[e,s]of n){const n=[];s.forEach((e=>{n.push(t.get(e)??0)})),this.scorePerMesh.set({topic:e},n)}}}}(t.metricsRegister,t.metricsTopicStrToLabel,{gossipPromiseExpireSec:this.opts.gossipsubIWantFollowupMs/1e3,behaviourPenaltyThreshold:n.scoreParams.behaviourPenaltyThreshold,maxMeshMessageDeliveriesWindowSec:e/1e3});s.mcacheSize.addCollect((()=>this.onScrapeMetrics(s)));for(const e of this.multicodecs)s.protocolsEnabled.set({protocol:e},1);this.metrics=s}else this.metrics=null;this.gossipTracer=new Np(this.opts.gossipsubIWantFollowupMs,this.msgIdToStrFn,this.metrics),this.score=new Op(this.opts.scoreParams,this.metrics,{scoreCacheValidityMs:n.heartbeatInterval}),this.maxInboundStreams=t.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams,this.allowedTopics=n.allowedTopics?new Set(n.allowedTopics):null}getPeers(){return[...this.peers.keys()].map((e=>(0,Ht.XL)(e)))}isStarted(){return this.status.code===Tf.started}async start(){if(this.isStarted())return;this.log("starting"),this.publishConfig=await async function(e,t){switch(e){case fp.rv:{if(!t)throw Error("Must provide PeerId");if(null==t.privateKey)throw Error("Cannot sign message, no private key present");if(null==t.publicKey)throw Error("Cannot sign message, no public key present");const e=await(0,Jt.unmarshalPrivateKey)(t.privateKey);return{type:dp.Signing,author:t,key:t.publicKey,privateKey:e}}case fp.G$:return{type:dp.Anonymous};default:throw new Error(`Unknown signature policy "${e}"`)}}(this.globalSignaturePolicy,this.components.peerId),this.outboundInflightQueue=(0,Yn.N)({objectMode:!0}),Xh(this.outboundInflightQueue,(async e=>{for await(const{peerId:t,connection:n}of e)await this.createOutboundStream(t,n)})).catch((e=>this.log.error("outbound inflight queue error",e))),await Promise.all(this.opts.directPeers.map((async e=>{await this.components.peerStore.addressBook.add(e.id,e.addrs)})));const e=this.components.registrar;await Promise.all(this.multicodecs.map((t=>e.handle(t,this.onIncomingStream.bind(this),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}))));const t=(0,Jh.g)({onConnect:this.onPeerConnected.bind(this),onDisconnect:this.onPeerDisconnected.bind(this)}),n=await Promise.all(this.multicodecs.map((n=>e.register(n,t)))),s=setTimeout(this.runHeartbeat,100);this.status={code:Tf.started,registrarTopologyIds:n,heartbeatTimeout:s,hearbeatStartMs:Date.now()+100},this.score.start(),this.directPeerInitial=setTimeout((()=>{Promise.resolve().then((async()=>{await Promise.all(Array.from(this.direct).map((async e=>await this.connect(e))))})).catch((e=>{this.log(e)}))}),1e3),this.log("started")}async stop(){if(this.log("stopping"),this.status.code!==Tf.started)return;const{registrarTopologyIds:e}=this.status;this.status={code:Tf.stopped};const t=this.components.registrar;e.forEach((e=>t.unregister(e))),this.outboundInflightQueue.end();for(const e of this.streamsOutbound.values())e.close();this.streamsOutbound.clear();for(const e of this.streamsInbound.values())e.close();this.streamsInbound.clear(),this.peers.clear(),this.subscriptions.clear(),this.heartbeatTimer&&(this.heartbeatTimer.cancel(),this.heartbeatTimer=null),this.score.stop(),this.mesh.clear(),this.fanout.clear(),this.fanoutLastpub.clear(),this.gossip.clear(),this.control.clear(),this.peerhave.clear(),this.iasked.clear(),this.backoff.clear(),this.outbound.clear(),this.gossipTracer.clear(),this.seenCache.clear(),this.fastMsgIdCache&&this.fastMsgIdCache.clear(),this.directPeerInitial&&clearTimeout(this.directPeerInitial),this.log("stopped")}dumpPeerScoreStats(){return this.score.dumpPeerScoreStats()}onIncomingStream({stream:e,connection:t}){if(!this.isStarted())return;const n=t.remotePeer;this.addPeer(n,t.stat.direction,t.remoteAddr),this.createInboundStream(n,e),this.outboundInflightQueue.push({peerId:n,connection:t})}onPeerConnected(e,t){this.metrics?.newConnectionCount.inc({status:t.stat.status}),this.isStarted()&&"OPEN"===t.stat.status&&(this.addPeer(e,t.stat.direction,t.remoteAddr),this.outboundInflightQueue.push({peerId:e,connection:t}))}onPeerDisconnected(e){this.log("connection ended %p",e),this.removePeer(e)}async createOutboundStream(e,t){if(!this.isStarted())return;const n=e.toString();if(this.peers.has(n)&&!this.streamsOutbound.has(n))try{const s=new uf(await t.newStream(this.multicodecs),(e=>this.log.error("outbound pipe error",e)),{maxBufferSize:this.opts.maxOutboundBufferSize});this.log("create outbound stream %p",e),this.streamsOutbound.set(n,s);const r=s.protocol;r===sp&&this.floodsubPeers.add(n),this.metrics?.peersPerProtocol.inc({protocol:r},1),this.subscriptions.size>0&&(this.log("send subscriptions to",n),this.sendSubscriptions(n,Array.from(this.subscriptions),!0))}catch(e){this.log.error("createOutboundStream error",e)}}async createInboundStream(e,t){if(!this.isStarted())return;const n=e.toString();if(!this.peers.has(n))return;const s=this.streamsInbound.get(n);void 0!==s&&(this.log("replacing existing inbound steam %s",n),s.close()),this.log("create inbound stream %s",n);const r=new hf(t,{maxDataLength:this.opts.maxInboundDataLength});this.streamsInbound.set(n,r),this.pipePeerReadStream(e,r.source).catch((e=>this.log(e)))}addPeer(e,t,n){const s=e.toString();if(!this.peers.has(s)){this.log("new peer %p",e),this.peers.add(s),this.score.addPeer(s);const r=function(e){for(const t of e.tuples())switch(t[0]){case kf.ip4:case kf.ip6:return(0,Rf.cR)(t[0],t[1])}return null}(n);null!==r?this.score.addIP(s,r):this.log("Added peer has no IP in current address %s %s",s,n.toString()),this.outbound.has(s)||this.outbound.set(s,"outbound"===t)}}removePeer(e){const t=e.toString();if(!this.peers.has(t))return;this.log("delete peer %p",e),this.peers.delete(t);const n=this.streamsOutbound.get(t),s=this.streamsInbound.get(t);n&&this.metrics?.peersPerProtocol.inc({protocol:n.protocol},-1),n?.close(),s?.close(),this.streamsOutbound.delete(t),this.streamsInbound.delete(t);for(const e of this.topics.values())e.delete(t);for(const[e,n]of this.mesh)!0===n.delete(t)&&this.metrics?.onRemoveFromMesh(e,xp.Dc,1);for(const e of this.fanout.values())e.delete(t);this.floodsubPeers.delete(t),this.gossip.delete(t),this.control.delete(t),this.outbound.delete(t),this.score.removePeer(t),this.acceptFromWhitelist.delete(t)}get started(){return this.status.code===Tf.started}getMeshPeers(e){const t=this.mesh.get(e);return t?Array.from(t):[]}getSubscribers(e){const t=this.topics.get(e);return(t?Array.from(t):[]).map((e=>(0,Ht.XL)(e)))}getTopics(){return Array.from(this.subscriptions)}async pipePeerReadStream(e,t){try{await Xh(t,(async t=>{for await(const n of t)try{const t=n.subarray(),s=yf(t,this.decodeRpcLimits);this.metrics?.onRpcRecv(s,t.length),this.opts.awaitRpcHandler?await this.handleReceivedRpc(e,s):this.handleReceivedRpc(e,s).catch((e=>this.log(e)))}catch(e){this.log(e)}}))}catch(t){this.handlePeerReadStreamError(t,e)}}handlePeerReadStreamError(e,t){this.log.error(e),this.onPeerDisconnected(t)}async handleReceivedRpc(e,t){if(!this.acceptFrom(e.toString()))return this.log("received message from unacceptable peer %p",e),void this.metrics?.rpcRecvNotAccepted.inc();if(this.log("rpc from %p",e),t.subscriptions&&t.subscriptions.length>0){const n=[];t.subscriptions.forEach((t=>{const s=t.topic,r=!0===t.subscribe;if(null!=s){if(this.allowedTopics&&!this.allowedTopics.has(s))return;this.handleReceivedSubscription(e,s,r),n.push({topic:s,subscribe:r})}})),this.dispatchEvent(new Zh.u("subscription-change",{detail:{peerId:e,subscriptions:n}}))}if(t.messages)for(const n of t.messages){if(this.allowedTopics&&!this.allowedTopics.has(n.topic))continue;const t=this.handleReceivedMessage(e,n).catch((e=>this.log(e)));this.opts.awaitRpcMessageHandler&&await t}t.control&&await this.handleControlMessage(e.toString(),t.control)}handleReceivedSubscription(e,t,n){this.log("subscription update from %p topic %s",e,t);let s=this.topics.get(t);null==s&&(s=new Set,this.topics.set(t,s)),n?s.add(e.toString()):s.delete(e.toString())}async handleReceivedMessage(e,t){this.metrics?.onMsgRecvPreValidation(t.topic);const n=await this.validateReceivedMessage(e,t);switch(this.metrics?.onMsgRecvResult(t.topic,n.code),n.code){case pp.duplicate:return this.score.duplicateMessage(e.toString(),n.msgIdStr,t.topic),this.gossipTracer.deliverMessage(n.msgIdStr,!0),void this.mcache.observeDuplicate(n.msgIdStr,e.toString());case pp.invalid:if(n.msgIdStr){const s=n.msgIdStr;this.score.rejectMessage(e.toString(),s,t.topic,n.reason),this.gossipTracer.rejectMessage(s,n.reason)}else this.score.rejectInvalidMessage(e.toString(),t.topic);return void this.metrics?.onMsgRecvInvalid(t.topic,n);case pp.valid:if(this.score.validateMessage(n.messageId.msgIdStr),this.gossipTracer.deliverMessage(n.messageId.msgIdStr),this.mcache.put(n.messageId,t,!this.opts.asyncValidation),this.subscriptions.has(t.topic)){this.components.peerId.equals(e)&&!this.opts.emitSelf||(super.dispatchEvent(new Zh.u("gossipsub:message",{detail:{propagationSource:e,msgId:n.messageId.msgIdStr,msg:n.msg}})),super.dispatchEvent(new Zh.u("message",{detail:n.msg})))}this.opts.asyncValidation||this.forwardMessage(n.messageId.msgIdStr,t,e.toString())}}async validateReceivedMessage(e,t){const n=this.fastMsgIdFn?.(t),s=void 0!==n?this.fastMsgIdCache?.get(n):void 0;if(s)return{code:pp.duplicate,msgIdStr:s};const r=await async function(e,t){switch(e){case fp.G$:return null!=t.signature?{valid:!1,error:hp.SignaturePresent}:null!=t.seqno?{valid:!1,error:hp.SeqnoPresent}:null!=t.key?{valid:!1,error:hp.FromPresent}:{valid:!0,message:{type:"unsigned",topic:t.topic,data:t.data??new Uint8Array(0)}};case fp.rv:{if(null==t.seqno)return{valid:!1,error:hp.InvalidSeqno};if(8!==t.seqno.length)return{valid:!1,error:hp.InvalidSeqno};if(null==t.signature)return{valid:!1,error:hp.InvalidSignature};if(null==t.from)return{valid:!1,error:hp.InvalidPeerId};let e,n;try{e=(0,Ht.nu)(t.from)}catch(e){return{valid:!1,error:hp.InvalidPeerId}}if(t.key){if(n=(0,Jt.unmarshalPublicKey)(t.key),void 0!==e.publicKey&&!(0,ve.a)(n.bytes,e.publicKey))return{valid:!1,error:hp.InvalidPeerId}}else{if(null==e.publicKey)return{valid:!1,error:hp.InvalidPeerId};n=(0,Jt.unmarshalPublicKey)(e.publicKey)}const s={from:t.from,data:t.data,seqno:t.seqno,topic:t.topic,signature:void 0,key:void 0},r=(0,ee.x)([jp,np.Message.encode(s).finish()]);return await n.verify(r,t.signature)?{valid:!0,message:{type:"signed",from:e,data:t.data??new Uint8Array(0),sequenceNumber:BigInt(`0x${(0,$.d)(t.seqno,"base16")}`),topic:t.topic,signature:t.signature,key:t.key??(0,Jt.marshalPublicKey)(n)}}:{valid:!1,error:hp.InvalidSignature}}}}(this.globalSignaturePolicy,t);if(!r.valid)return{code:pp.invalid,reason:up.Error,error:r.error};const o=r.message;try{this.dataTransform&&(o.data=this.dataTransform.inboundTransform(t.topic,o.data))}catch(e){return this.log("Invalid message, transform failed",e),{code:pp.invalid,reason:up.Error,error:hp.TransformFailed}}const i=await this.msgIdFn(o),a=this.msgIdToStrFn(i),c={msgId:i,msgIdStr:a};if(void 0!==n&&this.fastMsgIdCache){this.fastMsgIdCache.put(n,a)&&this.metrics?.fastMsgIdCacheCollision.inc()}if(this.seenCache.has(a))return{code:pp.duplicate,msgIdStr:a};this.seenCache.put(a);const l=this.topicValidators.get(t.topic);if(null!=l){let t;try{t=await l(e,o)}catch(e){const n=e.code;"ERR_TOPIC_VALIDATOR_IGNORE"===n&&(t=fp.z8.Ignore),t="ERR_TOPIC_VALIDATOR_REJECT"===n?fp.z8.Reject:fp.z8.Ignore}if(t!==fp.z8.Accept)return{code:pp.invalid,reason:yp(t),msgIdStr:a}}return{code:pp.valid,messageId:c,msg:o}}getScore(e){return this.score.score(e)}sendSubscriptions(e,t,n){this.sendRpc(e,{subscriptions:t.map((e=>({topic:e,subscribe:n})))})}async handleControlMessage(e,t){if(void 0===t)return;const n=t.ihave?this.handleIHave(e,t.ihave):[],s=t.iwant?this.handleIWant(e,t.iwant):[],r=t.graft?await this.handleGraft(e,t.graft):[];t.prune&&await this.handlePrune(e,t.prune),(n.length||s.length||r.length)&&this.sendRpc(e,{messages:s,control:{iwant:n,prune:r}})}acceptFrom(e){if(this.direct.has(e))return!0;const t=Date.now(),n=this.acceptFromWhitelist.get(e);if(n&&n.messagesAccepted<128&&n.acceptUntil>=t)return n.messagesAccepted+=1,!0;const s=this.score.score(e);return s>=0?this.acceptFromWhitelist.set(e,{messagesAccepted:0,acceptUntil:t+1e3}):this.acceptFromWhitelist.delete(e),s>=this.opts.scoreThresholds.graylistThreshold}handleIHave(e,t){if(!t.length)return[];const n=this.score.score(e);if(n<this.opts.scoreThresholds.gossipThreshold)return this.log("IHAVE: ignoring peer %s with score below threshold [ score = %d ]",e,n),this.metrics?.ihaveRcvIgnored.inc({reason:zp.LowScore}),[];const s=(this.peerhave.get(e)??0)+1;if(this.peerhave.set(e,s),s>10)return this.log("IHAVE: peer %s has advertised too many times (%d) within this heartbeat interval; ignoring",e,s),this.metrics?.ihaveRcvIgnored.inc({reason:zp.MaxIhave}),[];const r=this.iasked.get(e)??0;if(r>=ip)return this.log("IHAVE: peer %s has already advertised too many messages (%d); ignoring",e,r),this.metrics?.ihaveRcvIgnored.inc({reason:zp.MaxIasked}),[];const o=new Map;if(t.forEach((({topicID:e,messageIDs:t})=>{if(!e||!t||!this.mesh.has(e))return;let n=0;t.forEach((e=>{const t=this.msgIdToStrFn(e);this.seenCache.has(t)||(o.set(t,e),n++)})),this.metrics?.onIhaveRcv(e,t.length,n)})),!o.size)return[];let i=o.size;i+r>ip&&(i=ip-r),this.log("IHAVE: Asking for %d out of %d messages from %s",i,o.size,e);let a=Array.from(o.values());return ap(a),a=a.slice(0,i),this.iasked.set(e,r+i),this.gossipTracer.addPromise(e,a),[{messageIDs:a}]}handleIWant(e,t){if(!t.length)return[];const n=this.score.score(e);if(n<this.opts.scoreThresholds.gossipThreshold)return this.log("IWANT: ignoring peer %s with score below threshold [score = %d]",e,n),[];const s=new Map,r=new Map;let o=0;return t.forEach((({messageIDs:t})=>{t&&t.forEach((t=>{const n=this.msgIdToStrFn(t),i=this.mcache.getWithIWantCount(n,e);null!=i?(r.set(i.msg.topic,1+(r.get(i.msg.topic)??0)),i.count>3?this.log("IWANT: Peer %s has asked for message %s too many times: ignoring request",e,t):s.set(n,i.msg)):o++}))})),this.metrics?.onIwantRcv(r,o),s.size?(this.log("IWANT: Sending %d messages to %s",s.size,e),Array.from(s.values())):(this.log("IWANT: Could not provide any wanted messages to %s",e),[])}async handleGraft(e,t){const n=[],s=this.score.score(e),r=Date.now();let o=this.opts.doPX;return t.forEach((({topicID:t})=>{if(!t)return;const i=this.mesh.get(t);if(!i)return void(o=!1);if(i.has(e))return;if(this.direct.has(e))return this.log("GRAFT: ignoring request from direct peer %s",e),n.push(t),void(o=!1);const a=this.backoff.get(t)?.get(e);if("number"==typeof a&&r<a){this.log("GRAFT: ignoring backed off peer %s",e),this.score.addPenalty(e,1,Bp.GraftBackoff),o=!1;const s=a+this.opts.graftFloodThreshold-this.opts.pruneBackoff;return r<s&&this.score.addPenalty(e,1,Bp.GraftBackoff),this.addBackoff(e,t),void n.push(t)}return s<0?(this.log("GRAFT: ignoring peer %s with negative score: score=%d, topic=%s",e,s,t),n.push(t),o=!1,void this.addBackoff(e,t)):i.size>=this.opts.Dhi&&!this.outbound.get(e)?(n.push(t),void this.addBackoff(e,t)):(this.log("GRAFT: Add mesh link from %s in %s",e,t),this.score.graft(e,t),i.add(e),void this.metrics?.onAddToMesh(t,Cp.Subscribed,1))})),n.length?await Promise.all(n.map((t=>this.makePrune(e,t,o)))):[]}async handlePrune(e,t){const n=this.score.score(e);for(const{topicID:s,backoff:r,peers:o}of t){if(null==s)continue;const t=this.mesh.get(s);if(!t)return;if(this.log("PRUNE: Remove mesh link to %s in %s",e,s),this.score.prune(e,s),t.has(e)&&(t.delete(e),this.metrics?.onRemoveFromMesh(s,xp.Unsub,1)),"number"==typeof r&&r>0?this.doAddBackoff(e,s,1e3*r):this.addBackoff(e,s),o&&o.length){if(n<this.opts.scoreThresholds.acceptPXThreshold){this.log("PRUNE: ignoring PX from peer %s with insufficient score [score = %d, topic = %s]",e,n,s);continue}await this.pxConnect(o)}}}addBackoff(e,t){this.doAddBackoff(e,t,this.opts.pruneBackoff)}doAddBackoff(e,t,n){let s=this.backoff.get(t);s||(s=new Map,this.backoff.set(t,s));const r=Date.now()+n;(s.get(e)??0)<r&&s.set(e,r)}applyIwantPenalties(){this.gossipTracer.getBrokenPromises().forEach(((e,t)=>{this.log("peer %s didn't follow up in %d IWANT requests; adding penalty",t,e),this.score.addPenalty(t,e,Bp.BrokenPromise)}))}clearBackoff(){if(this.heartbeatTicks%15!=0)return;const e=Date.now();this.backoff.forEach(((t,n)=>{t.forEach(((n,s)=>{n<e&&t.delete(s)})),0===t.size&&this.backoff.delete(n)}))}async directConnect(){const e=[];this.direct.forEach((t=>{this.streamsOutbound.has(t)||e.push(t)})),await Promise.all(e.map((async e=>await this.connect(e))))}async pxConnect(e){e.length>this.opts.prunePeers&&(ap(e),e=e.slice(0,this.opts.prunePeers));const t=[];await Promise.all(e.map((async e=>{if(!e.peerID)return;const n=(0,Ht.nu)(e.peerID).toString();if(!this.peers.has(n))if(e.signedPeerRecord)try{const s=await Qh.e.openAndCertify(e.signedPeerRecord,"libp2p-peer-record"),r=s.peerId;if(!s.peerId.equals(n))return void this.log("bogus peer record obtained through px: peer ID %p doesn't match expected peer %p",r,n);if(!await this.components.peerStore.addressBook.consumePeerRecord(s))return void this.log("bogus peer record obtained through px: could not add peer record to address book");t.push(n)}catch(e){this.log("bogus peer record obtained through px: invalid signature or not a peer record")}else t.push(n)}))),t.length&&await Promise.all(t.map((async e=>await this.connect(e))))}async connect(e){this.log("Initiating connection with %s",e);const t=(0,Ht.XL)(e),n=await this.components.connectionManager.openConnection(t);for(const e of this.multicodecs)for(const s of this.components.registrar.getTopologies(e))s.onConnect(t,n)}subscribe(e){if(this.status.code!==Tf.started)throw new Error("Pubsub has not started");if(!this.subscriptions.has(e)){this.subscriptions.add(e);for(const t of this.peers.keys())this.sendSubscriptions(t,[e],!0)}this.join(e)}unsubscribe(e){if(this.status.code!==Tf.started)throw new Error("Pubsub is not started");const t=this.subscriptions.delete(e);if(this.log("unsubscribe from %s - am subscribed %s",e,t),t)for(const t of this.peers.keys())this.sendSubscriptions(t,[e],!1);this.leave(e)}join(e){if(this.status.code!==Tf.started)throw new Error("Gossipsub has not started");if(this.mesh.has(e))return;this.log("JOIN %s",e),this.metrics?.onJoin(e);const t=new Set,n=this.fanout.get(e);if(n&&(this.fanout.delete(e),this.fanoutLastpub.delete(e),n.forEach((e=>{!this.direct.has(e)&&this.score.score(e)>=0&&t.add(e)})),this.metrics?.onAddToMesh(e,Cp.Fanout,t.size)),t.size<this.opts.D){const n=t.size;this.getRandomGossipPeers(e,this.opts.D,(e=>!t.has(e)&&!this.direct.has(e)&&this.score.score(e)>=0)).forEach((e=>{t.add(e)})),this.metrics?.onAddToMesh(e,Cp.Random,t.size-n)}this.mesh.set(e,t),t.forEach((t=>{this.log("JOIN: Add mesh link to %s in %s",t,e),this.sendGraft(t,e)}))}leave(e){if(this.status.code!==Tf.started)throw new Error("Gossipsub has not started");this.log("LEAVE %s",e),this.metrics?.onLeave(e);const t=this.mesh.get(e);t&&(Promise.all(Array.from(t).map((async t=>(this.log("LEAVE: Remove mesh link to %s in %s",t,e),await this.sendPrune(t,e))))).catch((e=>{this.log("Error sending prunes to mesh peers",e)})),this.mesh.delete(e))}selectPeersToForward(e,t,n){const s=new Set,r=this.topics.get(e);r&&(this.direct.forEach((e=>{r.has(e)&&t!==e&&!n?.has(e)&&s.add(e)})),this.floodsubPeers.forEach((e=>{r.has(e)&&t!==e&&!n?.has(e)&&this.score.score(e)>=this.opts.scoreThresholds.publishThreshold&&s.add(e)})));const o=this.mesh.get(e);return o&&o.size>0&&o.forEach((e=>{t===e||n?.has(e)||s.add(e)})),s}selectPeersToPublish(e){const t=new Set,n={direct:0,floodsub:0,mesh:0,fanout:0},s=this.topics.get(e);if(s)if(this.opts.floodPublish)s.forEach((e=>{this.direct.has(e)?(t.add(e),n.direct++):this.score.score(e)>=this.opts.scoreThresholds.publishThreshold&&(t.add(e),n.floodsub++)}));else{this.direct.forEach((e=>{s.has(e)&&(t.add(e),n.direct++)})),this.floodsubPeers.forEach((e=>{s.has(e)&&this.score.score(e)>=this.opts.scoreThresholds.publishThreshold&&(t.add(e),n.floodsub++)}));const r=this.mesh.get(e);if(r&&r.size>0)r.forEach((e=>{t.add(e),n.mesh++}));else{const s=this.fanout.get(e);if(s&&s.size>0)s.forEach((e=>{t.add(e),n.fanout++}));else{const s=this.getRandomGossipPeers(e,this.opts.D,(e=>this.score.score(e)>=this.opts.scoreThresholds.publishThreshold));s.size>0&&(this.fanout.set(e,s),s.forEach((e=>{t.add(e),n.fanout++})))}this.fanoutLastpub.set(e,Date.now())}}return{tosend:t,tosendCount:n}}forwardMessage(e,t,n,s){n&&this.score.deliverMessage(n,e,t.topic);const r=this.selectPeersToForward(t.topic,n,s);r.forEach((e=>{this.sendRpc(e,{messages:[t]})})),this.metrics?.onForwardMsg(t.topic,r.size)}async publish(e,t,n){const s=this.dataTransform?this.dataTransform.outboundTransform(e,t):t;if(null==this.publishConfig)throw Error("PublishError.Uninitialized");const{raw:r,msg:o}=await async function(e,t,n,s){switch(e.type){case dp.Signing:{const r={from:e.author.toBytes(),data:s,seqno:(0,Fp.po)(8),topic:t,signature:void 0,key:void 0},o=(0,ee.x)([jp,np.Message.encode(r).finish()]);return r.signature=await e.privateKey.sign(o),r.key=e.key,{raw:r,msg:{type:"signed",from:e.author,data:n,sequenceNumber:BigInt(`0x${(0,$.d)(r.seqno,"base16")}`),topic:t,signature:r.signature,key:r.key}}}case dp.Anonymous:return{raw:{from:void 0,data:s,seqno:void 0,topic:t,signature:void 0,key:void 0},msg:{type:"unsigned",data:n,topic:t}}}}(this.publishConfig,e,t,s),i=await this.msgIdFn(o),a=this.msgIdToStrFn(i),c=n?.ignoreDuplicatePublishError??this.opts.ignoreDuplicatePublishError;if(this.seenCache.has(a)){if(c)return this.metrics?.onPublishDuplicateMsg(e),{recipients:[]};throw Error("PublishError.Duplicate")}const{tosend:l,tosendCount:d}=this.selectPeersToPublish(e),u=!0===this.opts.emitSelf&&this.subscriptions.has(e),h=n?.allowPublishToZeroPeers??this.opts.allowPublishToZeroPeers;if(0===l.size&&!h&&!u)throw Error("PublishError.InsufficientPeers");this.seenCache.put(a),this.mcache.put({msgId:i,msgIdStr:a},r,!0),this.publishedMessageIds.put(a);for(const e of l){this.sendRpc(e,{messages:[r]})||l.delete(e)}return this.metrics?.onPublishMsg(e,d,l.size,null!=r.data?r.data.length:0),u&&(l.add(this.components.peerId.toString()),super.dispatchEvent(new Zh.u("gossipsub:message",{detail:{propagationSource:this.components.peerId,msgId:a,msg:o}})),super.dispatchEvent(new Zh.u("message",{detail:o}))),{recipients:Array.from(l.values()).map((e=>(0,Ht.XL)(e)))}}reportMessageValidationResult(e,t,n){if(n===fp.z8.Accept){const s=this.mcache.validate(e);if(this.metrics?.onReportValidationMcacheHit(null!==s),null!=s){const{message:r,originatingPeers:o}=s;this.score.deliverMessage(t.toString(),e,r.topic),this.forwardMessage(e,s.message,t.toString(),o),this.metrics?.onReportValidation(r.topic,n)}}else{const s=this.mcache.remove(e);if(this.metrics?.onReportValidationMcacheHit(null!==s),s){const r=yp(n),{message:o,originatingPeers:i}=s;this.score.rejectMessage(t.toString(),e,o.topic,r);for(const t of i)this.score.rejectMessage(t,e,o.topic,r);this.metrics?.onReportValidation(o.topic,n)}}}sendGraft(e,t){const n=[{topicID:t}];this.sendRpc(e,{control:{graft:n}})}async sendPrune(e,t){const n=[await this.makePrune(e,t,this.opts.doPX)];this.sendRpc(e,{control:{prune:n}})}sendRpc(e,t){const n=this.streamsOutbound.get(e);if(!n)return this.log(`Cannot send RPC to ${e} as there is no open stream to it available`),!1;const s=this.control.get(e);s&&(this.piggybackControl(e,t,s),this.control.delete(e));const r=this.gossip.get(e);r&&(this.piggybackGossip(e,t,r),this.gossip.delete(e));const o=np.encode(t).finish();try{n.push(o)}catch(t){return this.log.error(`Cannot send rpc to ${e}`,t),s&&this.control.set(e,s),r&&this.gossip.set(e,r),!1}return this.metrics?.onRpcSent(t,o.length),!0}piggybackControl(e,t,n){if(n.graft){t.control||(t.control={}),t.control.graft||(t.control.graft=[]);for(const s of n.graft)s.topicID&&this.mesh.get(s.topicID)?.has(e)&&t.control.graft.push(s)}if(n.prune){t.control||(t.control={}),t.control.prune||(t.control.prune=[]);for(const s of n.prune)s.topicID&&!this.mesh.get(s.topicID)?.has(e)&&t.control.prune.push(s)}}piggybackGossip(e,t,n){t.control||(t.control={}),t.control.ihave=n}async sendGraftPrune(e,t,n){const s=this.opts.doPX;for(const[r,o]of e){const e=o.map((e=>({topicID:e})));let i=[];const a=t.get(r);a&&(i=await Promise.all(a.map((async e=>await this.makePrune(r,e,s&&!n.get(r))))),t.delete(r)),this.sendRpc(r,{control:{graft:e,prune:i}})}for(const[e,r]of t){const t=await Promise.all(r.map((async t=>await this.makePrune(e,t,s&&!n.get(e)))));this.sendRpc(e,{control:{prune:t}})}}emitGossip(e){const t=this.mcache.getGossipIDs(new Set(e.keys()));for(const[n,s]of e)this.doEmitGossip(n,s,t.get(n)??[])}doEmitGossip(e,t,n){if(!n.length)return;if(ap(n),n.length>ip&&this.log("too many messages for gossip; will truncate IHAVE list (%d messages)",n.length),!t.size)return;let s=this.opts.Dlazy;const r=.25*t.size;let o=t;r>s&&(s=r),s>o.size?s=o.size:o=ap(Array.from(o)).slice(0,s),o.forEach((t=>{let s=n;n.length>ip&&(s=ap(s.slice()).slice(0,ip)),this.pushGossip(t,{topicID:e,messageIDs:s})}))}flush(){for(const[e,t]of this.gossip.entries())this.gossip.delete(e),this.sendRpc(e,{control:{ihave:t}});for(const[e,t]of this.control.entries())this.control.delete(e),this.sendRpc(e,{control:{graft:t.graft,prune:t.prune}})}pushGossip(e,t){this.log("Add gossip to %s",e);const n=this.gossip.get(e)||[];this.gossip.set(e,n.concat(t))}async makePrune(e,t,n){if(this.score.prune(e,t),this.streamsOutbound.get(e).protocol===rp)return{topicID:t,peers:[]};const s=this.opts.pruneBackoff/1e3;if(!n)return{topicID:t,peers:[],backoff:s};const r=this.getRandomGossipPeers(t,this.opts.prunePeers,(t=>t!==e&&this.score.score(t)>=0)),o=await Promise.all(Array.from(r).map((async e=>{const t=(0,Ht.XL)(e);return{peerID:t.toBytes(),signedPeerRecord:await this.components.peerStore.addressBook.getRawEnvelope(t)}})));return{topicID:t,peers:o,backoff:s}}async heartbeat(){const{D:e,Dlo:t,Dhi:n,Dscore:s,Dout:r,fanoutTTL:o}=this.opts;this.heartbeatTicks++;const i=new Map,a=e=>{let t=i.get(e);return void 0===t&&(t=this.score.score(e),i.set(e,t)),t},c=new Map,l=new Map,d=new Map;this.clearBackoff(),this.peerhave.clear(),this.metrics?.cacheSize.set({cache:"iasked"},this.iasked.size),this.iasked.clear(),this.applyIwantPenalties(),this.heartbeatTicks%this.opts.directConnectTicks==0&&await this.directConnect(),this.fastMsgIdCache?.prune(),this.seenCache.prune(),this.gossipTracer.prune(),this.publishedMessageIds.prune();const u=new Map;this.mesh.forEach(((o,i)=>{const h=this.topics.get(i),p=new Set,f=new Set;if(u.set(i,f),h){const e=ap(Array.from(h)),t=this.backoff.get(i);for(const n of e){const e=this.streamsOutbound.get(n);if(e&&this.multicodecs.includes(e.protocol)&&!o.has(n)&&!this.direct.has(n)){const e=a(n);t&&t.has(n)||!(e>=0)||p.add(n),e>=this.opts.scoreThresholds.gossipThreshold&&f.add(n)}}}const y=(e,t)=>{this.log("HEARTBEAT: Remove mesh link to %s in %s",e,i),this.addBackoff(e,i),o.delete(e),a(e)>=this.opts.scoreThresholds.gossipThreshold&&f.add(e),this.metrics?.onRemoveFromMesh(i,t,1);const n=l.get(e);n?n.push(i):l.set(e,[i])},g=(e,t)=>{this.log("HEARTBEAT: Add mesh link to %s in %s",e,i),this.score.graft(e,i),o.add(e),f.delete(e),this.metrics?.onAddToMesh(i,t,1);const n=c.get(e);n?n.push(i):c.set(e,[i])};if(o.forEach((e=>{const t=a(e);t<0&&(this.log("HEARTBEAT: Prune peer %s with negative score: score=%d, topic=%s",e,t,i),y(e,xp.BadScore),d.set(e,!0))})),o.size<t){const t=function(e,t){return Pp(e,t,(()=>!0))}(p,e-o.size);t.forEach((e=>{g(e,Cp.NotEnough)}))}if(o.size>n){let t=Array.from(o);t.sort(((e,t)=>a(t)-a(e))),t=t.slice(0,s).concat(ap(t.slice(s)));let n=0;if(t.slice(0,e).forEach((e=>{this.outbound.get(e)&&n++})),n<r){const s=e=>{const n=t[e];for(let n=e;n>0;n--)t[n]=t[n-1];t[0]=n};if(n>0){let r=n;for(let n=1;n<e&&r>0;n++)this.outbound.get(t[n])&&(s(n),r--)}let r=e-n;for(let n=e;n<t.length&&r>0;n++)this.outbound.get(t[n])&&(s(n),r--)}t.slice(e).forEach((e=>{y(e,xp.Excess)}))}if(o.size>=t){let e=0;if(o.forEach((t=>{this.outbound.get(t)&&e++})),e<r){Pp(p,r-e,(e=>!0===this.outbound.get(e))).forEach((e=>{g(e,Cp.Outbound)}))}}if(this.heartbeatTicks%this.opts.opportunisticGraftTicks==0&&o.size>1){const e=Array.from(o).sort(((e,t)=>a(e)-a(t))),t=Math.floor(o.size/2),n=a(e[t]);if(n<this.opts.scoreThresholds.opportunisticGraftThreshold){const e=Pp(p,this.opts.opportunisticGraftPeers,(e=>a(e)>n));for(const t of e)this.log("HEARTBEAT: Opportunistically graft peer %s on topic %s",t,i),g(t,Cp.Opportunistic)}}}));const h=Date.now();this.fanoutLastpub.forEach(((e,t)=>{e+o<h&&(this.fanout.delete(t),this.fanoutLastpub.delete(t))})),this.fanout.forEach(((t,n)=>{const s=this.topics.get(n);t.forEach((e=>{(!s.has(e)||a(e)<this.opts.scoreThresholds.publishThreshold)&&t.delete(e)}));const r=this.topics.get(n),o=[],i=new Set;if(u.set(n,i),r){const e=ap(Array.from(r));for(const n of e){const e=this.streamsOutbound.get(n);if(e&&this.multicodecs.includes(e.protocol)&&!t.has(n)&&!this.direct.has(n)){const e=a(n);e>=this.opts.scoreThresholds.publishThreshold&&o.push(n),e>=this.opts.scoreThresholds.gossipThreshold&&i.add(n)}}}if(t.size<e){const n=e-t.size;o.slice(0,n).forEach((e=>{t.add(e),i?.delete(e)}))}})),this.emitGossip(u),await this.sendGraftPrune(c,l,d),this.flush(),this.mcache.shift(),this.dispatchEvent(new Zh.u("gossipsub:heartbeat"))}getRandomGossipPeers(e,t,n=(()=>!0)){const s=this.topics.get(e);if(!s)return new Set;let r=[];return s.forEach((e=>{const t=this.streamsOutbound.get(e);t&&this.multicodecs.includes(t.protocol)&&n(e)&&r.push(e)})),r=ap(r),t>0&&r.length>t&&(r=r.slice(0,t)),new Set(r)}onScrapeMetrics(e){e.mcacheSize.set(this.mcache.size),e.mcacheNotValidatedCount.set(this.mcache.notValidatedCount),e.cacheSize.set({cache:"direct"},this.direct.size),e.cacheSize.set({cache:"seenCache"},this.seenCache.size),e.cacheSize.set({cache:"fastMsgIdCache"},this.fastMsgIdCache?.size??0),e.cacheSize.set({cache:"publishedMessageIds"},this.publishedMessageIds.size),e.cacheSize.set({cache:"mcache"},this.mcache.size),e.cacheSize.set({cache:"score"},this.score.size),e.cacheSize.set({cache:"gossipTracer.promises"},this.gossipTracer.size),e.cacheSize.set({cache:"gossipTracer.requests"},this.gossipTracer.requestMsByMsgSize),e.cacheSize.set({cache:"topics"},this.topics.size),e.cacheSize.set({cache:"subscriptions"},this.subscriptions.size),e.cacheSize.set({cache:"mesh"},this.mesh.size),e.cacheSize.set({cache:"fanout"},this.fanout.size),e.cacheSize.set({cache:"peers"},this.peers.size),e.cacheSize.set({cache:"streamsOutbound"},this.streamsOutbound.size),e.cacheSize.set({cache:"streamsInbound"},this.streamsInbound.size),e.cacheSize.set({cache:"acceptFromWhitelist"},this.acceptFromWhitelist.size),e.cacheSize.set({cache:"gossip"},this.gossip.size),e.cacheSize.set({cache:"control"},this.control.size),e.cacheSize.set({cache:"peerhave"},this.peerhave.size),e.cacheSize.set({cache:"outbound"},this.outbound.size);let t=0;for(const e of this.backoff.values())t+=e.size;e.cacheSize.set({cache:"backoff"},t);for(const[t,n]of this.topics)e.topicPeersCount.set({topicStr:t},n.size);for(const[t,n]of this.mesh)e.meshPeerCounts.set({topicStr:t},n.size);const n=[],s=new Map;e.behaviourPenalty.reset();for(const t of this.peers.keys()){const r=this.score.score(t);n.push(r),s.set(t,r),e.behaviourPenalty.observe(this.score.peerStats.get(t)?.behaviourPenalty??0)}e.registerScores(n,this.opts.scoreThresholds),e.registerScorePerMesh(this.mesh,s);const r=function(e,t,n,s,r){const o={byTopic:new Map,p5w:[],p6w:[],p7w:[],score:[]};for(const i of e){const e=t.get(i);if(e){const t=Kp(i,e,n,s,r);for(const[e,n]of t.byTopic){let t=o.byTopic.get(e);t||(t={p1w:[],p2w:[],p3w:[],p3bw:[],p4w:[]},o.byTopic.set(e,t)),t.p1w.push(n.p1w),t.p2w.push(n.p2w),t.p3w.push(n.p3w),t.p3bw.push(n.p3bw),t.p4w.push(n.p4w)}o.p5w.push(t.p5w),o.p6w.push(t.p6w),o.p7w.push(t.p7w),o.score.push(t.score)}else o.p5w.push(0),o.p6w.push(0),o.p7w.push(0),o.score.push(0)}return o}(this.peers.keys(),this.score.peerStats,this.score.params,this.score.peerIPs,e.topicStrToLabel);e.registerScoreWeights(r)}}function Pf(e={}){return t=>new If(t,e)}If.multicodec=op;const Af=()=>({gossipsub:Pf({fallbackToFloodsub:!0,emitSelf:!0,maxInboundStreams:64,maxOutboundStreams:128})});var Df=n(34905),Of=n(2122),Nf=n(46990),Lf=n(26425),Mf=n(74322),Cf=n(59246),xf=n(87144);const Bf=(0,a.vF)("ipfs-http-client:lib:error-handler"),zf=o.A.bind({ignoreUndefined:!0}),Uf=i.isBrowser||i.isWebWorker?location.protocol:"http",Ff=i.isBrowser||i.isWebWorker?location.hostname:"localhost",jf=i.isBrowser||i.isWebWorker?location.port:"5001",Hf=async e=>{let t;try{if((e.headers.get("Content-Type")||"").startsWith("application/json")){const n=await e.json();Bf(n),t=n.Message||n.message}else t=await e.text()}catch(e){Bf("Failed to parse error response",e),t=e.message}let n=new xt.HTTPError(e);throw t&&(t.includes("deadline has elapsed")&&(n=new xt.TimeoutError),t&&t.includes("context deadline exceeded")&&(n=new xt.TimeoutError)),t&&t.includes("request timed out")&&(n=new xt.TimeoutError),t&&(n.message=t),n},$f=/[A-Z\u00C0-\u00D6\u00D8-\u00DE]/g,Vf=e=>e.replace($f,(function(e){return"-"+e.toLowerCase()}));class Kf extends xt{constructor(e={}){const t=((e={})=>{let t,n,s={};if("string"==typeof e||(0,j.R8)(e))t=new URL((0,Cf.O)(e));else if(e instanceof URL)t=e;else if("string"==typeof e.url||(0,j.R8)(e.url))t=new URL((0,Cf.O)(e.url)),s=e;else if(e.url instanceof URL)t=e.url,s=e;else{s=e||{};const n=(s.protocol||Uf).replace(":",""),r=(s.host||Ff).split(":")[0],o=s.port||jf;t=new URL(`${n}://${r}:${o}`)}if(s.apiPath?t.pathname=s.apiPath:"/"!==t.pathname&&void 0!==t.pathname||(t.pathname="api/v0"),i.isNode){const e=(0,xf.A)(t);n=s.agent||new e({keepAlive:!0,maxSockets:6})}return{...s,host:t.host,protocol:t.protocol.replace(":",""),port:Number(t.port),apiPath:t.pathname,url:t,agent:n}})(e);var n;super({timeout:(n=t.timeout||0,("string"==typeof n?(0,Et.A)(n):n)||void 0),headers:t.headers,base:`${t.url}`,handleError:Hf,transformSearchParams:e=>{const t=new URLSearchParams;for(const[n,s]of e)"undefined"!==s&&"null"!==s&&"signal"!==n&&t.append(Vf(n),s),"timeout"!==n||isNaN(s)||t.append(Vf(n),s);return t},agent:t.agent}),delete this.get,delete this.put,delete this.delete,delete this.options;const s=this.fetch;this.fetch=(e,n={})=>("string"!=typeof e||e.startsWith("/")||(e=`${t.url}/${e}`),s.call(this,e,zf(n,{method:"POST"})))}}xt.HTTPError;const qf=e=>t=>e(new Kf(t),t);function Gf(e){if(null!=e)return"string"==typeof e?e:e.toString(8).padStart(4,"0")}function Wf(e){if(null==e)return;let t;if(null!=e.secs&&(t={secs:e.secs,nsecs:e.nsecs}),null!=e.Seconds&&(t={secs:e.Seconds,nsecs:e.FractionalNanoseconds}),Array.isArray(e)&&(t={secs:e[0],nsecs:e[1]}),e instanceof Date){const n=e.getTime(),s=Math.floor(n/1e3);t={secs:s,nsecs:1e3*(n-1e3*s)}}if(Object.prototype.hasOwnProperty.call(t,"secs")){if(null!=t&&null!=t.nsecs&&(t.nsecs<0||t.nsecs>999999999))throw c(new Error("mtime-nsecs must be within the range [0,999999999]"),"ERR_INVALID_MTIME_NSECS");return t}}function Yf({arg:e,searchParams:t,hashAlg:n,mtime:s,mode:r,...o}={}){t&&(o={...o,...t}),n&&(o.hash=n),null!=s&&(s=Wf(s),o.mtime=s.secs,o.mtimeNsecs=s.nsecs),null!=r&&(o.mode=Gf(r)),o.timeout&&!isNaN(o.timeout)&&(o.timeout=`${o.timeout}ms`),null==e?e=[]:Array.isArray(e)||(e=[e]);const i=new URLSearchParams(o);return e.forEach((e=>i.append("arg",e))),i}const Xf=qf((e=>async function(t={}){return((await(await e.post("bitswap/wantlist",{signal:t.signal,searchParams:Yf(t),headers:t.headers})).json()).Keys||[]).map((e=>J.TO.parse(e["/"])))})),Qf=qf((e=>async function(t,n={}){return((await(await e.post("bitswap/wantlist",{signal:n.signal,searchParams:Yf({...n,peer:t.toString()}),headers:n.headers})).json()).Keys||[]).map((e=>J.TO.parse(e["/"])))})),Jf=qf((e=>async function(t={}){const n=await e.post("bitswap/stat",{searchParams:Yf(t),signal:t.signal,headers:t.headers});return function(e){return{provideBufLen:e.ProvideBufLen,wantlist:(e.Wantlist||[]).map((e=>J.TO.parse(e["/"]))),peers:(e.Peers||[]).map((e=>(0,Ht.XL)(e))),blocksReceived:BigInt(e.BlocksReceived),dataReceived:BigInt(e.DataReceived),blocksSent:BigInt(e.BlocksSent),dataSent:BigInt(e.DataSent),dupBlksReceived:BigInt(e.DupBlksReceived),dupDataReceived:BigInt(e.DupDataReceived)}}(await n.json())}));const Zf=qf((e=>async function(t,n={}){return(await e.post("bitswap/unwant",{signal:n.signal,searchParams:Yf({arg:t.toString(),...n}),headers:n.headers})).json()}));function ey(e){return{wantlist:Xf(e),wantlistForPeer:Qf(e),unwant:Zf(e),stat:Jf(e)}}const ty=qf((e=>async function(t,n={}){const s=await e.post("block/get",{signal:n.signal,searchParams:Yf({arg:t.toString(),...n}),headers:n.headers});return new Uint8Array(await s.arrayBuffer())}));var ny=n(96091);function sy(...e){return(0,_t.anySignal)(function(e){return e.filter(Boolean)}(e))}const ry=qf((e=>async function t(n,s={}){const r=new AbortController,o=sy(r.signal,s.signal);let i;try{const t=await e.post("block/put",{signal:o,searchParams:Yf(s),...await(0,ny.e)([n],r,s.headers)});i=await t.json()}catch(e){if("dag-pb"===s.format)return t(n,{...s,format:"protobuf"});if("dag-cbor"===s.format)return t(n,{...s,format:"cbor"});throw e}return J.TO.parse(i.Key)})),oy=qf((e=>async function*(t,n={}){Array.isArray(t)||(t=[t]);const s=await e.post("block/rm",{signal:n.signal,searchParams:Yf({arg:t.map((e=>e.toString())),"stream-channels":!0,...n}),headers:n.headers});for await(const e of s.ndjson())yield iy(e)}));function iy(e){const t={cid:J.TO.parse(e.Hash)};return e.Error&&(t.error=new Error(e.Error)),t}const ay=qf((e=>async function(t,n={}){const s=await e.post("block/stat",{signal:n.signal,searchParams:Yf({arg:t.toString(),...n}),headers:n.headers}),r=await s.json();return{cid:J.TO.parse(r.Key),size:r.Size}}));function cy(e){return{get:ty(e),put:ry(e),rm:oy(e),stat:ay(e)}}const ly=qf((e=>async function(t,n={}){const s=await e.post("bootstrap/add",{signal:n.signal,searchParams:Yf({arg:t,...n}),headers:n.headers}),{Peers:r}=await s.json();return{Peers:r.map((e=>(0,j.HZ)(e)))}})),dy=qf((e=>async function(t={}){const n=await e.post("bootstrap/rm",{signal:t.signal,searchParams:Yf({...t,all:!0}),headers:t.headers}),{Peers:s}=await n.json();return{Peers:s.map((e=>(0,j.HZ)(e)))}})),uy=qf((e=>async function(t={}){const n=await e.post("bootstrap/list",{signal:t.signal,searchParams:Yf(t),headers:t.headers}),{Peers:s}=await n.json();return{Peers:s.map((e=>(0,j.HZ)(e)))}})),hy=qf((e=>async function(t={}){const n=await e.post("bootstrap/add",{signal:t.signal,searchParams:Yf({...t,default:!0}),headers:t.headers}),{Peers:s}=await n.json();return{Peers:s.map((e=>(0,j.HZ)(e)))}})),py=qf((e=>async function(t,n={}){const s=await e.post("bootstrap/rm",{signal:n.signal,searchParams:Yf({arg:t,...n}),headers:n.headers}),{Peers:r}=await s.json();return{Peers:r.map((e=>(0,j.HZ)(e)))}}));function fy(e){return{add:ly(e),clear:dy(e),list:uy(e),reset:hy(e),rm:py(e)}}const yy=qf((e=>async function(t,n={}){const s=await e.post("config/profile/apply",{signal:n.signal,searchParams:Yf({arg:t,...n}),headers:n.headers}),r=await s.json();return{original:r.OldCfg,updated:r.NewCfg}}));function gy(e){if(null==e)return e;const t=/^[A-Z]+$/;return Object.keys(e).reduce(((n,s)=>(t.test(s)?n[s.toLowerCase()]=e[s]:t.test(s[0])?n[s[0].toLowerCase()+s.slice(1)]=e[s]:n[s]=e[s],n)),{})}const my=qf((e=>async function(t={}){const n=await e.post("config/profile/list",{signal:t.signal,searchParams:Yf(t),headers:t.headers});return(await n.json()).map((e=>gy(e)))}));function wy(e){return{apply:yy(e),list:my(e)}}const by=qf((e=>async(t,n={})=>{if(!t)throw new Error("key argument is required");const s=await e.post("config",{signal:n.signal,searchParams:Yf({arg:t,...n}),headers:n.headers});return(await s.json()).Value})),_y=qf((e=>async(t={})=>{const n=await e.post("config/show",{signal:t.signal,searchParams:Yf({...t}),headers:t.headers});return await n.json()})),Ey=qf((e=>async(t,n={})=>{const s=new AbortController,r=sy(s.signal,n.signal),o=await e.post("config/replace",{signal:r,searchParams:Yf(n),...await(0,ny.e)([(0,x.s)(JSON.stringify(t))],s,n.headers)});await o.text()})),vy=qf((e=>async(t,n,s={})=>{if("string"!=typeof t)throw new Error("Invalid key type");const r={...s,...Sy(t,n)},o=await e.post("config",{signal:s.signal,searchParams:Yf(r),headers:s.headers});await o.text()})),Sy=(e,t)=>{switch(typeof t){case"boolean":return{arg:[e,t.toString()],bool:!0};case"string":return{arg:[e,t]};default:return{arg:[e,JSON.stringify(t)],json:!0}}};function ky(e){return{getAll:_y(e),get:by(e),set:vy(e),replace:Ey(e),profiles:wy(e)}}const Ry=qf((e=>async function*(t,n={}){const s=await e.post("dag/export",{signal:n.signal,searchParams:Yf({arg:t.toString()}),headers:n.headers});yield*s.iterator()}));async function*Ty(e,t,n,s,r){const o=async e=>{const t=await n.getCodec(e.code),o=await s(e,r);return t.decode(o)},i=t.split("/").filter(Boolean);let a=await o(e),l=e;for(;i.length;){const e=i.shift();if(!e)throw c(new Error(`Could not resolve path "${t}"`),"ERR_INVALID_PATH");if(!Object.prototype.hasOwnProperty.call(a,e))throw c(new Error(`no link named "${e}" under ${l}`),"ERR_NO_LINK");a=a[e],yield{value:a,remainderPath:i.join("/")};const n=J.TO.asCID(a);n&&(l=n,a=await o(a))}yield{value:a,remainderPath:""}}const Iy=(e,t)=>{const n=qf(((t,n)=>{const s=ty(n);return async(t,n={})=>{if(n.path){const r=n.localResolve?await(0,sc.A)(Ty(t,n.path,e,s,n)):await(0,Vt.A)(Ty(t,n.path,e,s,n));if(!r)throw c(new Error("Not found"),"ERR_NOT_FOUND");return r}const r=await e.getCodec(t.code),o=await s(t,n);return{value:r.decode(o),remainderPath:""}}}));return n(t)},Py=qf((e=>async function*(t,n={}){const s=new AbortController,r=sy(s.signal,n.signal),{headers:o,body:i}=await(0,ny.e)(t,s,n.headers),a=await e.post("dag/import",{signal:r,headers:o,body:i,searchParams:Yf({"pin-roots":n.pinRoots})});for await(const{Root:e}of a.ndjson())if(void 0!==e){const{Cid:{"/":t},PinErrorMsg:n}=e;yield{root:{cid:J.TO.parse(t),pinErrorMsg:n}}}})),Ay=(e,t)=>{const n=qf((t=>async(n,s={})=>{const r={storeCodec:"dag-cbor",hashAlg:"sha2-256",...s};let o;if(r.inputCodec){if(!(n instanceof Uint8Array))throw new Error("Can only inputCodec on raw bytes that can be decoded");o=n}else{o=(await e.getCodec(r.storeCodec)).encode(n),r.inputCodec=r.storeCodec}const i=new AbortController,a=sy(i.signal,r.signal),c=await t.post("dag/put",{timeout:r.timeout,signal:a,searchParams:Yf(r),...await(0,ny.e)([o],i,r.headers)}),l=await c.json();return J.TO.parse(l.Cid["/"])}));return n(t)},Dy=qf((e=>async(t,n={})=>{const s=await e.post("dag/resolve",{signal:n.signal,searchParams:Yf({arg:`${t}${n.path?`/${n.path}`.replace(/\/[/]+/g,"/"):""}`,...n}),headers:n.headers}),r=await s.json();return{cid:J.TO.parse(r.Cid["/"]),remainderPath:r.RemPath}}));function Oy(e,t){return{export:Ry(t),get:Iy(e,t),import:Py(t),put:Ay(e,t),resolve:Dy(t)}}const Ny=e=>{if(0===e.Type)return{name:"SENDING_QUERY",type:e.Type};if(1===e.Type)return{from:(0,Ht.XL)(e.ID),name:"PEER_RESPONSE",type:e.Type,messageType:0,messageName:"PUT_VALUE",closer:(e.Responses||[]).map((({ID:e,Addrs:t})=>({id:(0,Ht.XL)(e),multiaddrs:t.map((e=>(0,j.HZ)(e))),protocols:[]}))),providers:(e.Responses||[]).map((({ID:e,Addrs:t})=>({id:(0,Ht.XL)(e),multiaddrs:t.map((e=>(0,j.HZ)(e))),protocols:[]})))};if(2===e.Type){let t={id:e.ID??(0,Ht.XL)(e.ID),multiaddrs:[],protocols:[]};return e.Responses&&e.Responses.length&&(t={id:(0,Ht.XL)(e.Responses[0].ID),multiaddrs:e.Responses[0].Addrs.map((e=>(0,j.HZ)(e))),protocols:[]}),{name:"FINAL_PEER",type:e.Type,peer:t}}if(3===e.Type)return{name:"QUERY_ERROR",type:e.Type,error:new Error(e.Extra)};if(4===e.Type)return{name:"PROVIDER",type:e.Type,providers:e.Responses.map((({ID:e,Addrs:t})=>({id:(0,Ht.XL)(e),multiaddrs:t.map((e=>(0,j.HZ)(e))),protocols:[]})))};if(5===e.Type)return{name:"VALUE",type:e.Type,value:(0,x.s)(e.Extra,"base64pad")};if(6===e.Type){const t=e.Responses.map((({ID:e})=>(0,Ht.XL)(e)));if(!t.length)throw new Error("No peer found");return{name:"ADDING_PEER",type:e.Type,peer:t[0]}}if(7===e.Type)return{name:"DIALING_PEER",type:e.Type,peer:(0,Ht.XL)(e.ID)};throw new Error("Unknown DHT event type")},Ly=qf((e=>async function*(t,n={}){const s=await e.post("dht/findpeer",{signal:n.signal,searchParams:Yf({arg:t,...n}),headers:n.headers});for await(const e of s.ndjson())yield Ny(e)})),My=qf((e=>async function*(t,n={}){const s=await e.post("dht/findprovs",{signal:n.signal,searchParams:Yf({arg:t.toString(),...n}),headers:n.headers});for await(const e of s.ndjson())yield Ny(e)})),Cy=qf((e=>async function*(t,n={}){const s=await e.post("dht/get",{signal:n.signal,searchParams:Yf({arg:t instanceof Uint8Array?(0,$.d)(t):t.toString(),...n}),headers:n.headers});for await(const e of s.ndjson())yield Ny(e)})),xy=qf((e=>async function*(t,n={recursive:!1}){const s=Array.isArray(t)?t:[t],r=await e.post("dht/provide",{signal:n.signal,searchParams:Yf({arg:s.map((e=>e.toString())),...n}),headers:n.headers});for await(const e of r.ndjson())yield Ny(e)})),By=qf((e=>async function*(t,n,s={}){const r=new AbortController,o=sy(r.signal,s.signal),i=await e.post("dht/put",{signal:o,searchParams:Yf({arg:t instanceof Uint8Array?(0,$.d)(t):t.toString(),...s}),...await(0,ny.e)([n],r,s.headers)});for await(const e of i.ndjson())yield Ny(e)})),zy=qf((e=>async function*(t,n={}){const s=await e.post("dht/query",{signal:n.signal,searchParams:Yf({arg:t.toString(),...n}),headers:n.headers});for await(const e of s.ndjson())yield Ny(e)}));function Uy(e){return{findPeer:Ly(e),findProvs:My(e),get:Cy(e),provide:xy(e),put:By(e),query:zy(e)}}const Fy=qf((e=>async function(t={}){return(await e.post("diag/cmds",{signal:t.signal,searchParams:Yf(t),headers:t.headers})).json()})),jy=qf((e=>async function(t={}){return(await e.post("diag/net",{signal:t.signal,searchParams:Yf(t),headers:t.headers})).json()})),Hy=qf((e=>async function(t={}){return(await e.post("diag/sys",{signal:t.signal,searchParams:Yf(t),headers:t.headers})).json()}));function $y(e){return{cmds:Fy(e),net:jy(e),sys:Hy(e)}}const Vy=qf((e=>async function(t,n,s={}){const r=await e.post("files/chmod",{signal:s.signal,searchParams:Yf({arg:t,mode:n,...s}),headers:s.headers});await r.text()})),Ky=qf((e=>async function(t,n,s={}){const r=Array.isArray(t)?t:[t],o=await e.post("files/cp",{signal:s.signal,searchParams:Yf({arg:r.concat(n).map((e=>J.TO.asCID(e)?`/ipfs/${e}`:e)),...s}),headers:s.headers});await o.text()})),qy=qf((e=>async function(t,n={}){if(!t||"string"!=typeof t)throw new Error("ipfs.files.flush requires a path");const s=await e.post("files/flush",{signal:n.signal,searchParams:Yf({arg:t,...n}),headers:n.headers}),r=await s.json();return J.TO.parse(r.Cid)}));function Gy(e){const t=gy(e);return Object.prototype.hasOwnProperty.call(t,"mode")&&(t.mode=parseInt(t.mode,8)),Object.prototype.hasOwnProperty.call(t,"mtime")&&(t.mtime={secs:t.mtime,nsecs:t.mtimeNsecs||0},delete t.mtimeNsecs),t}const Wy=qf((e=>async function*(t,n={}){if(!t)throw new Error("ipfs.files.ls requires a path");const s=await e.post("files/ls",{signal:n.signal,searchParams:Yf({arg:J.TO.asCID(t)?`/ipfs/${t}`:t,long:!0,...n,stream:!0}),headers:n.headers});for await(const e of s.ndjson())if("Entries"in e)for(const t of e.Entries||[])yield Yy(Gy(t));else yield Yy(Gy(e))}));function Yy(e){return e.hash&&(e.cid=J.TO.parse(e.hash)),delete e.hash,e.type=1===e.type?"directory":"file",e}const Xy=qf((e=>async function(t,n={}){const s=await e.post("files/mkdir",{signal:n.signal,searchParams:Yf({arg:t,...n}),headers:n.headers});await s.text()})),Qy=qf((e=>async function(t,n,s={}){Array.isArray(t)||(t=[t]);const r=await e.post("files/mv",{signal:s.signal,searchParams:Yf({arg:t.concat(n),...s}),headers:s.headers});await r.text()}));var Jy=n(98844);const Zy=qf((e=>async function*(t,n={}){const s=await e.post("files/read",{signal:n.signal,searchParams:Yf({arg:t,count:n.length,...n}),headers:n.headers});yield*Jy(s.body)})),eg=qf((e=>async function(t,n={}){const s=await e.post("files/rm",{signal:n.signal,searchParams:Yf({arg:t,...n}),headers:n.headers}),r=await s.text();if(""!==r){const e=new xt.HTTPError(s);throw e.message=r,e}})),tg=qf((e=>async function(t,n={}){const s=await e.post("files/stat",{signal:n.signal,searchParams:Yf({arg:t,...n}),headers:n.headers}),r=await s.json();return r.WithLocality=r.WithLocality||!1,(o=Gy(r)).cid=J.TO.parse(o.hash),delete o.hash,o;var o}));const ng=qf((e=>async function(t,n={}){const s=await e.post("files/touch",{signal:n.signal,searchParams:Yf({arg:t,...n}),headers:n.headers});await s.text()})),sg=qf((e=>async function(t,n,s={}){const r=new AbortController,o=sy(r.signal,s.signal),i=await e.post("files/write",{signal:o,searchParams:Yf({arg:t,streamChannels:!0,count:s.length,...s}),...await(0,ny.e)([{content:n,path:"arg",mode:Gf(s.mode),mtime:Wf(s.mtime)}],r,s.headers)});await i.text()}));function rg(e){return{chmod:Vy(e),cp:Ky(e),flush:qy(e),ls:Wy(e),mkdir:Xy(e),mv:Qy(e),read:Zy(e),rm:eg(e),stat:tg(e),touch:ng(e),write:sg(e)}}const og=qf((e=>async(e,t,n={})=>{throw c(new Error("Not implemented"),"ERR_NOT_IMPLEMENTED")})),ig=qf((e=>async function(t,n){const s=n??{type:"Ed25519"},r=await e.post("key/gen",{signal:s.signal,searchParams:Yf({arg:t,...s}),headers:s.headers});return gy(await r.json())})),ag=qf((e=>async function(t,n,s,r={}){const o=await e.post("key/import",{signal:r.signal,searchParams:Yf({arg:t,pem:n,password:s,...r}),headers:r.headers});return gy(await o.json())})),cg=qf((e=>async(e,t={})=>{throw c(new Error("Not implemented"),"ERR_NOT_IMPLEMENTED")})),lg=qf((e=>async function(t={}){const n=await e.post("key/list",{signal:t.signal,searchParams:Yf(t),headers:t.headers});return((await n.json()).Keys||[]).map((e=>gy(e)))})),dg=qf((e=>async function(t,n,s={}){const r=await e.post("key/rename",{signal:s.signal,searchParams:Yf({arg:[t,n],...s}),headers:s.headers});return gy(await r.json())})),ug=qf((e=>async function(t,n={}){const s=await e.post("key/rm",{signal:n.signal,searchParams:Yf({arg:t,...n}),headers:n.headers});return gy((await s.json()).Keys[0])}));function hg(e){return{export:og(e),gen:ig(e),import:ag(e),info:cg(e),list:lg(e),rename:dg(e),rm:ug(e)}}const pg=qf((e=>async function(t,n,s={}){const r=await e.post("log/level",{signal:s.signal,searchParams:Yf({arg:[t,n],...s}),headers:s.headers});return gy(await r.json())})),fg=qf((e=>async function(t={}){const n=await e.post("log/ls",{signal:t.signal,searchParams:Yf(t),headers:t.headers});return(await n.json()).Strings})),yg=qf((e=>async function*(t={}){const n=await e.post("log/tail",{signal:t.signal,searchParams:Yf(t),headers:t.headers});yield*n.ndjson()}));function gg(e){return{level:pg(e),ls:fg(e),tail:yg(e)}}const mg=qf((e=>async function(t,n={}){const s=await e.post("name/publish",{signal:n.signal,searchParams:Yf({arg:`${t}`,...n}),headers:n.headers});return gy(await s.json())})),wg=qf((e=>async function*(t,n={}){const s=await e.post("name/resolve",{signal:n.signal,searchParams:Yf({arg:t,stream:!0,...n}),headers:n.headers});for await(const e of s.ndjson())yield e.Path})),bg=qf((e=>async function(t,n={}){const s=await e.post("name/pubsub/cancel",{signal:n.signal,searchParams:Yf({arg:t,...n}),headers:n.headers});return gy(await s.json())})),_g=qf((e=>async function(t={}){const n=await e.post("name/pubsub/state",{signal:t.signal,searchParams:Yf(t),headers:t.headers});return gy(await n.json())})),Eg=qf((e=>async function(t={}){const n=await e.post("name/pubsub/subs",{signal:t.signal,searchParams:Yf(t),headers:t.headers});return(await n.json()).Strings||[]}));function vg(e){return{cancel:bg(e),state:_g(e),subs:Eg(e)}}function Sg(e){return{publish:mg(e),resolve:wg(e),pubsub:vg(e)}}const kg=qf((e=>async function(t,n={}){const s=await e.post("object/data",{signal:n.signal,searchParams:Yf({arg:`${t instanceof Uint8Array?J.TO.decode(t):t}`,...n}),headers:n.headers}),r=await s.arrayBuffer();return new Uint8Array(r,0,r.byteLength)})),Rg=qf((e=>async function(t,n={}){const s=await e.post("object/get",{signal:n.signal,searchParams:Yf({arg:`${t instanceof Uint8Array?J.TO.decode(t):t}`,dataEncoding:"base64",...n}),headers:n.headers}),r=await s.json();return{Data:(0,x.s)(r.Data,"base64pad"),Links:(r.Links||[]).map((e=>({Name:e.Name,Hash:J.TO.parse(e.Hash),Tsize:e.Size})))}})),Tg=qf((e=>async function(t,n={}){const s=await e.post("object/links",{signal:n.signal,searchParams:Yf({arg:`${t instanceof Uint8Array?J.TO.decode(t):t}`,...n}),headers:n.headers});return((await s.json()).Links||[]).map((e=>({Name:e.Name,Tsize:e.Size,Hash:J.TO.parse(e.Hash)})))})),Ig=qf((e=>async function(t={}){const n=await e.post("object/new",{signal:t.signal,searchParams:Yf({arg:t.template,...t}),headers:t.headers}),{Hash:s}=await n.json();return J.TO.parse(s)})),Pg=(e,t)=>{const n=qf((n=>{const s=Ay(e,t);return async function(e,t={}){return s(e,{...t,storeCodec:"dag-pb",hashAlg:"sha2-256",version:1})}}));return n(t)},Ag=qf((e=>async function(t,n={}){const s=await e.post("object/stat",{signal:n.signal,searchParams:Yf({arg:`${t}`,...n}),headers:n.headers}),r=await s.json();return{...r,Hash:J.TO.parse(r.Hash)}})),Dg=qf((e=>async function(t,n,s={}){const r=await e.post("object/patch/add-link",{signal:s.signal,searchParams:Yf({arg:[`${t}`,n.Name||n.name||"",(n.Hash||n.cid||"").toString()||null],...s}),headers:s.headers}),{Hash:o}=await r.json();return J.TO.parse(o)})),Og=qf((e=>async function(t,n,s={}){const r=new AbortController,o=sy(r.signal,s.signal),i=await e.post("object/patch/append-data",{signal:o,searchParams:Yf({arg:`${t}`,...s}),...await(0,ny.e)([n],r,s.headers)}),{Hash:a}=await i.json();return J.TO.parse(a)})),Ng=qf((e=>async function(t,n,s={}){const r=await e.post("object/patch/rm-link",{signal:s.signal,searchParams:Yf({arg:[`${t}`,n.Name||n.name||null],...s}),headers:s.headers}),{Hash:o}=await r.json();return J.TO.parse(o)})),Lg=qf((e=>async function(t,n,s={}){const r=new AbortController,o=sy(r.signal,s.signal),i=await e.post("object/patch/set-data",{signal:o,searchParams:Yf({arg:[`${t}`],...s}),...await(0,ny.e)([n],r,s.headers)}),{Hash:a}=await i.json();return J.TO.parse(a)}));function Mg(e){return{addLink:Dg(e),appendData:Og(e),rmLink:Ng(e),setData:Lg(e)}}function Cg(e,t){return{data:kg(t),get:Rg(t),links:Tg(t),new:Ig(t),put:Pg(e,t),stat:Ag(t),patch:Mg(t)}}const xg=qf((e=>async function*(t,n={}){for await(const{path:s,recursive:r,metadata:o}of(0,Kt.n)(t)){const t=await e.post("pin/add",{signal:n.signal,searchParams:Yf({...n,arg:s,recursive:r,metadata:o?JSON.stringify(o):void 0,stream:!0}),headers:n.headers});for await(const e of t.ndjson())if(e.Pins)for(const t of e.Pins)yield J.TO.parse(t);else yield J.TO.parse(e)}}));function Bg(e){const t=xg(e);return qf((()=>async function(e,n={}){return(0,Vt.A)(t([{path:e,...n}],n))}))(e)}function zg(e,t,n){const s={type:e,cid:J.TO.parse(t)};return n&&(s.metadata=n),s}const Ug=qf((e=>async function*(t={}){let n=[];t.paths&&(n=Array.isArray(t.paths)?t.paths:[t.paths]);const s=await e.post("pin/ls",{signal:t.signal,searchParams:Yf({...t,arg:n.map((e=>`${e}`)),stream:!0}),headers:t.headers});for await(const e of s.ndjson()){if(e.Keys){for(const t of Object.keys(e.Keys))yield zg(e.Keys[t].Type,t,e.Keys[t].Metadata);return}yield zg(e.Type,e.Cid,e.Metadata)}})),Fg=qf((e=>async function*(t,n={}){for await(const{path:s,recursive:r}of(0,Kt.n)(t)){const t=new URLSearchParams(n.searchParams);t.append("arg",`${s}`),null!=r&&t.set("recursive",String(r));const o=await e.post("pin/rm",{signal:n.signal,headers:n.headers,searchParams:Yf({...n,arg:`${s}`,recursive:r})});for await(const e of o.ndjson())e.Pins?yield*e.Pins.map((e=>J.TO.parse(e))):yield J.TO.parse(e)}})),jg=e=>{const t=Fg(e);return qf((()=>async function(e,n={}){return(0,Vt.A)(t([{path:e,...n}],n))}))(e)},Hg=({Name:e,Status:t,Cid:n})=>({cid:J.TO.parse(n),name:e,status:t}),$g=e=>{if("string"==typeof e&&""!==e)return e;throw new TypeError("service name must be passed")},Vg=e=>{if(J.TO.asCID(e))return e.toString();throw new TypeError("CID instance expected instead of "+typeof e)},Kg=({service:e,cid:t,name:n,status:s,all:r})=>{const o=Yf({service:$g(e),name:n,force:!!r||void 0});if(t)for(const e of t)o.append("cid",Vg(e));if(s)for(const e of s)o.append("status",e);return o},qg=({cid:e,service:t,background:n,name:s,origins:r})=>{const o=Yf({arg:Vg(e),service:$g(t),name:s,background:!!n||void 0});if(r)for(const e of r)o.append("origin",e.toString());return o};function Gg(e){return async function(t,{timeout:n,signal:s,headers:r,...o}){const i=await e.post("pin/remote/add",{timeout:n,signal:s,headers:r,searchParams:qg({cid:t,...o})});return Hg(await i.json())}}function Wg(e){return async function*({timeout:t,signal:n,headers:s,...r}){const o=await e.post("pin/remote/ls",{timeout:t,signal:n,headers:s,searchParams:Kg(r)});for await(const e of o.ndjson())yield Hg(e)}}function Yg(e){return async function({timeout:t,signal:n,headers:s,...r}){await e.post("pin/remote/rm",{timeout:t,signal:n,headers:s,searchParams:Kg({...r,all:!1})})}}function Xg(e){return async function({timeout:t,signal:n,headers:s,...r}){await e.post("pin/remote/rm",{timeout:t,signal:n,headers:s,searchParams:Kg({...r,all:!0})})}}function Qg(e){const t=String(e);if("undefined"===t)throw Error("endpoint is required");return"/"===t[t.length-1]?t.slice(0,-1):t}function Jg(e){return{service:e.Service,endpoint:new URL(e.ApiEndpoint),...e.Stat&&{stat:Zg(e.Stat)}}}function Zg(e){switch(e.Status){case"valid":{const{Pinning:t,Pinned:n,Queued:s,Failed:r}=e.PinCount;return{status:"valid",pinCount:{queued:s,pinning:t,pinned:n,failed:r}}}case"invalid":return{status:"invalid"};default:return{status:e.Status}}}function em(e){return async function(t,n){const{endpoint:s,key:r,headers:o,timeout:i,signal:a}=n;await e.post("pin/remote/service/add",{timeout:i,signal:a,searchParams:Yf({arg:[t,Qg(s),r]}),headers:o})}}function tm(e){return async function(t={}){const{stat:n,headers:s,timeout:r,signal:o}=t,i=await e.post("pin/remote/service/ls",{timeout:r,signal:o,headers:s,searchParams:!0===n?Yf({stat:n}):void 0}),{RemoteServices:a}=await i.json();return a.map(Jg)}}function nm(e){return async function(t,n={}){await e.post("pin/remote/service/rm",{signal:n.signal,headers:n.headers,searchParams:Yf({arg:t})})}}function sm(e){const t=new Kf(e);return{add:em(t),ls:tm(t),rm:nm(t)}}function rm(e){const t=new Kf(e);return{add:Gg(t),ls:Wg(t),rm:Yg(t),rmAll:Xg(t),service:sm(e)}}function om(e){return{addAll:xg(e),add:Bg(e),ls:Ug(e),rmAll:Fg(e),rm:jg(e),remote:rm(e)}}var im=n(34664);const am=e=>(0,$.d)(cm(e)),cm=e=>im.base64url.decode(e),lm=e=>BigInt(`0x${(0,$.d)(im.base64url.decode(e),"base16")}`),dm=e=>im.base64url.encode((0,x.s)(e)),um=qf((e=>async function(t={}){const{Strings:n}=await(await e.post("pubsub/ls",{signal:t.signal,searchParams:Yf(t),headers:t.headers})).json();return s=n,(Array.isArray(s)?s.map(am):s)||[];var s})),hm=qf((e=>async function(t,n={}){const s=await e.post("pubsub/peers",{signal:n.signal,searchParams:Yf({arg:dm(t),...n}),headers:n.headers}),{Strings:r}=await s.json();return r||[]})),pm=qf((e=>async function(t,n,s={}){const r=Yf({arg:dm(t),...s}),o=new AbortController,i=sy(o.signal,s.signal),a=await e.post("pubsub/pub",{signal:i,searchParams:r,...await(0,ny.e)([n],o,s.headers)});await a.text()})),fm=(0,a.vF)("ipfs-http-client:pubsub:subscribe"),ym=(e,t)=>qf((e=>async function(n,s,r={}){let o,i;r.signal=t.subscribe(n,s,r.signal);const a=new Promise(((e,t)=>{o=e,i=t})),c=setTimeout((()=>o()),1e3);return e.post("pubsub/sub",{signal:r.signal,searchParams:Yf({arg:dm(n),...r}),headers:r.headers}).catch((e=>{t.unsubscribe(n,s),i(e)})).then((e=>{clearTimeout(c),e&&(!async function(e,{onMessage:t,onEnd:n,onError:s}){s=s||fm;try{for await(const n of e.ndjson())try{if(!n.from)continue;null!=n.from&&null!=n.seqno?t({type:"signed",from:(0,Ht.XL)(n.from),data:cm(n.data),sequenceNumber:lm(n.seqno),topic:am(n.topicIDs[0]),key:cm(n.key??"u"),signature:cm(n.signature??"u")}):t({type:"unsigned",data:cm(n.data),topic:am(n.topicIDs[0])})}catch(e){e.message=`Failed to parse pubsub message: ${e.message}`,s(e,!1,n)}}catch(e){gm(e)||s(e,!0)}finally{n()}}(e,{onMessage:e=>{s&&("function"!=typeof s?"function"==typeof s.handleEvent&&s.handleEvent(e):s(e))},onEnd:()=>t.unsubscribe(n,s),onError:r.onError}),o())})),a}))(e);const gm=e=>{switch(e.type){case"aborted":case"abort":return!0;default:return"AbortError"===e.name}},mm=(e,t)=>async function(e,n){t.unsubscribe(e,n)};class wm{constructor(){this._subs=new Map}subscribe(e,t,n){const s=this._subs.get(e)||[];if(s.find((e=>e.handler===t)))throw new Error(`Already subscribed to ${e} with this handler`);const r=new AbortController;return this._subs.set(e,[{handler:t,controller:r}].concat(s)),n&&n.addEventListener("abort",(()=>this.unsubscribe(e,t))),r.signal}unsubscribe(e,t){const n=this._subs.get(e)||[];let s;t?(this._subs.set(e,n.filter((e=>e.handler!==t))),s=n.filter((e=>e.handler===t))):(this._subs.set(e,[]),s=n),(this._subs.get(e)||[]).length||this._subs.delete(e),s.forEach((e=>e.controller.abort()))}}function bm(e){const t=new wm;return{ls:um(e),peers:hm(e),publish:pm(e),subscribe:ym(e,t),unsubscribe:mm(e,t)}}const _m=qf((e=>async function*(t={}){const n=await e.post("refs/local",{signal:t.signal,transform:gy,searchParams:Yf(t),headers:t.headers});yield*n.ndjson()})),Em=qf(((e,t)=>Object.assign((async function*(t,n={}){const s=Array.isArray(t)?t:[t],r=await e.post("refs",{signal:n.signal,searchParams:Yf({arg:s.map((e=>`${e instanceof Uint8Array?J.TO.decode(e):e}`)),...n}),headers:n.headers,transform:gy});yield*r.ndjson()}),{local:_m(t)}))),vm=qf((e=>async function*(t={}){const n=await e.post("repo/gc",{signal:t.signal,searchParams:Yf(t),headers:t.headers,transform:e=>({err:e.Error?new Error(e.Error):null,cid:(e.Key||{})["/"]?J.TO.parse(e.Key["/"]):null})});yield*n.ndjson()})),Sm=qf((e=>async function(t={}){const n=await e.post("repo/stat",{signal:t.signal,searchParams:Yf(t),headers:t.headers}),s=await n.json();return{numObjects:BigInt(s.NumObjects),repoSize:BigInt(s.RepoSize),repoPath:s.RepoPath,version:s.Version,storageMax:BigInt(s.StorageMax)}})),km=qf((e=>async function(t={}){return(await(await e.post("repo/version",{signal:t.signal,searchParams:Yf(t),headers:t.headers})).json()).Version}));function Rm(e){return{gc:vm(e),stat:Sm(e),version:km(e)}}const Tm=qf((e=>async function*(t={}){const n=await e.post("stats/bw",{signal:t.signal,searchParams:Yf(t),headers:t.headers,transform:e=>({totalIn:BigInt(e.TotalIn),totalOut:BigInt(e.TotalOut),rateIn:parseFloat(e.RateIn),rateOut:parseFloat(e.RateOut)})});yield*n.ndjson()}));function Im(e){return{bitswap:Jf(e),repo:Sm(e),bw:Tm(e)}}const Pm=qf((e=>async function(t={}){const n=await e.post("swarm/addrs",{signal:t.signal,searchParams:Yf(t),headers:t.headers}),{Addrs:s}=await n.json();return Object.keys(s).map((e=>({id:(0,Ht.XL)(e),addrs:(s[e]||[]).map((e=>(0,j.HZ)(e)))})))})),Am=qf((e=>async function(t,n={}){const s=await e.post("swarm/connect",{signal:n.signal,searchParams:Yf({arg:t,...n}),headers:n.headers}),{Strings:r}=await s.json();return r||[]})),Dm=qf((e=>async function(t,n={}){const s=await e.post("swarm/disconnect",{signal:n.signal,searchParams:Yf({arg:t,...n}),headers:n.headers}),{Strings:r}=await s.json();return r||[]})),Om=qf((e=>async function(t={}){const n=await e.post("swarm/addrs/local",{signal:t.signal,searchParams:Yf(t),headers:t.headers}),{Strings:s}=await n.json();return(s||[]).map((e=>(0,j.HZ)(e)))})),Nm=qf((e=>async function(t={}){const n=await e.post("swarm/peers",{signal:t.signal,searchParams:Yf(t),headers:t.headers}),{Peers:s}=await n.json();return(s||[]).map((e=>({addr:(0,j.HZ)(e.Addr),peer:(0,Ht.XL)(e.Peer),muxer:e.Muxer,latency:e.Latency,streams:e.Streams,direction:null==e.Direction?void 0:0===e.Direction?"inbound":"outbound"})))}));function Lm(e){return{addrs:Pm(e),connect:Am(e),disconnect:Dm(e),localAddrs:Om(e),peers:Nm(e)}}const Mm=qf((e=>async function*(t,n={}){const s=new AbortController,r=sy(s.signal,n.signal),{headers:o,body:i,total:a,parts:c}=await(0,ny.e)(t,s,n.headers),[l,d]="function"==typeof n.progress?Cm(a,c,n.progress):[void 0,void 0],u=await e.post("add",{searchParams:Yf({"stream-channels":!0,...n,progress:Boolean(l)}),onUploadProgress:d,signal:r,headers:o,body:i});for await(let e of u.ndjson())e=gy(e),void 0!==e.hash?yield Bm(e):l&&l(e.bytes||0,e.name)})),Cm=(e,t,n)=>t?[void 0,xm(e,t,n)]:[n,void 0],xm=(e,t,n)=>{let s=0;const r=t.length;return({loaded:o,total:i})=>{const a=Math.floor(o/i*e);for(;s<r;){const{start:e,end:r,name:o}=t[s];if(a<r){n(a-e,o);break}n(r-e,o),s+=1}}};function Bm({name:e,hash:t,size:n,mode:s,mtime:r,mtimeNsecs:o}){const i={path:e,cid:J.TO.parse(t),size:parseInt(n)};return null!=s&&(i.mode=parseInt(s,8)),null!=r&&(i.mtime={secs:r,nsecs:o||0}),i}function zm(e){const t=Mm(e);return qf((()=>async function(e,n={}){return await(0,Vt.A)(t((0,oo.n)(e),n))}))(e)}const Um=qf((e=>async function*(t,n={}){const s=await e.post("cat",{signal:n.signal,searchParams:Yf({arg:t.toString(),...n}),headers:n.headers});yield*s.iterator()})),Fm=qf((e=>async(t={})=>(await e.post("commands",{signal:t.signal,searchParams:Yf(t),headers:t.headers})).json())),jm=qf((e=>async(t,n={})=>{const s=await e.post("dns",{signal:n.signal,searchParams:Yf({arg:t,...n}),headers:n.headers});return(await s.json()).Path})),Hm=qf((e=>()=>{const t=new URL(e.opts.base||"");return{host:t.hostname,port:t.port,protocol:t.protocol,pathname:t.pathname,"api-path":t.pathname}})),$m=qf((e=>async function*(t,n={}){const s={arg:`${t instanceof Uint8Array?J.TO.decode(t):t}`,...n};s.compressionLevel&&(s["compression-level"]=s.compressionLevel,delete s.compressionLevel);const r=await e.post("get",{signal:n.signal,searchParams:Yf(s),headers:n.headers});yield*r.iterator()})),Vm=qf((e=>async function(t={}){const n=await e.post("id",{signal:t.signal,searchParams:Yf({arg:t.peerId?t.peerId.toString():void 0,...t}),headers:t.headers}),s={...gy(await n.json())};return s.id=(0,Ht.XL)(s.id),s.addresses&&(s.addresses=s.addresses.map((e=>(0,j.HZ)(e)))),s})),Km=e=>{const t=Vm(e);return async function(e={}){const n=await t(e);return Boolean(n&&n.addresses&&n.addresses.length)}},qm=qf(((e,t)=>async function*(n,s={}){const r=`${n instanceof Uint8Array?J.TO.decode(n):n}`;async function o(e){let n=e.Hash;if(n.includes("/")){const e=n.startsWith("/ipfs/")?n:`/ipfs/${n}`;n=(await tg(t)(e)).cid}else n=J.TO.parse(n);const s={name:e.Name,path:r+(e.Name?`/${e.Name}`:""),size:e.Size,cid:n,type:Gm(e)};return e.Mode&&(s.mode=parseInt(e.Mode,8)),void 0!==e.Mtime&&null!==e.Mtime&&(s.mtime={secs:e.Mtime},void 0!==e.MtimeNsecs&&null!==e.MtimeNsecs&&(s.mtime.nsecs=e.MtimeNsecs)),s}const i=await e.post("ls",{signal:s.signal,searchParams:Yf({arg:r,...s}),headers:s.headers});for await(let e of i.ndjson()){if(e=e.Objects,!e)throw new Error("expected .Objects in results");if(e=e[0],!e)throw new Error("expected one array in results.Objects");const t=e.Links;if(!Array.isArray(t))throw new Error("expected one array in results.Objects[0].Links");if(!t.length)return void(yield o(e));yield*t.map(o)}}));function Gm(e){switch(e.Type){case 1:case 5:return"dir";default:return"file"}}const Wm=qf((e=>async function(t={}){const n=await e.post("dns",{signal:t.signal,searchParams:Yf(t),headers:t.headers});return gy(await n.json())})),Ym=qf((e=>async function*(t,n={}){const s=await e.post("ping",{signal:n.signal,searchParams:Yf({arg:`${t}`,...n}),headers:n.headers,transform:gy});yield*s.ndjson()})),Xm=qf((e=>async function(t,n={}){const s=await e.post("resolve",{signal:n.signal,searchParams:Yf({arg:t,...n}),headers:n.headers}),{Path:r}=await s.json();return r})),Qm=qf((e=>async(e={})=>{throw c(new Error("Not implemented"),"ERR_NOT_IMPLEMENTED")})),Jm=qf((e=>async function(t={}){const n=await e.post("shutdown",{signal:t.signal,searchParams:Yf(t),headers:t.headers});await n.text()})),Zm=qf((e=>async function(t={}){const n=await e.post("version",{signal:t.signal,searchParams:Yf(t),headers:t.headers});return{...gy(await n.json()),"ipfs-http-client":"1.0.0"}}));n(19984),n(68086);var ew=n(86824);var tw,nw,sw=n(74171);class rw extends Wn{constructor(){super(),this.data={}}open(){return Promise.resolve()}close(){return Promise.resolve()}async put(e,t){this.data[e.toString()]=t}async get(e){if(!await this.has(e))throw Xt();return this.data[e.toString()]}async has(e){return void 0!==this.data[e.toString()]}async delete(e){delete this.data[e.toString()]}async*_all(){yield*Object.entries(this.data).map((([e,t])=>({key:new bt.U(e),value:t})))}async*_allKeys(){yield*Object.entries(this.data).map((([e])=>new bt.U(e)))}}async function*ow(e,t){yield*(0,Xr.A)(e,(async e=>(await t.addressBook.add(e.id,e.multiaddrs),e)))}function iw(e){const t=new Set;return(0,qn.A)(e,(e=>!t.has(e.id.toString())&&(t.add(e.id.toString()),!0)))}async function*aw(e,t=1){let n=0;for await(const t of e)n++,yield t;if(n<t)throw c(new Error("not found"),"NOT_FOUND")}!function(e){e.NOT_STARTED_YET="The libp2p node is not started yet",e.DHT_DISABLED="DHT is not available",e.PUBSUB_DISABLED="PubSub is not available",e.CONN_ENCRYPTION_REQUIRED="At least one connection encryption module is required",e.ERR_TRANSPORTS_REQUIRED="At least one transport module is required",e.ERR_PROTECTOR_REQUIRED="Private network is enforced, but no protector was provided",e.NOT_FOUND="Not found"}(tw||(tw={})),function(e){e.DHT_DISABLED="ERR_DHT_DISABLED",e.ERR_PUBSUB_DISABLED="ERR_PUBSUB_DISABLED",e.PUBSUB_NOT_STARTED="ERR_PUBSUB_NOT_STARTED",e.DHT_NOT_STARTED="ERR_DHT_NOT_STARTED",e.CONN_ENCRYPTION_REQUIRED="ERR_CONN_ENCRYPTION_REQUIRED",e.ERR_TRANSPORTS_REQUIRED="ERR_TRANSPORTS_REQUIRED",e.ERR_PROTECTOR_REQUIRED="ERR_PROTECTOR_REQUIRED",e.ERR_PEER_DIAL_INTERCEPTED="ERR_PEER_DIAL_INTERCEPTED",e.ERR_CONNECTION_INTERCEPTED="ERR_CONNECTION_INTERCEPTED",e.ERR_INVALID_PROTOCOLS_FOR_STREAM="ERR_INVALID_PROTOCOLS_FOR_STREAM",e.ERR_CONNECTION_ENDED="ERR_CONNECTION_ENDED",e.ERR_CONNECTION_FAILED="ERR_CONNECTION_FAILED",e.ERR_NODE_NOT_STARTED="ERR_NODE_NOT_STARTED",e.ERR_ALREADY_ABORTED="ERR_ALREADY_ABORTED",e.ERR_TOO_MANY_ADDRESSES="ERR_TOO_MANY_ADDRESSES",e.ERR_NO_VALID_ADDRESSES="ERR_NO_VALID_ADDRESSES",e.ERR_RELAYED_DIAL="ERR_RELAYED_DIAL",e.ERR_DIALED_SELF="ERR_DIALED_SELF",e.ERR_DISCOVERED_SELF="ERR_DISCOVERED_SELF",e.ERR_DUPLICATE_TRANSPORT="ERR_DUPLICATE_TRANSPORT",e.ERR_ENCRYPTION_FAILED="ERR_ENCRYPTION_FAILED",e.ERR_HOP_REQUEST_FAILED="ERR_HOP_REQUEST_FAILED",e.ERR_INVALID_KEY="ERR_INVALID_KEY",e.ERR_INVALID_MESSAGE="ERR_INVALID_MESSAGE",e.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",e.ERR_INVALID_PEER="ERR_INVALID_PEER",e.ERR_MUXER_UNAVAILABLE="ERR_MUXER_UNAVAILABLE",e.ERR_NOT_FOUND="ERR_NOT_FOUND",e.ERR_TIMEOUT="ERR_TIMEOUT",e.ERR_TRANSPORT_UNAVAILABLE="ERR_TRANSPORT_UNAVAILABLE",e.ERR_TRANSPORT_DIAL_FAILED="ERR_TRANSPORT_DIAL_FAILED",e.ERR_UNSUPPORTED_PROTOCOL="ERR_UNSUPPORTED_PROTOCOL",e.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED="ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED",e.ERR_INVALID_MULTIADDR="ERR_INVALID_MULTIADDR",e.ERR_SIGNATURE_NOT_VALID="ERR_SIGNATURE_NOT_VALID",e.ERR_FIND_SELF="ERR_FIND_SELF",e.ERR_NO_ROUTERS_AVAILABLE="ERR_NO_ROUTERS_AVAILABLE",e.ERR_CONNECTION_NOT_MULTIPLEXED="ERR_CONNECTION_NOT_MULTIPLEXED",e.ERR_NO_DIAL_TOKENS="ERR_NO_DIAL_TOKENS",e.ERR_KEYCHAIN_REQUIRED="ERR_KEYCHAIN_REQUIRED",e.ERR_INVALID_CMS="ERR_INVALID_CMS",e.ERR_MISSING_KEYS="ERR_MISSING_KEYS",e.ERR_NO_KEY="ERR_NO_KEY",e.ERR_INVALID_KEY_NAME="ERR_INVALID_KEY_NAME",e.ERR_INVALID_KEY_TYPE="ERR_INVALID_KEY_TYPE",e.ERR_KEY_ALREADY_EXISTS="ERR_KEY_ALREADY_EXISTS",e.ERR_INVALID_KEY_SIZE="ERR_INVALID_KEY_SIZE",e.ERR_KEY_NOT_FOUND="ERR_KEY_NOT_FOUND",e.ERR_OLD_KEY_NAME_INVALID="ERR_OLD_KEY_NAME_INVALID",e.ERR_NEW_KEY_NAME_INVALID="ERR_NEW_KEY_NAME_INVALID",e.ERR_PASSWORD_REQUIRED="ERR_PASSWORD_REQUIRED",e.ERR_PEM_REQUIRED="ERR_PEM_REQUIRED",e.ERR_CANNOT_READ_KEY="ERR_CANNOT_READ_KEY",e.ERR_MISSING_PRIVATE_KEY="ERR_MISSING_PRIVATE_KEY",e.ERR_MISSING_PUBLIC_KEY="ERR_MISSING_PUBLIC_KEY",e.ERR_INVALID_OLD_PASS_TYPE="ERR_INVALID_OLD_PASS_TYPE",e.ERR_INVALID_NEW_PASS_TYPE="ERR_INVALID_NEW_PASS_TYPE",e.ERR_INVALID_PASS_LENGTH="ERR_INVALID_PASS_LENGTH",e.ERR_NOT_IMPLEMENTED="ERR_NOT_IMPLEMENTED",e.ERR_WRONG_PING_ACK="ERR_WRONG_PING_ACK",e.ERR_INVALID_RECORD="ERR_INVALID_RECORD",e.ERR_ALREADY_SUCCEEDED="ERR_ALREADY_SUCCEEDED",e.ERR_NO_HANDLER_FOR_PROTOCOL="ERR_NO_HANDLER_FOR_PROTOCOL",e.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS",e.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS",e.ERR_CONNECTION_DENIED="ERR_CONNECTION_DENIED"}(nw||(nw={}));var cw=n(4807),lw=n(37007);const dw=(0,a.vF)("libp2p:peer-routing");class uw{constructor(e,t){this.components=e,this.routers=t.routers??[],this.refreshManagerInit=t.refreshManager??{},this.started=!1,this._findClosestPeersTask=this._findClosestPeersTask.bind(this)}isStarted(){return this.started}async start(){this.started||0===this.routers.length||null!=this.timeoutId||!1===this.refreshManagerInit.enabled||(this.timeoutId=(0,cw.setDelayedInterval)(this._findClosestPeersTask,this.refreshManagerInit.interval,this.refreshManagerInit.bootDelay),this.started=!0)}async _findClosestPeersTask(){if(null==this.abortController)try{this.abortController=new B.TimeoutController(this.refreshManagerInit.timeout??1e4);try{(0,lw.setMaxListeners)?.(1/0,this.abortController.signal)}catch{}await(0,Kn.A)(this.getClosestPeers(this.components.peerId.toBytes(),{signal:this.abortController.signal}))}catch(e){dw.error(e)}finally{this.abortController?.clear(),this.abortController=void 0}}async stop(){(0,cw.clearDelayedInterval)(this.timeoutId),this.abortController?.abort(),this.started=!1}async findPeer(e,t){if(0===this.routers.length)throw c(new Error("No peer routers available"),nw.ERR_NO_ROUTERS_AVAILABLE);if(e.toString()===this.components.peerId.toString())throw c(new Error("Should not try to find self"),nw.ERR_FIND_SELF);const n=await no((0,Qr.A)(...this.routers.map((n=>async function*(){try{yield await n.findPeer(e,t)}catch(e){dw.error(e)}}()))),(e=>(0,qn.A)(e,Boolean)),(e=>ow(e,this.components.peerStore)),(async e=>await(0,sc.A)(e)));if(null!=n)return n;throw c(new Error(tw.NOT_FOUND),nw.ERR_NOT_FOUND)}async*getClosestPeers(e,t){if(0===this.routers.length)throw c(new Error("No peer routers available"),nw.ERR_NO_ROUTERS_AVAILABLE);yield*no((0,Qr.A)(...this.routers.map((n=>n.getClosestPeers(e,t)))),(e=>ow(e,this.components.peerStore)),(e=>iw(e)),(e=>aw(e)))}}class hw{constructor(e,t){this.routers=t.routers??[],this.started=!1,this.components=e}isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(e,t={}){if(0===this.routers.length)throw c(new Error("No content this.routers available"),nw.ERR_NO_ROUTERS_AVAILABLE);yield*no((0,Qr.A)(...this.routers.map((n=>n.findProviders(e,t)))),(e=>ow(e,this.components.peerStore)),(e=>iw(e)),(e=>aw(e)))}async provide(e,t={}){if(0===this.routers.length)throw c(new Error("No content routers available"),nw.ERR_NO_ROUTERS_AVAILABLE);await Promise.all(this.routers.map((async n=>await n.provide(e,t))))}async put(e,t,n){if(!this.isStarted())throw c(new Error(tw.NOT_STARTED_YET),nw.DHT_NOT_STARTED);const s=this.components.dht;null!=s&&await(0,Kn.A)(s.put(e,t,n))}async get(e,t){if(!this.isStarted())throw c(new Error(tw.NOT_STARTED_YET),nw.DHT_NOT_STARTED);const n=this.components.dht;if(null!=n)for await(const s of n.get(e,t))if("VALUE"===s.name)return s.value;throw c(new Error(tw.NOT_FOUND),nw.ERR_NOT_FOUND)}async*getMany(e,t,n){if(!this.isStarted())throw c(new Error(tw.NOT_STARTED_YET),nw.DHT_NOT_STARTED);if(null==t||0===t)return;let s=0;const r=this.components.dht;if(null!=r)for await(const o of r.get(e,n))if("VALUE"===o.name&&(yield{from:o.from,val:o.value},s++,s===t))break;if(0===s)throw c(new Error(tw.NOT_FOUND),nw.ERR_NOT_FOUND)}}const pw=e=>e;class fw extends Zh.b{constructor(e,t){super();const{listen:n=[],announce:s=[]}=t;this.components=e,this.listen=n.map((e=>e.toString())),this.announce=new Set(s.map((e=>e.toString()))),this.observed=new Set,this.announceFilter=t.announceFilter??pw}getListenAddrs(){return Array.from(this.listen).map((e=>(0,j.HZ)(e)))}getAnnounceAddrs(){return Array.from(this.announce).map((e=>(0,j.HZ)(e)))}getObservedAddrs(){return Array.from(this.observed).map((e=>(0,j.HZ)(e)))}confirmObservedAddr(e){}removeObservedAddr(e){}addObservedAddr(e){let t=(0,j.HZ)(e);const n=t.getPeerId();if(null!=n){(0,Ht.XL)(n).equals(this.components.peerId)&&(t=t.decapsulate((0,j.HZ)(`/p2p/${this.components.peerId.toString()}`)))}const s=t.toString();this.observed.has(s)||(this.observed.add(s),this.dispatchEvent(new Zh.u("change:addresses")))}getAddresses(){let e=this.getAnnounceAddrs().map((e=>e.toString()));0===e.length&&(e=this.components.transportManager.getAddrs().map((e=>e.toString()))),e=e.concat(this.getObservedAddrs().map((e=>e.toString())));const t=new Set(e);return this.announceFilter(Array.from(t).map((e=>(0,j.HZ)(e)))).map((e=>!0===e.protos().pop()?.path||e.getPeerId()===this.components.peerId.toString()?e:e.encapsulate(`/p2p/${this.components.peerId.toString()}`)))}}const yw=(0,a.vF)("libp2p:connection-manager:latency-monitor:visibility-change-emitter");class gw extends Zh.b{constructor(){super(),this.hidden="hidden",this.visibilityChange="visibilityChange",null!=globalThis.document&&(this._initializeVisibilityVarNames(),this._addVisibilityChangeListener())}_initializeVisibilityVarNames(){let e="hidden",t="visibilitychange";void 0!==globalThis.document.hidden?(e="hidden",t="visibilitychange"):void 0!==globalThis.document.mozHidden?(e="mozHidden",t="mozvisibilitychange"):void 0!==globalThis.document.msHidden?(e="msHidden",t="msvisibilitychange"):void 0!==globalThis.document.webkitHidden&&(e="webkitHidden",t="webkitvisibilitychange"),this.hidden=e,this.visibilityChange=t}_addVisibilityChangeListener(){void 0===globalThis.document.addEventListener||void 0===document[this.hidden]?yw("Checking page visibility requires a browser that supports the Page Visibility API."):globalThis.document.addEventListener(this.visibilityChange,this._handleVisibilityChange.bind(this),!1)}isVisible(){if(void 0!==this.hidden&&void 0!==document[this.hidden])return null==document[this.hidden]}_handleVisibilityChange(){const e=!1===globalThis.document[this.hidden];yw(e?"Page Visible":"Page Hidden"),this.dispatchEvent(new Zh.u("visibilityChange",{detail:e}))}}const mw=(0,a.vF)("libp2p:connection-manager:latency-monitor");class ww extends Zh.b{constructor(e={}){super();const{latencyCheckIntervalMs:t,dataEmitIntervalMs:n,asyncTestFn:s,latencyRandomPercentage:r}=e;this.latencyCheckIntervalMs=t??500,this.latencyRandomPercentage=r??10,this.latencyCheckMultiply=this.latencyRandomPercentage/100*2*this.latencyCheckIntervalMs,this.latencyCheckSubtract=this.latencyCheckMultiply/2,this.dataEmitIntervalMs=null===n||0===n?void 0:n??5e3,mw("latencyCheckIntervalMs: %s dataEmitIntervalMs: %s",this.latencyCheckIntervalMs,this.dataEmitIntervalMs),null!=this.dataEmitIntervalMs?mw("Expecting ~%s events per summary",this.latencyCheckIntervalMs/this.dataEmitIntervalMs):mw("Not emitting summaries"),this.asyncTestFn=s,null!=globalThis.process?.hrtime?(mw("Using process.hrtime for timing"),this.now=globalThis.process.hrtime,this.getDeltaMS=e=>{const t=this.now(e);return 1e3*t[0]+t[1]/1e6}):"undefined"!=typeof window&&null!=window.performance?.now?(mw("Using performance.now for timing"),this.now=window.performance.now.bind(window.performance),this.getDeltaMS=e=>Math.round(this.now()-e)):(mw("Using Date.now for timing"),this.now=Date.now,this.getDeltaMS=e=>this.now()-e),this.latencyData=this.initLatencyData()}start(){void 0!==globalThis.window&&(this.visibilityChangeEmitter=new gw,this.visibilityChangeEmitter.addEventListener("visibilityChange",(e=>{const{detail:t}=e;t?this._startTimers():(this._emitSummary(),this._stopTimers())}))),!0===this.visibilityChangeEmitter?.isVisible()&&this._startTimers()}stop(){this._stopTimers()}_startTimers(){null==this.checkLatencyID&&(this.checkLatency(),null!=this.dataEmitIntervalMs&&(this.emitIntervalID=setInterval((()=>this._emitSummary()),this.dataEmitIntervalMs),"function"==typeof this.emitIntervalID.unref&&this.emitIntervalID.unref()))}_stopTimers(){null!=this.checkLatencyID&&(clearTimeout(this.checkLatencyID),this.checkLatencyID=void 0),null!=this.emitIntervalID&&(clearInterval(this.emitIntervalID),this.emitIntervalID=void 0)}_emitSummary(){const e=this.getSummary();e.events>0&&this.dispatchEvent(new Zh.u("data",{detail:e}))}getSummary(){const e={events:this.latencyData.events,minMs:this.latencyData.minMs,maxMs:this.latencyData.maxMs,avgMs:this.latencyData.events>0?this.latencyData.totalMs/this.latencyData.events:Number.POSITIVE_INFINITY,lengthMs:this.getDeltaMS(this.latencyData.startTime)};return this.latencyData=this.initLatencyData(),mw.trace("Summary: %O",e),e}checkLatency(){const e=Math.random()*this.latencyCheckMultiply-this.latencyCheckSubtract,t={deltaOffset:Math.ceil(this.latencyCheckIntervalMs+e),startTime:this.now()},n=()=>{if(null==this.checkLatencyID)return;const e=this.getDeltaMS(t.startTime)-t.deltaOffset;this.checkLatency(),this.latencyData.events++,this.latencyData.minMs=Math.min(this.latencyData.minMs,e),this.latencyData.maxMs=Math.max(this.latencyData.maxMs,e),this.latencyData.totalMs+=e,mw.trace("MS: %s Data: %O",e,this.latencyData)};mw.trace("localData: %O",t),this.checkLatencyID=setTimeout((()=>{null!=this.asyncTestFn?(t.deltaOffset=0,t.startTime=this.now(),this.asyncTestFn(n)):(t.deltaOffset-=1,n())}),t.deltaOffset),"function"==typeof this.checkLatencyID.unref&&this.checkLatencyID.unref()}initLatencyData(){return{startTime:this.now(),minMs:Number.POSITIVE_INFINITY,maxMs:Number.NEGATIVE_INFINITY,events:0,totalMs:0}}}var bw=n(45106);function _w(e,t){const n={[Symbol.iterator]:()=>n,next:()=>{const n=e.next(),s=n.value;if(!0===n.done||null==s){return{done:!0,value:void 0}}return{done:!1,value:t(s)}}};return n}class Ew{constructor(e){if(this.map=new Map,null!=e)for(const[t,n]of e.entries())this.map.set(t.toString(),n)}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){this.map.delete(e.toString())}entries(){return _w(this.map.entries(),(e=>[(0,Ht.XL)(e[0]),e[1]]))}forEach(e){this.map.forEach(((t,n)=>{e(t,(0,Ht.XL)(n),this)}))}get(e){return this.map.get(e.toString())}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),t)}keys(){return _w(this.map.keys(),(e=>(0,Ht.XL)(e)))}values(){return this.map.values()}get size(){return this.map.size}}class vw{constructor(e){if(this.set=new Set,null!=e)for(const t of e)this.set.add(t.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return _w(this.set.entries(),(e=>{const t=(0,Ht.XL)(e[0]);return[t,t]}))}forEach(e){this.set.forEach((t=>{const n=(0,Ht.XL)(t);e(n,n,this)}))}has(e){return this.set.has(e.toString())}values(){return _w(this.set.values(),(e=>(0,Ht.XL)(e)))}intersection(e){const t=new vw;for(const n of e)this.has(n)&&t.add(n);return t}difference(e){const t=new vw;for(const n of this)e.has(n)||t.add(n);return t}union(e){const t=new vw;for(const n of e)t.add(n);for(const e of this)t.add(e);return t}}class Sw{constructor(e){if(this.list=[],null!=e)for(const t of e)this.list.push(t.toString())}[Symbol.iterator](){return _w(this.list.entries(),(e=>(0,Ht.XL)(e[1])))}concat(e){const t=new Sw(this);for(const n of e)t.push(n);return t}entries(){return _w(this.list.entries(),(e=>[e[0],(0,Ht.XL)(e[1])]))}every(e){return this.list.every(((t,n)=>e((0,Ht.XL)(t),n,this)))}filter(e){const t=new Sw;return this.list.forEach(((n,s)=>{const r=(0,Ht.XL)(n);e(r,s,this)&&t.push(r)})),t}find(e){const t=this.list.find(((t,n)=>e((0,Ht.XL)(t),n,this)));if(null!=t)return(0,Ht.XL)(t)}findIndex(e){return this.list.findIndex(((t,n)=>e((0,Ht.XL)(t),n,this)))}forEach(e){this.list.forEach(((t,n)=>{e((0,Ht.XL)(t),n,this)}))}includes(e){return this.list.includes(e.toString())}indexOf(e){return this.list.indexOf(e.toString())}pop(){const e=this.list.pop();if(null!=e)return(0,Ht.XL)(e)}push(...e){for(const t of e)this.list.push(t.toString())}shift(){const e=this.list.shift();if(null!=e)return(0,Ht.XL)(e)}unshift(...e){let t=this.list.length;for(let t=e.length-1;t>-1;t--)this.list.unshift(e[t].toString());return t}get length(){return this.list.length}}var kw=n(55317),Rw=n(94798);function Tw(e){if((0,Yt.Q)(e))return{peerId:e};if((0,j.R8)(e)){const t=e.getPeerId();return{multiaddr:e,peerId:null==t?void 0:(0,Ht.XL)(t)}}throw c(new Error(`${e} is not a PeerId or a Multiaddr`),nw.ERR_INVALID_MULTIADDR)}const Iw=(0,a.vF)("libp2p:connection-manager"),Pw={maxConnections:1/0,minConnections:0,maxEventLoopDelay:1/0,pollInterval:2e3,autoDialInterval:1e4,inboundConnectionThreshold:5,maxIncomingPendingConnections:10};class Aw extends Zh.b{constructor(e,t){if(super(),this.opts=o.A.call({ignoreUndefined:!0},Pw,t),this.opts.maxConnections<this.opts.minConnections)throw c(new Error("Connection Manager maxConnections must be greater than minConnections"),nw.ERR_INVALID_PARAMETERS);Iw("options: %o",this.opts),this.components=e,this.connections=new Map,this.started=!1,null!=t.maxEventLoopDelay&&t.maxEventLoopDelay>0&&t.maxEventLoopDelay!==1/0&&(this.latencyMonitor=new ww({latencyCheckIntervalMs:t.pollInterval,dataEmitIntervalMs:t.pollInterval}));try{(0,lw.setMaxListeners)?.(1/0,this)}catch{}this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.startupReconnectTimeout=t.startupReconnectTimeout??6e4,this.dialTimeout=t.dialTimeout??3e4,this.allow=(t.allow??[]).map((e=>(0,j.HZ)(e))),this.deny=(t.deny??[]).map((e=>(0,j.HZ)(e))),this.inboundConnectionRateLimiter=new Rw.RateLimiterMemory({points:this.opts.inboundConnectionThreshold,duration:1}),this.incomingPendingConnections=0}isStarted(){return this.started}async start(){this.components.metrics?.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{const e={inbound:0,outbound:0};for(const t of this.connections.values())for(const n of t)"inbound"===n.stat.direction?e.inbound++:e.outbound++;return e}}),this.components.metrics?.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{const e={};for(const t of this.connections.values())for(const n of t)for(const t of n.streams){const n=`${t.stat.direction} ${t.stat.protocol??"unnegotiated"}`;e[n]=(e[n]??0)+1}return e}}),this.components.metrics?.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{const e={};for(const t of this.connections.values())for(const n of t){const t={};for(const e of n.streams){const n=`${e.stat.direction} ${e.stat.protocol??"unnegotiated"}`;t[n]=(t[n]??0)+1}for(const[n,s]of Object.entries(t))e[n]=e[n]??[],e[n].push(s)}const t={};for(let[n,s]of Object.entries(e)){s=s.sort(((e,t)=>e-t));const e=Math.floor(.9*s.length);t[n]=s[e]}return t}}),this.latencyMonitor?.start(),this._onLatencyMeasure=this._onLatencyMeasure.bind(this),this.latencyMonitor?.addEventListener("data",this._onLatencyMeasure),this.started=!0,Iw("started")}async afterStart(){this.components.upgrader.addEventListener("connection",this.onConnect),this.components.upgrader.addEventListener("connectionEnd",this.onDisconnect),Promise.resolve().then((async()=>{const e=[];for(const t of await this.components.peerStore.all()){(await this.components.peerStore.getTags(t.id)).filter((e=>e.name===kw.Q)).length>0&&e.push(t.id)}this.connectOnStartupController?.clear(),this.connectOnStartupController=new B.TimeoutController(this.startupReconnectTimeout);try{(0,lw.setMaxListeners)?.(1/0,this.connectOnStartupController.signal)}catch{}await Promise.all(e.map((async e=>{await this.openConnection(e,{signal:this.connectOnStartupController?.signal}).catch((e=>{Iw.error(e)}))})))})).catch((e=>{Iw.error(e)})).finally((()=>{this.connectOnStartupController?.clear()}))}async beforeStop(){this.connectOnStartupController?.abort(),this.components.upgrader.removeEventListener("connection",this.onConnect),this.components.upgrader.removeEventListener("connectionEnd",this.onDisconnect)}async stop(){this.latencyMonitor?.removeEventListener("data",this._onLatencyMeasure),this.latencyMonitor?.stop(),this.started=!1,await this._close(),Iw("stopped")}async _close(){const e=[];for(const t of this.connections.values())for(const n of t)e.push((async()=>{try{await n.close()}catch(e){Iw.error(e)}})());Iw("closing %d connections",e.length),await Promise.all(e),this.connections.clear()}onConnect(e){this._onConnect(e).catch((e=>{Iw.error(e)}))}async _onConnect(e){const{detail:t}=e;if(!this.started)return void await t.close();const n=t.remotePeer,s=n.toString(),r=this.connections.get(s);null!=r?r.push(t):this.connections.set(s,[t]),null!=n.publicKey&&await this.components.peerStore.keyBook.set(n,n.publicKey);const o=this.getConnections().length,i=o-this.opts.maxConnections;await this._checkMaxLimit("maxConnections",o,i),this.dispatchEvent(new Zh.u("peer:connect",{detail:t}))}onDisconnect(e){const{detail:t}=e;if(!this.started)return;const n=t.remotePeer.toString();let s=this.connections.get(n);null!=s&&s.length>1?(s=s.filter((e=>e.id!==t.id)),this.connections.set(n,s)):null!=s&&(this.connections.delete(n),this.dispatchEvent(new Zh.u("peer:disconnect",{detail:t})))}getConnections(e){if(null!=e)return this.connections.get(e.toString())??[];let t=[];for(const e of this.connections.values())t=t.concat(e);return t}async openConnection(e,t={}){const{peerId:n,multiaddr:s}=Tw(e);if(null==n&&null==s)throw c(new TypeError("Can only open connections to PeerIds or Multiaddrs"),nw.ERR_INVALID_PARAMETERS);if(null!=n){Iw("dial to",n);const e=this.getConnections(n);if(e.length>0)return Iw("had an existing connection to %p",n),e[0]}let r;if(null==t?.signal){r=new B.TimeoutController(this.dialTimeout),t.signal=r.signal;try{(0,lw.setMaxListeners)?.(1/0,r.signal)}catch{}}try{const n=await this.components.dialer.dial(e,t);let s=this.connections.get(n.remotePeer.toString());null==s&&(s=[],this.connections.set(n.remotePeer.toString(),s));let r=!1;for(const e of s)e.id===n.id&&(r=!0);return r||s.push(n),n}finally{null!=r&&r.clear()}}async closeConnections(e){const t=this.connections.get(e.toString())??[];await Promise.all(t.map((async e=>await e.close())))}getAll(e){if(!(0,Yt.Q)(e))throw c(new Error("peerId must be an instance of peer-id"),nw.ERR_INVALID_PARAMETERS);const t=e.toString(),n=this.connections.get(t);return null!=n?n.filter((e=>e.stat.status===bw.vP)):[]}_onLatencyMeasure(e){const{detail:t}=e;this._checkMaxLimit("maxEventLoopDelay",t.avgMs,1).catch((e=>{Iw.error(e)}))}async _checkMaxLimit(e,t,n=1){const s=this.opts[e];null!=s?(Iw.trace("checking limit of %s. current value: %d of %d",e,t,s),t>s&&(Iw("%s: limit exceeded: %p, %d/%d, pruning %d connection(s)",this.components.peerId,e,t,s,n),await this._pruneConnections(n))):Iw.trace("limit %s was not set so it cannot be applied",e)}async _pruneConnections(e){const t=this.getConnections(),n=new Ew;for(const e of t){const t=e.remotePeer;if(n.has(t))continue;const s=await this.components.peerStore.getTags(t);n.set(t,s.reduce(((e,t)=>e+t.value),0))}const s=t.sort(((e,t)=>{const s=n.get(e.remotePeer)??0,r=n.get(t.remotePeer)??0;if(s>r)return 1;if(s<r)return-1;const o=e.stat.timeline.open,i=t.stat.timeline.open;return o<i?1:o>i?-1:0})),r=[];for(const t of s)if(Iw("too many connections open - closing a connection to %p",t.remotePeer),r.push(t),r.length===e)break;await Promise.all(r.map((async e=>{try{await e.close()}catch(e){Iw.error(e)}this.onDisconnect(new Zh.u("connectionEnd",{detail:e}))})))}async acceptIncomingConnection(e){if(this.deny.some((t=>e.remoteAddr.toString().startsWith(t.toString()))))return Iw("connection from %s refused - connection remote address was in deny list",e.remoteAddr),!1;if(this.allow.some((t=>e.remoteAddr.toString().startsWith(t.toString()))))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.opts.maxIncomingPendingConnections)return Iw("connection from %s refused - incomingPendingConnections exceeded by peer %s",e.remoteAddr),!1;if(e.remoteAddr.isThinWaistAddress()){const t=e.remoteAddr.nodeAddress().address;try{await this.inboundConnectionRateLimiter.consume(t,1)}catch{return Iw("connection from %s refused - inboundConnectionThreshold exceeded by host %s",t,e.remoteAddr),!1}}return this.getConnections().length<this.opts.maxConnections?(this.incomingPendingConnections++,!0):(Iw("connection from %s refused - maxConnections exceeded",e.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}}var Dw=n(30395),Ow=n(86602);const Nw=(0,a.vF)("libp2p:connection-manager:auto-dialler"),Lw={enabled:!0,minConnections:0,autoDialInterval:1e4};class Mw{constructor(e,t){this.components=e,this.options=o.A.call({ignoreUndefined:!0},Lw,t),this.running=!1,this._autoDial=this._autoDial.bind(this),Nw("options: %j",this.options)}isStarted(){return this.running}async start(){this.options.enabled?(this.running=!0,this._autoDial().catch((e=>{Nw.error("could start autodial",e)})),Nw("started")):Nw("not enabled")}async stop(){this.options.enabled?(this.running=!1,null!=this.autoDialTimeout&&this.autoDialTimeout.clear(),Nw("stopped")):Nw("not enabled")}async _autoDial(){null!=this.autoDialTimeout&&this.autoDialTimeout.clear();const e=this.options.minConnections;if(this.components.connectionManager.getConnections().length>=e)return void(this.autoDialTimeout=Dw(this._autoDial,this.options.autoDialInterval));const t=await this.components.peerStore.all(),n=await no(t.sort((()=>Math.random()>.5?1:-1)),(e=>(0,qn.A)(e,(e=>!e.id.equals(this.components.peerId)))),(e=>(0,Ow.A)(e,((e,t)=>t.protocols.length>e.protocols.length||null!=t.id.publicKey&&null==e.id.publicKey?1:-1))),(async e=>await $n(e)));for(let t=0;this.running&&t<n.length&&this.components.connectionManager.getConnections().length<e;t++){if(!this.running)return;const e=n[t];if(0===this.components.connectionManager.getConnections(e.id).length){Nw("connecting to a peerStore stored peer %p",e.id);try{await this.components.connectionManager.openConnection(e.id)}catch(e){Nw.error("could not connect to peerStore stored peer",e)}}}this.running&&(this.autoDialTimeout=Dw(this._autoDial,this.options.autoDialInterval))}}an._configure(),nn._configure(sn),rn._configure(on);const Cw=["uint64","int64","sint64","fixed64","sfixed64"];function xw(e){return function(e){for(const t of Cw){if(null==e[t])continue;const n=e[t];e[t]=function(){return BigInt(n.call(this).toString())}}return e}(new nn(e))}function Bw(){return function(e){for(const t of Cw){if(null==e[t])continue;const n=e[t];e[t]=function(e){return n.call(this,e.toString())}}return e}(rn.create())}function zw(e,t){const n=xw(e instanceof Uint8Array?e:e.subarray());return t.decode(n)}function Uw(e,t){const n=Bw();return t.encode(e,n,{lengthDelimited:!1}),n.finish()}var Fw,jw;function Hw(e,t,n,s){return{name:e,type:t,encode:n,decode:s}}function $w(e){function t(t){if(null==e[t.toString()])throw new Error("Invalid enum value");return e[t]}return Hw("enum",Fw.VARINT,(function(e,n){const s=t(e);n.int32(s)}),(function(e){return t(e.int32())}))}function Vw(e,t){return Hw("message",Fw.LENGTH_DELIMITED,e,t)}!function(e){e[e.VARINT=0]="VARINT",e[e.BIT64=1]="BIT64",e[e.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",e[e.START_GROUP=3]="START_GROUP",e[e.END_GROUP=4]="END_GROUP",e[e.BIT32=5]="BIT32"}(Fw||(Fw={})),function(e){let t,n,s,r,o,i;!function(e){e.SUCCESS="SUCCESS",e.HOP_SRC_ADDR_TOO_LONG="HOP_SRC_ADDR_TOO_LONG",e.HOP_DST_ADDR_TOO_LONG="HOP_DST_ADDR_TOO_LONG",e.HOP_SRC_MULTIADDR_INVALID="HOP_SRC_MULTIADDR_INVALID",e.HOP_DST_MULTIADDR_INVALID="HOP_DST_MULTIADDR_INVALID",e.HOP_NO_CONN_TO_DST="HOP_NO_CONN_TO_DST",e.HOP_CANT_DIAL_DST="HOP_CANT_DIAL_DST",e.HOP_CANT_OPEN_DST_STREAM="HOP_CANT_OPEN_DST_STREAM",e.HOP_CANT_SPEAK_RELAY="HOP_CANT_SPEAK_RELAY",e.HOP_CANT_RELAY_TO_SELF="HOP_CANT_RELAY_TO_SELF",e.STOP_SRC_ADDR_TOO_LONG="STOP_SRC_ADDR_TOO_LONG",e.STOP_DST_ADDR_TOO_LONG="STOP_DST_ADDR_TOO_LONG",e.STOP_SRC_MULTIADDR_INVALID="STOP_SRC_MULTIADDR_INVALID",e.STOP_DST_MULTIADDR_INVALID="STOP_DST_MULTIADDR_INVALID",e.STOP_RELAY_REFUSED="STOP_RELAY_REFUSED",e.MALFORMED_MESSAGE="MALFORMED_MESSAGE"}(t=e.Status||(e.Status={})),function(e){e[e.SUCCESS=100]="SUCCESS",e[e.HOP_SRC_ADDR_TOO_LONG=220]="HOP_SRC_ADDR_TOO_LONG",e[e.HOP_DST_ADDR_TOO_LONG=221]="HOP_DST_ADDR_TOO_LONG",e[e.HOP_SRC_MULTIADDR_INVALID=250]="HOP_SRC_MULTIADDR_INVALID",e[e.HOP_DST_MULTIADDR_INVALID=251]="HOP_DST_MULTIADDR_INVALID",e[e.HOP_NO_CONN_TO_DST=260]="HOP_NO_CONN_TO_DST",e[e.HOP_CANT_DIAL_DST=261]="HOP_CANT_DIAL_DST",e[e.HOP_CANT_OPEN_DST_STREAM=262]="HOP_CANT_OPEN_DST_STREAM",e[e.HOP_CANT_SPEAK_RELAY=270]="HOP_CANT_SPEAK_RELAY",e[e.HOP_CANT_RELAY_TO_SELF=280]="HOP_CANT_RELAY_TO_SELF",e[e.STOP_SRC_ADDR_TOO_LONG=320]="STOP_SRC_ADDR_TOO_LONG",e[e.STOP_DST_ADDR_TOO_LONG=321]="STOP_DST_ADDR_TOO_LONG",e[e.STOP_SRC_MULTIADDR_INVALID=350]="STOP_SRC_MULTIADDR_INVALID",e[e.STOP_DST_MULTIADDR_INVALID=351]="STOP_DST_MULTIADDR_INVALID",e[e.STOP_RELAY_REFUSED=390]="STOP_RELAY_REFUSED",e[e.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE"}(n||(n={})),function(e){e.codec=()=>$w(n)}(t=e.Status||(e.Status={})),function(e){e.HOP="HOP",e.STOP="STOP",e.STATUS="STATUS",e.CAN_HOP="CAN_HOP"}(s=e.Type||(e.Type={})),function(e){e[e.HOP=1]="HOP",e[e.STOP=2]="STOP",e[e.STATUS=3]="STATUS",e[e.CAN_HOP=4]="CAN_HOP"}(r||(r={})),function(e){e.codec=()=>$w(r)}(s=e.Type||(e.Type={})),function(e){let t;e.codec=()=>(null==t&&(t=Vw(((e,t,n={})=>{if(!1!==n.lengthDelimited&&t.fork(),(!0===n.writeDefaults||null!=e.id&&e.id.byteLength>0)&&(t.uint32(10),t.bytes(e.id)),null!=e.addrs)for(const n of e.addrs)t.uint32(18),t.bytes(n);!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={id:new Uint8Array(0),addrs:[]},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();switch(t>>>3){case 1:n.id=e.bytes();break;case 2:n.addrs.push(e.bytes());break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>Uw(t,e.codec()),e.decode=t=>zw(t,e.codec())}(o=e.Peer||(e.Peer={})),e.codec=()=>(null==i&&(i=Vw(((t,n,s={})=>{!1!==s.lengthDelimited&&n.fork(),null!=t.type&&(n.uint32(8),e.Type.codec().encode(t.type,n)),null!=t.srcPeer&&(n.uint32(18),e.Peer.codec().encode(t.srcPeer,n,{writeDefaults:!1})),null!=t.dstPeer&&(n.uint32(26),e.Peer.codec().encode(t.dstPeer,n,{writeDefaults:!1})),null!=t.code&&(n.uint32(32),e.Status.codec().encode(t.code,n)),!1!==s.lengthDelimited&&n.ldelim()}),((t,n)=>{const s={},r=null==n?t.len:t.pos+n;for(;t.pos<r;){const n=t.uint32();switch(n>>>3){case 1:s.type=e.Type.codec().decode(t);break;case 2:s.srcPeer=e.Peer.codec().decode(t,t.uint32());break;case 3:s.dstPeer=e.Peer.codec().decode(t,t.uint32());break;case 4:s.code=e.Status.codec().decode(t);break;default:t.skipType(7&n)}}return s}))),i),e.encode=t=>Uw(t,e.codec()),e.decode=t=>zw(t,e.codec())}(jw||(jw={}));var Kw=n(47483);const qw="/libp2p/circuit/relay/0.1.0";function Gw(e,t){e.write({type:jw.Type.STATUS,code:t})}function Ww(e,t){try{null!=e.dstPeer?.addrs&&e.dstPeer.addrs.forEach((e=>(0,j.HZ)(e)))}catch(n){throw Gw(t,e.type===jw.Type.HOP?jw.Status.HOP_DST_MULTIADDR_INVALID:jw.Status.STOP_DST_MULTIADDR_INVALID),n}try{null!=e.srcPeer?.addrs&&e.srcPeer.addrs.forEach((e=>(0,j.HZ)(e)))}catch(n){throw Gw(t,e.type===jw.Type.HOP?jw.Status.HOP_SRC_MULTIADDR_INVALID:jw.Status.STOP_SRC_MULTIADDR_INVALID),n}}const Yw=Math.pow(2,7),Xw=Math.pow(2,14),Qw=Math.pow(2,21),Jw=Math.pow(2,28),Zw=Math.pow(2,35),eb=Math.pow(2,42),tb=Math.pow(2,49),nb=Math.pow(2,56),sb=Math.pow(2,63),rb={encodingLength:e=>e<Yw?1:e<Xw?2:e<Qw?3:e<Jw?4:e<Zw?5:e<eb?6:e<tb?7:e<nb?8:e<sb?9:10,encode(e,t,n=0){if(null!=Number.MAX_SAFE_INTEGER&&e>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return null==t&&(t=(0,Wp.K)(rb.encodingLength(e))),Gp.R.fromNumber(e).toBytes(t,n),t},decode:(e,t=0)=>Gp.R.fromBytes(e,t).toNumber(!0)};const ob=e=>{const t=rb.encodingLength(e),n=(s=t,null!=globalThis?.Buffer?.allocUnsafe?globalThis.Buffer.allocUnsafe(s):new Uint8Array(s));var s;return rb.encode(e,n),ob.bytes=t,n};function ib(e){const t=(e=e??{}).lengthEncoder??ob;return async function*(e){for await(const n of e){const e=t(n.byteLength);e instanceof Uint8Array?yield e:yield*e,n instanceof Uint8Array?yield n:yield*n}}}ob.bytes=0,ib.single=(e,t)=>{const n=(t=t??{}).lengthEncoder??ob;return new zo.I(n(e.byteLength),e)};const ab=8,cb=4194304;var lb;!function(e){e[e.LENGTH=0]="LENGTH",e[e.DATA=1]="DATA"}(lb||(lb={}));const db=e=>{const t=rb.decode(e);return db.bytes=rb.encodingLength(t),t};function ub(e){return async function*(t){const n=new zo.I;let s=lb.LENGTH,r=-1;const o=e?.lengthDecoder??db,i=e?.maxLengthLength??ab,a=e?.maxDataLength??cb;for await(const l of t)for(n.append(l);n.byteLength>0;){if(s===lb.LENGTH)try{if(r=o(n),r<0)throw c(new Error("invalid message length"),"ERR_INVALID_MSG_LENGTH");if(r>a)throw c(new Error("message length too long"),"ERR_MSG_DATA_TOO_LONG");const t=o.bytes;n.consume(t),null!=e?.onLength&&e.onLength(r),s=lb.DATA}catch(e){if(e instanceof RangeError){if(n.byteLength>i)throw c(new Error("message length length too long"),"ERR_MSG_LENGTH_TOO_LONG");break}throw e}if(s===lb.DATA){if(n.byteLength<r)break;const t=n.sublist(0,r);n.consume(r),null!=e?.onData&&e.onData(t),yield t,s=lb.LENGTH}}if(n.byteLength>0)throw c(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}}db.bytes=0,ub.fromReader=(e,t)=>{let n=1;const s=async function*(){for(;;)try{const{done:t,value:s}=await e.next(n);if(!0===t)return;null!=s&&(yield s)}catch(e){if("ERR_UNDER_READ"===e.code)return{done:!0,value:null};throw e}finally{n=1}}();return ub({...t??{},onLength:e=>{n=e}})(s)};var hb=n(97313);function pb(e){const t=(0,Yn.N)(),n=(0,Wi.w)(e.source),s=(0,hb.A)();let r;const o=e.sink(async function*(){yield*t;const e=await s.promise;yield*e}());o.catch((e=>{r=e}));return{reader:n,writer:t,stream:{sink:async e=>null!=r?await Promise.reject(r):(s.resolve(e),await o),source:n},rest:()=>t.end(),write:t.push,read:async()=>{const e=await n.next();if(null!=e.value)return e.value}}}const fb=(0,a.vF)("libp2p:circuit:stream-handler");class yb{constructor(e){const{stream:t,maxLength:n=4096}=e;this.stream=t,this.shake=pb(this.stream),this.decoder=ub.fromReader(this.shake.reader,{maxDataLength:n})}async read(){const e=await this.decoder.next();if(null!=e.value){const t=jw.decode(e.value);return fb("read message type",t.type),t}fb("read received no value, closing stream"),this.close()}write(e){fb("write message type %s",e.type),this.shake.write(ib.single(jw.encode(e)))}rest(){return this.shake.rest(),this.shake.stream}end(e){this.write(e),this.close()}close(){fb("closing the stream"),this.rest().sink([]).catch((e=>{fb.error(e)}))}}const gb=(0,a.vF)("libp2p:circuit:stop");const mb=(0,a.vF)("libp2p:circuit:hop");async function wb(e){const{connection:t,request:n,streamHandler:s,circuit:r,connectionManager:o}=e;if(!r.hopEnabled())return mb("HOP request received but we are not acting as a relay"),s.end({type:jw.Type.STATUS,code:jw.Status.HOP_CANT_SPEAK_RELAY});try{Ww(n,s)}catch(e){return void mb.error("invalid hop request via peer %p %o",t.remotePeer,e)}if(null==n.dstPeer)return void mb("HOP request received but we do not receive a dstPeer");const i=(0,Ht.nu)(n.dstPeer.id),a=o.getConnections(i);if(0===a.length&&!r.hopActive())return mb("HOP request received but we are not connected to the destination peer"),s.end({type:jw.Type.STATUS,code:jw.Status.HOP_NO_CONN_TO_DST});if(0===a.length)return mb("did not have connection to remote peer"),s.end({type:jw.Type.STATUS,code:jw.Status.HOP_NO_CONN_TO_DST});const c={type:jw.Type.STOP,dstPeer:n.dstPeer,srcPeer:n.srcPeer};let l;try{mb("performing STOP request");const e=await async function(e){const{connection:t,request:n,signal:s}=e,r=await t.newStream(qw,{signal:s});gb("starting stop request to %p",t.remotePeer);const o=new yb({stream:r});o.write(n);const i=await o.read();if(null!=i){if(i.code===jw.Status.SUCCESS)return gb("stop request to %p was successful",t.remotePeer),o.rest();gb("stop request failed with code %d",i.code),o.close()}else o.close()}({connection:a[0],request:c});if(null==e)throw new Error("Could not stop");l=e}catch(e){return void mb.error(e)}mb("hop request from %p is valid",t.remotePeer),s.write({type:jw.Type.STATUS,code:jw.Status.SUCCESS});const d=s.rest();return mb("creating related connections"),await no(d,l,d)}var bb=n(85225);const _b=(0,a.vF)("libp2p:circuit");class Eb{constructor(e,t){this._init=t,this.components=e,this._started=!1}isStarted(){return this._started}async start(){this._started||(this._started=!0,await this.components.registrar.handle(qw,(e=>{this._onProtocol(e).catch((e=>{_b.error(e)}))}),{...this._init}).catch((e=>{_b.error(e)})))}async stop(){await this.components.registrar.unhandle(qw)}hopEnabled(){return!0}hopActive(){return!0}get[bb.HR](){return!0}get[Symbol.toStringTag](){return"libp2p/circuit-relay-v1"}async _onProtocol(e){const{connection:t,stream:n}=e,s=new B.TimeoutController(this._init.hop.timeout);try{(0,lw.setMaxListeners)?.(1/0,s.signal)}catch{}try{const e=(0,qp.DG)(n,s.signal),r=new yb({stream:{...n,...e}}),o=await r.read();if(null==o)return _b("request was invalid, could not read from stream"),r.write({type:jw.Type.STATUS,code:jw.Status.MALFORMED_MESSAGE}),void r.close();let i;switch(o.type){case jw.Type.CAN_HOP:_b("received CAN_HOP request from %p",t.remotePeer),await function(e){const{connection:t,streamHandler:n,circuit:s}=e,r=s.hopEnabled();mb("can hop (%s) request from %p",r,t.remotePeer),n.end({type:jw.Type.STATUS,code:r?jw.Status.SUCCESS:jw.Status.HOP_CANT_SPEAK_RELAY})}({circuit:this,connection:t,streamHandler:r});break;case jw.Type.HOP:_b("received HOP request from %p",t.remotePeer),await wb({connection:t,request:o,streamHandler:r,circuit:this,connectionManager:this.components.connectionManager});break;case jw.Type.STOP:_b("received STOP request from %p",t.remotePeer),i=await function(e){const{connection:t,request:n,streamHandler:s}=e;try{Ww(n,s)}catch(e){return void gb.error("invalid stop request via peer %p %o",t.remotePeer,e)}return gb("stop request is valid"),s.write({type:jw.Type.STATUS,code:jw.Status.SUCCESS}),s.rest()}({connection:t,request:o,streamHandler:r});break;default:return _b("Request of type %s not supported",o.type),r.write({type:jw.Type.STATUS,code:jw.Status.MALFORMED_MESSAGE}),void r.close()}if(null!=i){const e=t.remoteAddr.encapsulate("/p2p-circuit").encapsulate((0,j.HZ)(o.dstPeer?.addrs[0])),n=(0,j.HZ)(o.srcPeer?.addrs[0]),s=(0,Kw.e)({stream:i,remoteAddr:e,localAddr:n}),r=o.type===jw.Type.HOP?"relay":"inbound";_b("new %s connection %s",r,s.remoteAddr);const a=await this.components.upgrader.upgradeInbound(s);_b("%s connection %s upgraded",r,s.remoteAddr),null!=this.handler&&this.handler(a)}}finally{s.clear()}}async dial(e,t={}){const n=e.toString().split("/p2p-circuit"),s=(0,j.HZ)(n[0]),r=(0,j.HZ)(n[n.length-1]),o=s.getPeerId(),i=r.getPeerId();if(null==o||null==i){const e="Circuit relay dial failed as addresses did not have peer id";throw _b.error(e),c(new Error(e),nw.ERR_RELAYED_DIAL)}const a=(0,Ht.XL)(o),l=(0,Ht.XL)(i);let d=!1;let u=this.components.connectionManager.getConnections(a)[0];null==u&&(await this.components.peerStore.addressBook.add(a,[s]),u=await this.components.connectionManager.openConnection(a,t),d=!0);try{const n=await async function(e){const{connection:t,request:n,signal:s}=e,r=await t.newStream(qw,{signal:s}),o=new yb({stream:r});o.write(n);const i=await o.read();if(null==i)throw c(new Error("HOP request had no response"),nw.ERR_HOP_REQUEST_FAILED);if(i.code===jw.Status.SUCCESS)return mb("hop request was successful"),o.rest();throw mb("hop request failed with code %d, closing stream",i.code),o.close(),c(new Error(`HOP request failed with code "${i.code??"unknown"}"`),nw.ERR_HOP_REQUEST_FAILED)}({...t,connection:u,request:{type:jw.Type.HOP,srcPeer:{id:this.components.peerId.toBytes(),addrs:this.components.addressManager.getAddresses().map((e=>e.bytes))},dstPeer:{id:l.toBytes(),addrs:[(0,j.HZ)(r).bytes]}}}),o=s.encapsulate(`/p2p-circuit/p2p/${this.components.peerId.toString()}`),i=(0,Kw.e)({stream:n,remoteAddr:e,localAddr:o});return _b("new outbound connection %s",i.remoteAddr),await this.components.upgrader.upgradeOutbound(i)}catch(e){throw _b.error("Circuit relay dial failed",e),d&&await u.close(),e}}createListener(e){return this.handler=e.handler,function(e){const t=new Map,n=Object.assign(new Zh.b,{close:async()=>await Promise.resolve(),listen:async function(s){const r=s.toString().split("/p2p-circuit").find((e=>""!==e)),o=(0,j.HZ)(r),i=o.getPeerId();if(null==i)throw new Error("Could not determine relay peer from multiaddr");const a=(0,Ht.XL)(i);await e.peerStore.addressBook.add(a,[o]);const c=await e.connectionManager.openConnection(a),l=c.remoteAddr.encapsulate("/p2p-circuit");t.set(c.remotePeer.toString(),l),n.dispatchEvent(new Zh.u("listening"))},getAddrs:function(){const e=[];for(const n of t.values())e.push(n);return e}});return e.connectionManager.addEventListener("peer:disconnect",(e=>{const{detail:s}=e;t.delete(s.remotePeer.toString())&&n.dispatchEvent(new Zh.u("close"))})),n}({connectionManager:this.components.connectionManager,peerStore:this.components.peerStore})}filter(e){return(e=Array.isArray(e)?e:[e]).filter((e=>Fr.matches(e)))}}async function vb(e){const t=(new TextEncoder).encode(e),n=await co.sha256.digest(t);return J.TO.createV0(n)}const Sb="hop_relay",kb="true",Rb="/libp2p/relay";var Tb=n(12773);const Ib=(0,a.vF)("libp2p:auto-relay"),Pb=()=>{};class Ab{constructor(e,t){this.components=e,this.addressSorter=t.addressSorter??Tb._,this.maxListeners=t.maxListeners??1,this.listenRelays=new Set,this.onError=t.onError??Pb,this._onProtocolChange=this._onProtocolChange.bind(this),this._onPeerDisconnected=this._onPeerDisconnected.bind(this),this.components.peerStore.addEventListener("change:protocols",(e=>{this._onProtocolChange(e).catch((e=>{Ib.error(e)}))})),this.components.connectionManager.addEventListener("peer:disconnect",this._onPeerDisconnected)}async _onProtocolChange(e){const{peerId:t,protocols:n}=e.detail,s=t.toString();if(null!=n.find((e=>e===qw))){if(!this.listenRelays.has(s))try{const e=this.components.connectionManager.getConnections(t);if(0===e.length)return;const n=e[0];if(n.remoteAddr.protoCodes().includes(290))return void Ib(`relayed connection to ${s} will not be used to hop on`);const r=await async function(e){const{connection:t,signal:n}=e,s=await t.newStream(qw,{signal:n}),r=new yb({stream:s});r.write({type:jw.Type.CAN_HOP});const o=await r.read();return await r.close(),null!=o&&o.code===jw.Status.SUCCESS}({connection:n});r&&(await this.components.peerStore.metadataBook.setValue(t,Sb,(0,x.s)(kb)),await this._addListenRelay(n,s))}catch(e){this.onError(e)}}else this.listenRelays.has(s)&&await this._removeListenRelay(s)}_onPeerDisconnected(e){const t=e.detail.remotePeer.toString();this.listenRelays.has(t)&&this._removeListenRelay(t).catch((e=>{Ib.error(e)}))}async _addListenRelay(e,t){try{if(this.listenRelays.size>=this.maxListeners)return;const n=await no(await this.components.peerStore.addressBook.get(e.remotePeer),(e=>(0,Ow.A)(e,this.addressSorter)),(async e=>await $n(e))),s=await Promise.all(n.map((async t=>{try{let n=t.multiaddr;return null==n.getPeerId()&&(n=n.encapsulate(`/p2p/${e.remotePeer.toString()}`)),n=n.encapsulate("/p2p-circuit"),await this.components.transportManager.listen([n]),!0}catch(e){Ib.error("error listening on circuit address",e),this.onError(e)}return!1})));s.includes(!0)&&this.listenRelays.add(t)}catch(e){this.onError(e),this.listenRelays.delete(t)}}async _removeListenRelay(e){this.listenRelays.delete(e)&&await this._listenOnAvailableHopRelays([e])}async _listenOnAvailableHopRelays(e=[]){if(this.listenRelays.size>=this.maxListeners)return;const t=[],n=await this.components.peerStore.all();for(const{id:s,metadata:r}of n){const n=s.toString();if(this.listenRelays.has(n))continue;if(e.includes(n))continue;const o=r.get(Sb);if(null==o||(0,$.d)(o)!==kb)continue;const i=this.components.connectionManager.getConnections(s);if(0!==i.length){if(await this._addListenRelay(i[0],n),this.listenRelays.size>=this.maxListeners)return}else t.push(s)}for(const e of t)if(await this._tryToListenOnRelay(e),this.listenRelays.size>=this.maxListeners)return;try{const e=await vb(Rb);for await(const t of this.components.contentRouting.findProviders(e)){if(0===t.multiaddrs.length)continue;const e=t.id;if(!e.equals(this.components.peerId)&&(await this.components.peerStore.addressBook.add(e,t.multiaddrs),await this._tryToListenOnRelay(e),this.listenRelays.size>=this.maxListeners))return}}catch(e){this.onError(e)}}async _tryToListenOnRelay(e){try{const t=await this.components.connectionManager.openConnection(e);await this._addListenRelay(t,e.toString())}catch(t){Ib.error("Could not use %p as relay",e,t),this.onError(t,`could not connect and listen on known hop relay ${e.toString()}`)}}}const Db=(0,a.vF)("libp2p:relay");class Ob{constructor(e,t){this.components=e,this.autoRelay=!1!==t.autoRelay?.enabled?new Ab(e,{addressSorter:t.addressSorter,...t.autoRelay}):void 0,this.started=!1,this.init=t,this._advertiseService=this._advertiseService.bind(this)}isStarted(){return this.started}async start(){!1!==this.init.hop.enabled&&!1!==this.init.advertise.enabled&&(this.timeout=(0,cw.setDelayedInterval)(this._advertiseService,this.init.advertise.ttl,this.init.advertise.bootDelay)),this.started=!0}async stop(){null!=this.timeout&&(0,cw.clearDelayedInterval)(this.timeout),this.started=!1}async _advertiseService(){try{const e=await vb(Rb);await this.components.contentRouting.provide(e)}catch(e){e.code===nw.ERR_NO_ROUTERS_AVAILABLE?(Db.error("a content router, such as a DHT, must be provided in order to advertise the relay service",e),await this.stop()):Db.error(e)}}}var Nb=n(42424),Lb=(n(59343),n(12698),n(50276));n(88392);const Mb=Lb.pki;const Cb=(0,a.vF)("libp2p:keychain:cms"),xb=new WeakMap;class Bb{constructor(e,t){if(null==e)throw c(new Error("keychain is required"),nw.ERR_KEYCHAIN_REQUIRED);this.keychain=e,xb.set(this,{dek:t})}async encrypt(e,t){if(!(t instanceof Uint8Array))throw c(new Error("Plain data must be a Uint8Array"),nw.ERR_INVALID_PARAMETERS);const n=await this.keychain.findKeyByName(e),s=await this.keychain.getPrivateKey(e),r=xb.get(this);if(null==r)throw c(new Error("dek missing"),nw.ERR_INVALID_PARAMETERS);const o=r.dek,i=Lb.pki.decryptRsaPrivateKey(s,o),a=await((e,t)=>{const n=Mb.rsa.setPublicKey(t.n,t.e),s=Mb.createCertificate();s.publicKey=n,s.serialNumber="01",s.validity.notBefore=new Date,s.validity.notAfter=new Date,s.validity.notAfter.setFullYear(s.validity.notBefore.getFullYear()+10);const r=[{name:"organizationName",value:"ipfs"},{shortName:"OU",value:"keystore"},{name:"commonName",value:e.id}];return s.setSubject(r),s.setIssuer(r),s.setExtensions([{name:"basicConstraints",cA:!0},{name:"keyUsage",keyCertSign:!0,digitalSignature:!0,nonRepudiation:!0,keyEncipherment:!0,dataEncipherment:!0},{name:"extKeyUsage",serverAuth:!0,clientAuth:!0,codeSigning:!0,emailProtection:!0,timeStamping:!0},{name:"nsCertType",client:!0,server:!0,email:!0,objsign:!0,sslCA:!0,emailCA:!0,objCA:!0}]),s.sign(t),s})(n,i),l=Lb.pkcs7.createEnvelopedData();l.addRecipient(a),l.content=Lb.util.createBuffer(t),l.encrypt();const d=Lb.asn1.toDer(l.toAsn1()).getBytes();return(0,x.s)(d,"ascii")}async decrypt(e){if(!(e instanceof Uint8Array))throw c(new Error("CMS data is required"),nw.ERR_INVALID_PARAMETERS);let t;try{const n=Lb.util.createBuffer((0,$.d)(e,"ascii")),s=Lb.asn1.fromDer(n);t=Lb.pkcs7.messageFromAsn1(s)}catch(e){throw Cb.error(e),c(new Error("Invalid CMS"),nw.ERR_INVALID_CMS)}const n=t.recipients.filter((e=>e.issuer.find((e=>"O"===e.shortName&&"ipfs"===e.value)))).filter((e=>e.issuer.find((e=>"CN"===e.shortName)))).map((e=>({recipient:e,keyId:e.issuer.find((e=>"CN"===e.shortName)).value}))),s=await async function(e,t){const n=e.map(t);return e[(await Promise.all(n)).findIndex((e=>e))]}(n,(async e=>{try{if(null!=await this.keychain.findKeyById(e.keyId))return!0}catch(e){return!1}return!1}));if(null==s){const e=n.map((e=>e.keyId));throw c(new Error(`Decryption needs one of the key(s): ${e.join(", ")}`),nw.ERR_MISSING_KEYS,{missingKeys:e})}const r=await this.keychain.findKeyById(s.keyId);if(null==r)throw c(new Error("No key available to decrypto"),nw.ERR_NO_KEY);const o=await this.keychain.getPrivateKey(r.name),i=xb.get(this);if(null==i)throw c(new Error("dek missing"),nw.ERR_INVALID_PARAMETERS);const a=i.dek,l=Lb.pki.decryptRsaPrivateKey(o,a);return t.decrypt(s.recipient,l),(0,x.s)(t.content.getBytes(),"ascii")}}const zb=(0,a.vF)("libp2p:keychain"),Ub="/info/",Fb=new WeakMap,jb=14,Hb=16,$b=1e3,Vb={dek:{keyLength:64,iterationCount:1e4,salt:"you should override this value with a crypto secure random number",hash:"sha2-512"}};function Kb(e){return null!=e&&("string"==typeof e&&(e===Nb(e.trim())&&e.length>0))}async function qb(){const e=800*Math.random()+200;await new Promise((t=>setTimeout(t,e)))}function Gb(e){return new bt.U("/pkcs8/"+e)}function Wb(e){return new bt.U(Ub+e)}class Yb{constructor(e,t){if(this.components=e,this.init=(0,o.A)(Vb,t),null!=this.init.pass&&this.init.pass?.length<20)throw new Error("pass must be least 20 characters");if(null!=this.init.dek?.keyLength&&this.init.dek.keyLength<jb)throw new Error(`dek.keyLength must be least ${jb} bytes`);if(null!=this.init.dek?.salt?.length&&this.init.dek.salt.length<Hb)throw new Error(`dek.saltLength must be least ${Hb} bytes`);if(null!=this.init.dek?.iterationCount&&this.init.dek.iterationCount<$b)throw new Error(`dek.iterationCount must be least ${$b}`);const n=null!=this.init.pass&&null!=this.init.dek?.salt?(0,Fp.Az)(this.init.pass,this.init.dek?.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";Fb.set(this,{dek:n}),this.started=!1}isStarted(){return this.started}async start(){const e=Wb("self");await this.components.datastore.has(e)||await this.importPeer("self",this.components.peerId),this.started=!0}stop(){this.started=!1}get cms(){const e=Fb.get(this);if(null==e)throw c(new Error("dek missing"),nw.ERR_INVALID_PARAMETERS);const t=e.dek;return new Bb(this,t)}static generateOptions(){const e=Object.assign({},Vb),t=3*Math.ceil(Hb/3);return e.dek.salt=(0,$.d)((0,Fp.po)(t),"base64"),e}static get options(){return Vb}async createKey(e,t,n=2048){if(!Kb(e)||"self"===e)throw await qb(),c(new Error("Invalid key name"),nw.ERR_INVALID_KEY_NAME);if("string"!=typeof t)throw await qb(),c(new Error("Invalid key type"),nw.ERR_INVALID_KEY_TYPE);const s=Gb(e);if(await this.components.datastore.has(s))throw await qb(),c(new Error("Key name already exists"),nw.ERR_KEY_ALREADY_EXISTS);if("rsa"===t.toLowerCase())if(!Number.isSafeInteger(n)||n<2048)throw await qb(),c(new Error("Invalid RSA key size"),nw.ERR_INVALID_KEY_SIZE);let r;try{const o=await(0,Jt.generateKeyPair)(t,n),i=await o.id(),a=Fb.get(this);if(null==a)throw c(new Error("dek missing"),nw.ERR_INVALID_PARAMETERS);const l=a.dek,d=await o.export(l);r={name:e,id:i};const u=this.components.datastore.batch();u.put(s,(0,x.s)(d)),u.put(Wb(e),(0,x.s)(JSON.stringify(r))),await u.commit()}catch(e){throw await qb(),e}return r}async listKeys(){const e={prefix:Ub},t=[];for await(const n of this.components.datastore.query(e))t.push(JSON.parse((0,$.d)(n.value)));return t}async findKeyById(e){try{return(await this.listKeys()).find((t=>t.id===e))}catch(e){throw await qb(),e}}async findKeyByName(e){if(!Kb(e))throw await qb(),c(new Error(`Invalid key name '${e}'`),nw.ERR_INVALID_KEY_NAME);const t=Wb(e);try{const e=await this.components.datastore.get(t);return JSON.parse((0,$.d)(e))}catch(t){throw await qb(),zb.error(t),c(new Error(`Key '${e}' does not exist.`),nw.ERR_KEY_NOT_FOUND)}}async removeKey(e){if(!Kb(e)||"self"===e)throw await qb(),c(new Error(`Invalid key name '${e}'`),nw.ERR_INVALID_KEY_NAME);const t=Gb(e),n=await this.findKeyByName(e),s=this.components.datastore.batch();return s.delete(t),s.delete(Wb(e)),await s.commit(),n}async renameKey(e,t){if(!Kb(e)||"self"===e)throw await qb(),c(new Error(`Invalid old key name '${e}'`),nw.ERR_OLD_KEY_NAME_INVALID);if(!Kb(t)||"self"===t)throw await qb(),c(new Error(`Invalid new key name '${t}'`),nw.ERR_NEW_KEY_NAME_INVALID);const n=Gb(e),s=Gb(t),r=Wb(e),o=Wb(t);if(await this.components.datastore.has(s))throw await qb(),c(new Error(`Key '${t}' already exists`),nw.ERR_KEY_ALREADY_EXISTS);try{const e=await this.components.datastore.get(n),i=await this.components.datastore.get(r),a=JSON.parse((0,$.d)(i));a.name=t;const c=this.components.datastore.batch();return c.put(s,e),c.put(o,(0,x.s)(JSON.stringify(a))),c.delete(n),c.delete(r),await c.commit(),a}catch(e){throw await qb(),e}}async exportKey(e,t){if(!Kb(e))throw await qb(),c(new Error(`Invalid key name '${e}'`),nw.ERR_INVALID_KEY_NAME);if(null==t)throw await qb(),c(new Error("Password is required"),nw.ERR_PASSWORD_REQUIRED);const n=Gb(e);try{const e=await this.components.datastore.get(n),s=(0,$.d)(e),r=Fb.get(this);if(null==r)throw c(new Error("dek missing"),nw.ERR_INVALID_PARAMETERS);const o=r.dek,i=await(0,Jt.importKey)(s,o);return await i.export(t)}catch(e){throw await qb(),e}}async exportPeerId(e){const t="temporary-password",n=await this.exportKey(e,t),s=await(0,Jt.importKey)(n,t);return await(0,Ht.AX)(s.public.bytes,s.bytes)}async importKey(e,t,n){if(!Kb(e)||"self"===e)throw await qb(),c(new Error(`Invalid key name '${e}'`),nw.ERR_INVALID_KEY_NAME);if(null==t)throw await qb(),c(new Error("PEM encoded key is required"),nw.ERR_PEM_REQUIRED);const s=Gb(e);if(await this.components.datastore.has(s))throw await qb(),c(new Error(`Key '${e}' already exists`),nw.ERR_KEY_ALREADY_EXISTS);let r,o;try{r=await(0,Jt.importKey)(t,n)}catch(e){throw await qb(),c(new Error("Cannot read the key, most likely the password is wrong"),nw.ERR_CANNOT_READ_KEY)}try{o=await r.id();const e=Fb.get(this);if(null==e)throw c(new Error("dek missing"),nw.ERR_INVALID_PARAMETERS);const n=e.dek;t=await r.export(n)}catch(e){throw await qb(),e}const i={name:e,id:o},a=this.components.datastore.batch();return a.put(s,(0,x.s)(t)),a.put(Wb(e),(0,x.s)(JSON.stringify(i))),await a.commit(),i}async importPeer(e,t){try{if(!Kb(e))throw c(new Error(`Invalid key name '${e}'`),nw.ERR_INVALID_KEY_NAME);if(null==t)throw c(new Error("PeerId is required"),nw.ERR_MISSING_PRIVATE_KEY);if(null==t.privateKey)throw c(new Error("PeerId.privKey is required"),nw.ERR_MISSING_PRIVATE_KEY);const n=await(0,Jt.unmarshalPrivateKey)(t.privateKey),s=Gb(e);if(await this.components.datastore.has(s))throw await qb(),c(new Error(`Key '${e}' already exists`),nw.ERR_KEY_ALREADY_EXISTS);const r=Fb.get(this);if(null==r)throw c(new Error("dek missing"),nw.ERR_INVALID_PARAMETERS);const o=r.dek,i=await n.export(o),a={name:e,id:t.toString()},l=this.components.datastore.batch();return l.put(s,(0,x.s)(i)),l.put(Wb(e),(0,x.s)(JSON.stringify(a))),await l.commit(),a}catch(e){throw await qb(),e}}async getPrivateKey(e){if(!Kb(e))throw await qb(),c(new Error(`Invalid key name '${e}'`),nw.ERR_INVALID_KEY_NAME);try{const t=Gb(e),n=await this.components.datastore.get(t);return(0,$.d)(n)}catch(t){throw await qb(),zb.error(t),c(new Error(`Key '${e}' does not exist.`),nw.ERR_KEY_NOT_FOUND)}}async rotateKeychainPass(e,t){if("string"!=typeof e)throw await qb(),c(new Error(`Invalid old pass type '${typeof e}'`),nw.ERR_INVALID_OLD_PASS_TYPE);if("string"!=typeof t)throw await qb(),c(new Error(`Invalid new pass type '${typeof t}'`),nw.ERR_INVALID_NEW_PASS_TYPE);if(t.length<20)throw await qb(),c(new Error(`Invalid pass length ${t.length}`),nw.ERR_INVALID_PASS_LENGTH);zb("recreating keychain");const n=Fb.get(this);if(null==n)throw c(new Error("dek missing"),nw.ERR_INVALID_PARAMETERS);const s=n.dek;this.init.pass=t;const r=null!=t&&null!=this.init.dek?.salt?(0,Fp.Az)(t,this.init.dek.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";Fb.set(this,{dek:r});const o=await this.listKeys();for(const e of o){const t=await this.components.datastore.get(Gb(e.name)),n=(0,$.d)(t),o=await(0,Jt.importKey)(n,s),i=r.toString(),a=await o.export(i),c=this.components.datastore.batch(),l={name:e.name,id:e.id};c.put(Gb(e.name),(0,x.s)(a)),c.put(Wb(e.name),(0,x.s)(JSON.stringify(l))),await c.commit()}zb("keychain reconstructed")}}var Xb=n(47655),Qb=n(18151);const Jb=(0,a.vF)("libp2p:transports");class Zb extends Zh.b{constructor(e,t={}){super(),this.components=e,this.started=!1,this.transports=new Map,this.listeners=(0,Qb.n)({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=t.faultTolerance??bb.aF.FATAL_ALL}add(e){const t=e[Symbol.toStringTag];if(null==t)throw c(new Error("Transport must have a valid tag"),nw.ERR_INVALID_KEY);if(this.transports.has(t))throw c(new Error("There is already a transport with this tag"),nw.ERR_DUPLICATE_TRANSPORT);Jb("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}isStarted(){return this.started}async start(){const e=this.components.addressManager.getListenAddrs();await this.listen(e),this.started=!0}async stop(){const e=[];for(const[t,n]of this.listeners)for(Jb("closing listeners for %s",t);n.length>0;){const t=n.pop();null!=t&&e.push(t.close())}await Promise.all(e),Jb("all listeners closed");for(const e of this.listeners.keys())this.listeners.set(e,[]);this.started=!1}async dial(e,t){const n=this.transportForMultiaddr(e);if(null==n)throw c(new Error(`No transport available for address ${String(e)}`),nw.ERR_TRANSPORT_UNAVAILABLE);try{return await n.dial(e,{...t,upgrader:this.components.upgrader})}catch(e){throw null==e.code&&(e.code=nw.ERR_TRANSPORT_DIAL_FAILED),e}}getAddrs(){let e=[];for(const t of this.listeners.values())for(const n of t)e=[...e,...n.getAddrs()];return e}getTransports(){return Array.of(...this.transports.values())}transportForMultiaddr(e){for(const t of this.transports.values()){if(t.filter([e]).length>0)return t}}async listen(e){if(null==e||0===e.length)return void Jb("no addresses were provided for listening, this node is dial only");const t=[];for(const[n,s]of this.transports.entries()){const r=s.filter(e),o=[];for(const e of r){Jb("creating listener for %s on %s",n,e);const t=s.createListener({upgrader:this.components.upgrader});let r=this.listeners.get(n);null==r&&(r=[],this.listeners.set(n,r)),r.push(t),t.addEventListener("listening",(()=>{this.dispatchEvent(new Zh.u("listener:listening",{detail:t}))})),t.addEventListener("close",(()=>{this.dispatchEvent(new Zh.u("listener:close",{detail:t}))})),o.push(t.listen(e))}if(0===o.length){t.push(n);continue}if(null==(await(0,Xb.A)(o)).find((e=>e.isFulfilled))&&this.faultTolerance!==bb.aF.NO_FATAL)throw c(new Error(`Transport (${n}) could not listen on any available address`),nw.ERR_NO_VALID_ADDRESSES)}if(t.length===this.transports.size){const e=`no valid addresses were provided for transports [${t.join(", ")}]`;if(this.faultTolerance===bb.aF.FATAL_ALL)throw c(new Error(e),nw.ERR_NO_VALID_ADDRESSES);Jb(`libp2p in dial mode only: ${e}`)}}async remove(e){Jb("removing %s",e);for(const t of this.listeners.get(e)??[])await t.close();this.transports.delete(e),this.listeners.delete(e)}async removeAll(){const e=[];for(const t of this.transports.keys())e.push(this.remove(t));await Promise.all(e)}}const e_="/multistream/1.0.0",t_=1024,n_=(0,a.vF)("libp2p:mss"),s_=(0,x.s)("\n");function r_(e){const t=new zo.I(e,s_);return ib.single(t)}function o_(e,t,n={}){const s=r_(t);!0===n.writeBytes?e.push(s.subarray()):e.push(s)}async function i_(e,t){const n=await async function(e,t){let n=1;const s={[Symbol.asyncIterator]:()=>s,next:async()=>await e.next(n)};let r=s;null!=t?.signal&&(r=(0,qp.IV)(s,t.signal));const o=await no(r,ub({onLength:e=>{n=e},maxDataLength:t_}),(async e=>await(0,sc.A)(e)));if(null==o||0===o.length)throw c(new Error("no buffer returned"),"ERR_INVALID_MULTISTREAM_SELECT_MESSAGE");if(o.get(o.byteLength-1)!==s_[0])throw n_.error("Invalid mss message - missing newline - %s",o.subarray()),c(new Error("missing newline"),"ERR_INVALID_MULTISTREAM_SELECT_MESSAGE");return o.sublist(0,-1)}(e,t);return(0,$.d)(n.subarray())}const a_=(0,a.vF)("libp2p:mss:select");async function c_(e,t,n={}){t=Array.isArray(t)?[...t]:[t];const{reader:s,writer:r,rest:o,stream:i}=pb(e),a=t.shift();if(null==a)throw new Error("At least one protocol must be specified");a_('select: write ["%s", "%s"]',e_,a);!function(e,t,n={}){const s=new zo.I;for(const e of t)s.append(r_(e));!0===n.writeBytes?e.push(s.subarray()):e.push(s)}(r,[(0,x.s)(e_),(0,x.s)(a)],n);let l=await i_(s,n);if(a_('select: read "%s"',l),l===e_&&(l=await i_(s,n),a_('select: read "%s"',l)),l===a)return o(),{stream:i,protocol:a};for(const e of t){a_('select: write "%s"',e),o_(r,(0,x.s)(e),n);const t=await i_(s,n);if(a_('select: read "%s" for "%s"',t,e),t===e)return o(),{stream:i,protocol:e}}throw o(),c(new Error("protocol selection failed"),"ERR_UNSUPPORTED_PROTOCOL")}const l_=(0,a.vF)("libp2p:mss:handle");async function d_(e,t,n){t=Array.isArray(t)?t:[t];const{writer:s,reader:r,rest:o,stream:i}=pb(e);for(;;){const e=await i_(r,n);if(l_('read "%s"',e),e!==e_){if(t.includes(e))return o_(s,(0,x.s)(e),n),l_('respond with "%s" for "%s"',e,e),o(),{stream:i,protocol:e};"ls"!==e?(o_(s,(0,x.s)("na"),n),l_('respond with "na" for "%s"',e)):(o_(s,new zo.I(...t.map((e=>r_((0,x.s)(e))))),n),l_('respond with "%s" for %s',t,e))}else l_('respond with "%s" for "%s"',e_,e),o_(s,(0,x.s)(e_),n)}}var u_=n(96046);const h_=(0,a.vF)("libp2p:connection");class p_{constructor(e){const{remoteAddr:t,remotePeer:n,newStream:s,close:r,getStreams:o,stat:i}=e;this.id=`${parseInt(String(1e9*Math.random())).toString(36)}${Date.now()}`,this.remoteAddr=t,this.remotePeer=n,this.stat={...i,status:bw.vP},this._newStream=s,this._close=r,this._getStreams=o,this.tags=[],this._closing=!1}get[Symbol.toStringTag](){return"Connection"}get[u_.H](){return!0}get streams(){return this._getStreams()}async newStream(e,t){if(this.stat.status===bw.qc)throw c(new Error("the connection is being closed"),"ERR_CONNECTION_BEING_CLOSED");if(this.stat.status===bw.V)throw c(new Error("the connection is closed"),"ERR_CONNECTION_CLOSED");Array.isArray(e)||(e=[e]);const n=await this._newStream(e,t);return n.stat.direction="outbound",n}addStream(e){e.stat.direction="inbound"}removeStream(e){}async close(){if(this.stat.status!==bw.V&&!this._closing){this.stat.status=bw.qc;try{this.streams.forEach((e=>e.close()))}catch(e){h_.error(e)}this._closing=!0,await this._close(),this._closing=!1,this.stat.timeline.close=Date.now(),this.stat.status=bw.V}}}var f_=n(53499);const y_=(0,a.vF)("libp2p:registrar");class g_{constructor(e){this.topologies=new Map,this.handlers=new Map,this.components=e,this._onDisconnect=this._onDisconnect.bind(this),this._onProtocolChange=this._onProtocolChange.bind(this),this._onConnect=this._onConnect.bind(this),this.components.connectionManager.addEventListener("peer:disconnect",this._onDisconnect),this.components.connectionManager.addEventListener("peer:connect",this._onConnect),this.components.peerStore.addEventListener("change:protocols",this._onProtocolChange)}getProtocols(){return Array.from(new Set([...this.topologies.keys(),...this.handlers.keys()])).sort()}getHandler(e){const t=this.handlers.get(e);if(null==t)throw c(new Error(`No handler registered for protocol ${e}`),nw.ERR_NO_HANDLER_FOR_PROTOCOL);return t}getTopologies(e){const t=this.topologies.get(e);return null==t?[]:[...t.values()]}async handle(e,t,n){if(this.handlers.has(e))throw c(new Error(`Handler already registered for protocol ${e}`),nw.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED);const s=o.A.bind({ignoreUndefined:!0})({maxInboundStreams:32,maxOutboundStreams:64},n);this.handlers.set(e,{handler:t,options:s}),await this.components.peerStore.protoBook.add(this.components.peerId,[e])}async unhandle(e){const t=Array.isArray(e)?e:[e];t.forEach((e=>{this.handlers.delete(e)})),await this.components.peerStore.protoBook.remove(this.components.peerId,t)}async register(e,t){if(!(0,f_.g)(t))throw y_.error("topology must be an instance of interfaces/topology"),c(new Error("topology must be an instance of interfaces/topology"),nw.ERR_INVALID_PARAMETERS);const n=`${(1e9*Math.random()).toString(36)}${Date.now()}`;let s=this.topologies.get(e);return null==s&&(s=new Map,this.topologies.set(e,s)),s.set(n,t),await t.setRegistrar(this),n}unregister(e){for(const[t,n]of this.topologies.entries())n.has(e)&&(n.delete(e),0===n.size&&this.topologies.delete(t))}_onDisconnect(e){const t=e.detail;this.components.peerStore.protoBook.get(t.remotePeer).then((e=>{for(const n of e){const e=this.topologies.get(n);if(null!=e)for(const n of e.values())n.onDisconnect(t.remotePeer)}})).catch((e=>{y_.error(e)}))}_onConnect(e){const t=e.detail;this.components.peerStore.protoBook.get(t.remotePeer).then((e=>{for(const n of e){const e=this.topologies.get(n);if(null!=e)for(const n of e.values())n.onConnect(t.remotePeer,t)}})).catch((e=>{y_.error(e)}))}_onProtocolChange(e){const{peerId:t,protocols:n,oldProtocols:s}=e.detail,r=s.filter((e=>!n.includes(e))),o=n.filter((e=>!s.includes(e)));for(const e of r){const n=this.topologies.get(e);if(null!=n)for(const e of n.values())e.onDisconnect(t)}for(const e of o){const n=this.topologies.get(e);if(null!=n)for(const e of n.values()){const n=this.components.connectionManager.getConnections(t)[0];null!=n&&e.onConnect(t,n)}}}}const m_=(0,a.vF)("libp2p:upgrader");function w_(e,t,n){let s=0;return n.streams.forEach((n=>{n.stat.direction===t&&n.stat.protocol===e&&s++})),s}class b_ extends Zh.b{constructor(e,t){super(),this.components=e,this.connectionEncryption=new Map,t.connectionEncryption.forEach((e=>{this.connectionEncryption.set(e.protocol,e)})),this.muxers=new Map,t.muxers.forEach((e=>{this.muxers.set(e.protocol,e)})),this.inboundUpgradeTimeout=t.inboundUpgradeTimeout}async upgradeInbound(e,t){if(!await this.components.connectionManager.acceptIncomingConnection(e))throw c(new Error("connection denied"),nw.ERR_CONNECTION_DENIED);let n,s,r,o,i;const a=new B.TimeoutController(this.inboundUpgradeTimeout);try{(0,lw.setMaxListeners)?.(1/0,a.signal)}catch{}try{const l=(0,qp.DG)(e,a.signal);if(e.source=l.source,e.sink=l.sink,await this.components.connectionGater.denyInboundConnection(e))throw c(new Error("The multiaddr connection is blocked by gater.acceptConnection"),nw.ERR_CONNECTION_INTERCEPTED);this.components.metrics?.trackMultiaddrConnection(e),m_("starting the inbound connection upgrade");let d=e;if(!0!==t?.skipProtection){const t=this.components.connectionProtector;null!=t&&(m_("protecting the inbound connection"),d=await t.protect(e))}try{if(n=d,!0!==t?.skipEncryption){if(({conn:n,remotePeer:s,protocol:i}=await this._encryptInbound(d)),await this.components.connectionGater.denyInboundEncryptedConnection(s,{...d,...n}))throw c(new Error("The multiaddr connection is blocked by gater.acceptEncryptedConnection"),nw.ERR_CONNECTION_INTERCEPTED)}else{const t=e.remoteAddr.getPeerId();if(null==t)throw c(new Error("inbound connection that skipped encryption must have a peer id"),nw.ERR_INVALID_MULTIADDR);const n=(0,Ht.XL)(t);i="native",s=n}if(r=n,null!=t?.muxerFactory)o=t.muxerFactory;else if(this.muxers.size>0){const e=await this._multiplexInbound({...d,...n},this.muxers);o=e.muxerFactory,r=e.stream}}catch(e){throw m_.error("Failed to upgrade inbound connection",e),e}if(await this.components.connectionGater.denyInboundUpgradedConnection(s,{...d,...n}))throw c(new Error("The multiaddr connection is blocked by gater.acceptEncryptedConnection"),nw.ERR_CONNECTION_INTERCEPTED);return m_("Successfully upgraded inbound connection"),this._createConnection({cryptoProtocol:i,direction:"inbound",maConn:e,upgradedConn:r,muxerFactory:o,remotePeer:s})}finally{this.components.connectionManager.afterUpgradeInbound(),a.clear()}}async upgradeOutbound(e,t){const n=e.remoteAddr.getPeerId();let s,r,o,i,a,l;if(null!=n&&(s=(0,Ht.XL)(n),await this.components.connectionGater.denyOutboundConnection(s,e)))throw c(new Error("The multiaddr connection is blocked by connectionGater.denyOutboundConnection"),nw.ERR_CONNECTION_INTERCEPTED);this.components.metrics?.trackMultiaddrConnection(e),m_("Starting the outbound connection upgrade");let d=e;if(!0!==t?.skipProtection){const t=this.components.connectionProtector;null!=t&&(d=await t.protect(e))}try{if(r=d,!0!==t?.skipEncryption){if(({conn:r,remotePeer:o,protocol:a}=await this._encryptOutbound(d,s)),await this.components.connectionGater.denyOutboundEncryptedConnection(o,{...d,...r}))throw c(new Error("The multiaddr connection is blocked by gater.acceptEncryptedConnection"),nw.ERR_CONNECTION_INTERCEPTED)}else{if(null==s)throw c(new Error("Encryption was skipped but no peer id was passed"),nw.ERR_INVALID_PEER);a="native",o=s}if(i=r,null!=t?.muxerFactory)l=t.muxerFactory;else if(this.muxers.size>0){const e=await this._multiplexOutbound({...d,...r},this.muxers);l=e.muxerFactory,i=e.stream}}catch(t){throw m_.error("Failed to upgrade outbound connection",t),await e.close(t),t}if(await this.components.connectionGater.denyOutboundUpgradedConnection(o,{...d,...r}))throw c(new Error("The multiaddr connection is blocked by gater.acceptEncryptedConnection"),nw.ERR_CONNECTION_INTERCEPTED);return m_("Successfully upgraded outbound connection"),this._createConnection({cryptoProtocol:a,direction:"outbound",maConn:e,upgradedConn:i,muxerFactory:l,remotePeer:o})}_createConnection(e){const{cryptoProtocol:t,direction:n,maConn:s,upgradedConn:r,remotePeer:o,muxerFactory:i}=e;let a,l,d;null!=i&&(a=i.createStreamMuxer({direction:n,onIncomingStream:e=>{null!=d&&Promise.resolve().then((async()=>{const t=this.components.registrar.getProtocols(),{stream:s,protocol:r}=await d_(e,t);if(m_("%s: incoming stream opened on %s",n,r),null==d)return;const i=function(e,t){try{const{options:n}=t.getHandler(e);return n.maxInboundStreams}catch(e){if(e.code!==nw.ERR_NO_HANDLER_FOR_PROTOCOL)throw e}return 32}(r,this.components.registrar);w_(r,"inbound",d)!==i?(e.source=s.source,e.sink=s.sink,e.stat.protocol=r,this.components.peerStore.protoBook.add(o,[r]).catch((e=>m_.error(e))),d.addStream(e),this.components.metrics?.trackProtocolStream(e,d),this._onStream({connection:d,stream:e,protocol:r})):e.abort(c(new Error(`Too many inbound protocol streams for protocol "${r}" - limit ${i}`),nw.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS))})).catch((t=>{m_.error(t),null==e.stat.timeline.close&&e.close()}))},onStreamEnd:e=>{d?.removeStream(e.id)}}),l=async(e,t={})=>{if(null==a)throw c(new Error("Stream is not multiplexed"),nw.ERR_MUXER_UNAVAILABLE);m_("%s: starting new stream on %s",n,e);const s=await a.newStream();let r;try{if(null==t.signal){m_("No abort signal was passed while trying to negotiate protocols %s falling back to default timeout",e),r=new B.TimeoutController(3e4),t.signal=r.signal;try{(0,lw.setMaxListeners)?.(1/0,r.signal)}catch{}}const{stream:n,protocol:i}=await c_(s,e,t),a=function(e,t){try{const{options:n}=t.getHandler(e);return n.maxOutboundStreams}catch(e){if(e.code!==nw.ERR_NO_HANDLER_FOR_PROTOCOL)throw e}return 64}(i,this.components.registrar);if(w_(i,"outbound",d)===a){const e=c(new Error(`Too many outbound protocol streams for protocol "${i}" - limit ${a}`),nw.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS);throw s.abort(e),e}return this.components.peerStore.protoBook.add(o,[i]).catch((e=>m_.error(e))),s.source=n.source,s.sink=n.sink,s.stat.protocol=i,this.components.metrics?.trackProtocolStream(s,d),s}catch(e){if(m_.error("could not create new stream",e),null==s.stat.timeline.close&&s.close(),null!=e.code)throw e;throw c(e,nw.ERR_UNSUPPORTED_PROTOCOL)}finally{null!=r&&r.clear()}},Promise.all([a.sink(r.source),r.sink(a.source)]).catch((e=>{m_.error(e)})));const u=s.timeline;s.timeline=new Proxy(u,{set:(...e)=>(null!=d&&"close"===e[1]&&null!=e[2]&&null==u.close&&(async()=>{try{"OPEN"===d.stat.status&&await d.close()}catch(e){m_.error(e)}finally{this.dispatchEvent(new Zh.u("connectionEnd",{detail:d}))}})().catch((e=>{m_.error(e)})),Reflect.set(...e))}),s.timeline.upgraded=Date.now();const h=()=>{throw c(new Error("connection is not multiplexed"),nw.ERR_CONNECTION_NOT_MULTIPLEXED)};var p;return p={remoteAddr:s.remoteAddr,remotePeer:o,stat:{status:"OPEN",direction:n,timeline:s.timeline,multiplexer:a?.protocol,encryption:t},newStream:l??h,getStreams:()=>null!=a?a.streams:h(),close:async()=>{await s.close(),null!=a&&a.close()}},d=new p_(p),this.dispatchEvent(new Zh.u("connection",{detail:d})),d}_onStream(e){const{connection:t,stream:n,protocol:s}=e,{handler:r}=this.components.registrar.getHandler(s);r({connection:t,stream:n})}async _encryptInbound(e){const t=Array.from(this.connectionEncryption.keys());m_("handling inbound crypto protocol selection",t);try{const{stream:n,protocol:s}=await d_(e,t,{writeBytes:!0}),r=this.connectionEncryption.get(s);if(null==r)throw new Error(`no crypto module found for ${s}`);return m_("encrypting inbound connection..."),{...await r.secureInbound(this.components.peerId,n),protocol:s}}catch(e){throw c(e,nw.ERR_ENCRYPTION_FAILED)}}async _encryptOutbound(e,t){const n=Array.from(this.connectionEncryption.keys());m_("selecting outbound crypto protocol",n);try{const{stream:s,protocol:r}=await c_(e,n,{writeBytes:!0}),o=this.connectionEncryption.get(r);if(null==o)throw new Error(`no crypto module found for ${r}`);return m_("encrypting outbound connection to %p",t),{...await o.secureOutbound(this.components.peerId,s,t),protocol:r}}catch(e){throw c(e,nw.ERR_ENCRYPTION_FAILED)}}async _multiplexOutbound(e,t){const n=Array.from(t.keys());m_("outbound selecting muxer %s",n);try{const{stream:s,protocol:r}=await c_(e,n,{writeBytes:!0});m_("%s selected as muxer protocol",r);return{stream:s,muxerFactory:t.get(r)}}catch(e){throw m_.error("error multiplexing outbound stream",e),c(e,nw.ERR_MUXER_UNAVAILABLE)}}async _multiplexInbound(e,t){const n=Array.from(t.keys());m_("inbound handling muxers %s",n);try{const{stream:s,protocol:r}=await d_(e,n,{writeBytes:!0});return{stream:s,muxerFactory:t.get(r)}}catch(e){throw m_.error("error multiplexing inbound stream",e),c(e,nw.ERR_MUXER_UNAVAILABLE)}}}var __;!function(e){let t;e.codec=()=>(null==t&&(t=Vw(((e,t,n={})=>{if(!1!==n.lengthDelimited&&t.fork(),null!=e.protocolVersion&&(t.uint32(42),t.string(e.protocolVersion)),null!=e.agentVersion&&(t.uint32(50),t.string(e.agentVersion)),null!=e.publicKey&&(t.uint32(10),t.bytes(e.publicKey)),null!=e.listenAddrs)for(const n of e.listenAddrs)t.uint32(18),t.bytes(n);if(null!=e.observedAddr&&(t.uint32(34),t.bytes(e.observedAddr)),null!=e.protocols)for(const n of e.protocols)t.uint32(26),t.string(n);null!=e.signedPeerRecord&&(t.uint32(66),t.bytes(e.signedPeerRecord)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={listenAddrs:[],protocols:[]},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();switch(t>>>3){case 5:n.protocolVersion=e.string();break;case 6:n.agentVersion=e.string();break;case 1:n.publicKey=e.bytes();break;case 2:n.listenAddrs.push(e.bytes());break;case 4:n.observedAddr=e.bytes();break;case 3:n.protocols.push(e.string());break;case 8:n.signedPeerRecord=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>Uw(t,e.codec()),e.decode=t=>zw(t,e.codec())}(__||(__={}));const E_="0.0.0",v_=`js-libp2p/${E_}`,S_=(0,a.vF)("libp2p:identify");class k_{constructor(e,t){this.components=e,this.started=!1,this.init=t,this.identifyProtocolStr=`/${t.protocolPrefix}/id/1.0.0`,this.identifyPushProtocolStr=`/${t.protocolPrefix}/id/push/1.0.0`,this.host={protocolVersion:`${t.protocolPrefix}/0.1.0`,...t.host},this.components.connectionManager.addEventListener("peer:connect",(e=>{const t=e.detail;this.identify(t).catch(S_.error)})),this.components.peerStore.addEventListener("change:multiaddrs",(e=>{const{peerId:t}=e.detail;this.components.peerId.equals(t)&&this.pushToPeerStore().catch((e=>S_.error(e)))})),this.components.peerStore.addEventListener("change:protocols",(e=>{const{peerId:t}=e.detail;this.components.peerId.equals(t)&&this.pushToPeerStore().catch((e=>S_.error(e)))}))}isStarted(){return this.started}async start(){this.started||(await this.components.peerStore.metadataBook.setValue(this.components.peerId,"AgentVersion",(0,x.s)(this.host.agentVersion)),await this.components.peerStore.metadataBook.setValue(this.components.peerId,"ProtocolVersion",(0,x.s)(this.host.protocolVersion)),await this.components.registrar.handle(this.identifyProtocolStr,(e=>{this._handleIdentify(e).catch((e=>{S_.error(e)}))}),{maxInboundStreams:this.init.maxInboundStreams,maxOutboundStreams:this.init.maxOutboundStreams}),await this.components.registrar.handle(this.identifyPushProtocolStr,(e=>{this._handlePush(e).catch((e=>{S_.error(e)}))}),{maxInboundStreams:this.init.maxPushIncomingStreams,maxOutboundStreams:this.init.maxPushOutgoingStreams}),this.started=!0)}async stop(){await this.components.registrar.unhandle(this.identifyProtocolStr),await this.components.registrar.unhandle(this.identifyPushProtocolStr),this.started=!1}async push(e){const t=await this.components.peerStore.addressBook.getRawEnvelope(this.components.peerId),n=this.components.addressManager.getAddresses().map((e=>e.bytes)),s=await this.components.peerStore.protoBook.get(this.components.peerId),r=e.map((async e=>{let r;const o=new B.TimeoutController(this.init.timeout);try{(0,lw.setMaxListeners)?.(1/0,o.signal)}catch{}try{r=await e.newStream([this.identifyPushProtocolStr],{signal:o.signal});const i=(0,qp.DG)(r,o.signal);await i.sink(no([__.encode({listenAddrs:n,signedPeerRecord:t,protocols:s})],ib()))}catch(e){S_.error("could not push identify update to peer",e)}finally{null!=r&&r.close(),o.clear()}}));await Promise.all(r)}async pushToPeerStore(){if(!this.isStarted())return;const e=[];for(const t of this.components.connectionManager.getConnections()){const n=t.remotePeer;(await this.components.peerStore.get(n)).protocols.includes(this.identifyPushProtocolStr)&&e.push(t)}await this.push(e)}async _identify(e,t={}){let n,s,r=t.signal;if(null==r){n=new B.TimeoutController(this.init.timeout),r=n.signal;try{(0,lw.setMaxListeners)?.(1/0,n.signal)}catch{}}try{s=await e.newStream([this.identifyProtocolStr],{signal:r});const t=(0,qp.DG)(s,r),n=await no([],t,ub({maxDataLength:this.init.maxIdentifyMessageSize??8192}),(async e=>await(0,sc.A)(e)));if(null==n)throw c(new Error("No data could be retrieved"),nw.ERR_CONNECTION_ENDED);try{return __.decode(n)}catch(e){throw c(e,nw.ERR_INVALID_MESSAGE)}}finally{null!=n&&n.clear(),null!=s&&s.close()}}async identify(e,t={}){const n=await this._identify(e,t),{publicKey:s,listenAddrs:r,protocols:o,observedAddr:i,signedPeerRecord:a,agentVersion:l,protocolVersion:d}=n;if(null==s)throw c(new Error("public key was missing from identify message"),nw.ERR_MISSING_PUBLIC_KEY);const u=await(0,Ht.AX)(s);if(!e.remotePeer.equals(u))throw c(new Error("identified peer does not match the expected peer"),nw.ERR_INVALID_PEER);if(this.components.peerId.equals(u))throw c(new Error("identified peer is our own peer id?"),nw.ERR_INVALID_PEER);const h=k_.getCleanMultiaddr(i);if(null!=a){S_("received signed peer record from %p",u);try{const e=await Qh.e.openAndCertify(a,Qh.c.DOMAIN);if(!e.peerId.equals(u))throw c(new Error("identified peer does not match the expected peer"),nw.ERR_INVALID_PEER);if(await this.components.peerStore.addressBook.consumePeerRecord(e))return await this.components.peerStore.protoBook.set(u,o),null!=l&&await this.components.peerStore.metadataBook.setValue(u,"AgentVersion",(0,x.s)(l)),null!=d&&await this.components.peerStore.metadataBook.setValue(u,"ProtocolVersion",(0,x.s)(d)),void S_("identify completed for peer %p and protocols %o",u,o)}catch(e){S_("received invalid envelope, discard it and fallback to listenAddrs is available",e)}}else S_("no signed peer record received from %p",u);S_("falling back to legacy addresses from %p",u);try{await this.components.peerStore.addressBook.set(u,r.map((e=>(0,j.HZ)(e))))}catch(e){S_.error("received invalid addrs",e)}await this.components.peerStore.protoBook.set(u,o),null!=l&&await this.components.peerStore.metadataBook.setValue(u,"AgentVersion",(0,x.s)(l)),null!=d&&await this.components.peerStore.metadataBook.setValue(u,"ProtocolVersion",(0,x.s)(d)),S_("identify completed for peer %p and protocols %o",u,o),S_("received observed address of %s",h?.toString())}async _handleIdentify(e){const{connection:t,stream:n}=e,s=new B.TimeoutController(this.init.timeout);try{(0,lw.setMaxListeners)?.(1/0,s.signal)}catch{}try{const e=this.components.peerId.publicKey??new Uint8Array(0),r=await this.components.peerStore.get(this.components.peerId),o=this.components.addressManager.getAddresses().map((e=>e.decapsulateCode((0,j.WH)("p2p").code)));let i=r.peerRecordEnvelope;if(o.length>0&&null==i){const e=new Qh.c({peerId:this.components.peerId,multiaddrs:o}),t=await Qh.e.seal(e,this.components.peerId);await this.components.peerStore.addressBook.consumePeerRecord(t),i=t.marshal().subarray()}const a=__.encode({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:e,listenAddrs:o.map((e=>e.bytes)),signedPeerRecord:i,observedAddr:t.remoteAddr.bytes,protocols:r.protocols}),c=(0,qp.DG)(n,s.signal),l=no([a],ib());await c.sink(l)}catch(e){S_.error("could not respond to identify request",e)}finally{n.close(),s.clear()}}async _handlePush(e){const{connection:t,stream:n}=e,s=new B.TimeoutController(this.init.timeout);try{(0,lw.setMaxListeners)?.(1/0,s.signal)}catch{}let r;try{const e=(0,qp.DG)(n,s.signal),t=await no([],e,ub({maxDataLength:this.init.maxIdentifyMessageSize??8192}),(async e=>await(0,sc.A)(e)));null!=t&&(r=__.decode(t))}catch(e){return S_.error("received invalid message",e)}finally{n.close(),s.clear()}if(null==r)return S_.error("received invalid message");const o=t.remotePeer;if(this.components.peerId.equals(o))S_("received push from ourselves?");else{if(S_("received push from %p",o),null!=r.signedPeerRecord){S_("received signedPeerRecord in push");try{const e=await Qh.e.openAndCertify(r.signedPeerRecord,Qh.c.DOMAIN);if(await this.components.peerStore.addressBook.consumePeerRecord(e))return S_("consumed signedPeerRecord sent in push"),void await this.components.peerStore.protoBook.set(o,r.protocols);S_("failed to consume signedPeerRecord sent in push")}catch(e){S_("received invalid envelope, discard it and fallback to listenAddrs is available",e)}}else S_("did not receive signedPeerRecord in push");try{await this.components.peerStore.addressBook.set(o,r.listenAddrs.map((e=>(0,j.HZ)(e))))}catch(e){S_.error("received invalid addrs",e)}try{await this.components.peerStore.protoBook.set(o,r.protocols)}catch(e){S_.error("received invalid protocols",e)}S_("handled push from %p",o)}}static getCleanMultiaddr(e){if(null!=e&&e.length>0)try{return(0,j.HZ)(e)}catch{}}}var R_,T_;!function(e){let t;e.codec=()=>(null==t&&(t=Vw(((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),!0!==n.writeDefaults&&""===e.identifier||(t.uint32(10),t.string(e.identifier)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={identifier:""},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();if(t>>>3==1)n.identifier=e.string();else e.skipType(7&t)}return n}))),t),e.encode=t=>Uw(t,e.codec()),e.decode=t=>zw(t,e.codec())}(R_||(R_={})),function(e){let t,n,s;!function(e){e.OK="OK",e.NOT_FOUND="NOT_FOUND",e.ERROR="ERROR"}(t=e.StatusCode||(e.StatusCode={})),function(e){e[e.OK=0]="OK",e[e.NOT_FOUND=1]="NOT_FOUND",e[e.ERROR=2]="ERROR"}(n||(n={})),function(e){e.codec=()=>$w(n)}(t=e.StatusCode||(e.StatusCode={})),e.codec=()=>(null==s&&(s=Vw(((t,s,r={})=>{!1!==r.lengthDelimited&&s.fork(),(!0===r.writeDefaults||null!=t.status&&0!==n[t.status])&&(s.uint32(8),e.StatusCode.codec().encode(t.status,s)),(!0===r.writeDefaults||null!=t.data&&t.data.byteLength>0)&&(s.uint32(18),s.bytes(t.data)),!1!==r.lengthDelimited&&s.ldelim()}),((n,s)=>{const r={status:t.OK,data:new Uint8Array(0)},o=null==s?n.len:n.pos+s;for(;n.pos<o;){const t=n.uint32();switch(t>>>3){case 1:r.status=e.StatusCode.codec().decode(n);break;case 2:r.data=n.bytes();break;default:n.skipType(7&t)}}return r}))),s),e.encode=t=>Uw(t,e.codec()),e.decode=t=>zw(t,e.codec())}(T_||(T_={}));const I_=(0,a.vF)("libp2p:fetch");class P_{constructor(e,t){this.started=!1,this.components=e,this.protocol=`/${t.protocolPrefix??"libp2p"}/fetch/0.0.1`,this.lookupFunctions=new Map,this.handleMessage=this.handleMessage.bind(this),this.init=t}async start(){await this.components.registrar.handle(this.protocol,(e=>{this.handleMessage(e).catch((e=>{I_.error(e)})).finally((()=>{e.stream.close()}))}),{maxInboundStreams:this.init.maxInboundStreams,maxOutboundStreams:this.init.maxOutboundStreams}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}async fetch(e,t,n={}){I_("dialing %s to %p",this.protocol,e);const s=await this.components.connectionManager.openConnection(e,n);let r,o,i=n.signal;if(null==i){I_("using default timeout of %d ms",this.init.timeout),r=new B.TimeoutController(this.init.timeout),i=r.signal;try{(0,lw.setMaxListeners)?.(1/0,r.signal)}catch{}}try{o=await s.newStream(this.protocol,{signal:i});const e=(0,qp.DG)(o,i);I_("fetch %s",t);const n=await no([R_.encode({identifier:t})],ib(),e,ub(),(async function(e){const n=await(0,sc.A)(e);if(null==n)throw c(new Error("No data received"),nw.ERR_INVALID_MESSAGE);const s=T_.decode(n);switch(s.status){case T_.StatusCode.OK:return I_("received status for %s ok",t),s.data;case T_.StatusCode.NOT_FOUND:return I_("received status for %s not found",t),null;case T_.StatusCode.ERROR:{I_("received status for %s error",t);const e=(0,$.d)(s.data);throw c(new Error("Error in fetch protocol response: "+e),nw.ERR_INVALID_PARAMETERS)}default:throw I_("received status for %s unknown",t),c(new Error("Unknown response status"),nw.ERR_INVALID_MESSAGE)}}));return n??null}finally{null!=r&&r.clear(),null!=o&&o.close()}}async handleMessage(e){const{stream:t}=e,n=this;await no(t,ub(),(async function*(e){const t=await(0,sc.A)(e);if(null==t)throw c(new Error("No data received"),nw.ERR_INVALID_MESSAGE);const s=R_.decode(t);let r;const o=n._getLookupFunction(s.identifier);if(null!=o){I_("look up data with identifier %s",s.identifier);const e=await o(s.identifier);null!=e?(I_("sending status for %s ok",s.identifier),r={status:T_.StatusCode.OK,data:e}):(I_("sending status for %s not found",s.identifier),r={status:T_.StatusCode.NOT_FOUND,data:new Uint8Array(0)})}else{I_("sending status for %s error",s.identifier);const e=(0,x.s)(`No lookup function registered for key: ${s.identifier}`);r={status:T_.StatusCode.ERROR,data:e}}yield T_.encode(r)}),ib(),t)}_getLookupFunction(e){for(const t of this.lookupFunctions.keys())if(e.startsWith(t))return this.lookupFunctions.get(t)}registerLookupFunction(e,t){if(this.lookupFunctions.has(e))throw c(new Error("Fetch protocol handler for key prefix '"+e+"' already registered"),nw.ERR_KEY_ALREADY_EXISTS);this.lookupFunctions.set(e,t)}unregisterLookupFunction(e,t){if(null!=t){if(this.lookupFunctions.get(e)!==t)return}this.lookupFunctions.delete(e)}}const A_=(0,a.vF)("libp2p:ping");class D_{constructor(e,t){this.components=e,this.started=!1,this.protocol=`/${t.protocolPrefix}/ping/1.0.0`,this.init=t}async start(){await this.components.registrar.handle(this.protocol,this.handleMessage,{maxInboundStreams:this.init.maxInboundStreams,maxOutboundStreams:this.init.maxOutboundStreams}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}handleMessage(e){const{stream:t}=e;no(t,t).catch((e=>{A_.error(e)}))}async ping(e,t={}){A_("dialing %s to %p",this.protocol,e);const n=Date.now(),s=(0,Fp.po)(32),r=await this.components.connectionManager.openConnection(e,t);let o,i,a=t.signal;if(null==a){o=new B.TimeoutController(this.init.timeout),a=o.signal;try{(0,lw.setMaxListeners)?.(1/0,o.signal)}catch{}}try{i=await r.newStream([this.protocol],{signal:a});const e=(0,qp.DG)(i,a),t=await no([s],e,(async e=>await(0,sc.A)(e))),o=Date.now();if(null==t||!(0,ve.a)(s,t.subarray()))throw c(new Error("Received wrong ping ack"),nw.ERR_WRONG_PING_ACK);return o-n}finally{null!=o&&o.clear(),null!=i&&i.close()}}}var O_=n(14470),N_=n(34967),L_=n(63044);const M_=(0,a.vF)("libp2p:nat"),C_=7200;function x_(e=1024,t=65535){return Math.floor(Math.random()*(t-e+1)+e)}class B_{constructor(e,t){if(this.components=e,this.started=!1,this.enabled=t.enabled,this.externalAddress=t.externalAddress,this.localAddress=t.localAddress,this.description=t.description??`libp2p@${E_} ${this.components.peerId.toString()}`,this.ttl=t.ttl??C_,this.keepAlive=t.keepAlive??!0,this.gateway=t.gateway,this.ttl<C_)throw c(new Error("NatManager ttl should be at least 7200 seconds"),nw.ERR_INVALID_PARAMETERS)}isStarted(){return this.started}start(){}afterStart(){O_.Bd||!this.enabled||this.started||(this.started=!0,this._start().catch((e=>{M_.error(e)})))}async _start(){const e=this.components.transportManager.getAddrs();for(const t of e){const{family:e,host:n,port:s,transport:r}=t.toOptions();if(!t.isThinWaistAddress()||"tcp"!==r)continue;if((0,L_.U)(t))continue;if(4!==e)continue;const o=await this._getClient(),i=this.externalAddress??await o.externalIp(),a=(0,N_.A)(i);if(!0===a)throw new Error(`${i} is private - please set config.nat.externalIp to an externally routable IP or ensure you are not behind a double NAT`);if(null==a)throw new Error(`${i} is not an IP address`);const c=x_();M_(`opening uPnP connection from ${i}:${c} to ${n}:${s}`),await o.map({publicPort:c,localPort:s,localAddress:this.localAddress,protocol:"TCP"===r.toUpperCase()?"TCP":"UDP"}),this.components.addressManager.addObservedAddr((0,j.NF)({family:4,address:i,port:c},r))}}async _getClient(){return null!=this.client||(this.client=await async function(){throw new Error("Not supported in browsers")}((this.description,this.ttl,this.keepAlive,this.gateway))),this.client}async stop(){if(!O_.Bd&&null!=this.client)try{await this.client.close(),this.client=void 0}catch(e){M_.error(e)}}}const z_=(0,a.vF)("libp2p:peer-record-updater");class U_{constructor(e){this.components=e,this.started=!1,this.update=this.update.bind(this)}isStarted(){return this.started}async start(){this.started=!0,this.components.transportManager.addEventListener("listener:listening",this.update),this.components.transportManager.addEventListener("listener:close",this.update),this.components.addressManager.addEventListener("change:addresses",this.update)}async stop(){this.started=!1,this.components.transportManager.removeEventListener("listener:listening",this.update),this.components.transportManager.removeEventListener("listener:close",this.update),this.components.addressManager.removeEventListener("change:addresses",this.update)}update(){Promise.resolve().then((async()=>{const e=new Qh.c({peerId:this.components.peerId,multiaddrs:this.components.addressManager.getAddresses().map((e=>e.decapsulateCode((0,j.WH)("p2p").code)))}),t=await Qh.e.seal(e,this.components.peerId);await this.components.peerStore.addressBook.consumePeerRecord(t)})).catch((e=>{z_.error("Could not update self peer record: %o",e)}))}}class F_{constructor(e){this.dht=e}async findPeer(e,t={}){for await(const n of this.dht.findPeer(e,t))if("FINAL_PEER"===n.name)return n.peer;throw c(new Error(tw.NOT_FOUND),nw.ERR_NOT_FOUND)}async*getClosestPeers(e,t={}){for await(const n of this.dht.getClosestPeers(e,t))"FINAL_PEER"===n.name&&(yield n.peer)}}const j_={ERR_INVALID_PARAMETERS:"ERR_INVALID_PARAMETERS",ERR_NOT_FOUND:"ERR_NOT_FOUND"},H_=(0,a.vF)("libp2p:peer-store:address-book"),$_="change:multiaddrs";async function V_(){return!0}class K_{constructor(e,t,n){this.dispatchEvent=e,this.store=t,this.addressFilter=n??V_}async consumePeerRecord(e){H_.trace("consumePeerRecord await write lock");const t=await this.store.lock.writeLock();let n,s,r;H_.trace("consumePeerRecord got write lock");try{let t;try{t=Qh.c.createFromProtobuf(e.payload)}catch(e){return H_.error("invalid peer record received"),!1}n=t.peerId;const o=t.multiaddrs;if(!n.equals(e.peerId))return H_("signing key does not match PeerId in the PeerRecord"),!1;if(null==o||0===o.length)return!1;if(await this.store.has(n)&&(s=await this.store.load(n),null!=s.peerRecordEnvelope)){const e=await Qh.e.createFromProtobuf(s.peerRecordEnvelope),n=Qh.c.createFromProtobuf(e.payload);if(n.seqNumber>=t.seqNumber)return H_("sequence number was lower or equal to existing sequence number - stored: %d received: %d",n.seqNumber,t.seqNumber),!1}const i=await q_(n,o,this.addressFilter,!0);r=await this.store.patchOrCreate(n,{addresses:i,peerRecordEnvelope:e.marshal().subarray()}),H_("stored provided peer record for %p",t.peerId)}finally{H_.trace("consumePeerRecord release write lock"),t()}return this.dispatchEvent(new Zh.u($_,{detail:{peerId:n,multiaddrs:r.addresses.map((({multiaddr:e})=>e)),oldMultiaddrs:null==s?[]:s.addresses.map((({multiaddr:e})=>e))}})),!0}async getRawEnvelope(e){H_.trace("getRawEnvelope await read lock");const t=await this.store.lock.readLock();H_.trace("getRawEnvelope got read lock");try{return(await this.store.load(e)).peerRecordEnvelope}catch(e){if(e.code!==j_.ERR_NOT_FOUND)throw e}finally{H_.trace("getRawEnvelope release read lock"),t()}}async getPeerRecord(e){const t=await this.getRawEnvelope(e);if(null!=t)return await Qh.e.createFromProtobuf(t)}async get(e){e=(0,Ht.vV)(e),H_.trace("get wait for read lock");const t=await this.store.lock.readLock();H_.trace("get got read lock");try{return(await this.store.load(e)).addresses}catch(e){if(e.code!==j_.ERR_NOT_FOUND)throw e}finally{H_.trace("get release read lock"),t()}return[]}async set(e,t){if(e=(0,Ht.vV)(e),!Array.isArray(t))throw H_.error("multiaddrs must be an array of Multiaddrs"),new mp.A("multiaddrs must be an array of Multiaddrs",j_.ERR_INVALID_PARAMETERS);H_.trace("set await write lock");const n=await this.store.lock.writeLock();H_.trace("set got write lock");let s,r,o=!1;try{const n=await q_(e,t,this.addressFilter);if(0===n.length)return;try{if(s=await this.store.load(e),o=!0,new Set([...n.map((({multiaddr:e})=>e.toString())),...s.addresses.map((({multiaddr:e})=>e.toString()))]).size===s.addresses.length&&n.length===s.addresses.length)return}catch(e){if(e.code!==j_.ERR_NOT_FOUND)throw e}r=await this.store.patchOrCreate(e,{addresses:n}),H_("set multiaddrs for %p",e)}finally{H_.trace("set multiaddrs for %p",e),H_("set release write lock"),n()}this.dispatchEvent(new Zh.u($_,{detail:{peerId:e,multiaddrs:r.addresses.map((e=>e.multiaddr)),oldMultiaddrs:null==s?[]:s.addresses.map((({multiaddr:e})=>e))}})),o||this.dispatchEvent(new Zh.u("peer",{detail:{id:e,multiaddrs:r.addresses.map((e=>e.multiaddr)),protocols:r.protocols}}))}async add(e,t){if(e=(0,Ht.vV)(e),!Array.isArray(t))throw H_.error("multiaddrs must be an array of Multiaddrs"),new mp.A("multiaddrs must be an array of Multiaddrs",j_.ERR_INVALID_PARAMETERS);H_.trace("add await write lock");const n=await this.store.lock.writeLock();let s,r,o;H_.trace("add got write lock");try{const n=await q_(e,t,this.addressFilter);if(0===n.length)return;try{if(r=await this.store.load(e),s=!0,new Set([...n.map((({multiaddr:e})=>e.toString())),...r.addresses.map((({multiaddr:e})=>e.toString()))]).size===r.addresses.length)return}catch(e){if(e.code!==j_.ERR_NOT_FOUND)throw e}o=await this.store.mergeOrCreate(e,{addresses:n}),H_("added multiaddrs for %p",e)}finally{H_.trace("set release write lock"),n()}this.dispatchEvent(new Zh.u($_,{detail:{peerId:e,multiaddrs:o.addresses.map((e=>e.multiaddr)),oldMultiaddrs:null==r?[]:r.addresses.map((({multiaddr:e})=>e))}})),!0===s&&this.dispatchEvent(new Zh.u("peer",{detail:{id:e,multiaddrs:o.addresses.map((e=>e.multiaddr)),protocols:o.protocols}}))}async delete(e){e=(0,Ht.vV)(e),H_.trace("delete await write lock");const t=await this.store.lock.writeLock();let n;H_.trace("delete got write lock");try{try{n=await this.store.load(e)}catch(e){if(e.code!==j_.ERR_NOT_FOUND)throw e}await this.store.patchOrCreate(e,{addresses:[]})}finally{H_.trace("delete release write lock"),t()}null!=n&&this.dispatchEvent(new Zh.u($_,{detail:{peerId:e,multiaddrs:[],oldMultiaddrs:null==n?[]:n.addresses.map((({multiaddr:e})=>e))}}))}}async function q_(e,t,n,s=!1){const r=[];return await Promise.all(t.map((async t=>{if(!(0,j.R8)(t))throw H_.error("multiaddr must be an instance of Multiaddr"),new mp.A("multiaddr must be an instance of Multiaddr",j_.ERR_INVALID_PARAMETERS);await n(e,t)&&r.push({multiaddr:t,isCertified:s})}))),r}const G_=(0,a.vF)("libp2p:peer-store:key-book"),W_="change:pubkey";class Y_{constructor(e,t){this.dispatchEvent=e,this.store=t}async set(e,t){if(e=(0,Ht.vV)(e),!(t instanceof Uint8Array))throw G_.error("publicKey must be an instance of Uint8Array to store data"),new mp.A("publicKey must be an instance of PublicKey",j_.ERR_INVALID_PARAMETERS);G_.trace("set await write lock");const n=await this.store.lock.writeLock();G_.trace("set got write lock");let s,r=!1;try{try{if(s=await this.store.load(e),null!=s.pubKey&&(0,ve.a)(s.pubKey,t))return}catch(e){if(e.code!==j_.ERR_NOT_FOUND)throw e}await this.store.patchOrCreate(e,{pubKey:t}),r=!0}finally{G_.trace("set release write lock"),n()}r&&this.dispatchEvent(new Zh.u(W_,{detail:{peerId:e,publicKey:t,oldPublicKey:null==s?void 0:s.pubKey}}))}async get(e){e=(0,Ht.vV)(e),G_.trace("get await write lock");const t=await this.store.lock.readLock();G_.trace("get got write lock");try{return(await this.store.load(e)).pubKey}catch(e){if(e.code!==j_.ERR_NOT_FOUND)throw e}finally{G_("get release write lock"),t()}}async delete(e){e=(0,Ht.vV)(e),G_.trace("delete await write lock");const t=await this.store.lock.writeLock();let n;G_.trace("delete got write lock");try{try{n=await this.store.load(e)}catch(e){if(e.code!==j_.ERR_NOT_FOUND)throw e}await this.store.patchOrCreate(e,{pubKey:void 0})}catch(e){if(e.code!==j_.ERR_NOT_FOUND)throw e}finally{G_.trace("delete release write lock"),t()}this.dispatchEvent(new Zh.u(W_,{detail:{peerId:e,publicKey:void 0,oldPublicKey:null==n?void 0:n.pubKey}}))}}const X_=(0,a.vF)("libp2p:peer-store:metadata-book"),Q_="change:metadata";class J_{constructor(e,t){this.dispatchEvent=e,this.store=t}async get(e){e=(0,Ht.vV)(e),X_.trace("get await read lock");const t=await this.store.lock.readLock();X_.trace("get got read lock");try{return(await this.store.load(e)).metadata}catch(e){if(e.code!==j_.ERR_NOT_FOUND)throw e}finally{X_.trace("get release read lock"),t()}return new Map}async getValue(e,t){e=(0,Ht.vV)(e),X_.trace("getValue await read lock");const n=await this.store.lock.readLock();X_.trace("getValue got read lock");try{return(await this.store.load(e)).metadata.get(t)}catch(e){if(e.code!==j_.ERR_NOT_FOUND)throw e}finally{X_.trace("getValue release write lock"),n()}}async set(e,t){if(e=(0,Ht.vV)(e),!(t instanceof Map))throw X_.error("valid metadata must be provided to store data"),new mp.A("valid metadata must be provided",j_.ERR_INVALID_PARAMETERS);X_.trace("set await write lock");const n=await this.store.lock.writeLock();let s;X_.trace("set got write lock");try{try{s=await this.store.load(e)}catch(e){if(e.code!==j_.ERR_NOT_FOUND)throw e}await this.store.mergeOrCreate(e,{metadata:t})}finally{X_.trace("set release write lock"),n()}this.dispatchEvent(new Zh.u(Q_,{detail:{peerId:e,metadata:t,oldMetadata:null==s?new Map:s.metadata}}))}async setValue(e,t,n){if(e=(0,Ht.vV)(e),"string"!=typeof t||!(n instanceof Uint8Array))throw X_.error("valid key and value must be provided to store data"),new mp.A("valid key and value must be provided",j_.ERR_INVALID_PARAMETERS);X_.trace("setValue await write lock");const s=await this.store.lock.writeLock();let r,o;X_.trace("setValue got write lock");try{try{r=await this.store.load(e);const s=r.metadata.get(t);if(null!=s&&(0,ve.a)(n,s))return}catch(e){if(e.code!==j_.ERR_NOT_FOUND)throw e}o=await this.store.mergeOrCreate(e,{metadata:new Map([[t,n]])})}finally{X_.trace("setValue release write lock"),s()}this.dispatchEvent(new Zh.u(Q_,{detail:{peerId:e,metadata:o.metadata,oldMetadata:null==r?new Map:r.metadata}}))}async delete(e){e=(0,Ht.vV)(e),X_.trace("delete await write lock");const t=await this.store.lock.writeLock();let n;X_.trace("delete got write lock");try{try{n=await this.store.load(e)}catch(e){if(e.code!==j_.ERR_NOT_FOUND)throw e}null!=n&&await this.store.patch(e,{metadata:new Map})}finally{X_.trace("delete release write lock"),t()}null!=n&&this.dispatchEvent(new Zh.u(Q_,{detail:{peerId:e,metadata:new Map,oldMetadata:n.metadata}}))}async deleteValue(e,t){e=(0,Ht.vV)(e),X_.trace("deleteValue await write lock");const n=await this.store.lock.writeLock();let s,r;X_.trace("deleteValue got write lock");try{r=await this.store.load(e),s=r.metadata,s.delete(t),await this.store.patch(e,{metadata:s})}catch(e){if(e.code!==j_.ERR_NOT_FOUND)throw e}finally{X_.trace("deleteValue release write lock"),n()}null!=s&&this.dispatchEvent(new Zh.u(Q_,{detail:{peerId:e,metadata:s,oldMetadata:null==r?new Map:r.metadata}}))}}const Z_=(0,a.vF)("libp2p:peer-store:proto-book"),eE="change:protocols";class tE{constructor(e,t){this.dispatchEvent=e,this.store=t}async get(e){Z_.trace("get wait for read lock");const t=await this.store.lock.readLock();Z_.trace("get got read lock");try{return(await this.store.load(e)).protocols}catch(e){if(e.code!==j_.ERR_NOT_FOUND)throw e}finally{Z_.trace("get release read lock"),t()}return[]}async set(e,t){if(e=(0,Ht.vV)(e),!Array.isArray(t))throw Z_.error("protocols must be provided to store data"),new mp.A("protocols must be provided",j_.ERR_INVALID_PARAMETERS);Z_.trace("set await write lock");const n=await this.store.lock.writeLock();let s,r;Z_.trace("set got write lock");try{try{if(s=await this.store.load(e),new Set([...t]).size===s.protocols.length)return}catch(e){if(e.code!==j_.ERR_NOT_FOUND)throw e}r=await this.store.patchOrCreate(e,{protocols:t}),Z_("stored provided protocols for %p",e)}finally{Z_.trace("set release write lock"),n()}this.dispatchEvent(new Zh.u(eE,{detail:{peerId:e,protocols:r.protocols,oldProtocols:null==s?[]:s.protocols}}))}async add(e,t){if(e=(0,Ht.vV)(e),!Array.isArray(t))throw Z_.error("protocols must be provided to store data"),new mp.A("protocols must be provided",j_.ERR_INVALID_PARAMETERS);Z_.trace("add await write lock");const n=await this.store.lock.writeLock();let s,r;Z_.trace("add got write lock");try{try{if(s=await this.store.load(e),new Set([...s.protocols,...t]).size===s.protocols.length)return}catch(e){if(e.code!==j_.ERR_NOT_FOUND)throw e}r=await this.store.mergeOrCreate(e,{protocols:t}),Z_("added provided protocols for %p",e)}finally{Z_.trace("add release write lock"),n()}this.dispatchEvent(new Zh.u(eE,{detail:{peerId:e,protocols:r.protocols,oldProtocols:null==s?[]:s.protocols}}))}async remove(e,t){if(e=(0,Ht.vV)(e),!Array.isArray(t))throw Z_.error("protocols must be provided to store data"),new mp.A("protocols must be provided",j_.ERR_INVALID_PARAMETERS);Z_.trace("remove await write lock");const n=await this.store.lock.writeLock();let s,r;Z_.trace("remove got write lock");try{try{s=await this.store.load(e);const n=new Set(s.protocols);for(const e of t)n.delete(e);if(s.protocols.length===n.size)return;t=Array.from(n)}catch(e){if(e.code!==j_.ERR_NOT_FOUND)throw e}r=await this.store.patchOrCreate(e,{protocols:t})}finally{Z_.trace("remove release write lock"),n()}this.dispatchEvent(new Zh.u(eE,{detail:{peerId:e,protocols:r.protocols,oldProtocols:null==s?[]:s.protocols}}))}async delete(e){e=(0,Ht.vV)(e),Z_.trace("delete await write lock");const t=await this.store.lock.writeLock();let n;Z_.trace("delete got write lock");try{try{n=await this.store.load(e)}catch(e){if(e.code!==j_.ERR_NOT_FOUND)throw e}await this.store.patchOrCreate(e,{protocols:[]})}finally{Z_.trace("delete release write lock"),t()}null!=n&&this.dispatchEvent(new Zh.u(eE,{detail:{peerId:e,protocols:[],oldProtocols:n.protocols}}))}}an._configure(),nn._configure(sn),rn._configure(on);const nE=["uint64","int64","sint64","fixed64","sfixed64"];function sE(e){return function(e){for(const t of nE){if(null==e[t])continue;const n=e[t];e[t]=function(){return BigInt(n.call(this).toString())}}return e}(new nn(e))}function rE(){return function(e){for(const t of nE){if(null==e[t])continue;const n=e[t];e[t]=function(e){return n.call(this,e.toString())}}return e}(rn.create())}function oE(e,t){const n=sE(e instanceof Uint8Array?e:e.subarray());return t.decode(n)}function iE(e,t){const n=rE();return t.encode(e,n,{lengthDelimited:!1}),n.finish()}var aE,cE,lE,dE;function uE(e,t){return function(e,t,n,s){return{name:e,type:t,encode:n,decode:s}}("message",aE.LENGTH_DELIMITED,e,t)}!function(e){e[e.VARINT=0]="VARINT",e[e.BIT64=1]="BIT64",e[e.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",e[e.START_GROUP=3]="START_GROUP",e[e.END_GROUP=4]="END_GROUP",e[e.BIT32=5]="BIT32"}(aE||(aE={})),function(e){let t;e.codec=()=>(null==t&&(t=uE(((e,t,n={})=>{if(!1!==n.lengthDelimited&&t.fork(),null!=e.addresses)for(const n of e.addresses)t.uint32(10),lE.codec().encode(n,t);if(null!=e.protocols)for(const n of e.protocols)t.uint32(18),t.string(n);if(null!=e.metadata)for(const n of e.metadata)t.uint32(26),dE.codec().encode(n,t);null!=e.pubKey&&(t.uint32(34),t.bytes(e.pubKey)),null!=e.peerRecordEnvelope&&(t.uint32(42),t.bytes(e.peerRecordEnvelope)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={addresses:[],protocols:[],metadata:[]},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();switch(t>>>3){case 1:n.addresses.push(lE.codec().decode(e,e.uint32()));break;case 2:n.protocols.push(e.string());break;case 3:n.metadata.push(dE.codec().decode(e,e.uint32()));break;case 4:n.pubKey=e.bytes();break;case 5:n.peerRecordEnvelope=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>iE(t,e.codec()),e.decode=t=>oE(t,e.codec())}(cE||(cE={})),function(e){let t;e.codec=()=>(null==t&&(t=uE(((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.multiaddr&&e.multiaddr.byteLength>0&&(t.uint32(10),t.bytes(e.multiaddr)),null!=e.isCertified&&(t.uint32(16),t.bool(e.isCertified)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={multiaddr:new Uint8Array(0)},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();switch(t>>>3){case 1:n.multiaddr=e.bytes();break;case 2:n.isCertified=e.bool();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>iE(t,e.codec()),e.decode=t=>oE(t,e.codec())}(lE||(lE={})),function(e){let t;e.codec=()=>(null==t&&(t=uE(((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.key&&""!==e.key&&(t.uint32(10),t.string(e.key)),null!=e.value&&e.value.byteLength>0&&(t.uint32(18),t.bytes(e.value)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={key:"",value:new Uint8Array(0)},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();switch(t>>>3){case 1:n.key=e.string();break;case 2:n.value=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>iE(t,e.codec()),e.decode=t=>oE(t,e.codec())}(dE||(dE={}));const hE=(0,a.vF)("libp2p:peer-store:store"),pE="/peers/";class fE{constructor(e){this.components=e,this.lock=(0,vc.A)({name:"peer-store",singleProcess:!0})}_peerIdToDatastoreKey(e){if(null==e.type)throw hE.error("peerId must be an instance of peer-id to store data"),new mp.A("peerId must be an instance of peer-id",j_.ERR_INVALID_PARAMETERS);const t=e.toCID().toString();return new bt.U(`${pE}${t}`)}async has(e){return await this.components.datastore.has(this._peerIdToDatastoreKey(e))}async delete(e){await this.components.datastore.delete(this._peerIdToDatastoreKey(e))}async load(e){const t=await this.components.datastore.get(this._peerIdToDatastoreKey(e)),n=cE.decode(t),s=new Map;for(const e of n.metadata)s.set(e.key,e.value);return{...n,id:e,addresses:n.addresses.map((({multiaddr:e,isCertified:t})=>({multiaddr:(0,j.HZ)(e),isCertified:t??!1}))),metadata:s,pubKey:n.pubKey??void 0,peerRecordEnvelope:n.peerRecordEnvelope??void 0}}async save(e){if(null!=e.pubKey&&null!=e.id.publicKey&&!(0,ve.a)(e.pubKey,e.id.publicKey))throw hE.error("peer publicKey bytes do not match peer id publicKey bytes"),new mp.A("publicKey bytes do not match peer id publicKey bytes",j_.ERR_INVALID_PARAMETERS);const t=new Set,n=e.addresses.filter((e=>!t.has(e.multiaddr.toString())&&(t.add(e.multiaddr.toString()),!0))).sort(((e,t)=>e.multiaddr.toString().localeCompare(t.multiaddr.toString()))).map((({multiaddr:e,isCertified:t})=>({multiaddr:e.bytes,isCertified:t}))),s=[];[...e.metadata.keys()].sort().forEach((t=>{const n=e.metadata.get(t);null!=n&&s.push({key:t,value:n})}));const r=cE.encode({addresses:n,protocols:e.protocols.sort(),pubKey:e.pubKey,metadata:s,peerRecordEnvelope:e.peerRecordEnvelope});return await this.components.datastore.put(this._peerIdToDatastoreKey(e.id),r.subarray()),await this.load(e.id)}async patch(e,t){const n=await this.load(e);return await this._patch(e,t,n)}async patchOrCreate(e,t){let n;try{n=await this.load(e)}catch(t){if(t.code!==j_.ERR_NOT_FOUND)throw t;n={id:e,addresses:[],protocols:[],metadata:new Map}}return await this._patch(e,t,n)}async _patch(e,t,n){return await this.save({...n,...t,id:e})}async merge(e,t){const n=await this.load(e);return await this._merge(e,t,n)}async mergeOrCreate(e,t){let n;try{n=await this.load(e)}catch(t){if(t.code!==j_.ERR_NOT_FOUND)throw t;n={id:e,addresses:[],protocols:[],metadata:new Map}}return await this._merge(e,t,n)}async _merge(e,t,n){const s=new Map;return n.addresses.forEach((e=>{s.set(e.multiaddr.toString(),e.isCertified)})),(t.addresses??[]).forEach((e=>{const t=e.multiaddr.toString(),n=Boolean(s.get(t))||e.isCertified;s.set(t,n)})),await this.save({id:e,addresses:Array.from(s.entries()).map((([e,t])=>({multiaddr:(0,j.HZ)(e),isCertified:t}))),protocols:Array.from(new Set([...n.protocols??[],...t.protocols??[]])),metadata:new Map([...n.metadata?.entries()??[],...t.metadata?.entries()??[]]),pubKey:t.pubKey??(null!=n?n.pubKey:void 0),peerRecordEnvelope:t.peerRecordEnvelope??(null!=n?n.peerRecordEnvelope:void 0)})}async*all(){for await(const e of this.components.datastore.queryKeys({prefix:pE})){const t=e.toString().split("/")[2],n=U.base32.decode(t);yield this.load((0,Ht.nu)(n))}}}var yE,gE;!function(e){let t;e.codec=()=>(null==t&&(t=uE(((e,t,n={})=>{if(!1!==n.lengthDelimited&&t.fork(),null!=e.tags)for(const n of e.tags)t.uint32(10),gE.codec().encode(n,t);!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={tags:[]},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();if(t>>>3==1)n.tags.push(gE.codec().decode(e,e.uint32()));else e.skipType(7&t)}return n}))),t),e.encode=t=>iE(t,e.codec()),e.decode=t=>oE(t,e.codec())}(yE||(yE={})),function(e){let t;e.codec=()=>(null==t&&(t=uE(((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.name&&""!==e.name&&(t.uint32(10),t.string(e.name)),null!=e.value&&(t.uint32(16),t.uint32(e.value)),null!=e.expiry&&(t.uint32(24),t.uint64(e.expiry)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={name:""},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();switch(t>>>3){case 1:n.name=e.string();break;case 2:n.value=e.uint32();break;case 3:n.expiry=e.uint64();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>iE(t,e.codec()),e.decode=t=>oE(t,e.codec())}(gE||(gE={}));const mE=(0,a.vF)("libp2p:peer-store");class wE extends Zh.b{constructor(e,t={}){super(),this.components=e,this.store=new fE(e),this.addressBook=new K_(this.dispatchEvent.bind(this),this.store,t.addressFilter),this.keyBook=new Y_(this.dispatchEvent.bind(this),this.store),this.metadataBook=new J_(this.dispatchEvent.bind(this),this.store),this.protoBook=new tE(this.dispatchEvent.bind(this),this.store)}async forEach(e){mE.trace("getPeers await read lock");const t=await this.store.lock.readLock();mE.trace("getPeers got read lock");try{for await(const t of this.store.all())t.id.equals(this.components.peerId)||e(t)}finally{mE.trace("getPeers release read lock"),t()}}async all(){const e=[];return await this.forEach((t=>{e.push(t)})),e}async delete(e){mE.trace("delete await write lock");const t=await this.store.lock.writeLock();mE.trace("delete got write lock");try{await this.store.delete(e)}finally{mE.trace("delete release write lock"),t()}}async get(e){mE.trace("get await read lock");const t=await this.store.lock.readLock();mE.trace("get got read lock");try{return await this.store.load(e)}finally{mE.trace("get release read lock"),t()}}async has(e){mE.trace("has await read lock");const t=await this.store.lock.readLock();mE.trace("has got read lock");try{return await this.store.has(e)}finally{mE.trace("has release read lock"),t()}}async tagPeer(e,t,n={}){const s=n.value??0,r=Math.round(s),o=n.ttl??void 0;if(r!==s||r<0||r>100)throw new mp.A("Tag value must be between 0-100","ERR_TAG_VALUE_OUT_OF_BOUNDS");const i=await this.metadataBook.getValue(e,"tags");let a=[];null!=i&&(a=yE.decode(i).tags),a=a.filter((e=>e.name!==t)),a.push({name:t,value:r,expiry:null==o?void 0:BigInt(Date.now()+o)}),await this.metadataBook.setValue(e,"tags",yE.encode({tags:a}).subarray())}async unTagPeer(e,t){const n=await this.metadataBook.getValue(e,"tags");let s=[];null!=n&&(s=yE.decode(n).tags),s=s.filter((e=>e.name!==t)),await this.metadataBook.setValue(e,"tags",yE.encode({tags:s}).subarray())}async getTags(e){const t=await this.metadataBook.getValue(e,"tags");let n=[];null!=t&&(n=yE.decode(t).tags);const s=BigInt(Date.now()),r=n.filter((e=>null==e.expiry||e.expiry>s));return r.length!==n.length&&await this.metadataBook.setValue(e,"tags",yE.encode({tags:r}).subarray()),r.map((e=>({name:e.name,value:e.value??0})))}}class bE{constructor(e){this.dht=e}async provide(e){await(0,Kn.A)(this.dht.provide(e))}async*findProviders(e,t={}){for await(const n of this.dht.findProviders(e,t))"PROVIDER"===n.name&&(yield*n.providers)}async put(e,t,n){await(0,Kn.A)(this.dht.put(e,t,n))}async get(e,t){for await(const n of this.dht.get(e,t))if("VALUE"===n.name)return n.value;throw c(new Error("Not found"),"ERR_NOT_FOUND")}}class _E{constructor(e={}){this._started=!1,this._peerId=e.peerId,this._addressManager=e.addressManager,this._peerStore=e.peerStore,this._upgrader=e.upgrader,this._metrics=e.metrics,this._registrar=e.registrar,this._connectionManager=e.connectionManager,this._transportManager=e.transportManager,this._connectionGater=e.connectionGater,this._contentRouting=e.contentRouting,this._peerRouting=e.peerRouting,this._datastore=e.datastore,this._connectionProtector=e.connectionProtector,this._dht=e.dht,this._pubsub=e.pubsub,this._dialer=e.dialer}isStarted(){return this._started}async beforeStart(){await Promise.all(Object.values(this).filter((e=>(0,sw.nw)(e))).map((async e=>{null!=e.beforeStart&&await e.beforeStart()})))}async start(){await Promise.all(Object.values(this).filter((e=>(0,sw.nw)(e))).map((async e=>{await e.start()}))),this._started=!0}async afterStart(){await Promise.all(Object.values(this).filter((e=>(0,sw.nw)(e))).map((async e=>{null!=e.afterStart&&await e.afterStart()})))}async beforeStop(){await Promise.all(Object.values(this).filter((e=>(0,sw.nw)(e))).map((async e=>{null!=e.beforeStop&&await e.beforeStop()})))}async stop(){await Promise.all(Object.values(this).filter((e=>(0,sw.nw)(e))).map((async e=>{await e.stop()}))),this._started=!1}async afterStop(){await Promise.all(Object.values(this).filter((e=>(0,sw.nw)(e))).map((async e=>{null!=e.afterStop&&await e.afterStop()})))}get peerId(){if(null==this._peerId)throw c(new Error("peerId not set"),"ERR_SERVICE_MISSING");return this._peerId}set peerId(e){this._peerId=e}get addressManager(){if(null==this._addressManager)throw c(new Error("addressManager not set"),"ERR_SERVICE_MISSING");return this._addressManager}set addressManager(e){this._addressManager=e}get peerStore(){if(null==this._peerStore)throw c(new Error("peerStore not set"),"ERR_SERVICE_MISSING");return this._peerStore}set peerStore(e){this._peerStore=e}get upgrader(){if(null==this._upgrader)throw c(new Error("upgrader not set"),"ERR_SERVICE_MISSING");return this._upgrader}set upgrader(e){this._upgrader=e}get registrar(){if(null==this._registrar)throw c(new Error("registrar not set"),"ERR_SERVICE_MISSING");return this._registrar}set registrar(e){this._registrar=e}get connectionManager(){if(null==this._connectionManager)throw c(new Error("connectionManager not set"),"ERR_SERVICE_MISSING");return this._connectionManager}set connectionManager(e){this._connectionManager=e}get transportManager(){if(null==this._transportManager)throw c(new Error("transportManager not set"),"ERR_SERVICE_MISSING");return this._transportManager}set transportManager(e){this._transportManager=e}get connectionGater(){if(null==this._connectionGater)throw c(new Error("connectionGater not set"),"ERR_SERVICE_MISSING");return this._connectionGater}set connectionGater(e){this._connectionGater=e}get contentRouting(){if(null==this._contentRouting)throw c(new Error("contentRouting not set"),"ERR_SERVICE_MISSING");return this._contentRouting}set contentRouting(e){this._contentRouting=e}get peerRouting(){if(null==this._peerRouting)throw c(new Error("peerRouting not set"),"ERR_SERVICE_MISSING");return this._peerRouting}set peerRouting(e){this._peerRouting=e}get datastore(){if(null==this._datastore)throw c(new Error("datastore not set"),"ERR_SERVICE_MISSING");return this._datastore}set datastore(e){this._datastore=e}get connectionProtector(){return this._connectionProtector}set connectionProtector(e){this._connectionProtector=e}get dialer(){if(null==this._dialer)throw c(new Error("dialer not set"),"ERR_SERVICE_MISSING");return this._dialer}set dialer(e){this._dialer=e}get metrics(){return this._metrics}set metrics(e){this._metrics=e}get dht(){return this._dht}set dht(e){this._dht=e}get pubsub(){return this._pubsub}set pubsub(e){this._pubsub=e}}var EE=n(69753);const vE={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:e=>e},connectionManager:{maxConnections:300,minConnections:50,autoDial:!0,autoDialInterval:1e4,maxParallelDials:100,maxDialsPerPeer:4,dialTimeout:3e4,inboundUpgradeTimeout:3e4,resolvers:{dnsaddr:EE.H},addressSorter:Tb._},connectionGater:{},transportManager:{faultTolerance:bb.aF.FATAL_ALL},peerRouting:{refreshManager:{enabled:!0,interval:6e5,bootDelay:1e4}},nat:{enabled:!0,ttl:7200,keepAlive:!0},relay:{enabled:!0,advertise:{bootDelay:9e5,enabled:!1,ttl:18e5},hop:{enabled:!1,active:!1,timeout:3e4},autoRelay:{enabled:!1,maxListeners:2}},identify:{protocolPrefix:"ipfs",host:{agentVersion:v_},timeout:6e4,maxInboundStreams:1,maxOutboundStreams:1,maxPushIncomingStreams:1,maxPushOutgoingStreams:1},ping:{protocolPrefix:"ipfs",maxInboundStreams:1,maxOutboundStreams:1,timeout:1e4},fetch:{protocolPrefix:"libp2p",maxInboundStreams:1,maxOutboundStreams:1,timeout:1e4}};var SE=n(62552),kE=n(35591);class RE extends Zh.b{get[kE.H](){return!0}get[Symbol.toStringTag](){return"@libp2p/dummy-dht"}get wan(){throw c(new Error(tw.DHT_DISABLED),nw.DHT_DISABLED)}get lan(){throw c(new Error(tw.DHT_DISABLED),nw.DHT_DISABLED)}get(){throw c(new Error(tw.DHT_DISABLED),nw.DHT_DISABLED)}findProviders(){throw c(new Error(tw.DHT_DISABLED),nw.DHT_DISABLED)}findPeer(){throw c(new Error(tw.DHT_DISABLED),nw.DHT_DISABLED)}getClosestPeers(){throw c(new Error(tw.DHT_DISABLED),nw.DHT_DISABLED)}provide(){throw c(new Error(tw.DHT_DISABLED),nw.DHT_DISABLED)}put(){throw c(new Error(tw.DHT_DISABLED),nw.DHT_DISABLED)}async getMode(){throw c(new Error(tw.DHT_DISABLED),nw.DHT_DISABLED)}async setMode(){throw c(new Error(tw.DHT_DISABLED),nw.DHT_DISABLED)}async refreshRoutingTable(){throw c(new Error(tw.DHT_DISABLED),nw.DHT_DISABLED)}}class TE extends Zh.b{constructor(){super(...arguments),this.topicValidators=new Map}isStarted(){return!1}start(){}stop(){}get globalSignaturePolicy(){throw c(new Error(tw.PUBSUB_DISABLED),nw.ERR_PUBSUB_DISABLED)}get multicodecs(){throw c(new Error(tw.PUBSUB_DISABLED),nw.ERR_PUBSUB_DISABLED)}getPeers(){throw c(new Error(tw.PUBSUB_DISABLED),nw.ERR_PUBSUB_DISABLED)}getTopics(){throw c(new Error(tw.PUBSUB_DISABLED),nw.ERR_PUBSUB_DISABLED)}subscribe(){throw c(new Error(tw.PUBSUB_DISABLED),nw.ERR_PUBSUB_DISABLED)}unsubscribe(){throw c(new Error(tw.PUBSUB_DISABLED),nw.ERR_PUBSUB_DISABLED)}getSubscribers(){throw c(new Error(tw.PUBSUB_DISABLED),nw.ERR_PUBSUB_DISABLED)}async publish(){throw c(new Error(tw.PUBSUB_DISABLED),nw.ERR_PUBSUB_DISABLED)}}var IE=n(66152);const PE=(0,a.vF)("libp2p:dialer:dial-request");class AE{constructor(e){const{addrs:t,dialAction:n,dialer:s}=e;this.addrs=t,this.dialer=s,this.dialAction=n}async run(e={}){const t=this.dialer.getTokens(this.addrs.length);if(t.length<1)throw c(new Error("No dial tokens available"),nw.ERR_NO_DIAL_TOKENS);const n=new IE;for(const e of t)n.push(e).catch((e=>{PE.error(e)}));const s=this.addrs.map((()=>{const e=new AbortController;try{(0,lw.setMaxListeners)?.(1/0,e.signal)}catch{}return e}));if(null!=e.signal)try{(0,lw.setMaxListeners)?.(1/0,e.signal)}catch{}let r=0,o=!1;try{return await Promise.any(this.addrs.map((async(i,a)=>{const l=await n.shift();if(o)throw this.dialer.releaseToken(t.splice(t.indexOf(l),1)[0]),c(new Error("dialAction already succeeded"),nw.ERR_ALREADY_SUCCEEDED);const d=s[a];if(null==d)throw c(new Error("dialAction did not come with an AbortController"),nw.ERR_INVALID_PARAMETERS);let u;try{const t=d.signal;u=await this.dialAction(i,{...e,signal:null!=e.signal?(0,_t.anySignal)([t,e.signal]):t}),s[a]=void 0}finally{r++,this.addrs.length-r>=t.length?n.push(l).catch((e=>{PE.error(e)})):this.dialer.releaseToken(t.splice(t.indexOf(l),1)[0])}if(null==u)throw c(new Error("dialAction led to empty object"),nw.ERR_TRANSPORT_DIAL_FAILED);return o=!0,u})))}finally{s.forEach((e=>{void 0!==e&&e.abort()})),t.forEach((e=>this.dialer.releaseToken(e)))}}}const DE=(0,a.vF)("libp2p:dialer");class OE{constructor(e,t={}){this.started=!1,this.addressSorter=t.addressSorter??Tb._,this.maxAddrsToDial=t.maxAddrsToDial??25,this.timeout=t.dialTimeout??3e4,this.maxDialsPerPeer=t.maxDialsPerPeer??4,this.tokens=[...new Array(t.maxParallelDials??100)].map(((e,t)=>t)),this.components=e,this.pendingDials=(0,Qb.n)({name:"libp2p_dialler_pending_dials",metrics:e.metrics}),this.pendingDialTargets=(0,Qb.n)({name:"libp2p_dialler_pending_dial_targets",metrics:e.metrics});for(const[e,n]of Object.entries(t.resolvers??{}))j.K6.set(e,n)}isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1;for(const e of this.pendingDials.values())try{e.controller.abort()}catch(e){DE.error(e)}this.pendingDials.clear();for(const e of this.pendingDialTargets.values())e.abort();this.pendingDialTargets.clear()}async dial(e,t={}){const{peerId:n,multiaddr:s}=Tw(e);if(null!=n){if(this.components.peerId.equals(n))throw c(new Error("Tried to dial self"),nw.ERR_DIALED_SELF);if(null!=s&&(DE("storing multiaddrs %p",n,s),await this.components.peerStore.addressBook.add(n,[s])),await this.components.connectionGater.denyDialPeer(n))throw c(new Error("The dial request is blocked by gater.allowDialPeer"),nw.ERR_PEER_DIAL_INTERCEPTED)}DE("creating dial target for %p",n);const r=new AbortController,o=LE();this.pendingDialTargets.set(o,r);let i,a=r.signal;null!=t.signal&&(a=(0,_t.anySignal)([a,t.signal]));try{i=await this._createDialTarget({peerId:n,multiaddr:s},{...t,signal:a})}finally{this.pendingDialTargets.delete(o)}if(0===i.addrs.length)throw c(new Error("The dial request has no valid addresses"),nw.ERR_NO_VALID_ADDRESSES);const l=this.pendingDials.get(i.id)??this._createPendingDial(i,t);try{const e=await l.promise;return DE("dial succeeded to %s",i.id),e}catch(e){throw DE("dial failed to %s",i.id,e),l.controller.signal.aborted&&(e.code=nw.ERR_TIMEOUT),DE.error(e),e}finally{l.destroy()}}async _createDialTarget(e,t){let n=[];if((0,j.R8)(e.multiaddr)&&n.push(e.multiaddr),!(0,j.R8)(e.multiaddr)&&(0,Yt.Q)(e.peerId)&&n.push(...await this._loadAddresses(e.peerId)),n=(await Promise.all(n.map((async e=>await this._resolve(e,t))))).flat().filter((e=>Boolean(this.components.transportManager.transportForMultiaddr(e)))),n=[...new Set(n.map((e=>e.toString())))].map((e=>(0,j.HZ)(e))),n.length>this.maxAddrsToDial)throw c(new Error("dial with more addresses than allowed"),nw.ERR_TOO_MANY_ADDRESSES);const s=(0,Yt.Q)(e.peerId)?e.peerId:void 0;if(null!=s){const e=`/p2p/${s.toString()}`;n=n.map((t=>{const n=t.getPeerId();return null!=n&&s.equals(n)?t:t.encapsulate(e)}))}return{id:null==s?LE():s.toString(),addrs:n}}async _loadAddresses(e){const t=await this.components.peerStore.addressBook.get(e);return(await Promise.all(t.map((async t=>!await this.components.connectionGater.denyDialMultiaddr(e,t.multiaddr)&&t)))).filter(NE).sort(this.addressSorter).map((e=>e.multiaddr))}_createPendingDial(e,t={}){const n=new AE({addrs:e.addrs,dialAction:async(e,t={})=>{if(!0===t.signal?.aborted)throw c(new Error("already aborted"),nw.ERR_ALREADY_ABORTED);return await this.components.transportManager.dial(e,t).catch((t=>{throw DE.error("dial to %s failed",e,t),t}))},dialer:this}),s=new B.TimeoutController(this.timeout),r=[s.signal];null!=t.signal&&r.push(t.signal);const o=(0,_t.anySignal)(r);try{(0,lw.setMaxListeners)?.(1/0,o)}catch{}const i={dialRequest:n,controller:s,promise:n.run({...t,signal:o}),destroy:()=>{s.clear(),this.pendingDials.delete(e.id)}};return this.pendingDials.set(e.id,i),i}getTokens(e){const t=Math.min(e,this.maxDialsPerPeer,this.tokens.length),n=this.tokens.splice(0,t);return DE("%d tokens request, returning %d, %d remaining",e,t,this.tokens.length),n}releaseToken(e){this.tokens.includes(e)||(DE("token %d released",e),this.tokens.push(e))}async _resolve(e,t){if(!e.protoNames().includes("dnsaddr"))return[e];const n=await this._resolveRecord(e,t);return(await Promise.all(n.map((async e=>await this._resolve(e,t))))).flat().reduce(((e,t)=>(null==e.find((e=>e.equals(t)))&&e.push(t),e)),[])}async _resolveRecord(e,t){try{e=(0,j.HZ)(e.toString());return await e.resolve(t)}catch(t){return DE.error(`multiaddr ${e.toString()} could not be resolved`,t),[]}}}function NE(e){return Boolean(e)}function LE(){return`${parseInt(String(1e9*Math.random()),10).toString()}${Date.now()}`}const ME=(0,a.vF)("libp2p");class CE extends Zh.b{constructor(e){super(),this.started=!1,this.peerId=e.peerId;const t=this.components=new _E({peerId:e.peerId,datastore:e.datastore??new rw,connectionGater:{denyDialPeer:async()=>await Promise.resolve(!1),denyDialMultiaddr:async()=>await Promise.resolve(!1),denyInboundConnection:async()=>await Promise.resolve(!1),denyOutboundConnection:async()=>await Promise.resolve(!1),denyInboundEncryptedConnection:async()=>await Promise.resolve(!1),denyOutboundEncryptedConnection:async()=>await Promise.resolve(!1),denyInboundUpgradedConnection:async()=>await Promise.resolve(!1),denyOutboundUpgradedConnection:async()=>await Promise.resolve(!1),filterMultiaddrForPeer:async()=>await Promise.resolve(!0),...e.connectionGater}});t.peerStore=new wE(t,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...e.peerStore}),this.services=[t],null!=e.metrics&&(this.metrics=this.components.metrics=this.configureComponent(e.metrics(this.components))),this.peerStore=this.components.peerStore,this.peerStore.addEventListener("peer",(e=>{const{detail:t}=e;this.dispatchEvent(new Zh.u("peer:discovery",{detail:t}))})),null!=e.connectionProtector&&(this.components.connectionProtector=e.connectionProtector(t)),this.components.upgrader=new b_(this.components,{connectionEncryption:(e.connectionEncryption??[]).map((e=>this.configureComponent(e(this.components)))),muxers:(e.streamMuxers??[]).map((e=>this.configureComponent(e(this.components)))),inboundUpgradeTimeout:e.connectionManager.inboundUpgradeTimeout}),this.components.dialer=new OE(this.components,e.connectionManager),this.connectionManager=this.components.connectionManager=new Aw(this.components,e.connectionManager),this.components.connectionManager.addEventListener("peer:disconnect",(e=>{this.dispatchEvent(new Zh.u("peer:disconnect",{detail:e.detail}))})),this.components.connectionManager.addEventListener("peer:connect",(e=>{this.dispatchEvent(new Zh.u("peer:connect",{detail:e.detail}))})),this.registrar=this.components.registrar=new g_(this.components),this.components.transportManager=new Zb(this.components,e.transportManager),this.components.addressManager=new fw(this.components,e.addresses),this.configureComponent(new U_(this.components)),this.configureComponent(new Mw(this.components,{enabled:e.connectionManager.autoDial,minConnections:e.connectionManager.minConnections,autoDialInterval:e.connectionManager.autoDialInterval}));const n=Yb.generateOptions();this.keychain=this.configureComponent(new Yb(this.components,{...n,...e.keychain})),this.services.push(new B_(this.components,e.nat)),e.transports.forEach((e=>{this.components.transportManager.add(this.configureComponent(e(this.components)))})),this.identifyService=new k_(this.components,{...e.identify}),this.configureComponent(this.identifyService),null!=e.dht?this.dht=this.components.dht=e.dht(this.components):this.dht=new RE,null!=e.pubsub?this.pubsub=this.components.pubsub=e.pubsub(this.components):this.pubsub=new TE;const s=(e.peerRouters??[]).map((e=>this.configureComponent(e(this.components))));null!=e.dht&&(s.push(this.configureComponent(new F_(this.dht))),this.dht.addEventListener("peer",(e=>{this.onDiscoveryPeer(e)}))),this.peerRouting=this.components.peerRouting=this.configureComponent(new uw(this.components,{...e.peerRouting,routers:s}));const r=(e.contentRouters??[]).map((e=>this.configureComponent(e(this.components))));null!=e.dht&&r.push(this.configureComponent(new bE(this.dht))),this.contentRouting=this.components.contentRouting=this.configureComponent(new hw(this.components,{routers:r})),e.relay.enabled&&(this.components.transportManager.add(this.configureComponent(new Eb(this.components,e.relay))),this.configureComponent(new Ob(this.components,{addressSorter:e.connectionManager.addressSorter,...e.relay}))),this.fetchService=this.configureComponent(new P_(this.components,{...e.fetch})),this.pingService=this.configureComponent(new D_(this.components,{...e.ping}));for(const t of e.peerDiscovery??[]){this.configureComponent(t(this.components)).addEventListener("peer",(e=>{this.onDiscoveryPeer(e)}))}}configureComponent(e){return(0,sw.nw)(e)&&this.services.push(e),e}async start(){if(!this.started){this.started=!0,ME("libp2p is starting");try{await Promise.all(this.services.map((async e=>{null!=e.beforeStart&&await e.beforeStart()}))),await Promise.all(this.services.map((e=>e.start()))),await Promise.all(this.services.map((async e=>{null!=e.afterStart&&await e.afterStart()}))),ME("libp2p has started")}catch(e){throw ME.error("An error occurred starting libp2p",e),await this.stop(),e}}}async stop(){this.started&&(ME("libp2p is stopping"),this.started=!1,await Promise.all(this.services.map((async e=>{null!=e.beforeStop&&await e.beforeStop()}))),await Promise.all(this.services.map((e=>e.stop()))),await Promise.all(this.services.map((async e=>{null!=e.afterStop&&await e.afterStop()}))),ME("libp2p has stopped"))}isStarted(){return this.started}getConnections(e){return this.components.connectionManager.getConnections(e)}getPeers(){const e=new vw;for(const t of this.components.connectionManager.getConnections())e.add(t.remotePeer);return Array.from(e)}async dial(e,t={}){return await this.components.connectionManager.openConnection(e,t)}async dialProtocol(e,t,n={}){if(null==t)throw c(new Error("no protocols were provided to open a stream"),nw.ERR_INVALID_PROTOCOLS_FOR_STREAM);if(0===(t=Array.isArray(t)?t:[t]).length)throw c(new Error("no protocols were provided to open a stream"),nw.ERR_INVALID_PROTOCOLS_FOR_STREAM);const s=await this.dial(e,n);return await s.newStream(t,n)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(e){(0,j.R8)(e)&&(e=(0,Ht.XL)(e.getPeerId()??"")),await this.components.connectionManager.closeConnections(e)}async getPublicKey(e,t={}){if(ME("getPublicKey %p",e),null!=e.publicKey)return e.publicKey;const n=await this.peerStore.get(e);if(null!=n.pubKey)return n.pubKey;if(null==this.dht)throw c(new Error("Public key was not in the peer store and the DHT is not enabled"),nw.ERR_NO_ROUTERS_AVAILABLE);const s=(0,ee.x)([(0,x.s)("/pk/"),e.multihash.digest]);for await(const n of this.dht.get(s,t))if("VALUE"===n.name){const t=(0,Jt.unmarshalPublicKey)(n.value);return await this.peerStore.keyBook.set(e,n.value),t.bytes}throw c(new Error(`Node not responding with its public key: ${e.toString()}`),nw.ERR_INVALID_RECORD)}async fetch(e,t,n={}){if((0,j.R8)(e)){const t=(0,Ht.XL)(e.getPeerId()??"");await this.components.peerStore.addressBook.add(t,[e]),e=t}return await this.fetchService.fetch(e,t,n)}async ping(e,t={}){if((0,j.R8)(e)){const t=(0,Ht.XL)(e.getPeerId()??"");await this.components.peerStore.addressBook.add(t,[e]),e=t}return await this.pingService.ping(e,t)}async handle(e,t,n){Array.isArray(e)||(e=[e]),await Promise.all(e.map((async e=>{await this.components.registrar.handle(e,t,n)})))}async unhandle(e){Array.isArray(e)||(e=[e]),await Promise.all(e.map((async e=>{await this.components.registrar.unhandle(e)})))}async register(e,t){return await this.registrar.register(e,t)}unregister(e){this.registrar.unregister(e)}onDiscoveryPeer(e){const{detail:t}=e;t.id.toString()!==this.peerId.toString()?(t.multiaddrs.length>0&&this.components.peerStore.addressBook.add(t.id,t.multiaddrs).catch((e=>ME.error(e))),t.protocols.length>0&&this.components.peerStore.protoBook.set(t.id,t.protocols).catch((e=>ME.error(e))),this.dispatchEvent(new Zh.u("peer:discovery",{detail:t}))):ME.error(new Error(nw.ERR_DISCOVERED_SELF))}}async function xE(e){if(null==e.peerId){const t=e.datastore;if(null!=t)try{const n=new Yb({datastore:t},{...Yb.generateOptions(),...e.keychain??{}});e.peerId=await n.exportPeerId("self")}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}}return null==e.peerId&&(e.peerId=await(0,SE.jq)()),new CE(function(e){const t=(0,o.A)(vE,e);if(null==t.transports||t.transports.length<1)throw c(new Error(tw.ERR_TRANSPORTS_REQUIRED),nw.ERR_TRANSPORTS_REQUIRED);if(null==t.connectionEncryption||0===t.connectionEncryption.length)throw c(new Error(tw.CONN_ENCRYPTION_REQUIRED),nw.CONN_ENCRYPTION_REQUIRED);if(null===t.connectionProtector&&null!=globalThis.process?.env?.LIBP2P_FORCE_PNET)throw c(new Error(tw.ERR_PROTECTOR_REQUIRED),nw.ERR_PROTECTOR_REQUIRED);return t.identify.host.agentVersion===v_&&(O_.Ll||O_.OT?t.identify.host.agentVersion+=` UserAgent=${globalThis.process.version}`:(O_.Bd||O_.p7||O_.QN||O_.lV)&&(t.identify.host.agentVersion+=` UserAgent=${globalThis.navigator.userAgent}`)),t}(e))}var BE=n(9971);const zE="/dht/provider",UE=20,FE=3,jE=Number(3e5),HE=Number(3e4),$E=Number(3e5),VE=Number(3e4),KE=Number(3e4),qE=(0,x.s)("/pk/");function GE(e){return{...e,multiaddrs:e.multiaddrs.filter((e=>{const[[t,n]]=e.stringTuples();if(53===t||54===t||55===t)return"localhost"!==n;if(4!==t&&6!==t)return!1;if(null==n)return!1;const s=(0,N_.A)(n);return null==s||!s}))}}function WE(e){return{...e,multiaddrs:e.multiaddrs.filter((e=>{const[[t,n]]=e.stringTuples();if("localhost"===n)return!0;if(4!==t&&6!==t)return!1;if(null==n)return!1;const s=(0,N_.A)(n);return null!=s&&s}))}}async function YE(e){return(await co.sha256.digest(e)).digest}async function XE(e){return await YE(e.toBytes())}function QE(e){return new bt.U(`/dht/record/${(0,$.d)(e,"base32")}`,!1)}function JE(e,t){const n=new Date;return new ss.L(e,t,n).serialize()}class ZE{constructor(e,t){const{kBucketSize:n,pingTimeout:s,lan:r,pingConcurrency:o,protocol:i,tagName:c,tagValue:l}=t;this.components=e,this.log=(0,a.vF)(`libp2p:kad-dht:${r?"lan":"wan"}:routing-table`),this.kBucketSize=n??20,this.pingTimeout=s??1e4,this.pingConcurrency=o??10,this.lan=r,this.running=!1,this.protocol=i,this.tagName=c??"kad-close",this.tagValue=l??50;const d=()=>{this.metrics?.pingQueueSize.update(this.pingQueue.size),this.metrics?.pingRunning.update(this.pingQueue.pending)};this.pingQueue=new Ct.A({concurrency:this.pingConcurrency}),this.pingQueue.addListener("add",d),this.pingQueue.addListener("next",d),this._onPing=this._onPing.bind(this)}isStarted(){return this.running}async start(){this.running=!0,null!=this.components.metrics&&(this.metrics={routingTableSize:this.components.metrics.registerMetric(`libp2p_kad_dht_${this.lan?"lan":"wan"}_routing_table_size`),pingQueueSize:this.components.metrics.registerMetric(`libp2p_kad_dht_${this.lan?"lan":"wan"}_ping_queue_size`),pingRunning:this.components.metrics.registerMetric(`libp2p_kad_dht_${this.lan?"lan":"wan"}_ping_running`)});const e=new BE({localNodeId:await XE(this.components.peerId),numberOfNodesPerKBucket:this.kBucketSize,numberOfNodesToPing:1});this.kb=e,e.on("ping",this._onPing),this._tagPeers(e)}async stop(){this.running=!1,this.pingQueue.clear(),this.kb=void 0}_tagPeers(e){let t=new vw;const n=function(e,t=100){let n;return()=>{clearTimeout(n),n=setTimeout((()=>{e()}),t)}}((()=>{const n=new vw(e.closest(e.localNodeId,20).map((e=>e.peer))),s=n.difference(t),r=t.difference(n);Promise.resolve().then((async()=>{for(const e of s)await this.components.peerStore.tagPeer(e,this.tagName,{value:this.tagValue});for(const e of r)await this.components.peerStore.unTagPeer(e,this.tagName)})).catch((e=>{this.log.error("Could not update peer tags",e)})),t=n}));e.on("added",(()=>{n()})),e.on("removed",(()=>{n()}))}_onPing(e,t){this.pingQueue.add((async()=>{if(!this.running)return;let n=0;try{await Promise.all(e.map((async e=>{let t;try{t=new B.TimeoutController(this.pingTimeout);const s={signal:t.signal};this.log("pinging old contact %p",e.peer);const r=await this.components.connectionManager.openConnection(e.peer,s);(await r.newStream(this.protocol,s)).close(),n++}catch(t){this.running&&null!=this.kb&&(this.log.error("could not ping peer %p",e.peer,t),this.log("evicting old contact after ping failed %p",e),this.kb.remove(e.id))}finally{null!=t&&t.clear(),this.metrics?.routingTableSize.update(this.size)}}))),this.running&&n<e.length&&null!=this.kb&&(this.log("adding new contact %p",t.peer),this.kb.add(t))}catch(e){this.log.error("could not process k-bucket ping event",e)}})).catch((e=>{this.log.error("could not process k-bucket ping event",e)}))}get size(){return null==this.kb?0:this.kb.count()}async find(e){const t=await XE(e),n=this.closestPeer(t);if(null!=n&&e.equals(n))return n}closestPeer(e){const t=this.closestPeers(e,1);if(t.length>0)return t[0]}closestPeers(e,t=this.kBucketSize){if(null==this.kb)return[];return this.kb.closest(e,t).map((e=>e.peer))}async add(e){if(null==this.kb)throw new Error("RoutingTable is not started");const t=await XE(e);this.kb.add({id:t,peer:e}),this.log("added %p with kad id %b",e,t),this.metrics?.routingTableSize.update(this.size)}async remove(e){if(null==this.kb)throw new Error("RoutingTable is not started");const t=await XE(e);this.kb.remove(t),this.metrics?.routingTableSize.update(this.size)}}var ev=n(2503),tv=[77591,22417,43971,28421,740,29829,71467,228973,196661,78537,27689,36431,44415,14362,19456,106025,96308,2882,49509,21149,87173,131409,75844,23676,121838,30291,17492,2953,7564,110620,129477,127283,53113,72417,165166,109690,21200,102125,24049,71504,90342,25307,72039,26812,26715,32264,133800,71161,88956,171987,51779,24425,16671,30251,186294,247761,14202,2121,8465,35024,4876,85917,169730,3638,256836,96184,943,18678,6583,52907,35807,112254,214097,18796,11595,9243,23554,887,268203,382004,24590,111335,11625,16619,29039,102425,69006,97976,92362,32552,63717,41433,128974,137630,59943,10019,13986,35430,33665,108037,43799,43280,38195,29078,58629,18265,14425,46832,235538,40830,77881,110717,58937,3463,325358,51300,47623,117252,19007,10170,20540,91237,294813,4951,79841,56232,36270,128547,69209,66275,100156,32063,73531,34439,80937,28892,44466,88595,216307,32583,49620,16605,82127,45807,21630,78726,20235,40163,111007,96926,5567,72083,21665,58844,39419,179767,48328,42662,51550,5251,37811,49608,81056,50854,55513,20922,18891,197409,164656,32593,71449,220474,58919,85682,67854,13758,35066,3565,61905,214793,119572,141419,21504,10302,27354,67003,46131,32668,15165,64871,34450,17821,2757,11452,34189,5160,12257,85523,560,53385,65887,119549,135620,312353,115979,122356,10867,193231,124537,54783,90675,120791,4715,142253,50943,17271,43358,25331,4917,120566,34580,12878,33786,160528,32523,4869,301307,104817,81491,23276,8832,97911,31265,52065,7998,49622,9715,43998,34091,84587,20664,69041,29419,53205,10838,58288,116145,6185,5154,141795,35924,21307,144738,43730,12085,8279,10002,119,133779,199668,72938,31768,39176,67875,38453,9700,44144,4121,116048,41733,12868,82669,92308,128,34262,11332,7712,90764,36141,13553,71312,77470,117314,96549,49135,23602,54468,28605,6327,62308,17171,67531,21319,14105,894,107722,46157,8503,51069,100472,45138,15246,14577,35609,191464,1757,13364,161349,32067,91705,81144,52339,5408,91066,21983,14157,100545,4372,26630,129112,1423,29676,213626,4397,88436,99190,6877,49958,26122,114348,60661,29818,293118,50042,179738,16400,163423,89627,31040,43973,36638,45952,5153,1894,109322,1898,134021,12402,112077,68309,190269,69866,31938,107383,11522,105232,11248,14868,39852,71707,186525,16530,38162,106212,11700,5130,16608,26998,59586,108399,230033,43683,48135,82179,2073,5015,196684,189293,16378,23452,8301,35640,11632,214551,29240,57644,33137,91949,55157,52384,117313,5090,17717,89668,49363,82238,241035,66216,29066,184088,97206,62820,26595,4241,135635,173672,8202,459,71355,146294,29587,3008,135385,141203,14803,6634,45094,69362,50925,546,51884,62011,83296,234584,44515,56050,89476,87751,19373,12691,149923,19794,13833,35846,87557,58339,2884,19145,25647,12224,11024,77338,64608,122297,53025,7205,36189,36294,170779,21750,7739,173883,75192,35664,224240,113121,30181,26267,27036,117827,92015,106516,55628,203549,67949,60462,60844,35911,20457,1820,920,19773,8738,73173,181993,38521,98254,76257,46008,92796,5384,26868,151566,22124,2411,15919,186872,180021,28099,152961,78811,80237,62352,102653,74259,184890,16792,123702,224945,29940,19512,75283,14059,112691,92811,233329,20411,138569,53341,109802,50600,134528,66747,5529,166531,31578,64732,67189,1596,126357,967,167999,206598,109752,119431,207825,78791,91938,10301,27311,24233,252343,28831,32812,66002,112267,90895,8786,8095,16824,22866,21813,60507,174833,19549,130985,117051,52110,6938,81923,123864,38061,919,18680,53534,46739,112893,161529,85429,26761,11900,81121,91968,15390,217947,56524,1713,6654,37089,85630,138866,61850,16491,75577,16884,98296,73523,6140,44645,6062,36366,29844,57946,37932,42472,5266,20834,19309,33753,127182,134259,35810,41805,45878,312001,14881,47757,49251,120050,44252,3708,25856,107864,120347,1228,36550,41682,34496,47025,8393,173365,246526,12894,161607,35670,90785,126572,2095,124731,157033,58694,554,12786,9642,4817,16136,47864,174698,66992,4639,69284,10625,40710,27763,51738,30404,264105,137904,109882,52487,42824,57514,2740,10479,146799,107390,16586,88038,174951,9410,16185,44158,5568,40658,46108,12763,97385,26175,108859,664,230732,67470,46663,14395,50750,141320,93140,15361,47997,55784,6791,307840,118569,107326,18056,58281,260415,54691,8790,73332,45633,7511,45674,143373,14031,11799,94491,35646,96544,14560,26049,32983,25791,83814,42094,231370,63955,139212,2359,169908,3108,183486,105867,28197,32941,124968,26402,88267,149768,23053,3078,19091,52924,25383,19209,111548,97361,3959,24880,235061,9099,24921,161254,151405,20508,7159,34381,20133,11434,74036,19974,34769,36585,1076,22454,17354,38727,235160,111547,96454,117448,156940,91330,37299,7310,26915,117060,51369,22620,61861,322264,106850,111694,15091,2624,40345,300446,177064,1707,27389,54792,327783,132669,183543,59003,17744,20603,151134,106923,53084,71803,279424,319816,11579,21946,16728,38274,72711,5085,83391,88646,40159,25027,34680,10752,12988,54126,30365,18338,100445,230674,44874,84974,143877,123253,139372,28082,91477,144002,13096,219729,46016,50029,42377,14601,6660,58244,58978,23918,88206,113611,64452,17541,41032,10942,12021,49189,10978,40175,37156,10947,71709,106894,112538,57007,137486,150608,152719,40615,7746,279716,13101,19524,28708,40578,72320,1096,182051,94527,51275,22833,45164,81917,77519,48508,5421,140302,37845,149830,5587,27579,5357,428725,248187,6326,206760,39814,32585,89923,44341,288753,284443,96368,31201,94189,119504,20359,52073,103216,179,27934,32801,96035,34111,34309,101326,18198,20704,210266,37643,27880,141873,106e3,19414,56614,167714,66483,107885,86602,4379,20796,75467,4987,5017,118857,26003,34308,114428,29198,6686,29697,73632,3739,69795,16798,41504,7207,30722,21436,36735,28067,28545,3239,11221,36031,41889,100010,19247,317673,29495,174554,6424,129725,53845,94986,7955,59676,2604,191497,19735,102214,62954,23844,11872,179525,261436,34492,428,78404,142035,16747,17246,27578,37021,33672,57944,26056,135760,2369,61674,122066,31327,19374,157065,40553,130982,69619,71290,38855,72100,92903,95940,51422,165999,65713,57873,50726,7288,20272,2081,42326,22624,81120,57914,79352,19447,1684,72302,11774,302559,161481,96396,13692,414988,3721,79066,56627,46883,21150,11747,12184,5856,113458,176117,84416,52079,27933,3354,59765,141359,2212,216309,2555,23458,196722,142463,45701,44548,28798,19418,215,29916,9396,10574,114226,84475,13520,18694,34056,4524,90302,62930,13539,19407,77209,7728,38088,9535,2263,23875,183945,17750,26274,67172,10585,28042,22199,7478,51331,66030,26774,192929,31434,25850,50197,52926,178158,4679,181256,70184,229600,9959,105594,72158,73974,2726,35085,78087,23284,35568,51713,155676,5401,27254,11966,17569,223253,71993,103357,111477,55722,30504,26034,46774,35392,36285,214814,41143,163465,1051,16094,81044,6636,76489,179102,20712,39178,35683,125177,54219,30617,52994,25324,50123,2543,87529,58995,10688,125199,12388,60158,125481,131646,7642,133350,65874,3438,97277,101450,10075,56344,116821,50778,60547,98016,106135,13859,14255,16300,77373,173521,8285,45932,37426,4054,114295,55947,7703,39114,52,51119,128135,19714,60715,9554,50492,88180,2823,118271,52993,122625,97919,23859,37895,25040,33614,32102,20431,3577,9275,15686,43031,157741,110358,1884,40291,125391,13736,5008,64881,87336,77381,70711,43032,49155,118587,70494,4318,10168,30126,12580,10524,280104,104001,145413,2862,84140,6603,106005,13566,12780,11251,42830,571,179910,82443,13146,469,42714,32591,265217,424024,92553,54721,134100,6007,15242,114681,59030,16718,85465,200214,85982,55174,165013,23493,56964,82529,109150,32706,27568,82442,5350,14976,13165,44890,60021,21343,33978,17264,4655,22328,27819,75730,16567,55483,14510,17926,45827,150609,3704,7385,272531,161543,76904,122163,52405,2039,19165,41623,14423,228354,3369,176360,85491,7122,35789,303724,4465,13628,2233,55311,118771,20713,10006,221519,45115,71021,35650,29775,7337,10864,20665,21142,1746,15080,1624,32449,10905,105743,229797,7701,3940,22997,178467,57208,389057,39683,59403,63344,63125,54847,69691,18336,56448,3362,37202,18282,29648,138224,35867,10495,5911,28814,26653,31514,176702,26550,45621,11734,4525,40543,73944,121080,27858,155561,14887,44670,30742,8796,107455,113472,56369,75581,183777,240095,133699,153299,8768,160464,26058,49078,103971,21875,71486,44888,17156,9678,89541,123019,102337,3972,83930,21245,87852,109660,287918,183019,686,10100,39177,283941,11274,24736,26793,26214,25995,77011,141580,4070,23742,46285,46632,30700,26669,19056,35951,115575,174034,56097,35463,87425,24575,44245,38701,82317,85922,281616,100333,147697,61503,7730,84330,8530,59917,61597,17173,9092,32658,90288,193136,39023,20381,56654,31132,7779,1919,1375,117128,30819,11169,40938,23935,115201,101155,151034,4835,11231,74550,89388,59951,91704,107312,167882,115062,12732,72738,88703,464019,158267,57995,60496,737,14371,123867,4174,243339,159946,7568,16025,134556,110916,38103,191,80226,88794,29688,27230,10454,76308,57647,77409,113483,66864,14745,19808,12023,46583,84805,16015,17102,2231,20611,3547,95740,250131,34559,108894,8498,15853,159169,148920,20942,2813,93160,45188,210613,45531,52587,149062,39782,28194,57849,60965,84954,89766,84453,100927,16501,27658,165311,103841,54192,207341,19558,20084,319622,5672,205467,98462,61849,36279,13609,147177,24726,165015,209489,59591,31157,6551,117580,75060,141146,277310,21072,22023,106474,63041,137443,122965,68371,5383,42146,98961,113467,30863,23794,4843,99630,30392,82679,13699,241612,33601,93146,24319,18643,32155,95669,40440,15333,34089,67799,142144,58245,38633,114531,117400,77861,188726,5507,2568,8853,10987,107222,2663,2421,11530,13345,30075,41785,118661,104786,17459,12490,16281,71936,193555,17431,5944,71758,26485,77317,20803,367167,158,7362,93430,11735,172445,46002,11532,54482,930,62911,2235,23004,179236,4764,101859,208113,22477,55163,95579,14098,67320,162556,90709,156949,3826,57492,4025,34092,87442,104565,6718,186015,28214,14209,10039,107186,233912,58877,81637,55265,39828,6194,145813,50831,105849,4974,88319,122296,10272,197216,95714,51540,72418,23324,91555,8743,140452,250249,51666,34124,7229,38592,129641,78169,174242,22464,149964,51450,14034,10026,95376,26190,120062,14401,8700,265,31386,143573,7203,229889,61567,4227,140981,2466,72052,10787,10062,30958,6099,38471,30103,23202,208101,70847,467,58934,32271,32984,36637,24107,30771,17109,73353,13650,2098,157040,67366,66904,106018,265380,107238,18535,44025,32681,144983,62505,91295,56120,3082,77508,10322,63023,36700,81885,224127,16721,45023,239261,111272,13852,7866,149243,204199,32309,22084,42029,38316,126644,104973,14406,43454,67322,61310,15789,40285,24026,181047,6301,70927,23319,115823,27248,66693,115875,278566,63007,146844,56841,59007,87368,180001,22370,42114,80605,12022,10374,308,25079,14689,12618,63368,7936,264973,212291,136713,95999,105801,18965,32075,48700,52230,35119,96912,32992,8586,16606,101333,101812,14969,39930,759,193090,27387,42914,12937,5058,62646,64528,38624,25743,37502,3716,4435,30352,178687,26461,132611,42002,138442,35833,59582,16345,8048,60319,49349,309,47800,49739,90482,26405,34470,63786,32479,85028,39866,47846,11649,23934,29466,2816,42864,31828,7410,74885,49632,47629,111801,90749,19536,18767,105764,59606,21223,10746,76298,22220,39408,7190,79654,64856,11602,82156,272765,17079,70089,245473,51813,184407,384678,1576,122249,5064,27481,6188,25790,74361,27541,318284,45430,31488,620,93579,45723,192118,22670,51913,4162,70244,35966,26397,16199,50899,209613,121702,287507,2993,36101,132229,67345,33062,76295,118628,78705,52316,34375,107083,107454,44863,127561,33964,3073,154010,190914,55967,39074,6272,31047,5550,41123,26154,98638,47110,19998,148091,50229,31329,59900,195442,19106,61347,73497,70015,682,45850,25776,38022,148951,6288,37411,232526,109277,27286,32342,9262,5220,16651,23175,46740,129438,78614,121925,66914,88710,127952,5563,21500,34521,10739,14863,191006,62956,17359,16749,67027,56284,69134,43301,35039,58883,54466,60823,404451,75743,59856,86979,7923,34273,83785,32142,7693,268986,197428,282681,17049,22346,22990,92245,107180,3357,37104,96724,49153,7683,31197,43267,82231,164276,23696,20848,188364,22309,24821,158707,1018,22514,70922,27792,45589,59709,10765,736,35218,63479,51987,24275,63588,55361,92929,81964,4658,20122,12330,44058,13065,311456,72224,8337,211229,38979,22590,138478,52757,32595,133600,8838,31549,94412,43391,90056,1585,94802,127271,6223,31889,137038,132910,2165,57616,230152,6080,10748,36737,74579,134062,50525,180532,119270,34556,76155,82394,52595,29258,31435,87820,67996,26943,183878,38007,2410,13526,180297,69856,3503,187396,167700,7838,16701,9199,56267,3661,37407,65994,23767,5708,62508,221700,67088,86978,46776,84434,32088,5612,9149,88244,21685,95151,46750,189612,2979,506311,2594,3628,40074,105039,78243,28523,6651,38058,71999,30992,12764,68261,108991,6165,26450,61961,13400,22426,7490,60890,109623,2070,12958,50355,67979,257096,7213,42578,52121,35716,65461,7516,124758,39268,302,64712,14977,1467,219452,2840,34229,11121,21602,19270,63574,8024,1532,17331,79839,78885,52029,180767,57957,6069,91265,61380,55767,8927,32881,287603,22149,35029,68876,6428,199567,46926,13412,104132,21434,366616,45060,110046,81924,128910,45886,52821,130416,29416,77342,21762,67329,121432,79924,11724,38625,81006,102033,28338,13326,3250,82056,82526,38212,21112,12382,111495,3263,7414,86274,93490,40844,30224,45212,24019,48411,71367,24941,76729,57776,3769,38114,202019,197745,31953,237533,33270,201580,255648,100798,44741,32241,98468,106931,10085,15090,170358,33154,66787,18819,69760,25061,234005,82660,6295,131975,16874,9076,4094,25005,17740,40908,19533,220019,44330,99792,50040,19619,13950,55228,24423,31253,95308,103177,184795,28590,82285,5059,3210,75525,49894,70007,56178,10580,36051,139681,21617,98736,3555,106306,164189,37352,63915,47824,24883,145530,61904,28444,11483,19837,145446,30420,112972,85939,11835,191233,2262,20705,58630,1753,148334,1197,144714,6887,11223,107667,60879,77914,4151,57417,81594,96681,169430,1784,20444,95138,254041,27038,596,7117,72808,13759,3353,126776,21074,55322,27081,36942,39547,139830,179275,4453,713,8722,71399,19204,25785,22794,23923,104114,11291,25458,102309,88396,75288,230440,206396,104551,58447,130857,37247,94734,31548,176529,226077,65159,20104,10096,66881,94191,237909,27109,37404,1520,27421,25220,113003,23423,24884,50585,6286,231877,150800,11789,3226,90004,60642,5053,202400,61442,132531,175329,57138,30116,103847,9973,75367,16452,32360,59119,21246,10191,164804,23305,61051,37348,154530,13214,5468,50403,66754,130976,50559,80515,14436,155492,84017,5472,43107,41240,2890,90431,70188,382,76234,48040,50211,281038,237007,32115,142178,1536,22761,96429,1811,31243,1679,49143,55209,17402,235054,61494,7462,77030,34925,87609,78002,9499,9027,73289,201078,101379,63544,27666,5469,10642,30029,49816,132979,95620,58086,351930,116300,2110,2043,30845,6154,11279,16727,4122,2277,27281,4971,3650,39060,61970,65951,39674,75686,38151,11370,130809,177895,32665,63725,122267,7857,39618,118483,44792,157755,178624,136994,24260,41308,22471,12404,21707,12486,30473,52781,50246,20247,39065,909,56825,103158,128603,31542,1089,41935,32744,12428,37963,84420,33134,72921,208449,42622,168151,127335,147107,46699,38216,12591,94342,85814,31423,24944,2605,87542,67473,192551,4496,56321,91819,17630,6300,256183,114569,202090,33209,35289,34897,24967,40520,43470,5344,10199,34810,14283,10381,10017,62923,49924,23233,64539,13051,35686,19698,11570,135555,120868,44924,87065,52318,52335,47586,140906,245885,109834,78668,9065,46990,25258,72022,61243,40838,4545,146387,10537,11557,17470,36930,68104,46711,24264,79401,81043,18225,120488,24746,84338,81652,28266,13776,21878,46973,1047,230465,73357,95777,24973,210160,62210,58404,110633,169651,6937,41870,9909,26822,191062,76553,27519,96256,239070,2478,205678,67955,58532,20601,50120,19148,78501,195724,110740,8249,109665,27446,30568,57631,31425,49752,32820,65504,50079,3663,102256,219898,23849,211315,14645,4359,91767,9528,12449,49366,7941,49763,107848,8930,27086,50686,9744,10447,81935,39513,46514,1670,29229,6172,22312,137280,97759,9806,14445,22976,56458,73391,34983,93760,174219,52573,33149,59747,2429,136277,75123,165263,91040,7446,57632,48633,97140,246081,84766,151684,79918,93268,120346,54059,54875,77858,32996,103590,45276,11968,19600,25849,17159,132907,42828,16817,4913,99462,103303,27395,5737,74184,20749,21160,14377,77062,131403,158735,10999,27799,77785,9320,34366,51593,61070,33746,47048,29268,36675,30262,53297,9832,82e3,20188,122292,39917,7331,18160,68301,185935,134830,15031,4935,10004,165845,185534,46923,30109,44134,122631,18874,22903,112790,26561,18549,348902,82871,140345,255565,135390,63556,103747,145055,179600,145662,296111,61661,211987,23952,52342,126343,48450,32919,44277,82185,9591,62139,205363,376969,394874,108461,18040,120885,14798,39863,16571,16794,58271,81025,55206,14640,118656,6361,44092,85970,6262,153863,108244,180200,72264,79947,38044,10050,5735,61221,80712,5471,115689,11391,11661,184257,20010,60116,30320,19327,134598,45455,27542,18004,125092,452272,1549,91523,46567,180063,156026,2608,11174,58848,37788,65907,80194,30490,5786,40775,119519,106241,11323,156297,8425,61495,2617,29675,2425,59886,112582,49142,59618,4863,50597,86710,50650,168632,27693,85641,83643,18993,25768,84284,28090,93592,36627,312804,43381,9887,9402,100931,97165,3311,173330,66805,28935,4963,184460,3201,78102,19126,21607,37496,24938,22615,16153,32862,134792,153318,61120,6067,2812,12826,12792,23825,37559,64662,202250,102694,155488,85881,149193,46233,65383,15521,106982,11358,176786,25752,39717,34208,24510,32464,77742,39371,72028,138229,60688,71386,102834,132477,2208,11548,63670,271279,28351,30338,38620,32491,99845,143885,152266,13252,2825,178663,108097,1775,78201,14897,113573,163346,62292,171129,22183,96598,38733,64971,166776,117445,9968,146393,44677,74867,20908,97328,12761,25656,26785,9148,112344,26115,99176,110121,22437,49547,6180,79320,5835,31392,43328,33377,75870,119860,69497,80273,7325,155219,43167,111173,28347,20222,3763,71752,55041,47252,14618,28088,15012,97805,194698,54636,2036,41349,6173,96604,61530,51859,43782,13361,24334,22668,24792,7070,23441,16789,3209,36211,208475,26242,32880,122181,182407,21444,31060,88459,29929,77907,12716,10934,97005,20599,31690,8403,58445,30303,22700,10336,86731,103115,337709,72556,46788,112566,47684,67089,53548,36874,56487,41387,125985,26893,40071,106683,73712,18787,40105,72992,67246,137276,50802,36790,70328,138827,22466,39263,183295,29858,50975,9322,57397,10654,24364,30383,55799,41600,23584,127295,296610,129078,143558,244131,86397,36049,1085,80677,3820,108139,5476,34767,24683,7758,13060,7239,131671,250593,59556,103392,29810,4188,252323,39404,116877,7651,43600,40338,13554,157253,39196,25978,144387,61211,234,50104,6129,10449,93777,9240,356378,274148,4439,72970,3724,147770,78680,62570,115877,40027,40547,36817,224392,64609,34795,165027,67440,2477,37206,23431,50754,164797,46018,94995,170982,27051,7957,22767,3674,27900,56419,18930,60701,41302,2692,84749,339721,61996,111094,80221,50129,1045,8153,62945,19202,8250,37208,37418,32560,79477,41106,88569,33963,36693,5892,30570,1581,66471,49647,11922,160717,29442,5643,114865,82962,95982,132098,22633,22838,94726,54556,28566,205039,162340,33216,16849,35847,221339,94851,26533,71469,1805,3804,12935,45483,71020,36310,65381,192960,34240,35165,59773,1248,46954,155332,96864,4246,388800,16129,57133,74592,44807,442014,38203,42574,80818,91592,26377,36424,65760,977,77387,22628,147610,28018,30561,98454,6969,119628,63648,18170,36854,26601,64018,22027,37279,51395,152934,21153,9430,58760,194742,5330,55115,34158,28917,174111,13171,122326,1526,43896,66094,25325,4234,148354,11450,275,18999,112191,44365,22723,68409,8733,57746,96565,75007,14196,108844,29475,88599,177563,100792,106156,86323,93726,14248,135341,194131,40126,47099,14779,8272,39597,95983,171398,65882,28052,10393,47213,40689,22120,72212,106829,34964,109146,753,648,21660,30047,17527,181025,5619,145357,4085,216883,9359,186951,24779,53931,24545,36197,223296,62628,168101,4243,107313,30321,26642,13049,51059,31027,107912,807,73550,26551,84369,122422,165872,49754,74213,234264,33151,52014,33100,87183,22365,52500,40013,23302,5652,72723,21404,26107,48434,587,94049,168493,96418,32871,70860,31709,25128,443,71597,166253,15670,70994,26341,133675,28280,75491,54756,47955,56028,26182,11952,113272,472197,64640,110753,17919,337,50642,22576,142,87371,53391,93210,126694,15285,19642,85667,14148,1506,42092,52962,33243,11970,20734,135843,57044,58880,13002,219134,22876,64754,232519,4257,43120,321573,24799,64526,124728,52579,81472,70831,276848,17403,74359,23021,182101,74597,23744,148267,12055,7976,5349,11772,67540,167347,65318,18720,127832,108238,22828,90233,9987,259080,118185,73209,79270,13775,90100,137742,90799,70569,15699,19961,9087,67475,57872,39731,8810,134897,131868,146849,19898,3334,2281,167061,91073,60356,467742,74712,188,53179,137679,92769,29241,9537,132595,80119,1041,88962,5976,40171,44911,102859,139059,104558,98987,47761,19272,71472,113864,175377,73338,10857,23402,23758,1591,139864,5644,4076,118760,16427,134198,18853,20291,100849,37423,22038,36677,19071,195521,57445,11069,31869,55718,66882,148490,44,41296,75242,49704,166810,9906,20943,122258,49112,105667,15969,10344,6408,187694,21399,72742,58970,14867,14376,81889,41856,23225,15042,56993,16074,131389,74276,72407,53875,383108,53597,37363,68993,44854,122548,430927,198279,38430,80409,12245,2981,628,2818,17760,37437,238229,7968,46892,2200,3730,34190,65983,37959,112291,87850,70827,6522,20750,73913,111621,41652,19587,2780,58668,25916,85259,18200,168962,95781,42445,102050,7776,57662,103313,47742,96358,41964,66174,100396,29069,204735,19679,27978,7479,40264,22534,61183,36081,107436,58223,14680,23002,101311,24716,124108,12908,5646,31750,40380,14215,232799,102772,14122,96775,61398,50917,12096,149880,67833,598749,124194,155871,49216,790,14677,65319,56917,7440,145744,95701,12206,49405,129269,76199,45732,9767,11058,9047,210885,11051,7392,26307,2130,8132,147526,20802,232698,115660,50060,59789,57344,107623,80343,112676,23291,9866,160971,34032,118291,15719,59730,164911,28975,2659,58046,78480,21854,66209,53863,109085,116045,29021,46481,107552,22130,18764,70254,31272,11300,52460,43933,84738,20721,53869,190840,79673,105300,7561,321817,66924,13940,33281,101046,183181,32176,71878,5678,62924,79535,56646,40303,19559,27703,93042,73368,42187,3670,37376,46440,7023,36816,109628,20680,5940,276440,275233,170848,112093,136996,14984,20226,111441,77693,112960,48577,39370,55707,50314,123404,26570,54281,61372,123391,4857,35928,246740,132507,106646,44241,7196,92258,9825,37688,51197,303141,5590,15476,132986,10955,85782,34486,26696,7991,28813,18858,39546,11703,11365,38185,5716,93555,11925,40121,60002,6985,10976,171384,3887,43394,13337,56346,6381,252336,39573,75042,53711,1028,31781,44295,95925,131713,7214,68125,43571,70954,213234,1628,8760,13391,65485,17320,56038,1710,25248,60803,57399,19839,3870,326,281556,50945,72400,21460,316244,75619,56246,98775,481,13513,55765,50427,7388,123519,32929,57908,27124,61316,101097,57467,30228,48792,10788,20402,37318,50526,155730,34456,158065,145305,17832,43733,64052,4506,35072,205355,177028,184004,187081,68616,35938,83703,10367,36892,93186,260137,51934,89970,4985,23445,26755,21558,7948,78741,23376,124405,85594,68596,57536,49351,12619,56593,132668,99924,109728,71844,71935,196018,65464,17617,14987,89701,143773,33997,8687,22701,33258,2914,4436,72108,85610,9671,49067,2327,82988,1361,1672,44033,35777,30269,24057,10605,82236,616,15793,13919,47249,112086,116698,9484,80207,90574,33304,68624,93127,56101,42210,160929,4827,38995,38095,4701,125119,5027,33680,9236,231236,14135,87837,23318,70261,78893,30151,81482,14332,1084,74256,27532,46644,79185,3148,62615,6981,55672,31668,36825,1849,14536,37446,14738,23779,43058,162749,72199,1168,21346,5592,85932,85302,9668,18351,57135,150360,2080,228015,77953,34670,119302,151751,31009,106725,84265,45214,59289,74178,113071,263206,111009,4021,44449,188119,192629,123592,392506,292847,114487,12831,205858,9852,20780,79648,75767,357014,97721,18166,21005,67950,33226,204009,16536,2987,11335,66717,144910,47950,17262,55060,15063,2934,51038,26775,178497,66008,3427,49433,128592,20036,157553,63861,3089,23015,51210,28696,35933,49942,71135,231518,99620,17248,21835,176536,20676,16944,38700,165831,233253,295625,36723,13023,52745,10907,19423,67972,125868,95473,82875,1183,108455,52685,33417,64095,21433,52438,33191,127809,44505,211823,7810,2752,95548,162031,7185,91196,47563,61721,33359,17897,23682,42806,178101,22874,49707,199897,75419,82456,8618,11171,79712,116847,18783,44190,46564,5346,59046,95032,7893,14916,3214,26800,24172,121453,34362,10250,17408,18888,4840,68696,22831,13162,36005,32512,14800,62357,41723,45046,27247,37486,5372,2564,34261,298500,66509,133920,89138,31305,117697,19097,108304,81386,84106,23802,46411,63304,946,51417,41777,41041,19501,115864,60743,294354,37955,94165,18116,1156,17937,20645,57114,90804,58042,48643,92288,9861,2557,88546,61333,101008,12853,5148,87856,4152,144503,73841,18718,9789,147565,10846,42085,12789,30223,8993,56352,67203,2448,28215,6052,23540,126319,75933,36689,80235,23231,23561,21383,38800,77548,102798,21234,31468,158608,46188,63960,191679,8051,67014,11185,170078,42186,28827,34777,41930,212079,12421,34750,24111,110344,73918,45171,70826,141949,40063,23979,24254,37309,26724,27179,24718,83648,54938,14591,17425,29525,102675,48975,48654,12316,8929,60640,41709,50168,63264,89812,50716,48632,38755,138583,160123,55579,71829,24230,233277,46322,39650,166388,34718,24108,98252,7031,106695,62498,18258,35062,217827,78731,34824,33354,19520,60852,2432,60224,8587,2836,62955,702,20227,42285,40560,95592,62486,11094,53035,143291,18842,46177,77994,1770,9657,107422,172915,32655,128716,25886,25164,156740,119928,165875,85817,11007,89110,33956,12652,65156,180266,8494,36889,19958,20955,96,1264,118288,135769,44754,86671,5632,19026,168220,289120,33569,93821,66144,70635,7687,5642,2714,55445,56636,71545,184182,93133,7332,37389,12643,52315,22729,11014,158742,17050,152889,50178,34601,41945,52136,9948,26914,63548,95721,115951,40759,8960,158258,38938,49232,48325,42234,81523,253019,66128,40978,20048,238048,38760,62928,122560,118532,43687,137472,163689,26680,9878,17448,51035,16211,60834,36749,29178,14241,59868,150086,2305,26477,42422,34342,165341,83279,33894,14257,29928,12743,13957,125571,89134,66712,10952,16507,147839,30146,7249,16565,45399,39874,114565,215780,31990,230881,171477,102,196546,44538,10880,84948,281705,86651,10617,31395,2342,453658,43569,60561,132901,21845,17727,58556,258242,22262,58728,4008,77997,11806,37431,30599,81375,109137,185787,114085,217292,97453,169085,30593,60212,11544,102056,65580,2384,91655,4855,95725,7295,157994,16228,20669,53276,141590,105246,17334,25440,76067,17967,39321,38911,11362,28559,63807,21627,26468,85816,40120,1025,15234,58319,69516,66512,124548,75845,78873,22137,46681,51242,85683,32909,76747,35555,43396,101465,1765,73094,1077,2962,39028,66777,57831,42048,15828,13962,36041,63657,52412,5242,58846,2141,5506,219012,134451,3936,182230,17558,17153,152237,22621,49377,170216,35257,68233,65374,6510,11126,212151,7184,2480,22517,3437,33073,30156,16557,3768,55067,86829,91e3,12350,148650,66017,79424,70885,49066,28250,21369,51213,34533,11510,3258,18176,18465,84413,6315,36411,163765,4346,356,107618,598,13727,285026,162695,8749,14583,7132,63521,184253,32378,25991,5604,30961,53675,4874,84693,5086,34811,26978,56564,7904,33519,51221,113942,69253,6664,125563,22055,220680,102008,742,51930,19494,176108,44424,35123,13025,75685,11759,74335,22250,181453,131147,16984,132115,154311,11991,76452,52609,85351,196,30969,9198,74919,2529,56838,71779,29187,116304,3504,62330,41190,86153,28393,254926,104228,105189,13264,84359,3574,12415,8534,57147,10175,188174,59504,60932,66318,16407,107921,17638,99103,49278,28403,39786,145865,8462,3558,43406,142271,29139,21989,36552,93955,72365,7176,13556,106185,37957,321774,17782,129017,51154,27938,24952,1935,39366,2791,33489,41582,56078,24558,9311,5449,218786,27808,190429,68013,36020,86003,29735,3404,87348,119357,115714,2324,86796,81973,40992,43376,93621,28784,16808,36367,2517,2909,191926,24978,55303,53308,205724,60068,3098,21375,64784,23949,26579,63121,12319,80145,39967,97861,6757,70143,67642,37082,34698,69140,122883,46151,62187,80934,429,19437,135071,137885,222647,13331,154065,327,61778,74257,40116,37493,14855,85079,237641,42342,102164,199965,71204,4662,29368,5042,113914,122214,8955,13149,102503,43173,5659,163787,69003,307084,63392,171080,21390,81918,86666,36622,24126,28887,5736,28054,207170,163428,79891,346467,95363,38980,111806,80828,9200,19288,294896,114468,87405,111715,141705,7015,72754,68463,48738,243147,33397,101210,37051,98801,82847,20397,4940,185559,18716,54718,83491,11725,40803,1128,12128,23060,5174,7745,67007,46701,1571,27807,180186,256996,18975,16837,7877,212758,250379,15440,87954,57755,24719,124057,83461,258,50864,8874,29038,71289,31627,15429,9005,4061,113851,107716,82819,13651,79656,117851,17539,111446,12938,39724,190787,4352,15402,21070,62708,8539,23777,73853,13552,38810,86117,16285,56400,1718,75342,142863,29033,378,110113,180321,32586,23606,26393,160984,207987,23783,8406,16904,24596,47274,11693,46539,60524,78595,48423,31718,20170,9009,146268,15183,191060,172765,1349,138436,37365,10970,40509,225817,20021,70394,152138,21541,66559,66544,89352,2725,17258,91345,7313,3815,115868,8660,40362,4071,103524,39388,118275,21950,6549,38226,32754,209574,29201,43495,18028,20296,40597,18370,47520,202450,24134,2219,8195,69545,38041,136934,46374,19041,159811,84865,58620,846,98749,13569,30714,97246,32186,4479,27355,92973,35214,151491,75963,37631,1561,27200,238083,23182,60756,12291,25766,39355,102333,87362,65741,59906,19538,201575,48772,102938,24438,292580,39964,66366,9004,61379,50548,37622,38732,28379,68180,76622,17488,69849,5963,7219,48143,43413,55358,540,58691,29506,19245,52193,48621,5518,13048,118625,44755,191081,42061,89197,2259,60665,66994,71210,51232,3585,142096,55024,7892,8345,58653,463307,65658,64319,137941,136323,53499,12746,43492,6978,95163,29925,60175,5128,7352,41463,184756,121146,20473,18426,4598,5309,54580,14277,121151,10691,56711,43880,63409,76682,11830,172218,264898,32632,66536,81062,31649,25788,92774,60222,11100,63159,9432,224657,25240,53613,152,138620,163829,2397,85345,12501,37507,64932,38575,43522,65789,80198,78796,35226,3851,108891,73311,3060,28391,93671,39663,46142,30982,66041,37281,68157,26553,71872,81142,211527,39747,118119,22695,2859,11066,20232,168911,7933,197005,17066,111071,44434,133994,120798,12766,227798,45756,132852,29917,36076,55352,65281,129800,41958,18944,84678,18580,168093,132621,39997,54092,27740,32354,3770,114118,103242,43918,15899,18574,145944,3190,123469,219903,24169,100571,62403,16776,92779,14535,17168,16475,14304,37231,1712,28218,242754,61688,28980,1318,51359,222657,99200,67989,31772,23932,35351,201251,49041,27306,19128,40135,3986,77333,19649,120683,151927,21081,7076,78375,77501,101599,8011,89585,96715,58179,5378,102138,106793,26051,217276,4197,16297,27014,46721,13322,22806,5278,29629,70632,9647,71519,58818,40603,128530,8903,36770,56900,31483,26935,43845,34265,34920,87658,6114,84767,64250,47318,50720,19264,162514,33357,13117,6705,46696,75032,71054,87004,42035,69138,11903,99854,102328,19611,34525,69312,6431,49842,101600,133178,108751,41829,89939,225664,48916,99556,9195,130387,5960,36857,116724,53518,94002,39077,53996,6945,22261,64291,8314,152785,57588,16522,9091,5048,87671,35441,39509,1945,12423,158923,178413,37549,14095,1475,73188,62878,4819,24012,68534,42606,4010,120809,57497,59564,101758,103718,32701,80116,12345,95834,46918,21468,53213,15665,31200,3867,5140,96013,250744,21016,10069,13968,35449,180829,27683,39704,59956,22893,3115,26293,32785,75934,62445,141162,62720,2018,83638,19949,114012,95006,3330,99829,130935,309272,9565,55874,121727,37017,23586,319858,40970,27602,8625,112329,61060,100088,118525,25922,16232,1907,60671,51583,44553,80993,5262,94679,8676,940,20736,11823,3020,16476,12340,152600,97416,3703,25744,66826,16245,16876,46446,84798,74227,176020,45192,61955,75496,23946,23626,40372,26036,6149,11822,30582,16541,41914,82385,232823,40921,80773,14930,3631,7517,39619,4348,36180,126106,138939,62611,1477,113512,47321,25052,14546,118881,29060,23589,128322,36795,18401,137921,104699,267929,36194,172791,18113,4766,188215,30083,332586,94089,5805,77909,22194,68234,154976,43220,40660,70001,184893,138095,11128,103010,22663,5108,212615,8485,5565,49222,54614,26530,42639,16319,55062,152662,105595,21114,22216,10294,68158,10436,86950,7206,62115,3977,3657,59874,456,118617,18156,106663,112229,80992,17442,8217,55551,5133,34344,251927,51153,39364,201321,7816,66803,23057,156724,145664,14276,95705,979,2796,6875,13429,212525,50602,26276,28284,3424,19465,52397,46963,31420,51399,206476,92317,48851,637,100820,83349,10317,60227,21972,6908,282439,32857,224767,95629,83882,42106,87338,69757,29840,68709,37665,45244,114577,49188,175943,54009,186746,106158,70168,3358,234002,50555,9221,129338,9562,20118,32923,78479,118280,65752,4977,10474,102174,60947,129006,10570,83451,8598,8078,159367,123785,80438,16742,5905,5281,181513,42402,6977,163136,93179,42191,14968,50421,112401,105440,33456,57347,121611,4221,94954,36517,24046,27796,6255,33394,72990,135408,116627,1233,57874,25654,95419,68156,401399,313338,55208,45573,93124,119251,47200,38196,11909,130667,45391,73904,64964,167846,4137,115606,52036,62214,7969,160925,7187,1132,134835,40309,73195,64494,80472,444841,61111,26500,45323,40743,53625,52797,22659,15631,29739,36706,28841,39147,102836,26794,10536,14845,87305,45874,12241,127587,83833,57183,79722,30844,41304,84655,20825,92500,3722,25655,27811,10157,81634,31362,34088,92487,70123,22190,185100,72658,139035,192523,88241,2078,230490,44528,85638,100198,22088,29982,291233,241062,13865,4445,137791,37835,107218,31726,19718,38234,72528,23046,19177,66695,5109,17251,28077,5617,21554,47839,72425,133825,1486,73065,181275,141508,21768,62971,63082,2512,34200,9904,120309,6392,91243,68416,268253,41199,116757,138551,185526,41246,28986,4093,19057,17295,4148,245766,122360,35356,112075,20301,75441,10998,7977,19769,62922,937,63547,100196,26427,157820,20983,236696,22935,8140,90315,156004,47204,140973,7726,45097,52725,22636,23436,257282,105247,522,88389,216031,202204,46812,211666,19693,68828,81691,45925,11256,30292,372,5236,167826,88328,232776,151611,5360,82104,18841,80393,25465,18285,20320,72377,31730,33160,45803,38715,27705,37379,24163,18360,103586,4015,32305,269494,91252,20080,36567,54650,7797,57073,12650,31164,42209,6375,261663,105528,81661,106002,2800,5375,17247,43151,4442,15727,194619,100855,144898,62320,78465,39929,16454,1967,28311,61363,17219,9395,8745,121445,76939,80385,162380,22009,54191,44248,16299,122830,48151,74429,78291,64755,14238,44966,2511,17712,67954,93583,829,105899,49935,84750,11591,33185,85447,42717,27409,208542,28965,62052,52525,5597,25694,65594,16343,63224,276188,12475,9331,127507,38522,57287,24128,133161,79723,105548,133695,48917,27558,43278,46520,13778,141954,110785,83366,17715,46317,105763,66298,147013,41086,94180,16478,220447,44611,730,19722,78975,117889,125643,26254,16574,18480,65006,15806,38549,246418,46052,36056,8440,34984,30170,3163,59800,4458,115442,4283,41970,33507,104078,1653,22,121158,276486,3655,6338,24048,133421,23641,2161,24422,36006,8086,10675,181474,12307,29514,59143,14729,52509,87128,122470,19446,80852,33314,24573,119864,14237,9652,57779,6612,51851,15284,98871,90581,124466,156831,21190,22015,71380,161906,87247,69201,18392,17908,108470,72962,40719,14338,17911,95260,43339,20610,78916,20710,72451,11315,31448,17263,58853,178878,48111,116002,45497,80506,82605,85880,36300,121755,25215,36118,301929,88728,405223,276136,553,34704,212438,49970,78329,922,20711,25036,257130,38295,145369,18128,15385,30829,55656,48345,8012,3561,28004,122041,192900,58338,112508,41085,29976,87040,47117,23905,4336,92061,138880,97407,42083,172121,6256,25192,172671,5,93568,1420,12677,31605,56743,40620,6015,78415,231077,31298,80026,13902,19048,24924,170586,32955,176119,87859,36731,6773,27711,24658,26475,115216,133207,93250,95820,88522,8317,5714,124047,55219,86860,19677,23961,22928,162209,8904,225992,359835,56084,96201,29392,96558,86071,93643,55114,13347,8183,95129,82012,2017,123336,34219,115554,157159,47747,101684,41008,18735,193781,104151,226906,7552,179874,124113,31159,21162,44010,14771,51268,166128,31382,73124,77438,92830,205709,12113,1292,38937,13114,1334,2118,15597,69581,14449,21934,76618,48728,67038,14967,51495,24243,87736,147249,26720,11119,46063,43749,5843,44147,152629,133428,65703,14269,45604,57982,28672,55616,45957,8438,95433,37698,220862,132034,39456,61870,4161,26501,73560,56418,9845,4654,20916,10456,88920,119358,9015,65931,96507,48029,38534,21676,109081,43078,34943,25089,6131,28766,23665,5477,10255,16695,67,45778,42443,42770,29534,23733,100513,62617,42630,48746,14191,43753,50295,26007,8792,57243,43119,54725,164253,58250,112304,131796,25165,4651,3188,24831,47748,3705,19540,13211,102095,5593,18699,23666,32005,117571,33541,60584,74573,86311,99443,25172,27222,168938,7143,11853,53560,18834,19960,86522,28217,53266,117700,72989,34323,18721,66450,34346,74056,47217,202002,46269,9429,68582,75458,37823,82843,96652,32549,145144,27958,19820,158086,31955,201406,135379,31207,192545,12950,51704,9094,248263,76147,64028,110009,79407,89345,99284,223492,47966,26848,15359,201137,2861,110507,71231,72297,31851,118777,71039,151051,240855,16333,50766,14727,7939,4149,80908,418780,88378,59276,1327,7284,38576,79814,65820,42199,84860,49574,62596,12396,70598,40117,8648,7994,16836,7630,14047,359699,106878,525,29037,28064,13380,11675,50669,74216,103539,180314,27449,56299,172344,19274,7301,246099,32043,19422,36506,129317,6806,30140,4614,46639,66926,932,86600,6322,27847,233103,10541,39025,34887,3517,12972,26220,2031,66561,115015,48658,47596,12714,33845,3893,16165,35237,89983,14769,11962,147224,47018,29977,27979,5552,82338,86023,131368,1218,24853,237840,132193,15455,40873,3668,65351,53388,15229,59889,272245,47934,11858,34347,18038,90853,86981,300602,19343,114181,29362,84921,6095,106059,79472,38015,1206,48741,6208,8e4,21916,17423,6002,108083,24479,34931,56661,9511,26995,100694,163853,35997,81254,58321,18919,171890,86877,91341,74503,70477,53412,7027,59281,39892,131302,5864,15947,61301,67466,162369,47956,27874,35624,282324,21270,111847,102548,41482,30955,116737,28264,8592,55458,22301,75090,29821,30697,51709,3041,19208,8038,24634,30467,87509,126428,19389,18814,152686,20701,83474,45832,80891,105808,11378,153223,120770,98186,150633,49838,9141,12755,30962,5260,74490,21256,31678,65062,33326,289838,187831,20595,89768,2805,58535,10844,70085,12090,2451,138068,98544,24461,4511,6754,41684,28203,3383,65355,82833,30161,83924,234361,128424,28921,222594,33975,125491,34069,11508,67464,144226,41850,98703,34371,7901,21254,38398,65651,23549,53883,213340,123269,12028,71764,177701,28758,2623,68395,11549,15232,68603,9660,63116,36079,57093,31198,20475,48467,89984,35619,186847,107469,31389,43631,73867,41949,68841,114250,1605,30564,63403,17588,27680,99533,12641,70325,50428,73426,78379,11855,91651,72081,91720,60198,15743,12065,83398,140046,6761,46598,45900,5068,886,62448,148968,37347,19405,9680,15819,43496,63370,75667,163700,37639,3633,22774,34341,183131,134335,37200,23915,7054,14194,12970,26438,13350,285521,25594,8219,104410,91039,168804,138480,149734,15907,33818,61132,60082,4622,110187,56736,13551,73571,3945,73463,65498,17758,263266,17593,2710,27585,54469,38200,45367,63754,28881,3473,12791,98287,31895,65787,4463,94536,24951,36332,59901,28803,52130,86403,7668,181822,74831,18977,9850,177206,145485,109798,7292,31421,26280,77211,58511,12507,127004,11113,147,8729,56208,43066,79926,129937,31345,83947,39915,46146,98763,42566,1337,13192,18323,105163,80570,117753,16555,72883,11077,159438,40764,70933,83329,26066,12276,72059,21655,173836,126713,69454,153482,91585,70644,102558,110483,6764,127864,190133,3961,101798,20945,71138,82402,90884,69669,44753,923,16939,59700,164258,25969,27082,31399,43846,6306,246093,51342,6153,151581,202801,182731,56475,162188,89426,141356,14355,121815,27536,28023,65257,77523,106668,127314,24947,12790,38796,169698,23555,10725,44573,183083,42088,62716,43265,105958,32050,44067,50118,1668,3874,6243,318411,16599,1691,94999,52378,28671,216728,123258,2059,34969,69225,5913,136280,171443,141515,91662,22175,135282,80020,92270,1663,4808,4482,3495,34691,5226,109830,108512,17342,107488,11606,123190,100247,29666,146527,113014,15794,30894,13224,39585,243192,22351,9903,7836,47699,11078,25468,122291,48821,26780,122679,75521,81450,630,4895,92900,55074,74293,17441,3563,111657,103102,51613,12318,52370,36191,68245,34269,40445,41354,122901,168604,182500,62012,42557,11259,24428,115113,86345,12362,3909,78430,86852,134602,20459,47853,93879,22577,7659,3688,38555,13349,17381,56715,91639,12493,10895,92438,3142,37057,28928,2004,36427,32268,34222,209974,10432,67436,41989,173518,107930,27079,62729,30908,55558,5828,45031,14902,53546,8204,144263,60255,14520,88212,86582,109589,69356,8064,47449,8505,66558,16886,4844,52817,111260,215129,12941,91118,650,20770,6273,73089,40618,62790,2873,35002,14023,97208,19386,102646,36993,143736,135457,35385,113601,17893,32627,84439,100619,56016,6581,57264,172160,45452,111710,203627,70131,24100,322787,1996,35665,70078,22358,90922,83658,4097,63200,58499,14542,99153,52159,6615,12414,63415,31986,16823,1579,65405,137809,8841,16898,48082,259,33014,42375,12260,179850,73667,91389,98882,29532,17311,326251,41092,5928,20742,44964,48019,43505,9317,49265,6643,192712,48424,163487,19861,20113,70848,31928,105333,23685,78563,14638,54755,7158,24142,44018,20774,125255,20331,24280,10163,1285,2336,39851,4299,117269,46714,63816,87779,159624,11731,9971,990,137317,108831,50994,74554,162680,23640,131597,146962,170620,34829,91205,21184,1913,63616,18427,93136,156592,17519,67565,115882,138220,78622,88535,18115,2711,33554,109492,54298,971,24914,25863,36363,45715,27099,194995,14299,178181,111488,72395,322385,157719,130787,11897,81843,83999,11369,49280,118604,40922,61332,110343,53407,75639,40582,300440,54722,25637,13694,48248,48278,194521,56203,52779,48783,72627,10953,376,16733,280238,26351,230789,15132,25168,137270,3588,63704,73376,94031,74284,19443,159557,9697,39901,13351,119050,15406,146455,3460,29556,75195,37673,102524,92329,47289,98413,15311,100684,56345,7116,95480,11590,7200,167,23610,58426,17730,136656,27944,53151,2701,8824,103124,3017,90744,113588,53216,79736,65940,26931,498,29568,80540,143543,21292,1740,59268,16561,180816,42323,50174,40890,52866,10703,57169,4700,17191,4424,93511,49698,166650,26972,48631,165169,82879,69326,202970,4007,2376,231325,139592,22119,62851,37504,68816,58345,67398,186643,43331,277416,53749,15746,23102,17432,4793,151138,48822,54265,48203,198688,14305,54287,2291,18018,113378,123260,7180,97549,87027,120085,2920,76080,8190,102005,5641,64580,14955,59802,54028,58884,19367,81779,412567,85957,97053,103637,78871,29364,27637,141728,4767,30686,112738,130146,42745,12730,105040,14844,232,210944,36581,152317,135543,29744,3129,55647,58149,46319,27265,17499,28005,59948,7170,34138,5702,293047,110892,408,91760,218674,18469,46095,81403,14389,4610,35672,73060,11006,74848,104820,118143,190357,20043,105358,141735,5115,27093,45924,123073,52599,29433,9616,238350,78610,24851,58858,26769,31969,24613,18294,4982,32735,39639,143563,112073,202205,12567,4873,88601,44897,81503,101648,81362,34662,85277,17574,48173,21435,221188,40215,39576,80786,26544,64668,81841,10731,37733,247986,149188,127703,495,18382,54388,72446,43071,30974,198723,89608,41360,190,33045,8386,31658,19992,237838,119015,137622,50890,100913,6460,116233,267230,26621,104129,65114,14190,41542,14888,85962,23342,23041,26453,43725,71809,45186,4770,46452,53894,56616,221286,18973,9038,109299,55365,19366,26863,18808,60909,69353,41738,83463,12100,68561,72860,3980,13796,49340,12332,31311,27418,4255,53430,18976,45523,510,14224,30477,26581,4530,3651,101663,139840,22709,150861,31996,63923,120623,262522,3076,10528,2929,14672,130238,18087,9816,121894,100308,25085,55111,14565,18952,53293,2042,369988,23674,61789,133529,28783,108293,35477,47119,36448,71049,40015,33055,78598,198442,1833,159937,40654,77444,189245,113153,8621,18599,38553,35223,166072,2375,11659,21786,89523,6032,12116,63046,159398,18454,3678,32521,47626,11411,103527,38896,42946,15696,26370,10185,8413,37080,165583,4331,63555,14907,72220,50056,6623,62236,36565,49783,10049,17503,100581,55951,146244,24724,9626,17969,25524,109300,173965,99994,101056,46459,43647,53737,277968,8347,123521,74858,33829,44762,77574,877,81377,222525,123532,30602,43881,53145,2973,16284,81940,61281,127044,63620,9875,14756,114829,19032,9202,52759,119141,23928,120551,19607,3599,33401,76821,73233,117430,39968,36539,7071,5446,121735,194059,15206,45283,6706,15603,65615,1207,165723,92275,34773,104447,8396,32353,205240,164323,13600,60555,79205,25532,22907,33410,57480,107111,69630,32137,47832,70913,33161,20321,2371,117348,10714,86246,1625,11763,17900,268,78457,99175,97940,101092,86660,32221,14041,128504,125080,53744,124263,31017,13897,403,31859,21964,5633,111630,5547,77329,17961,18241,84995,25984,12983,67491,62168,47262,5241,297,51191,7351,8967,147212,82060,16821,782,11033,82431,62957,5026,43459,77963,203477,53528,6247,191852,87774,74164,215654,13467,1522,219964,28589,244104,16242,117821,67725,72570,156792,17186,15979,26990,44128,193014,35276,57125,16212,166451,68017,6905,77608,16364,53777,75921,76426,37975,26203,269296,64099,84122,12077,38533,830,4407,20139,963,43028,38902,42911,37503,83343,85045,16979,1165,60835,137387,58380,86990,110066,134540,56331,193845,81238,17922,163093,38744,110641,12502,56404,34862,26865,125964,12965,111648,25547,7771,27196,136980,9555,29551,107158,57885,18831,37705,35505,101742,13970,102109,62548,124657,23328,11124,89592,146376,248050,6241,22033,18337,80685,29898,11908,216623,67721,106162,146610,21377,15085,91552,42041,62560,122532,125336,102365,121537,142559,29693,223919,11515,110495,18776,22494,5895,185059,103592,229351,51220,100102,37027,257855,29359,54123,36066,106493,12244,79258,32002,432,56205,94836,90182,6726,14762,29391,48938,26864,38083,60364,3310,60192,14766,205567,57504,110760,22649,24666,46333,21517,3430,13135,28873,27052,158809,11597,20529,6695,23138,22960,37137,45574,6545,305877,43423,26153,24769,59844,14501,10430,134352,56169,13213,103432,49523,35181,13435,12408,129475,64620,230854,77390,51990,15653,83248,33466,44571,117828,51481,2187,10559,68019,18021,54895,48247,18354,33737,4554,108595,37288,39767,116707,9175,3726,108877,21616,83684,49862,1938,8543,276466,20134,108498,48770,102254,31914,131520,185291,100559,51890,209,19526,76471,50544,71814,99351,8172,198526,28816,20419,9109,98389,136777,76479,75596,30635,165417,48216,120220,25955,211071,39314,24308,32164,2559,146280,43403,9233,17947,90585,1786,86920,125662,2457,64741,32152,32918,122882,78538,44001,31723,56426,23375,103172,88177,145697,52506,49319,68016,31664,41488,18486,110400,7030,28241,986,109199,19900,42147,56864,65287,49183,7858,24e3,30453,840,16673,25907,68916,89927,6309,158335,36407,199737,130464,13137,59603,201778,195292,21015,42466,179062,172561,89492,11075,180407,31868,72493,20998,60217,9865,19530,39274,130266,54539,21623,12535,13505,40641,73375,4087,85633,2153,3117,70680,55788,92096,47509,98493,37490,271936,151475,3032,16171,96642,34106,78425,125761,19591,3366,19316,54508,24183,50786,194248,91528,33253,34622,108355,41741,705,3814,3883,108929,13203,67831,10142,59754,68208,29128,84820,56880,38794,24972,48571,40821,40476,18137,164254,24064,236309,79181,11282,395,39169,2013,51587,28551,9645,701,109513,115899,113566,12762,62045,58322,103726,41343,40866,244102,143816,2490,70346,40973,52618,15412,30720,104315,38917,42027,93676,17513,107418,20706,123890,13399,97727,24044,87962,65606,44250,98044,65276,74790,101473,19350,91570,1326,87790,172042,7577,100813,86896,85891,41512,108130,27794,14875,71431,12835,156250,58135,3759,22476,42176,115873,34686,56523,73643,108505,51491,20838,12721,32863,45700,29496,13700,34294,55360,29206,155942,123812,7706,163234,203,132720,49358,144431,8130,175788,35818,3270,76832,25710,54095,97274,28779,94621,74396,19092,128242,58067,20885,14670,93255,15107,63291,23654,126900,129421,59294,262659,9798,3251,67344,28600,44629,50672,29072,26999,31526,23183,49175,165843,175455,17282,175411,32022,45989,30298,90690,78118,83156,23749,35636,31317,7069,80381,94561,133756,14960,97404,6138,41065,78041,32843,16601,34123,9559,146529,123377,96395,54441,42012,84257,123541,10745,22139,106459,11720,150883,172651,154996,110538,4728,53447,25704,2009,71152,119354,21166,66604,1429,216162,8637,122250,63520,27180,29172,36124,276428,107787,77184,4680,14952,104903,24418,14793,51561,52931,8371,26342,48526,7118,92066,67280,40653,8847,34597,105438,14198,50163,61188,146286,50315,41205,170829,161496,585,197359,95056,1687,365794,91349,48507,5804,49263,5146,104902,96365,117343,132222,46084,96919,16875,8073,262381,79982,52663,13928,16056,153908,15145,109256,132308,18763,24904,167644,13618,40750,18686,147124,114709,150038,52849,2938,12568,48617,8778,5459,44202,44591,74914,17183,248689,13878,7822,80060,23116,194037,18487,2067,7798,43077,33678,244028,31320,74273,2794,19466,8218,36280,183997,48124,19416,29656,19280,98734,7715,18311,30701,133602,150307,126956,7378,2933,79903,13178,12593,86571,26604,92446,13574,44205,65699,427599,21118,8245,14407,27877,47936,33542,7916,26460,117762,21596,37818,2249,127359,209394,60044,47677,308089,36791,154971,31417,6998,150042,174360,12255,43009,29335,48739,3912,101398,53340,2580,146939,151295,45360,125275,15273,45383,27456,48761,23314,8750,60801,85823,104759,27894,123685,66968,39480,26917,55290,83305,2696,98390,57569,145853,340733,4919,20024,52268,30884,7413,203685,70989,112855,4129,50536,349518,68205,332641,159581,135361,236026,37563,176404,64899,6578,122033,63871,1850,85234,82089,66124,74145,121098,107351,12687,36881,117334,13136,14698,85933,93866,18047,32620,310,15094,46e3,88451,23632,36645,27940,87618,80520,58892,20976,27702,140090,96075,67841,103292,238964,87778,107338,17019,83427,67522,7302,8261,47570,116787,8730,80484,61772,174422,56005,131193,52875,14588,28471,59817,9586,15720,158155,51307,109734,15196,11025,59331,3884,52626,102602,84797,25158,27314,4437,20488,76214,189248,35023,114952,157376,2827,62439,102878,129749,36405,10329,109339,108633,36662,1254,13267,5470,87105,58004,15397,10434,159667,21864,52022,179464,3013,32147,31496,116832,18494,105502,129227,107267,50033,13481,9954,24267,22141,16257,116154,36185,950,115685,11305,176708,2048,178671,112573,287867,162328,497663,95170,50979,193861,50987,30368,136257,31830,46549,15119,169876,23788,17462,249887,57377,1949,35448,14791,43769,210091,3783,34612,282103,88380,245190,5457,20491,98908,11402,86899,117916,16028,162584,60644,320177,156096,31065,55876,22e3,77655,9992,23397,13757,317623,63978,215255,2443,17648,93231,27388,104529,93807,55505,140477,12046,112040,70887,40152,94365,112353,25063,114679,266061,71248,119555,15589,2244,617,14129,211431,70110,100652,7777,4383,85911,89221,21010,120615,58357,86405,37554,41647,18,15143,69662,60491,14714,186134,148344,42347,5410,168175,44535,42449,343894,129417,99682,20659,27272,140483,63455,222159,17536,13722,42637,62324,11976,114691,148109,2283,32057,182393,4295,147364,33705,2075,44303,30274,28331,63740,69740,29148,10346,44862,33716,73937,153333,12930,38784,247159,2515,41053,20256,83368,256189,54639,115240,5096,24661,175419,153552,26516,141,138176,63885,34115,47222,55709,2765,28479,38875,236608,12229,22921,77291,54426,45388,2860,57787,114579,295139,105782,17826,71066,19119,54364,69385,16568,12323,28057,33346,34919,124763,155533,101386,31644,8627,49001,303600,29868,63213,9103,77280,71333,9696,138789,37059,24823,5057,21352,32368,114208,56803,19424,10445,58514,8661,209508,26187,171838,10460,63454,14016,122504,41328,21329,46618,32493,38225,7855,31763,7945,29876,8734,6438,24205,97490,139977,130740,47323,33195,85390,57194,13813,60600,21313,96251,7699,27584,170521,139271,1363,4402,336738,129223,84983,69150,13147,3590,163929,207225,155260,55916,20288,4503,8398,98490,11773,27512,37113,84976,86558,28365,11756,116005,182148,13733,115313,47644,67208,85069,9347,14995,226141,14704,101835,41159,35314,13113,63526,214039,29978,50446,83339,17440,129441,72522,118641,97816,24907,73844,15717,118884,167255,96509,162793,30847,36849,51297,78974,77793,10427,1873,2972,9999,35074,28190,64297,146836,46298,60038,163007,108919,61219,2403,75022,127339,4233,110389,69022,9833,128097,88016,79390,222936,22570,94657,28462,56956,38803,81536,30474,152794,19566,16481,147408,74574,81895,20731,1918,1366,76367,187321,54494,24366,21690,61696,33283,107477,77499,31112,414383,74362,18463,218441,120929,59848,258629,201924,69269,454,19989,13054,59894,3623,58908,20681,35723,78523,102680,38988,184112,108087,50944,132704,52966,21699,18860,96349,201411,82697,85395,95658,5093,6427,177894,44191,32755,26961,155739,6249,31310,81030,26574,84311,120155,86730,113535,7424,48888,13516,45747,98098,20077,183995,81945,43210,26704,40420,75831,45648,11180,6855,57927,65528,124096,34851,2598,156633,107572,127352,38169,123845,60142,62722,105584,232364,23211,68120,1601,22169,89299,747,258039,80572,7258,152249,11862,101204,8834,121434,33761,19175,133142,46343,40178,48723,3589,41977,30210,38868,62257,10087,82658,87827,90646,16415,47552,351723,28298,72225,91146,272760,1701,11295,1652,109651,300747,51863,198800,29446,11794,32345,37538,22356,33102,37590,113544,37970,11478,179743,25454,103417,59905,221970,105196,145604,7817,164809,102360,16974,75840,255333,56902,6659,1954,645,59400,67769,7689,18675,5215,13793,20536,27852,3387,29523,259718,16860,94625,43143,29245,15848,233581,22685,63631,78557,22836,133302,84513,1348,51826,47129,98836,58284,1830,1749,94642,10933,6145,12506,10975,13879,103781,144434,10268,28409,32346,52968,121567,107374,77268,23686,35097,10501,155275,15303,47136,21102,168741,55332,90385,15996,84817,681,137803,25054,142275,6163,38175,8056,124296,240642,65621,4934,178205,16101,62803,60964,18230,100622,76465,44689,14545,9543,47514,16852,93380,28048,12047,107106,37575,101485,77047,57326,34819,96137,76916,6469,46264,115983,75768,87668,69942,13027,165,8373,114231,26434,52844,42799,182044,23580,146254,38081,43236,33883,146220,382894,14606,46035,36481,166621,35417,95382,2957,59384,60428,36358,66343,75378,22267,22950,83528,17577,56474,25285,4619,179691,75355,95836,53295,34588,171410,4487,14679,84208,44015,18562,109133,54101,11531,86052,174479,303157,28095,9953,35642,14564,39802,16145,77606,117406,53038,121117,53624,22062,1212,7632,127157,237292,189087,10478,127345,102515,181997,86752,87623,10966,121602,68783,68681,83042,114380,138349,191305,67176,50085,39016,1427,42384,1412,67118,122616,72389,25260,2237,13576,137346,19938,20304,2191,68759,5373,61364,238507,75814,23931,69565,38993,131741,38364,12528,87762,5679,129853,5310,186831,32653,90338,260176,389531,108118,26843,43985,50175,30563,25106,56965,18130,140428,4542,165503,117991,24219,229605,1819,129663,1240,3797,76093,18398,71339,51919,93043,27175,47060,216257,6483,35051,1217,16512,80798,129064,13225,69339,8548,237079,72298,2575,34280,51379,117910,55671,53345,247552,29486,39328,140821,34681,57045,60177,5004,90269,78522,2479,322607,48474,61296,13057,31558,4678,59271,6699,27044,31988,35944,12503,83480,4389,136508,3781,114121,70279,4488,155829,42214,2898,68191,75695,305850,45041,74344,106509,30087,17429,93292,12477,290,23080,114802,35714,18751,26554,105424,17775,2144,2412,100610,65192,113975,52975,180272,135050,129815,76238,106483,21440,63186,4260,46189,9711,28249,4169,23429,23390,8324,141585,63809,67668,38457,38063,39226,59972,1189,203916,62368,14403,16949,61767,85801,1739,40147,35049,76757,33124,62102,15780,103593,103009,53484,22952,67973,114645,6566,5245,50462,7601,8288,3513,194571,80276,1908,54592,5124,58571,2513,6800,273997,193904,1119,17991,117245,2508,129156,82366,26278,71465,63341,56943,39662,106116,94966,156875,9736,2204,122308,94418,27134,1280,24539,49022,45314,3764,50904,46424,30699,28087,293839,9400,33646,40165,822,147499,50263,116179,29085,11863,31314,5578,17797,5104,12454,1604,15342,219206,10232,67800,94261,25872,13565,90339,78971,75377,26649,41184,47695,11514,35369,20767,14227,41953,309396,148270,147938,33074,14453,27499,109019,39018,25738,240196,158931,52820,8612,95853,21524,137010,84901,70869,70021,116794,48404,38771,6732,1070,70990,187297,49140,5238,576,3564,253975,16027,16483,2811,37775,19034,25259,4053,2e3,70083,95774,19713,33431,92703,91314,42381,288770,48194,95985,3991,77418,13406,241328,245086,56533,35275,62725,9246,51924,70181,95331,16163,31410,79016,39312,120878,119371,275987,80124,27712,9186,220,23598,146167,85209,68238,282190,57048,31273,30555,80913,17594,75779,59160,135002,101219,189377,29225,96735,60126,62522,104e3,27620,86814,17240,147533,11001,5425,43682,410,49460,87270,69480,46315,59448,1816,76201,9431,11788,87960,29063,65539,47347,11678,33846,7008,196704,9895,6753,8633,120892,59970,572824,115934,6646,202559,892,48351,37611,251282,57823,67263,57750,26527,34485,90747,7685,88370,6144,64182,1709,41969,21458,62327,181657,49247,225330,122600,114574,107124,85361,111833,63243,71420,15655,191178,72430,18063,51425,54002,12364,53225,86557,18193,97580,41232,138398,67821,128724,8944,233212,101353,52099,42127,14006,120107,32789,32132,3498,18123,33758,56058,5779,128760,59888,98869,18445,84702,51911,13234,218379,20093,39031,8074,70195,20708,23462,24355,131384,60189,26390,10403,41060,7140,10781,49410,42261,87202,82566,41663,43105,60276,2768,5733,74176,28329,2297,145430,131632,83615,122915,105441,655,224102,5284,136426,67763,16294,188511,32538,61049,27893,3394,13951,159099,28542,17930,145360,9492,190122,32285,78855,26440,13570,58648,73908,4239,124561,2444,74172,53131,11468,10794,73566,11623,35343,64710,30481,4163,10328,38309,29901,10538,154377,76132,92405,24839,11679,3465,13449,11637,7824,2337,57754,1260,14458,41118,19878,38661,13416,159180,37074,163164,54137,28627,52134,184900,8520,40385,29546,30502,22386,66527,107458,6850,24022,47983,30603,35083,8934,304066,39500,9,28261,33026,77251,9374,44833,116312,34990,29236,63563,125639,135405,165398,159055,55690,88141,69643,236964,31983,25572,20436,36746,60896,31850,16179,11828,5888,3043,66368,9750,31167,7915,53111,36430,1333,64344,93659,20061,60596,180191,51630,6792,30244,43509,101058,22409,420,44210,109783,43223,27030,72477,72831,32679,29235,7675,47556,12258,39907,149412,84926,118247,24692,71717,105038,86009,45941,41189,89453,29856,52543,30627,226798,67303,59230,67415,34408,1367,99685,16867,128419,52147,4111,125381,117881,16173,44093,102224,31575,23234,24870,83790,127407,239098,3200,994,1255,100903,242275,117266,55116,38205,16140,29662,11307,40414,208793,123355,56470,4862,75600,30119,58218,70828,24075,26974,7802,192353,4851,5475,78720,66596,3409,28573,64396,30381,30690,59859,88256,5406,99945,103064,34463,37727,24238,86643,60088,4057,23741,5967,162904,38240,28356,93858,25510,122879,6897,3278,7057,11971,4400,35461,211413,21395,59615,39471,87233,55795,128426,3051,22470,41950,14705,3974,180108,80476,78442,204996,91987,15634,67610,139015,142373,35611,51134,10387,4353,153456,57749,181039,14183,68447,151532,21107,36452,20551,3186,46247,46383,129666,88736,140662,146243,2066,8360,7978,64818,106963,17896,47801,10723,114821,223295,74192,3293,3393,16987,74064,11277,91622,4270,29828,27951,387869,103235,1374,61988,120083,477,145892,128378,11779,211263,61354,18221,17869,46530,83061,108538,157981,90608,67199,95080,49064,195814,12302,66307,10348,231346,160732,112859,63633,146558,21271,31037,198802,47622,12862,95710,3910,77850,73961,85585,34752,61e3,4082,24595,103679,71107,8208,79568,150019,16615,24961,139857,32664,197366,4559,54735,32696,4126,162019,75698,13916,70108,159638,19834,9349,24675,175560,49643,18206,52459,27992,10809,88865,401975,133172,29e3,34558,30915,3658,25834,42430,36562,125265,18182,10155,40149,97082,208980,19575,60853,90529,66545,9600,789,46420,2317,88593,55595,98980,115302,5742,169155,1073,177901,3472,11189,63711,78643,65472,50459,127979,93,42202,67053,21720,157650,11145,141378,42033,22824,85705,79114,35584,15974,1510,54172,28562,12451,104226,19190,97151,73024,20948,5151,81741,21499,29006,84183,198074,54003,45120,170125,26240,35177,28389,64863,79974,60778,176915,232183,45342,2038,80253,41564,40703,32689,5430,100689,5366,23007,134279,14266,26712,73993,24934,64242,52113,102887,61801,46415,201049,54251,62133,122757,164883,30815,139966,2319,30842,766,13362,10287,134518,86111,81665,82440,28333,43019,18963,8804,161944,23439,102144,101145,80029,39052,248708,30350,117340,11878,128467,974,138625,63961,5237,74778,61834,67040,43814,13690,65947,33809,232476,115258,181745,28824,94013,9510,10246,93722,81976,7217,114383,3493,16014,69045,72692,12145,80981,9507,6692,1620,60820,330444,35474,33962,4797,7053,295463,46445,27026,12491,77988,49524,35675,90947,29114,166705,101385,133782,32704,6186,84595,176031,185623,45966,151302,63069,1699,107491,947,15458,74452,196212,6046,10498,12163,10239,35191,243951,9277,9090,29539,54460,22820,26514,112549,60372,51753,48756,21812,70861,260326,41,44222,10441,16961,48148,138771,216194,5914,52153,53400,212036,56519,26245,10117,45888,15294,138019,90913,26368,43842,42111,23348,6082,194845,161089,156206,51546,11647,30759,302912,262094,8635,78876,26535,35283,54183,31183,85484,147873,12989,5197,6356,72894,65347,20150,27370,73787,1493,45918,12366,190217,20724,13858,10981,67449,81213,7553,14115,72242,271517,11842,48310,88743,143726,22177,3290,243231,58452,62937,12592,1654,40066,33477,13751,9921,128442,15868,7106,75236,83773,10775,36938,10482,170465,17368,17469,161508,32752,98340,800,19824,264456,3901,87319,2867,26782,9630,113102,185815,24197,44584,86366,40224,3636,140916,31731,267731,9567,53678,72984,29389,27963,17106,50282,284911,60170,8322,12608,23374,89652,5268,39044,229766,8869,151350,31436,177342,12269,183212,120418,116270,2843,78888,69192,7865,184099,1086,129897,18383,70508,20242,18508,229924,124569,35749,50589,55626,9884,83115,40971,30671,18135,14452,38861,17844,201826,5549,26413,17189,13561,38539,10679,143331,3314,36785,171194,49685,187713,67506,4618,104039,17060,195080,50648,33159,19238,67559,134840,28599,157523,17130,38064,117398,94355,31918,13575,34538,40326,13997,3494,348283,62481,26862,3603,104426,244363,153709,112487,304612,199674,41239,35545,54869,293005,28223,26277,26899,4533,18518,15492,38587,80488,70485,160395,263,60162,11382,222152,4696,250751,51921,182609,10707,48463,46243,1227,49111,111564,46502,33342,56846,68541,63559,858,139927,16654,229375,76759,26478,33205,95828,23399,92945,2637,35630,28470,143992,50214,14174,21456,166191,65665,1711,21594,78019,97599,111701,36,147151,110246,189022,43021,30397,40757,131935,42065,73335,48039,26596,28984,15102,2361,7421,202167,69744,43766,52826,3642,83304,33873,75140,63169,192389,36551,92748,13039,123959,233220,21738,84447,77230,20228,187852,19095,25799,92136,108774,29237,53947,2299,118106,2687,8830,42331,202924,33667,2023,73763,30704,19363,19779,16737,35629,48081,24068,101013,162338,291912,13749,24745,328289,167679,70086,48299,23306,16732,17801,43322,54589,3586,63653,43624,53474,925,109177,251316,43805,13082,19511,86565,142182,92461,17117,101033,103319,64589,4022,4351,235897,5352,82705,107142,46391,156084,5860,61365,10558,13045,7717,18357,33922,12590,33065,6928,46993,783,46937,67846,8952,26295,6107,119656,18799,17458,50747,4229,179559,112727,118080,20683,41464,125468,51560,49749,44231,7359,35339,62988,136487,67015,5208,29150,24956,105186,48858,6143,18097,6972,16404,73489,58742,97196,36357,164616,5834,32267,13746,147733,15113,132091,34127,106298,39729,106426,22294,9780,15602,36213,71502,42808,66802,599,60755,5851,39120,67363,108623,126368,72770,91263,32486,30596,151717,7951,52002,43103,11768,68942,40901,39344,24037,127500,116890,48403,16926,86750,17745,48648,159545,34460,58419,5634,114317,67865,31462,23352,24010,98185,125708,69686,68337,13610,26271,70691,2980,4768,27225,102402,75453,28106,8104,6931,1176,6274,6475,112635,22498,6176,238686,26832,28893,90319,14441,15682,15087,39517,45270,109134,104440,45965,47645,81772,7876,52683,87720,12898,4505,185665,2769,113401,15664,57592,105229,137381,97059,119268,6876,43309,33886,128363,35476,144249,67013,143587,83367,25703,91436,59347,53236,2289,16519,19844,46309,58558,99834,23313,218816,231303,36388,51333,183535,109792,139277,54306,90139,18235,8275,32710,37677,82464,86025,92204,88842,117723,37570,128723,234242,76350,73795,34896,148247,58424,11105,11744,45746,63372,17118,49772,199520,81902,38004,22911,33752,3125,1995,53792,4689,26909,108150,146062,69674,41811,161444,84855,8999,28561,16731,93937,3189,21967,24890,22943,1356,145300,51569,28802,517,118679,31703,40607,48098,108854,25003,10233,73969,177495,5248,24516,215347,146192,48712,60626,69188,40735,5866,586,101541,6509,47590,52129,5969,222045,110933,25733,24223,65339,62812,2414,155418,35819,16022,78423,43138,20995,128255,240673,46745,236093,72176,57085,97841,61248,107,36068,193177,105427,55726,215229,20446,47228,100420,87091,14429,121708,23605,21157,187721,21880,2997,203976,99166,95068,25877,7724,98925,83401,4829,13182,18229,13718,239662,38653,116505,153497,30589,89029,38962,181302,43853,78872,180301,4786,248240,7401,106136,112590,77745,19731,60880,77789,125748,135487,5975,48627,34084,12419,215770,47557,254582,10364,106495,21856,67539,88981,38805,21428,48732,42316,12149,16078,52808,25327,51322,33850,51147,12253,122354,46077,56483,254553,115417,81834,150991,94662,86668,7381,12841,100650,18218,15741,22372,68294,50705,15535,84660,61887,22553,72299,31361,24824,17743,46820,64288,31582,77006,111674,116384,30760,80920,86149,77192,51979,79691,60342,122805,103800,240873,160744,233114,78962,54920,8608,3484,316104,72548,24337,5088,230040,21926,10172,36838,26,86221,83458,102176,12062,17571,41929,41170,28428,68239,41750,103930,2634,18313,53019,34825,97837,63115,24606,73157,152474,14715,91439,37033,109806,140259,30668,174760,380,135597,95673,136073,65073,134249,13829,17279,122305,4420,46444,10237,64848,203623,70728,10349,182885,65075,24519,25783,40318,34139,22222,63394,55266,102764,41422,20126,65100,90408,53640,35128,48932,11192,38935,96839,34782,39492,19396,41332,6250,5511,19492,51304,25936,104466,54099,73771,86115,5080,7669,30891,111700,13931,25276,72289,135447,14820,258641,25265,31005,281179,75286,393,95359,14623,13584,6680,101227,80173,44933,76666,54542,13244,39348,458,25379,109451,134348,81143,6959,65554,12027,51311,8716,57589,140731,28467,23316,17272,30458,25980,55229,77197,83798,28302,114784,7428,34548,26241,14712,39336,103304,18928,54080,12870,334,87722,15208,16895,142098,114262,39820,83913,57817,28682,7721,14900,108672,11250,62246,42849,415188,1724,26555,24549,25505,26443,107450,145899,61035,43528,6901,60726,65906,267741,21338,147590,42079,18924,73017,135236,15393,5206,4026,84185,1531,5988,113890,82647,303391,7386,69844,71611,189865,76523,31877,13315,19314,198575,32821,1928,67641,25913,104475,103489,3297,70391,18406,15446,113347,19295,93790,27856,1792,167471,116449,8541,4408,41757,63233,25765,86680,64501,27034,24816,34975,6079,4486,49693,36229,16917,21581,62426,27862,11612,54284,35702,194034,355,24277,48262,87411,70504,310164,118018,12516,47559,43502,57433,107139,9290,66533,80863,14634,34312,91725,28606,21342,67241,72355,43244,375789,37402,174015,105070,8342,44167,67494,1890,16365,11723,271002,1865,47918,8350,45564,27742,25110,125803,8553,49504,81925,62211,4534,15491,19011,80373,206920,667,102405,128623,245524,5553,113309,192739,65766,19567,22832,261958,29679,21293,71134,20962,105123,24721,860,21752,33448,18372,157167,94822,35770,173224,232737,75729,28937,46828,28062,25453,5207,140366,36665,30652,6169,67920,150458,92040,23186,184604,92330,20891,176492,49427,27828,38305,42495,143982,49560,25503,90043,29747,65328,47830,12932,11068,77721,9003,25213,94205,140426,46090,89945,138173,192691,33329,112232,129905,35709,27514,1841,19957,31411,127476,53572,17497,173549,55063,175135,19841,69314,5192,237921,117660,150697,4060,273045,50414,98940,65348,153665,164423,58804,156695,48994,213928,86036,28608,8355,39574,34540,16927,135680,18374,151587,10830,53805,16878,16623,4282,48030,8537,14986,46102,13062,72897,72,33050,108227,39451,45935,651,113320,40535,95176,57450,48843,5003,19019,10407,211163,3848,1068,4988,32091,30095,41692,15099,43602,107434,50744,7627,171349,16313,150832,352665,207750,33937,38256,51091,156e3,87889,90663,84175,24908,114900,50365,31494,83829,5398,169342,47521,54818,18935,8356,43094,41212,174536,10082,92550,6678,60614,23355,69721,14796,34149,128830,58187,3179,208,40325,28399,225029,401412,51150,31580,207268,6657,10993,69818,64282,289845,23308,12961,38447,6681,52944,31855,2572,47646,120728,179148,37240,45196,218274,4816,3695,21961,50084,35209,18073,51452,27004,6100,33941,1377,84831,171214,85,141510,9078,99227,32610,6417,11718,49868,65579,87902,73018,49062,46280,61742,21512,40862,107733,15941,29168,157765,144919,14487,5767,158014,140070,7241,573,71584,16921,223566,40331,179473,35081,47926,140885,41508,52104,59180,42310,32811,29048,123517,102413,80208,10104,14746,12649,153641,126022,37965,113017,4171,83,142592,2809,6362,50416,71323,116894,260776,16204,1524,5760,30351,12658,20703,54403,36083,45408,74772,4946,14485,50759,111222,10890,2195,167147,92962,130534,16283,177256,35016,15472,210156,151187,73922,117691,43250,52051,37392,24811,24358,30830,5775,818,21969,1476,127322,151783,58392,31021,106913,65215,89407,90802,28531,11690,20234,95249,44602,37256,18707,11928,5161,4410,26571,51903,49768,22008,25252,65780,209499,68769,203726,13249,137363,48845,86823,6658,5674,31881,1083,1823,108676,34518,166752,13791,14287,91576,91429,8665,11529,26401,16191,91972,30964,5254,28486,54697,79613,66520,18447,22870,45203,194466,22822,51703,12278,76716,44595,73455,33546,12235,144843,36154,51247,11116,33040,3180,225753,60864,1972,28469,12891,28879,10338,144157,56294,353058,38302,41447,87532,110616,27065,168438,6557,1213,50804,144643,24817,2390,136531,38174,247513,16190,4059,122791,131994,137430,39506,57650,16305,5188,54309,106128,20628,88071,67394,395446,250285,66176,91254,1399,114196,43915,60230,44853,27206,106353,43013,18733,345105,226453,51202,16607,57106,117175,35492,10476,89598,127439,15187,39624,13688,61570,10615,31111,59370,6238,175252,32143,224492,41388,95408,34384,148238,78307,38959,9340,160091,61443,15737,11216,41244,170,38299,102443,113097,26382,14027,33707,3957,76300,66160,19431,18900,6952,1717,108656,82206,188021,257335,27295,43999,41210,31777,46956,57457,12657,11489,15697,48060,204748,53583,82422,284790,30503,137341,8120,19615,220311,15991,10217,63424,9808,67431,70976,98221,4491,15177,28535,144789,751,13230,2394,1504,33977,132104,30316,22230,931,97193,185240,24826,22687,174322,15307,22988,1390,188745,180325,29580,59068,74903,18994,29195,79,15436,7622,38462,11566,138710,44828,45774,37768,99236,68137,84083,19282,22698,17134,74807,126662,173497,46248,16938,119735,3212,28292,213652,49013,9975,32180,45660,86250,4801,68788,95490,77482,113751,11994,44624,94452,46839,128497,100316,5798,58588,73184,202987,65417,37790,88524,1606,43156,97964,105717,34947,11203,100060,37742,130074,93653,107799,94311,196106,41347,8035,10780,16390,27883,118236,167395,1979,25006,19375,31628,18916,144723,78502,114047,103107,86492,107686,5844,20934,206963,23556,22591,16562,146333,20167,10471,117434,33085,2863,9740,36669,41849,37271,22790,18209,28979,8231,12952,54408,21731,25130,45208,55748,138120,75826,414,29593,9925,292865,25999,683,123149,7036,92159,86055,61827,103680,23176,54918,58466,57578,13305,5709,86479,16697,31064,17660,200919,10770,49793,33423,32370,52047,16488,62555,6459,8426,83493,7763,59725,82812,18628,67760,79405,68557,9612,7673,28102,56517,69620,171797,32458,29541,15870,81109,32080,207644,71495,21202,11039,91036,61230,2810,130800,32260,4613,60590,37112,75214,33979,126402,155062,30642,63875,12810,194463,82799,47664,16725,36685,43367,61099,449,172150,102867,21691,301838,36745,7130,18671,57316,34852,38034,54182,35578,65900,99486,19771,3456,2658,16914,99866,28390,28109,8262,21147,34353,20006,4228,137085,1675,203023,283196,198286,214375,163329,290603,152574,40471,83506,30068,14730,23177,131539,34759,27668,32178,71896,104799,116305,85430,119262,42860,25160,8911,23428,49437,105322,6519,16203,6349,74711,1230,38045,8540,75165,44736,25909,51026,317034,4984,32281,91312,27060,44431,17817,45363,155937,239085,35697,59784,91993,29531,126740,213757,76560,167776,285273,24262,8237,65030,41160,74437,48804,118916,13159,37842,1031,75349,1478,11655,108777,23435,277425,101734,67469,70231,124711,43532,28514,65526,54956,1e3,21882,17728,25302,40952,52214,149632,1999,2111,3259,63362,89961,220561,39777,26335,9063,10572,12416,34551,34623,38604,24723,5947,15588,69927,66252,119177,69173,46629,28714,70715,212408,20521,406913,74380,11716,50659,50862,37009,88460,130101,7210,53853,538,65120,151950,55806,163748,52837,13153,21100,16674,64536,6091,138201,44837,58547,3723,163,2177,32288,85454,34033,8497,14282,25742,10535,10741,79559,117493,243787,49337,100718,79495,40139,42956,7551,55433,15421,31509,23034,45081,547,61176,53434,328001,8470,36263,30145,4519,74173,53935,11845,73774,60211,78025,3,4102,73782,109293,315332,48412,26683,13714,6865,20128,18490,104141,325,39470,171970,115860,15707,7268,73301,74336,31370,2368,111827,107757,136231,142844,97138,96638,84053,38691,23801,1588,10573,122098,77039,240,186135,146101,11996,18143,112963,46171,155836,348769,47795,121213,116266,132515,3344,144804,31286,99187,255838,129694,35894,48779,55235,148582,71967,65282,15174,13920,47080,6147,108242,157593,125025,7136,1286,28957,127956,28402,98813,20805,7532,109417,40610,5041,32958,15142,18408,108596,33543,50517,27748,80114,233434,91447,487,37094,100048,30541,43477,10639,89862,155868,37667,8726,60684,237903,73408,99589,12190,38739,97348,3914,13594,2680,149016,13907,30171,28343,23530,115225,61104,35821,147679,14337,4297,244282,24085,326976,56428,7851,21303,131620,71446,83253,68692,111870,5224,15813,38197,49026,45057,13660,3306,76345,40671,27905,91072,996,68527,62085,91351,122634,55109,168209,2024,27560,112707,17352,8306,167115,169921,166958,5031,46020,11844,67284,19130,76185,6920,32849,5450,14610,22451,21002,17392,31872,66682,84796,13709,40210,59898,12029,8719,53564,21462,91884,21647,88379,194428,12754,37797,132826,160016,22567,54383,53186,77611,31107,8339,4694,19185,90355,23597,17222,140675,28442,23668,55977,9128,61555,28774,155229,17658,9390,24379,69357,15752,127381,239631,62460,93181,55913,45133,140155,18676,25249,33164,29581,82837,67223,22362,29975,7317,52813,1943,29613,20012,207130,49617,49651,5636,15334,36313,29226,28084,95247,72072,19e3,224932,15811,114,32127,38097,37508,88507,37225,27359,91626,12193,69279,20608,11055,88156,92808,2152,57259,55275,72789,24475,104414,1708,9882,3818,48661,66897,1631,34806,227930,85815,87753,18321,250664,72733,25107,206797,50891,8082,196411,92596,96764,152823,65514,22819,387277,62176,51225,40329,15563,189,3659,73670,64357,51793,275136,33482,86653,74615,67058,11318,125720,15388,22388,8267,1730,102663,170910,40784,7144,85373,13040,7088,94309,583,44224,140424,77439,18496,164026,36578,4722,9151,5824,63365,26510,35199,40500,79277,32495,44614,35233,9566,203293,152144,7097,2330,183480,98629,13423,330887,44130,68600,30939,97829,31012,345465,56747,94879,4939,160027,149761,99423,46099,32251,15332,8761,96094,128555,5763,235318,222223,55729,30241,55420,201746,3987,81382,8259,49325,23287,7719,24633,251100,92311,18591,110533,64759,170260,393860,7175,21144,132887,3593,75346,101277,91109,16387,259187,11627,57459,173829,44694,55780,49797,89192,120443,62622,3904,14814,23887,1027,112258,64955,99800,11132,66353,36202,48624,18158,88481,96882,43059,11040,2455,7077,21651,181159,99126,100434,61388,68186,19161,110468,120052,8819,55324,41494,7014,37689,3618,87729,92615,207943,9823,128657,12587,15857,6379,67628,51216,71775,157617,63244,1503,3864,218754,110864,5769,21492,7243,1192,87921,85529,31512,18537,42698,35350,73510,84474,34301,8991,21013,35034,566,38832,19838,35586,37216,39413,55006,12178,59742,856,84563,6900,25632,17437,49786,30723,13847,70845,4044,7843,23944,235976,55530,48942,6518,20939,73769,192653,52936,95207,23895,132542,142982,22632,87452,48042,54018,178468,10728,26230,23559,363,81269,142012,5718,346258,31456,84333,246476,51018,66692,101804,120570,39962,30373,70593,2864,60541,19425,54209,104092,7201,31545,48018,25865,15442,46257,40443,8328,6451,111782,47527,97754,33046,470,245116,31095,39,91934,87208,73470,36708,36521,12801,70624,36272,8892,79768,12427,55454,103756,5908,52390,62962,22720,141138,94634,41689,128402,126390,6628,106394,35527,134394,82727,254651,194502,148064,89549,3202,28359,957,21954,27906,49840,142747,8307,24206,48978,1186,71728,133038,71474,91306,6333,110959,74600,70387,18983,62609,56057,22970,1147,135850,1321,28834,3578,59715,102227,32827,81415,99952,55636,257598,390,22702,35701,85872,402916,39216,189795,14929,19467,10112,144422,61514,5279,63421,134686,41436,8424,51925,10598,132295,124416,4604,194739,210929,57866,31829,51626,50007,9976,91878,61906,56168,81906,60918,61859,40017,23059,16887,40927,62064,12785,32893,32913,21782,93965,20169,44387,79084,38463,11457,93950,27127,157050,2697,337088,5116,54128,48255,33279,8821,27352,25515,124022,65710,28906,38557,33390,1722,104435,72215,38551,12094,30978,25113,6671,37355,175109,42862,98024,65406,221276,59624,118012,64637,78760,86697,21426,1639,40350,12584,67193,84144,31396,7863,143011,69629,63112,9454,28666,65798,46372,134721,6314,51402,30837,151922,2847,38676,38008,92823,136245,17540,5504,109295,205242,37606,5211,214892,1586,20670,208711,137743,19328,40652,16995,20023,14657,154919,34422,12996,13918,38221,47690,16398,2959,37680,89122,6721,198469,91876,172043,83898,101992,26084,94570,3635,76958,22853,76497,38266,176590,168403,44464,142840,79180,184594,1984,41806,83147,11985,6546,366068,59732,24533,271505,8736,39084,222992,93429,28962,58985,86665,8432,30028,14548,32439,54424,165029,55175,27458,69046,121277,46168,33732,20661,24581,135574,123110,37556,79260,72611,16957,12939,46162,58238,44907,72936,253758,41324,32518,96480,11949,124438,65280,43256,34107,53533,43531,37037,28366,45970,32741,173438,6121,194202,62969,26355,30314,58370,28455,1848,50519,82830,90393,21761,295490,10936,256940,133568,44050,20269,4089,27457,21610,219460,36743,14821,101388,52005,13124,30979,140816,167362,26054,18458,60789,34917,40447,26606,33422,9066,3452,83614,5761,20263,137238,25038,91310,101,52322,74548,42572,38084,214054,186568,31802,17665,30620,141936,37730,14420,4265,187218,49640,188208,51441,55388,96452,66659,40869,42039,60967,221027,19234,178581,29105,96050,9165,196118,157335,3738,40354,117436,2965,34136,59659,15570,50843,230035,31444,71260,43886,18316,5387,38500,168508,17406,32174,8828,103373,143806,90367,3560,18719,122310,16508,26719,2541,105429,6645,37998,73190,10591,235916,49737,87112,233941,53188,32193,79154,4544,52905,126477,7580,63501,57314,3216,31337,6541,103083,60846,49,9756,15481,1355,43840,14319,13743,27486,10222,73114,230718,418644,16706,6674,279748,23058,45273,295831,86306,2743,5535,88773,21829,35253,120938,31153,3169,16839,42847,8751,80974,33942,36867,35514,16485,26474,77775,56877,5391,48346,3882,108713,31403,27804,55248,26235,43821,136104,40118,175507,28034,203908,18732,1788,34030,106427,36958,54359,7251,44936,15356,69139,455,157915,22173,140291,50348,43275,82066,49621,54952,15216,36226,96695,66855,6936,1987,8227,196087,4631,68827,99004,47541,110265,17953,147605,110242,58520,31312,38724,329975,642,3155,34497,75937,6207,73843,6120,17249,51429,117746,3218,910,68961,319671,14938,29555,34700,1649,66673,72268,9655,76800,153087,6941,210168,27130,35398,1780,73242,3135,56689,19556,165307,8765,35967,121458,13333,70453,17350,117253,22265,13340,44265,39869,441,3742,135025,23581,33309,16543,17731,13291,157637,283005,21408,101360,63887,52312,83873,5338,233779,23759,186949,34531,177320,38069,156465,91004,19353,59852,68160,14891,1338,1072,29823,1950,28901,81407,313445,73038,84807,162348,240257,37162,138934,16111,58013,41253,102951,16457,96056,19541,56402,67217,41638,94381,89674,29481,37456,80815,151579,13937,13683,132537,19699,134545,67020,29816,222341,141235,427578,48868,129557,233342,23077,87871,16213,18728,16184,9469,37913,19680,2798,171356,178328,13216,50049,72690,71904,124644,55455,7504,29052,41036,266546,19899,30391,188755,8659,59469,16,104298,112943,53865,76203,138226,68857,139953,14125,107625,119795,173133,4398,50273,48808,54390,16466,122086,31835,67035,50971,48859,7508,46427,66477,73021,84615,39985,83076,46779,201569,53336,36443,60865,168164,143810,51393,25548,169307,32896,24485,38424,21837,29087,275813,51674,6714,64883,46169,187369,55186,76192,12852,12018,62134,31067,118303,16542,12125,10579,4928,26291,43854,7091,10946,253716,109062,39283,17261,113012,258512,47764,125126,32646,55892,80279,201623,149872,3192,385,1208,48750,5376,58738,22335,5427,82416,47811,32435,143086,38930,94128,59975,156037,37977,38224,62485,7698,50405,71027,16462,21559,136153,34131,107506,162069,63703,3101,215029,40407,4178,3774,9187,80019,17880,97926,67579,2600,18405,8351,47924,86638,70820,92206,86453,29610,42241,119200,3198,15466,67813,57863,35454,4779,99518,4649,104641,144269,33730,38073,65864,6838,109456,193298,154007,5623,45741,30846,182578,25573,157224,1543,58575,138703,146140,44971,49356,18275,59064,20300,13122,11848,24453,11973,9797,86843,2919,25530,49210,1130,161220,76788,75373,85604,34926,36014,17777,17255,51533,11676,92226,51845,119859,21525,5936,18507,28050,1140,31418,14857,34207,47859,10750,36382,32079,106909,59426,87757,38393,110042,15965,97104,33757,35344,97993,53979,33651,45407,41884,82515,173089,7177,58371,35365,47543,51927,35587,10670,23544,29306,84233,39976,76076,62097,9007,8668,28119,78281,120790,19835,143020,54968,18670,64959,20649,34469,42570,33001,136570,87796,120044,1106,58700,63951,127623,12805,83057,40212,31773,49850,7361,54336,347524,101314,23751,19569,48791,29174,49369,20467,7465,75842,38281,623,112457,60210,28849,51003,94720,6426,90047,85560,43761,3579,85105,34607,90410,118528,7224,42907,111163,18168,6960,161135,191298,5247,100584,127552,171568,20121,91173,12636,54615,20199,63730,98105,2396,40387,14438,125012,4765,33235,12865,45299,37728,82098,77872,114037,59253,19675,24838,398016,102561,11446,17069,57508,178277,65836,99941,26114,2585,271882,136866,50126,11027,155648,118367,14585,8910,123015,335383,40434,41016,53021,14439,87098,176860,201543,121888,2358,9286,5739,22666,54270,37884,169381,33984,93859,16124,89364,72207,51639,76366,99029,65812,2198,12147,174891,194289,6986,30252,88822,21284,11445,288337,160821,33034,100869,43852,25761,52882,1144,103809,1924,84458,86079,43411,13542,139276,18141,34978,41298,7276,26481,173800,33210,17951,142652,33616,33677,2210,19941,98568,2486,192414,80136,12058,235883,50963,249638,29572,27221,47034,6124,72107,63346,97620,158513,299699,40388,23235,37176,224244,198386,121323,67992,23827,63170,17838,106622,158590,26807,5345,23489,91891,55474,74834,37981,13058,5977,72552,34706,26828,145172,19904,21367,34043,960,77092,91381,4733,47446,7680,41697,5170,16960,14741,46101,13656,473,51842,37433,11103,11551,121951,13191,97536,165932,50397,51628,129028,9069,44885,6590,59195,47045,32940,225472,90345,21833,13303,29407,96615,141951,5198,6028,18395,7181,3861,14966,156358,167182,36529,55253,25942,173153,30959,27261,50691,150176,162201,38467,48462,80602,42163,118482,168,108756,26011,17166,54149,456538,22512,91374,13816,90358,131615,18132,226707,1824,28139,26860,42253,93877,77351,65575,8980,80574,22020,27948,40422,91324,76376,13528,39281,91685,82215,122541,144066,1983,193851,17283,26320,2739,194978,4790,26845,42627,61300,65815,174612,55133,4200,191130,79771,158321,52280,166796,221620,62461,11278,4067,88152,83409,31717,121367,13522,47325,37945,10406,174348,249321,154101,64912,29938,51775,17220,15776,166138,78890,84425,54121,42861,16368,24572,291647,10197,32073,22651,11677,97509,26952,35787,18424,41910,71614,94977,72318,41594,70024,275419,37702,60199,7335,39107,61315,18271,18394,33768,87884,104277,123724,7277,56288,71981,189803,49320,3352,6798,14240,8954,69220,94433,57372,28620,68863,193727,85575,42309,41667,67689,42081,22543,44824,12719,28540,114236,101553,27638,27296,4300,5353,4663,19379,94098,3758,95888,95144,80344,87320,28447,259518,12718,71391,152731,37063,24132,31911,104896,15672,103782,1521,4945,72541,23717,122632,15619,87175,206120,29428,189780,61416,28350,44457,972,1175,47233,198738,95789,41907,21953,97034,59341,22864,53713,16873,32971,20693,20954,31336,21477,16169,38370,16412,9019,3841,24599,21938,17085,6484,81198,76413,5849,72514,12320,65247,276175,37234,59796,52642,16312,57349,198507,94148,46134,18958,125552,1747,18725,151873,14901,5490,68287,29470,3689,64794,40814,26018,25692,54450,2703,88278,124886,173087,174e3,24159,179477,24276,46004,201876,209202,445,52876,31948,30206,157610,39180,18439,44124,50469,5774,96278,222758,200216,50290,45486,20435,46986,46276,140133,142326,15569,13363,47522,92583,2182,7135,16853,22998,30272,4952,63263,35623,39096,53789,44864,20053,110392,124213,4630,16087,28221,127787,25839,77481,44693,13464,113146,6983,27069,55717,50102,4760,7107,26186,66507,59145,36032,104182,71328,29425,64317,50781,47465,94298,69706,74899,22754,120756,25108,93077,56834,73286,39928,16218,41699,176763,7555,70819,50083,26895,23315,26014,16773,123079,41712,5719,31516,90427,158540,85051,183128,40864,27505,55392,9058,45224,96857,30901,136622,96557,56304,120061,11501,151448,5773,89743,7769,86069,2935,18471,41628,10114,33660,110170,49479,26745,92846,33221,26731,18795,87076,8550,2100,29972,120289,3077,72490,33784,2630,208722,50861,63483,79029,6419,39467,14302,45286,64207,9686,67513,44170,1050,77246,59266,17055,53801,7150,11111,42432,4278,94579,362117,36175,42902,41933,39002,98489,22913,74161,84773,57036,17556,162288,74485,178760,93867,73635,128860,50362,261,67455,80001,46080,35662,4368,25247,19230,74393,22588,1822,27682,235324,13798,85998,13194,235067,23514,71669,147632,23191,134748,214683,105101,1518,25489,247114,7380,54842,26922,3971,26361,20844,68642,170517,77339,123255,8963,77818,150998,48466,36806,2732,23261,11741,236162,18243,126216,28690,50546,16385,92760,197383,246558,201295,88255,67588,71687,176076,172653,169058,33906,63747,24835,157621,43338,30050,46152,132741,2770,51371,94835,6614,15112,11749,56936,1250,19027,399017,58036,100215,23388,55815,308768,124152,94803,9521,64186,8971,28,30427,62163,7616,103838,35079,29203,131235,7743,17389,10882,37420,61460,228512,85363,41581,131077,62822,119647,10130,54445,26925,19968,29016,24446,74028,24176,61448,67185,9254,8563,119129,9771,99184,37716,39514,10532,221512,258753,218630,55980,23394,32141,61924,66749,32411,3741,36475,26678,77010,44946,91203,128749,116953,20476,49625,53116,13735,102335,29376,51946,83407,67892,59212,34685,21083,1546,112982,32972,74397,1078,190545,16082,86140,58591,89611,101531,10061,105104,76319,20035,17551,52611,169061,190842,100780,23907,90413,115619,9675,34710,193435,49443,129734,11183,258877,16318,136182,126808,44635,27304,192375,2599,125648,47051,12091,23814,721,58800,40137,66726,97930,60877,74487,7942,54326,9841,41428,13762,8211,85383,6950,99177,79806,201786,296464,124087,13144,29741,41721,47634,55088,254286,106408,17041,99064,12942,64086,45233,14005,2612,55827,255,7984,13980,38574,12776,46654,73499,249951,2101,26676,25996,132326,116415,119062,50449,31033,23038,11589,179252,20007,14860,129270,21143,17796,144715,60106,70758,69842,34674,282133,44014,16774,57268,38528,24053,46373,201667,28327,471023,51889,102667,21193,114909,84132,69317,96723,67969,16134,68145,15058,28765,32035,2524,101089,98664,25045,76571,14957,86040,118506,262428,154764,81573,39681,283900,73287,127825,544,80448,52347,38512,175971,15180,45467,33086,46552,48894,81107,43213,36672,54025,76703,8053,7608,13299,56619,20752,238099,54164,105133,1444,32942,953,37564,8e3,66316,119463,106817,404,13667,149108,128597,31267,10269,49836,106150,1484,52330,76965,160486,171648,38456,31263,22424,37738,66245,67467,143369,60471,75610,20895,115528,86070,60854,40796,49347,18989,15030,11371,37578,15779,79867,10187,86462,46402,155626,93200,40229,7090,57547,108053,99598,11088,47505,41218,206017,2173,20988,30219,22919,80563,57566,42369,93141,41675,2407,182519,120495,27154,16702,29456,14349,7958,16688,117177,140375,42467,261919,74916,153569,10836,34742,49526,7621,105997,12212,2270,392377,7755,17959,25086,232152,138791,33847,13860,35316,5811,1344,71259,50452,207539,92635,50359,5821,33674,30255,2086,2587,96264,17543,42,6029,9580,43007,139248,82831,12917,29607,25786,51467,42137,85161,100698,31561,88989,121990,278500,3602,109344,37982,15279,116442,28936,30880,87894,58079,128661,126731,67392,28051,146885,4861,16216,97344,42827,147561,153948,22684,21335,47685,1853,43349,15185,59642,10229,25520,187921,108972,5579,98037,24945,6697,19193,63734,137934,75056,89740,19767,224268,56138,63643,151661,39313,70618,84031,89723,84074,13703,85626,35460,8867,64845,3439,57906,99776,63968,49270,81130,34356,16210,23547,36446,34090,140028,72439,2221,22163,57058,363492,113754,18913,95451,48663,54464,54037,176097,68425,3023,34906,29482,117389,341780,80431,58330,16753,92616,60907,94846,147486,4498,48646,7773,46801,7778,18946,464978,47558,33223,177444,7328,15626,63337,94700,11743,9351,255024,39098,16447,42647,96230,39769,58840,10068,63439,35800,65843,58823,413844,9156,51258,7434,61791,85018,6872,3692,28096,7121,33024,6009,75532,31997,192535,9661,3304,9547,14753,31987,25314,55689,15896,20430,39472,31340,99744,25398,115569,54883,28719,205423,23071,57855,64638,149867,25671,82403,37616,20668,39989,77996,74948,140555,175248,64810,36515,46595,4958,248773,24045,28728,136673,168704,20804,114833,100325,27135,21205,96151,153134,45992,7093,13992,76047,1980,19432,145001,75159,87462,17710,1013,45556,34297,144882,20648,26061,11319,129567,108555,18872,464580,33386,22717,65948,167189,5603,135042,79542,8801,202632,18114,91882,5973,5239,67315,4431,60916,47819,71693,32597,32606,18183,45072,80329,76385,24749,51305,40314,156514,14693,130345,13168,66214,18029,12858,34801,27628,14544,10823,40522,40185,33739,148694,23548,9923,61012,28859,17933,19442,34364,99849,164107,141167,30629,21054,6744,36491,8096,42474,41706,155060,30650,10600,163442,1143,96655,61390,52359,7559,51568,64256,203854,4467,22453,14504,436398,7878,6980,8293,63610,293747,16167,35763,19627,147603,15419,18032,110744,51346,33681,54571,40472,48615,39073,21604,13754,173027,92560,11083,47299,63062,11813,52007,29883,9734,139722,15953,1550,20651,13616,49306,16113,90089,92326,7584,30712,72424,164858,6831,152871,55746,197721,34167,196442,6022,112107,55215,7538,123381,4920,43539,77165,8939,50392,34192,20225,79762,22505,58667,40770,29788,97180,82835,4568,8579,13273,363569,35898,49983,436,36598,3237,131691,62418,35591,8101,4073,379438,65218,76072,33887,2968,27573,212619,288680,68278,72851,150504,217896,6913,121339,22017,35340,51072,43616,75043,31437,10833,81487,4364,22968,41454,106687,85446,19863,109625,149241,524,141850,214404,54376,657,237023,9401,108137,53800,32474,49712,53334,126876,27337,45552,177696,8269,15036,12097,42240,2328,125374,119295,99715,2500,19624,39441,27220,102691,60957,94543,39101,18566,67362,13975,78230,25017,34017,239007,90027,39351,41681,35354,43822,1043,916,58587,141983,94818,38799,75459,41114,67432,16195,36606,59568,22272,126769,31424,68659,12287,134302,257977,5756,207285,95637,47248,117689,19583,77451,22373,12200,54993,117118,34244,29386,34562,53819,71267,64172,77665,49368,7716,59301,25749,45426,194789,17297,2650,1766,32501,45198,20403,20984,6600,14171,94604,19037,5402,29896,9938,59935,109708,88081,145182,44844,39167,352626,164173,35374,45982,6122,154,73419,220487,53834,53601,17992,8609,229321,5610,68098,66815,71012,95069,140968,27396,8957,134489,24656,86659,56598,134852,17316,123838,255436,6613,41610,138033,81452,32023,32396,123687,63398,8693,29712,30407,19296,121188,3551,36099,20032,111948,56624,16547,27453,35916,15378,52039,56849,13489,22214,73177,53097,277349,2157,14029,187886,10260,141743,246460,91880,50869,3788,49486,133566,54950,33120,129337,53768,18333,9525,26902,312251,10297,9020,70759,16647,112432,59260,84609,9818,82766,73569,468,46001,75780,55028,52106,11498,43645,108069,17150,17753,29417,16705,31799,9606,289,122254,115975,8620,6133,255357,56908,14456,133464,43554,79224,11247,29630,160,12756,25464,65960,350428,62521,321796,100359,67358,35169,46172,113128,48988,88868,31094,33266,6847,60887,98188,49659,69117,92977,220228,13947,80181,35103,62170,97351,13475,2440,199768,19498,36597,46971,25234,67806,62881,84717,73648,181966,10488,94149,21550,26655,63436,48375,14405,165650,9621,24439,28043,42735,4490,29963,56674,45373,1934,262446,50855,67098,26898,5261,52696,40644,33900,9440,180286,87162,22940,19704,26936,69769,10254,101759,27406,12243,48e3,73926,113215,54935,5726,192787,4312,106216,9366,11550,52949,23457,212271,277152,133895,108374,6191,96477,29980,218916,58024,54696,40853,91124,65894,91170,65908,252552,6793,29212,15389,44516,122515,52617,35058,9017,103536,39510,49136,19242,130652,662077,74699,47024,31422,8517,73351,24399,13867,128360,4810,4434,61779,111983,61036,17798,110240,59722,102960,39688,10001,23803,23039,176498,56659,44814,134295,17188,77577,74466,226175,102472,154333,63900,111747,18062,41171,79669,32773,408933,42562,28931,30907,107388,43487,2946,240310,23938,24354,319,184983,7927,6488,1422,10790,68809,68209,64775,4361,202,17123,59634,51200,44391,18188,17843,2619,74278,3230,9540,47187,21702,36274,56894,43907,16310,34790,16866,6150,5561,13587,107545,108873,126867,86986,28640,33427,19017,5762,80637,17430,46903,2047,131055,25958,13558,5444,47152,13900,44563,122857,45348,70863,39593,54332,38068,33637,318,40310,143467,18502,24520,11377,62013,28942,27246,28269,83545,17999,59015,90707,30065,15161,34720,1263,37008,2012,6060,98575,92933,5721,299,199555,24578,29223,2985,743,115825,109523,136657,47454,26378,53586,3733,174945,93340,244456,5693,37386,28782,89767,27545,23573,18798,136425,34320,84778,20041,48453,38215,7477,71958,40621,8773,5874,187927,105965,51100,43533,18083,8443,10180,43597,2003,183999,69689,12216,129696,146188,62389,34044,68410,12765,43273,26949,266807,3345,34477,79197,5688,47539,213110,21634,22257,50092,32222,42346,39530,63668,98,134978,74022,5152,59088,174145,37220,9934,9545,118937,5724,87240,19875,15784,40143,23263,87513,181654,285152,37881,263241,4966,43934,10433,186657,6470,74416,225854,25908,142677,246262,32280,6192,75890,45546,143264,135305,29742,47013,77787,11732,126658,8763,37950,21806,57557,113464,89465,108995,164574,23894,22996,23169,15369,23117,17642,130607,40503,36239,280990,44666,9981,40427,147487,26869,168452,32886,32991,46798,240839,15111,70502,65697,88548,44145,28701,48767,31139,206777,35659,181164,166262,14554,171445,31786,66523,76607,17956,6507,31279,90476,116611,167918,6560,1243,115324,80128,41867,55897,187323,37069,32596,189444,145931,13390,105530,65709,26805,6999,55714,41300,22915,68951,22138,21120,22264,10058,19945,33635,56123,99085,10032,5818,6016,46649,57476,35264,94413,112522,262288,93686,83038,14341,23204,28807,66084,77987,6101,126673,7133,38126,5923,122091,170240,97772,46874,215746,43948,41622,3272,55596,8332,146411,251315,13533,8561,81521,115449,48616,175175,2063,186556,3036,134537,75772,29728,82360,22973,186559,86348,89100,38388,82297,45610,2613,87082,9986,177812,57884,23591,47485,42543,33582,44713,74439,257444,252451,31825,35631,38540,33066,5147,13973,4343,51830,70378,22827,26448,95560,36896,241741,48067,203953,298860,61620,20450,3220,67272,6586,107662,100160,108684,6929,57226,4762,7457,1320,40404,77204,99309,62750,208653,59977,44e3,74315,34332,5819,172217,64904,114077,18147,84012,1791,98456,90930,21446,116669,103938,7422,85140,59713,5768,326211,16239,75411,13229,29398,10758,236107,1539,112472,95979,152154,151294,306,21196,38146,10700,6891,84282,109646,56492,40539,6589,119491,51354,30685,140209,136906,29622,73617,49553,70525,51671,166869,139616,74395,37439,49595,45678,11959,33211,86560,52434,9282,62690,112155,130810,5243,108261,99970,265613,72551,80049,6391,33365,90721,66737,69872,87011,1860,9032,112544,60905,37371,89015,140351,19076,850,373531,2802,36725,218795,72062,28990,16550,24614,7815,6187,26336,33373,32162,42791,73555,32062,23386,10244,56392,49442,27076,136262,12412,14883,1134,33675,97153,199281,15608,100152,74072,47942,254301,36451,16026,10687,65067,56708,254030,30290,50490,13864,57941,259331,35588,23485,43486,24869,21620,92971,22072,88645,1048,182050,13343,32452,14825,19509,3325,216938,45740,99716,189082,53740,78245,25609,24311,176777,47340,308354,40669,66085,14102,125339,9225,128709,97207,1271,200933,78439,113451,88975,18324,46521,11819,18570,141756,72512,170020,52754,63550,118515,103073,93330,32736,50499,14722,31600,68452,398867,29316,172786,18417,104924,2606,5670,84818,16288,67106,59580,82929,607401,291,85829,359,15897,35830,50696,65630,52672,22115,356968,29895,40837,231192,34024,38957,26722,406,23335,124952,72068,68804,13268,147101,164740,276569,162596,66943,11569,26654,66358,4777,23229,102127,5848,978,2921,59666,5371,28212,90108,42938,39320,2499,4271,108792,33510,125072,71653,65239,38250,66357,38577,13964,86251,35708,50755,36010,29448,12209,3844,38222,206337,100876,67827,137088,14167,252225,84163,195270,1306,5703,54198,779,46802,22028,51124,86759,70560,113164,35685,162145,45471,34561,422,2611,6464,47486,19223,38246,9191,18331,89942,243642,212364,15893,17518,22617,6409,30046,126182,59716,36560,104428,18846,26592,19458,50793,147333,30826,1388,27647,10922,14495,33545,19269,135828,39727,41601,46931,233379,49169,131130,182112,16276,82381,118209,142445,128310,19672,28740,82907,33436,3118,102206,28723,24819,41937,38854,5157,3881,111491,1142,9776,421673,152241,29309,14961,87854,6054,15424,3796,82656,54996,2108,55367,239450,154525,9643,118103,106041,64601,68549,48707,30266,25772,18740,9462,229669,91798,112152,191327,14493,72828,8175,66636,236474,25817,87351,129027,76653,20422,22983,71240,27846,44661,12399,46158,77704,53101,35032,11072,17300,109294,33638,24408,1895,11241,760,17584,82479,125877,63150,141075,34259,23274,81698,15732,43577,48340,91584,14688,16379,24481,150280,96420,262050,48635,43727,61819,56268,72003,88178,17281,79912,13218,122519,125295,166396,11811,2171,118930,67746,17636,178278,174656,95661,173039,83845,79689,17473,98555,127696,203415,54730,22925,232239,9309,12136,175026,20740,180188,10747,39816,314017,266131,10040,175732,112550,220651,31974,37393,888,23008,86799,4303,64905,148467,75337,251,3284,370102,50264,9835,5438,23655,4481,29851,329,12855,7162,64931,78141,12804,42372,296771,83547,18624,34874,86271,3360,48665,77735,88767,11463,63527,28889,22258,29140,194315,113924,25499,6406,31334,1845,4802,49184,43455,35469,127594,92970,61038,115005,38840,87761,106838,8811,20572,55637,11162,96721,132425,108925,2948,125457,36356,3502,75270,27622,127192,2561,123095,49394,61155,16897,110064,9699,89448,53356,19628,220310,21622,83036,9885,112214,6087,26713,17901,161912,91492,3440,68594,9266,92238,8087,6866,150194,72175,80701,13459,31836,43243,239700,95846,44749,50647,21945,230538,120612,132371,244604,5193,105637,34661,41341,68775,85393,1874,8771,33718,49672,77403,595452,99507,6490,58895,128742,7704,39239,73217,43816,62824,37804,199976,22361,80005,87514,94832,14089,4574,139975,59142,75523,100268,43906,53442,15152,2547,186002,17011,19513,204282,3343,60568,128318,119250,4298,51871,41336,71759,21921,45074,98169,145889,99427,11350,1237,5520,28799,7803,53702,21026,136352,38293,128690,12158,90132,44600,10184,26957,39459,126025,78904,82999,59373,39301,150198,120529,153042,20177,50089,14764,271571,30530,123161,38975,101562,22941,5648,124654,109243,69817,71675,49162,106884,21241,107795,30258,16572,188262,141456,7688,60718,8271,11044,32440,104608,103419,236109,93156,43293,128929,42107,67180,25201,115254,185488,130954,72813,167547,20537,39969,38432,22582,184022,1139,27199,5655,17767,97412,122606,209377,27070,35871,326617,188954,42680,73512,80911,22629,3011,95021,315242,157737,383,41821,41808,19335,27950,15674,25677,110950,35375,76835,59108,57370,35262,16569,160415,37706,78086,32041,49691,137143,9782,172080,50148,77917,6323,10110,69172,17711,21795,59511,76184,135114,31046,132319,59105,157578,20549,80778,57649,158421,65143,4575,72235,21899,10797,92745,34035,106079,80159,4508,78304,25350,75457,46458,32937,25623,47,8531,104751,84953,8138,36508,187199,66310,115274,13253,32461,38536,1916,42007,187160,35055,26325,84394,35963,94216,45590,97782];class nv{constructor(e){const{peerRouting:t,routingTable:n,refreshInterval:s,refreshQueryTimeout:r,lan:o}=e;this.log=(0,a.vF)(`libp2p:kad-dht:${o?"lan":"wan"}:routing-table:refresh`),this.peerRouting=t,this.routingTable=n,this.refreshInterval=s??$E,this.refreshQueryTimeout=r??VE,this.commonPrefixLengthRefreshedAt=[],this.refreshTable=this.refreshTable.bind(this)}async start(){this.log(`refreshing routing table every ${this.refreshInterval}ms`),this.refreshTable(!0)}async stop(){null!=this.refreshTimeoutId&&clearTimeout(this.refreshTimeoutId)}refreshTable(e=!1){this.log("refreshing routing table");const t=this._maxCommonPrefix(),n=this._getTrackedCommonPrefixLengthsForRefresh(t);this.log(`max common prefix length ${t}`),this.log(`tracked CPLs [ ${n.map((e=>e.toISOString())).join(", ")} ]`),Promise.all(n.map((async(s,r)=>{try{if(await this._refreshCommonPrefixLength(r,s,e),0===this._numPeersForCpl(t)){const t=Math.min(2*(r+1),n.length-1);for(let n=r+1;n<t+1;n++)try{await this._refreshCommonPrefixLength(n,s,e)}catch(e){this.log.error(e)}}}catch(e){this.log.error(e)}}))).catch((e=>{this.log.error(e)})).then((()=>{this.refreshTimeoutId=setTimeout(this.refreshTable,this.refreshInterval),null!=this.refreshTimeoutId.unref&&this.refreshTimeoutId.unref()})).catch((e=>{this.log.error(e)}))}async _refreshCommonPrefixLength(e,t,n){if(!n&&t.getTime()>Date.now()-this.refreshInterval)return void this.log("not running refresh for cpl %s as time since last refresh not above interval",e);const s=await this._generateRandomPeerId(e);this.log("starting refreshing cpl %s with key %p (routing table size was %s)",e,s,this.routingTable.size);const r=new B.TimeoutController(this.refreshQueryTimeout);try{const t=await Sd(this.peerRouting.getClosestPeers(s.toBytes(),{signal:r.signal}));this.log(`found ${t} peers that were close to imaginary peer %p`,s),this.log("finished refreshing cpl %s with key %p (routing table size is now %s)",e,s,this.routingTable.size)}finally{r.clear()}}_getTrackedCommonPrefixLengthsForRefresh(e){e>15&&(e=15);const t=[];for(let n=0;n<=e;n++)t[n]=this.commonPrefixLengthRefreshedAt[n]??new Date;return t}async _generateRandomPeerId(e){if(null==this.routingTable.kb)throw new Error("Routing table not started");const t=(0,Fp.po)(2),n=(t[1]<<8)+t[0],s=await this._makePeerId(this.routingTable.kb.localNodeId,n,e);return(0,Ht.nu)(s)}async _makePeerId(e,t,n){if(n>15)throw new Error("Cannot generate peer ID for common prefix length greater than 15");const s=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0,!1),r=65535<<16-(n+1),o=tv[(s^32768>>n)&r|t&~r],i=new ArrayBuffer(34),a=new DataView(i,0,i.byteLength);return a.setUint8(0,co.sha256.code),a.setUint8(1,32),a.setUint32(2,o,!1),new Uint8Array(a.buffer,a.byteOffset,a.byteLength)}_maxCommonPrefix(){let e=0;for(const t of this._prefixLengths())t>e&&(e=t);return e}_numPeersForCpl(e){let t=0;for(const n of this._prefixLengths())n===e&&t++;return t}*_prefixLengths(){if(null!=this.routingTable.kb)for(const{id:e}of this.routingTable.kb.toIterable()){const t=(0,ev.I)(this.routingTable.kb.localNodeId,e);let n=0;for(const e of t){if(0!==e)break;n++}yield n}}}an._configure(),nn._configure(sn),rn._configure(on);const sv=["uint64","int64","sint64","fixed64","sfixed64"];function rv(e){return function(e){for(const t of sv){if(null==e[t])continue;const n=e[t];e[t]=function(){return BigInt(n.call(this).toString())}}return e}(new nn(e))}function ov(){return function(e){for(const t of sv){if(null==e[t])continue;const n=e[t];e[t]=function(e){return n.call(this,e.toString())}}return e}(rn.create())}function iv(e,t){const n=rv(e instanceof Uint8Array?e:e.subarray());return t.decode(n)}function av(e,t){const n=ov();return t.encode(e,n,{lengthDelimited:!1}),n.finish()}var cv,lv,dv;function uv(e,t,n,s){return{name:e,type:t,encode:n,decode:s}}function hv(e){function t(t){if(null==e[t.toString()])throw new Error("Invalid enum value");return e[t]}return uv("enum",cv.VARINT,(function(e,n){const s=t(e);n.int32(s)}),(function(e){return t(e.int32())}))}function pv(e,t){return uv("message",cv.LENGTH_DELIMITED,e,t)}!function(e){e[e.VARINT=0]="VARINT",e[e.BIT64=1]="BIT64",e[e.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",e[e.START_GROUP=3]="START_GROUP",e[e.END_GROUP=4]="END_GROUP",e[e.BIT32=5]="BIT32"}(cv||(cv={})),function(e){let t;e.codec=()=>(null==t&&(t=pv(((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.key&&(t.uint32(10),t.bytes(e.key)),null!=e.value&&(t.uint32(18),t.bytes(e.value)),null!=e.author&&(t.uint32(26),t.bytes(e.author)),null!=e.signature&&(t.uint32(34),t.bytes(e.signature)),null!=e.timeReceived&&(t.uint32(42),t.string(e.timeReceived)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();switch(t>>>3){case 1:n.key=e.bytes();break;case 2:n.value=e.bytes();break;case 3:n.author=e.bytes();break;case 4:n.signature=e.bytes();break;case 5:n.timeReceived=e.string();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>av(t,e.codec()),e.decode=t=>iv(t,e.codec())}(lv||(lv={})),function(e){let t,n,s,r,o,i;!function(e){e.PUT_VALUE="PUT_VALUE",e.GET_VALUE="GET_VALUE",e.ADD_PROVIDER="ADD_PROVIDER",e.GET_PROVIDERS="GET_PROVIDERS",e.FIND_NODE="FIND_NODE",e.PING="PING"}(t=e.MessageType||(e.MessageType={})),function(e){e[e.PUT_VALUE=0]="PUT_VALUE",e[e.GET_VALUE=1]="GET_VALUE",e[e.ADD_PROVIDER=2]="ADD_PROVIDER",e[e.GET_PROVIDERS=3]="GET_PROVIDERS",e[e.FIND_NODE=4]="FIND_NODE",e[e.PING=5]="PING"}(n||(n={})),function(e){e.codec=()=>hv(n)}(t=e.MessageType||(e.MessageType={})),function(e){e.NOT_CONNECTED="NOT_CONNECTED",e.CONNECTED="CONNECTED",e.CAN_CONNECT="CAN_CONNECT",e.CANNOT_CONNECT="CANNOT_CONNECT"}(s=e.ConnectionType||(e.ConnectionType={})),function(e){e[e.NOT_CONNECTED=0]="NOT_CONNECTED",e[e.CONNECTED=1]="CONNECTED",e[e.CAN_CONNECT=2]="CAN_CONNECT",e[e.CANNOT_CONNECT=3]="CANNOT_CONNECT"}(r||(r={})),function(e){e.codec=()=>hv(r)}(s=e.ConnectionType||(e.ConnectionType={})),function(t){let n;t.codec=()=>(null==n&&(n=pv(((t,n,s={})=>{if(!1!==s.lengthDelimited&&n.fork(),null!=t.id&&(n.uint32(10),n.bytes(t.id)),null!=t.addrs)for(const e of t.addrs)n.uint32(18),n.bytes(e);null!=t.connection&&(n.uint32(24),e.ConnectionType.codec().encode(t.connection,n)),!1!==s.lengthDelimited&&n.ldelim()}),((t,n)=>{const s={addrs:[]},r=null==n?t.len:t.pos+n;for(;t.pos<r;){const n=t.uint32();switch(n>>>3){case 1:s.id=t.bytes();break;case 2:s.addrs.push(t.bytes());break;case 3:s.connection=e.ConnectionType.codec().decode(t);break;default:t.skipType(7&n)}}return s}))),n),t.encode=e=>av(e,t.codec()),t.decode=e=>iv(e,t.codec())}(o=e.Peer||(e.Peer={})),e.codec=()=>(null==i&&(i=pv(((t,n,s={})=>{if(!1!==s.lengthDelimited&&n.fork(),null!=t.type&&(n.uint32(8),e.MessageType.codec().encode(t.type,n)),null!=t.clusterLevelRaw&&(n.uint32(80),n.int32(t.clusterLevelRaw)),null!=t.key&&(n.uint32(18),n.bytes(t.key)),null!=t.record&&(n.uint32(26),n.bytes(t.record)),null!=t.closerPeers)for(const s of t.closerPeers)n.uint32(66),e.Peer.codec().encode(s,n);if(null!=t.providerPeers)for(const s of t.providerPeers)n.uint32(74),e.Peer.codec().encode(s,n);!1!==s.lengthDelimited&&n.ldelim()}),((t,n)=>{const s={closerPeers:[],providerPeers:[]},r=null==n?t.len:t.pos+n;for(;t.pos<r;){const n=t.uint32();switch(n>>>3){case 1:s.type=e.MessageType.codec().decode(t);break;case 10:s.clusterLevelRaw=t.int32();break;case 2:s.key=t.bytes();break;case 3:s.record=t.bytes();break;case 8:s.closerPeers.push(e.Peer.codec().decode(t,t.uint32()));break;case 9:s.providerPeers.push(e.Peer.codec().decode(t,t.uint32()));break;default:t.skipType(7&n)}}return s}))),i),e.encode=t=>av(t,e.codec()),e.decode=t=>iv(t,e.codec())}(dv||(dv={}));const fv=dv.MessageType,yv=dv.ConnectionType,gv=Object.keys(fv);class mv{constructor(e,t,n){if(!(t instanceof Uint8Array))throw new Error("Key must be a Uint8Array");this.type=e,this.key=t,this.clusterLevelRaw=n,this.closerPeers=[],this.providerPeers=[],this.record=void 0}get clusterLevel(){const e=this.clusterLevelRaw-1;return e<0?0:e}set clusterLevel(e){this.clusterLevelRaw=e}serialize(){return dv.encode({key:this.key,type:this.type,clusterLevelRaw:this.clusterLevelRaw,closerPeers:this.closerPeers.map(wv),providerPeers:this.providerPeers.map(wv),record:null==this.record?void 0:this.record.serialize().subarray()})}static deserialize(e){const t=dv.decode(e),n=new mv(t.type??dv.MessageType.PUT_VALUE,t.key??Uint8Array.from([]),t.clusterLevelRaw??0);return n.closerPeers=t.closerPeers.map(bv),n.providerPeers=t.providerPeers.map(bv),null!=t.record?.length&&(n.record=ss.L.deserialize(t.record)),n}}function wv(e){return{id:e.id.toBytes(),addrs:(e.multiaddrs??[]).map((e=>e.bytes)),connection:yv.CONNECTED}}function bv(e){if(null==e.id)throw new Error("Invalid peer in message");return{id:(0,Ht.nu)(e.id),multiaddrs:(e.addrs??[]).map((e=>(0,j.HZ)(e))),protocols:[]}}function _v(e){return{...e,name:"SENDING_QUERY",type:0,messageName:e.type,messageType:gv.indexOf(e.type.toString())}}function Ev(e){return{...e,name:"PEER_RESPONSE",type:1,messageName:e.messageType,closer:null!=e.closer?e.closer:[],providers:null!=e.providers?e.providers:[]}}function vv(e){return{...e,name:"FINAL_PEER",type:2}}function Sv(e){return{...e,name:"QUERY_ERROR",type:3}}function kv(e){return{...e,name:"PROVIDER",type:4}}function Rv(e){return{...e,name:"VALUE",type:5}}function Tv(e){return{...e,name:"DIALING_PEER",type:7}}class Iv extends Zh.b{constructor(e,t){super();const{protocol:n,lan:s}=t;this.components=e,this.log=(0,a.vF)(`libp2p:kad-dht:${s?"lan":"wan"}:network`),this.running=!1,this.protocol=n}async start(){this.running||(this.running=!0)}async stop(){this.running=!1}isStarted(){return this.running}async*sendRequest(e,t,n={}){if(!this.running)return;this.log("sending %s to %p",t.type,e),yield Tv({peer:e}),yield _v({to:e,type:t.type});try{const s=await this.components.connectionManager.openConnection(e,n),r=await s.newStream(this.protocol,n),o=await this._writeReadMessage(r,t.serialize(),n);yield Ev({from:e,messageType:o.type,closer:o.closerPeers,providers:o.providerPeers,record:o.record})}catch(t){yield Sv({from:e,error:t})}finally{0}}async*sendMessage(e,t,n={}){if(!this.running)return;this.log("sending %s to %p",t.type,e),yield Tv({peer:e}),yield _v({to:e,type:t.type});try{const s=await this.components.connectionManager.openConnection(e,n),r=await s.newStream(this.protocol,n);await this._writeMessage(r,t.serialize(),n),yield Ev({from:e,messageType:t.type})}catch(t){yield Sv({from:e,error:t})}finally{0}}async _writeMessage(e,t,n){null!=n.signal&&(e=(0,qp.DG)(e,n.signal)),await no([t],ib(),e,Kn.A)}async _writeReadMessage(e,t,n){null!=n.signal&&(e=(0,qp.DG)(e,n.signal));const s=await no([t],ib(),e,ub(),(async e=>{const t=await(0,sc.A)(e);if(null!=t)return t;throw new mp.A("No message received","ERR_NO_MESSAGE_RECEIVED")})),r=mv.deserialize(s);return r.closerPeers.forEach((e=>{this.dispatchEvent(new Zh.u("peer",{detail:e}))})),r.providerPeers.forEach((e=>{this.dispatchEvent(new Zh.u("peer",{detail:e}))})),r}}var Pv=n(2328),Av=n(84041);class Dv{constructor(e,t){const{validators:n,selectors:s,peerRouting:r,queryManager:o,routingTable:i,network:c,lan:l}=t;this.components=e,this.log=(0,a.vF)(`libp2p:kad-dht:${l?"lan":"wan"}:content-fetching`),this.validators=n,this.selectors=s,this.peerRouting=r,this.queryManager=o,this.routingTable=i,this.network=c}async putLocal(e,t){const n=QE(e);await this.components.datastore.put(n,t)}async getLocal(e){this.log("getLocal %b",e);const t=QE(e);this.log("fetching record for key %k",t);const n=await this.components.datastore.get(t);this.log("found %k in local datastore",t);const s=ss.L.deserialize(n);return await(0,Pv.R)(this.validators,s),s}async*sendCorrectionRecord(e,t,n,s={}){this.log("sendCorrection for %b",e);const r=JE(e,n);for(const{value:o,from:i}of t){if((0,ve.a)(o,n)){this.log("record was ok");continue}if(this.components.peerId.equals(i)){try{const t=QE(e);this.log(`Storing corrected record for key ${t.toString()}`),await this.components.datastore.put(t,r.subarray())}catch(e){this.log.error("Failed error correcting self",e)}continue}let t=!1;const a=new mv(fv.PUT_VALUE,e,0);a.record=ss.L.deserialize(r);for await(const e of this.network.sendRequest(i,a,s))"PEER_RESPONSE"===e.name&&null!=e.record&&(0,ve.a)(e.record.value,ss.L.deserialize(r).value)&&(t=!0),yield e;t||(yield Sv({from:i,error:new mp.A("value not put correctly","ERR_PUT_VALUE_INVALID")})),this.log.error("Failed error correcting entry")}}async*put(e,t,n={}){this.log("put key %b value %b",e,t);const s=JE(e,t),r=QE(e);this.log(`storing record for key ${r.toString()}`),await this.components.datastore.put(r,s.subarray()),yield*no(this.peerRouting.getClosestPeers(e,{signal:n.signal}),(t=>(0,Xr.A)(t,(t=>async()=>{if("FINAL_PEER"!==t.name)return[t];const r=[],o=new mv(fv.PUT_VALUE,e,0);o.record=ss.L.deserialize(s),this.log("send put to %p",t.peer.id);for await(const e of this.network.sendRequest(t.peer.id,o,n))r.push(e),"PEER_RESPONSE"===e.name&&(null!=e.record&&(0,ve.a)(e.record.value,ss.L.deserialize(s).value)||r.push(Sv({from:t.peer.id,error:new mp.A("value not put correctly","ERR_PUT_VALUE_INVALID")})));return r}))),(e=>(0,Yr.A)(e,{ordered:!1,concurrency:FE})),(async function*(e){for await(const t of e)yield*t}))}async*get(e,t={}){this.log("get %b",e);const n=[];for await(const s of this.getMany(e,t))"VALUE"===s.name&&n.push(s),yield s;if(0===n.length)return;const s=n.map((e=>e.value));let r=0;try{r=(0,Av.A)(this.selectors,e,s)}catch(e){if("ERR_NO_SELECTOR_FUNCTION_FOR_RECORD_KEY"!==e.code)throw e}const o=s[r];if(this.log("GetValue %b %b",e,o),null==o)throw new mp.A("best value was not found","ERR_NOT_FOUND");yield*this.sendCorrectionRecord(e,n,o,t),yield n[r]}async*getMany(e,t={}){this.log("getMany values for %b",e);try{const t=await this.getLocal(e);yield Rv({value:t.value,from:this.components.peerId})}catch(t){this.log("error getting local value for %b",e,t)}const n=await YE(e),s=this.routingTable.closestPeers(n);this.log("found %d peers in routing table",s.length);const r=this;yield*this.queryManager.run(e,s,(async function*({peer:t,signal:n}){for await(const s of r.peerRouting.getValueOrPeers(t,e,{signal:n}))yield s,"PEER_RESPONSE"===s.name&&null!=s.record&&(yield Rv({from:t,value:s.record.value}))}),t)}}class Ov{constructor(e,t){const{network:n,peerRouting:s,queryManager:r,routingTable:o,providers:i,lan:c}=t;this.components=e,this.log=(0,a.vF)(`libp2p:kad-dht:${c?"lan":"wan"}:content-routing`),this.network=n,this.peerRouting=s,this.queryManager=r,this.routingTable=o,this.providers=i}async*provide(e,t,n={}){this.log("provide %s",e),await this.providers.addProvider(e,this.components.peerId);const s=new mv(fv.ADD_PROVIDER,e.multihash.bytes,0);s.providerPeers=[{id:this.components.peerId,multiaddrs:t,protocols:[]}];let r=0;const o=t=>async()=>{if("FINAL_PEER"!==t.name)return[t];const o=[];this.log("putProvider %s to %p",e,t.peer.id);try{this.log("sending provider record for %s to %p",e,t.peer.id);for await(const i of this.network.sendMessage(t.peer.id,s,n))"PEER_RESPONSE"===i.name&&(this.log("sent provider record for %s to %p",e,t.peer.id),r++),o.push(i)}catch(e){this.log.error("error sending provide record to peer %p",t.peer.id,e),o.push(Sv({from:t.peer.id,error:e}))}return o};yield*no(this.peerRouting.getClosestPeers(e.multihash.bytes,n),(e=>(0,Xr.A)(e,(e=>o(e)))),(e=>(0,Yr.A)(e,{ordered:!1,concurrency:FE})),(async function*(e){for await(const t of e)yield*t})),this.log("sent provider records to %d peers",r)}async*findProviders(e,t){const n=this.routingTable.kBucketSize,s=e.multihash.bytes,r=await YE(s),o=this;this.log("findProviders %c",e);const i=await this.providers.getProviders(e);if(i.length>0){const e=[];for(const t of i.slice(0,n))e.push({id:t,multiaddrs:(await this.components.peerStore.addressBook.get(t)??[]).map((e=>e.multiaddr)),protocols:[]});yield Ev({from:this.components.peerId,messageType:fv.GET_PROVIDERS,providers:e}),yield kv({from:this.components.peerId,providers:e})}if(i.length>=n)return;const a=async function*({peer:e,signal:t}){const n=new mv(fv.GET_PROVIDERS,s,0);yield*o.network.sendRequest(e,n,{signal:t})},c=new Set(i.map((e=>e.toString())));for await(const o of this.queryManager.run(s,this.routingTable.closestPeers(r),a,t))if(yield o,"PEER_RESPONSE"===o.name){this.log("Found %d provider entries for %c and %d closer peers",o.providers.length,e,o.closer.length);const t=[];for(const e of o.providers)c.has(e.id.toString())||(c.add(e.id.toString()),t.push(e));if(t.length>0&&(yield kv({from:o.from,providers:t})),c.size===n)return}}}class Nv{constructor(e,t){this.originDhtKey=e,this.capacity=t,this.peerDistances=[]}get length(){return this.peerDistances.length}get peers(){return this.peerDistances.map((e=>e.peerId))}async add(e){if(null!=this.peerDistances.find((t=>t.peerId.equals(e))))return;const t=await XE(e),n={peerId:e,distance:(0,ev.I)(this.originDhtKey,t)};this.peerDistances.push(n),this.peerDistances.sort(((e,t)=>(0,$d.U)(e.distance,t.distance))),this.peerDistances=this.peerDistances.slice(0,this.capacity)}async anyCloser(e){if(0===e.length)return!1;if(0===this.length)return!0;const t=await Promise.all(e.map(XE)),n=this.peerDistances[this.peerDistances.length-1].distance;for(const e of t){const t=(0,ev.I)(this.originDhtKey,e);if((0,$d.U)(t,n)<0)return!0}return!1}}class Lv{constructor(e,t){const{routingTable:n,network:s,validators:r,queryManager:o,lan:i}=t;this.components=e,this.routingTable=n,this.network=s,this.validators=r,this.queryManager=o,this.log=(0,a.vF)(`libp2p:kad-dht:${i?"lan":"wan"}:peer-routing`)}async findPeerLocal(e){let t;const n=await this.routingTable.find(e);if(null!=n){this.log("findPeerLocal found %p in routing table",e);try{t=await this.components.peerStore.get(n)}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}}if(null==t)try{t=await this.components.peerStore.get(e)}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}if(null!=t)return this.log("findPeerLocal found %p in peer store",e),{id:t.id,multiaddrs:t.addresses.map((e=>e.multiaddr)),protocols:[]}}async*_getValueSingle(e,t,n={}){const s=new mv(fv.GET_VALUE,t,0);yield*this.network.sendRequest(e,s,n)}async*getPublicKeyFromNode(e,t={}){const n=function(e){return(0,ee.x)([qE,e.toBytes()])}(e);for await(const s of this._getValueSingle(e,n,t))if(yield s,"PEER_RESPONSE"===s.name&&null!=s.record){const t=await(0,Ht.AX)(Fp.HP.marshalPublicKey({bytes:s.record.value}));if(!t.equals(e))throw new mp.A("public key does not match id","ERR_PUBLIC_KEY_DOES_NOT_MATCH_ID");if(null==t.publicKey)throw new mp.A("public key missing","ERR_PUBLIC_KEY_MISSING");yield Rv({from:e,value:t.publicKey})}throw new mp.A(`Node not responding with its public key: ${e.toString()}`,"ERR_INVALID_RECORD")}async*findPeer(e,t={}){this.log("findPeer %p",e);const n=await this.findPeerLocal(e);if(null!=n)return this.log("found local"),void(yield vv({from:this.components.peerId,peer:n}));const s=await XE(e),r=this.routingTable.closestPeers(s);if(null!=r.find((t=>t.equals(e))))try{const t=await this.components.peerStore.get(e);return this.log("found in peerStore"),void(yield vv({from:this.components.peerId,peer:{id:t.id,multiaddrs:t.addresses.map((e=>e.multiaddr)),protocols:[]}}))}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}const o=this,i=async function*({peer:t,signal:n}){const s=new mv(fv.FIND_NODE,e.toBytes(),0);for await(const r of o.network.sendRequest(t,s,{signal:n}))if(yield r,"PEER_RESPONSE"===r.name){const t=r.closer.find((t=>t.id.equals(e)));null!=t&&(yield vv({from:r.from,peer:t}))}};let a=!1;for await(const n of this.queryManager.run(e.toBytes(),r,i,t))"FINAL_PEER"===n.name&&(a=!0),yield n;a||(yield Sv({from:this.components.peerId,error:new mp.A("Not found","ERR_NOT_FOUND")}))}async*getClosestPeers(e,t={}){this.log("getClosestPeers to %b",e);const n=await YE(e),s=this.routingTable.closestPeers(n),r=this,o=new Nv(n,this.routingTable.kBucketSize);await Promise.all(s.map((async e=>{await o.add(e)})));const i=async function*({peer:t,signal:n}){r.log("closerPeersSingle %s from %p",(0,$.d)(e,"base32"),t);const s=new mv(fv.FIND_NODE,e,0);yield*r.network.sendRequest(t,s,{signal:n})};for await(const n of this.queryManager.run(e,s,i,t))yield n,"PEER_RESPONSE"===n.name&&await Promise.all(n.closer.map((async e=>{await o.add(e.id)})));this.log("found %d peers close to %b",o.length,e);for(const e of o.peers)yield vv({from:this.components.peerId,peer:{id:e,multiaddrs:(await this.components.peerStore.addressBook.get(e)??[]).map((e=>e.multiaddr)),protocols:[]}})}async*getValueOrPeers(e,t,n={}){for await(const s of this._getValueSingle(e,t,n)){if("PEER_RESPONSE"===s.name&&null!=s.record)try{await this._verifyRecordOnline(s.record)}catch(e){const t="invalid record received, discarded";this.log(t),yield Sv({from:s.from,error:new mp.A(t,"ERR_INVALID_RECORD")});continue}yield s}}async _verifyRecordOnline(e){if(null==e.timeReceived)throw new mp.A("invalid record received","ERR_INVALID_RECORD");await(0,Pv.R)(this.validators,new ss.L(e.key,e.value,e.timeReceived))}async getCloserPeersOffline(e,t){const n=await YE(e),s=this.routingTable.closestPeers(n),r=[];for(const e of s)if(!e.equals(t))try{const t=await this.components.peerStore.addressBook.get(e),n=await this.components.peerStore.protoBook.get(e);r.push({id:e,multiaddrs:t.map((e=>e.multiaddr)),protocols:n})}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}return r.length>0?this.log("getCloserPeersOffline found %d peer(s) closer to %b than %p",r.length,e,t):this.log("getCloserPeersOffline could not find peer closer to %b than %p",e,t),r}}const Mv=(0,a.vF)("libp2p:kad-dht:providers");class Cv{constructor(e,t={}){const{cacheSize:n,cleanupInterval:s,provideValidity:r}=t;this.components=e,this.cleanupInterval=s??36e5,this.provideValidity=r??864e5,this.cache=Mt(n??256),this.syncQueue=new Ct.A({concurrency:1}),this.started=!1}isStarted(){return this.started}async start(){this.started||(this.started=!0,this.cleaner=setInterval((()=>{this._cleanup().catch((e=>{Mv.error(e)}))}),this.cleanupInterval))}async stop(){this.started=!1,null!=this.cleaner&&(clearInterval(this.cleaner),this.cleaner=void 0)}async _cleanup(){await this.syncQueue.add((async()=>{const e=Date.now();let t=0,n=0;const s=new Map,r=this.components.datastore.batch(),o=this.components.datastore.query({prefix:zE});for await(const e of o)try{const{cid:o,peerId:i}=Bv(e.key),a=zv(e.value).getTime(),c=Date.now(),l=c-a,d=l>this.provideValidity;if(Mv("comparing: %d - %d = %d > %d %s",c,a,l,this.provideValidity,d?"(expired)":""),d){n++,r.delete(e.key);const t=s.get(o)??new Set;t.add(i),s.set(o,t)}t++}catch(e){Mv.error(e.message)}s.size>0?(Mv("deleting %d / %d entries",n,t),await r.commit()):Mv("nothing to delete");for(const[e,t]of s){const n=xv(e),s=this.cache.get(n);if(null!=s){for(const e of t)s.delete(e);0===s.size?this.cache.remove(n):this.cache.set(n,s)}}Mv("Cleanup successful (%dms)",Date.now()-e)}))}async _getProvidersMap(e){const t=xv(e);let n=this.cache.get(t);return null==n&&(n=await async function(e,t){const n=new Map,s=e.query({prefix:xv(t)});for await(const e of s){const{peerId:t}=Bv(e.key);n.set(t,zv(e.value))}return n}(this.components.datastore,e),this.cache.set(t,n)),n}async addProvider(e,t){await this.syncQueue.add((async()=>{Mv("%p provides %s",t,e);const n=await this._getProvidersMap(e);Mv("loaded %s provs",n.size);const s=new Date;n.set(t.toString(),s);const r=xv(e);this.cache.set(r,n),await async function(e,t,n,s){const r=[xv(t),"/",n.toString()].join(""),o=new bt.U(r),i=Uint8Array.from(zs.encode(s.getTime()));await e.put(o,i)}(this.components.datastore,e,t,s)}))}async getProviders(e){return await this.syncQueue.add((async()=>{Mv("get providers for %s",e);return[...(await this._getProvidersMap(e)).keys()].map((e=>(0,Ht.XL)(e)))}),{throwOnTimeout:!0})}}function xv(e){const t="string"==typeof e?e:(0,$.d)(e.multihash.bytes,"base32");return`${zE}/${t}`}function Bv(e){const t=e.toString().split("/");if(5!==t.length)throw new Error(`incorrectly formatted provider entry key in datastore: ${e.toString()}`);return{cid:t[3],peerId:t[4]}}function zv(e){return new Date(zs.decode(e))}const Uv=BigInt("0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF");async function*Fv(e){const{key:t,startingPeer:n,ourPeerId:s,signal:r,query:o,alpha:i,pathIndex:a,numPaths:c,cleanUp:l,queryFuncTimeout:d,log:u,peersSeen:h}=e,p=new Ct.A({concurrency:i}),f=await YE(t);!function e(n,i){if(null==n)return;h.add(n);const l=BigInt("0x"+(0,$.d)((0,ev.I)(i,f),"base16"));p.add((async()=>{let i;const y=[r];null!=d&&(i=new B.TimeoutController(d),y.push(i.signal));const g=(0,_t.anySignal)(y);try{for await(const r of o({key:t,peer:n,signal:g,pathIndex:a,numPaths:c})){if(g.aborted)return;if("PEER_RESPONSE"===r.name)for(const o of r.closer){if(h.has(o.id)){u("already seen %p in query",o.id);continue}if(s.equals(o.id)){u("not querying ourselves");continue}const r=await XE(o.id);BigInt("0x"+(0,$.d)((0,ev.I)(r,f),"base16"))>l?u("skipping %p as they are not closer to %b than %p",o.id,t,n):(u("querying closer peer %p",o.id),e(o.id,r))}p.emit("completed",r)}i?.clear()}catch(e){r.aborted?p.emit("error",e):p.emit("completed",Sv({from:n,error:e}))}finally{i?.clear()}}),{priority:Uv-l}).catch((e=>{u.error(e)}))}(n,await XE(n)),yield*async function*(e,t,n,s){let r=(0,hb.A)(),o=!0;const i=[],a=()=>{o&&(s("clean up queue, results %d, queue size %d, pending tasks %d",i.length,e.size,e.pending),o=!1,e.clear(),i.splice(0,i.length))};e.on("completed",(e=>{i.push(e),r.resolve()})),e.on("error",(e=>{s("queue error",e),a(),r.reject(e)})),e.on("idle",(()=>{s("queue idle"),o=!1,r.resolve()})),t.addEventListener("abort",(()=>{s("abort queue");const e=o;a(),e&&r.reject(new mp.A("Query aborted","ERR_QUERY_ABORTED"))})),n.addEventListener("cleanup",(()=>{a(),r.resolve()}));for(;o;)for(await r.promise,r=(0,hb.A)();i.length>0;){const e=i.shift();null!=e&&(yield e)}yield*i}(p,r,l,u)}class jv{constructor(e,t){const{lan:n=!1,disjointPaths:s=UE,alpha:r=FE}=t;this.components=e,this.disjointPaths=s??UE,this.controllers=new Set,this.running=!1,this.alpha=r??FE,this.lan=n,this.queries=0}isStarted(){return this.running}async start(){this.running=!0,null!=this.components.metrics&&null==this.metrics&&(this.metrics={runningQueries:this.components.metrics.registerMetric(`libp2p_kad_dht_${this.lan?"lan":"wan"}_running_queries`),queryTime:this.components.metrics.registerMetric(`libp2p_kad_dht_${this.lan?"lan":"wan"}_query_time_seconds`)})}async stop(){this.running=!1;for(const e of this.controllers)e.abort();this.controllers.clear()}async*run(e,t,n,s={}){if(!this.running)throw new Error("QueryManager not started");const r=this.metrics?.queryTime.timer();let o;if(null==s.signal){o=new B.TimeoutController(KE),s.signal=o.signal;try{null!=lw.setMaxListeners&&(0,lw.setMaxListeners)(1/0,o.signal)}catch{}}const i=new AbortController;this.controllers.add(i);const c=[i.signal];null!=s.signal&&c.push(s.signal);const l=(0,_t.anySignal)(c);try{null!=lw.setMaxListeners&&(0,lw.setMaxListeners)(1/0,l)}catch{}const d=(0,a.vF)(`libp2p:kad-dht:${this.lan?"lan":"wan"}:query:`+(0,$.d)(e,"base58btc")),u=t.slice(0,Math.min(this.disjointPaths,t.length)),h=Date.now(),p=new Zh.b;try{if(d("query:start"),this.queries++,this.metrics?.runningQueries.update(this.queries),0===t.length)return void d.error("Running query with no peers");const r=new vw,o=u.map(((t,o)=>Fv({key:e,startingPeer:t,ourPeerId:this.components.peerId,signal:l,query:n,pathIndex:o,numPaths:u.length,alpha:this.alpha,cleanUp:p,queryFuncTimeout:s.queryFuncTimeout,log:d,peersSeen:r})));for await(const e of(0,Qr.A)(...o))yield e,"QUERY_ERROR"===e.name&&d("error",e.error)}catch(e){if(this.running||"ERR_QUERY_ABORTED"!==e.code)throw e}finally{this.controllers.delete(i),null!=o&&o.clear(),this.queries--,this.metrics?.runningQueries.update(this.queries),null!=r&&r(),p.dispatchEvent(new Zh.u("cleanup")),d("query:done in %dms",Date.now()-h)}}}const Hv=(0,a.vF)("libp2p:kad-dht:rpc:handlers:add-provider");class $v{constructor(e){const{providers:t}=e;this.providers=t}async handle(e,t){if(Hv("start"),null==t.key||0===t.key.length)throw new mp.A("Missing key","ERR_MISSING_KEY");let n;try{n=J.TO.decode(t.key)}catch(e){throw new mp.A("Invalid CID","ERR_INVALID_CID")}null!=t.providerPeers&&0!==t.providerPeers.length||Hv.error("no providers found in message"),await Promise.all(t.providerPeers.map((async t=>{t.id.equals(e)?t.multiaddrs.length<1?Hv("no valid addresses for provider %p. Ignore",e):(Hv("received provider %p for %s (addrs %s)",e,n,t.multiaddrs.map((e=>e.toString()))),await this.providers.addProvider(n,t.id)):Hv("invalid provider peer %p from %p",t.id,e)})))}}var Vv=n(5986);const Kv=(0,a.vF)("libp2p:kad-dht:rpc:handlers:find-node");class qv{constructor(e,t){const{peerRouting:n,lan:s}=t;this.components=e,this.peerRouting=n,this.lan=Boolean(s)}async handle(e,t){Kv("incoming request from %p for peers closer to %b",e,t.key);let n=[];n=(0,Vv.aI)(this.components.peerId.toBytes(),t.key)?[{id:this.components.peerId,multiaddrs:this.components.addressManager.getAddresses().map((e=>e.decapsulateCode((0,j.WH)("p2p").code))),protocols:[]}]:await this.peerRouting.getCloserPeersOffline(t.key,e),n=n.map(this.lan?WE:GE).filter((({multiaddrs:e})=>e.length));const s=new mv(t.type,new Uint8Array(0),t.clusterLevel);return n.length>0?s.closerPeers=n:Kv("could not find any peers closer to %b than %p",t.key,e),s}}const Gv=(0,a.vF)("libp2p:kad-dht:rpc:handlers:get-providers");class Wv{constructor(e,t){const{peerRouting:n,providers:s,lan:r}=t;this.components=e,this.peerRouting=n,this.providers=s,this.lan=Boolean(r)}async handle(e,t){let n;try{n=J.TO.decode(t.key)}catch(e){throw new mp.A("Invalid CID","ERR_INVALID_CID")}Gv("%p asking for providers for %s",e,n);const[s,r]=await Promise.all([this.providers.getProviders(n),this.peerRouting.getCloserPeersOffline(t.key,e)]),o=await this._getPeers(s),i=await this._getPeers(r.map((({id:e})=>e))),a=new mv(t.type,t.key,t.clusterLevel);return o.length>0&&(a.providerPeers=o),i.length>0&&(a.closerPeers=i),Gv("got %s providers %s closerPeers",o.length,i.length),a}async _getAddresses(e){return(await this.components.peerStore.addressBook.get(e)).map((e=>e.multiaddr))}async _getPeers(e){const t=[],n=this.lan?WE:GE;for(const s of e){const e=n({id:s,multiaddrs:await this._getAddresses(s),protocols:[]});e.multiaddrs.length>0&&t.push(e)}return t}}const Yv=(0,a.vF)("libp2p:kad-dht:rpc:handlers:get-value");class Xv{constructor(e,t){const{peerRouting:n}=t;this.components=e,this.peerRouting=n}async handle(e,t){const n=t.key;if(Yv("%p asked for key %b",e,n),null==n||0===n.length)throw new mp.A("Invalid key","ERR_INVALID_KEY");const s=new mv(fv.GET_VALUE,n,t.clusterLevel);if(function(e){return"/pk/"===(0,$.d)(e.subarray(0,4))}(n)){Yv("is public key");const e=function(e){return(0,Ht.nu)(e.subarray(4))}(n);let t;try{const n=await this.components.peerStore.keyBook.get(e);if(null==n)throw new mp.A("No public key found in key book","ERR_NOT_FOUND");t=n}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}if(null!=t)return Yv("returning found public key"),s.record=new ss.L(n,t,new Date),s}const[r,o]=await Promise.all([this._checkLocalDatastore(n),this.peerRouting.getCloserPeersOffline(t.key,e)]);return null!=r&&(Yv("had record for %b in local datastore",n),s.record=r),o.length>0&&(Yv("had %s closer peers in routing table",o.length),s.closerPeers=o),s}async _checkLocalDatastore(e){Yv("checkLocalDatastore looking for %b",e);const t=QE(e);let n;try{n=await this.components.datastore.get(t)}catch(e){if("ERR_NOT_FOUND"===e.code)return;throw e}const s=ss.L.deserialize(n);if(null==s)throw new mp.A("Invalid record","ERR_INVALID_RECORD");if(!(null==s.timeReceived||Date.now()-s.timeReceived.getTime()>1296e5))return s;await this.components.datastore.delete(t)}}const Qv=(0,a.vF)("libp2p:kad-dht:rpc:handlers:ping");class Jv{async handle(e,t){return Qv("ping from %p",e),t}}class Zv{constructor(e,t){const{validators:n}=t;this.components=e,this.log=(0,a.vF)("libp2p:kad-dht:rpc:handlers:put-value"),this.validators=n}async handle(e,t){const n=t.key;this.log("%p asked us to store value for key %b",e,n);const s=t.record;if(null==s){const t=`Empty record from: ${e.toString()}`;throw this.log.error(t),new mp.A(t,"ERR_EMPTY_RECORD")}try{await(0,Pv.R)(this.validators,s),s.timeReceived=new Date;const e=QE(s.key);await this.components.datastore.put(e,s.serialize().subarray()),this.log("put record for %b into datastore under key %k",n,e)}catch(e){this.log("did not put record for key %b into datastore %o",n,e)}return t}}class eS{constructor(e,t){const{providers:n,peerRouting:s,validators:r,lan:o}=t;this.log=(0,a.vF)("libp2p:kad-dht:rpc"),this.routingTable=t.routingTable,this.handlers={[fv.GET_VALUE]:new Xv(e,{peerRouting:s}),[fv.PUT_VALUE]:new Zv(e,{validators:r}),[fv.FIND_NODE]:new qv(e,{peerRouting:s,lan:o}),[fv.ADD_PROVIDER]:new $v({providers:n}),[fv.GET_PROVIDERS]:new Wv(e,{peerRouting:s,providers:n,lan:o}),[fv.PING]:new Jv}}async handleMessage(e,t){try{await this.routingTable.add(e)}catch(e){this.log.error("Failed to update the kbucket store",e)}const n=this.handlers[t.type];if(null!=n)return await n.handle(e,t);this.log.error(`no handler found for message type: ${t.type}`)}onIncomingStream(e){Promise.resolve().then((async()=>{const{stream:t,connection:n}=e,s=n.remotePeer;try{await this.routingTable.add(s)}catch(e){this.log.error(e)}const r=this;await no(t,ub(),(async function*(e){for await(const t of e){const e=mv.deserialize(t);r.log("incoming %s from %p",e.type,s);const n=await r.handleMessage(s,e);null!=n&&(yield n.serialize())}}),ib(),t)})).catch((e=>{this.log.error(e)}))}}class tS extends Zh.b{constructor(e,t){super();const{protocol:n,lan:s}=t;this.components=e,this.log=(0,a.vF)("libp2p:kad-dht:topology-listener:"+(s?"lan":"wan")),this.running=!1,this.protocol=n}isStarted(){return this.running}async start(){if(this.running)return;this.running=!0;const e=(0,Jh.g)({onConnect:e=>{this.log("observed peer %p with protocol %s",e,this.protocol),this.dispatchEvent(new Zh.u("peer",{detail:e}))}});this.registrarId=await this.components.registrar.register(this.protocol,e)}async stop(){this.running=!1,null!=this.registrarId&&(this.components.registrar.unregister(this.registrarId),this.registrarId=void 0)}}class nS{constructor(e,t){const{peerRouting:n,lan:s,count:r,interval:o,queryTimeout:i}=t;this.components=e,this.log=(0,a.vF)(`libp2p:kad-dht:${s?"lan":"wan"}:query-self`),this.running=!1,this.peerRouting=n,this.count=r??UE,this.interval=o??jE,this.queryTimeout=i??HE}isStarted(){return this.running}async start(){this.running||(this.running=!0,this._querySelf())}async stop(){this.running=!1,null!=this.timeoutId&&clearTimeout(this.timeoutId),null!=this.controller&&this.controller.abort()}_querySelf(){Promise.resolve().then((async()=>{const e=new B.TimeoutController(this.queryTimeout);try{this.controller=new AbortController;const t=(0,_t.anySignal)([this.controller.signal,e.signal]);try{null!=lw.setMaxListeners&&(0,lw.setMaxListeners)(1/0,t)}catch{}const n=await no(this.peerRouting.getClosestPeers(this.components.peerId.toBytes(),{signal:t}),(e=>(0,Gn.A)(e,this.count)),(async e=>await Sd(e)));this.log("query ran successfully - found %d peers",n)}catch(e){this.log("query error",e)}finally{this.timeoutId=setTimeout(this._querySelf.bind(this),this.interval),e.clear()}})).catch((e=>{this.log("query error",e)}))}}class sS extends Zh.b{constructor(e,t){super();const{kBucketSize:n,clientMode:s,validators:r,selectors:o,querySelfInterval:i,lan:c,protocolPrefix:l,pingTimeout:d,pingConcurrency:u,maxInboundStreams:h,maxOutboundStreams:p,providers:f}=t;this.running=!1,this.components=e,this.lan=Boolean(c),this.log=(0,a.vF)("libp2p:kad-dht:"+(!0===c?"lan":"wan")),this.protocol=`${l??"/ipfs"}${!0===c?"/lan":""}/kad/1.0.0`,this.kBucketSize=n??20,this.clientMode=s??!0,this.maxInboundStreams=h??32,this.maxOutboundStreams=p??64,this.routingTable=new ZE(e,{kBucketSize:n,lan:this.lan,pingTimeout:d,pingConcurrency:u,protocol:this.protocol}),this.providers=new Cv(e,f??{}),this.validators={...Pv.y,...r},this.selectors={...Av.T,...o},this.network=new Iv(e,{protocol:this.protocol,lan:this.lan}),this.queryManager=new jv(e,{disjointPaths:Math.ceil(this.kBucketSize/2),lan:c}),this.peerRouting=new Lv(e,{routingTable:this.routingTable,network:this.network,validators:this.validators,queryManager:this.queryManager,lan:this.lan}),this.contentFetching=new Dv(e,{validators:this.validators,selectors:this.selectors,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,network:this.network,lan:this.lan}),this.contentRouting=new Ov(e,{network:this.network,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,providers:this.providers,lan:this.lan}),this.routingTableRefresh=new nv({peerRouting:this.peerRouting,routingTable:this.routingTable,lan:this.lan}),this.rpc=new eS(e,{routingTable:this.routingTable,providers:this.providers,peerRouting:this.peerRouting,validators:this.validators,lan:this.lan}),this.topologyListener=new tS(e,{protocol:this.protocol,lan:this.lan}),this.querySelf=new nS(e,{peerRouting:this.peerRouting,interval:i,lan:this.lan}),this.network.addEventListener("peer",(e=>{const t=e.detail;this.onPeerConnect(t).catch((e=>{this.log.error("could not add %p to routing table",t.id,e)})),this.dispatchEvent(new Zh.u("peer",{detail:t}))})),this.topologyListener.addEventListener("peer",(e=>{const t=e.detail;Promise.resolve().then((async()=>{const e=await this.components.peerStore.addressBook.get(t),n={id:t,multiaddrs:e.map((e=>e.multiaddr)),protocols:[]};await this.onPeerConnect(n)})).catch((e=>{this.log.error("could not add %p to routing table",t,e)}))}))}get[kE.H](){return!0}get[Symbol.toStringTag](){return"@libp2p/kad-dht"}async onPeerConnect(e){if(this.log("peer %p connected with protocols %s",e.id,e.protocols),0!==(e=this.lan?WE(e):GE(e)).multiaddrs.length)try{await this.routingTable.add(e.id)}catch(t){this.log.error("could not add %p to routing table",e.id,t)}else this.log("ignoring %p as they do not have any %s addresses in %s",e.id,this.lan?"private":"public",e.multiaddrs.map((e=>e.toString())))}isStarted(){return this.running}async getMode(){return this.clientMode?"client":"server"}async setMode(e){await this.components.registrar.unhandle(this.protocol),"client"===e?(this.log("enabling client mode"),this.clientMode=!0):(this.log("enabling server mode"),this.clientMode=!1,await this.components.registrar.handle(this.protocol,this.rpc.onIncomingStream.bind(this.rpc),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}))}async start(){this.running=!0,await this.setMode(this.clientMode?"client":"server"),await Promise.all([this.providers.start(),this.queryManager.start(),this.network.start(),this.routingTable.start(),this.topologyListener.start(),this.querySelf.start()]),await this.routingTableRefresh.start()}async stop(){this.running=!1,await Promise.all([this.providers.stop(),this.queryManager.stop(),this.network.stop(),this.routingTable.stop(),this.routingTableRefresh.stop(),this.topologyListener.stop(),this.querySelf.stop()])}async*put(e,t,n={}){yield*this.contentFetching.put(e,t,n)}async*get(e,t={}){yield*this.contentFetching.get(e,t)}async*provide(e,t={}){yield*this.contentRouting.provide(e,this.components.addressManager.getAddresses(),t)}async*findProviders(e,t={}){yield*this.contentRouting.findProviders(e,t)}async*findPeer(e,t={}){yield*this.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t={}){yield*this.peerRouting.getClosestPeers(e,t)}async refreshRoutingTable(){this.routingTableRefresh.refreshTable(!0)}}const rS=(0,a.vF)("libp2p:kad-dht");class oS extends Zh.b{constructor(e,t,n){super(),this.components=e,this.wan=t,this.lan=n,this.wan.addEventListener("peer",(e=>{this.dispatchEvent(new Zh.u("peer",{detail:e.detail}))})),this.lan.addEventListener("peer",(e=>{this.dispatchEvent(new Zh.u("peer",{detail:e.detail}))}))}get[kE.H](){return!0}get[Symbol.toStringTag](){return"@libp2p/dual-kad-dht"}isStarted(){return this.wan.isStarted()&&this.lan.isStarted()}async getMode(){return await this.wan.getMode()}async setMode(e){await this.wan.setMode(e)}async start(){await Promise.all([this.lan.start(),this.wan.start()])}async stop(){await Promise.all([this.lan.stop(),this.wan.stop()])}async*put(e,t,n={}){for await(const s of(0,Qr.A)(this.lan.put(e,t,n),this.wan.put(e,t,n)))yield s}async*get(e,t={}){let n=!1,s=!1;for await(const r of(0,Qr.A)(this.lan.get(e,t),this.wan.get(e,t)))yield r,"DIALING_PEER"===r.name&&(n=!0),"VALUE"===r.name&&(n=!0,null!=r.value&&(s=!0)),"SENDING_QUERY"===r.name&&(n=!0);if(!n)throw new mp.A("No peers found in routing table!","ERR_NO_PEERS_IN_ROUTING_TABLE");s||(yield Sv({from:this.components.peerId,error:new mp.A("Not found","ERR_NOT_FOUND")}))}async*provide(e,t={}){let n=0,s=0;const r=[],o=[this.lan];"server"===await this.wan.getMode()&&o.push(this.wan);for await(const i of(0,Qr.A)(...o.map((n=>n.provide(e,t)))))yield i,"SENDING_QUERY"===i.name&&n++,"QUERY_ERROR"===i.name&&r.push(i.error),"PEER_RESPONSE"===i.name&&"ADD_PROVIDER"===i.messageName&&(rS("sent provider record for %s to %p",e,i.from),s++);if(0===s){if(r.length>0)throw new mp.A(`Failed to provide to ${r.length} of ${n} peers`,"ERR_PROVIDES_FAILED",{errors:r});throw new mp.A("Failed to provide - no peers found","ERR_PROVIDES_FAILED")}}async*findProviders(e,t={}){yield*(0,Qr.A)(this.lan.findProviders(e,t),this.wan.findProviders(e,t))}async*findPeer(e,t={}){let n=!1;for await(const s of(0,Qr.A)(this.lan.findPeer(e,t),this.wan.findPeer(e,t)))yield s,"SENDING_QUERY"!==s.name&&"FINAL_PEER"!==s.name||(n=!0);if(!n)throw new mp.A("Peer lookup failed","ERR_LOOKUP_FAILED")}async*getClosestPeers(e,t={}){yield*(0,Qr.A)(this.lan.getClosestPeers(e,t),this.wan.getClosestPeers(e,t))}async refreshRoutingTable(){await Promise.all([this.lan.refreshRoutingTable(),this.wan.refreshRoutingTable()])}}class iS extends oS{constructor(e,t){super(e,new sS(e,{protocolPrefix:"/ipfs",...t,lan:!1}),new sS(e,{protocolPrefix:"/ipfs",...t,clientMode:!1,lan:!0}))}}const aS=H.wM,cS=H.w7,lS=function(e){let t=0;if(e=e.toString().trim(),aS(e)){const n=new Uint8Array(t+4);return e.split(/\./g).forEach((e=>{n[t++]=255&parseInt(e,10)})),n}if(cS(e)){const n=e.split(":",8);let s;for(s=0;s<n.length;s++){let e;aS(n[s])&&(e=lS(n[s]),n[s]=(0,$.d)(e.slice(0,2),"base16")),null!=e&&++s<8&&n.splice(s,0,(0,$.d)(e.slice(2,4),"base16"))}if(""===n[0])for(;n.length<8;)n.unshift("0");else if(""===n[n.length-1])for(;n.length<8;)n.push("0");else if(n.length<8){for(s=0;s<n.length&&""!==n[s];s++);const e=[s,1];for(s=9-n.length;s>0;s--)e.push("0");n.splice.apply(n,e)}const r=new Uint8Array(t+16);for(s=0;s<n.length;s++){const e=parseInt(n[s],16);r[t++]=e>>8&255,r[t++]=255&e}return r}throw new Error("invalid ip address")},dS=function(e,t=0,n){t=~~t,n=n??e.length-t;const s=new DataView(e.buffer);if(4===n){const s=[];for(let r=0;r<n;r++)s.push(e[t+r]);return s.join(".")}if(16===n){const e=[];for(let r=0;r<n;r+=2)e.push(s.getUint16(t+r).toString(16));return e.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""},uS=-1,hS={},pS={};function fS(e){if("number"==typeof e){if(null!=pS[e])return pS[e];throw new Error(`no protocol with code: ${e}`)}if("string"==typeof e){if(null!=hS[e])return hS[e];throw new Error(`no protocol with name: ${e}`)}throw new Error("invalid protocol id type: "+typeof e)}[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,uS,"ip6zone"],[43,8,"ipcidr"],[53,uS,"dns",!0],[54,uS,"dns4",!0],[55,uS,"dns6",!0],[56,uS,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,uS,"unix",!1,!0],[421,uS,"ipfs"],[421,uS,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,uS,"garlic64"],[448,0,"tls"],[449,uS,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,uS,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[777,uS,"memory"]].forEach((e=>{const t=function(e,t,n,s,r){return{code:e,size:t,name:n,resolvable:Boolean(s),path:Boolean(r)}}(...e);pS[t.code]=t,hS[t.name]=t}));fS("ip4"),fS("ip6"),fS("ipcidr");function yS(e,t){switch(fS(e).code){case 4:case 41:return function(e){const t=dS(e,0,e.length);if(null==t)throw new Error("ipBuff is required");if(!H.ei(t))throw new Error("invalid ip address");return t}(t);case 42:case 53:case 54:case 55:case 56:case 400:case 449:case 777:return SS(t);case 6:case 273:case 33:case 132:return ES(t).toString();case 421:return function(e){const t=zs.decode(e),n=e.slice(zs.decode.bytes);if(n.length!==t)throw new Error("inconsistent lengths");return(0,$.d)(n,"base58btc")}(t);case 444:case 445:return kS(t);case 466:return function(e){const t=zs.decode(e),n=e.slice(zs.decode.bytes);if(n.length!==t)throw new Error("inconsistent lengths");return"u"+(0,$.d)(n,"base64url")}(t);default:return(0,$.d)(t,"base16")}}function gS(e,t){switch(fS(e).code){case 4:case 41:return bS(t);case 42:case 53:case 54:case 55:case 56:case 400:case 449:case 777:return vS(t);case 6:case 273:case 33:case 132:return _S(parseInt(t,10));case 421:return function(e){let t;t="Q"===e[0]||"1"===e[0]?F.D4(z.base58btc.decode(`z${e}`)).bytes:J.TO.parse(e).multihash.bytes;const n=Uint8Array.from(zs.encode(t.length));return(0,ee.x)([n,t],n.length+t.length)}(t);case 444:return function(e){const t=e.split(":");if(2!==t.length)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(16!==t[0].length)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion address.`);const n=U.base32.decode("b"+t[0]),s=parseInt(t[1],10);if(s<1||s>65536)throw new Error("Port number is not in range(1, 65536)");const r=_S(s);return(0,ee.x)([n,r],n.length+r.length)}(t);case 445:return function(e){const t=e.split(":");if(2!==t.length)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(56!==t[0].length)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion3 address.`);const n=U.base32.decode(`b${t[0]}`),s=parseInt(t[1],10);if(s<1||s>65536)throw new Error("Port number is not in range(1, 65536)");const r=_S(s);return(0,ee.x)([n,r],n.length+r.length)}(t);case 466:return function(e){const t=wS.decode(e),n=Uint8Array.from(zs.encode(t.length));return(0,ee.x)([n,t],n.length+t.length)}(t);default:return(0,x.s)(t,"base16")}}const mS=Object.values(P.Fo).map((e=>e.decoder)),wS=function(){let e=mS[0].or(mS[1]);return mS.slice(2).forEach((t=>e=e.or(t))),e}();function bS(e){if(!H.ei(e))throw new Error("invalid ip address");return lS(e)}function _S(e){const t=new ArrayBuffer(2);return new DataView(t).setUint16(0,e),new Uint8Array(t)}function ES(e){return new DataView(e.buffer).getUint16(e.byteOffset)}function vS(e){const t=(0,x.s)(e),n=Uint8Array.from(zs.encode(t.length));return(0,ee.x)([n,t],n.length+t.length)}function SS(e){const t=zs.decode(e);if((e=e.slice(zs.decode.bytes)).length!==t)throw new Error("inconsistent lengths");return(0,$.d)(e)}function kS(e){const t=e.slice(0,e.length-2),n=e.slice(e.length-2);return`${(0,$.d)(t,"base32")}:${ES(n)}`}function RS(e){return e.map((e=>{const t=CS(e);return null!=e[1]?[t.code,yS(t.code,e[1])]:[t.code]}))}function TS(e){return OS((0,ee.x)(e.map((e=>{const t=CS(e);let n=Uint8Array.from(zs.encode(t.code));return e.length>1&&null!=e[1]&&(n=(0,ee.x)([n,e[1]])),n}))))}function IS(e,t){if(e.size>0)return e.size/8;if(0===e.size)return 0;return zs.decode(t)+(zs.decode.bytes??0)}function PS(e){const t=[];let n=0;for(;n<e.length;){const s=zs.decode(e,n),r=zs.decode.bytes??0,o=IS(fS(s),e.slice(n+r));if(0===o){t.push([s]),n+=r;continue}const i=e.slice(n+r,n+r+o);if(n+=o+r,n>e.length)throw MS("Invalid address Uint8Array: "+(0,$.d)(e,"base16"));t.push([s,i])}return t}function AS(e){return function(e){const t=[];return e.map((e=>{const n=CS(e);return t.push(n.name),e.length>1&&null!=e[1]&&t.push(e[1]),null})),LS(t.join("/"))}(RS(PS(e)))}function DS(e){const t=function(e){const t=[],n=e.split("/").slice(1);if(1===n.length&&""===n[0])return[];for(let s=0;s<n.length;s++){const r=n[s],o=fS(r);if(0!==o.size){if(s++,s>=n.length)throw MS("invalid address: "+e);if(!0===o.path){t.push([r,LS(n.slice(s).join("/"))]);break}t.push([r,n[s]])}else t.push([r])}return t}(e=LS(e));return TS(t.map((e=>{Array.isArray(e)||(e=[e]);const t=CS(e);return e.length>1?[t.code,gS(t.code,e[1])]:[t.code]})))}function OS(e){const t=NS(e);if(null!=t)throw t;return Uint8Array.from(e)}function NS(e){try{PS(e)}catch(e){return e}}function LS(e){return"/"+e.trim().split("/").filter((e=>e)).join("/")}function MS(e){return new Error("Error parsing address: "+e)}function CS(e){return fS(e[0])}var xS,BS,zS,US,FS=function(e,t,n,s){if("a"===n&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?s:"a"===n?s.call(e):s?s.value:t.get(e)},jS=function(e,t,n,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(e,n):r?r.value=n:t.set(e,n),n};const HS=Symbol.for("nodejs.util.inspect.custom"),$S=[fS("dns").code,fS("dns4").code,fS("dns6").code,fS("dnsaddr").code],VS=new Map,KS=Symbol.for("@multiformats/js-multiaddr/multiaddr");function qS(e){return Boolean(e?.[KS])}class GS{constructor(e){if(xS.set(this,void 0),BS.set(this,void 0),zS.set(this,void 0),this[US]=!0,null==e&&(e=""),e instanceof Uint8Array)this.bytes=OS(e);else if("string"==typeof e){if(e.length>0&&"/"!==e.charAt(0))throw new Error(`multiaddr "${e}" must start with a "/"`);this.bytes=DS(e)}else{if(!qS(e))throw new Error("addr must be a string, Buffer, or another Multiaddr");this.bytes=OS(e.bytes)}}toString(){return null==FS(this,xS,"f")&&jS(this,xS,AS(this.bytes),"f"),FS(this,xS,"f")}toJSON(){return this.toString()}toOptions(){let e,t,n,s,r="";const o=fS("tcp"),i=fS("udp"),a=fS("ip4"),c=fS("ip6"),l=fS("dns6"),d=fS("ip6zone");for(const[u,h]of this.stringTuples())u===d.code&&(r=`%${h??""}`),$S.includes(u)&&(t=o.name,s=443,n=`${h??""}${r}`,e=u===l.code?6:4),u!==o.code&&u!==i.code||(t=fS(u).name,s=parseInt(h??"")),u!==a.code&&u!==c.code||(t=fS(u).name,n=`${h??""}${r}`,e=u===c.code?6:4);if(null==e||null==t||null==n||null==s)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:s}}protos(){return this.protoCodes().map((e=>Object.assign({},fS(e))))}protoCodes(){const e=[],t=this.bytes;let n=0;for(;n<t.length;){const s=zs.decode(t,n),r=zs.decode.bytes??0;n+=IS(fS(s),t.slice(n+r))+r,e.push(s)}return e}protoNames(){return this.protos().map((e=>e.name))}tuples(){return null==FS(this,BS,"f")&&jS(this,BS,PS(this.bytes),"f"),FS(this,BS,"f")}stringTuples(){return null==FS(this,zS,"f")&&jS(this,zS,RS(this.tuples()),"f"),FS(this,zS,"f")}encapsulate(e){return e=new GS(e),new GS(this.toString()+e.toString())}decapsulate(e){const t=e.toString(),n=this.toString(),s=n.lastIndexOf(t);if(s<0)throw new Error(`Address ${this.toString()} does not contain subaddress: ${e.toString()}`);return new GS(n.slice(0,s))}decapsulateCode(e){const t=this.tuples();for(let n=t.length-1;n>=0;n--)if(t[n][0]===e)return new GS(TS(t.slice(0,n)));return this}getPeerId(){try{const e=this.stringTuples().filter((e=>e[0]===hS.ipfs.code)),t=e.pop();if(null!=t?.[1]){const e=t[1];return"Q"===e[0]||"1"===e[0]?(0,$.d)(z.base58btc.decode(`z${e}`),"base58btc"):(0,$.d)(J.TO.parse(e).multihash.bytes,"base58btc")}return null}catch(e){return null}}getPath(){let e=null;try{e=this.stringTuples().filter((e=>!0===fS(e[0]).path))[0][1],null==e&&(e=null)}catch{e=null}return e}equals(e){return(0,ve.a)(this.bytes,e.bytes)}async resolve(e){const t=this.protos().find((e=>e.resolvable));if(null==t)return[this];const n=VS.get(t.name);if(null==n)throw c(new Error(`no available resolver for ${t.name}`),"ERR_NO_AVAILABLE_RESOLVER");return(await n(this,e)).map((e=>new GS(e)))}nodeAddress(){const e=this.toOptions();if("tcp"!==e.transport&&"udp"!==e.transport)throw new Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(e){const t=(e??this).protos();return 2===t.length&&((4===t[0].code||41===t[0].code)&&(6===t[1].code||273===t[1].code))}[(xS=new WeakMap,BS=new WeakMap,zS=new WeakMap,US=KS,HS)](){return`Multiaddr(${AS(this.bytes)})`}}function WS(e){return new GS(e)}const YS=Ek("dns4"),XS=Ek("dns6"),QS=Ek("dnsaddr"),JS=_k(Ek("dns"),QS,YS,XS),ZS=_k(Ek("ip4"),Ek("ip6")),ek=_k(bk(ZS,Ek("tcp")),bk(JS,Ek("tcp"))),tk=bk(ZS,Ek("udp")),nk=bk(tk,Ek("utp")),sk=bk(tk,Ek("quic")),rk=_k(bk(ek,Ek("ws")),bk(JS,Ek("ws"))),ok=_k(bk(ek,Ek("wss")),bk(JS,Ek("wss")),bk(ek,Ek("tls"),Ek("ws")),bk(JS,Ek("tls"),Ek("ws"))),ik=_k(bk(ek,Ek("http")),bk(ZS,Ek("http")),bk(JS,Ek("http"))),ak=_k(bk(ek,Ek("https")),bk(ZS,Ek("https")),bk(JS,Ek("https"))),ck=bk(tk,Ek("webrtc-direct"),Ek("certhash")),lk=_k(bk(ck,Ek("p2p")),ck),dk=_k(bk(rk,Ek("p2p-webrtc-star"),Ek("p2p")),bk(ok,Ek("p2p-webrtc-star"),Ek("p2p")),bk(rk,Ek("p2p-webrtc-star")),bk(ok,Ek("p2p-webrtc-star"))),uk=(_k(bk(rk,Ek("p2p-websocket-star"),Ek("p2p")),bk(ok,Ek("p2p-websocket-star"),Ek("p2p")),bk(rk,Ek("p2p-websocket-star")),bk(ok,Ek("p2p-websocket-star"))),_k(bk(ik,Ek("p2p-webrtc-direct"),Ek("p2p")),bk(ak,Ek("p2p-webrtc-direct"),Ek("p2p")),bk(ik,Ek("p2p-webrtc-direct")),bk(ak,Ek("p2p-webrtc-direct")))),hk=_k(rk,ok,ik,ak,dk,uk,ek,nk,sk,JS,lk),pk=(_k(bk(hk,Ek("p2p-stardust"),Ek("p2p")),bk(hk,Ek("p2p-stardust"))),_k(bk(hk,Ek("p2p")),dk,uk,lk,Ek("p2p"))),fk=_k(bk(pk,Ek("p2p-circuit"),pk),bk(pk,Ek("p2p-circuit")),bk(Ek("p2p-circuit"),pk),bk(hk,Ek("p2p-circuit")),bk(Ek("p2p-circuit"),hk),Ek("p2p-circuit")),yk=()=>_k(bk(fk,yk),fk),gk=yk(),mk=_k(bk(gk,pk,gk),bk(pk,gk),bk(gk,pk),gk,pk);_k(bk(gk,Ek("webrtc")),bk(hk,Ek("webrtc")),Ek("webrtc"));function wk(e){return function(t){let n;try{n=WS(t)}catch(e){return!1}const s=e(n.protoNames());return null!==s&&(!0===s||!1===s?s:0===s.length)}}function bk(...e){function t(t){if(t.length<e.length)return null;let n=t;return e.some((e=>(n="function"==typeof e?e().partialMatch(t):e.partialMatch(t),Array.isArray(n)&&(t=n),null===n))),n}return{toString:function(){return"{ "+e.join(" ")+" }"},input:e,matches:wk(t),partialMatch:t}}function _k(...e){function t(t){let n=null;return e.some((e=>{const s="function"==typeof e?e().partialMatch(t):e.partialMatch(t);return null!=s&&(n=s,!0)})),n}return{toString:function(){return"{ "+e.join(" ")+" }"},input:e,matches:wk(t),partialMatch:t}}function Ek(e){const t=e;return{toString:function(){return t},matches:function(e){let n;try{n=WS(e)}catch(e){return!1}const s=n.protoNames();return 1===s.length&&s[0]===t},partialMatch:function(e){return 0===e.length?null:e[0]===t?e.slice(1):null}}}const vk=(0,a.vF)("libp2p:bootstrap");class Sk extends Zh.b{constructor(e,t={list:[]}){if(null==t.list||0===t.list.length)throw new Error("Bootstrap requires a list of peer addresses");super(),this.components=e,this.timeout=t.timeout??1e3,this.list=[];for(const e of t.list){if(!mk.matches(e)){vk.error("Invalid multiaddr");continue}const t=WS(e),n=t.getPeerId();if(null==n){vk.error("Invalid bootstrap multiaddr without peer id");continue}const s={id:(0,Ht.XL)(n),multiaddrs:[t],protocols:[]};this.list.push(s)}this._init=t}get[kE.H](){return!0}get[Symbol.toStringTag](){return"@libp2p/bootstrap"}isStarted(){return Boolean(this.timer)}start(){this.isStarted()||(vk("Starting bootstrap node discovery, discovering peers after %s ms",this.timeout),this.timer=setTimeout((()=>{this._discoverBootstrapPeers().catch((e=>{vk.error(e)}))}),this.timeout))}async _discoverBootstrapPeers(){if(null!=this.timer)for(const e of this.list){if(await this.components.peerStore.tagPeer(e.id,this._init.tagName??"bootstrap",{value:this._init.tagValue??50,ttl:this._init.tagTTL??12e4}),null==this.timer)return;this.dispatchEvent(new Zh.u("peer",{detail:e}))}}stop(){null!=this.timer&&clearTimeout(this.timer),this.timer=void 0}}Sk.tag="bootstrap";var kk=WebSocket,Rk=n(60544);function Tk(e){return e instanceof ArrayBuffer||"ArrayBuffer"===e?.constructor?.name&&"number"==typeof e?.byteLength}var Ik=e=>{if(e.readyState>=2)throw new Error("socket closed");if(1!==e.readyState)return new Promise(((t,n)=>{function s(){e.removeEventListener("open",r),e.removeEventListener("error",o)}function r(){s(),t()}function o(t){s(),n(t.error??new Error(`connect ECONNREFUSED ${e.url}`))}e.addEventListener("open",r),e.addEventListener("error",o)}))},Pk=(e,t)=>{(t=t??{}).closeOnEnd=!1!==t.closeOnEnd;return async n=>{for await(const t of n){try{await Ik(e)}catch(e){if("socket closed"===e.message)break;throw e}e.send(t)}if(null!=t.closeOnEnd&&e.readyState<=1)return await new Promise(((t,n)=>{e.addEventListener("close",(e=>{if(e.wasClean||1006===e.code)t();else{const t=Object.assign(new Error("ws error"),{event:e});n(t)}})),setTimeout((()=>e.close()))}))}},Ak=(e,t)=>{t=t??{};const n=(e=>{e.binaryType="arraybuffer";const t=async()=>await new Promise(((t,n)=>{if(r)return t();if(null!=s)return n(s);const o=t=>{e.removeEventListener("open",i),e.removeEventListener("error",a),t()},i=()=>o(t),a=t=>{o((()=>n(t.error??new Error(`connect ECONNREFUSED ${e.url}`))))};e.addEventListener("open",i),e.addEventListener("error",a)})),n=async function*(){const n=new Rk.PP((({push:t,stop:n,fail:s})=>{const r=e=>{let n=null;"string"==typeof e.data&&(n=(0,x.s)(e.data)),Tk(e.data)&&(n=new Uint8Array(e.data)),e.data instanceof Uint8Array&&(n=e.data),null!=n&&t(n)},o=e=>s(e.error??new Error("Socket error"));return e.addEventListener("message",r),e.addEventListener("error",o),e.addEventListener("close",n),()=>{e.removeEventListener("message",r),e.removeEventListener("error",o),e.removeEventListener("close",n)}}),{highWaterMark:1/0});await t();for await(const e of n)yield Tk(e)?new Uint8Array(e):e}();let s,r=1===e.readyState;return e.addEventListener("open",(()=>{r=!0,s=null})),e.addEventListener("close",(()=>{r=!1,s=null})),e.addEventListener("error",(t=>{r||(s=t.error??new Error(`connect ECONNREFUSED ${e.url}`))})),Object.assign(n,{connected:t})})(e);let s=t.remoteAddress,r=t.remotePort;if(null!=e.url)try{const t=new URL(e.url);s=t.hostname,r=parseInt(t.port,10)}catch{}if(null==s||null==r)throw new Error("Remote connection did not have address and/or port");const o={sink:Pk(e,t),source:n,connected:async()=>await n.connected(),close:async()=>{e.readyState!==e.CONNECTING&&e.readyState!==e.OPEN||await new Promise((t=>{e.addEventListener("close",(()=>{t()})),e.close()}))},destroy:()=>{null!=e.terminate?e.terminate():e.close()},remoteAddress:s,remotePort:r,socket:e};return o};const Dk={http:"ws",https:"wss"};function Ok(e,t){t=t??{};const n=((e,t)=>(0,ct.relative)(e,t,Dk,"ws"))(e,("undefined"==typeof window?"":window.location).toString()),s=new kk(n,t.websocket);return Ak(s,t)}class Nk extends Error{constructor(e){super(e),this.name="TimeoutError"}}class Lk extends Error{constructor(e){super(),this.name="AbortError",this.message=e}}const Mk=e=>void 0===globalThis.DOMException?new Lk(e):new DOMException(e),Ck=e=>{const t=void 0===e.reason?Mk("This operation was aborted."):e.reason;return t instanceof Error?t:Mk(t)};const xk=(0,a.vF)("libp2p:websockets:socket");function Bk(e,t,n){const s={async sink(t){null!=n?.signal&&(t=(0,qp.IV)(t,n.signal));try{await e.sink(t)}catch(e){"aborted"!==e.type&&xk.error(e)}},source:null!=(n=n??{}).signal?(0,qp.IV)(e.source,n.signal):e.source,remoteAddr:t,timeline:{open:Date.now()},async close(){const t=Date.now();try{await function(e,t){const{milliseconds:n,fallback:s,message:r,customTimers:o={setTimeout:setTimeout,clearTimeout:clearTimeout}}=t;let i;const a=new Promise(((a,c)=>{if("number"!=typeof n||1!==Math.sign(n))throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${n}\``);if(n===Number.POSITIVE_INFINITY)return void a(e);if(t.signal){const{signal:e}=t;e.aborted&&c(Ck(e)),e.addEventListener("abort",(()=>{c(Ck(e))}))}const l=new Nk;i=o.setTimeout.call(void 0,(()=>{if(s)try{a(s())}catch(e){c(e)}else"function"==typeof e.cancel&&e.cancel(),!1===r?a():r instanceof Error?c(r):(l.message=r??`Promise timed out after ${n} milliseconds`,c(l))}),n),(async()=>{try{a(await e)}catch(e){c(e)}finally{o.clearTimeout.call(void 0,i)}})()}));return a.clear=()=>{o.clearTimeout.call(void 0,i),i=void 0},a}(e.close(),{milliseconds:2e3})}catch(n){const{host:r,port:o}=s.remoteAddr.toOptions();xk("timeout closing stream to %s:%s after %dms, destroying it manually",r,o,Date.now()-t),e.destroy()}finally{s.timeline.close=Date.now()}}};return e.socket.addEventListener("close",(()=>{null==s.timeline.close&&(s.timeline.close=Date.now())}),{once:!0}),s}const zk=H.wM,Uk=H.w7,Fk=function(e){let t=0;if(e=e.toString().trim(),zk(e)){const n=new Uint8Array(t+4);return e.split(/\./g).forEach((e=>{n[t++]=255&parseInt(e,10)})),n}if(Uk(e)){const n=e.split(":",8);let s;for(s=0;s<n.length;s++){let e;zk(n[s])&&(e=Fk(n[s]),n[s]=(0,$.d)(e.slice(0,2),"base16")),null!=e&&++s<8&&n.splice(s,0,(0,$.d)(e.slice(2,4),"base16"))}if(""===n[0])for(;n.length<8;)n.unshift("0");else if(""===n[n.length-1])for(;n.length<8;)n.push("0");else if(n.length<8){for(s=0;s<n.length&&""!==n[s];s++);const e=[s,1];for(s=9-n.length;s>0;s--)e.push("0");n.splice.apply(n,e)}const r=new Uint8Array(t+16);for(s=0;s<n.length;s++){const e=parseInt(n[s],16);r[t++]=e>>8&255,r[t++]=255&e}return r}throw new Error("invalid ip address")},jk=function(e,t=0,n){t=~~t,n=n??e.length-t;const s=new DataView(e.buffer);if(4===n){const s=[];for(let r=0;r<n;r++)s.push(e[t+r]);return s.join(".")}if(16===n){const e=[];for(let r=0;r<n;r+=2)e.push(s.getUint16(t+r).toString(16));return e.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""},Hk=-1,$k={},Vk={};function Kk(e){if("number"==typeof e){if(null!=Vk[e])return Vk[e];throw new Error(`no protocol with code: ${e}`)}if("string"==typeof e){if(null!=$k[e])return $k[e];throw new Error(`no protocol with name: ${e}`)}throw new Error("invalid protocol id type: "+typeof e)}[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,Hk,"ip6zone"],[43,8,"ipcidr"],[53,Hk,"dns",!0],[54,Hk,"dns4",!0],[55,Hk,"dns6",!0],[56,Hk,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,Hk,"unix",!1,!0],[421,Hk,"ipfs"],[421,Hk,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,Hk,"garlic64"],[448,0,"tls"],[449,Hk,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,Hk,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[777,Hk,"memory"]].forEach((e=>{const t=function(e,t,n,s,r){return{code:e,size:t,name:n,resolvable:Boolean(s),path:Boolean(r)}}(...e);Vk[t.code]=t,$k[t.name]=t}));Kk("ip4"),Kk("ip6"),Kk("ipcidr");function qk(e,t){switch(Kk(e).code){case 4:case 41:return function(e){const t=jk(e,0,e.length);if(null==t)throw new Error("ipBuff is required");if(!H.ei(t))throw new Error("invalid ip address");return t}(t);case 42:case 53:case 54:case 55:case 56:case 400:case 449:case 777:return eR(t);case 6:case 273:case 33:case 132:return Jk(t).toString();case 421:return function(e){const t=zs.decode(e),n=e.slice(zs.decode.bytes);if(n.length!==t)throw new Error("inconsistent lengths");return(0,$.d)(n,"base58btc")}(t);case 444:case 445:return tR(t);case 466:return function(e){const t=zs.decode(e),n=e.slice(zs.decode.bytes);if(n.length!==t)throw new Error("inconsistent lengths");return"u"+(0,$.d)(n,"base64url")}(t);default:return(0,$.d)(t,"base16")}}function Gk(e,t){switch(Kk(e).code){case 4:case 41:return Xk(t);case 42:case 53:case 54:case 55:case 56:case 400:case 449:case 777:return Zk(t);case 6:case 273:case 33:case 132:return Qk(parseInt(t,10));case 421:return function(e){let t;t="Q"===e[0]||"1"===e[0]?F.D4(z.base58btc.decode(`z${e}`)).bytes:J.TO.parse(e).multihash.bytes;const n=Uint8Array.from(zs.encode(t.length));return(0,ee.x)([n,t],n.length+t.length)}(t);case 444:return function(e){const t=e.split(":");if(2!==t.length)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(16!==t[0].length)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion address.`);const n=U.base32.decode("b"+t[0]),s=parseInt(t[1],10);if(s<1||s>65536)throw new Error("Port number is not in range(1, 65536)");const r=Qk(s);return(0,ee.x)([n,r],n.length+r.length)}(t);case 445:return function(e){const t=e.split(":");if(2!==t.length)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(56!==t[0].length)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion3 address.`);const n=U.base32.decode(`b${t[0]}`),s=parseInt(t[1],10);if(s<1||s>65536)throw new Error("Port number is not in range(1, 65536)");const r=Qk(s);return(0,ee.x)([n,r],n.length+r.length)}(t);case 466:return function(e){const t=Yk.decode(e),n=Uint8Array.from(zs.encode(t.length));return(0,ee.x)([n,t],n.length+t.length)}(t);default:return(0,x.s)(t,"base16")}}const Wk=Object.values(P.Fo).map((e=>e.decoder)),Yk=function(){let e=Wk[0].or(Wk[1]);return Wk.slice(2).forEach((t=>e=e.or(t))),e}();function Xk(e){if(!H.ei(e))throw new Error("invalid ip address");return Fk(e)}function Qk(e){const t=new ArrayBuffer(2);return new DataView(t).setUint16(0,e),new Uint8Array(t)}function Jk(e){return new DataView(e.buffer).getUint16(e.byteOffset)}function Zk(e){const t=(0,x.s)(e),n=Uint8Array.from(zs.encode(t.length));return(0,ee.x)([n,t],n.length+t.length)}function eR(e){const t=zs.decode(e);if((e=e.slice(zs.decode.bytes)).length!==t)throw new Error("inconsistent lengths");return(0,$.d)(e)}function tR(e){const t=e.slice(0,e.length-2),n=e.slice(e.length-2);return`${(0,$.d)(t,"base32")}:${Jk(n)}`}function nR(e){return e.map((e=>{const t=hR(e);return null!=e[1]?[t.code,qk(t.code,e[1])]:[t.code]}))}function sR(e){return cR((0,ee.x)(e.map((e=>{const t=hR(e);let n=Uint8Array.from(zs.encode(t.code));return e.length>1&&null!=e[1]&&(n=(0,ee.x)([n,e[1]])),n}))))}function rR(e,t){if(e.size>0)return e.size/8;if(0===e.size)return 0;return zs.decode(t)+(zs.decode.bytes??0)}function oR(e){const t=[];let n=0;for(;n<e.length;){const s=zs.decode(e,n),r=zs.decode.bytes??0,o=rR(Kk(s),e.slice(n+r));if(0===o){t.push([s]),n+=r;continue}const i=e.slice(n+r,n+r+o);if(n+=o+r,n>e.length)throw uR("Invalid address Uint8Array: "+(0,$.d)(e,"base16"));t.push([s,i])}return t}function iR(e){return function(e){const t=[];return e.map((e=>{const n=hR(e);return t.push(n.name),e.length>1&&null!=e[1]&&t.push(e[1]),null})),dR(t.join("/"))}(nR(oR(e)))}function aR(e){const t=function(e){const t=[],n=e.split("/").slice(1);if(1===n.length&&""===n[0])return[];for(let s=0;s<n.length;s++){const r=n[s],o=Kk(r);if(0!==o.size){if(s++,s>=n.length)throw uR("invalid address: "+e);if(!0===o.path){t.push([r,dR(n.slice(s).join("/"))]);break}t.push([r,n[s]])}else t.push([r])}return t}(e=dR(e));return sR(t.map((e=>{Array.isArray(e)||(e=[e]);const t=hR(e);return e.length>1?[t.code,Gk(t.code,e[1])]:[t.code]})))}function cR(e){const t=lR(e);if(null!=t)throw t;return Uint8Array.from(e)}function lR(e){try{oR(e)}catch(e){return e}}function dR(e){return"/"+e.trim().split("/").filter((e=>e)).join("/")}function uR(e){return new Error("Error parsing address: "+e)}function hR(e){return Kk(e[0])}var pR,fR,yR,gR,mR=function(e,t,n,s){if("a"===n&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?s:"a"===n?s.call(e):s?s.value:t.get(e)},wR=function(e,t,n,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(e,n):r?r.value=n:t.set(e,n),n};const bR=Symbol.for("nodejs.util.inspect.custom"),_R=[Kk("dns").code,Kk("dns4").code,Kk("dns6").code,Kk("dnsaddr").code],ER=new Map,vR=Symbol.for("@multiformats/js-multiaddr/multiaddr");function SR(e){return Boolean(e?.[vR])}class kR{constructor(e){if(pR.set(this,void 0),fR.set(this,void 0),yR.set(this,void 0),this[gR]=!0,null==e&&(e=""),e instanceof Uint8Array)this.bytes=cR(e);else if("string"==typeof e){if(e.length>0&&"/"!==e.charAt(0))throw new Error(`multiaddr "${e}" must start with a "/"`);this.bytes=aR(e)}else{if(!SR(e))throw new Error("addr must be a string, Buffer, or another Multiaddr");this.bytes=cR(e.bytes)}}toString(){return null==mR(this,pR,"f")&&wR(this,pR,iR(this.bytes),"f"),mR(this,pR,"f")}toJSON(){return this.toString()}toOptions(){let e,t,n,s,r="";const o=Kk("tcp"),i=Kk("udp"),a=Kk("ip4"),c=Kk("ip6"),l=Kk("dns6"),d=Kk("ip6zone");for(const[u,h]of this.stringTuples())u===d.code&&(r=`%${h??""}`),_R.includes(u)&&(t=o.name,s=443,n=`${h??""}${r}`,e=u===l.code?6:4),u!==o.code&&u!==i.code||(t=Kk(u).name,s=parseInt(h??"")),u!==a.code&&u!==c.code||(t=Kk(u).name,n=`${h??""}${r}`,e=u===c.code?6:4);if(null==e||null==t||null==n||null==s)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:s}}protos(){return this.protoCodes().map((e=>Object.assign({},Kk(e))))}protoCodes(){const e=[],t=this.bytes;let n=0;for(;n<t.length;){const s=zs.decode(t,n),r=zs.decode.bytes??0;n+=rR(Kk(s),t.slice(n+r))+r,e.push(s)}return e}protoNames(){return this.protos().map((e=>e.name))}tuples(){return null==mR(this,fR,"f")&&wR(this,fR,oR(this.bytes),"f"),mR(this,fR,"f")}stringTuples(){return null==mR(this,yR,"f")&&wR(this,yR,nR(this.tuples()),"f"),mR(this,yR,"f")}encapsulate(e){return e=new kR(e),new kR(this.toString()+e.toString())}decapsulate(e){const t=e.toString(),n=this.toString(),s=n.lastIndexOf(t);if(s<0)throw new Error(`Address ${this.toString()} does not contain subaddress: ${e.toString()}`);return new kR(n.slice(0,s))}decapsulateCode(e){const t=this.tuples();for(let n=t.length-1;n>=0;n--)if(t[n][0]===e)return new kR(sR(t.slice(0,n)));return this}getPeerId(){try{const e=this.stringTuples().filter((e=>e[0]===$k.ipfs.code)),t=e.pop();if(null!=t?.[1]){const e=t[1];return"Q"===e[0]||"1"===e[0]?(0,$.d)(z.base58btc.decode(`z${e}`),"base58btc"):(0,$.d)(J.TO.parse(e).multihash.bytes,"base58btc")}return null}catch(e){return null}}getPath(){let e=null;try{e=this.stringTuples().filter((e=>!0===Kk(e[0]).path))[0][1],null==e&&(e=null)}catch{e=null}return e}equals(e){return(0,ve.a)(this.bytes,e.bytes)}async resolve(e){const t=this.protos().find((e=>e.resolvable));if(null==t)return[this];const n=ER.get(t.name);if(null==n)throw c(new Error(`no available resolver for ${t.name}`),"ERR_NO_AVAILABLE_RESOLVER");return(await n(this,e)).map((e=>new kR(e)))}nodeAddress(){const e=this.toOptions();if("tcp"!==e.transport&&"udp"!==e.transport)throw new Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(e){const t=(e??this).protos();return 2===t.length&&((4===t[0].code||41===t[0].code)&&(6===t[1].code||273===t[1].code))}[(pR=new WeakMap,fR=new WeakMap,yR=new WeakMap,gR=vR,bR)](){return`Multiaddr(${iR(this.bytes)})`}}function RR(e){return new kR(e)}const TR=QR("dns4"),IR=QR("dns6"),PR=QR("dnsaddr"),AR=XR(QR("dns"),PR,TR,IR),DR=XR(QR("ip4"),QR("ip6")),OR=XR(YR(DR,QR("tcp")),YR(AR,QR("tcp"))),NR=YR(DR,QR("udp")),LR=YR(NR,QR("utp")),MR=YR(NR,QR("quic")),CR=XR(YR(OR,QR("ws")),YR(AR,QR("ws"))),xR=XR(YR(OR,QR("wss")),YR(AR,QR("wss")),YR(OR,QR("tls"),QR("ws")),YR(AR,QR("tls"),QR("ws"))),BR=XR(YR(OR,QR("http")),YR(DR,QR("http")),YR(AR,QR("http"))),zR=XR(YR(OR,QR("https")),YR(DR,QR("https")),YR(AR,QR("https"))),UR=YR(NR,QR("webrtc-direct"),QR("certhash")),FR=XR(YR(UR,QR("p2p")),UR),jR=XR(YR(CR,QR("p2p-webrtc-star"),QR("p2p")),YR(xR,QR("p2p-webrtc-star"),QR("p2p")),YR(CR,QR("p2p-webrtc-star")),YR(xR,QR("p2p-webrtc-star"))),HR=(XR(YR(CR,QR("p2p-websocket-star"),QR("p2p")),YR(xR,QR("p2p-websocket-star"),QR("p2p")),YR(CR,QR("p2p-websocket-star")),YR(xR,QR("p2p-websocket-star"))),XR(YR(BR,QR("p2p-webrtc-direct"),QR("p2p")),YR(zR,QR("p2p-webrtc-direct"),QR("p2p")),YR(BR,QR("p2p-webrtc-direct")),YR(zR,QR("p2p-webrtc-direct")))),$R=XR(CR,xR,BR,zR,jR,HR,OR,LR,MR,AR,FR),VR=(XR(YR($R,QR("p2p-stardust"),QR("p2p")),YR($R,QR("p2p-stardust"))),XR(YR($R,QR("p2p")),jR,HR,FR,QR("p2p"))),KR=XR(YR(VR,QR("p2p-circuit"),VR),YR(VR,QR("p2p-circuit")),YR(QR("p2p-circuit"),VR),YR($R,QR("p2p-circuit")),YR(QR("p2p-circuit"),$R),QR("p2p-circuit")),qR=()=>XR(YR(KR,qR),KR),GR=qR();XR(YR(GR,VR,GR),YR(VR,GR),YR(GR,VR),GR,VR),XR(YR(GR,QR("webrtc")),YR($R,QR("webrtc")),QR("webrtc"));function WR(e){return function(t){let n;try{n=RR(t)}catch(e){return!1}const s=e(n.protoNames());return null!==s&&(!0===s||!1===s?s:0===s.length)}}function YR(...e){function t(t){if(t.length<e.length)return null;let n=t;return e.some((e=>(n="function"==typeof e?e().partialMatch(t):e.partialMatch(t),Array.isArray(n)&&(t=n),null===n))),n}return{toString:function(){return"{ "+e.join(" ")+" }"},input:e,matches:WR(t),partialMatch:t}}function XR(...e){function t(t){let n=null;return e.some((e=>{const s="function"==typeof e?e().partialMatch(t):e.partialMatch(t);return null!=s&&(n=s,!0)})),n}return{toString:function(){return"{ "+e.join(" ")+" }"},input:e,matches:WR(t),partialMatch:t}}function QR(e){const t=e;return{toString:function(){return t},matches:function(e){let n;try{n=RR(e)}catch(e){return!1}const s=n.protoNames();return 1===s.length&&s[0]===t},partialMatch:function(e){return 0===e.length?null:e[0]===t?e.slice(1):null}}}const JR=(0,a.vF)("libp2p:websockets");class ZR{constructor(e){this.init=e}get[Symbol.toStringTag](){return"@libp2p/websockets"}get[bb.HR](){return!0}async dial(e,t){JR("dialing %s",e),t=t??{};const n=Bk(await this._connect(e,t),e);JR("new outbound connection %s",n.remoteAddr);const s=await t.upgrader.upgradeOutbound(n);return JR("outbound connection %s upgraded",n.remoteAddr),s}async _connect(e,t){if(!0===t?.signal?.aborted)throw new mp.l;const n=e.toOptions();JR("dialing %s:%s",n.host,n.port);const s=(0,hb.A)(),r=e=>{JR.error("connection error:",e),s.reject(e)},o=Ok((0,fc._)(e),this.init);if(null!=o.socket.on?o.socket.on("error",r):o.socket.onerror=r,null==t.signal)return await Promise.race([o.connected(),s.promise]),JR("connected %s",e),o;let i;const a=new Promise(((e,n)=>{i=()=>{n(new mp.l),o.close().catch((e=>{JR.error("error closing raw socket",e)}))},!0!==t?.signal?.aborted?t?.signal?.addEventListener("abort",i):i()}));try{await Promise.race([a,s.promise,o.connected()])}finally{null!=i&&t?.signal?.removeEventListener("abort",i)}return JR("connected %s",e),o}createListener(e){return function(){throw new Error("WebSocket Servers can not be created in the browser!")}(this.init)}filter(e){return e=Array.isArray(e)?e:[e],null!=this.init?.filter?this.init?.filter(e):O_.Bd||O_.p7?function(e){return e.filter((e=>{if(e.protoCodes().includes(290))return!1;const t=e.decapsulateCode(421);return xR.matches(t)}))}(e):function(e){return e.filter((e=>{if(e.protoCodes().includes(290))return!1;const t=e.decapsulateCode(421);return CR.matches(t)||xR.matches(t)}))}(e)}}var eT=n(81849);const tT=Math.pow(2,7),nT=Math.pow(2,14),sT=Math.pow(2,21),rT=Math.pow(2,28),oT=Math.pow(2,35),iT=Math.pow(2,42),aT=Math.pow(2,49),cT=Math.pow(2,56),lT=Math.pow(2,63),dT={encodingLength:e=>e<tT?1:e<nT?2:e<sT?3:e<rT?4:e<oT?5:e<iT?6:e<aT?7:e<cT?8:e<lT?9:10,encode(e,t,n=0){if(null!=Number.MAX_SAFE_INTEGER&&e>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return null==t&&(t=(0,Wp.K)(dT.encodingLength(e))),Gp.R.fromNumber(e).toBytes(t,n),t},decode:(e,t=0)=>Gp.R.fromBytes(e,t).toNumber(!0)};const uT=e=>{const t=dT.encodingLength(e),n=(s=t,null!=globalThis?.Buffer?.allocUnsafe?globalThis.Buffer.allocUnsafe(s):new Uint8Array(s));var s;return dT.encode(e,n),uT.bytes=t,n};function hT(e){const t=(e=e??{}).lengthEncoder??uT;return async function*(e){for await(const n of e){const e=t(n.byteLength);e instanceof Uint8Array?yield e:yield*e,n instanceof Uint8Array?yield n:yield*n}}}uT.bytes=0,hT.single=(e,t)=>{const n=(t=t??{}).lengthEncoder??uT;return new zo.I(n(e.byteLength),e)};const pT=8,fT=4194304;var yT;!function(e){e[e.LENGTH=0]="LENGTH",e[e.DATA=1]="DATA"}(yT||(yT={}));const gT=e=>{const t=dT.decode(e);return gT.bytes=dT.encodingLength(t),t};function mT(e){return async function*(t){const n=new zo.I;let s=yT.LENGTH,r=-1;const o=e?.lengthDecoder??gT,i=e?.maxLengthLength??pT,a=e?.maxDataLength??fT;for await(const l of t)for(n.append(l);n.byteLength>0;){if(s===yT.LENGTH)try{if(r=o(n),r<0)throw c(new Error("invalid message length"),"ERR_INVALID_MSG_LENGTH");if(r>a)throw c(new Error("message length too long"),"ERR_MSG_DATA_TOO_LONG");const t=o.bytes;n.consume(t),null!=e?.onLength&&e.onLength(r),s=yT.DATA}catch(e){if(e instanceof RangeError){if(n.byteLength>i)throw c(new Error("message length length too long"),"ERR_MSG_LENGTH_TOO_LONG");break}throw e}if(s===yT.DATA){if(n.byteLength<r)break;const t=n.sublist(0,r);n.consume(r),null!=e?.onData&&e.onData(t),yield t,s=yT.LENGTH}}if(n.byteLength>0)throw c(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}}function wT(e,t={}){const n=pb(e),s=mT.fromReader(n.reader,t),r={read:async e=>{const{value:t}=await n.reader.next(e);if(null==t)throw new Error("Value is null");return t},readLP:async()=>{const{value:e}=await s.next();if(null==e)throw new Error("Value is null");return e},readPB:async e=>{const t=await r.readLP();if(null==t)throw new Error("Value is null");const n=t instanceof Uint8Array?t:t.subarray();return e.decode(n)},write:e=>{e instanceof Uint8Array?n.writer.push(e):n.writer.push(e.subarray())},writeLP:e=>{r.write(hT.single(e,t))},writePB:(e,t)=>{r.writeLP(t.encode(e))},pb:e=>({read:async()=>await r.readPB(e),write:t=>{r.writePB(t,e)},unwrap:()=>r}),unwrap:()=>(n.rest(),e.source=n.stream.source,e.sink=n.stream.sink,e)};return r}function bT(){const e=(0,hb.A)();let t=!1;return{sink:async n=>{if(t)throw new Error("already piped");t=!0,e.resolve(n)},source:async function*(){const t=await e.promise;yield*t}()}}gT.bytes=0,mT.fromReader=(e,t)=>{let n=1;const s=async function*(){for(;;)try{const{done:t,value:s}=await e.next(n);if(!0===t)return;null!=s&&(yield s)}catch(e){if("ERR_UNDER_READ"===e.code)return{done:!0,value:null};throw e}finally{n=1}}();return mT({...t??{},onLength:e=>{n=e}})(s)};const _T=65535,ET=Boolean(globalThis.process?.env?.DUMP_SESSION_KEYS);var vT=n(94423),ST=n(774),kT=n(50204),RT=n(51612);const TT={hashSHA256:e=>(0,kT.tW)(e),getHKDF(e,t){const n=new vT.i(kT.aD,t,e).expand(96);return[n.subarray(0,32),n.subarray(32,64),n.subarray(64,96)]},generateX25519KeyPair(){const e=ST.TZ();return{publicKey:e.publicKey,privateKey:e.secretKey}},generateX25519KeyPairFromSeed(e){const t=ST.K(e);return{publicKey:t.publicKey,privateKey:t.secretKey}},generateX25519SharedKey:(e,t)=>ST.Tc(e,t),chaCha20Poly1305Encrypt:(e,t,n,s)=>new RT.g6(s).seal(t,e,n),chaCha20Poly1305Decrypt:(e,t,n,s,r)=>new RT.g6(s).open(t,e,n,r)},IT=e=>{const t=(n=2,globalThis.Buffer?globalThis.Buffer.allocUnsafe(n):new Uint8Array(n));var n;return new DataView(t.buffer,t.byteOffset,t.byteLength).setUint16(0,e,!1),t};IT.bytes=2;const PT=e=>{if(e.length<2)throw RangeError("Could not decode int16BE");return e instanceof Uint8Array?new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0,!1):e.getUint16(0)};PT.bytes=2;var AT=n(99588);an._configure(),nn._configure(sn),rn._configure(on);const DT=["uint64","int64","sint64","fixed64","sfixed64"];function OT(e){return function(e){for(const t of DT){if(null==e[t])continue;const n=e[t];e[t]=function(){return BigInt(n.call(this).toString())}}return e}(new nn(e))}function NT(){return function(e){for(const t of DT){if(null==e[t])continue;const n=e[t];e[t]=function(e){return n.call(this,e.toString())}}return e}(rn.create())}function LT(e,t){const n=OT(e instanceof Uint8Array?e:e.subarray());return t.decode(n)}function MT(e,t){const n=NT();return t.encode(e,n,{lengthDelimited:!1}),n.finish()}var CT,xT,BT;function zT(e,t){return function(e,t,n,s){return{name:e,type:t,encode:n,decode:s}}("message",CT.LENGTH_DELIMITED,e,t)}async function UT(e,t,n){const s=await async function(e,t){if(null==e.privateKey)throw new Error("PrivateKey was missing from PeerId");const n=await(0,Jt.unmarshalPrivateKey)(e.privateKey);return await n.sign(t)}(e,HT(t));if(null==e.publicKey)throw new Error("PublicKey was missing from local PeerId");return function(e,t,n){return BT.encode({identityKey:e,identitySig:t,extensions:n??{webtransportCerthashes:[]}}).subarray()}(e.publicKey,s,n)}async function FT(e){return await(0,Ht.AX)(e.identityKey)}function jT(e){return BT.decode(e)}function HT(e){const t=(0,x.s)("noise-libp2p-static-key:");return(0,ee.x)([t,e],t.length+e.length)}async function $T(e,t,n){const s=await(0,Ht.AX)(t.identityKey);if(!s.equals(n))throw new Error(`Payload identity key ${s.toString()} does not match expected remote peer ${n.toString()}`);const r=HT(e);if(null==s.publicKey)throw new Error("PublicKey was missing from PeerId");if(null==t.identitySig)throw new Error("Signature was missing from message");const o=(0,Jt.unmarshalPublicKey)(s.publicKey);if(!await o.verify(r,t.identitySig))throw new Error("Static key doesn't match to peer that signed payload!");return s}function VT(e){return e instanceof Uint8Array&&32===e.length}!function(e){e[e.VARINT=0]="VARINT",e[e.BIT64=1]="BIT64",e[e.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",e[e.START_GROUP=3]="START_GROUP",e[e.END_GROUP=4]="END_GROUP",e[e.BIT32=5]="BIT32"}(CT||(CT={})),function(e){let t;e.codec=()=>(null==t&&(t=zT(((e,t,n={})=>{if(!1!==n.lengthDelimited&&t.fork(),null!=e.webtransportCerthashes)for(const n of e.webtransportCerthashes)t.uint32(10),t.bytes(n);!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={webtransportCerthashes:[]},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();if(t>>>3==1)n.webtransportCerthashes.push(e.bytes());else e.skipType(7&t)}return n}))),t),e.encode=t=>MT(t,e.codec()),e.decode=t=>LT(t,e.codec())}(xT||(xT={})),function(e){let t;e.codec=()=>(null==t&&(t=zT(((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),(!0===n.writeDefaults||null!=e.identityKey&&e.identityKey.byteLength>0)&&(t.uint32(10),t.bytes(e.identityKey??new Uint8Array(0))),(!0===n.writeDefaults||null!=e.identitySig&&e.identitySig.byteLength>0)&&(t.uint32(18),t.bytes(e.identitySig??new Uint8Array(0))),null!=e.extensions&&(t.uint32(34),xT.codec().encode(e.extensions,t,{writeDefaults:!1})),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={identityKey:new Uint8Array(0),identitySig:new Uint8Array(0)},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();switch(t>>>3){case 1:n.identityKey=e.bytes();break;case 2:n.identitySig=e.bytes();break;case 4:n.extensions=xT.codec().decode(e,e.uint32());break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>MT(t,e.codec()),e.decode=t=>LT(t,e.codec())}(BT||(BT={}));const KT=(0,a.vF)("libp2p:noise");let qT;function GT(e){e?(qT(`LOCAL_PUBLIC_EPHEMERAL_KEY ${(0,$.d)(e.publicKey,"hex")}`),qT(`LOCAL_PRIVATE_EPHEMERAL_KEY ${(0,$.d)(e.privateKey,"hex")}`)):qT("Missing local ephemeral keys.")}function WT(e){qT(`REMOTE_EPHEMERAL_PUBLIC_KEY ${(0,$.d)(e,"hex")}`)}qT=ET?KT:Object.assign((()=>{}),{enabled:!1,trace:()=>{},error:()=>{}});class YT{constructor(e=0){this.n=e,this.bytes=new Uint8Array(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,e,!0)}increment(){this.n++,this.view.setUint32(4,this.n,!0)}getBytes(){return this.bytes}getUint64(){return this.n}assertValue(){if(this.n>4294967295)throw new Error("Cipherstate has reached maximum n, a new handshake must be performed")}}class XT{constructor(e){this.crypto=e}encryptWithAd(e,t,n){const s=this.encrypt(e.k,e.n,t,n);return e.n.increment(),s}decryptWithAd(e,t,n,s){const{plaintext:r,valid:o}=this.decrypt(e.k,e.n,t,n,s);return o&&e.n.increment(),{plaintext:r,valid:o}}hasKey(e){return!this.isEmptyKey(e.k)}createEmptyKey(){return new Uint8Array(32)}isEmptyKey(e){const t=this.createEmptyKey();return(0,ve.a)(t,e)}encrypt(e,t,n,s){return t.assertValue(),this.crypto.chaCha20Poly1305Encrypt(s,t.getBytes(),n,e)}encryptAndHash(e,t){let n;return n=this.hasKey(e.cs)?this.encryptWithAd(e.cs,e.h,t):t,this.mixHash(e,n),n}decrypt(e,t,n,s,r){t.assertValue();const o=this.crypto.chaCha20Poly1305Decrypt(s,t.getBytes(),n,e,r);return o?{plaintext:o,valid:!0}:{plaintext:new Uint8Array(0),valid:!1}}decryptAndHash(e,t){let n,s=!0;return this.hasKey(e.cs)?({plaintext:n,valid:s}=this.decryptWithAd(e.cs,e.h,t)):n=t,this.mixHash(e,t),{plaintext:n,valid:s}}dh(e,t){try{const n=this.crypto.generateX25519SharedKey(e,t);return 32===n.length?n:n.subarray(0,32)}catch(e){return KT(e.message),new Uint8Array(32)}}mixHash(e,t){e.h=this.getHash(e.h,t)}getHash(e,t){return this.crypto.hashSHA256((0,ee.x)([e,t],e.length+t.length))}mixKey(e,t){const[n,s]=this.crypto.getHKDF(e.ck,t);e.cs=this.initializeKey(s),e.ck=n}initializeKey(e){return{k:e,n:new YT}}initializeSymmetric(e){const t=(0,Vv.sH)(e,"utf-8"),n=this.hashProtocolName(t),s=n,r=this.createEmptyKey();return{cs:this.initializeKey(r),ck:s,h:n}}hashProtocolName(e){if(e.length<=32){const t=new Uint8Array(32);return t.set(e),t}return this.getHash(e,new Uint8Array(0))}split(e){const[t,n]=this.crypto.getHKDF(e.ck,new Uint8Array(0));return{cs1:this.initializeKey(t),cs2:this.initializeKey(n)}}writeMessageRegular(e,t){const n=this.encryptWithAd(e,new Uint8Array(0),t);return{ne:this.createEmptyKey(),ns:new Uint8Array(0),ciphertext:n}}readMessageRegular(e,t){return this.decryptWithAd(e,new Uint8Array(0),t.ciphertext)}}class QT extends XT{initializeInitiator(e,t,n,s){const r=this.initializeSymmetric("Noise_XX_25519_ChaChaPoly_SHA256");this.mixHash(r,e);return{ss:r,s:t,rs:n,psk:s,re:new Uint8Array(32)}}initializeResponder(e,t,n,s){const r=this.initializeSymmetric("Noise_XX_25519_ChaChaPoly_SHA256");this.mixHash(r,e);return{ss:r,s:t,rs:n,psk:s,re:new Uint8Array(32)}}writeMessageA(e,t,n){const s=new Uint8Array(0);e.e=void 0!==n?n:this.crypto.generateX25519KeyPair();const r=e.e.publicKey;this.mixHash(e.ss,r);return{ne:r,ns:s,ciphertext:this.encryptAndHash(e.ss,t)}}writeMessageB(e,t){e.e=this.crypto.generateX25519KeyPair();const n=e.e.publicKey;this.mixHash(e.ss,n),this.mixKey(e.ss,this.dh(e.e.privateKey,e.re));const s=e.s.publicKey,r=this.encryptAndHash(e.ss,s);this.mixKey(e.ss,this.dh(e.s.privateKey,e.re));return{ne:n,ns:r,ciphertext:this.encryptAndHash(e.ss,t)}}writeMessageC(e,t){const n=e.s.publicKey,s=this.encryptAndHash(e.ss,n);this.mixKey(e.ss,this.dh(e.s.privateKey,e.re));const r=this.encryptAndHash(e.ss,t),o={ne:this.createEmptyKey(),ns:s,ciphertext:r},{cs1:i,cs2:a}=this.split(e.ss);return{h:e.ss.h,messageBuffer:o,cs1:i,cs2:a}}readMessageA(e,t){return VT(t.ne)&&(e.re=t.ne),this.mixHash(e.ss,e.re),this.decryptAndHash(e.ss,t.ciphertext)}readMessageB(e,t){if(VT(t.ne)&&(e.re=t.ne),this.mixHash(e.ss,e.re),!e.e)throw new Error("Handshake state `e` param is missing.");this.mixKey(e.ss,this.dh(e.e.privateKey,e.re));const{plaintext:n,valid:s}=this.decryptAndHash(e.ss,t.ns);s&&VT(n)&&(e.rs=n),this.mixKey(e.ss,this.dh(e.e.privateKey,e.rs));const{plaintext:r,valid:o}=this.decryptAndHash(e.ss,t.ciphertext);return{plaintext:r,valid:s&&o}}readMessageC(e,t){const{plaintext:n,valid:s}=this.decryptAndHash(e.ss,t.ns);if(s&&VT(n)&&(e.rs=n),!e.e)throw new Error("Handshake state `e` param is missing.");this.mixKey(e.ss,this.dh(e.e.privateKey,e.rs));const{plaintext:r,valid:o}=this.decryptAndHash(e.ss,t.ciphertext),{cs1:i,cs2:a}=this.split(e.ss);return{h:e.ss.h,plaintext:r,valid:s&&o,cs1:i,cs2:a}}initSession(e,t,n){const s=this.createEmptyKey(),r=new Uint8Array(32);let o;return o=e?this.initializeInitiator(t,n,r,s):this.initializeResponder(t,n,r,s),{hs:o,i:e,mc:0}}sendMessage(e,t,n){let s;if(0===e.mc)s=this.writeMessageA(e.hs,t,n);else if(1===e.mc)s=this.writeMessageB(e.hs,t);else if(2===e.mc){const{h:n,messageBuffer:r,cs1:o,cs2:i}=this.writeMessageC(e.hs,t);s=r,e.h=n,e.cs1=o,e.cs2=i}else{if(!(e.mc>2))throw new Error("Session invalid.");if(e.i){if(!e.cs1)throw new Error("CS1 (cipher state) is not defined");s=this.writeMessageRegular(e.cs1,t)}else{if(!e.cs2)throw new Error("CS2 (cipher state) is not defined");s=this.writeMessageRegular(e.cs2,t)}}return e.mc++,s}recvMessage(e,t){let n=new Uint8Array(0),s=!1;if(0===e.mc)({plaintext:n,valid:s}=this.readMessageA(e.hs,t));else if(1===e.mc)({plaintext:n,valid:s}=this.readMessageB(e.hs,t));else if(2===e.mc){const{h:r,plaintext:o,valid:i,cs1:a,cs2:c}=this.readMessageC(e.hs,t);n=o,s=i,e.h=r,e.cs1=a,e.cs2=c}return e.mc++,{plaintext:n,valid:s}}}class JT{constructor(e,t,n,s,r,o,i,a){this.remoteExtensions={webtransportCerthashes:[]},this.isInitiator=e,this.payload=t,this.prologue=n,this.staticKeypair=r,this.connection=o,i&&(this.remotePeer=i),this.xx=a??new QT(s),this.session=this.xx.initSession(this.isInitiator,this.prologue,this.staticKeypair)}async propose(){var e;if(e=this.session.hs.s,qT(`LOCAL_STATIC_PUBLIC_KEY ${(0,$.d)(e.publicKey,"hex")}`),qT(`LOCAL_STATIC_PRIVATE_KEY ${(0,$.d)(e.privateKey,"hex")}`),this.isInitiator){KT("Stage 0 - Initiator starting to send first message.");const e=this.xx.sendMessage(this.session,new Uint8Array(0));this.connection.writeLP(function(e){return(0,ee.x)([e.ne,e.ciphertext],e.ne.length+e.ciphertext.length)}(e)),KT("Stage 0 - Initiator finished sending first message."),GT(this.session.hs.e)}else{KT("Stage 0 - Responder waiting to receive first message...");const e=function(e){if(e.length<32)throw new Error("Cannot decode stage 0 MessageBuffer: length less than 32 bytes.");return{ne:e.subarray(0,32),ciphertext:e.subarray(32,e.length),ns:new Uint8Array(0)}}((await this.connection.readLP()).subarray()),{valid:t}=this.xx.recvMessage(this.session,e);if(!t)throw new AT.c6("xx handshake stage 0 validation fail");KT("Stage 0 - Responder received first message."),WT(this.session.hs.re)}}async exchange(){if(this.isInitiator){KT("Stage 1 - Initiator waiting to receive first message from responder...");const t=function(e){if(e.length<80)throw new Error("Cannot decode stage 1 MessageBuffer: length less than 80 bytes.");return{ne:e.subarray(0,32),ns:e.subarray(32,80),ciphertext:e.subarray(80,e.length)}}((await this.connection.readLP()).subarray()),{plaintext:n,valid:s}=this.xx.recvMessage(this.session,t);if(!s)throw new AT.c6("xx handshake stage 1 validation fail");KT("Stage 1 - Initiator received the message."),WT(this.session.hs.re),e=this.session.hs.rs,qT(`REMOTE_STATIC_PUBLIC_KEY ${(0,$.d)(e,"hex")}`),KT("Initiator going to check remote's signature...");try{const e=jT(n);this.remotePeer=this.remotePeer||await FT(e),await $T(this.session.hs.rs,e,this.remotePeer),this.setRemoteNoiseExtension(e.extensions)}catch(e){const t=e;throw new AT.aS(`Error occurred while verifying signed payload: ${t.message}`)}KT("All good with the signature!")}else{KT("Stage 1 - Responder sending out first message with signed payload and static key.");const e=this.xx.sendMessage(this.session,this.payload);this.connection.writeLP(function(e){return(0,ee.x)([e.ne,e.ns,e.ciphertext],e.ne.length+e.ns.length+e.ciphertext.length)}(e)),KT("Stage 1 - Responder sent the second handshake message with signed payload."),GT(this.session.hs.e)}var e}async finish(){if(this.isInitiator){KT("Stage 2 - Initiator sending third handshake message.");const e=this.xx.sendMessage(this.session,this.payload);this.connection.writeLP(function(e){return(0,ee.x)([e.ns,e.ciphertext],e.ns.length+e.ciphertext.length)}(e)),KT("Stage 2 - Initiator sent message with signed payload.")}else{KT("Stage 2 - Responder waiting for third handshake message...");const e=function(e){if(e.length<48)throw new Error("Cannot decode stage 2 MessageBuffer: length less than 48 bytes.");return{ne:new Uint8Array(0),ns:e.subarray(0,48),ciphertext:e.subarray(48,e.length)}}((await this.connection.readLP()).subarray()),{plaintext:t,valid:n}=this.xx.recvMessage(this.session,e);if(!n)throw new AT.c6("xx handshake stage 2 validation fail");KT("Stage 2 - Responder received the message, finished handshake.");try{const e=jT(t);this.remotePeer=this.remotePeer||await FT(e),await $T(this.session.hs.rs,e,this.remotePeer),this.setRemoteNoiseExtension(e.extensions)}catch(e){const t=e;throw new AT.aS(`Error occurred while verifying signed payload: ${t.message}`)}}var e;(e=this.session).cs1&&e.cs2?(qT(`CIPHER_STATE_1 ${e.cs1.n.getUint64()} ${(0,$.d)(e.cs1.k,"hex")}`),qT(`CIPHER_STATE_2 ${e.cs2.n.getUint64()} ${(0,$.d)(e.cs2.k,"hex")}`)):qT("Missing cipher state.")}encrypt(e,t){const n=this.getCS(t);return this.xx.encryptWithAd(n,new Uint8Array(0),e)}decrypt(e,t,n){const s=this.getCS(t,!1);return this.xx.decryptWithAd(s,new Uint8Array(0),e,n)}getRemoteStaticKey(){return this.session.hs.rs}getCS(e,t=!0){if(!e.cs1||!e.cs2)throw new AT.c6("Handshake not completed properly, cipher state does not exist.");return this.isInitiator?t?e.cs1:e.cs2:t?e.cs2:e.cs1}setRemoteNoiseExtension(e){e&&(this.remoteExtensions=e)}}class ZT{constructor(e={}){this.protocol="/noise";const{staticNoiseKey:t,extensions:n,crypto:s,prologueBytes:r,metrics:o}=e;this.crypto=s??TT,this.extensions=n,this.metrics=o?function(e){return{xxHandshakeSuccesses:e.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:e.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:e.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:e.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:e.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}(o):void 0,this.staticKeys=t?this.crypto.generateX25519KeyPairFromSeed(t):this.crypto.generateX25519KeyPair(),this.prologue=r??new Uint8Array(0)}async secureOutbound(e,t,n){const s=wT(t,{lengthEncoder:IT,lengthDecoder:PT,maxDataLength:_T}),r=await this.performHandshake({connection:s,isInitiator:!0,localPeer:e,remotePeer:n});return{conn:await this.createSecureConnection(s,r),remoteExtensions:r.remoteExtensions,remotePeer:r.remotePeer}}async secureInbound(e,t,n){const s=wT(t,{lengthEncoder:IT,lengthDecoder:PT,maxDataLength:_T}),r=await this.performHandshake({connection:s,isInitiator:!1,localPeer:e,remotePeer:n});return{conn:await this.createSecureConnection(s,r),remotePeer:r.remotePeer,remoteExtensions:r.remoteExtensions}}async performHandshake(e){const t=await UT(e.localPeer,this.staticKeys.publicKey,this.extensions);return await this.performXXHandshake(e,t)}async performXXHandshake(e,t){const{isInitiator:n,remotePeer:s,connection:r}=e,o=new JT(n,t,this.prologue,this.crypto,this.staticKeys,r,s);try{await o.propose(),await o.exchange(),await o.finish(),this.metrics?.xxHandshakeSuccesses.increment()}catch(e){if(this.metrics?.xxHandshakeErrors.increment(),e instanceof Error)throw e.message=`Error occurred during XX handshake: ${e.message}`,e}return o}async createSecureConnection(e,t){const[n,s]=function(){const e=bT(),t=bT();return[{source:e.source,sink:t.sink},{source:t.source,sink:e.sink}]}(),r=e.unwrap();return await no(n,function(e,t){return async function*(n){for await(const s of n)for(let n=0;n<s.length;n+=65519){let r=n+65519;r>s.length&&(r=s.length);const o=e.encrypt(s.subarray(n,r),e.session);t?.encryptedPackets.increment(),yield IT(o.byteLength),yield o}}}(t,this.metrics),r,ub({lengthDecoder:PT}),function(e,t){return async function*(n){for await(const s of n)for(let n=0;n<s.length;n+=_T){let r=n+_T;if(r>s.length&&(r=s.length),r-RT.iW<n)throw new Error("Invalid chunk");const o=s.subarray(n,r),i=s.subarray(n,r-RT.iW),{plaintext:a,valid:c}=e.decrypt(o,e.session,i);if(!c)throw t?.decryptErrors.increment(),new Error("Failed to validate decrypted chunk");t?.decryptedPackets.increment(),yield a}}}(t,this.metrics),n),s}}function eI(e={}){return()=>new ZT(e)}const tI=o.A.bind({ignoreUndefined:!0,concatArrays:!0});function nI({options:e={},peerId:t,multiaddrs:n=[],repo:s,keychainConfig:r={},config:o={}}){const{datastore:i}=s,a=function({options:e,config:t,datastore:n,keychainConfig:s,peerId:r,multiaddrs:o}){const i=()=>{const e=Jn(t,"Pubsub.Router")||"gossipsub",n=Af();if(!n[e])throw c(new Error(`Router unavailable. Configure libp2p.modules.pubsub to use the ${e} router.`),"ERR_NOT_SUPPORTED");return n[e]},a={datastore:n,peerId:r},l={addresses:{listen:o.map((e=>e.toString())),announce:Jn(e,"addresses.announce",Jn(t,"Addresses.Announce",[])),noAnnounce:Jn(e,"addresses.noAnnounce",Jn(t,"Addresses.NoAnnounce",[]))},connectionManager:Jn(e,"connectionManager",{maxConnections:Jn(e,"config.Swarm.ConnMgr.HighWater",Jn(t,"Swarm.ConnMgr.HighWater")),minConnections:Jn(e,"config.Swarm.ConnMgr.LowWater",Jn(t,"Swarm.ConnMgr.LowWater"))}),keychain:s,identify:{host:{agentVersion:`js-ipfs/${Sa}`}},contentRouters:[],peerRouters:[],peerDiscovery:[],transports:[],streamMuxers:[(0,eT.t)({maxInboundStreams:256,maxOutboundStreams:1024})],connectionEncryption:[eI()],relay:{enabled:Jn(e,"relay.enabled",Jn(t,"relay.enabled",!0)),hop:{enabled:Jn(e,"relay.hop.enabled",Jn(t,"relay.hop.enabled",!1)),active:Jn(e,"relay.hop.active",Jn(t,"relay.hop.active",!1))}},nat:{enabled:!Jn(t,"Swarm.DisableNatPortMap",!1)}};Jn(e,"config.Pubsub.Enabled",Jn(t,"Pubsub.Enabled",!0))&&(l.pubsub=i());"none"!==Jn(t,"Routing.Type","dhtclient")&&(l.dht=(d={clientMode:"dhtserver"!==Jn(t,"Routing.Type","dht"),kBucketSize:Jn(e,"dht.kBucketSize",20),validators:{ipns:xn},selectors:{ipns:Zn}},e=>new iS(e,d)));var d;const u=Jn(e,"config.Bootstrap",Jn(t,"Bootstrap",[]));u.length>0&&l.peerDiscovery?.push(function(e){return t=>new Sk(t,e)}({list:u}));let h=Jn(e,"libp2p",void 0);"function"==typeof h&&(h=void 0);const p=tI(a,function(){const e=(0,ew.a)();return{transports:[e.transport],peerDiscovery:[e.discovery],connectionManager:{maxParallelDials:150,maxDialsPerPeer:4,dialTimeout:1e4,autoDial:!0},nat:{enabled:!1}}}(),l,h),f=Jn(e,"config.Addresses.Delegates",Jn(t,"Addresses.Delegates",[]));if(f.length>0){const e=f[Math.floor(Math.random()*f.length)],t=(0,j.HZ)(e).toOptions(),n=function(e={}){const t={name:I.identity.name,code:I.identity.code,encode:e=>e,decode:e=>e},n=Object.values(P.Fo);(e.ipld&&e.ipld.bases?e.ipld.bases:[]).forEach((e=>n.push(e)));const s=new Nf.g({bases:n,loadBase:e.ipld&&e.ipld.loadBase}),r=Object.values(P.qr);[S,k,R,T,t].concat(e.ipld&&e.ipld.codecs||[]).forEach((e=>r.push(e)));const o=new Lf.l({codecs:r,loadCodec:e.ipld&&e.ipld.loadCodec}),i=Object.values(P.RY);(e.ipld&&e.ipld.hashers?e.ipld.hashers:[]).forEach((e=>i.push(e)));const a=new Mf.i({hashers:i,loadHasher:e.ipld&&e.ipld.loadHasher});return{add:zm(e),addAll:Mm(e),bitswap:ey(e),block:cy(e),bootstrap:fy(e),cat:Um(e),commands:Fm(e),config:ky(e),dag:Oy(o,e),dht:Uy(e),diag:$y(e),dns:jm(e),files:rg(e),get:$m(e),getEndpointConfig:Hm(e),id:Vm(e),isOnline:Km(e),key:hg(e),log:gg(e),ls:qm(e),mount:Wm(e),name:Sg(e),object:Cg(o,e),pin:om(e),ping:Ym(e),pubsub:bm(e),refs:Em(e),repo:Rm(e),resolve:Xm(e),start:Qm(e),stats:Im(e),stop:Jm(e),swarm:Lm(e),version:Zm(e),bases:s,codecs:o,hashers:a}}({host:t.host,protocol:443===parseInt(t.port)?"https":"http",port:t.port});p.contentRouters?.push((0,Of.hh)(n)),p.peerRouters?.push((0,Df.CK)(n))}Jn(e,"config.Discovery.MDNS.Enabled",Jn(t,"Discovery.MDNS.Enabled",!0))||(p.peerDiscovery=p.peerDiscovery?.filter((e=>{try{if("function"==typeof e)return"@libp2p/mdns"!==e({})[Symbol.toStringTag]}catch{}return!0})));null==p.transports&&(p.transports=[]);null==p.transports.find((e=>{try{if("function"==typeof e)return"@libp2p/websockets"===e({})[Symbol.toStringTag]}catch{}return!1}))&&p.transports.push(function(e={}){return()=>new ZR(e)}());return p}({options:e,config:o,datastore:i,keychainConfig:r,peerId:t,multiaddrs:n});return"function"==typeof e.libp2p?e.libp2p({libp2pOptions:a,options:e,config:o,datastore:i,peerId:t}):(a.start=!1,async function(e){const t=await xE(e);return!1!==e.start&&await t.start(),t}(a))}const sI=o.A.bind({ignoreUndefined:!0}),rI=(0,a.vF)("ipfs:components:peer:storage");class oI{constructor(e,t,n,s,r){this.print=s,this.peerId=e,this.keychain=t,this.repo=n,this.print=s,this.isNew=r}static async start(e,t,n){const{repoAutoMigrate:s,repo:r,onMigrationProgress:o}=n,i="string"==typeof r||null==r?qh(e,t,{path:r,autoMigrate:s,onMigrationProgress:o}):r,{peerId:a,keychain:c,isNew:l}=await iI(e,i,n);return new oI(a,c,i,e,l)}}const iI=async(e,t,n)=>{if(!t.closed)return{...await uI(t,n),isNew:!1};try{return await t.open(),{...await uI(t,n),isNew:!1}}catch(s){if(s.code!==sh)throw s;if(n.init&&!1===n.init.allowNew)throw new C("Initialization of new repos disabled by config, pass `config.init.isNew: true` to enable it");return{...await aI(e,t,n),isNew:!0}}},aI=async(e,t,n)=>{const s=n.init||{},r=await t.exists();if(rI("repo exists?",r),!0===r)throw new Error("repo already exists");const o=s.privateKey?await cI(s.privateKey):await lI(e,s),i=dI(o);rI("peer identity: %s",i.PeerID);const a={...sI(pI(Gr(),s.profiles),n.config),Identity:i};await t.init(a),await t.open(),rI("repo opened");const c={pass:n.pass};try{c.dek=await t.config.get("Keychain.DEK")}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}const l=await nI({options:void 0,multiaddrs:void 0,peerId:o,repo:t,config:a,keychainConfig:c});return await t.datastore.has(new bt.U("/info/self"))||await l.keychain.importPeer("self",o),await t.config.set("Keychain",{DEK:l.keychain.init.dek}),{peerId:o,keychain:l.keychain}},cI=async e=>{if(rI("using user-supplied private-key"),(0,Yt.Q)(e))return e;const t=(0,x.s)(e,"base64pad"),n=await(0,Jt.unmarshalPrivateKey)(t);return await(0,Ht.AX)(n.public.bytes,n.bytes)},lI=(e,{algorithm:t="Ed25519",bits:n=2048})=>{if(e("generating %s keypair...",t),"Ed25519"===t)return(0,SE.jq)();if("RSA"===t)return(0,SE.S_)({bits:n});throw c(new Error("Unknown PeerId algorithm"),"ERR_UNKNOWN_PEER_ID_ALGORITHM")},dI=e=>{if(null==e.privateKey)throw c(new Error("Private key missing"),"ERR_MISSING_PRIVATE_KEY");return{PeerID:e.toString(),PrivKey:(0,$.d)(e.privateKey,"base64pad")}},uI=async(e,t)=>{const n=t.config,s=t.init&&t.init.profiles||[],r=t.pass,o=await e.config.getAll(),i=hI(pI(o,s),n);if(o!==i&&await e.config.replace(i),!i.Identity||!i.Identity.PrivKey)throw new A("No private key was found in the config, please intialize the repo");const a=(0,x.s)(i.Identity.PrivKey,"base64pad"),c=await(0,Jt.unmarshalPrivateKey)(a),l=await(0,Ht.AX)(c.public.bytes,c.bytes);return{peerId:l,keychain:(await nI({options:void 0,multiaddrs:void 0,peerId:l,repo:e,config:i,keychainConfig:{pass:r,...i.Keychain}})).keychain}},hI=(e,t)=>t?sI(e,t):e,pI=(e,t)=>(t||[]).reduce(((e,t)=>{const n=Pa[t];if(!n)throw new Error(`Could not find profile with name '${t}'`);return rI("applying profile %s",t),n.transform(e)}),e);var fI=n(46163);var yI=function(e){let t=new Uint8Array(e.reduce(((e,t)=>e+zs.encodingLength(t)),0)),n=0;for(const s of e)t=zs.encode(s,t,n),n+=zs.encodingLength(s);return t};class gI{constructor(e,t,n){this._refCounter=1,this.cid=e,this.priority=t||1,this.wantType=n}inc(){this._refCounter+=1}dec(){this._refCounter=Math.max(0,this._refCounter-1)}hasRefs(){return this._refCounter>0}get[Symbol.toStringTag](){return`WantlistEntry <key: ${this.cid.toString(z.base58btc)}, priority: ${this.priority}, refs: ${this._refCounter}>`}equals(e){return this._refCounter===e._refCounter&&this.cid.equals(e.cid)&&this.priority===e.priority&&this.wantType===e.wantType}}const mI=l.Reader,wI=l.Writer,bI=l.util,_I=l.roots["ipfs-bitswap"]||(l.roots["ipfs-bitswap"]={}),EI=_I.Message=(()=>{function e(e){if(this.blocks=[],this.payload=[],this.blockPresences=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.wantlist=null,e.prototype.blocks=bI.emptyArray,e.prototype.payload=bI.emptyArray,e.prototype.blockPresences=bI.emptyArray,e.prototype.pendingBytes=0,e.encode=function(e,t){if(t||(t=wI.create()),null!=e.wantlist&&Object.hasOwnProperty.call(e,"wantlist")&&_I.Message.Wantlist.encode(e.wantlist,t.uint32(10).fork()).ldelim(),null!=e.blocks&&e.blocks.length)for(var n=0;n<e.blocks.length;++n)t.uint32(18).bytes(e.blocks[n]);if(null!=e.payload&&e.payload.length)for(n=0;n<e.payload.length;++n)_I.Message.Block.encode(e.payload[n],t.uint32(26).fork()).ldelim();if(null!=e.blockPresences&&e.blockPresences.length)for(n=0;n<e.blockPresences.length;++n)_I.Message.BlockPresence.encode(e.blockPresences[n],t.uint32(34).fork()).ldelim();return null!=e.pendingBytes&&Object.hasOwnProperty.call(e,"pendingBytes")&&t.uint32(40).int32(e.pendingBytes),t},e.decode=function(e,t){e instanceof mI||(e=mI.create(e));for(var n=void 0===t?e.len:e.pos+t,s=new _I.Message;e.pos<n;){var r=e.uint32();switch(r>>>3){case 1:s.wantlist=_I.Message.Wantlist.decode(e,e.uint32());break;case 2:s.blocks&&s.blocks.length||(s.blocks=[]),s.blocks.push(e.bytes());break;case 3:s.payload&&s.payload.length||(s.payload=[]),s.payload.push(_I.Message.Block.decode(e,e.uint32()));break;case 4:s.blockPresences&&s.blockPresences.length||(s.blockPresences=[]),s.blockPresences.push(_I.Message.BlockPresence.decode(e,e.uint32()));break;case 5:s.pendingBytes=e.int32();break;default:e.skipType(7&r)}}return s},e.fromObject=function(e){if(e instanceof _I.Message)return e;var t=new _I.Message;if(null!=e.wantlist){if("object"!=typeof e.wantlist)throw TypeError(".Message.wantlist: object expected");t.wantlist=_I.Message.Wantlist.fromObject(e.wantlist)}if(e.blocks){if(!Array.isArray(e.blocks))throw TypeError(".Message.blocks: array expected");t.blocks=[];for(var n=0;n<e.blocks.length;++n)"string"==typeof e.blocks[n]?bI.base64.decode(e.blocks[n],t.blocks[n]=bI.newBuffer(bI.base64.length(e.blocks[n])),0):e.blocks[n].length>=0&&(t.blocks[n]=e.blocks[n])}if(e.payload){if(!Array.isArray(e.payload))throw TypeError(".Message.payload: array expected");t.payload=[];for(n=0;n<e.payload.length;++n){if("object"!=typeof e.payload[n])throw TypeError(".Message.payload: object expected");t.payload[n]=_I.Message.Block.fromObject(e.payload[n])}}if(e.blockPresences){if(!Array.isArray(e.blockPresences))throw TypeError(".Message.blockPresences: array expected");t.blockPresences=[];for(n=0;n<e.blockPresences.length;++n){if("object"!=typeof e.blockPresences[n])throw TypeError(".Message.blockPresences: object expected");t.blockPresences[n]=_I.Message.BlockPresence.fromObject(e.blockPresences[n])}}return null!=e.pendingBytes&&(t.pendingBytes=0|e.pendingBytes),t},e.toObject=function(e,t){t||(t={});var n={};if((t.arrays||t.defaults)&&(n.blocks=[],n.payload=[],n.blockPresences=[]),t.defaults&&(n.wantlist=null,n.pendingBytes=0),null!=e.wantlist&&e.hasOwnProperty("wantlist")&&(n.wantlist=_I.Message.Wantlist.toObject(e.wantlist,t)),e.blocks&&e.blocks.length){n.blocks=[];for(var s=0;s<e.blocks.length;++s)n.blocks[s]=t.bytes===String?bI.base64.encode(e.blocks[s],0,e.blocks[s].length):t.bytes===Array?Array.prototype.slice.call(e.blocks[s]):e.blocks[s]}if(e.payload&&e.payload.length){n.payload=[];for(s=0;s<e.payload.length;++s)n.payload[s]=_I.Message.Block.toObject(e.payload[s],t)}if(e.blockPresences&&e.blockPresences.length){n.blockPresences=[];for(s=0;s<e.blockPresences.length;++s)n.blockPresences[s]=_I.Message.BlockPresence.toObject(e.blockPresences[s],t)}return null!=e.pendingBytes&&e.hasOwnProperty("pendingBytes")&&(n.pendingBytes=e.pendingBytes),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,l.util.toJSONOptions)},e.getTypeUrl=function(e){return void 0===e&&(e="type.googleapis.com"),e+"/Message"},e.Wantlist=function(){function e(e){if(this.entries=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.entries=bI.emptyArray,e.prototype.full=!1,e.encode=function(e,t){if(t||(t=wI.create()),null!=e.entries&&e.entries.length)for(var n=0;n<e.entries.length;++n)_I.Message.Wantlist.Entry.encode(e.entries[n],t.uint32(10).fork()).ldelim();return null!=e.full&&Object.hasOwnProperty.call(e,"full")&&t.uint32(16).bool(e.full),t},e.decode=function(e,t){e instanceof mI||(e=mI.create(e));for(var n=void 0===t?e.len:e.pos+t,s=new _I.Message.Wantlist;e.pos<n;){var r=e.uint32();switch(r>>>3){case 1:s.entries&&s.entries.length||(s.entries=[]),s.entries.push(_I.Message.Wantlist.Entry.decode(e,e.uint32()));break;case 2:s.full=e.bool();break;default:e.skipType(7&r)}}return s},e.fromObject=function(e){if(e instanceof _I.Message.Wantlist)return e;var t=new _I.Message.Wantlist;if(e.entries){if(!Array.isArray(e.entries))throw TypeError(".Message.Wantlist.entries: array expected");t.entries=[];for(var n=0;n<e.entries.length;++n){if("object"!=typeof e.entries[n])throw TypeError(".Message.Wantlist.entries: object expected");t.entries[n]=_I.Message.Wantlist.Entry.fromObject(e.entries[n])}}return null!=e.full&&(t.full=Boolean(e.full)),t},e.toObject=function(e,t){t||(t={});var n={};if((t.arrays||t.defaults)&&(n.entries=[]),t.defaults&&(n.full=!1),e.entries&&e.entries.length){n.entries=[];for(var s=0;s<e.entries.length;++s)n.entries[s]=_I.Message.Wantlist.Entry.toObject(e.entries[s],t)}return null!=e.full&&e.hasOwnProperty("full")&&(n.full=e.full),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,l.util.toJSONOptions)},e.getTypeUrl=function(e){return void 0===e&&(e="type.googleapis.com"),e+"/Message.Wantlist"},e.WantType=function(){const e={},t=Object.create(e);return t[e[0]="Block"]=0,t[e[1]="Have"]=1,t}(),e.Entry=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.block=bI.newBuffer([]),e.prototype.priority=0,e.prototype.cancel=!1,e.prototype.wantType=0,e.prototype.sendDontHave=!1,e.encode=function(e,t){return t||(t=wI.create()),null!=e.block&&Object.hasOwnProperty.call(e,"block")&&t.uint32(10).bytes(e.block),null!=e.priority&&Object.hasOwnProperty.call(e,"priority")&&t.uint32(16).int32(e.priority),null!=e.cancel&&Object.hasOwnProperty.call(e,"cancel")&&t.uint32(24).bool(e.cancel),null!=e.wantType&&Object.hasOwnProperty.call(e,"wantType")&&t.uint32(32).int32(e.wantType),null!=e.sendDontHave&&Object.hasOwnProperty.call(e,"sendDontHave")&&t.uint32(40).bool(e.sendDontHave),t},e.decode=function(e,t){e instanceof mI||(e=mI.create(e));for(var n=void 0===t?e.len:e.pos+t,s=new _I.Message.Wantlist.Entry;e.pos<n;){var r=e.uint32();switch(r>>>3){case 1:s.block=e.bytes();break;case 2:s.priority=e.int32();break;case 3:s.cancel=e.bool();break;case 4:s.wantType=e.int32();break;case 5:s.sendDontHave=e.bool();break;default:e.skipType(7&r)}}return s},e.fromObject=function(e){if(e instanceof _I.Message.Wantlist.Entry)return e;var t=new _I.Message.Wantlist.Entry;switch(null!=e.block&&("string"==typeof e.block?bI.base64.decode(e.block,t.block=bI.newBuffer(bI.base64.length(e.block)),0):e.block.length>=0&&(t.block=e.block)),null!=e.priority&&(t.priority=0|e.priority),null!=e.cancel&&(t.cancel=Boolean(e.cancel)),e.wantType){case"Block":case 0:t.wantType=0;break;case"Have":case 1:t.wantType=1}return null!=e.sendDontHave&&(t.sendDontHave=Boolean(e.sendDontHave)),t},e.toObject=function(e,t){t||(t={});var n={};return t.defaults&&(t.bytes===String?n.block="":(n.block=[],t.bytes!==Array&&(n.block=bI.newBuffer(n.block))),n.priority=0,n.cancel=!1,n.wantType=t.enums===String?"Block":0,n.sendDontHave=!1),null!=e.block&&e.hasOwnProperty("block")&&(n.block=t.bytes===String?bI.base64.encode(e.block,0,e.block.length):t.bytes===Array?Array.prototype.slice.call(e.block):e.block),null!=e.priority&&e.hasOwnProperty("priority")&&(n.priority=e.priority),null!=e.cancel&&e.hasOwnProperty("cancel")&&(n.cancel=e.cancel),null!=e.wantType&&e.hasOwnProperty("wantType")&&(n.wantType=t.enums===String?_I.Message.Wantlist.WantType[e.wantType]:e.wantType),null!=e.sendDontHave&&e.hasOwnProperty("sendDontHave")&&(n.sendDontHave=e.sendDontHave),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,l.util.toJSONOptions)},e.getTypeUrl=function(e){return void 0===e&&(e="type.googleapis.com"),e+"/Message.Wantlist.Entry"},e}(),e}(),e.Block=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.prefix=bI.newBuffer([]),e.prototype.data=bI.newBuffer([]),e.encode=function(e,t){return t||(t=wI.create()),null!=e.prefix&&Object.hasOwnProperty.call(e,"prefix")&&t.uint32(10).bytes(e.prefix),null!=e.data&&Object.hasOwnProperty.call(e,"data")&&t.uint32(18).bytes(e.data),t},e.decode=function(e,t){e instanceof mI||(e=mI.create(e));for(var n=void 0===t?e.len:e.pos+t,s=new _I.Message.Block;e.pos<n;){var r=e.uint32();switch(r>>>3){case 1:s.prefix=e.bytes();break;case 2:s.data=e.bytes();break;default:e.skipType(7&r)}}return s},e.fromObject=function(e){if(e instanceof _I.Message.Block)return e;var t=new _I.Message.Block;return null!=e.prefix&&("string"==typeof e.prefix?bI.base64.decode(e.prefix,t.prefix=bI.newBuffer(bI.base64.length(e.prefix)),0):e.prefix.length>=0&&(t.prefix=e.prefix)),null!=e.data&&("string"==typeof e.data?bI.base64.decode(e.data,t.data=bI.newBuffer(bI.base64.length(e.data)),0):e.data.length>=0&&(t.data=e.data)),t},e.toObject=function(e,t){t||(t={});var n={};return t.defaults&&(t.bytes===String?n.prefix="":(n.prefix=[],t.bytes!==Array&&(n.prefix=bI.newBuffer(n.prefix))),t.bytes===String?n.data="":(n.data=[],t.bytes!==Array&&(n.data=bI.newBuffer(n.data)))),null!=e.prefix&&e.hasOwnProperty("prefix")&&(n.prefix=t.bytes===String?bI.base64.encode(e.prefix,0,e.prefix.length):t.bytes===Array?Array.prototype.slice.call(e.prefix):e.prefix),null!=e.data&&e.hasOwnProperty("data")&&(n.data=t.bytes===String?bI.base64.encode(e.data,0,e.data.length):t.bytes===Array?Array.prototype.slice.call(e.data):e.data),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,l.util.toJSONOptions)},e.getTypeUrl=function(e){return void 0===e&&(e="type.googleapis.com"),e+"/Message.Block"},e}(),e.BlockPresenceType=function(){const e={},t=Object.create(e);return t[e[0]="Have"]=0,t[e[1]="DontHave"]=1,t}(),e.BlockPresence=function(){function e(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.cid=bI.newBuffer([]),e.prototype.type=0,e.encode=function(e,t){return t||(t=wI.create()),null!=e.cid&&Object.hasOwnProperty.call(e,"cid")&&t.uint32(10).bytes(e.cid),null!=e.type&&Object.hasOwnProperty.call(e,"type")&&t.uint32(16).int32(e.type),t},e.decode=function(e,t){e instanceof mI||(e=mI.create(e));for(var n=void 0===t?e.len:e.pos+t,s=new _I.Message.BlockPresence;e.pos<n;){var r=e.uint32();switch(r>>>3){case 1:s.cid=e.bytes();break;case 2:s.type=e.int32();break;default:e.skipType(7&r)}}return s},e.fromObject=function(e){if(e instanceof _I.Message.BlockPresence)return e;var t=new _I.Message.BlockPresence;switch(null!=e.cid&&("string"==typeof e.cid?bI.base64.decode(e.cid,t.cid=bI.newBuffer(bI.base64.length(e.cid)),0):e.cid.length>=0&&(t.cid=e.cid)),e.type){case"Have":case 0:t.type=0;break;case"DontHave":case 1:t.type=1}return t},e.toObject=function(e,t){t||(t={});var n={};return t.defaults&&(t.bytes===String?n.cid="":(n.cid=[],t.bytes!==Array&&(n.cid=bI.newBuffer(n.cid))),n.type=t.enums===String?"Have":0),null!=e.cid&&e.hasOwnProperty("cid")&&(n.cid=t.bytes===String?bI.base64.encode(e.cid,0,e.cid.length):t.bytes===Array?Array.prototype.slice.call(e.cid):e.cid),null!=e.type&&e.hasOwnProperty("type")&&(n.type=t.enums===String?_I.Message.BlockPresenceType[e.type]:e.type),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,l.util.toJSONOptions)},e.getTypeUrl=function(e){return void 0===e&&(e="type.googleapis.com"),e+"/Message.BlockPresence"},e}(),e})(),vI=EI.Wantlist.WantType.Block,SI=EI.Wantlist.WantType.Have;class kI{constructor(e,t){this.set=t?(0,Qb.n)({name:"ipfs_bitswap_wantlist",metrics:t.metrics}):new Map,this._stats=e}get length(){return this.set.size}add(e,t,n){const s=e.toString(z.base58btc),r=this.set.get(s);r?(r.inc(),r.priority=t,r.wantType===SI&&n===vI&&(r.wantType=n)):(this.set.set(s,new gI(e,t,n)),this._stats&&this._stats.push(null,"wantListSize",1))}remove(e){const t=e.toString(z.base58btc),n=this.set.get(t);n&&(n.dec(),n.hasRefs()||(this.set.delete(t),this._stats&&this._stats.push(null,"wantListSize",-1)))}removeForce(e){this.set.has(e)&&this.set.delete(e)}forEach(e){return this.set.forEach(e)}entries(){return this.set.entries()}sortedEntries(){return new Map((e=e=>e[1].key,t=Array.from(this.set.entries()),Array.prototype.slice.call(t,0).sort(((t,n)=>{const s=e(t),r=e(n);return s<r?-1:s>r?1:0}))));var e,t}contains(e){const t=e.toString(z.base58btc);return this.set.has(t)}get(e){const t=e.toString(z.base58btc);return this.set.get(t)}}kI.Entry=gI;const RI=kI.Entry;class TI{constructor(e,t,n,s,r){this.entry=new RI(e,t,n),this.cancel=Boolean(s),this.sendDontHave=Boolean(r)}get cid(){return this.entry.cid}set cid(e){this.entry.cid=e}get priority(){return this.entry.priority}set priority(e){this.entry.priority=e}get wantType(){return this.entry.wantType}set wantType(e){this.entry.wantType=e}get[Symbol.toStringTag](){return`BitswapMessageEntry ${this.cid.toString(z.base58btc)} <cancel: ${this.cancel}, priority: ${this.priority}>`}equals(e){return this.cancel===e.cancel&&this.sendDontHave===e.sendDontHave&&this.wantType===e.wantType&&this.entry.equals(e.entry)}}const II=(e,t)=>{const n=["bitswap"];return t&&n.push(t),e&&n.push(`${e.toString().slice(0,8)}`),(0,a.vF)(n.join(":"))},PI=(e,t)=>{if(e.size!==t.size)return!1;for(const[n,s]of e){const e=t.get(n);if(void 0===e)return!1;if(s instanceof Uint8Array&&e instanceof Uint8Array&&!(0,ve.a)(s,e))return!1;if(s instanceof TI&&e instanceof TI&&!s.equals(e))return!1}return!0};class AI{constructor(e){this.full=e,this.wantlist=new Map,this.blocks=new Map,this.blockPresences=new Map,this.pendingBytes=0}get empty(){return 0===this.blocks.size&&0===this.wantlist.size&&0===this.blockPresences.size}addEntry(e,t,n,s,r){null==n&&(n=AI.WantType.Block);const o=e.toString(z.base58btc),i=this.wantlist.get(o);i?(i.wantType===n&&(i.priority=t),s&&(i.cancel=Boolean(s)),r&&(i.sendDontHave=Boolean(r)),n===AI.WantType.Block&&i.wantType===AI.WantType.Have&&(i.wantType=n)):this.wantlist.set(o,new TI(e,t,n,s,r))}addBlock(e,t){const n=e.toString(z.base58btc);this.blocks.set(n,t)}addHave(e){const t=e.toString(z.base58btc);this.blockPresences.has(t)||this.blockPresences.set(t,AI.BlockPresenceType.Have)}addDontHave(e){const t=e.toString(z.base58btc);this.blockPresences.has(t)||this.blockPresences.set(t,AI.BlockPresenceType.DontHave)}cancel(e){const t=e.toString(z.base58btc);this.wantlist.delete(t),this.addEntry(e,0,AI.WantType.Block,!0,!1)}setPendingBytes(e){this.pendingBytes=e}serializeToBitswap100(){const e={wantlist:{entries:Array.from(this.wantlist.values()).map((e=>({block:e.cid.bytes,priority:Number(e.priority),cancel:Boolean(e.cancel)}))),full:!!this.full||void 0},blocks:Array.from(this.blocks.values())};return EI.encode(e).finish()}serializeToBitswap110(){const e={wantlist:{entries:Array.from(this.wantlist.values()).map((e=>({block:e.cid.bytes,priority:Number(e.priority),wantType:e.wantType,cancel:Boolean(e.cancel),sendDontHave:Boolean(e.sendDontHave)}))),full:!!this.full||void 0},blockPresences:[],payload:[],pendingBytes:this.pendingBytes};for(const[t,n]of this.blocks.entries()){const s=J.TO.parse(t),r=s.version,o=s.code,i=s.multihash.code,a=s.multihash.digest.length,c=yI([r,o,i,a]);e.payload.push(new EI.Block({prefix:c,data:n}))}for(const[t,n]of this.blockPresences)e.blockPresences.push(new EI.BlockPresence({cid:J.TO.parse(t).bytes,type:n}));return this.pendingBytes>0&&(e.pendingBytes=this.pendingBytes),EI.encode(e).finish()}equals(e){return!!(this.full===e.full&&this.pendingBytes===e.pendingBytes&&PI(this.wantlist,e.wantlist)&&PI(this.blocks,e.blocks)&&PI(this.blockPresences,e.blockPresences))}get[Symbol.toStringTag](){const e=Array.from(this.wantlist.keys()),t=Array.from(this.blocks.keys());return`BitswapMessage <full: ${this.full}, list: ${e}, blocks: ${t}>`}}AI.deserialize=async(e,t)=>{const n=EI.decode(e),s=n.wantlist&&n.wantlist.full||!1,r=new AI(s);return n.wantlist&&n.wantlist.entries&&n.wantlist.entries.forEach((e=>{if(!e.block)return;const t=J.TO.decode(e.block);r.addEntry(t,e.priority||0,e.wantType,Boolean(e.cancel),Boolean(e.sendDontHave))})),n.blockPresences&&n.blockPresences.forEach((e=>{if(!e.cid)return;const t=J.TO.decode(e.cid);e.type===AI.BlockPresenceType.Have?r.addHave(t):r.addDontHave(t)})),n.blocks.length>0?(await Promise.all(n.blocks.map((async e=>{const t=await co.sha256.digest(e),n=J.TO.createV0(t);r.addBlock(n,e)}))),r):n.payload.length>0?(await Promise.all(n.payload.map((async e=>{if(!e.prefix||!e.data)return;const n=fI(e.prefix),s=n[0],o=n[1],i=n[2],a=i===co.sha256.code?co.sha256:t&&await t.getHasher(i);if(!a)throw new mp.A("Unknown hash algorithm","ERR_UNKNOWN_HASH_ALG");const c=await a.digest(e.data),l=J.TO.create(s,o,c);r.addBlock(l,e.data)}))),r.setPendingBytes(n.pendingBytes),r):r},AI.blockPresenceSize=e=>e.bytes.length+1,AI.Entry=TI,AI.WantType={Block:EI.Wantlist.WantType.Block,Have:EI.Wantlist.WantType.Have},AI.BlockPresenceType={Have:EI.BlockPresenceType.Have,DontHave:EI.BlockPresenceType.DontHave};const DI=Math.pow(2,31)-1;var OI=n(29760);class NI{constructor(e,t,n){this.peerId=t,this.network=n,this.refcnt=1,this._entries=[],this._log=II(e,"msgqueue"),this.sendEntries=(0,OI.A)(this._sendEntries.bind(this),1)}addMessage(e){e.empty||this.send(e)}addEntries(e){this._entries=this._entries.concat(e),this.sendEntries()}_sendEntries(){if(!this._entries.length)return;const e=new AI(!1);this._entries.forEach((t=>{t.cancel?e.cancel(t.cid):e.addEntry(t.cid,t.priority)})),this._entries=[],this.addMessage(e)}async send(e){try{await this.network.connectTo(this.peerId)}catch(e){return void this._log.error("cant connect to peer %s: %s",this.peerId.toString(),e.message)}this._log("sending message to peer %s",this.peerId.toString()),this.network.sendMessage(this.peerId,e).catch((e=>{this._log.error("send error: %s",e.message)}))}}class LI{constructor(e,t,n,s){this.peers=(0,Qb.n)({name:"ipfs_bitswap_want_manager_peers",metrics:s.metrics}),this.wantlist=new kI(n,s),this.network=t,this._stats=n,this._peerId=e,this._log=II(e,"want")}_addEntries(e,t,n){const s=e.map(((e,n)=>new AI.Entry(e,DI-n,AI.WantType.Block,t)));s.forEach((e=>{e.cancel?n?this.wantlist.removeForce(e.cid.toString(z.base58btc)):this.wantlist.remove(e.cid):(this._log("adding to wl"),this.wantlist.add(e.cid,e.priority))}));for(const e of this.peers.values())e.addEntries(s)}_startPeerHandler(e){let t=this.peers.get(e.toString());if(t)return void t.refcnt++;t=new NI(this._peerId,e,this.network);const n=new AI(!0);for(const e of this.wantlist.entries())n.addEntry(e[1].cid,e[1].priority);return t.addMessage(n),this.peers.set(e.toString(),t),t}_stopPeerHandler(e){const t=this.peers.get(e.toString());t&&(t.refcnt--,t.refcnt>0||this.peers.delete(e.toString()))}wantBlocks(e,t={}){this._addEntries(e,!1),t&&t.signal&&t.signal.addEventListener("abort",(()=>{this.cancelWants(e)}))}unwantBlocks(e){this._log("unwant blocks: %s",e.length),this._addEntries(e,!0,!0)}cancelWants(e){this._log("cancel wants: %s",e.length),this._addEntries(e,!0)}connectedPeers(){return Array.from(this.peers.keys())}connected(e){this._startPeerHandler(e)}disconnected(e){this._stopPeerHandler(e)}start(){}stop(){this.peers.forEach((e=>this.disconnected(e.peerId)))}}const MI="/ipfs/bitswap/1.0.0",CI="/ipfs/bitswap/1.1.0",xI="/ipfs/bitswap/1.2.0";class BI{constructor(e,t,n,s={}){this._log=II(e.peerId,"network"),this._libp2p=e,this._bitswap=t,this._protocols=[MI],s.b100Only||(this._protocols.unshift(CI),this._protocols.unshift(xI)),this._stats=n,this._running=!1,this._onPeerConnect=this._onPeerConnect.bind(this),this._onPeerDisconnect=this._onPeerDisconnect.bind(this),this._onConnection=this._onConnection.bind(this),this._hashLoader=s.hashLoader,this._maxInboundStreams=s.maxInboundStreams??32,this._maxOutboundStreams=s.maxOutboundStreams??128,this._incomingStreamTimeout=s.incomingStreamTimeout??3e4}async start(){this._running=!0,await this._libp2p.handle(this._protocols,this._onConnection,{maxInboundStreams:this._maxInboundStreams,maxOutboundStreams:this._maxOutboundStreams});const e=(0,Jh.g)({onConnect:this._onPeerConnect,onDisconnect:this._onPeerDisconnect});this._registrarIds=[];for(const t of this._protocols)this._registrarIds.push(await this._libp2p.register(t,e));this._libp2p.getConnections().forEach((e=>{this._onPeerConnect(e.remotePeer)}))}async stop(){if(this._running=!1,await this._libp2p.unhandle(this._protocols),null!=this._registrarIds){for(const e of this._registrarIds)this._libp2p.unregister(e);this._registrarIds=[]}}_onConnection({stream:e,connection:t}){if(!this._running)return;const n=new B.TimeoutController(this._incomingStreamTimeout);Promise.resolve().then((async()=>{this._log("incoming new bitswap %s connection from %p",e.stat.protocol,t.remotePeer),await no((0,qp.IV)(e.source,n.signal),ub(),(async e=>{for await(const s of e){try{const e=await AI.deserialize(s.subarray(),this._hashLoader);await this._bitswap._receiveMessage(t.remotePeer,e)}catch(e){this._bitswap._receiveError(e);break}n.reset()}}))})).catch((t=>{this._log(t),e.abort(t)})).finally((()=>{n.clear(),e.close()}))}_onPeerConnect(e){this._bitswap._onPeerConnected(e)}_onPeerDisconnect(e){this._bitswap._onPeerDisconnected(e)}findProviders(e,t={}){return this._libp2p.contentRouting.findProviders(e,t)}async findAndConnect(e,t){const n=[];let s=0;for await(const r of this.findProviders(e,t))if(this._log(`connecting to provider ${r.id}`),n.push(this.connectTo(r.id,t).catch((e=>{this._log.error(e)}))),s++,3===s)break;await Promise.all(n)}async provide(e,t){await this._libp2p.contentRouting.provide(e,t)}async sendMessage(e,t){if(!this._running)throw new Error("network isn't running");const n=e.toString();this._log("sendMessage to %s",n,t);const s=await this._libp2p.dial(e),r=await s.newStream([xI,CI,MI]);await async function(e,t,n){try{let n;switch(e.stat.protocol){case MI:n=t.serializeToBitswap100();break;case CI:case xI:n=t.serializeToBitswap110();break;default:throw new Error("Unknown protocol: "+e.stat.protocol)}await no([n],ib(),e)}catch(e){n(e)}finally{e.close()}}(r,t,this._log),this._updateSentStats(e,t.blocks)}async connectTo(e,t){if(!this._running)throw new Error("network isn't running");return this._libp2p.dial(e,t)}_updateSentStats(e,t){const n=e.toString();if(this._stats){for(const e of t.values())this._stats.push(n,"dataSent",e.length);this._stats.push(n,"blocksSent",t.size)}}}class zI{constructor(e){this.partner=e,this.wantlist=new kI,this.exchangeCount=0,this.sentToPeer=new Map,this.accounting={bytesSent:0,bytesRecv:0}}sentBytes(e){this.exchangeCount++,this.lastExchange=(new Date).getTime(),this.accounting.bytesSent+=e}receivedBytes(e){this.exchangeCount++,this.lastExchange=(new Date).getTime(),this.accounting.bytesRecv+=e}wants(e,t,n){this.wantlist.add(e,t,n)}cancelWant(e){this.wantlist.remove(e)}wantlistContains(e){return this.wantlist.get(e)}debtRatio(){return this.accounting.bytesSent/(this.accounting.bytesRecv+1)}}class UI extends Map{constructor(e,t){super(),this._cmp=t||this._defaultSort,this._keys=[];for(const[t,n]of e||[])this.set(t,n)}update(e){if(e<0||e>=this._keys.length)return;const t=this._keys[e];this._keys.splice(e,1);const n=this._find(t);this._keys.splice(n,0,t)}set(e,t){if(this.has(e)){const t=this.indexOf(e);this._keys.splice(t,1)}super.set(e,t);const n=this._find(e);return this._keys.splice(n,0,e),this}clear(){super.clear(),this._keys=[]}delete(e){if(!this.has(e))return!1;const t=this.indexOf(e);return this._keys.splice(t,1),super.delete(e)}indexOf(e){if(!this.has(e))return-1;const t=this._find(e);if(this._keys[t]===e)return t;for(let n=1;n<this._keys.length;n++){if(this._keys[t+n]===e)return t+n;if(this._keys[t-n]===e)return t-n}return-1}_find(e){let t=0,n=this._keys.length;for(;t<n;){const s=t+n>>>1,r=this._kCmp(this._keys[s],e);if(r<0)t=s+1;else{if(!(r>0))return s;n=s}}return t}*keys(){for(const e of this._keys)yield e}*values(){for(const e of this._keys)yield this.get(e)}*entries(){for(const e of this._keys)yield[e,this.get(e)]}*[Symbol.iterator](){yield*this.entries()}forEach(e,t){if(e)for(const n of this._keys)e.apply(t,[[n,this.get(n)]])}_defaultSort(e,t){return e[0]<t[0]?-1:t[0]<e[0]?1:0}_kCmp(e,t){return this._cmp([e,this.get(e)],[t,this.get(t)])}}const FI={hasNewInfo:()=>!1,merge(){}};class jI{constructor(e=FI){this._taskMerger=e,this._byPeer=new UI([],HI.compare)}pushTasks(e,t){let n=this._byPeer.get(e.toString());n||(n=new HI(e,this._taskMerger)),n.pushTasks(t),this._byPeer.set(e.toString(),n)}popTasks(e){const t=this._head();if(void 0===t)return{tasks:[],pendingSize:0};const{tasks:n,pendingSize:s}=t.popTasks(e);if(0===n.length)return{tasks:n,pendingSize:s};const r=t.peerId;return t.isIdle()?this._byPeer.delete(r.toString()):this._byPeer.update(0),{peerId:r,tasks:n,pendingSize:s}}_head(){if(0!==this._byPeer.size)for(const[,e]of this._byPeer)return e}remove(e,t){const n=this._byPeer.get(t.toString());n&&n.remove(e)}tasksDone(e,t){const n=this._byPeer.get(e.toString());if(!n)return;const s=this._byPeer.indexOf(e.toString());for(const e of t)n.taskDone(e);this._byPeer.update(s)}}class HI{constructor(e,t){this.peerId=e,this._taskMerger=t,this._activeTotalSize=0,this._pending=new $I,this._active=new Set}pushTasks(e){for(const t of e)this._pushTask(t)}_pushTask(e){if(!this._taskHasMoreInfoThanActiveTasks(e))return;const t=this._pending.get(e.topic);if(t)return e.priority>t.priority&&this._pending.updatePriority(e.topic,e.priority),void this._taskMerger.merge(e,t);this._pending.add(e)}_taskHasMoreInfoThanActiveTasks(e){const t=[];for(const n of this._active)n.topic===e.topic&&t.push(n);return 0===t.length||this._taskMerger.hasNewInfo(e,t)}popTasks(e){let t=0;const n=[],s=this._pending.tasks();for(let r=0;r<s.length&&t<e;r++){const e=s[r];n.push(e),t+=e.size,this._pending.delete(e.topic),this._activeTotalSize+=e.size,this._active.add(e)}return{tasks:n,pendingSize:this._pending.totalSize}}taskDone(e){this._active.has(e)&&(this._activeTotalSize-=e.size,this._active.delete(e))}remove(e){this._pending.delete(e)}isIdle(){return 0===this._pending.length&&0===this._active.size}static compare(e,t){return 0===e[1]._pending.length?1:0===t[1]._pending.length?-1:e[1]._activeTotalSize===t[1]._activeTotalSize?t[1]._pending.length-e[1]._pending.length:e[1]._activeTotalSize-t[1]._activeTotalSize}}class $I{constructor(){this._tasks=new UI([],this._compare)}get length(){return this._tasks.size}get totalSize(){return[...this._tasks.values()].reduce(((e,t)=>e+t.task.size),0)}get(e){return(this._tasks.get(e)||{}).task}add(e){this._tasks.set(e.topic,{created:Date.now(),task:e})}delete(e){this._tasks.delete(e)}tasks(){return[...this._tasks.values()].map((e=>e.task))}updatePriority(e,t){const n=this._tasks.get(e);if(!n)return;const s=this._tasks.indexOf(e);n.task.priority=t,this._tasks.update(s)}_compare(e,t){return e[1].task.priority===t[1].task.priority?e[1].created-t[1].created:t[1].task.priority-e[1].task.priority}}const VI={hasNewInfo(e,t){let n=!1,s=!1;for(const e of t)e.data.haveBlock&&(n=!0),e.data.isWantBlock&&(s=!0);return!(s||!e.data.isWantBlock)||!(n||!e.data.haveBlock)},merge(e,t){const n=e.data,s=t.data;!s.haveBlock&&n.haveBlock&&(s.haveBlock=n.haveBlock,s.blockSize=n.blockSize),!s.isWantBlock&&n.isWantBlock&&(s.isWantBlock=!0,s.haveBlock&&!n.haveBlock||(s.haveBlock=n.haveBlock,t.size=e.size)),s.isWantBlock&&s.haveBlock&&(t.size=s.blockSize)}},KI=AI.WantType;class qI{constructor(e,t,n,s,r,o={}){this._log=II(e,"engine"),this.blockstore=t,this.network=n,this._stats=s,this._opts=this._processOpts(o),this.ledgerMap=(0,Qb.n)({name:"ipfs_bitswap_ledger_map",metrics:r.metrics}),this._running=!1,this._requestQueue=new jI(VI)}_processOpts(e){return{maxSizeReplaceHasWithBlock:1024,targetMessageSize:16384,...e}}_scheduleProcessTasks(){setTimeout((()=>{this._processTasks()}))}async _processTasks(){if(!this._running)return;const{peerId:e,tasks:t,pendingSize:n}=this._requestQueue.popTasks(this._opts.targetMessageSize);if(0===t.length)return;const s=new AI(!1);s.setPendingBytes(n);const r=[],o=new Map;for(const e of t){const t=J.TO.parse(e.topic);e.data.haveBlock?e.data.isWantBlock?(r.push(t),o.set(e.topic,e.data)):s.addHave(t):s.addDontHave(t)}const i=await this._getBlocks(r);for(const[e,t]of o){const n=J.TO.parse(e),r=i.get(e);r?s.addBlock(n,r):t.sendDontHave&&s.addDontHave(n)}if(s.empty)return e&&this._requestQueue.tasksDone(e,t),void this._scheduleProcessTasks();try{e&&await this.network.sendMessage(e,s);for(const[t,n]of i.entries())e&&this.messageSent(e,J.TO.parse(t),n)}catch(e){this._log.error(e)}e&&this._requestQueue.tasksDone(e,t),this._scheduleProcessTasks()}wantlistForPeer(e){const t=e.toString(),n=this.ledgerMap.get(t);return n?n.wantlist.sortedEntries():new Map}ledgerForPeer(e){const t=e.toString(),n=this.ledgerMap.get(t);return n?{peer:n.partner,value:n.debtRatio(),sent:n.accounting.bytesSent,recv:n.accounting.bytesRecv,exchanged:n.exchangeCount}:null}peers(){return Array.from(this.ledgerMap.values()).map((e=>e.partner))}receivedBlocks(e){if(e.length){for(const t of this.ledgerMap.values())for(const n of e){const e=t.wantlistContains(n.cid);if(!e)continue;const s=n.data.length,r=this._sendAsBlock(e.wantType,s);let o=s;r||(o=AI.blockPresenceSize(e.cid)),this._requestQueue.pushTasks(t.partner,[{topic:e.cid.toString(z.base58btc),priority:e.priority,size:o,data:{blockSize:s,isWantBlock:r,haveBlock:!0,sendDontHave:!1}}])}this._scheduleProcessTasks()}}async messageReceived(e,t){const n=this._findOrCreate(e);if(t.empty)return;if(t.full&&(n.wantlist=new kI),this._updateBlockAccounting(t.blocks,n),0===t.wantlist.size)return void this._scheduleProcessTasks();const s=[],r=[];t.wantlist.forEach((e=>{e.cancel?(n.cancelWant(e.cid),s.push(e.cid)):(n.wants(e.cid,e.priority,e.wantType),r.push(e))})),this._cancelWants(e,s),await this._addWants(e,r),this._scheduleProcessTasks()}_cancelWants(e,t){for(const n of t)this._requestQueue.remove(n.toString(z.base58btc),e)}async _addWants(e,t){const n=await this._getBlockSizes(t.map((e=>e.cid))),s=[];for(const r of t){const t=r.cid.toString(z.base58btc),o=n.get(t);if(null==o)r.sendDontHave&&s.push({topic:t,priority:r.priority,size:AI.blockPresenceSize(r.cid),data:{isWantBlock:r.wantType===KI.Block,blockSize:0,haveBlock:!1,sendDontHave:r.sendDontHave}});else{const e=this._sendAsBlock(r.wantType,o);let n=o;e||(n=AI.blockPresenceSize(r.cid)),s.push({topic:t,priority:r.priority,size:n,data:{isWantBlock:e,blockSize:o,haveBlock:!0,sendDontHave:r.sendDontHave}})}this._requestQueue.pushTasks(e,s)}}_sendAsBlock(e,t){return e===KI.Block||t<=this._opts.maxSizeReplaceHasWithBlock}async _getBlockSizes(e){const t=await this._getBlocks(e);return new Map([...t].map((([e,t])=>[e,t.length])))}async _getBlocks(e){const t=new Map;return await Promise.all(e.map((async e=>{try{const n=await this.blockstore.get(e);t.set(e.toString(z.base58btc),n)}catch(t){"ERR_NOT_FOUND"!==t.code&&this._log.error("failed to query blockstore for %s: %s",e,t)}}))),t}_updateBlockAccounting(e,t){for(const n of e.values())this._log("got block (%s bytes)",n.length),t.receivedBytes(n.length)}messageSent(e,t,n){const s=this._findOrCreate(e);s.sentBytes(n.length),s.wantlist.remove(t)}numBytesSentTo(e){return this._findOrCreate(e).accounting.bytesSent}numBytesReceivedFrom(e){return this._findOrCreate(e).accounting.bytesRecv}peerDisconnected(e){this.ledgerMap.delete(e.toString())}_findOrCreate(e){const t=e.toString(),n=this.ledgerMap.get(t);if(n)return n;const s=new zI(e);return this.ledgerMap.set(t,s),this._stats&&this._stats.push(t,"peerCount",1),s}start(){this._running=!0}stop(){this._running=!1}}const GI=e=>`unwant:${(0,$.d)(e.multihash.bytes,"base64")}`,WI=e=>`block:${(0,$.d)(e.multihash.bytes,"base64")}`;class YI extends lw.EventEmitter{constructor(e){super(),this.setMaxListeners(1e3),this._log=II(e,"notif")}hasBlock(e,t){const n=WI(e);this._log(n),this.emit(n,t)}wantBlock(e,t={}){if(!e)throw new Error("Not a valid cid");const n=WI(e),s=GI(e);return this._log(`wantBlock:${e}`),new Promise(((r,o)=>{const i=()=>{this.removeListener(n,a),o(new Error(`Block for ${e} unwanted`))},a=e=>{this.removeListener(s,i),r(e)};this.once(s,i),this.once(n,a),t&&t.signal&&t.signal.addEventListener("abort",(()=>{this.removeListener(n,a),this.removeListener(s,i),o(new Error(`Want for ${e} aborted`))}))}))}unwantBlock(e){const t=GI(e);this._log(t),this.emit(t)}}var XI=n(84166);class QI extends lw.EventEmitter{constructor(e,t){super(),this._options=t,this._queue=[],this._stats={},this._frequencyLastTime=Date.now(),this._frequencyAccumulators={},this._movingAverages={},this._update=this._update.bind(this),e.forEach((e=>{this._stats[e]=BigInt(0),this._movingAverages[e]={},this._options.movingAverageIntervals.forEach((t=>{(this._movingAverages[e][t]=XI(t)).push(this._frequencyLastTime,0)}))})),this._enabled=this._options.enabled}enable(){this._enabled=!0}disable(){this._disabled=!0}stop(){this._timeout&&clearTimeout(this._timeout)}get snapshot(){return Object.assign({},this._stats)}get movingAverages(){return Object.assign({},this._movingAverages)}push(e,t){this._enabled&&(this._queue.push([e,t,Date.now()]),this._resetComputeTimeout())}_resetComputeTimeout(){this._timeout&&clearTimeout(this._timeout),this._timeout=setTimeout(this._update,this._nextTimeout())}_nextTimeout(){const e=this._queue.length/this._options.computeThrottleMaxQueueSize;return Math.max(this._options.computeThrottleTimeout*(1-e),0)}_update(){if(this._timeout=null,this._queue.length){let e;for(;this._queue.length;){const t=e=this._queue.shift();t&&this._applyOp(t)}e&&this._updateFrequency(e[2]),this.emit("update",this._stats)}}_updateFrequency(e){const t=e-this._frequencyLastTime;t&&Object.keys(this._stats).forEach((n=>{this._updateFrequencyFor(n,t,e)})),this._frequencyLastTime=e}_updateFrequencyFor(e,t,n){const s=this._frequencyAccumulators[e]||0;this._frequencyAccumulators[e]=0;const r=s/t*1e3;let o=this._movingAverages[e];o||(o=this._movingAverages[e]={}),this._options.movingAverageIntervals.forEach((e=>{let t=o[e];t||(t=o[e]=XI(e)),t.push(n,r)}))}_applyOp(e){const t=e[0],n=e[1];if("number"!=typeof n)throw new Error(`invalid increment number: ${n}`);Object.prototype.hasOwnProperty.call(this._stats,t)||(this._stats[t]=BigInt(0)),this._stats[t]=BigInt(this._stats[t])+BigInt(n),this._frequencyAccumulators[t]||(this._frequencyAccumulators[t]=0),this._frequencyAccumulators[t]+=n}}const JI={enabled:!1,computeThrottleTimeout:1e3,computeThrottleMaxQueueSize:1e3,movingAverageIntervals:[6e4,3e5,9e5]};class ZI extends lw.EventEmitter{constructor(e,t=[],n=JI){super();const s=Object.assign({},JI,n);if("number"!=typeof s.computeThrottleTimeout)throw new Error("need computeThrottleTimeout");if("number"!=typeof s.computeThrottleMaxQueueSize)throw new Error("need computeThrottleMaxQueueSize");this._initialCounters=t,this._options=s,this._enabled=this._options.enabled,this._global=new QI(t,s),this._global.on("update",(e=>this.emit("update",e))),this._peers=(0,Qb.n)({name:"ipfs_bitswap_stats_peers",metrics:e.metrics})}enable(){this._enabled=!0,this._options.enabled=!0,this._global.enable()}disable(){this._enabled=!1,this._options.enabled=!1,this._global.disable()}stop(){this._enabled=!1,this._global.stop();for(const e of this._peers)e[1].stop()}get snapshot(){return this._global.snapshot}get movingAverages(){return this._global.movingAverages}forPeer(e){const t="string"!=typeof e&&e.toString?e.toString():`${e}`;return this._peers.get(t)}push(e,t,n){if(this._enabled&&(this._global.push(t,n),e)){let s=this._peers.get(e);s||(s=new QI(this._initialCounters,this._options),this._peers.set(e,s)),s.push(t,n)}}disconnected(e){const t=e.toString(),n=this._peers.get(t);n&&(n.stop(),this._peers.delete(t))}}const eP=(e,t)=>async function*(){const n=await $n(e);yield*n.sort(t)}();class tP{open(){return Promise.reject(new Error(".open is not implemented"))}close(){return Promise.reject(new Error(".close is not implemented"))}put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(const{key:n,value:s}of e)await this.put(n,s,t),yield{key:n,value:s}}async*getMany(e,t={}){for await(const n of e)yield this.get(n,t)}async*deleteMany(e,t={}){for await(const n of e)await this.delete(n,t),yield n}batch(){let e=[],t=[];return{put(t,n){e.push({key:t,value:n})},delete(e){t.push(e)},commit:async n=>{await(0,Kn.A)(this.putMany(e,n)),e=[],await(0,Kn.A)(this.deleteMany(t,n)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let n=this._all(e,t);if(null!=e.prefix&&(n=(0,qn.A)(n,(t=>t.key.toString().startsWith(e.prefix||"")))),Array.isArray(e.filters)&&(n=e.filters.reduce(((e,t)=>(0,qn.A)(e,t)),n)),Array.isArray(e.orders)&&(n=e.orders.reduce(((e,t)=>eP(e,t)),n)),null!=e.offset){let t=0;n=(0,qn.A)(n,(()=>t++>=(e.offset||0)))}return null!=e.limit&&(n=(0,Gn.A)(n,e.limit)),n}queryKeys(e,t){let n=this._allKeys(e,t);if(null!=e.prefix&&(n=(0,qn.A)(n,(t=>t.toString().startsWith(e.prefix||"")))),Array.isArray(e.filters)&&(n=e.filters.reduce(((e,t)=>(0,qn.A)(e,t)),n)),Array.isArray(e.orders)&&(n=e.orders.reduce(((e,t)=>eP(e,t)),n)),null!=e.offset){let t=0;n=(0,qn.A)(n,(()=>t++>=e.offset))}return null!=e.limit&&(n=(0,Gn.A)(n,e.limit)),n}}const nP={statsEnabled:!1,statsComputeThrottleTimeout:1e3,statsComputeThrottleMaxQueueSize:1e3},sP=["blocksReceived","dataReceived","dupBlksReceived","dupDataReceived","blocksSent","dataSent","providesBufferLength","wantListLength","peerCount"];class rP extends tP{constructor(e,t,n={}){super(),this._libp2p=e,this._log=II(this.peerId),this._options=Object.assign({},nP,n),this._stats=new ZI(e,sP,{enabled:this._options.statsEnabled,computeThrottleTimeout:this._options.statsComputeThrottleTimeout,computeThrottleMaxQueueSize:this._options.statsComputeThrottleMaxQueueSize}),this.network=new BI(e,this,this._stats,{hashLoader:n.hashLoader,maxInboundStreams:n.maxInboundStreams,maxOutboundStreams:n.maxOutboundStreams,incomingStreamTimeout:n.incomingStreamTimeout}),this.blockstore=t,this.engine=new qI(this.peerId,t,this.network,this._stats,e),this.wm=new LI(this.peerId,this.network,this._stats,e),this.notifications=new YI(this.peerId),this.started=!1}isStarted(){return this.started}get peerId(){return this._libp2p.peerId}async _receiveMessage(e,t){try{await this.engine.messageReceived(e,t)}catch(e){this._log("failed to receive message",t)}if(0===t.blocks.size)return;const n=[];for(const[e,s]of t.blocks.entries()){const t=J.TO.parse(e);n.push({wasWanted:this.wm.wantlist.contains(t),cid:t,data:s})}this.wm.cancelWants(n.filter((({wasWanted:e})=>e)).map((({cid:e})=>e))),await Promise.all(n.map((({cid:t,wasWanted:n,data:s})=>this._handleReceivedBlock(e,t,s,n))))}async _handleReceivedBlock(e,t,n,s){this._log("received block");const r=await this.blockstore.has(t);this._updateReceiveCounters(e.toString(),t,n,r),s&&await this.put(t,n)}_updateReceiveCounters(e,t,n,s){this._stats.push(e,"blocksReceived",1),this._stats.push(e,"dataReceived",n.length),s&&(this._stats.push(e,"dupBlksReceived",1),this._stats.push(e,"dupDataReceived",n.length))}_receiveError(e){this._log.error("ReceiveError: %s",e.message)}_onPeerConnected(e){this.wm.connected(e)}_onPeerDisconnected(e){this.wm.disconnected(e),this.engine.peerDisconnected(e),this._stats.disconnected(e)}enableStats(){this._stats.enable()}disableStats(){this._stats.disable()}wantlistForPeer(e,t){return this.engine.wantlistForPeer(e)}ledgerForPeer(e){return this.engine.ledgerForPeer(e)}async get(e,t={}){const n=(e,t)=>(this.wm.wantBlocks([e],t),this.notifications.wantBlock(e,t));let s=!1;const r=async(e,t)=>{try{return await this.blockstore.get(e,t)}catch(r){if("ERR_NOT_FOUND"!==r.code)throw r;return s||(s=!0,this.network.findAndConnect(e,t).catch((e=>this._log.error(e)))),n(e,t)}},o=new AbortController,i=t.signal?(0,_t.anySignal)([t.signal,o.signal]):o.signal;try{return await Promise.race([this.notifications.wantBlock(e,{signal:i}),r(e,{signal:i})])}finally{o.abort()}}async*getMany(e,t={}){for await(const n of e)yield this.get(n,t)}unwant(e){const t=Array.isArray(e)?e:[e];this.wm.unwantBlocks(t),t.forEach((e=>this.notifications.unwantBlock(e)))}cancelWants(e){this.wm.cancelWants(Array.isArray(e)?e:[e])}async put(e,t,n){await this.blockstore.put(e,t),this._sendHaveBlockNotifications(e,t)}async*putMany(e,t){for await(const{key:n,value:s}of this.blockstore.putMany(e,t))this._sendHaveBlockNotifications(n,s),yield{key:n,value:s}}_sendHaveBlockNotifications(e,t){this.notifications.hasBlock(e,t),this.engine.receivedBlocks([{cid:e,data:t}]),this.network.provide(e).catch((e=>{this._log.error("Failed to provide: %s",e.message)}))}getWantlist(){return this.wm.wantlist.entries()}peers(){return this.engine.peers()}stat(){return this._stats}async start(){this.wm.start(),await this.network.start(),this.engine.start(),this.started=!0}async stop(){this._stats.stop(),this.wm.stop(),await this.network.stop(),this.engine.stop(),this.started=!1}unwrap(){return this.blockstore}has(e){return this.blockstore.has(e)}}function oP(e){return e=e||new Error("Not Found"),c(e,"ERR_NOT_FOUND")}function iP(e){return e=e||new Error("Aborted"),c(e,"ERR_ABORTED")}class aP extends tP{constructor(e,t){super(),this.child=e,this.bitswap=t}open(){return this.child.open()}close(){return this.child.close()}unwrap(){return this.child}async put(e,t,n={}){await this.has(e)||(this.bitswap.isStarted()?await this.bitswap.put(e,t,n):await this.child.put(e,t,n))}async*putMany(e,t={}){const n=(0,qn.A)(e,(async({key:e})=>!await this.has(e)));this.bitswap.isStarted()?yield*this.bitswap.putMany(n,t):yield*this.child.putMany(n,t)}async get(e,t={}){return!await this.has(e)&&this.bitswap.isStarted()?this.bitswap.get(e,t):this.child.get(e,t)}async*getMany(e,t={}){const n=(0,Yn.N)({objectMode:!0}),s=(0,Yn.N)({objectMode:!0});Promise.resolve().then((async()=>{for await(const t of e)!await this.has(t)&&this.bitswap.isStarted()?n.push(t):s.push(t);n.end(),s.end()})),yield*(0,Qr.A)(this.bitswap.getMany(n,t),this.child.getMany(s,t))}async delete(e,t){await this.child.delete(e,t)}async*deleteMany(e,t){yield*this.child.deleteMany(e,t)}async has(e,t={}){return this.child.has(e,t)}async*query(e,t={}){yield*this.child.query(e,t)}async*queryKeys(e,t={}){yield*this.child.queryKeys(e,t)}}class cP{constructor(e,t,n,s,r){this.peerId=e,this.libp2p=t,this.bitswap=n,this.repo=s,this.blockstore=r}static async start({peerId:e,repo:t,print:n,hashers:s,options:r}){t.closed&&await t.open();const o=await t.config.getAll(),i=await nI({options:r,repo:t,peerId:e,multiaddrs:lP(e,o),config:o,keychainConfig:void 0});await i.start();for(const e of i.getMultiaddrs())n(`Swarm listening on ${e.toString()}`);const a=((e,t,n={})=>new rP(e,t,n))(i,t.blocks,{statsEnabled:!0,hashLoader:s,maxInboundStreams:1024,maxOutboundStreams:1024});await a.start();const c=new aP(t.blocks,a);return t.blocks=c,t.pins.blockstore=c,new cP(e,i,a,t,c)}static async stop(e){e.repo.blocks=e.blockstore.unwrap(),e.repo.pins.blockstore=e.blockstore.unwrap(),await e.bitswap.stop(),await e.libp2p.stop()}}const lP=(e,t)=>{const n=e.toString(),s=[],r=t.Addresses&&t.Addresses.Swarm||[];for(const e of r){let t=(0,j.HZ)(e);if(t.protoCodes().includes(dP))throw c(new Error("websocket-star swarm addresses are not supported. See https://github.com/ipfs/js-ipfs/issues/2779"),"ERR_WEBSOCKET_STAR_SWARM_ADDR_NOT_SUPPORTED");const r=t.getPeerId();r&&r!==n&&(t=t.encapsulate(`/p2p/${n}`)),s.push(t)}return s},dP=479;class uP{constructor({network:e}){this.addrs=function({network:e}){return St((async function(t={}){const n=[],{libp2p:s}=await e.use(t);return await s.peerStore.forEach((e=>{n.push({id:e.id,addrs:e.addresses.map((e=>e.multiaddr))})})),n}))}({network:e}),this.connect=function({network:e}){return St((async function(t,n={}){const{libp2p:s}=await e.use(n);await s.dial(t,n)}))}({network:e}),this.disconnect=function({network:e}){return St((async function(t,n={}){const{libp2p:s}=await e.use(n);await s.hangUp(t)}))}({network:e}),this.localAddrs=function({network:e}){return St((async function(t={}){const{libp2p:n}=await e.use(t);return n.getMultiaddrs()}))}({network:e}),this.peers=function({network:e}){return St((async function(t={}){const{libp2p:n}=await e.use(t);if(t.verbose){const e=[];for(const s of n.getConnections()){const n={addr:s.remoteAddr,peer:s.remotePeer};(t.verbose||t.direction)&&(n.direction=s.stat.direction),t.verbose&&(n.muxer=s.stat.multiplexer,n.latency="n/a",n.streams=[]),e.push(n)}return e}const s=new Map;for(const e of n.getConnections()){const t={addr:e.remoteAddr,peer:e.remotePeer};s.set(e.remotePeer.toString(),t)}return Array.from(s.values())}))}({network:e})}}const hP={success:!0,time:0,text:""};const pP="/ipns/";function fP(e){let t;if(e.startsWith(pP)&&(e=e.substring(pP.length)),"1"!==e[0]&&"Q"!==e[0]||(e=`z${e}`),"z"===e[0]&&(t=z.base58btc.decode(e)),"k"===e[0]&&(t=ps.base36.decode(e)),!t)throw new Error("Could not parse string");if(1!==t[0]&&114!==t[1]&&(t=(0,ee.x)([[1,114],t])),40!==t.length)throw new Error("Incorrect length "+t.length);return(0,ee.x)([(0,x.s)(pP),t.subarray(2)])}const yP=async(e,t,n)=>{const s=await e.use(n);if(null!=s.libp2p.dht)return s;{const e=async function*(){yield{from:t,name:"QUERY_ERROR",type:3,error:new C("dht not enabled")}};return{libp2p:{dht:{get:e,put:e,findProviders:e,findPeer:e,provide:e,getClosestPeers:e}}}}};const gP=async()=>{throw new C("pubsub not enabled")};var mP=n(96763);const wP=o.A.bind({ignoreUndefined:!0}),bP=(0,a.vF)("ipfs");class _P{constructor({print:e,storage:t,codecs:n,options:s}){const{peerId:r,repo:o,keychain:i}=t,a=Lt.create(cP),l=_c(s.preload),d=jt(),u=function({network:e}){return()=>{const t=e.try();return null!=t&&Boolean(t.libp2p.isStarted())}}({network:a}),h=new ls(s),p=Object.values(P.RY);(s.ipld&&s.ipld.hashers?s.ipld.hashers:[]).forEach((e=>p.push(e))),this.hashers=new Mf.i({hashers:p,loadHasher:s.ipld&&s.ipld.loadHasher});const f=Object.values(P.Fo);(s.ipld&&s.ipld.bases?s.ipld.bases:[]).forEach((e=>f.push(e))),this.bases=new Nf.g({bases:f,loadBase:s.ipld&&s.ipld.loadBase});const y=new Wt({repo:o,codecs:n}),g=new ro({codecs:n,hashers:this.hashers,preload:l,repo:o}),m=new _s({dns:d,ipns:h,repo:o,codecs:n,peerId:r,isOnline:u,keychain:i,options:s}),w=$t({repo:o,codecs:n,bases:this.bases,name:m}),b=new pc({repo:o,codecs:n,hashers:this.hashers,preload:l}),_=Object.assign(Ss({repo:o,codecs:n,resolve:w,preload:l}),{local:Is({repo:t.repo})}),{add:E,addAll:v,cat:S,get:k,ls:R}=new va({preload:l,repo:o,options:s.EXPERIMENTAL,hashers:this.hashers}),T=id({repo:o,preload:l,hashers:this.hashers,options:s}),I=function({preload:e,files:t,options:n={}}){if(n.interval=n.interval||3e4,!n.enabled){Ec("MFS preload disabled");const e=async()=>{};return{start:e,stop:e}}let s,r="";const o=async()=>{try{const n=await t.stat("/"),s=n.cid.toString();r!==s&&(Ec(`preloading updated MFS root ${r} -> ${n.cid}`),await e(n.cid),r=s)}catch(e){Ec.error("failed to preload MFS root",e)}finally{s=setTimeout(o,n.interval)}};return{async start(){const e=await t.stat("/");r=e.cid.toString(),Ec(`monitoring MFS root ${e.cid}`),s=setTimeout(o,n.interval)},stop(){clearTimeout(s)}}}({files:T,preload:l,options:s.preload});this.preload=l,this.name=m,this.ipns=h,this.pin=y,this.resolve=w,this.block=g,this.refs=_,this.start=function({network:e,preload:t,peerId:n,keychain:s,repo:r,ipns:o,mfsPreload:i,print:a,hashers:c,options:l}){return async()=>{const{libp2p:d}=await Lt.start(e,{peerId:n,repo:r,print:a,hashers:c,options:l});await Promise.all([o.startOnline({keychain:s,libp2p:d,peerId:n,repo:r}),t.start(),i.start()])}}({network:a,peerId:r,repo:o,preload:l,ipns:h,mfsPreload:I,print:e,keychain:i,hashers:this.hashers,options:s}),this.stop=function({network:e,preload:t,ipns:n,repo:s,mfsPreload:r}){return async()=>{await Promise.all([t.stop(),n.stop(),r.stop()]),await Lt.stop(e),await s.close()}}({network:a,preload:l,mfsPreload:I,ipns:h,repo:o}),this.dht=function({network:e,repo:t,peerId:n}){const{get:s,put:r,findProvs:o,findPeer:i,provide:a,query:l}={async*get(t,s={}){const{libp2p:r}=await yP(e,n,s),o=t instanceof Uint8Array?t:fP(t);if(null==r.dht)throw c(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");yield*r.dht.get(o,s)},async*put(t,s,r){const{libp2p:o}=await yP(e,n,r),i=t instanceof Uint8Array?t:fP(t);if(null==o.dht)throw c(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");yield*o.dht.put(i,s,r)},async*findProvs(t,s={}){const{libp2p:r}=await yP(e,n,s);if(null==r.dht)throw c(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");yield*r.dht.findProviders(t,{signal:s.signal})},async*findPeer(t,s={}){const{libp2p:r}=await yP(e,n,s);if(null==r.dht)throw c(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");yield*r.dht.findPeer(t,{signal:s.signal})},async*provide(s,r={recursive:!1}){const{libp2p:o}=await yP(e,n,r);if(!await t.blocks.has(s))throw c(new Error("block(s) not found locally, cannot provide"),"ERR_BLOCK_NOT_FOUND");if(r.recursive)throw c(new Error("not implemented yet"),"ERR_NOT_IMPLEMENTED_YET");if(null==o.dht)throw c(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");yield*o.dht.provide(s)},async*query(t,s={}){const{libp2p:r}=await yP(e,n,s);let o;const i=J.TO.asCID(t);if(o=null!=i?i.multihash.bytes:(0,Ht.XL)(t.toString()).toBytes(),null==r.dht)throw c(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");yield*r.dht.getClosestPeers(o,s)}};return{get:St(s),put:St(r),findProvs:St(o),findPeer:St(i),provide:St(a),query:St(l)}}({network:a,repo:o,peerId:r}),this.pubsub=function({network:e,config:t}){const n=Jn(t||{},"Pubsub.Enabled",!0),s={};let r;return{subscribe:n?St((async function(t,n,o={}){const{libp2p:i}=await e.use(o);i.pubsub.subscribe(t),null==r&&(r=e=>{const t=e.detail;s[t.topic]&&s[t.topic].forEach((e=>{"function"!=typeof e?null!=e&&null!=e.handleEvent&&e.handleEvent(t):e(t)}))},i.pubsub.addEventListener("message",r)),null!=n&&(null==s[t]&&(s[t]=[]),s[t].push(n))})):gP,unsubscribe:n?St((async function(t,n,o={}){const{libp2p:i}=await e.use(o);null!=n&&null!=s[t]&&(s[t]=s[t].filter((e=>e!==n)),0===s[t].length&&delete s[t]),"function"!=typeof n&&delete s[t],null==s[t]&&i.pubsub.unsubscribe(t),0===Object.keys(s).length&&(i.pubsub.removeEventListener("message",r),r=void 0)})):gP,publish:n?St((async function(t,n,s={}){const{libp2p:r}=await e.use(s);if(!n)throw c(new Error('argument "data" is required'),"ERR_ARG_REQUIRED");await r.pubsub.publish(t,n)})):gP,ls:n?St((async function(t={}){const{libp2p:n}=await e.use(t);return n.pubsub.getTopics()})):gP,peers:n?St((async function(t,n={}){const{libp2p:s}=await e.use(n);return s.pubsub.getSubscribers(t)})):gP}}({network:a,config:s.config}),this.dns=d,this.isOnline=u,this.id=Ra({network:a,peerId:r}),this.version=function({repo:e}){return St((async function(t={}){const n=await e.version.get();return{version:Sa,commit:"",repo:`${n}`,"ipfs-core":Sa,"interface-ipfs-core":"^0.158.0"}}))}({repo:o}),this.bitswap=new As({network:a}),this.bootstrap=new Wr({repo:o}),this.config=function({repo:e}){return{getAll:St((async function(t={}){return e.config.getAll(t)})),get:St((async function(t,n){return t?e.config.get(t,n):Promise.reject(new Error("key argument is required"))})),set:St((async function(t,n,s){return e.config.set(t,n,s)})),replace:St((async function(t,n){return e.config.replace(t,n)})),profiles:{apply:St((async function(t,n={dryRun:!1}){const{dryRun:s}=n,r=Pa[t];if(!r)throw new Error(`No profile with name '${t}' exists`);try{const t=await e.config.getAll(n);let o=JSON.parse(JSON.stringify(t));return o=r.transform(o),s||await e.config.replace(o,n),delete t.Identity.PrivKey,delete o.Identity.PrivKey,{original:t,updated:o}}catch(e){throw Aa(e),new Error(`Could not apply profile '${t}' to config: ${e.message}`)}})),list:St(Da)}}}({repo:o}),this.ping=function({network:e}){return St((async function*(t,n={}){const{libp2p:s}=await e.use();n.count=n.count||10;const r=await s.peerStore.get(t);let o=r&&r.id;if(!o){yield{...hP,text:`Looking up peer ${t}`};const e=await s.peerRouting.findPeer(t);o=e&&e.id}if(!o)throw new Error("Peer was not found");yield{...hP,text:`PING ${o.toString()}`};let i=0,a=0;for(let e=0;e<n.count;e++)try{const e=await s.ping(o);a+=e,i++,yield{...hP,time:e}}catch(e){yield{...hP,success:!1,text:e.toString()}}if(i){const e=a/i;yield{...hP,text:`Average latency: ${e}ms`}}}))}({network:a}),this.add=E,this.addAll=v,this.cat=S,this.get=k,this.ls=R,this.dag=b,this.files=T,this.key=new cd({keychain:i}),this.object=new fd({preload:l,codecs:n,repo:o}),this.repo=new wd({repo:o,hashers:this.hashers}),this.stats=new _d({repo:o,network:a}),this.swarm=new uP({network:a}),Object.defineProperty(this,"libp2p",{get(){const e=a.try();return e?e.libp2p:void 0}});const A=()=>Promise.reject(c(new Error("Not implemented"),"ERR_NOT_IMPLEMENTED"));this.commands=A,this.diag={cmds:A,net:A,sys:A},this.log={level:A,ls:A,tail:async function*(){throw c(new Error("Not implemented"),"ERR_NOT_IMPLEMENTED")}},this.mount=A,this.codecs=n}async init(){throw new O}}n(97429);const EP=async function(e={}){const t=(e=wP({start:!0,EXPERIMENTAL:{},preload:{enabled:!i.isTest,addresses:["/dns4/node0.preload.ipfs.io/https","/dns4/node1.preload.ipfs.io/https","/dns4/node2.preload.ipfs.io/https","/dns4/node3.preload.ipfs.io/https"]}},e)).init||{},n={name:I.identity.name,code:I.identity.code,encode:e=>e,decode:e=>e},s=Object.values(P.qr);[S,k,R,T,n].concat(e.ipld&&e.ipld.codecs||[]).forEach((e=>s.push(e)));const r=new Lf.l({codecs:s,loadCodec:e.ipld&&e.ipld.loadCodec}),o=e.silent?bP:mP.log;bP("creating repo");const a=await oI.start(o,r,e);bP("getting repo config");const l=await a.repo.config.getAll(),d=new _P({storage:a,print:o,codecs:r,options:{...e,config:l}});if(bP("starting preload"),await d.preload.start(),bP("starting storage"),d.ipns.startOffline(a),a.isNew&&!t.emptyRepo){const e=await(async e=>{const t=S.encode({Data:new v({type:"directory"}).marshal(),Links:[]}),n=await e.block.put(t,{mhtype:"sha2-256",format:"dag-pb"});return await e.pin.add(n),n})(d);if(bP("adding default assets"),await void d.addAll,bP("initializing IPNS keyspace"),null==a.peerId.publicKey)throw c(new Error("Public key missing"),"ERR_MISSING_PUBLIC_KEY");const t=new B.TimeoutController(3e4);try{await d.ipns.initializeKeyspace(a.peerId,(0,x.s)(`/ipfs/${e}`),{signal:t.signal})}finally{t.clear()}}return!1!==e.start&&(bP("starting node"),await d.start()),d}},9842:function(e,t,n){"use strict";function s(e){return/^127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(e)||/^::1$/.test(e)}n.d(t,{l:function(){return s}})},43744:function(e,t,n){"use strict";n.d(t,{A:function(){return i}});const s=Object.prototype.toString,r=e=>"[object Error]"===s.call(e),o=new Set(["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Load failed","Network request failed","fetch failed"]);function i(e){return!(!e||!r(e)||"TypeError"!==e.name||"string"!=typeof e.message)&&("Load failed"===e.message?void 0===e.stack:o.has(e.message))}},87721:function(e,t,n){"use strict";var s=n(40859),r=n(97313);const o=1048576,i=(e,t)=>{t.append(e)};t.A=async function*(e,t={}){let n=new s.I,a=!1,c=(0,r.A)(),l=Number(t.size??o);(isNaN(l)||0===l||l<0)&&(l=o);const d=t.yieldAfter??0,u=t.serialize??i;for(Promise.resolve().then((async()=>{try{let t;for await(const s of e)u(s,n),n.byteLength>=l?(clearTimeout(t),c.resolve()):t=setTimeout((()=>{c.resolve()}),d);clearTimeout(t),c.resolve()}catch(e){c.reject(e)}finally{a=!0}}));!a;)if(await c.promise,c=(0,r.A)(),n.byteLength>0){const e=n;n=new s.I,yield e.subarray()}}},8306:function(e,t,n){"use strict";async function s(e){for await(const t of e);}n.d(t,{A:function(){return s}})},40506:function(e,t,n){"use strict";async function*s(e,t){for await(const n of e)await t(n)&&(yield n)}n.d(t,{A:function(){return s}})},89230:function(e,t,n){"use strict";async function s(e){for await(const t of e)return t}n.d(t,{A:function(){return s}})},62808:function(e,t,n){"use strict";async function s(e){let t;for await(const n of e)t=n;return t}n.d(t,{A:function(){return s}})},89585:function(e,t,n){"use strict";n.d(t,{V:function(){return g}});var s=n(97313);class r{buffer;mask;top;btm;next;constructor(e){if(!(e>0)||0!=(e-1&e))throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return void 0===this.buffer[this.top]&&(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){const e=this.buffer[this.btm];if(void 0!==e)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return void 0===this.buffer[this.btm]}}class o{size;hwm;head;tail;constructor(e={}){this.hwm=e.splitLimit??16,this.head=new r(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return null!=e?.byteLength?e.byteLength:1}push(e){if(null!=e?.value&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){const t=this.head;this.head=t.next=new r(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(void 0===e&&null!=this.tail.next){const t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return null!=e?.value&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}}class i extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}}function a(e,t){let n,r,a,c=(t=t??{}).onEnd,l=new o,d=(0,s.A)();const u=e=>null!=r?r(e):(l.push(e),n),h=e=>{if(a)return n;if(!0!==t?.objectMode&&null==e?.byteLength)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return u({done:!1,value:e})},p=e=>a?n:(a=!0,null!=e?(e=>(l=new o,null!=r?r({error:e}):(l.push({error:e}),n)))(e):u({done:!0}));if(n={[Symbol.asyncIterator](){return this},next:async()=>{try{return l.isEmpty()?a?{done:!0}:await new Promise(((t,s)=>{r=o=>{r=null,l.push(o);try{t(e(l))}catch(e){s(e)}return n}})):e(l)}finally{l.isEmpty()&&queueMicrotask((()=>{d.resolve(),d=(0,s.A)()}))}},return:()=>(l=new o,p(),{done:!0}),throw:e=>(p(e),{done:!0}),push:h,end:p,get readableLength(){return l.size},onEmpty:async e=>{const t=e?.signal;if(t?.throwIfAborted(),l.isEmpty())return;let n,s;null!=t&&(n=new Promise(((e,n)=>{s=()=>{n(new i)},t.addEventListener("abort",s)})));try{await Promise.race([d.promise,n])}finally{null!=s&&null!=t&&t?.removeEventListener("abort",s)}}},null==c)return n;const f=n;return n={[Symbol.asyncIterator](){return this},next:()=>f.next(),throw:e=>(f.throw(e),null!=c&&(c(e),c=void 0),{done:!0}),return:()=>(f.return(),null!=c&&(c(),c=void 0),{done:!0}),push:h,end:e=>(f.end(e),null!=c&&(c(e),c=void 0),n),get readableLength(){return f.readableLength}},n}var c=n(40859);class l extends Error{code;constructor(e,t){super(e),this.code=t}}class d extends l{type;constructor(e){super(e,"ABORT_ERR"),this.type="aborted"}}function u(e){const t=function(e={}){return a((e=>{const t=e.shift();if(null==t)return{done:!0};if(null!=t.error)throw t.error;return{done:!0===t.done,value:t.value}}),e)}();e.sink(t).catch((e=>{t.end(e)})),e.sink=async e=>{for await(const n of e)t.push(n);t.end()};let n=e.source;null!=e.source[Symbol.iterator]?n=e.source[Symbol.iterator]():null!=e.source[Symbol.asyncIterator]&&(n=e.source[Symbol.asyncIterator]());const s=new c.I;return{read:async(e,t)=>{let r;t?.signal?.throwIfAborted();const o=new Promise(((e,n)=>{r=()=>{n(new d("Read aborted"))},t?.signal?.addEventListener("abort",r)}));try{if(null==e){const{done:e,value:t}=await Promise.race([n.next(),o]);return!0===e?new c.I:t}for(;s.byteLength<e;){const{value:e,done:t}=await Promise.race([n.next(),o]);if(!0===t)throw new l("unexpected end of input","ERR_UNEXPECTED_EOF");s.append(e)}const t=s.sublist(0,e);return s.consume(e),t}finally{null!=r&&t?.signal?.removeEventListener("abort",r)}},write:async(e,n)=>{n?.signal?.throwIfAborted(),e instanceof Uint8Array?t.push(e):t.push(e.subarray()),await t.onEmpty(n)},unwrap:()=>{const t=e.source;return e.source=async function*(){yield*s,yield*t}(),e}}}var h=n(89754),p=n(38231);class f extends Error{code;constructor(e,t){super(e),this.code=t}}const y=e=>p.D4(e);function g(e,t){const n=u(e);return{read:async e=>{let s=-1;const r=new c.I,o=t?.lengthDecoder??y;for(;;){r.append(await n.read(1,e));try{s=o(r)}catch(e){if(e instanceof RangeError)continue;throw e}if(s>-1)break;if(null!=t?.maxLengthLength&&r.byteLength>t.maxLengthLength)throw new f("message length length too long","ERR_MSG_LENGTH_TOO_LONG")}if(null!=t?.maxDataLength&&s>t.maxDataLength)throw new f("message length too long","ERR_MSG_DATA_TOO_LONG");return n.read(s,e)},write:async(e,s)=>{await n.write(h.l.single(e,t),s)},unwrap:()=>n.unwrap()}}y.bytes=0},89754:function(e,t,n){"use strict";n.d(t,{D:function(){return f},l:function(){return c}});var s=n(38231),r=n(40859),o=n(10167);function i(e){return null!=e[Symbol.asyncIterator]}const a=e=>{const t=s.OY(e),n=(0,o.K)(t);return s.lF(e,n),a.bytes=t,n};function c(e,t){const n=(t=t??{}).lengthEncoder??a;function*s(e){const t=n(e.byteLength);t instanceof Uint8Array?yield t:yield*t,e instanceof Uint8Array?yield e:yield*e}return i(e)?async function*(){for await(const t of e)yield*s(t)}():function*(){for(const t of e)yield*s(t)}()}a.bytes=0,c.single=(e,t)=>{const n=(t=t??{}).lengthEncoder??a;return new r.I(n(e.byteLength),e)};var l=n(66310);const d=8,u=4194304;var h;!function(e){e[e.LENGTH=0]="LENGTH",e[e.DATA=1]="DATA"}(h||(h={}));const p=e=>{const t=s.D4(e);return p.bytes=s.OY(t),t};function f(e,t){const n=new r.I;let s=h.LENGTH,o=-1;const a=t?.lengthDecoder??p,c=t?.maxLengthLength??d,f=t?.maxDataLength??u;function*y(){for(;n.byteLength>0;){if(s===h.LENGTH)try{if(o=a(n),o<0)throw l(new Error("invalid message length"),"ERR_INVALID_MSG_LENGTH");if(o>f)throw l(new Error("message length too long"),"ERR_MSG_DATA_TOO_LONG");const e=a.bytes;n.consume(e),null!=t?.onLength&&t.onLength(o),s=h.DATA}catch(e){if(e instanceof RangeError){if(n.byteLength>c)throw l(new Error("message length length too long"),"ERR_MSG_LENGTH_TOO_LONG");break}throw e}if(s===h.DATA){if(n.byteLength<o)break;const e=n.sublist(0,o);n.consume(o),null!=t?.onData&&t.onData(e),yield e,s=h.LENGTH}}}return i(e)?async function*(){for await(const t of e)n.append(t),yield*y();if(n.byteLength>0)throw l(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}():function*(){for(const t of e)n.append(t),yield*y();if(n.byteLength>0)throw l(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}()}p.bytes=0,f.fromReader=(e,t)=>{let n=1;return f(async function*(){for(;;)try{const{done:t,value:s}=await e.next(n);if(!0===t)return;null!=s&&(yield s)}catch(e){if("ERR_UNDER_READ"===e.code)return{done:!0,value:null};throw e}finally{n=1}}(),{...t??{},onLength:e=>{n=e}})}},47390:function(e,t,n){"use strict";async function*s(e,t){for await(const n of e)yield t(n)}n.d(t,{A:function(){return s}})},67631:function(e,t,n){"use strict";n.d(t,{A:function(){return r}});var s=n(48651);async function*r(...e){const t=(0,s.N)({objectMode:!0});Promise.resolve().then((async()=>{try{await Promise.all(e.map((async e=>{for await(const n of e)t.push(n)}))),t.end()}catch(e){t.end(e)}})),yield*t}},48209:function(e,t,n){"use strict";n.d(t,{A:function(){return o}});var s=n(97313);const r=globalThis.CustomEvent??Event;async function*o(e,t={}){let n=t.concurrency??1/0;n<1&&(n=1/0);const o=null!=t.ordered&&t.ordered,i=new EventTarget,a=[];let c,l=(0,s.A)(),d=(0,s.A)(),u=!1,h=!1;function p(){return o?a[0]?.done:Boolean(a.find((e=>e.done)))}function*f(){for(;a.length>0&&a[0].done;){const e=a[0];if(a.shift(),!e.ok)throw h=!0,l.resolve(),e.err;yield e.value,l.resolve()}}function*y(){for(;p();)for(let e=0;e<a.length;e++)if(a[e].done){const t=a[e];if(a.splice(e,1),e--,!t.ok)throw h=!0,l.resolve(),t.err;yield t.value,l.resolve()}}for(i.addEventListener("task-complete",(()=>{d.resolve()})),Promise.resolve().then((async()=>{try{for await(const t of e){if(a.length===n&&(l=(0,s.A)(),await l.promise),h)break;const e={done:!1};a.push(e),t().then((t=>{e.done=!0,e.ok=!0,e.value=t,i.dispatchEvent(new r("task-complete"))}),(t=>{e.done=!0,e.err=t,i.dispatchEvent(new r("task-complete"))}))}u=!0,i.dispatchEvent(new r("task-complete"))}catch(e){c=e,i.dispatchEvent(new r("task-complete"))}}));;){if(p()||(d=(0,s.A)(),await d.promise),null!=c)throw c;if(o?yield*f():yield*y(),u&&0===a.length)break}}},97101:function(e,t){"use strict";t.A=function(e){const[t,n]=null!=e[Symbol.asyncIterator]?[e[Symbol.asyncIterator](),Symbol.asyncIterator]:[e[Symbol.iterator](),Symbol.iterator],s=[];return{peek:()=>t.next(),push:e=>{s.push(e)},next:()=>s.length>0?{done:!1,value:s.shift()}:t.next(),[n](){return this}}}},81033:function(e,t,n){"use strict";n.d(t,{F:function(){return d}});var s=n(97313);class r{buffer;mask;top;btm;next;constructor(e){if(!(e>0)||0!=(e-1&e))throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return void 0===this.buffer[this.top]&&(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){const e=this.buffer[this.btm];if(void 0!==e)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return void 0===this.buffer[this.btm]}}class o{size;hwm;head;tail;constructor(e={}){this.hwm=e.splitLimit??16,this.head=new r(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return null!=e?.byteLength?e.byteLength:1}push(e){if(null!=e?.value&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){const t=this.head;this.head=t.next=new r(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(void 0===e&&null!=this.tail.next){const t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return null!=e?.value&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}}class i extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}}function a(e={}){return c((e=>{const t=e.shift();if(null==t)return{done:!0};if(null!=t.error)throw t.error;return{done:!0===t.done,value:t.value}}),e)}function c(e,t){let n,r,a,c=(t=t??{}).onEnd,l=new o,d=(0,s.A)();const u=e=>null!=r?r(e):(l.push(e),n),h=e=>{if(a)return n;if(!0!==t?.objectMode&&null==e?.byteLength)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return u({done:!1,value:e})},p=e=>a?n:(a=!0,null!=e?(e=>(l=new o,null!=r?r({error:e}):(l.push({error:e}),n)))(e):u({done:!0}));if(n={[Symbol.asyncIterator](){return this},next:async()=>{try{return l.isEmpty()?a?{done:!0}:await new Promise(((t,s)=>{r=o=>{r=null,l.push(o);try{t(e(l))}catch(e){s(e)}return n}})):e(l)}finally{l.isEmpty()&&queueMicrotask((()=>{d.resolve(),d=(0,s.A)()}))}},return:()=>(l=new o,p(),{done:!0}),throw:e=>(p(e),{done:!0}),push:h,end:p,get readableLength(){return l.size},onEmpty:async e=>{const t=e?.signal;if(t?.throwIfAborted(),l.isEmpty())return;let n,s;null!=t&&(n=new Promise(((e,n)=>{s=()=>{n(new i)},t.addEventListener("abort",s)})));try{await Promise.race([d.promise,n])}finally{null!=s&&null!=t&&t?.removeEventListener("abort",s)}}},null==c)return n;const f=n;return n={[Symbol.asyncIterator](){return this},next:()=>f.next(),throw:e=>(f.throw(e),null!=c&&(c(e),c=void 0),{done:!0}),return:()=>(f.return(),null!=c&&(c(),c=void 0),{done:!0}),push:h,end:e=>(f.end(e),null!=c&&(c(e),c=void 0),n),get readableLength(){return f.readableLength}},n}var l=function(...e){const t=[];for(const n of e)null==n[Symbol.asyncIterator]&&t.push(n);return t.length===e.length?function*(){for(const e of t)yield*e}():async function*(){const t=a({objectMode:!0});Promise.resolve().then((async()=>{try{await Promise.all(e.map((async e=>{for await(const n of e)t.push(n)}))),t.end()}catch(e){t.end(e)}})),yield*t}()};function d(e,...t){if(null==e)throw new Error("Empty pipeline");if(f(e)){const t=e;e=()=>t.source}else if(p(e)||h(e)){const t=e;e=()=>t}const n=[e,...t];if(n.length>1&&f(n[n.length-1])&&(n[n.length-1]=n[n.length-1].sink),n.length>2)for(let e=1;e<n.length-1;e++)f(n[e])&&(n[e]=y(n[e]));return u(...n)}const u=(...e)=>{let t;for(;e.length>0;)t=e.shift()(t);return t},h=e=>null!=e?.[Symbol.asyncIterator],p=e=>null!=e?.[Symbol.iterator],f=e=>null!=e&&(null!=e.sink&&null!=e.source),y=e=>t=>{const n=e.sink(t);if(null!=n?.then){const t=a({objectMode:!0});let s;n.then((()=>{t.end()}),(e=>{t.end(e)}));const r=e.source;if(h(r))s=async function*(){yield*r,t.end()};else{if(!p(r))throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");s=function*(){yield*r,t.end()}}return l(t,s())}return e.source}},37958:function(e,t,n){"use strict";n.d(t,{z:function(){return r}});var s=n(89585);function r(e,t){const n=(0,s.V)(e,t),r={read:async(e,t)=>{const s=await n.read(t);return e.decode(s)},write:async(e,t,s)=>{await n.write(t.encode(e),s)},pb:e=>({read:async t=>r.read(e,t),write:async(t,n)=>r.write(t,e,n),unwrap:()=>r}),unwrap:()=>n.unwrap()};return r}},48651:function(e,t,n){"use strict";n.d(t,{N:function(){return o},$:function(){return i}});class s{constructor(e){if(!(e>0)||0!=(e-1&e))throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return void 0===this.buffer[this.top]&&(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){const e=this.buffer[this.btm];if(void 0!==e)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return void 0===this.buffer[this.btm]}}class r{constructor(e={}){this.hwm=e.splitLimit??16,this.head=new s(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return null!=e?.byteLength?e.byteLength:1}push(e){if(null!=e?.value&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){const t=this.head;this.head=t.next=new s(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(void 0===e&&null!=this.tail.next){const t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return null!=e?.value&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}}function o(e={}){return a((e=>{const t=e.shift();if(null==t)return{done:!0};if(null!=t.error)throw t.error;return{done:!0===t.done,value:t.value}}),e)}function i(e={}){return a((e=>{let t;const n=[];for(;!e.isEmpty()&&(t=e.shift(),null!=t);){if(null!=t.error)throw t.error;!1===t.done&&n.push(t.value)}return null==t?{done:!0}:{done:!0===t.done,value:n}}),e)}function a(e,t){let n,s,o,i=(t=t??{}).onEnd,a=new r;const c=e=>null!=s?s(e):(a.push(e),n),l=e=>{if(o)return n;if(!0!==t?.objectMode&&null==e?.byteLength)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return c({done:!1,value:e})},d=e=>o?n:(o=!0,null!=e?(e=>(a=new r,null!=s?s({error:e}):(a.push({error:e}),n)))(e):c({done:!0}));if(n={[Symbol.asyncIterator](){return this},next:async()=>a.isEmpty()?o?{done:!0}:await new Promise(((t,r)=>{s=o=>{s=null,a.push(o);try{t(e(a))}catch(e){r(e)}return n}})):e(a),return:()=>(a=new r,d(),{done:!0}),throw:e=>(d(e),{done:!0}),push:l,end:d,get readableLength(){return a.size}},null==i)return n;const u=n;return n={[Symbol.asyncIterator](){return this},next:()=>u.next(),throw:e=>(u.throw(e),null!=i&&(i(e),i=void 0),{done:!0}),return:()=>(u.return(),null!=i&&(i(),i=void 0),{done:!0}),push:l,end:e=>(u.end(e),null!=i&&(i(e),i=void 0),n),get readableLength(){return u.readableLength}},n}},22845:function(e,t,n){"use strict";n.d(t,{w:function(){return r}});var s=n(40859);function r(e){const t=async function*(){let t=yield,n=new s.I;for await(const r of e)if(null!=t)for(n.append(r);n.length>=t;){const e=n.sublist(0,t);if(n.consume(t),t=yield e,null==t){n.length>0&&(t=yield n,n=new s.I);break}}else n.append(r),t=yield n,n=new s.I;if(null!=t)throw Object.assign(new Error(`stream ended before ${t} bytes became available`),{code:"ERR_UNDER_READ",buffer:n})}();return t.next(),t}},86602:function(e,t,n){"use strict";async function*s(e,t){const n=await async function(e){const t=[];for await(const n of e)t.push(n);return t}(e);yield*n.sort(t)}n.d(t,{A:function(){return s}})},66213:function(e,t,n){"use strict";async function*s(e,t){let n=0;if(!(t<1))for await(const s of e)if(yield s,n++,n===t)return}n.d(t,{A:function(){return s}})},30994:function(e,t,n){"use strict";n.d(t,{N:function(){return p}});var s=async e=>{if(e.readyState>=2)throw new Error("socket closed");1!==e.readyState&&await new Promise(((t,n)=>{function s(){e.removeEventListener("open",r),e.removeEventListener("error",o)}function r(){s(),t()}function o(t){s(),n(t.error??new Error(`connect ECONNREFUSED ${e.url}`))}e.addEventListener("open",r),e.addEventListener("error",o)}))},r=(e,t)=>{(t=t??{}).closeOnEnd=!1!==t.closeOnEnd;return async n=>{for await(const t of n){try{await s(e)}catch(e){if("socket closed"===e.message)break;throw e}if(e.readyState===e.CLOSING||e.readyState===e.CLOSED)break;e.send(t)}null!=t.closeOnEnd&&e.readyState<=1&&await new Promise(((t,n)=>{e.addEventListener("close",(e=>{if(e.wasClean||1006===e.code)t();else{const t=Object.assign(new Error("ws error"),{event:e});n(t)}})),setTimeout((()=>{e.close()}))}))}},o=n(60544),i=n(16676);function a(e){return e instanceof ArrayBuffer||"ArrayBuffer"===e?.constructor?.name&&"number"==typeof e?.byteLength}var c=(e,t)=>{t=t??{};const n=(e=>{e.binaryType="arraybuffer";const t=async()=>{await new Promise(((t,n)=>{if(r)return void t();if(null!=s)return void n(s);const o=t=>{e.removeEventListener("open",i),e.removeEventListener("error",a),t()},i=()=>{o(t)},a=t=>{o((()=>{n(t.error??new Error(`connect ECONNREFUSED ${e.url}`))}))};e.addEventListener("open",i),e.addEventListener("error",a)}))},n=async function*(){const n=new o.PP((({push:t,stop:n,fail:s})=>{const r=e=>{let n=null;"string"==typeof e.data&&(n=(0,i.s)(e.data)),a(e.data)&&(n=new Uint8Array(e.data)),e.data instanceof Uint8Array&&(n=e.data),null!=n&&t(n)},o=e=>{s(e.error??new Error("Socket error"))};return e.addEventListener("message",r),e.addEventListener("error",o),e.addEventListener("close",n),()=>{e.removeEventListener("message",r),e.removeEventListener("error",o),e.removeEventListener("close",n)}}),{highWaterMark:1/0});await t();for await(const e of n)yield a(e)?new Uint8Array(e):e}();let s,r=1===e.readyState;return e.addEventListener("open",(()=>{r=!0,s=null})),e.addEventListener("close",(()=>{r=!1,s=null})),e.addEventListener("error",(t=>{r||(s=t.error??new Error(`connect ECONNREFUSED ${e.url}`))})),Object.assign(n,{connected:t})})(e);let s=t.remoteAddress,c=t.remotePort;if(null!=e.url)try{const t=new URL(e.url);s=t.hostname,c=parseInt(t.port,10)}catch{}if(null==s||null==c)throw new Error("Remote connection did not have address and/or port");return{sink:r(e,t),source:n,connected:async()=>{await n.connected()},close:async()=>{e.readyState!==e.CONNECTING&&e.readyState!==e.OPEN||await new Promise((t=>{e.addEventListener("close",(()=>{t()})),e.close()}))},destroy:()=>{null!=e.terminate?e.terminate():e.close()},remoteAddress:s,remotePort:c,socket:e}},l=WebSocket,d=n(26438);const u={http:"ws",https:"wss"};var h=(e,t)=>(0,d.relative)(e,t,u,"ws");function p(e,t){const n="undefined"==typeof window?"":window.location;t=t??{};const s=h(e,n.toString()),r=new l(s,t.websocket);return c(r,t)}}}]);
//# sourceMappingURL=112.d76914ce.chunk.js.map