(self.webpackChunkcyb=self.webpackChunkcyb||[]).push([[937],{19221:function(t){t.exports=function t(r,s){var o,i=0,a=0,c=s=s||0,l=r.length;do{if(c>=l||a>49)throw t.bytes=0,new RangeError("Could not decode varint");o=r[c++],i+=a<28?(o&n)<<a:(o&n)*Math.pow(2,a),a+=7}while(o>=e);return t.bytes=c-s,i};var e=128,n=127},1246:function(t){t.exports=function t(s,o,i){if(Number.MAX_SAFE_INTEGER&&s>Number.MAX_SAFE_INTEGER)throw t.bytes=0,new RangeError("Could not encode varint");o=o||[];var a=i=i||0;for(;s>=r;)o[i++]=255&s|e,s/=128;for(;s&n;)o[i++]=255&s|e,s>>>=7;return o[i]=0|s,t.bytes=i-a+1,o};var e=128,n=-128,r=Math.pow(2,31)},89003:function(t,e,n){t.exports={encode:n(1246),decode:n(19221),encodingLength:n(98641)}},98641:function(t){var e=Math.pow(2,7),n=Math.pow(2,14),r=Math.pow(2,21),s=Math.pow(2,28),o=Math.pow(2,35),i=Math.pow(2,42),a=Math.pow(2,49),c=Math.pow(2,56),l=Math.pow(2,63);t.exports=function(t){return t<e?1:t<n?2:t<r?3:t<s?4:t<o?5:t<i?6:t<a?7:t<c?8:t<l?9:10}},25853:function(t,e,n){"use strict";t.exports=n(5092)},5092:function(t,e,n){"use strict";var r=e;function s(){r.util._configure(),r.Writer._configure(r.BufferWriter),r.Reader._configure(r.BufferReader)}r.build="minimal",r.Writer=n(40834),r.BufferWriter=n(88832),r.Reader=n(96115),r.BufferReader=n(86890),r.util=n(27957),r.rpc=n(43825),r.roots=n(34954),r.configure=s,s()},96115:function(t,e,n){"use strict";t.exports=c;var r,s=n(27957),o=s.LongBits,i=s.utf8;function a(t,e){return RangeError("index out of range: "+t.pos+" + "+(e||1)+" > "+t.len)}function c(t){this.buf=t,this.pos=0,this.len=t.length}var l,u="undefined"!=typeof Uint8Array?function(t){if(t instanceof Uint8Array||Array.isArray(t))return new c(t);throw Error("illegal buffer")}:function(t){if(Array.isArray(t))return new c(t);throw Error("illegal buffer")},d=function(){return s.Buffer?function(t){return(c.create=function(t){return s.Buffer.isBuffer(t)?new r(t):u(t)})(t)}:u};function h(){var t=new o(0,0),e=0;if(!(this.len-this.pos>4)){for(;e<3;++e){if(this.pos>=this.len)throw a(this);if(t.lo=(t.lo|(127&this.buf[this.pos])<<7*e)>>>0,this.buf[this.pos++]<128)return t}return t.lo=(t.lo|(127&this.buf[this.pos++])<<7*e)>>>0,t}for(;e<4;++e)if(t.lo=(t.lo|(127&this.buf[this.pos])<<7*e)>>>0,this.buf[this.pos++]<128)return t;if(t.lo=(t.lo|(127&this.buf[this.pos])<<28)>>>0,t.hi=(t.hi|(127&this.buf[this.pos])>>4)>>>0,this.buf[this.pos++]<128)return t;if(e=0,this.len-this.pos>4){for(;e<5;++e)if(t.hi=(t.hi|(127&this.buf[this.pos])<<7*e+3)>>>0,this.buf[this.pos++]<128)return t}else for(;e<5;++e){if(this.pos>=this.len)throw a(this);if(t.hi=(t.hi|(127&this.buf[this.pos])<<7*e+3)>>>0,this.buf[this.pos++]<128)return t}throw Error("invalid varint encoding")}function p(t,e){return(t[e-4]|t[e-3]<<8|t[e-2]<<16|t[e-1]<<24)>>>0}function f(){if(this.pos+8>this.len)throw a(this,8);return new o(p(this.buf,this.pos+=4),p(this.buf,this.pos+=4))}c.create=d(),c.prototype._slice=s.Array.prototype.subarray||s.Array.prototype.slice,c.prototype.uint32=(l=4294967295,function(){if(l=(127&this.buf[this.pos])>>>0,this.buf[this.pos++]<128)return l;if(l=(l|(127&this.buf[this.pos])<<7)>>>0,this.buf[this.pos++]<128)return l;if(l=(l|(127&this.buf[this.pos])<<14)>>>0,this.buf[this.pos++]<128)return l;if(l=(l|(127&this.buf[this.pos])<<21)>>>0,this.buf[this.pos++]<128)return l;if(l=(l|(15&this.buf[this.pos])<<28)>>>0,this.buf[this.pos++]<128)return l;if((this.pos+=5)>this.len)throw this.pos=this.len,a(this,10);return l}),c.prototype.int32=function(){return 0|this.uint32()},c.prototype.sint32=function(){var t=this.uint32();return t>>>1^-(1&t)|0},c.prototype.bool=function(){return 0!==this.uint32()},c.prototype.fixed32=function(){if(this.pos+4>this.len)throw a(this,4);return p(this.buf,this.pos+=4)},c.prototype.sfixed32=function(){if(this.pos+4>this.len)throw a(this,4);return 0|p(this.buf,this.pos+=4)},c.prototype.float=function(){if(this.pos+4>this.len)throw a(this,4);var t=s.float.readFloatLE(this.buf,this.pos);return this.pos+=4,t},c.prototype.double=function(){if(this.pos+8>this.len)throw a(this,4);var t=s.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,t},c.prototype.bytes=function(){var t=this.uint32(),e=this.pos,n=this.pos+t;if(n>this.len)throw a(this,t);return this.pos+=t,Array.isArray(this.buf)?this.buf.slice(e,n):e===n?new this.buf.constructor(0):this._slice.call(this.buf,e,n)},c.prototype.string=function(){var t=this.bytes();return i.read(t,0,t.length)},c.prototype.skip=function(t){if("number"==typeof t){if(this.pos+t>this.len)throw a(this,t);this.pos+=t}else do{if(this.pos>=this.len)throw a(this)}while(128&this.buf[this.pos++]);return this},c.prototype.skipType=function(t){switch(t){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;4!=(t=7&this.uint32());)this.skipType(t);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+t+" at offset "+this.pos)}return this},c._configure=function(t){r=t,c.create=d(),r._configure();var e=s.Long?"toLong":"toNumber";s.merge(c.prototype,{int64:function(){return h.call(this)[e](!1)},uint64:function(){return h.call(this)[e](!0)},sint64:function(){return h.call(this).zzDecode()[e](!1)},fixed64:function(){return f.call(this)[e](!0)},sfixed64:function(){return f.call(this)[e](!1)}})}},86890:function(t,e,n){"use strict";t.exports=o;var r=n(96115);(o.prototype=Object.create(r.prototype)).constructor=o;var s=n(27957);function o(t){r.call(this,t)}o._configure=function(){s.Buffer&&(o.prototype._slice=s.Buffer.prototype.slice)},o.prototype.string=function(){var t=this.uint32();return this.buf.utf8Slice?this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+t,this.len)):this.buf.toString("utf-8",this.pos,this.pos=Math.min(this.pos+t,this.len))},o._configure()},34954:function(t){"use strict";t.exports={}},43825:function(t,e,n){"use strict";e.Service=n(64998)},64998:function(t,e,n){"use strict";t.exports=s;var r=n(27957);function s(t,e,n){if("function"!=typeof t)throw TypeError("rpcImpl must be a function");r.EventEmitter.call(this),this.rpcImpl=t,this.requestDelimited=Boolean(e),this.responseDelimited=Boolean(n)}(s.prototype=Object.create(r.EventEmitter.prototype)).constructor=s,s.prototype.rpcCall=function t(e,n,s,o,i){if(!o)throw TypeError("request must be specified");var a=this;if(!i)return r.asPromise(t,a,e,n,s,o);if(a.rpcImpl)try{return a.rpcImpl(e,n[a.requestDelimited?"encodeDelimited":"encode"](o).finish(),(function(t,n){if(t)return a.emit("error",t,e),i(t);if(null!==n){if(!(n instanceof s))try{n=s[a.responseDelimited?"decodeDelimited":"decode"](n)}catch(t){return a.emit("error",t,e),i(t)}return a.emit("data",n,e),i(null,n)}a.end(!0)}))}catch(t){return a.emit("error",t,e),void setTimeout((function(){i(t)}),0)}else setTimeout((function(){i(Error("already ended"))}),0)},s.prototype.end=function(t){return this.rpcImpl&&(t||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this}},91802:function(t,e,n){"use strict";t.exports=s;var r=n(27957);function s(t,e){this.lo=t>>>0,this.hi=e>>>0}var o=s.zero=new s(0,0);o.toNumber=function(){return 0},o.zzEncode=o.zzDecode=function(){return this},o.length=function(){return 1};var i=s.zeroHash="\0\0\0\0\0\0\0\0";s.fromNumber=function(t){if(0===t)return o;var e=t<0;e&&(t=-t);var n=t>>>0,r=(t-n)/4294967296>>>0;return e&&(r=~r>>>0,n=~n>>>0,++n>4294967295&&(n=0,++r>4294967295&&(r=0))),new s(n,r)},s.from=function(t){if("number"==typeof t)return s.fromNumber(t);if(r.isString(t)){if(!r.Long)return s.fromNumber(parseInt(t,10));t=r.Long.fromString(t)}return t.low||t.high?new s(t.low>>>0,t.high>>>0):o},s.prototype.toNumber=function(t){if(!t&&this.hi>>>31){var e=1+~this.lo>>>0,n=~this.hi>>>0;return e||(n=n+1>>>0),-(e+4294967296*n)}return this.lo+4294967296*this.hi},s.prototype.toLong=function(t){return r.Long?new r.Long(0|this.lo,0|this.hi,Boolean(t)):{low:0|this.lo,high:0|this.hi,unsigned:Boolean(t)}};var a=String.prototype.charCodeAt;s.fromHash=function(t){return t===i?o:new s((a.call(t,0)|a.call(t,1)<<8|a.call(t,2)<<16|a.call(t,3)<<24)>>>0,(a.call(t,4)|a.call(t,5)<<8|a.call(t,6)<<16|a.call(t,7)<<24)>>>0)},s.prototype.toHash=function(){return String.fromCharCode(255&this.lo,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,255&this.hi,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},s.prototype.zzEncode=function(){var t=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^t)>>>0,this.lo=(this.lo<<1^t)>>>0,this},s.prototype.zzDecode=function(){var t=-(1&this.lo);return this.lo=((this.lo>>>1|this.hi<<31)^t)>>>0,this.hi=(this.hi>>>1^t)>>>0,this},s.prototype.length=function(){var t=this.lo,e=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return 0===n?0===e?t<16384?t<128?1:2:t<2097152?3:4:e<16384?e<128?5:6:e<2097152?7:8:n<128?9:10}},27957:function(t,e,n){"use strict";var r=e;function s(t,e,n){for(var r=Object.keys(e),s=0;s<r.length;++s)void 0!==t[r[s]]&&n||(t[r[s]]=e[r[s]]);return t}function o(t){function e(t,n){if(!(this instanceof e))return new e(t,n);Object.defineProperty(this,"message",{get:function(){return t}}),Error.captureStackTrace?Error.captureStackTrace(this,e):Object.defineProperty(this,"stack",{value:(new Error).stack||""}),n&&s(this,n)}return e.prototype=Object.create(Error.prototype,{constructor:{value:e,writable:!0,enumerable:!1,configurable:!0},name:{get:function(){return t},set:void 0,enumerable:!1,configurable:!0},toString:{value:function(){return this.name+": "+this.message},writable:!0,enumerable:!1,configurable:!0}}),e}r.asPromise=n(34537),r.base64=n(97419),r.EventEmitter=n(19211),r.float=n(10945),r.inquire=n(67199),r.utf8=n(94997),r.pool=n(76662),r.LongBits=n(91802),r.isNode=Boolean(void 0!==n.g&&n.g&&n.g.process&&n.g.process.versions&&n.g.process.versions.node),r.global=r.isNode&&n.g||"undefined"!=typeof window&&window||"undefined"!=typeof self&&self||this,r.emptyArray=Object.freeze?Object.freeze([]):[],r.emptyObject=Object.freeze?Object.freeze({}):{},r.isInteger=Number.isInteger||function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t},r.isString=function(t){return"string"==typeof t||t instanceof String},r.isObject=function(t){return t&&"object"==typeof t},r.isset=r.isSet=function(t,e){var n=t[e];return!(null==n||!t.hasOwnProperty(e))&&("object"!=typeof n||(Array.isArray(n)?n.length:Object.keys(n).length)>0)},r.Buffer=function(){try{var t=r.inquire("buffer").Buffer;return t.prototype.utf8Write?t:null}catch(t){return null}}(),r._Buffer_from=null,r._Buffer_allocUnsafe=null,r.newBuffer=function(t){return"number"==typeof t?r.Buffer?r._Buffer_allocUnsafe(t):new r.Array(t):r.Buffer?r._Buffer_from(t):"undefined"==typeof Uint8Array?t:new Uint8Array(t)},r.Array="undefined"!=typeof Uint8Array?Uint8Array:Array,r.Long=r.global.dcodeIO&&r.global.dcodeIO.Long||r.global.Long||r.inquire("long"),r.key2Re=/^true|false|0|1$/,r.key32Re=/^-?(?:0|[1-9][0-9]*)$/,r.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,r.longToHash=function(t){return t?r.LongBits.from(t).toHash():r.LongBits.zeroHash},r.longFromHash=function(t,e){var n=r.LongBits.fromHash(t);return r.Long?r.Long.fromBits(n.lo,n.hi,e):n.toNumber(Boolean(e))},r.merge=s,r.lcFirst=function(t){return t.charAt(0).toLowerCase()+t.substring(1)},r.newError=o,r.ProtocolError=o("ProtocolError"),r.oneOfGetter=function(t){for(var e={},n=0;n<t.length;++n)e[t[n]]=1;return function(){for(var t=Object.keys(this),n=t.length-1;n>-1;--n)if(1===e[t[n]]&&void 0!==this[t[n]]&&null!==this[t[n]])return t[n]}},r.oneOfSetter=function(t){return function(e){for(var n=0;n<t.length;++n)t[n]!==e&&delete this[t[n]]}},r.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},r._configure=function(){var t=r.Buffer;t?(r._Buffer_from=t.from!==Uint8Array.from&&t.from||function(e,n){return new t(e,n)},r._Buffer_allocUnsafe=t.allocUnsafe||function(e){return new t(e)}):r._Buffer_from=r._Buffer_allocUnsafe=null}},40834:function(t,e,n){"use strict";t.exports=d;var r,s=n(27957),o=s.LongBits,i=s.base64,a=s.utf8;function c(t,e,n){this.fn=t,this.len=e,this.next=void 0,this.val=n}function l(){}function u(t){this.head=t.head,this.tail=t.tail,this.len=t.len,this.next=t.states}function d(){this.len=0,this.head=new c(l,0,0),this.tail=this.head,this.states=null}var h=function(){return s.Buffer?function(){return(d.create=function(){return new r})()}:function(){return new d}};function p(t,e,n){e[n]=255&t}function f(t,e){this.len=t,this.next=void 0,this.val=e}function y(t,e,n){for(;t.hi;)e[n++]=127&t.lo|128,t.lo=(t.lo>>>7|t.hi<<25)>>>0,t.hi>>>=7;for(;t.lo>127;)e[n++]=127&t.lo|128,t.lo=t.lo>>>7;e[n++]=t.lo}function g(t,e,n){e[n]=255&t,e[n+1]=t>>>8&255,e[n+2]=t>>>16&255,e[n+3]=t>>>24}d.create=h(),d.alloc=function(t){return new s.Array(t)},s.Array!==Array&&(d.alloc=s.pool(d.alloc,s.Array.prototype.subarray)),d.prototype._push=function(t,e,n){return this.tail=this.tail.next=new c(t,e,n),this.len+=e,this},f.prototype=Object.create(c.prototype),f.prototype.fn=function(t,e,n){for(;t>127;)e[n++]=127&t|128,t>>>=7;e[n]=t},d.prototype.uint32=function(t){return this.len+=(this.tail=this.tail.next=new f((t>>>=0)<128?1:t<16384?2:t<2097152?3:t<268435456?4:5,t)).len,this},d.prototype.int32=function(t){return t<0?this._push(y,10,o.fromNumber(t)):this.uint32(t)},d.prototype.sint32=function(t){return this.uint32((t<<1^t>>31)>>>0)},d.prototype.uint64=function(t){var e=o.from(t);return this._push(y,e.length(),e)},d.prototype.int64=d.prototype.uint64,d.prototype.sint64=function(t){var e=o.from(t).zzEncode();return this._push(y,e.length(),e)},d.prototype.bool=function(t){return this._push(p,1,t?1:0)},d.prototype.fixed32=function(t){return this._push(g,4,t>>>0)},d.prototype.sfixed32=d.prototype.fixed32,d.prototype.fixed64=function(t){var e=o.from(t);return this._push(g,4,e.lo)._push(g,4,e.hi)},d.prototype.sfixed64=d.prototype.fixed64,d.prototype.float=function(t){return this._push(s.float.writeFloatLE,4,t)},d.prototype.double=function(t){return this._push(s.float.writeDoubleLE,8,t)};var w=s.Array.prototype.set?function(t,e,n){e.set(t,n)}:function(t,e,n){for(var r=0;r<t.length;++r)e[n+r]=t[r]};d.prototype.bytes=function(t){var e=t.length>>>0;if(!e)return this._push(p,1,0);if(s.isString(t)){var n=d.alloc(e=i.length(t));i.decode(t,n,0),t=n}return this.uint32(e)._push(w,e,t)},d.prototype.string=function(t){var e=a.length(t);return e?this.uint32(e)._push(a.write,e,t):this._push(p,1,0)},d.prototype.fork=function(){return this.states=new u(this),this.head=this.tail=new c(l,0,0),this.len=0,this},d.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new c(l,0,0),this.len=0),this},d.prototype.ldelim=function(){var t=this.head,e=this.tail,n=this.len;return this.reset().uint32(n),n&&(this.tail.next=t.next,this.tail=e,this.len+=n),this},d.prototype.finish=function(){for(var t=this.head.next,e=this.constructor.alloc(this.len),n=0;t;)t.fn(t.val,e,n),n+=t.len,t=t.next;return e},d._configure=function(t){r=t,d.create=h(),r._configure()}},88832:function(t,e,n){"use strict";t.exports=o;var r=n(40834);(o.prototype=Object.create(r.prototype)).constructor=o;var s=n(27957);function o(){r.call(this)}function i(t,e,n){t.length<40?s.utf8.write(t,e,n):e.utf8Write?e.utf8Write(t,n):e.write(t,n)}o._configure=function(){o.alloc=s._Buffer_allocUnsafe,o.writeBytesBuffer=s.Buffer&&s.Buffer.prototype instanceof Uint8Array&&"set"===s.Buffer.prototype.set.name?function(t,e,n){e.set(t,n)}:function(t,e,n){if(t.copy)t.copy(e,n,0,t.length);else for(var r=0;r<t.length;)e[n++]=t[r++]}},o.prototype.bytes=function(t){s.isString(t)&&(t=s._Buffer_from(t,"base64"));var e=t.length>>>0;return this.uint32(e),e&&this._push(o.writeBytesBuffer,e,t),this},o.prototype.string=function(t){var e=s.Buffer.byteLength(t);return this.uint32(e),e&&this._push(i,e,t),this},o._configure()},90088:function(t){t.exports=function t(r,s){var o,i=0,a=0,c=s=s||0,l=r.length;do{if(c>=l||a>49)throw t.bytes=0,new RangeError("Could not decode varint");o=r[c++],i+=a<28?(o&n)<<a:(o&n)*Math.pow(2,a),a+=7}while(o>=e);return t.bytes=c-s,i};var e=128,n=127},98720:function(t){t.exports=function t(s,o,i){if(Number.MAX_SAFE_INTEGER&&s>Number.MAX_SAFE_INTEGER)throw t.bytes=0,new RangeError("Could not encode varint");o=o||[];var a=i=i||0;for(;s>=r;)o[i++]=255&s|e,s/=128;for(;s&n;)o[i++]=255&s|e,s>>>=7;return o[i]=0|s,t.bytes=i-a+1,o};var e=128,n=-128,r=Math.pow(2,31)},26104:function(t,e,n){t.exports={encode:n(98720),decode:n(90088),encodingLength:n(91222)}},91222:function(t){var e=Math.pow(2,7),n=Math.pow(2,14),r=Math.pow(2,21),s=Math.pow(2,28),o=Math.pow(2,35),i=Math.pow(2,42),a=Math.pow(2,49),c=Math.pow(2,56),l=Math.pow(2,63);t.exports=function(t){return t<e?1:t<n?2:t<r?3:t<s?4:t<o?5:t<i?6:t<a?7:t<c?8:t<l?9:10}},67412:function(t,e,n){"use strict";t.exports=n(14036)},14036:function(t,e,n){"use strict";var r=e;function s(){r.util._configure(),r.Writer._configure(r.BufferWriter),r.Reader._configure(r.BufferReader)}r.build="minimal",r.Writer=n(79827),r.BufferWriter=n(28324),r.Reader=n(18550),r.BufferReader=n(41873),r.util=n(25072),r.rpc=n(4239),r.roots=n(98426),r.configure=s,s()},18550:function(t,e,n){"use strict";t.exports=c;var r,s=n(25072),o=s.LongBits,i=s.utf8;function a(t,e){return RangeError("index out of range: "+t.pos+" + "+(e||1)+" > "+t.len)}function c(t){this.buf=t,this.pos=0,this.len=t.length}var l,u="undefined"!=typeof Uint8Array?function(t){if(t instanceof Uint8Array||Array.isArray(t))return new c(t);throw Error("illegal buffer")}:function(t){if(Array.isArray(t))return new c(t);throw Error("illegal buffer")},d=function(){return s.Buffer?function(t){return(c.create=function(t){return s.Buffer.isBuffer(t)?new r(t):u(t)})(t)}:u};function h(){var t=new o(0,0),e=0;if(!(this.len-this.pos>4)){for(;e<3;++e){if(this.pos>=this.len)throw a(this);if(t.lo=(t.lo|(127&this.buf[this.pos])<<7*e)>>>0,this.buf[this.pos++]<128)return t}return t.lo=(t.lo|(127&this.buf[this.pos++])<<7*e)>>>0,t}for(;e<4;++e)if(t.lo=(t.lo|(127&this.buf[this.pos])<<7*e)>>>0,this.buf[this.pos++]<128)return t;if(t.lo=(t.lo|(127&this.buf[this.pos])<<28)>>>0,t.hi=(t.hi|(127&this.buf[this.pos])>>4)>>>0,this.buf[this.pos++]<128)return t;if(e=0,this.len-this.pos>4){for(;e<5;++e)if(t.hi=(t.hi|(127&this.buf[this.pos])<<7*e+3)>>>0,this.buf[this.pos++]<128)return t}else for(;e<5;++e){if(this.pos>=this.len)throw a(this);if(t.hi=(t.hi|(127&this.buf[this.pos])<<7*e+3)>>>0,this.buf[this.pos++]<128)return t}throw Error("invalid varint encoding")}function p(t,e){return(t[e-4]|t[e-3]<<8|t[e-2]<<16|t[e-1]<<24)>>>0}function f(){if(this.pos+8>this.len)throw a(this,8);return new o(p(this.buf,this.pos+=4),p(this.buf,this.pos+=4))}c.create=d(),c.prototype._slice=s.Array.prototype.subarray||s.Array.prototype.slice,c.prototype.uint32=(l=4294967295,function(){if(l=(127&this.buf[this.pos])>>>0,this.buf[this.pos++]<128)return l;if(l=(l|(127&this.buf[this.pos])<<7)>>>0,this.buf[this.pos++]<128)return l;if(l=(l|(127&this.buf[this.pos])<<14)>>>0,this.buf[this.pos++]<128)return l;if(l=(l|(127&this.buf[this.pos])<<21)>>>0,this.buf[this.pos++]<128)return l;if(l=(l|(15&this.buf[this.pos])<<28)>>>0,this.buf[this.pos++]<128)return l;if((this.pos+=5)>this.len)throw this.pos=this.len,a(this,10);return l}),c.prototype.int32=function(){return 0|this.uint32()},c.prototype.sint32=function(){var t=this.uint32();return t>>>1^-(1&t)|0},c.prototype.bool=function(){return 0!==this.uint32()},c.prototype.fixed32=function(){if(this.pos+4>this.len)throw a(this,4);return p(this.buf,this.pos+=4)},c.prototype.sfixed32=function(){if(this.pos+4>this.len)throw a(this,4);return 0|p(this.buf,this.pos+=4)},c.prototype.float=function(){if(this.pos+4>this.len)throw a(this,4);var t=s.float.readFloatLE(this.buf,this.pos);return this.pos+=4,t},c.prototype.double=function(){if(this.pos+8>this.len)throw a(this,4);var t=s.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,t},c.prototype.bytes=function(){var t=this.uint32(),e=this.pos,n=this.pos+t;if(n>this.len)throw a(this,t);return this.pos+=t,Array.isArray(this.buf)?this.buf.slice(e,n):e===n?new this.buf.constructor(0):this._slice.call(this.buf,e,n)},c.prototype.string=function(){var t=this.bytes();return i.read(t,0,t.length)},c.prototype.skip=function(t){if("number"==typeof t){if(this.pos+t>this.len)throw a(this,t);this.pos+=t}else do{if(this.pos>=this.len)throw a(this)}while(128&this.buf[this.pos++]);return this},c.prototype.skipType=function(t){switch(t){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;4!=(t=7&this.uint32());)this.skipType(t);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+t+" at offset "+this.pos)}return this},c._configure=function(t){r=t,c.create=d(),r._configure();var e=s.Long?"toLong":"toNumber";s.merge(c.prototype,{int64:function(){return h.call(this)[e](!1)},uint64:function(){return h.call(this)[e](!0)},sint64:function(){return h.call(this).zzDecode()[e](!1)},fixed64:function(){return f.call(this)[e](!0)},sfixed64:function(){return f.call(this)[e](!1)}})}},41873:function(t,e,n){"use strict";t.exports=o;var r=n(18550);(o.prototype=Object.create(r.prototype)).constructor=o;var s=n(25072);function o(t){r.call(this,t)}o._configure=function(){s.Buffer&&(o.prototype._slice=s.Buffer.prototype.slice)},o.prototype.string=function(){var t=this.uint32();return this.buf.utf8Slice?this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+t,this.len)):this.buf.toString("utf-8",this.pos,this.pos=Math.min(this.pos+t,this.len))},o._configure()},98426:function(t){"use strict";t.exports={}},4239:function(t,e,n){"use strict";e.Service=n(99603)},99603:function(t,e,n){"use strict";t.exports=s;var r=n(25072);function s(t,e,n){if("function"!=typeof t)throw TypeError("rpcImpl must be a function");r.EventEmitter.call(this),this.rpcImpl=t,this.requestDelimited=Boolean(e),this.responseDelimited=Boolean(n)}(s.prototype=Object.create(r.EventEmitter.prototype)).constructor=s,s.prototype.rpcCall=function t(e,n,s,o,i){if(!o)throw TypeError("request must be specified");var a=this;if(!i)return r.asPromise(t,a,e,n,s,o);if(a.rpcImpl)try{return a.rpcImpl(e,n[a.requestDelimited?"encodeDelimited":"encode"](o).finish(),(function(t,n){if(t)return a.emit("error",t,e),i(t);if(null!==n){if(!(n instanceof s))try{n=s[a.responseDelimited?"decodeDelimited":"decode"](n)}catch(t){return a.emit("error",t,e),i(t)}return a.emit("data",n,e),i(null,n)}a.end(!0)}))}catch(t){return a.emit("error",t,e),void setTimeout((function(){i(t)}),0)}else setTimeout((function(){i(Error("already ended"))}),0)},s.prototype.end=function(t){return this.rpcImpl&&(t||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this}},41838:function(t,e,n){"use strict";t.exports=s;var r=n(25072);function s(t,e){this.lo=t>>>0,this.hi=e>>>0}var o=s.zero=new s(0,0);o.toNumber=function(){return 0},o.zzEncode=o.zzDecode=function(){return this},o.length=function(){return 1};var i=s.zeroHash="\0\0\0\0\0\0\0\0";s.fromNumber=function(t){if(0===t)return o;var e=t<0;e&&(t=-t);var n=t>>>0,r=(t-n)/4294967296>>>0;return e&&(r=~r>>>0,n=~n>>>0,++n>4294967295&&(n=0,++r>4294967295&&(r=0))),new s(n,r)},s.from=function(t){if("number"==typeof t)return s.fromNumber(t);if(r.isString(t)){if(!r.Long)return s.fromNumber(parseInt(t,10));t=r.Long.fromString(t)}return t.low||t.high?new s(t.low>>>0,t.high>>>0):o},s.prototype.toNumber=function(t){if(!t&&this.hi>>>31){var e=1+~this.lo>>>0,n=~this.hi>>>0;return e||(n=n+1>>>0),-(e+4294967296*n)}return this.lo+4294967296*this.hi},s.prototype.toLong=function(t){return r.Long?new r.Long(0|this.lo,0|this.hi,Boolean(t)):{low:0|this.lo,high:0|this.hi,unsigned:Boolean(t)}};var a=String.prototype.charCodeAt;s.fromHash=function(t){return t===i?o:new s((a.call(t,0)|a.call(t,1)<<8|a.call(t,2)<<16|a.call(t,3)<<24)>>>0,(a.call(t,4)|a.call(t,5)<<8|a.call(t,6)<<16|a.call(t,7)<<24)>>>0)},s.prototype.toHash=function(){return String.fromCharCode(255&this.lo,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,255&this.hi,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},s.prototype.zzEncode=function(){var t=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^t)>>>0,this.lo=(this.lo<<1^t)>>>0,this},s.prototype.zzDecode=function(){var t=-(1&this.lo);return this.lo=((this.lo>>>1|this.hi<<31)^t)>>>0,this.hi=(this.hi>>>1^t)>>>0,this},s.prototype.length=function(){var t=this.lo,e=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return 0===n?0===e?t<16384?t<128?1:2:t<2097152?3:4:e<16384?e<128?5:6:e<2097152?7:8:n<128?9:10}},25072:function(t,e,n){"use strict";var r=e;function s(t,e,n){for(var r=Object.keys(e),s=0;s<r.length;++s)void 0!==t[r[s]]&&n||(t[r[s]]=e[r[s]]);return t}function o(t){function e(t,n){if(!(this instanceof e))return new e(t,n);Object.defineProperty(this,"message",{get:function(){return t}}),Error.captureStackTrace?Error.captureStackTrace(this,e):Object.defineProperty(this,"stack",{value:(new Error).stack||""}),n&&s(this,n)}return e.prototype=Object.create(Error.prototype,{constructor:{value:e,writable:!0,enumerable:!1,configurable:!0},name:{get:function(){return t},set:void 0,enumerable:!1,configurable:!0},toString:{value:function(){return this.name+": "+this.message},writable:!0,enumerable:!1,configurable:!0}}),e}r.asPromise=n(34537),r.base64=n(97419),r.EventEmitter=n(19211),r.float=n(10945),r.inquire=n(67199),r.utf8=n(94997),r.pool=n(76662),r.LongBits=n(41838),r.isNode=Boolean(void 0!==n.g&&n.g&&n.g.process&&n.g.process.versions&&n.g.process.versions.node),r.global=r.isNode&&n.g||"undefined"!=typeof window&&window||"undefined"!=typeof self&&self||this,r.emptyArray=Object.freeze?Object.freeze([]):[],r.emptyObject=Object.freeze?Object.freeze({}):{},r.isInteger=Number.isInteger||function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t},r.isString=function(t){return"string"==typeof t||t instanceof String},r.isObject=function(t){return t&&"object"==typeof t},r.isset=r.isSet=function(t,e){var n=t[e];return!(null==n||!t.hasOwnProperty(e))&&("object"!=typeof n||(Array.isArray(n)?n.length:Object.keys(n).length)>0)},r.Buffer=function(){try{var t=r.inquire("buffer").Buffer;return t.prototype.utf8Write?t:null}catch(t){return null}}(),r._Buffer_from=null,r._Buffer_allocUnsafe=null,r.newBuffer=function(t){return"number"==typeof t?r.Buffer?r._Buffer_allocUnsafe(t):new r.Array(t):r.Buffer?r._Buffer_from(t):"undefined"==typeof Uint8Array?t:new Uint8Array(t)},r.Array="undefined"!=typeof Uint8Array?Uint8Array:Array,r.Long=r.global.dcodeIO&&r.global.dcodeIO.Long||r.global.Long||r.inquire("long"),r.key2Re=/^true|false|0|1$/,r.key32Re=/^-?(?:0|[1-9][0-9]*)$/,r.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,r.longToHash=function(t){return t?r.LongBits.from(t).toHash():r.LongBits.zeroHash},r.longFromHash=function(t,e){var n=r.LongBits.fromHash(t);return r.Long?r.Long.fromBits(n.lo,n.hi,e):n.toNumber(Boolean(e))},r.merge=s,r.lcFirst=function(t){return t.charAt(0).toLowerCase()+t.substring(1)},r.newError=o,r.ProtocolError=o("ProtocolError"),r.oneOfGetter=function(t){for(var e={},n=0;n<t.length;++n)e[t[n]]=1;return function(){for(var t=Object.keys(this),n=t.length-1;n>-1;--n)if(1===e[t[n]]&&void 0!==this[t[n]]&&null!==this[t[n]])return t[n]}},r.oneOfSetter=function(t){return function(e){for(var n=0;n<t.length;++n)t[n]!==e&&delete this[t[n]]}},r.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},r._configure=function(){var t=r.Buffer;t?(r._Buffer_from=t.from!==Uint8Array.from&&t.from||function(e,n){return new t(e,n)},r._Buffer_allocUnsafe=t.allocUnsafe||function(e){return new t(e)}):r._Buffer_from=r._Buffer_allocUnsafe=null}},79827:function(t,e,n){"use strict";t.exports=d;var r,s=n(25072),o=s.LongBits,i=s.base64,a=s.utf8;function c(t,e,n){this.fn=t,this.len=e,this.next=void 0,this.val=n}function l(){}function u(t){this.head=t.head,this.tail=t.tail,this.len=t.len,this.next=t.states}function d(){this.len=0,this.head=new c(l,0,0),this.tail=this.head,this.states=null}var h=function(){return s.Buffer?function(){return(d.create=function(){return new r})()}:function(){return new d}};function p(t,e,n){e[n]=255&t}function f(t,e){this.len=t,this.next=void 0,this.val=e}function y(t,e,n){for(;t.hi;)e[n++]=127&t.lo|128,t.lo=(t.lo>>>7|t.hi<<25)>>>0,t.hi>>>=7;for(;t.lo>127;)e[n++]=127&t.lo|128,t.lo=t.lo>>>7;e[n++]=t.lo}function g(t,e,n){e[n]=255&t,e[n+1]=t>>>8&255,e[n+2]=t>>>16&255,e[n+3]=t>>>24}d.create=h(),d.alloc=function(t){return new s.Array(t)},s.Array!==Array&&(d.alloc=s.pool(d.alloc,s.Array.prototype.subarray)),d.prototype._push=function(t,e,n){return this.tail=this.tail.next=new c(t,e,n),this.len+=e,this},f.prototype=Object.create(c.prototype),f.prototype.fn=function(t,e,n){for(;t>127;)e[n++]=127&t|128,t>>>=7;e[n]=t},d.prototype.uint32=function(t){return this.len+=(this.tail=this.tail.next=new f((t>>>=0)<128?1:t<16384?2:t<2097152?3:t<268435456?4:5,t)).len,this},d.prototype.int32=function(t){return t<0?this._push(y,10,o.fromNumber(t)):this.uint32(t)},d.prototype.sint32=function(t){return this.uint32((t<<1^t>>31)>>>0)},d.prototype.uint64=function(t){var e=o.from(t);return this._push(y,e.length(),e)},d.prototype.int64=d.prototype.uint64,d.prototype.sint64=function(t){var e=o.from(t).zzEncode();return this._push(y,e.length(),e)},d.prototype.bool=function(t){return this._push(p,1,t?1:0)},d.prototype.fixed32=function(t){return this._push(g,4,t>>>0)},d.prototype.sfixed32=d.prototype.fixed32,d.prototype.fixed64=function(t){var e=o.from(t);return this._push(g,4,e.lo)._push(g,4,e.hi)},d.prototype.sfixed64=d.prototype.fixed64,d.prototype.float=function(t){return this._push(s.float.writeFloatLE,4,t)},d.prototype.double=function(t){return this._push(s.float.writeDoubleLE,8,t)};var w=s.Array.prototype.set?function(t,e,n){e.set(t,n)}:function(t,e,n){for(var r=0;r<t.length;++r)e[n+r]=t[r]};d.prototype.bytes=function(t){var e=t.length>>>0;if(!e)return this._push(p,1,0);if(s.isString(t)){var n=d.alloc(e=i.length(t));i.decode(t,n,0),t=n}return this.uint32(e)._push(w,e,t)},d.prototype.string=function(t){var e=a.length(t);return e?this.uint32(e)._push(a.write,e,t):this._push(p,1,0)},d.prototype.fork=function(){return this.states=new u(this),this.head=this.tail=new c(l,0,0),this.len=0,this},d.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new c(l,0,0),this.len=0),this},d.prototype.ldelim=function(){var t=this.head,e=this.tail,n=this.len;return this.reset().uint32(n),n&&(this.tail.next=t.next,this.tail=e,this.len+=n),this},d.prototype.finish=function(){for(var t=this.head.next,e=this.constructor.alloc(this.len),n=0;t;)t.fn(t.val,e,n),n+=t.len,t=t.next;return e},d._configure=function(t){r=t,d.create=h(),r._configure()}},28324:function(t,e,n){"use strict";t.exports=o;var r=n(79827);(o.prototype=Object.create(r.prototype)).constructor=o;var s=n(25072);function o(){r.call(this)}function i(t,e,n){t.length<40?s.utf8.write(t,e,n):e.utf8Write?e.utf8Write(t,n):e.write(t,n)}o._configure=function(){o.alloc=s._Buffer_allocUnsafe,o.writeBytesBuffer=s.Buffer&&s.Buffer.prototype instanceof Uint8Array&&"set"===s.Buffer.prototype.set.name?function(t,e,n){e.set(t,n)}:function(t,e,n){if(t.copy)t.copy(e,n,0,t.length);else for(var r=0;r<t.length;)e[n++]=t[r++]}},o.prototype.bytes=function(t){s.isString(t)&&(t=s._Buffer_from(t,"base64"));var e=t.length>>>0;return this.uint32(e),e&&this._push(o.writeBytesBuffer,e,t),this},o.prototype.string=function(t){var e=s.Buffer.byteLength(t);return this.uint32(e),e&&this._push(i,e,t),this},o._configure()},77841:function(t){t.exports=function t(r,s){var o,i=0,a=0,c=s=s||0,l=r.length;do{if(c>=l||a>49)throw t.bytes=0,new RangeError("Could not decode varint");o=r[c++],i+=a<28?(o&n)<<a:(o&n)*Math.pow(2,a),a+=7}while(o>=e);return t.bytes=c-s,i};var e=128,n=127},98222:function(t){t.exports=function t(s,o,i){if(Number.MAX_SAFE_INTEGER&&s>Number.MAX_SAFE_INTEGER)throw t.bytes=0,new RangeError("Could not encode varint");o=o||[];var a=i=i||0;for(;s>=r;)o[i++]=255&s|e,s/=128;for(;s&n;)o[i++]=255&s|e,s>>>=7;return o[i]=0|s,t.bytes=i-a+1,o};var e=128,n=-128,r=Math.pow(2,31)},33497:function(t,e,n){t.exports={encode:n(98222),decode:n(77841),encodingLength:n(32510)}},32510:function(t){var e=Math.pow(2,7),n=Math.pow(2,14),r=Math.pow(2,21),s=Math.pow(2,28),o=Math.pow(2,35),i=Math.pow(2,42),a=Math.pow(2,49),c=Math.pow(2,56),l=Math.pow(2,63);t.exports=function(t){return t<e?1:t<n?2:t<r?3:t<s?4:t<o?5:t<i?6:t<a?7:t<c?8:t<l?9:10}},68653:function(t,e,n){"use strict";t.exports=n(82943)},82943:function(t,e,n){"use strict";var r=e;function s(){r.util._configure(),r.Writer._configure(r.BufferWriter),r.Reader._configure(r.BufferReader)}r.build="minimal",r.Writer=n(685),r.BufferWriter=n(43410),r.Reader=n(68184),r.BufferReader=n(87674),r.util=n(43264),r.rpc=n(32988),r.roots=n(19981),r.configure=s,s()},68184:function(t,e,n){"use strict";t.exports=c;var r,s=n(43264),o=s.LongBits,i=s.utf8;function a(t,e){return RangeError("index out of range: "+t.pos+" + "+(e||1)+" > "+t.len)}function c(t){this.buf=t,this.pos=0,this.len=t.length}var l,u="undefined"!=typeof Uint8Array?function(t){if(t instanceof Uint8Array||Array.isArray(t))return new c(t);throw Error("illegal buffer")}:function(t){if(Array.isArray(t))return new c(t);throw Error("illegal buffer")},d=function(){return s.Buffer?function(t){return(c.create=function(t){return s.Buffer.isBuffer(t)?new r(t):u(t)})(t)}:u};function h(){var t=new o(0,0),e=0;if(!(this.len-this.pos>4)){for(;e<3;++e){if(this.pos>=this.len)throw a(this);if(t.lo=(t.lo|(127&this.buf[this.pos])<<7*e)>>>0,this.buf[this.pos++]<128)return t}return t.lo=(t.lo|(127&this.buf[this.pos++])<<7*e)>>>0,t}for(;e<4;++e)if(t.lo=(t.lo|(127&this.buf[this.pos])<<7*e)>>>0,this.buf[this.pos++]<128)return t;if(t.lo=(t.lo|(127&this.buf[this.pos])<<28)>>>0,t.hi=(t.hi|(127&this.buf[this.pos])>>4)>>>0,this.buf[this.pos++]<128)return t;if(e=0,this.len-this.pos>4){for(;e<5;++e)if(t.hi=(t.hi|(127&this.buf[this.pos])<<7*e+3)>>>0,this.buf[this.pos++]<128)return t}else for(;e<5;++e){if(this.pos>=this.len)throw a(this);if(t.hi=(t.hi|(127&this.buf[this.pos])<<7*e+3)>>>0,this.buf[this.pos++]<128)return t}throw Error("invalid varint encoding")}function p(t,e){return(t[e-4]|t[e-3]<<8|t[e-2]<<16|t[e-1]<<24)>>>0}function f(){if(this.pos+8>this.len)throw a(this,8);return new o(p(this.buf,this.pos+=4),p(this.buf,this.pos+=4))}c.create=d(),c.prototype._slice=s.Array.prototype.subarray||s.Array.prototype.slice,c.prototype.uint32=(l=4294967295,function(){if(l=(127&this.buf[this.pos])>>>0,this.buf[this.pos++]<128)return l;if(l=(l|(127&this.buf[this.pos])<<7)>>>0,this.buf[this.pos++]<128)return l;if(l=(l|(127&this.buf[this.pos])<<14)>>>0,this.buf[this.pos++]<128)return l;if(l=(l|(127&this.buf[this.pos])<<21)>>>0,this.buf[this.pos++]<128)return l;if(l=(l|(15&this.buf[this.pos])<<28)>>>0,this.buf[this.pos++]<128)return l;if((this.pos+=5)>this.len)throw this.pos=this.len,a(this,10);return l}),c.prototype.int32=function(){return 0|this.uint32()},c.prototype.sint32=function(){var t=this.uint32();return t>>>1^-(1&t)|0},c.prototype.bool=function(){return 0!==this.uint32()},c.prototype.fixed32=function(){if(this.pos+4>this.len)throw a(this,4);return p(this.buf,this.pos+=4)},c.prototype.sfixed32=function(){if(this.pos+4>this.len)throw a(this,4);return 0|p(this.buf,this.pos+=4)},c.prototype.float=function(){if(this.pos+4>this.len)throw a(this,4);var t=s.float.readFloatLE(this.buf,this.pos);return this.pos+=4,t},c.prototype.double=function(){if(this.pos+8>this.len)throw a(this,4);var t=s.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,t},c.prototype.bytes=function(){var t=this.uint32(),e=this.pos,n=this.pos+t;if(n>this.len)throw a(this,t);return this.pos+=t,Array.isArray(this.buf)?this.buf.slice(e,n):e===n?new this.buf.constructor(0):this._slice.call(this.buf,e,n)},c.prototype.string=function(){var t=this.bytes();return i.read(t,0,t.length)},c.prototype.skip=function(t){if("number"==typeof t){if(this.pos+t>this.len)throw a(this,t);this.pos+=t}else do{if(this.pos>=this.len)throw a(this)}while(128&this.buf[this.pos++]);return this},c.prototype.skipType=function(t){switch(t){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;4!=(t=7&this.uint32());)this.skipType(t);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+t+" at offset "+this.pos)}return this},c._configure=function(t){r=t,c.create=d(),r._configure();var e=s.Long?"toLong":"toNumber";s.merge(c.prototype,{int64:function(){return h.call(this)[e](!1)},uint64:function(){return h.call(this)[e](!0)},sint64:function(){return h.call(this).zzDecode()[e](!1)},fixed64:function(){return f.call(this)[e](!0)},sfixed64:function(){return f.call(this)[e](!1)}})}},87674:function(t,e,n){"use strict";t.exports=o;var r=n(68184);(o.prototype=Object.create(r.prototype)).constructor=o;var s=n(43264);function o(t){r.call(this,t)}o._configure=function(){s.Buffer&&(o.prototype._slice=s.Buffer.prototype.slice)},o.prototype.string=function(){var t=this.uint32();return this.buf.utf8Slice?this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+t,this.len)):this.buf.toString("utf-8",this.pos,this.pos=Math.min(this.pos+t,this.len))},o._configure()},19981:function(t){"use strict";t.exports={}},32988:function(t,e,n){"use strict";e.Service=n(37867)},37867:function(t,e,n){"use strict";t.exports=s;var r=n(43264);function s(t,e,n){if("function"!=typeof t)throw TypeError("rpcImpl must be a function");r.EventEmitter.call(this),this.rpcImpl=t,this.requestDelimited=Boolean(e),this.responseDelimited=Boolean(n)}(s.prototype=Object.create(r.EventEmitter.prototype)).constructor=s,s.prototype.rpcCall=function t(e,n,s,o,i){if(!o)throw TypeError("request must be specified");var a=this;if(!i)return r.asPromise(t,a,e,n,s,o);if(a.rpcImpl)try{return a.rpcImpl(e,n[a.requestDelimited?"encodeDelimited":"encode"](o).finish(),(function(t,n){if(t)return a.emit("error",t,e),i(t);if(null!==n){if(!(n instanceof s))try{n=s[a.responseDelimited?"decodeDelimited":"decode"](n)}catch(t){return a.emit("error",t,e),i(t)}return a.emit("data",n,e),i(null,n)}a.end(!0)}))}catch(t){return a.emit("error",t,e),void setTimeout((function(){i(t)}),0)}else setTimeout((function(){i(Error("already ended"))}),0)},s.prototype.end=function(t){return this.rpcImpl&&(t||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this}},67348:function(t,e,n){"use strict";t.exports=s;var r=n(43264);function s(t,e){this.lo=t>>>0,this.hi=e>>>0}var o=s.zero=new s(0,0);o.toNumber=function(){return 0},o.zzEncode=o.zzDecode=function(){return this},o.length=function(){return 1};var i=s.zeroHash="\0\0\0\0\0\0\0\0";s.fromNumber=function(t){if(0===t)return o;var e=t<0;e&&(t=-t);var n=t>>>0,r=(t-n)/4294967296>>>0;return e&&(r=~r>>>0,n=~n>>>0,++n>4294967295&&(n=0,++r>4294967295&&(r=0))),new s(n,r)},s.from=function(t){if("number"==typeof t)return s.fromNumber(t);if(r.isString(t)){if(!r.Long)return s.fromNumber(parseInt(t,10));t=r.Long.fromString(t)}return t.low||t.high?new s(t.low>>>0,t.high>>>0):o},s.prototype.toNumber=function(t){if(!t&&this.hi>>>31){var e=1+~this.lo>>>0,n=~this.hi>>>0;return e||(n=n+1>>>0),-(e+4294967296*n)}return this.lo+4294967296*this.hi},s.prototype.toLong=function(t){return r.Long?new r.Long(0|this.lo,0|this.hi,Boolean(t)):{low:0|this.lo,high:0|this.hi,unsigned:Boolean(t)}};var a=String.prototype.charCodeAt;s.fromHash=function(t){return t===i?o:new s((a.call(t,0)|a.call(t,1)<<8|a.call(t,2)<<16|a.call(t,3)<<24)>>>0,(a.call(t,4)|a.call(t,5)<<8|a.call(t,6)<<16|a.call(t,7)<<24)>>>0)},s.prototype.toHash=function(){return String.fromCharCode(255&this.lo,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,255&this.hi,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},s.prototype.zzEncode=function(){var t=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^t)>>>0,this.lo=(this.lo<<1^t)>>>0,this},s.prototype.zzDecode=function(){var t=-(1&this.lo);return this.lo=((this.lo>>>1|this.hi<<31)^t)>>>0,this.hi=(this.hi>>>1^t)>>>0,this},s.prototype.length=function(){var t=this.lo,e=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return 0===n?0===e?t<16384?t<128?1:2:t<2097152?3:4:e<16384?e<128?5:6:e<2097152?7:8:n<128?9:10}},43264:function(t,e,n){"use strict";var r=e;function s(t,e,n){for(var r=Object.keys(e),s=0;s<r.length;++s)void 0!==t[r[s]]&&n||(t[r[s]]=e[r[s]]);return t}function o(t){function e(t,n){if(!(this instanceof e))return new e(t,n);Object.defineProperty(this,"message",{get:function(){return t}}),Error.captureStackTrace?Error.captureStackTrace(this,e):Object.defineProperty(this,"stack",{value:(new Error).stack||""}),n&&s(this,n)}return e.prototype=Object.create(Error.prototype,{constructor:{value:e,writable:!0,enumerable:!1,configurable:!0},name:{get:function(){return t},set:void 0,enumerable:!1,configurable:!0},toString:{value:function(){return this.name+": "+this.message},writable:!0,enumerable:!1,configurable:!0}}),e}r.asPromise=n(34537),r.base64=n(97419),r.EventEmitter=n(19211),r.float=n(10945),r.inquire=n(67199),r.utf8=n(94997),r.pool=n(76662),r.LongBits=n(67348),r.isNode=Boolean(void 0!==n.g&&n.g&&n.g.process&&n.g.process.versions&&n.g.process.versions.node),r.global=r.isNode&&n.g||"undefined"!=typeof window&&window||"undefined"!=typeof self&&self||this,r.emptyArray=Object.freeze?Object.freeze([]):[],r.emptyObject=Object.freeze?Object.freeze({}):{},r.isInteger=Number.isInteger||function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t},r.isString=function(t){return"string"==typeof t||t instanceof String},r.isObject=function(t){return t&&"object"==typeof t},r.isset=r.isSet=function(t,e){var n=t[e];return!(null==n||!t.hasOwnProperty(e))&&("object"!=typeof n||(Array.isArray(n)?n.length:Object.keys(n).length)>0)},r.Buffer=function(){try{var t=r.inquire("buffer").Buffer;return t.prototype.utf8Write?t:null}catch(t){return null}}(),r._Buffer_from=null,r._Buffer_allocUnsafe=null,r.newBuffer=function(t){return"number"==typeof t?r.Buffer?r._Buffer_allocUnsafe(t):new r.Array(t):r.Buffer?r._Buffer_from(t):"undefined"==typeof Uint8Array?t:new Uint8Array(t)},r.Array="undefined"!=typeof Uint8Array?Uint8Array:Array,r.Long=r.global.dcodeIO&&r.global.dcodeIO.Long||r.global.Long||r.inquire("long"),r.key2Re=/^true|false|0|1$/,r.key32Re=/^-?(?:0|[1-9][0-9]*)$/,r.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,r.longToHash=function(t){return t?r.LongBits.from(t).toHash():r.LongBits.zeroHash},r.longFromHash=function(t,e){var n=r.LongBits.fromHash(t);return r.Long?r.Long.fromBits(n.lo,n.hi,e):n.toNumber(Boolean(e))},r.merge=s,r.lcFirst=function(t){return t.charAt(0).toLowerCase()+t.substring(1)},r.newError=o,r.ProtocolError=o("ProtocolError"),r.oneOfGetter=function(t){for(var e={},n=0;n<t.length;++n)e[t[n]]=1;return function(){for(var t=Object.keys(this),n=t.length-1;n>-1;--n)if(1===e[t[n]]&&void 0!==this[t[n]]&&null!==this[t[n]])return t[n]}},r.oneOfSetter=function(t){return function(e){for(var n=0;n<t.length;++n)t[n]!==e&&delete this[t[n]]}},r.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},r._configure=function(){var t=r.Buffer;t?(r._Buffer_from=t.from!==Uint8Array.from&&t.from||function(e,n){return new t(e,n)},r._Buffer_allocUnsafe=t.allocUnsafe||function(e){return new t(e)}):r._Buffer_from=r._Buffer_allocUnsafe=null}},685:function(t,e,n){"use strict";t.exports=d;var r,s=n(43264),o=s.LongBits,i=s.base64,a=s.utf8;function c(t,e,n){this.fn=t,this.len=e,this.next=void 0,this.val=n}function l(){}function u(t){this.head=t.head,this.tail=t.tail,this.len=t.len,this.next=t.states}function d(){this.len=0,this.head=new c(l,0,0),this.tail=this.head,this.states=null}var h=function(){return s.Buffer?function(){return(d.create=function(){return new r})()}:function(){return new d}};function p(t,e,n){e[n]=255&t}function f(t,e){this.len=t,this.next=void 0,this.val=e}function y(t,e,n){for(;t.hi;)e[n++]=127&t.lo|128,t.lo=(t.lo>>>7|t.hi<<25)>>>0,t.hi>>>=7;for(;t.lo>127;)e[n++]=127&t.lo|128,t.lo=t.lo>>>7;e[n++]=t.lo}function g(t,e,n){e[n]=255&t,e[n+1]=t>>>8&255,e[n+2]=t>>>16&255,e[n+3]=t>>>24}d.create=h(),d.alloc=function(t){return new s.Array(t)},s.Array!==Array&&(d.alloc=s.pool(d.alloc,s.Array.prototype.subarray)),d.prototype._push=function(t,e,n){return this.tail=this.tail.next=new c(t,e,n),this.len+=e,this},f.prototype=Object.create(c.prototype),f.prototype.fn=function(t,e,n){for(;t>127;)e[n++]=127&t|128,t>>>=7;e[n]=t},d.prototype.uint32=function(t){return this.len+=(this.tail=this.tail.next=new f((t>>>=0)<128?1:t<16384?2:t<2097152?3:t<268435456?4:5,t)).len,this},d.prototype.int32=function(t){return t<0?this._push(y,10,o.fromNumber(t)):this.uint32(t)},d.prototype.sint32=function(t){return this.uint32((t<<1^t>>31)>>>0)},d.prototype.uint64=function(t){var e=o.from(t);return this._push(y,e.length(),e)},d.prototype.int64=d.prototype.uint64,d.prototype.sint64=function(t){var e=o.from(t).zzEncode();return this._push(y,e.length(),e)},d.prototype.bool=function(t){return this._push(p,1,t?1:0)},d.prototype.fixed32=function(t){return this._push(g,4,t>>>0)},d.prototype.sfixed32=d.prototype.fixed32,d.prototype.fixed64=function(t){var e=o.from(t);return this._push(g,4,e.lo)._push(g,4,e.hi)},d.prototype.sfixed64=d.prototype.fixed64,d.prototype.float=function(t){return this._push(s.float.writeFloatLE,4,t)},d.prototype.double=function(t){return this._push(s.float.writeDoubleLE,8,t)};var w=s.Array.prototype.set?function(t,e,n){e.set(t,n)}:function(t,e,n){for(var r=0;r<t.length;++r)e[n+r]=t[r]};d.prototype.bytes=function(t){var e=t.length>>>0;if(!e)return this._push(p,1,0);if(s.isString(t)){var n=d.alloc(e=i.length(t));i.decode(t,n,0),t=n}return this.uint32(e)._push(w,e,t)},d.prototype.string=function(t){var e=a.length(t);return e?this.uint32(e)._push(a.write,e,t):this._push(p,1,0)},d.prototype.fork=function(){return this.states=new u(this),this.head=this.tail=new c(l,0,0),this.len=0,this},d.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new c(l,0,0),this.len=0),this},d.prototype.ldelim=function(){var t=this.head,e=this.tail,n=this.len;return this.reset().uint32(n),n&&(this.tail.next=t.next,this.tail=e,this.len+=n),this},d.prototype.finish=function(){for(var t=this.head.next,e=this.constructor.alloc(this.len),n=0;t;)t.fn(t.val,e,n),n+=t.len,t=t.next;return e},d._configure=function(t){r=t,d.create=h(),r._configure()}},43410:function(t,e,n){"use strict";t.exports=o;var r=n(685);(o.prototype=Object.create(r.prototype)).constructor=o;var s=n(43264);function o(){r.call(this)}function i(t,e,n){t.length<40?s.utf8.write(t,e,n):e.utf8Write?e.utf8Write(t,n):e.write(t,n)}o._configure=function(){o.alloc=s._Buffer_allocUnsafe,o.writeBytesBuffer=s.Buffer&&s.Buffer.prototype instanceof Uint8Array&&"set"===s.Buffer.prototype.set.name?function(t,e,n){e.set(t,n)}:function(t,e,n){if(t.copy)t.copy(e,n,0,t.length);else for(var r=0;r<t.length;)e[n++]=t[r++]}},o.prototype.bytes=function(t){s.isString(t)&&(t=s._Buffer_from(t,"base64"));var e=t.length>>>0;return this.uint32(e),e&&this._push(o.writeBytesBuffer,e,t),this},o.prototype.string=function(t){var e=s.Buffer.byteLength(t);return this.uint32(e),e&&this._push(i,e,t),this},o._configure()},55353:function(t,e,n){"use strict";t.exports=n(20612)},20612:function(t,e,n){"use strict";var r=e;function s(){r.util._configure(),r.Writer._configure(r.BufferWriter),r.Reader._configure(r.BufferReader)}r.build="minimal",r.Writer=n(27070),r.BufferWriter=n(5096),r.Reader=n(59824),r.BufferReader=n(26075),r.util=n(81910),r.rpc=n(86177),r.roots=n(83314),r.configure=s,s()},59824:function(t,e,n){"use strict";t.exports=c;var r,s=n(81910),o=s.LongBits,i=s.utf8;function a(t,e){return RangeError("index out of range: "+t.pos+" + "+(e||1)+" > "+t.len)}function c(t){this.buf=t,this.pos=0,this.len=t.length}var l,u="undefined"!=typeof Uint8Array?function(t){if(t instanceof Uint8Array||Array.isArray(t))return new c(t);throw Error("illegal buffer")}:function(t){if(Array.isArray(t))return new c(t);throw Error("illegal buffer")},d=function(){return s.Buffer?function(t){return(c.create=function(t){return s.Buffer.isBuffer(t)?new r(t):u(t)})(t)}:u};function h(){var t=new o(0,0),e=0;if(!(this.len-this.pos>4)){for(;e<3;++e){if(this.pos>=this.len)throw a(this);if(t.lo=(t.lo|(127&this.buf[this.pos])<<7*e)>>>0,this.buf[this.pos++]<128)return t}return t.lo=(t.lo|(127&this.buf[this.pos++])<<7*e)>>>0,t}for(;e<4;++e)if(t.lo=(t.lo|(127&this.buf[this.pos])<<7*e)>>>0,this.buf[this.pos++]<128)return t;if(t.lo=(t.lo|(127&this.buf[this.pos])<<28)>>>0,t.hi=(t.hi|(127&this.buf[this.pos])>>4)>>>0,this.buf[this.pos++]<128)return t;if(e=0,this.len-this.pos>4){for(;e<5;++e)if(t.hi=(t.hi|(127&this.buf[this.pos])<<7*e+3)>>>0,this.buf[this.pos++]<128)return t}else for(;e<5;++e){if(this.pos>=this.len)throw a(this);if(t.hi=(t.hi|(127&this.buf[this.pos])<<7*e+3)>>>0,this.buf[this.pos++]<128)return t}throw Error("invalid varint encoding")}function p(t,e){return(t[e-4]|t[e-3]<<8|t[e-2]<<16|t[e-1]<<24)>>>0}function f(){if(this.pos+8>this.len)throw a(this,8);return new o(p(this.buf,this.pos+=4),p(this.buf,this.pos+=4))}c.create=d(),c.prototype._slice=s.Array.prototype.subarray||s.Array.prototype.slice,c.prototype.uint32=(l=4294967295,function(){if(l=(127&this.buf[this.pos])>>>0,this.buf[this.pos++]<128)return l;if(l=(l|(127&this.buf[this.pos])<<7)>>>0,this.buf[this.pos++]<128)return l;if(l=(l|(127&this.buf[this.pos])<<14)>>>0,this.buf[this.pos++]<128)return l;if(l=(l|(127&this.buf[this.pos])<<21)>>>0,this.buf[this.pos++]<128)return l;if(l=(l|(15&this.buf[this.pos])<<28)>>>0,this.buf[this.pos++]<128)return l;if((this.pos+=5)>this.len)throw this.pos=this.len,a(this,10);return l}),c.prototype.int32=function(){return 0|this.uint32()},c.prototype.sint32=function(){var t=this.uint32();return t>>>1^-(1&t)|0},c.prototype.bool=function(){return 0!==this.uint32()},c.prototype.fixed32=function(){if(this.pos+4>this.len)throw a(this,4);return p(this.buf,this.pos+=4)},c.prototype.sfixed32=function(){if(this.pos+4>this.len)throw a(this,4);return 0|p(this.buf,this.pos+=4)},c.prototype.float=function(){if(this.pos+4>this.len)throw a(this,4);var t=s.float.readFloatLE(this.buf,this.pos);return this.pos+=4,t},c.prototype.double=function(){if(this.pos+8>this.len)throw a(this,4);var t=s.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,t},c.prototype.bytes=function(){var t=this.uint32(),e=this.pos,n=this.pos+t;if(n>this.len)throw a(this,t);return this.pos+=t,Array.isArray(this.buf)?this.buf.slice(e,n):e===n?new this.buf.constructor(0):this._slice.call(this.buf,e,n)},c.prototype.string=function(){var t=this.bytes();return i.read(t,0,t.length)},c.prototype.skip=function(t){if("number"==typeof t){if(this.pos+t>this.len)throw a(this,t);this.pos+=t}else do{if(this.pos>=this.len)throw a(this)}while(128&this.buf[this.pos++]);return this},c.prototype.skipType=function(t){switch(t){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;4!=(t=7&this.uint32());)this.skipType(t);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+t+" at offset "+this.pos)}return this},c._configure=function(t){r=t,c.create=d(),r._configure();var e=s.Long?"toLong":"toNumber";s.merge(c.prototype,{int64:function(){return h.call(this)[e](!1)},uint64:function(){return h.call(this)[e](!0)},sint64:function(){return h.call(this).zzDecode()[e](!1)},fixed64:function(){return f.call(this)[e](!0)},sfixed64:function(){return f.call(this)[e](!1)}})}},26075:function(t,e,n){"use strict";t.exports=o;var r=n(59824);(o.prototype=Object.create(r.prototype)).constructor=o;var s=n(81910);function o(t){r.call(this,t)}o._configure=function(){s.Buffer&&(o.prototype._slice=s.Buffer.prototype.slice)},o.prototype.string=function(){var t=this.uint32();return this.buf.utf8Slice?this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+t,this.len)):this.buf.toString("utf-8",this.pos,this.pos=Math.min(this.pos+t,this.len))},o._configure()},83314:function(t){"use strict";t.exports={}},86177:function(t,e,n){"use strict";e.Service=n(44658)},44658:function(t,e,n){"use strict";t.exports=s;var r=n(81910);function s(t,e,n){if("function"!=typeof t)throw TypeError("rpcImpl must be a function");r.EventEmitter.call(this),this.rpcImpl=t,this.requestDelimited=Boolean(e),this.responseDelimited=Boolean(n)}(s.prototype=Object.create(r.EventEmitter.prototype)).constructor=s,s.prototype.rpcCall=function t(e,n,s,o,i){if(!o)throw TypeError("request must be specified");var a=this;if(!i)return r.asPromise(t,a,e,n,s,o);if(a.rpcImpl)try{return a.rpcImpl(e,n[a.requestDelimited?"encodeDelimited":"encode"](o).finish(),(function(t,n){if(t)return a.emit("error",t,e),i(t);if(null!==n){if(!(n instanceof s))try{n=s[a.responseDelimited?"decodeDelimited":"decode"](n)}catch(t){return a.emit("error",t,e),i(t)}return a.emit("data",n,e),i(null,n)}a.end(!0)}))}catch(t){return a.emit("error",t,e),void setTimeout((function(){i(t)}),0)}else setTimeout((function(){i(Error("already ended"))}),0)},s.prototype.end=function(t){return this.rpcImpl&&(t||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this}},76758:function(t,e,n){"use strict";t.exports=s;var r=n(81910);function s(t,e){this.lo=t>>>0,this.hi=e>>>0}var o=s.zero=new s(0,0);o.toNumber=function(){return 0},o.zzEncode=o.zzDecode=function(){return this},o.length=function(){return 1};var i=s.zeroHash="\0\0\0\0\0\0\0\0";s.fromNumber=function(t){if(0===t)return o;var e=t<0;e&&(t=-t);var n=t>>>0,r=(t-n)/4294967296>>>0;return e&&(r=~r>>>0,n=~n>>>0,++n>4294967295&&(n=0,++r>4294967295&&(r=0))),new s(n,r)},s.from=function(t){if("number"==typeof t)return s.fromNumber(t);if(r.isString(t)){if(!r.Long)return s.fromNumber(parseInt(t,10));t=r.Long.fromString(t)}return t.low||t.high?new s(t.low>>>0,t.high>>>0):o},s.prototype.toNumber=function(t){if(!t&&this.hi>>>31){var e=1+~this.lo>>>0,n=~this.hi>>>0;return e||(n=n+1>>>0),-(e+4294967296*n)}return this.lo+4294967296*this.hi},s.prototype.toLong=function(t){return r.Long?new r.Long(0|this.lo,0|this.hi,Boolean(t)):{low:0|this.lo,high:0|this.hi,unsigned:Boolean(t)}};var a=String.prototype.charCodeAt;s.fromHash=function(t){return t===i?o:new s((a.call(t,0)|a.call(t,1)<<8|a.call(t,2)<<16|a.call(t,3)<<24)>>>0,(a.call(t,4)|a.call(t,5)<<8|a.call(t,6)<<16|a.call(t,7)<<24)>>>0)},s.prototype.toHash=function(){return String.fromCharCode(255&this.lo,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,255&this.hi,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},s.prototype.zzEncode=function(){var t=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^t)>>>0,this.lo=(this.lo<<1^t)>>>0,this},s.prototype.zzDecode=function(){var t=-(1&this.lo);return this.lo=((this.lo>>>1|this.hi<<31)^t)>>>0,this.hi=(this.hi>>>1^t)>>>0,this},s.prototype.length=function(){var t=this.lo,e=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return 0===n?0===e?t<16384?t<128?1:2:t<2097152?3:4:e<16384?e<128?5:6:e<2097152?7:8:n<128?9:10}},81910:function(t,e,n){"use strict";var r=e;function s(t,e,n){for(var r=Object.keys(e),s=0;s<r.length;++s)void 0!==t[r[s]]&&n||(t[r[s]]=e[r[s]]);return t}function o(t){function e(t,n){if(!(this instanceof e))return new e(t,n);Object.defineProperty(this,"message",{get:function(){return t}}),Error.captureStackTrace?Error.captureStackTrace(this,e):Object.defineProperty(this,"stack",{value:(new Error).stack||""}),n&&s(this,n)}return e.prototype=Object.create(Error.prototype,{constructor:{value:e,writable:!0,enumerable:!1,configurable:!0},name:{get:function(){return t},set:void 0,enumerable:!1,configurable:!0},toString:{value:function(){return this.name+": "+this.message},writable:!0,enumerable:!1,configurable:!0}}),e}r.asPromise=n(34537),r.base64=n(97419),r.EventEmitter=n(19211),r.float=n(10945),r.inquire=n(67199),r.utf8=n(94997),r.pool=n(76662),r.LongBits=n(76758),r.isNode=Boolean(void 0!==n.g&&n.g&&n.g.process&&n.g.process.versions&&n.g.process.versions.node),r.global=r.isNode&&n.g||"undefined"!=typeof window&&window||"undefined"!=typeof self&&self||this,r.emptyArray=Object.freeze?Object.freeze([]):[],r.emptyObject=Object.freeze?Object.freeze({}):{},r.isInteger=Number.isInteger||function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t},r.isString=function(t){return"string"==typeof t||t instanceof String},r.isObject=function(t){return t&&"object"==typeof t},r.isset=r.isSet=function(t,e){var n=t[e];return!(null==n||!t.hasOwnProperty(e))&&("object"!=typeof n||(Array.isArray(n)?n.length:Object.keys(n).length)>0)},r.Buffer=function(){try{var t=r.inquire("buffer").Buffer;return t.prototype.utf8Write?t:null}catch(t){return null}}(),r._Buffer_from=null,r._Buffer_allocUnsafe=null,r.newBuffer=function(t){return"number"==typeof t?r.Buffer?r._Buffer_allocUnsafe(t):new r.Array(t):r.Buffer?r._Buffer_from(t):"undefined"==typeof Uint8Array?t:new Uint8Array(t)},r.Array="undefined"!=typeof Uint8Array?Uint8Array:Array,r.Long=r.global.dcodeIO&&r.global.dcodeIO.Long||r.global.Long||r.inquire("long"),r.key2Re=/^true|false|0|1$/,r.key32Re=/^-?(?:0|[1-9][0-9]*)$/,r.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,r.longToHash=function(t){return t?r.LongBits.from(t).toHash():r.LongBits.zeroHash},r.longFromHash=function(t,e){var n=r.LongBits.fromHash(t);return r.Long?r.Long.fromBits(n.lo,n.hi,e):n.toNumber(Boolean(e))},r.merge=s,r.lcFirst=function(t){return t.charAt(0).toLowerCase()+t.substring(1)},r.newError=o,r.ProtocolError=o("ProtocolError"),r.oneOfGetter=function(t){for(var e={},n=0;n<t.length;++n)e[t[n]]=1;return function(){for(var t=Object.keys(this),n=t.length-1;n>-1;--n)if(1===e[t[n]]&&void 0!==this[t[n]]&&null!==this[t[n]])return t[n]}},r.oneOfSetter=function(t){return function(e){for(var n=0;n<t.length;++n)t[n]!==e&&delete this[t[n]]}},r.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},r._configure=function(){var t=r.Buffer;t?(r._Buffer_from=t.from!==Uint8Array.from&&t.from||function(e,n){return new t(e,n)},r._Buffer_allocUnsafe=t.allocUnsafe||function(e){return new t(e)}):r._Buffer_from=r._Buffer_allocUnsafe=null}},27070:function(t,e,n){"use strict";t.exports=d;var r,s=n(81910),o=s.LongBits,i=s.base64,a=s.utf8;function c(t,e,n){this.fn=t,this.len=e,this.next=void 0,this.val=n}function l(){}function u(t){this.head=t.head,this.tail=t.tail,this.len=t.len,this.next=t.states}function d(){this.len=0,this.head=new c(l,0,0),this.tail=this.head,this.states=null}var h=function(){return s.Buffer?function(){return(d.create=function(){return new r})()}:function(){return new d}};function p(t,e,n){e[n]=255&t}function f(t,e){this.len=t,this.next=void 0,this.val=e}function y(t,e,n){for(;t.hi;)e[n++]=127&t.lo|128,t.lo=(t.lo>>>7|t.hi<<25)>>>0,t.hi>>>=7;for(;t.lo>127;)e[n++]=127&t.lo|128,t.lo=t.lo>>>7;e[n++]=t.lo}function g(t,e,n){e[n]=255&t,e[n+1]=t>>>8&255,e[n+2]=t>>>16&255,e[n+3]=t>>>24}d.create=h(),d.alloc=function(t){return new s.Array(t)},s.Array!==Array&&(d.alloc=s.pool(d.alloc,s.Array.prototype.subarray)),d.prototype._push=function(t,e,n){return this.tail=this.tail.next=new c(t,e,n),this.len+=e,this},f.prototype=Object.create(c.prototype),f.prototype.fn=function(t,e,n){for(;t>127;)e[n++]=127&t|128,t>>>=7;e[n]=t},d.prototype.uint32=function(t){return this.len+=(this.tail=this.tail.next=new f((t>>>=0)<128?1:t<16384?2:t<2097152?3:t<268435456?4:5,t)).len,this},d.prototype.int32=function(t){return t<0?this._push(y,10,o.fromNumber(t)):this.uint32(t)},d.prototype.sint32=function(t){return this.uint32((t<<1^t>>31)>>>0)},d.prototype.uint64=function(t){var e=o.from(t);return this._push(y,e.length(),e)},d.prototype.int64=d.prototype.uint64,d.prototype.sint64=function(t){var e=o.from(t).zzEncode();return this._push(y,e.length(),e)},d.prototype.bool=function(t){return this._push(p,1,t?1:0)},d.prototype.fixed32=function(t){return this._push(g,4,t>>>0)},d.prototype.sfixed32=d.prototype.fixed32,d.prototype.fixed64=function(t){var e=o.from(t);return this._push(g,4,e.lo)._push(g,4,e.hi)},d.prototype.sfixed64=d.prototype.fixed64,d.prototype.float=function(t){return this._push(s.float.writeFloatLE,4,t)},d.prototype.double=function(t){return this._push(s.float.writeDoubleLE,8,t)};var w=s.Array.prototype.set?function(t,e,n){e.set(t,n)}:function(t,e,n){for(var r=0;r<t.length;++r)e[n+r]=t[r]};d.prototype.bytes=function(t){var e=t.length>>>0;if(!e)return this._push(p,1,0);if(s.isString(t)){var n=d.alloc(e=i.length(t));i.decode(t,n,0),t=n}return this.uint32(e)._push(w,e,t)},d.prototype.string=function(t){var e=a.length(t);return e?this.uint32(e)._push(a.write,e,t):this._push(p,1,0)},d.prototype.fork=function(){return this.states=new u(this),this.head=this.tail=new c(l,0,0),this.len=0,this},d.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new c(l,0,0),this.len=0),this},d.prototype.ldelim=function(){var t=this.head,e=this.tail,n=this.len;return this.reset().uint32(n),n&&(this.tail.next=t.next,this.tail=e,this.len+=n),this},d.prototype.finish=function(){for(var t=this.head.next,e=this.constructor.alloc(this.len),n=0;t;)t.fn(t.val,e,n),n+=t.len,t=t.next;return e},d._configure=function(t){r=t,d.create=h(),r._configure()}},5096:function(t,e,n){"use strict";t.exports=o;var r=n(27070);(o.prototype=Object.create(r.prototype)).constructor=o;var s=n(81910);function o(){r.call(this)}function i(t,e,n){t.length<40?s.utf8.write(t,e,n):e.utf8Write?e.utf8Write(t,n):e.write(t,n)}o._configure=function(){o.alloc=s._Buffer_allocUnsafe,o.writeBytesBuffer=s.Buffer&&s.Buffer.prototype instanceof Uint8Array&&"set"===s.Buffer.prototype.set.name?function(t,e,n){e.set(t,n)}:function(t,e,n){if(t.copy)t.copy(e,n,0,t.length);else for(var r=0;r<t.length;)e[n++]=t[r++]}},o.prototype.bytes=function(t){s.isString(t)&&(t=s._Buffer_from(t,"base64"));var e=t.length>>>0;return this.uint32(e),e&&this._push(o.writeBytesBuffer,e,t),this},o.prototype.string=function(t){var e=s.Buffer.byteLength(t);return this.uint32(e),e&&this._push(i,e,t),this},o._configure()},74449:function(t){"use strict";t.exports=async function*(t,e={}){const n=t.getReader();try{for(;;){const t=await n.read();if(t.done)return;yield t.value}}finally{!0!==e.preventCancel&&n.cancel(),n.releaseLock()}}},46851:function(t){"use strict";t.exports=async t=>{const e=[];for await(const n of t)e.push(n);return e}},106:function(t,e,n){"use strict";var r=n(34155);const s=n(59134),o="object"==typeof window&&"object"==typeof document&&9===document.nodeType,i=s(),a=o&&!i,c=i&&!o,l=i&&o,u=void 0!==r&&void 0!==r.release&&"node"===r.release.name&&!i,d="function"==typeof importScripts&&"undefined"!=typeof self&&"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope,h=void 0!==r&&void 0!==r.env&&!1,p="undefined"!=typeof navigator&&"ReactNative"===navigator.product;t.exports={isTest:h,isElectron:i,isElectronMain:c,isElectronRenderer:l,isNode:u,isBrowser:a,isWebWorker:d,isEnvWithDom:o,isReactNative:p}},38688:function(t,e,n){"use strict";t.exports=n(30700)},46953:function(t,e,n){"use strict";const r=n(67137);async function*s(t,e){const n=new r,s=await n.get(t,e);yield*s.iterator()}t.exports=(t,e)=>({path:decodeURIComponent(new URL(t).pathname.split("/").pop()||""),content:s(t,e)})},67137:function(t,e,n){"use strict";const{fetch:r,Request:s,Headers:o}=n(50730),{TimeoutError:i,HTTPError:a}=n(44171),c=n(70942).bind({ignoreUndefined:!0}),{URL:l,URLSearchParams:u}=n(17745),d=n(32044),h=n(74449),{isBrowser:p,isWebWorker:f}=n(106),y=n(46851),g={throwHttpErrors:!0,credentials:"same-origin"};class w{constructor(t={}){this.opts=c(g,t)}async fetch(t,e={}){const n=c(this.opts,e),g=new o(n.headers);if("string"!=typeof t&&!(t instanceof l||t instanceof s))throw new TypeError("`resource` must be a string, URL, or Request");const w=new l(t.toString(),n.base),{searchParams:E,transformSearchParams:_,json:v}=n;E&&(w.search="function"==typeof _?_(new u(n.searchParams)):new u(n.searchParams)),v&&(n.body=JSON.stringify(n.json),g.set("content-type","application/json"));const k=new AbortController,R=d([k.signal,n.signal]);null!=globalThis.ReadableStream&&n.body instanceof globalThis.ReadableStream&&(p||f)&&(n.body=new Blob(await y(h(n.body))));const S=await((t,e,n)=>{if(void 0===e)return t;const r=Date.now(),s=()=>Date.now()-r>=e;return new Promise(((r,o)=>{const a=setTimeout((()=>{s()&&(o(new i),n.abort())}),e),c=t=>e=>{clearTimeout(a),s()?o(new i):t(e)};t.then(c(r),c(o))}))})(r(w.toString(),{...n,signal:R,timeout:void 0,headers:g,duplex:"half"}),n.timeout,k);if(!S.ok&&n.throwHttpErrors)throw n.handleError&&await n.handleError(S),new a(S);return S.iterator=async function*(){yield*b(S.body)},S.ndjson=async function*(){for await(const t of m(S.iterator()))e.transform?yield e.transform(t):yield t},S}post(t,e={}){return this.fetch(t,{...e,method:"POST"})}get(t,e={}){return this.fetch(t,{...e,method:"GET"})}put(t,e={}){return this.fetch(t,{...e,method:"PUT"})}delete(t,e={}){return this.fetch(t,{...e,method:"DELETE"})}options(t,e={}){return this.fetch(t,{...e,method:"OPTIONS"})}}const m=async function*(t){const e=new TextDecoder;let n="";for await(const r of t){n+=e.decode(r,{stream:!0});const t=n.split(/\r?\n/);for(let e=0;e<t.length-1;e++){const n=t[e].trim();n.length>0&&(yield JSON.parse(n))}n=t[t.length-1]}n+=e.decode(),n=n.trim(),0!==n.length&&(yield JSON.parse(n))},b=t=>{if(E(t))return t;if(v(t)){const e=t[Symbol.asyncIterator]();return{[Symbol.asyncIterator]:()=>({next:e.next.bind(e),return:n=>(t.destroy(),"function"==typeof e.return?e.return():Promise.resolve({done:!0,value:n}))})}}if(_(t)){const e=t.getReader();return async function*(){try{for(;;){const{done:t,value:n}=await e.read();if(t)return;n&&(yield n)}}finally{e.releaseLock()}}()}throw new TypeError("Body can't be converted to AsyncIterable")},E=t=>"object"==typeof t&&null!==t&&"function"==typeof t[Symbol.asyncIterator],_=t=>t&&"function"==typeof t.getReader,v=t=>Object.prototype.hasOwnProperty.call(t,"readable")&&Object.prototype.hasOwnProperty.call(t,"writable");w.HTTPError=a,w.TimeoutError=i,w.streamToAsyncIterator=b,w.post=(t,e)=>new w(e).post(t,e),w.get=(t,e)=>new w(e).get(t,e),w.put=(t,e)=>new w(e).put(t,e),w.delete=(t,e)=>new w(e).delete(t,e),w.options=(t,e)=>new w(e).options(t,e),t.exports=w},44171:function(t,e){"use strict";class n extends Error{constructor(t="Request timed out"){super(t),this.name="TimeoutError"}}e.TimeoutError=n;class r extends Error{constructor(t="The operation was aborted."){super(t),this.name="AbortError"}}e.AbortError=r;class s extends Error{constructor(t){super(t.statusText),this.name="HTTPError",this.response=t}}e.HTTPError=s},50730:function(t,e,n){"use strict";const{TimeoutError:r,AbortError:s}=n(44171),{Response:o,Request:i,Headers:a,default:c}=n(38688),l=c,u=t=>{const e=new a;for(const n of t.trim().split(/[\r\n]+/)){const t=n.indexOf(": ");t>0&&e.set(n.slice(0,t),n.slice(t+1))}return e};class d extends o{constructor(t,e,n){super(e,n),Object.defineProperty(this,"url",{value:t})}}t.exports={fetch:(t,e={})=>null!=e.onUploadProgress?((t,e={})=>{const n=new XMLHttpRequest;n.open(e.method||"GET",t.toString(),!0);const{timeout:i,headers:c}=e;if(i&&i>0&&i<1/0&&(n.timeout=i),null!=e.overrideMimeType&&n.overrideMimeType(e.overrideMimeType),c)for(const[t,e]of new a(c))n.setRequestHeader(t,e);return e.signal&&(e.signal.onabort=()=>n.abort()),e.onUploadProgress&&(n.upload.onprogress=e.onUploadProgress),n.responseType="arraybuffer",new Promise(((t,i)=>{const a=e=>{switch(e.type){case"error":t(o.error());break;case"load":t(new d(n.responseURL,n.response,{status:n.status,statusText:n.statusText,headers:u(n.getAllResponseHeaders())}));break;case"timeout":i(new r);break;case"abort":i(new s)}};n.onerror=a,n.onload=a,n.ontimeout=a,n.onabort=a,n.send(e.body)}))})(t,e):l(t,e),Request:i,Headers:a}},77914:function(t,e,n){"use strict";t.exports=c;var r,s=n(44738),o=s.LongBits,i=s.utf8;function a(t,e){return RangeError("index out of range: "+t.pos+" + "+(e||1)+" > "+t.len)}function c(t){this.buf=t,this.pos=0,this.len=t.length}var l,u="undefined"!=typeof Uint8Array?function(t){if(t instanceof Uint8Array||Array.isArray(t))return new c(t);throw Error("illegal buffer")}:function(t){if(Array.isArray(t))return new c(t);throw Error("illegal buffer")},d=function(){return s.Buffer?function(t){return(c.create=function(t){return s.Buffer.isBuffer(t)?new r(t):u(t)})(t)}:u};function h(){var t=new o(0,0),e=0;if(!(this.len-this.pos>4)){for(;e<3;++e){if(this.pos>=this.len)throw a(this);if(t.lo=(t.lo|(127&this.buf[this.pos])<<7*e)>>>0,this.buf[this.pos++]<128)return t}return t.lo=(t.lo|(127&this.buf[this.pos++])<<7*e)>>>0,t}for(;e<4;++e)if(t.lo=(t.lo|(127&this.buf[this.pos])<<7*e)>>>0,this.buf[this.pos++]<128)return t;if(t.lo=(t.lo|(127&this.buf[this.pos])<<28)>>>0,t.hi=(t.hi|(127&this.buf[this.pos])>>4)>>>0,this.buf[this.pos++]<128)return t;if(e=0,this.len-this.pos>4){for(;e<5;++e)if(t.hi=(t.hi|(127&this.buf[this.pos])<<7*e+3)>>>0,this.buf[this.pos++]<128)return t}else for(;e<5;++e){if(this.pos>=this.len)throw a(this);if(t.hi=(t.hi|(127&this.buf[this.pos])<<7*e+3)>>>0,this.buf[this.pos++]<128)return t}throw Error("invalid varint encoding")}function p(t,e){return(t[e-4]|t[e-3]<<8|t[e-2]<<16|t[e-1]<<24)>>>0}function f(){if(this.pos+8>this.len)throw a(this,8);return new o(p(this.buf,this.pos+=4),p(this.buf,this.pos+=4))}c.create=d(),c.prototype._slice=s.Array.prototype.subarray||s.Array.prototype.slice,c.prototype.uint32=(l=4294967295,function(){if(l=(127&this.buf[this.pos])>>>0,this.buf[this.pos++]<128)return l;if(l=(l|(127&this.buf[this.pos])<<7)>>>0,this.buf[this.pos++]<128)return l;if(l=(l|(127&this.buf[this.pos])<<14)>>>0,this.buf[this.pos++]<128)return l;if(l=(l|(127&this.buf[this.pos])<<21)>>>0,this.buf[this.pos++]<128)return l;if(l=(l|(15&this.buf[this.pos])<<28)>>>0,this.buf[this.pos++]<128)return l;if((this.pos+=5)>this.len)throw this.pos=this.len,a(this,10);return l}),c.prototype.int32=function(){return 0|this.uint32()},c.prototype.sint32=function(){var t=this.uint32();return t>>>1^-(1&t)|0},c.prototype.bool=function(){return 0!==this.uint32()},c.prototype.fixed32=function(){if(this.pos+4>this.len)throw a(this,4);return p(this.buf,this.pos+=4)},c.prototype.sfixed32=function(){if(this.pos+4>this.len)throw a(this,4);return 0|p(this.buf,this.pos+=4)},c.prototype.float=function(){if(this.pos+4>this.len)throw a(this,4);var t=s.float.readFloatLE(this.buf,this.pos);return this.pos+=4,t},c.prototype.double=function(){if(this.pos+8>this.len)throw a(this,4);var t=s.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,t},c.prototype.bytes=function(){var t=this.uint32(),e=this.pos,n=this.pos+t;if(n>this.len)throw a(this,t);return this.pos+=t,Array.isArray(this.buf)?this.buf.slice(e,n):e===n?new this.buf.constructor(0):this._slice.call(this.buf,e,n)},c.prototype.string=function(){var t=this.bytes();return i.read(t,0,t.length)},c.prototype.skip=function(t){if("number"==typeof t){if(this.pos+t>this.len)throw a(this,t);this.pos+=t}else do{if(this.pos>=this.len)throw a(this)}while(128&this.buf[this.pos++]);return this},c.prototype.skipType=function(t){switch(t){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;4!=(t=7&this.uint32());)this.skipType(t);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+t+" at offset "+this.pos)}return this},c._configure=function(t){r=t,c.create=d(),r._configure();var e=s.Long?"toLong":"toNumber";s.merge(c.prototype,{int64:function(){return h.call(this)[e](!1)},uint64:function(){return h.call(this)[e](!0)},sint64:function(){return h.call(this).zzDecode()[e](!1)},fixed64:function(){return f.call(this)[e](!0)},sfixed64:function(){return f.call(this)[e](!1)}})}},97151:function(t,e,n){"use strict";t.exports=o;var r=n(77914);(o.prototype=Object.create(r.prototype)).constructor=o;var s=n(44738);function o(t){r.call(this,t)}o._configure=function(){s.Buffer&&(o.prototype._slice=s.Buffer.prototype.slice)},o.prototype.string=function(){var t=this.uint32();return this.buf.utf8Slice?this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+t,this.len)):this.buf.toString("utf-8",this.pos,this.pos=Math.min(this.pos+t,this.len))},o._configure()},57369:function(t,e,n){"use strict";t.exports=s;var r=n(44738);function s(t,e){this.lo=t>>>0,this.hi=e>>>0}var o=s.zero=new s(0,0);o.toNumber=function(){return 0},o.zzEncode=o.zzDecode=function(){return this},o.length=function(){return 1};var i=s.zeroHash="\0\0\0\0\0\0\0\0";s.fromNumber=function(t){if(0===t)return o;var e=t<0;e&&(t=-t);var n=t>>>0,r=(t-n)/4294967296>>>0;return e&&(r=~r>>>0,n=~n>>>0,++n>4294967295&&(n=0,++r>4294967295&&(r=0))),new s(n,r)},s.from=function(t){if("number"==typeof t)return s.fromNumber(t);if(r.isString(t)){if(!r.Long)return s.fromNumber(parseInt(t,10));t=r.Long.fromString(t)}return t.low||t.high?new s(t.low>>>0,t.high>>>0):o},s.prototype.toNumber=function(t){if(!t&&this.hi>>>31){var e=1+~this.lo>>>0,n=~this.hi>>>0;return e||(n=n+1>>>0),-(e+4294967296*n)}return this.lo+4294967296*this.hi},s.prototype.toLong=function(t){return r.Long?new r.Long(0|this.lo,0|this.hi,Boolean(t)):{low:0|this.lo,high:0|this.hi,unsigned:Boolean(t)}};var a=String.prototype.charCodeAt;s.fromHash=function(t){return t===i?o:new s((a.call(t,0)|a.call(t,1)<<8|a.call(t,2)<<16|a.call(t,3)<<24)>>>0,(a.call(t,4)|a.call(t,5)<<8|a.call(t,6)<<16|a.call(t,7)<<24)>>>0)},s.prototype.toHash=function(){return String.fromCharCode(255&this.lo,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,255&this.hi,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},s.prototype.zzEncode=function(){var t=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^t)>>>0,this.lo=(this.lo<<1^t)>>>0,this},s.prototype.zzDecode=function(){var t=-(1&this.lo);return this.lo=((this.lo>>>1|this.hi<<31)^t)>>>0,this.hi=(this.hi>>>1^t)>>>0,this},s.prototype.length=function(){var t=this.lo,e=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return 0===n?0===e?t<16384?t<128?1:2:t<2097152?3:4:e<16384?e<128?5:6:e<2097152?7:8:n<128?9:10}},44738:function(t,e,n){"use strict";var r=e;function s(t,e,n){for(var r=Object.keys(e),s=0;s<r.length;++s)void 0!==t[r[s]]&&n||(t[r[s]]=e[r[s]]);return t}function o(t){function e(t,n){if(!(this instanceof e))return new e(t,n);Object.defineProperty(this,"message",{get:function(){return t}}),Error.captureStackTrace?Error.captureStackTrace(this,e):Object.defineProperty(this,"stack",{value:(new Error).stack||""}),n&&s(this,n)}return e.prototype=Object.create(Error.prototype,{constructor:{value:e,writable:!0,enumerable:!1,configurable:!0},name:{get:function(){return t},set:void 0,enumerable:!1,configurable:!0},toString:{value:function(){return this.name+": "+this.message},writable:!0,enumerable:!1,configurable:!0}}),e}r.asPromise=n(34537),r.base64=n(97419),r.EventEmitter=n(19211),r.float=n(10945),r.inquire=n(67199),r.utf8=n(94997),r.pool=n(76662),r.LongBits=n(57369),r.isNode=Boolean(void 0!==n.g&&n.g&&n.g.process&&n.g.process.versions&&n.g.process.versions.node),r.global=r.isNode&&n.g||"undefined"!=typeof window&&window||"undefined"!=typeof self&&self||this,r.emptyArray=Object.freeze?Object.freeze([]):[],r.emptyObject=Object.freeze?Object.freeze({}):{},r.isInteger=Number.isInteger||function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t},r.isString=function(t){return"string"==typeof t||t instanceof String},r.isObject=function(t){return t&&"object"==typeof t},r.isset=r.isSet=function(t,e){var n=t[e];return!(null==n||!t.hasOwnProperty(e))&&("object"!=typeof n||(Array.isArray(n)?n.length:Object.keys(n).length)>0)},r.Buffer=function(){try{var t=r.inquire("buffer").Buffer;return t.prototype.utf8Write?t:null}catch(t){return null}}(),r._Buffer_from=null,r._Buffer_allocUnsafe=null,r.newBuffer=function(t){return"number"==typeof t?r.Buffer?r._Buffer_allocUnsafe(t):new r.Array(t):r.Buffer?r._Buffer_from(t):"undefined"==typeof Uint8Array?t:new Uint8Array(t)},r.Array="undefined"!=typeof Uint8Array?Uint8Array:Array,r.Long=r.global.dcodeIO&&r.global.dcodeIO.Long||r.global.Long||r.inquire("long"),r.key2Re=/^true|false|0|1$/,r.key32Re=/^-?(?:0|[1-9][0-9]*)$/,r.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,r.longToHash=function(t){return t?r.LongBits.from(t).toHash():r.LongBits.zeroHash},r.longFromHash=function(t,e){var n=r.LongBits.fromHash(t);return r.Long?r.Long.fromBits(n.lo,n.hi,e):n.toNumber(Boolean(e))},r.merge=s,r.lcFirst=function(t){return t.charAt(0).toLowerCase()+t.substring(1)},r.newError=o,r.ProtocolError=o("ProtocolError"),r.oneOfGetter=function(t){for(var e={},n=0;n<t.length;++n)e[t[n]]=1;return function(){for(var t=Object.keys(this),n=t.length-1;n>-1;--n)if(1===e[t[n]]&&void 0!==this[t[n]]&&null!==this[t[n]])return t[n]}},r.oneOfSetter=function(t){return function(e){for(var n=0;n<t.length;++n)t[n]!==e&&delete this[t[n]]}},r.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},r._configure=function(){var t=r.Buffer;t?(r._Buffer_from=t.from!==Uint8Array.from&&t.from||function(e,n){return new t(e,n)},r._Buffer_allocUnsafe=t.allocUnsafe||function(e){return new t(e)}):r._Buffer_from=r._Buffer_allocUnsafe=null}},29078:function(t,e,n){"use strict";t.exports=d;var r,s=n(44738),o=s.LongBits,i=s.base64,a=s.utf8;function c(t,e,n){this.fn=t,this.len=e,this.next=void 0,this.val=n}function l(){}function u(t){this.head=t.head,this.tail=t.tail,this.len=t.len,this.next=t.states}function d(){this.len=0,this.head=new c(l,0,0),this.tail=this.head,this.states=null}var h=function(){return s.Buffer?function(){return(d.create=function(){return new r})()}:function(){return new d}};function p(t,e,n){e[n]=255&t}function f(t,e){this.len=t,this.next=void 0,this.val=e}function y(t,e,n){for(;t.hi;)e[n++]=127&t.lo|128,t.lo=(t.lo>>>7|t.hi<<25)>>>0,t.hi>>>=7;for(;t.lo>127;)e[n++]=127&t.lo|128,t.lo=t.lo>>>7;e[n++]=t.lo}function g(t,e,n){e[n]=255&t,e[n+1]=t>>>8&255,e[n+2]=t>>>16&255,e[n+3]=t>>>24}d.create=h(),d.alloc=function(t){return new s.Array(t)},s.Array!==Array&&(d.alloc=s.pool(d.alloc,s.Array.prototype.subarray)),d.prototype._push=function(t,e,n){return this.tail=this.tail.next=new c(t,e,n),this.len+=e,this},f.prototype=Object.create(c.prototype),f.prototype.fn=function(t,e,n){for(;t>127;)e[n++]=127&t|128,t>>>=7;e[n]=t},d.prototype.uint32=function(t){return this.len+=(this.tail=this.tail.next=new f((t>>>=0)<128?1:t<16384?2:t<2097152?3:t<268435456?4:5,t)).len,this},d.prototype.int32=function(t){return t<0?this._push(y,10,o.fromNumber(t)):this.uint32(t)},d.prototype.sint32=function(t){return this.uint32((t<<1^t>>31)>>>0)},d.prototype.uint64=function(t){var e=o.from(t);return this._push(y,e.length(),e)},d.prototype.int64=d.prototype.uint64,d.prototype.sint64=function(t){var e=o.from(t).zzEncode();return this._push(y,e.length(),e)},d.prototype.bool=function(t){return this._push(p,1,t?1:0)},d.prototype.fixed32=function(t){return this._push(g,4,t>>>0)},d.prototype.sfixed32=d.prototype.fixed32,d.prototype.fixed64=function(t){var e=o.from(t);return this._push(g,4,e.lo)._push(g,4,e.hi)},d.prototype.sfixed64=d.prototype.fixed64,d.prototype.float=function(t){return this._push(s.float.writeFloatLE,4,t)},d.prototype.double=function(t){return this._push(s.float.writeDoubleLE,8,t)};var w=s.Array.prototype.set?function(t,e,n){e.set(t,n)}:function(t,e,n){for(var r=0;r<t.length;++r)e[n+r]=t[r]};d.prototype.bytes=function(t){var e=t.length>>>0;if(!e)return this._push(p,1,0);if(s.isString(t)){var n=d.alloc(e=i.length(t));i.decode(t,n,0),t=n}return this.uint32(e)._push(w,e,t)},d.prototype.string=function(t){var e=a.length(t);return e?this.uint32(e)._push(a.write,e,t):this._push(p,1,0)},d.prototype.fork=function(){return this.states=new u(this),this.head=this.tail=new c(l,0,0),this.len=0,this},d.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new c(l,0,0),this.len=0),this},d.prototype.ldelim=function(){var t=this.head,e=this.tail,n=this.len;return this.reset().uint32(n),n&&(this.tail.next=t.next,this.tail=e,this.len+=n),this},d.prototype.finish=function(){for(var t=this.head.next,e=this.constructor.alloc(this.len),n=0;t;)t.fn(t.val,e,n),n+=t.len,t=t.next;return e},d._configure=function(t){r=t,d.create=h(),r._configure()}},48320:function(t,e,n){"use strict";t.exports=o;var r=n(29078);(o.prototype=Object.create(r.prototype)).constructor=o;var s=n(44738);function o(){r.call(this)}function i(t,e,n){t.length<40?s.utf8.write(t,e,n):e.utf8Write?e.utf8Write(t,n):e.write(t,n)}o._configure=function(){o.alloc=s._Buffer_allocUnsafe,o.writeBytesBuffer=s.Buffer&&s.Buffer.prototype instanceof Uint8Array&&"set"===s.Buffer.prototype.set.name?function(t,e,n){e.set(t,n)}:function(t,e,n){if(t.copy)t.copy(e,n,0,t.length);else for(var r=0;r<t.length;)e[n++]=t[r++]}},o.prototype.bytes=function(t){s.isString(t)&&(t=s._Buffer_from(t,"base64"));var e=t.length>>>0;return this.uint32(e),e&&this._push(o.writeBytesBuffer,e,t),this},o.prototype.string=function(t){var e=s.Buffer.byteLength(t);return this.uint32(e),e&&this._push(i,e,t),this},o._configure()},82734:function(t){"use strict";var e=/^(?:[a-z0-9](?:[a-z0-9\-]{0,61}[a-z0-9])?\.){0,126}(?:[a-z0-9](?:[a-z0-9\-]{0,61}[a-z0-9]))\.?$/i;t.exports=function(t,n){if(null==n&&(n=!1),t.length<2)return!1;if(t.length>255)return!1;var r=t[t.length-1];if(n){if("."!==r)return!1}else if("."===r)return!1;return e.test(t)}},10356:function(t){t.exports=function t(r,s){var o,i=0,a=0,c=s=s||0,l=r.length;do{if(c>=l||a>49)throw t.bytes=0,new RangeError("Could not decode varint");o=r[c++],i+=a<28?(o&n)<<a:(o&n)*Math.pow(2,a),a+=7}while(o>=e);return t.bytes=c-s,i};var e=128,n=127},27698:function(t){t.exports=function t(s,o,i){if(Number.MAX_SAFE_INTEGER&&s>Number.MAX_SAFE_INTEGER)throw t.bytes=0,new RangeError("Could not encode varint");o=o||[];var a=i=i||0;for(;s>=r;)o[i++]=255&s|e,s/=128;for(;s&n;)o[i++]=255&s|e,s>>>=7;return o[i]=0|s,t.bytes=i-a+1,o};var e=128,n=-128,r=Math.pow(2,31)},38971:function(t,e,n){t.exports={encode:n(27698),decode:n(10356),encodingLength:n(23753)}},23753:function(t){var e=Math.pow(2,7),n=Math.pow(2,14),r=Math.pow(2,21),s=Math.pow(2,28),o=Math.pow(2,35),i=Math.pow(2,42),a=Math.pow(2,49),c=Math.pow(2,56),l=Math.pow(2,63);t.exports=function(t){return t<e?1:t<n?2:t<r?3:t<s?4:t<o?5:t<i?6:t<a?7:t<c?8:t<l?9:10}},41487:function(t,e,n){"use strict";const{XMLParser:r,XMLValidator:s}=n(16932),o=t=>{if(null==t)return!1;if(0===(t=t.toString().trim()).length)return!1;if(!0!==s.validate(t))return!1;let e;const n=new r;try{e=n.parse(t)}catch(t){return!1}return!!e&&"svg"in e};t.exports=o,t.exports.default=o},90560:function(t,e,n){"use strict";n.r(e),n.d(e,{code:function(){return l},decode:function(){return d},encode:function(){return u},name:function(){return c}});var r=n(64936),s=n(38161);const o=42;const i={float64:!0,typeEncoders:{Object:function(t){if(t.asCID!==t&&t["/"]!==t.bytes)return null;const e=s.k0.asCID(t);if(!e)return null;const n=new Uint8Array(e.bytes.byteLength+1);return n.set(e.bytes,1),[new r.WU(r.Dy.tag,o),new r.WU(r.Dy.bytes,n)]},undefined:function(){throw new Error("`undefined` is not supported by the IPLD Data Model and cannot be encoded")},number:function(t){if(Number.isNaN(t))throw new Error("`NaN` is not supported by the IPLD Data Model and cannot be encoded");if(t===1/0||t===-1/0)throw new Error("`Infinity` and `-Infinity` is not supported by the IPLD Data Model and cannot be encoded");return null}}};const a={allowIndefinite:!1,coerceUndefinedToNull:!0,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};a.tags[o]=function(t){if(0!==t[0])throw new Error("Invalid CID for CBOR tag 42; expected leading 0x00");return s.k0.decode(t.subarray(1))};const c="dag-cbor",l=113,u=t=>r.cv(t,i),d=t=>r.Jx(t,a)},10993:function(t,e,n){"use strict";n.r(e),n.d(e,{code:function(){return h},decode:function(){return f},encode:function(){return p},format:function(){return y},name:function(){return d},parse:function(){return w},stringify:function(){return y}});var r=n(11015),s=n(99382),o=n(64936),i=n(97223);function a(t){const e=s.base64.encode(t).slice(1);return[new o.WU(o.Dy.map,1/0,1),new o.WU(o.Dy.string,"/",1),new o.WU(o.Dy.map,1/0,1),new o.WU(o.Dy.string,"bytes",5),new o.WU(o.Dy.string,e,e.length),new o.WU(o.Dy.break,void 0,1),new o.WU(o.Dy.break,void 0,1)]}const c={typeEncoders:{Object:function(t){if(t.asCID!==t&&t["/"]!==t.bytes)return null;const e=r.k0.asCID(t);if(!e)return null;const n=e.toString();return[new o.WU(o.Dy.map,1/0,1),new o.WU(o.Dy.string,"/",1),new o.WU(o.Dy.string,n,n.length),new o.WU(o.Dy.break,void 0,1)]},Uint8Array:a,Buffer:a,undefined:function(){throw new Error("`undefined` is not supported by the IPLD Data Model and cannot be encoded")},number:function(t){if(Number.isNaN(t))throw new Error("`NaN` is not supported by the IPLD Data Model and cannot be encoded");if(t===1/0||t===-1/0)throw new Error("`Infinity` and `-Infinity` is not supported by the IPLD Data Model and cannot be encoded");return null}}};class l extends i.d2{constructor(t,e){super(t,e),this.tokenBuffer=[]}done(){return 0===this.tokenBuffer.length&&super.done()}_next(){return this.tokenBuffer.length>0?this.tokenBuffer.pop():super.next()}next(){const t=this._next();if(t.type===o.Dy.map){const t=this._next();if(t.type===o.Dy.string&&"/"===t.value){const t=this._next();if(t.type===o.Dy.string){if(this._next().type!==o.Dy.break)throw new Error("Invalid encoded CID form");return this.tokenBuffer.push(t),new o.WU(o.Dy.tag,42,0)}if(t.type===o.Dy.map){const t=this._next();if(t.type===o.Dy.string&&"bytes"===t.value){const t=this._next();if(t.type===o.Dy.string){for(let t=0;t<2;t++){if(this._next().type!==o.Dy.break)throw new Error("Invalid encoded Bytes form")}const e=s.base64.decode(`m${t.value}`);return new o.WU(o.Dy.bytes,e,t.value.length)}this.tokenBuffer.push(t)}this.tokenBuffer.push(t)}this.tokenBuffer.push(t)}this.tokenBuffer.push(t)}return t}}const u={allowIndefinite:!1,allowUndefined:!1,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};u.tags[42]=r.k0.parse;const d="dag-json",h=297,p=t=>i.cv(t,c),f=t=>{const e=Object.assign(u,{tokenizer:new l(t,u)});return i.Jx(t,e)},y=t=>g.decode(p(t)),g=new TextDecoder,w=t=>f(m.encode(t)),m=new TextEncoder},33808:function(t,e,n){"use strict";n.r(e),n.d(e,{code:function(){return D},createLink:function(){return A},createNode:function(){return T},decode:function(){return N},encode:function(){return P},name:function(){return I},prepare:function(){return R},validate:function(){return S}});var r=n(38161);const s=new TextDecoder;function o(t,e){let n=0;for(let r=0;;r+=7){if(r>=64)throw new Error("protobuf: varint overflow");if(e>=t.length)throw new Error("protobuf: unexpected end of data");const s=t[e++];if(n+=r<28?(127&s)<<r:(127&s)*2**r,s<128)break}return[n,e]}function i(t,e){let n;[n,e]=o(t,e);const r=e+n;if(n<0||r<0)throw new Error("protobuf: invalid length");if(r>t.length)throw new Error("protobuf: unexpected end of data");return[t.subarray(e,r),r]}function a(t,e){let n;return[n,e]=o(t,e),[7&n,n>>3,e]}function c(t){const e={},n=t.length;let r=0;for(;r<n;){let n,c;if([n,c,r]=a(t,r),1===c){if(e.Hash)throw new Error("protobuf: (PBLink) duplicate Hash section");if(2!==n)throw new Error(`protobuf: (PBLink) wrong wireType (${n}) for Hash`);if(void 0!==e.Name)throw new Error("protobuf: (PBLink) invalid order, found Name before Hash");if(void 0!==e.Tsize)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Hash");[e.Hash,r]=i(t,r)}else if(2===c){if(void 0!==e.Name)throw new Error("protobuf: (PBLink) duplicate Name section");if(2!==n)throw new Error(`protobuf: (PBLink) wrong wireType (${n}) for Name`);if(void 0!==e.Tsize)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Name");let o;[o,r]=i(t,r),e.Name=s.decode(o)}else{if(3!==c)throw new Error(`protobuf: (PBLink) invalid fieldNumber, expected 1, 2 or 3, got ${c}`);if(void 0!==e.Tsize)throw new Error("protobuf: (PBLink) duplicate Tsize section");if(0!==n)throw new Error(`protobuf: (PBLink) wrong wireType (${n}) for Tsize`);[e.Tsize,r]=o(t,r)}}if(r>n)throw new Error("protobuf: (PBLink) unexpected end of data");return e}const l=new TextEncoder,u=2**32,d=2**31;function h(t,e){let n=e.length;if("number"==typeof t.Tsize){if(t.Tsize<0)throw new Error("Tsize cannot be negative");if(!Number.isSafeInteger(t.Tsize))throw new Error("Tsize too large for encoding");n=y(e,n,t.Tsize)-1,e[n]=24}if("string"==typeof t.Name){const r=l.encode(t.Name);n-=r.length,e.set(r,n),n=y(e,n,r.length)-1,e[n]=18}return t.Hash&&(n-=t.Hash.length,e.set(t.Hash,n),n=y(e,n,t.Hash.length)-1,e[n]=10),e.length-n}function p(t){const e=function(t){let e=0;if(t.Data){const n=t.Data.length;e+=1+n+g(n)}if(t.Links)for(const n of t.Links){const t=f(n);e+=1+t+g(t)}return e}(t),n=new Uint8Array(e);let r=e;if(t.Data&&(r-=t.Data.length,n.set(t.Data,r),r=y(n,r,t.Data.length)-1,n[r]=10),t.Links)for(let e=t.Links.length-1;e>=0;e--){const s=h(t.Links[e],n.subarray(0,r));r-=s,r=y(n,r,s)-1,n[r]=18}return n}function f(t){let e=0;if(t.Hash){const n=t.Hash.length;e+=1+n+g(n)}if("string"==typeof t.Name){const n=l.encode(t.Name).length;e+=1+n+g(n)}return"number"==typeof t.Tsize&&(e+=1+g(t.Tsize)),e}function y(t,e,n){const r=e-=g(n);for(;n>=d;)t[e++]=127&n|128,n/=128;for(;n>=128;)t[e++]=127&n|128,n>>>=7;return t[e]=n,r}function g(t){return t%2==0&&t++,Math.floor((function(t){let e=0;t>=u&&(t=Math.floor(t/u),e=32);t>=65536&&(t>>>=16,e+=16);t>=256&&(t>>>=8,e+=8);return e+w[t]}(t)+6)/7)}const w=[0,1,2,2,3,3,3,3,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8],m=["Data","Links"],b=["Hash","Name","Tsize"],E=new TextEncoder;function _(t,e){if(t===e)return 0;const n=t.Name?E.encode(t.Name):[],r=e.Name?E.encode(e.Name):[];let s=n.length,o=r.length;for(let t=0,e=Math.min(s,o);t<e;++t)if(n[t]!==r[t]){s=n[t],o=r[t];break}return s<o?-1:o<s?1:0}function v(t,e){return!Object.keys(t).some((t=>!e.includes(t)))}function k(t){if("object"==typeof t.asCID){const e=r.k0.asCID(t);if(!e)throw new TypeError("Invalid DAG-PB form");return{Hash:e}}if("object"!=typeof t||Array.isArray(t))throw new TypeError("Invalid DAG-PB form");const e={};if(t.Hash){let n=r.k0.asCID(t.Hash);try{n||("string"==typeof t.Hash?n=r.k0.parse(t.Hash):t.Hash instanceof Uint8Array&&(n=r.k0.decode(t.Hash)))}catch(t){throw new TypeError(`Invalid DAG-PB form: ${t.message}`)}n&&(e.Hash=n)}if(!e.Hash)throw new TypeError("Invalid DAG-PB form");return"string"==typeof t.Name&&(e.Name=t.Name),"number"==typeof t.Tsize&&(e.Tsize=t.Tsize),e}function R(t){if((t instanceof Uint8Array||"string"==typeof t)&&(t={Data:t}),"object"!=typeof t||Array.isArray(t))throw new TypeError("Invalid DAG-PB form");const e={};if(void 0!==t.Data)if("string"==typeof t.Data)e.Data=E.encode(t.Data);else{if(!(t.Data instanceof Uint8Array))throw new TypeError("Invalid DAG-PB form");e.Data=t.Data}if(void 0!==t.Links){if(!Array.isArray(t.Links))throw new TypeError("Invalid DAG-PB form");e.Links=t.Links.map(k),e.Links.sort(_)}else e.Links=[];return e}function S(t){if(!t||"object"!=typeof t||Array.isArray(t)||t instanceof Uint8Array||t["/"]&&t["/"]===t.bytes)throw new TypeError("Invalid DAG-PB form");if(!v(t,m))throw new TypeError("Invalid DAG-PB form (extraneous properties)");if(void 0!==t.Data&&!(t.Data instanceof Uint8Array))throw new TypeError("Invalid DAG-PB form (Data must be bytes)");if(!Array.isArray(t.Links))throw new TypeError("Invalid DAG-PB form (Links must be a list)");for(let e=0;e<t.Links.length;e++){const n=t.Links[e];if(!n||"object"!=typeof n||Array.isArray(n)||n instanceof Uint8Array||n["/"]&&n["/"]===n.bytes)throw new TypeError("Invalid DAG-PB form (bad link)");if(!v(n,b))throw new TypeError("Invalid DAG-PB form (extraneous properties on link)");if(void 0===n.Hash)throw new TypeError("Invalid DAG-PB form (link must have a Hash)");if(null==n.Hash||!n.Hash["/"]||n.Hash["/"]!==n.Hash.bytes)throw new TypeError("Invalid DAG-PB form (link Hash must be a CID)");if(void 0!==n.Name&&"string"!=typeof n.Name)throw new TypeError("Invalid DAG-PB form (link Name must be a string)");if(void 0!==n.Tsize){if("number"!=typeof n.Tsize||n.Tsize%1!=0)throw new TypeError("Invalid DAG-PB form (link Tsize must be an integer)");if(n.Tsize<0)throw new TypeError("Invalid DAG-PB form (link Tsize cannot be negative)")}if(e>0&&-1===_(n,t.Links[e-1]))throw new TypeError("Invalid DAG-PB form (links must be sorted by Name bytes)")}}function T(t,e=[]){return R({Data:t,Links:e})}function A(t,e,n){return k({Hash:n,Name:t,Tsize:e})}const I="dag-pb",D=112;function P(t){S(t);const e={};return t.Links&&(e.Links=t.Links.map((t=>{const e={};return t.Hash&&(e.Hash=t.Hash.bytes),void 0!==t.Name&&(e.Name=t.Name),void 0!==t.Tsize&&(e.Tsize=t.Tsize),e}))),t.Data&&(e.Data=t.Data),p(e)}function N(t){const e=function(t){const e=t.length;let n,r,s=0,o=!1;for(;s<e;){let e,l;if([e,l,s]=a(t,s),2!==e)throw new Error(`protobuf: (PBNode) invalid wireType, expected 2, got ${e}`);if(1===l){if(r)throw new Error("protobuf: (PBNode) duplicate Data section");[r,s]=i(t,s),n&&(o=!0)}else{if(2!==l)throw new Error(`protobuf: (PBNode) invalid fieldNumber, expected 1 or 2, got ${l}`);{if(o)throw new Error("protobuf: (PBNode) duplicate Links section");let e;n||(n=[]),[e,s]=i(t,s),n.push(c(e))}}}if(s>e)throw new Error("protobuf: (PBNode) unexpected end of data");const l={};return r&&(l.Data=r),l.Links=n||[],l}(t),n={};return e.Data&&(n.Data=e.Data),e.Links&&(n.Links=e.Links.map((t=>{const e={};try{e.Hash=r.k0.decode(t.Hash)}catch(t){}if(!e.Hash)throw new Error("Invalid Hash field found in link, expected CID");return void 0!==t.Name&&(e.Name=t.Name),void 0!==t.Tsize&&(e.Tsize=t.Tsize),e}))),n}},46362:function(t,e,n){"use strict";n.d(e,{Ue:function(){return Nk}});var r={};n.r(r),n.d(r,{abortedError:function(){return gk},notFoundError:function(){return yk}});var s=n(79221),o=n(106),i=n(69860),a=n(32114),c=n(25853);const l=c.Reader,u=c.Writer,d=c.util,h=c.roots["ipfs-unixfs"]||(c.roots["ipfs-unixfs"]={}),p=h.Data=(()=>{function t(t){if(this.blocksizes=[],t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.Type=0,t.prototype.Data=d.newBuffer([]),t.prototype.filesize=d.Long?d.Long.fromBits(0,0,!0):0,t.prototype.blocksizes=d.emptyArray,t.prototype.hashType=d.Long?d.Long.fromBits(0,0,!0):0,t.prototype.fanout=d.Long?d.Long.fromBits(0,0,!0):0,t.prototype.mode=0,t.prototype.mtime=null,t.encode=function(t,e){if(e||(e=u.create()),e.uint32(8).int32(t.Type),null!=t.Data&&Object.hasOwnProperty.call(t,"Data")&&e.uint32(18).bytes(t.Data),null!=t.filesize&&Object.hasOwnProperty.call(t,"filesize")&&e.uint32(24).uint64(t.filesize),null!=t.blocksizes&&t.blocksizes.length)for(var n=0;n<t.blocksizes.length;++n)e.uint32(32).uint64(t.blocksizes[n]);return null!=t.hashType&&Object.hasOwnProperty.call(t,"hashType")&&e.uint32(40).uint64(t.hashType),null!=t.fanout&&Object.hasOwnProperty.call(t,"fanout")&&e.uint32(48).uint64(t.fanout),null!=t.mode&&Object.hasOwnProperty.call(t,"mode")&&e.uint32(56).uint32(t.mode),null!=t.mtime&&Object.hasOwnProperty.call(t,"mtime")&&h.UnixTime.encode(t.mtime,e.uint32(66).fork()).ldelim(),e},t.decode=function(t,e){t instanceof l||(t=l.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new h.Data;t.pos<n;){var s=t.uint32();switch(s>>>3){case 1:r.Type=t.int32();break;case 2:r.Data=t.bytes();break;case 3:r.filesize=t.uint64();break;case 4:if(r.blocksizes&&r.blocksizes.length||(r.blocksizes=[]),2==(7&s))for(var o=t.uint32()+t.pos;t.pos<o;)r.blocksizes.push(t.uint64());else r.blocksizes.push(t.uint64());break;case 5:r.hashType=t.uint64();break;case 6:r.fanout=t.uint64();break;case 7:r.mode=t.uint32();break;case 8:r.mtime=h.UnixTime.decode(t,t.uint32());break;default:t.skipType(7&s)}}if(!r.hasOwnProperty("Type"))throw d.ProtocolError("missing required 'Type'",{instance:r});return r},t.fromObject=function(t){if(t instanceof h.Data)return t;var e=new h.Data;switch(t.Type){case"Raw":case 0:e.Type=0;break;case"Directory":case 1:e.Type=1;break;case"File":case 2:e.Type=2;break;case"Metadata":case 3:e.Type=3;break;case"Symlink":case 4:e.Type=4;break;case"HAMTShard":case 5:e.Type=5}if(null!=t.Data&&("string"==typeof t.Data?d.base64.decode(t.Data,e.Data=d.newBuffer(d.base64.length(t.Data)),0):t.Data.length&&(e.Data=t.Data)),null!=t.filesize&&(d.Long?(e.filesize=d.Long.fromValue(t.filesize)).unsigned=!0:"string"==typeof t.filesize?e.filesize=parseInt(t.filesize,10):"number"==typeof t.filesize?e.filesize=t.filesize:"object"==typeof t.filesize&&(e.filesize=new d.LongBits(t.filesize.low>>>0,t.filesize.high>>>0).toNumber(!0))),t.blocksizes){if(!Array.isArray(t.blocksizes))throw TypeError(".Data.blocksizes: array expected");e.blocksizes=[];for(var n=0;n<t.blocksizes.length;++n)d.Long?(e.blocksizes[n]=d.Long.fromValue(t.blocksizes[n])).unsigned=!0:"string"==typeof t.blocksizes[n]?e.blocksizes[n]=parseInt(t.blocksizes[n],10):"number"==typeof t.blocksizes[n]?e.blocksizes[n]=t.blocksizes[n]:"object"==typeof t.blocksizes[n]&&(e.blocksizes[n]=new d.LongBits(t.blocksizes[n].low>>>0,t.blocksizes[n].high>>>0).toNumber(!0))}if(null!=t.hashType&&(d.Long?(e.hashType=d.Long.fromValue(t.hashType)).unsigned=!0:"string"==typeof t.hashType?e.hashType=parseInt(t.hashType,10):"number"==typeof t.hashType?e.hashType=t.hashType:"object"==typeof t.hashType&&(e.hashType=new d.LongBits(t.hashType.low>>>0,t.hashType.high>>>0).toNumber(!0))),null!=t.fanout&&(d.Long?(e.fanout=d.Long.fromValue(t.fanout)).unsigned=!0:"string"==typeof t.fanout?e.fanout=parseInt(t.fanout,10):"number"==typeof t.fanout?e.fanout=t.fanout:"object"==typeof t.fanout&&(e.fanout=new d.LongBits(t.fanout.low>>>0,t.fanout.high>>>0).toNumber(!0))),null!=t.mode&&(e.mode=t.mode>>>0),null!=t.mtime){if("object"!=typeof t.mtime)throw TypeError(".Data.mtime: object expected");e.mtime=h.UnixTime.fromObject(t.mtime)}return e},t.toObject=function(t,e){e||(e={});var n={};if((e.arrays||e.defaults)&&(n.blocksizes=[]),e.defaults){if(n.Type=e.enums===String?"Raw":0,e.bytes===String?n.Data="":(n.Data=[],e.bytes!==Array&&(n.Data=d.newBuffer(n.Data))),d.Long){var r=new d.Long(0,0,!0);n.filesize=e.longs===String?r.toString():e.longs===Number?r.toNumber():r}else n.filesize=e.longs===String?"0":0;if(d.Long){r=new d.Long(0,0,!0);n.hashType=e.longs===String?r.toString():e.longs===Number?r.toNumber():r}else n.hashType=e.longs===String?"0":0;if(d.Long){r=new d.Long(0,0,!0);n.fanout=e.longs===String?r.toString():e.longs===Number?r.toNumber():r}else n.fanout=e.longs===String?"0":0;n.mode=0,n.mtime=null}if(null!=t.Type&&t.hasOwnProperty("Type")&&(n.Type=e.enums===String?h.Data.DataType[t.Type]:t.Type),null!=t.Data&&t.hasOwnProperty("Data")&&(n.Data=e.bytes===String?d.base64.encode(t.Data,0,t.Data.length):e.bytes===Array?Array.prototype.slice.call(t.Data):t.Data),null!=t.filesize&&t.hasOwnProperty("filesize")&&("number"==typeof t.filesize?n.filesize=e.longs===String?String(t.filesize):t.filesize:n.filesize=e.longs===String?d.Long.prototype.toString.call(t.filesize):e.longs===Number?new d.LongBits(t.filesize.low>>>0,t.filesize.high>>>0).toNumber(!0):t.filesize),t.blocksizes&&t.blocksizes.length){n.blocksizes=[];for(var s=0;s<t.blocksizes.length;++s)"number"==typeof t.blocksizes[s]?n.blocksizes[s]=e.longs===String?String(t.blocksizes[s]):t.blocksizes[s]:n.blocksizes[s]=e.longs===String?d.Long.prototype.toString.call(t.blocksizes[s]):e.longs===Number?new d.LongBits(t.blocksizes[s].low>>>0,t.blocksizes[s].high>>>0).toNumber(!0):t.blocksizes[s]}return null!=t.hashType&&t.hasOwnProperty("hashType")&&("number"==typeof t.hashType?n.hashType=e.longs===String?String(t.hashType):t.hashType:n.hashType=e.longs===String?d.Long.prototype.toString.call(t.hashType):e.longs===Number?new d.LongBits(t.hashType.low>>>0,t.hashType.high>>>0).toNumber(!0):t.hashType),null!=t.fanout&&t.hasOwnProperty("fanout")&&("number"==typeof t.fanout?n.fanout=e.longs===String?String(t.fanout):t.fanout:n.fanout=e.longs===String?d.Long.prototype.toString.call(t.fanout):e.longs===Number?new d.LongBits(t.fanout.low>>>0,t.fanout.high>>>0).toNumber(!0):t.fanout),null!=t.mode&&t.hasOwnProperty("mode")&&(n.mode=t.mode),null!=t.mtime&&t.hasOwnProperty("mtime")&&(n.mtime=h.UnixTime.toObject(t.mtime,e)),n},t.prototype.toJSON=function(){return this.constructor.toObject(this,c.util.toJSONOptions)},t.DataType=function(){const t={},e=Object.create(t);return e[t[0]="Raw"]=0,e[t[1]="Directory"]=1,e[t[2]="File"]=2,e[t[3]="Metadata"]=3,e[t[4]="Symlink"]=4,e[t[5]="HAMTShard"]=5,e}(),t})(),f=(h.UnixTime=(()=>{function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.Seconds=d.Long?d.Long.fromBits(0,0,!1):0,t.prototype.FractionalNanoseconds=0,t.encode=function(t,e){return e||(e=u.create()),e.uint32(8).int64(t.Seconds),null!=t.FractionalNanoseconds&&Object.hasOwnProperty.call(t,"FractionalNanoseconds")&&e.uint32(21).fixed32(t.FractionalNanoseconds),e},t.decode=function(t,e){t instanceof l||(t=l.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new h.UnixTime;t.pos<n;){var s=t.uint32();switch(s>>>3){case 1:r.Seconds=t.int64();break;case 2:r.FractionalNanoseconds=t.fixed32();break;default:t.skipType(7&s)}}if(!r.hasOwnProperty("Seconds"))throw d.ProtocolError("missing required 'Seconds'",{instance:r});return r},t.fromObject=function(t){if(t instanceof h.UnixTime)return t;var e=new h.UnixTime;return null!=t.Seconds&&(d.Long?(e.Seconds=d.Long.fromValue(t.Seconds)).unsigned=!1:"string"==typeof t.Seconds?e.Seconds=parseInt(t.Seconds,10):"number"==typeof t.Seconds?e.Seconds=t.Seconds:"object"==typeof t.Seconds&&(e.Seconds=new d.LongBits(t.Seconds.low>>>0,t.Seconds.high>>>0).toNumber())),null!=t.FractionalNanoseconds&&(e.FractionalNanoseconds=t.FractionalNanoseconds>>>0),e},t.toObject=function(t,e){e||(e={});var n={};if(e.defaults){if(d.Long){var r=new d.Long(0,0,!1);n.Seconds=e.longs===String?r.toString():e.longs===Number?r.toNumber():r}else n.Seconds=e.longs===String?"0":0;n.FractionalNanoseconds=0}return null!=t.Seconds&&t.hasOwnProperty("Seconds")&&("number"==typeof t.Seconds?n.Seconds=e.longs===String?String(t.Seconds):t.Seconds:n.Seconds=e.longs===String?d.Long.prototype.toString.call(t.Seconds):e.longs===Number?new d.LongBits(t.Seconds.low>>>0,t.Seconds.high>>>0).toNumber():t.Seconds),null!=t.FractionalNanoseconds&&t.hasOwnProperty("FractionalNanoseconds")&&(n.FractionalNanoseconds=t.FractionalNanoseconds),n},t.prototype.toJSON=function(){return this.constructor.toObject(this,c.util.toJSONOptions)},t})(),h.Metadata=(()=>{function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.MimeType="",t.encode=function(t,e){return e||(e=u.create()),null!=t.MimeType&&Object.hasOwnProperty.call(t,"MimeType")&&e.uint32(10).string(t.MimeType),e},t.decode=function(t,e){t instanceof l||(t=l.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new h.Metadata;t.pos<n;){var s=t.uint32();if(s>>>3==1)r.MimeType=t.string();else t.skipType(7&s)}return r},t.fromObject=function(t){if(t instanceof h.Metadata)return t;var e=new h.Metadata;return null!=t.MimeType&&(e.MimeType=String(t.MimeType)),e},t.toObject=function(t,e){e||(e={});var n={};return e.defaults&&(n.MimeType=""),null!=t.MimeType&&t.hasOwnProperty("MimeType")&&(n.MimeType=t.MimeType),n},t.prototype.toJSON=function(){return this.constructor.toObject(this,c.util.toJSONOptions)},t})(),p),y=["raw","directory","file","metadata","symlink","hamt-sharded-directory"],g=["directory","hamt-sharded-directory"],w=parseInt("0644",8),m=parseInt("0755",8);function b(t){if(null!=t)return"number"==typeof t?4095&t:"0"===(t=t.toString()).substring(0,1)?4095&parseInt(t,8):4095&parseInt(t,10)}function E(t){if(null==t)return;let e;if(null!=t.secs&&(e={secs:t.secs,nsecs:t.nsecs}),null!=t.Seconds&&(e={secs:t.Seconds,nsecs:t.FractionalNanoseconds}),Array.isArray(t)&&(e={secs:t[0],nsecs:t[1]}),t instanceof Date){const n=t.getTime(),r=Math.floor(n/1e3);e={secs:r,nsecs:1e3*(n-1e3*r)}}if(Object.prototype.hasOwnProperty.call(e,"secs")){if(null!=e&&null!=e.nsecs&&(e.nsecs<0||e.nsecs>999999999))throw a(new Error("mtime-nsecs must be within the range [0,999999999]"),"ERR_INVALID_MTIME_NSECS");return e}}class _{static unmarshal(t){const e=f.decode(t),n=f.toObject(e,{defaults:!1,arrays:!0,longs:Number,objects:!1}),r=new _({type:y[n.Type],data:n.Data,blockSizes:n.blocksizes,mode:n.mode,mtime:n.mtime?{secs:n.mtime.Seconds,nsecs:n.mtime.FractionalNanoseconds}:void 0});return r._originalMode=n.mode||0,r}constructor(t={type:"file"}){const{type:e,data:n,blockSizes:r,hashType:s,fanout:o,mtime:i,mode:c}=t;if(e&&!y.includes(e))throw a(new Error("Type: "+e+" is not valid"),"ERR_INVALID_TYPE");this.type=e||"file",this.data=n,this.hashType=s,this.fanout=o,this.blockSizes=r||[],this._originalMode=0,this.mode=b(c),i&&(this.mtime=E(i),this.mtime&&!this.mtime.nsecs&&(this.mtime.nsecs=0))}set mode(t){this._mode=this.isDirectory()?m:w;const e=b(t);void 0!==e&&(this._mode=e)}get mode(){return this._mode}isDirectory(){return Boolean(this.type&&g.includes(this.type))}addBlockSize(t){this.blockSizes.push(t)}removeBlockSize(t){this.blockSizes.splice(t,1)}fileSize(){if(this.isDirectory())return 0;let t=0;return this.blockSizes.forEach((e=>{t+=e})),this.data&&(t+=this.data.length),t}marshal(){let t;switch(this.type){case"raw":t=f.DataType.Raw;break;case"directory":t=f.DataType.Directory;break;case"file":t=f.DataType.File;break;case"metadata":t=f.DataType.Metadata;break;case"symlink":t=f.DataType.Symlink;break;case"hamt-sharded-directory":t=f.DataType.HAMTShard;break;default:throw a(new Error("Type: "+t+" is not valid"),"ERR_INVALID_TYPE")}let e,n,r=this.data;if(this.data&&this.data.length||(r=void 0),null!=this.mode&&(e=4294963200&this._originalMode|(b(this.mode)||0),e!==w||this.isDirectory()||(e=void 0),e===m&&this.isDirectory()&&(e=void 0)),null!=this.mtime){const t=E(this.mtime);t&&(n={Seconds:t.secs,FractionalNanoseconds:t.nsecs},0===n.FractionalNanoseconds&&delete n.FractionalNanoseconds)}const s={Type:t,Data:r,filesize:this.isDirectory()?void 0:this.fileSize(),blocksizes:this.blockSizes,hashType:this.hashType,fanout:this.fanout,mode:e,mtime:n};return f.encode(s).finish()}}var v=n(33808),k=n(90560),R=n(10993),S=n(84296),T=n(38566),A=n(93387),I=n(49260);class D extends Error{constructor(t="not initialized"){super(t),this.name="NotInitializedError",this.code=D.code}}D.code="ERR_NOT_INITIALIZED";class P extends Error{constructor(t="cannot initialize an initializing node"){super(t),this.name="AlreadyInitializingError",this.code=N.code}}P.code="ERR_ALREADY_INITIALIZING";class N extends Error{constructor(t="cannot re-initialize an initialized node"){super(t),this.name="AlreadyInitializedError",this.code=N.code}}N.code="ERR_ALREADY_INITIALIZED";class O extends Error{constructor(t="not started"){super(t),this.name="NotStartedError",this.code=O.code}}O.code="ERR_NOT_STARTED";class L extends Error{constructor(t="cannot start, already startin"){super(t),this.name="AlreadyStartingError",this.code=L.code}}L.code="ERR_ALREADY_STARTING";class C extends Error{constructor(t="cannot start, already started"){super(t),this.name="AlreadyStartedError",this.code=C.code}}C.code="ERR_ALREADY_STARTED";class M extends Error{constructor(t="not enabled"){super(t),this.name="NotEnabledError",this.code=M.code}}M.code="ERR_NOT_ENABLED";var x=n(77408),B=n(10715),z=n(81653),U=n(14249),j=n(29094),$=n(91026),V=n(49736),H=n(49784);const F=V.C,K=V.aY,q=function(t){let e=0;if(t=t.toString().trim(),F(t)){const n=new Uint8Array(e+4);return t.split(/\./g).forEach((t=>{n[e++]=255&parseInt(t,10)})),n}if(K(t)){const n=t.split(":",8);let r;for(r=0;r<n.length;r++){let t;F(n[r])&&(t=q(n[r]),n[r]=(0,H.B)(t.slice(0,2),"base16")),null!=t&&++r<8&&n.splice(r,0,(0,H.B)(t.slice(2,4),"base16"))}if(""===n[0])for(;n.length<8;)n.unshift("0");else if(""===n[n.length-1])for(;n.length<8;)n.push("0");else if(n.length<8){for(r=0;r<n.length&&""!==n[r];r++);const t=[r,1];for(r=9-n.length;r>0;r--)t.push("0");n.splice.apply(n,t)}const s=new Uint8Array(e+16);for(r=0;r<n.length;r++){const t=parseInt(n[r],16);s[e++]=t>>8&255,s[e++]=255&t}return s}throw new Error("invalid ip address")},G=function(t,e=0,n){e=~~e,n=n??t.length-e;const r=new DataView(t.buffer);if(4===n){const r=[];for(let s=0;s<n;s++)r.push(t[e+s]);return r.join(".")}if(16===n){const t=[];for(let s=0;s<n;s+=2)t.push(r.getUint16(e+s).toString(16));return t.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""},W=-1,Z={},Y={};function J(t){if("number"==typeof t){if(null!=Y[t])return Y[t];throw new Error(`no protocol with code: ${t}`)}if("string"==typeof t){if(null!=Z[t])return Z[t];throw new Error(`no protocol with name: ${t}`)}throw new Error("invalid protocol id type: "+typeof t)}[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,W,"ip6zone"],[43,8,"ipcidr"],[53,W,"dns",!0],[54,W,"dns4",!0],[55,W,"dns6",!0],[56,W,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,W,"unix",!1,!0],[421,W,"ipfs"],[421,W,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,W,"garlic64"],[448,0,"tls"],[449,W,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,W,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[777,W,"memory"]].forEach((t=>{const e=function(t,e,n,r,s){return{code:t,size:e,name:n,resolvable:Boolean(r),path:Boolean(s)}}(...t);Y[e.code]=e,Z[e.name]=e}));var Q=n(38161),X=n(38971),tt=n(41690);n(9839);J("ip4"),J("ip6"),J("ipcidr");function et(t,e){switch(J(t).code){case 4:case 41:return function(t){const e=G(t,0,t.length);if(null==e)throw new Error("ipBuff is required");if(!V.h6(e))throw new Error("invalid ip address");return e}(e);case 42:case 53:case 54:case 55:case 56:case 400:case 449:case 777:return lt(e);case 6:case 273:case 33:case 132:return at(e).toString();case 421:return function(t){const e=X.decode(t),n=t.slice(X.decode.bytes);if(n.length!==e)throw new Error("inconsistent lengths");return(0,H.B)(n,"base58btc")}(e);case 444:case 445:return ut(e);case 466:return function(t){const e=X.decode(t),n=t.slice(X.decode.bytes);if(n.length!==e)throw new Error("inconsistent lengths");return"u"+(0,H.B)(n,"base64url")}(e);default:return(0,H.B)(e,"base16")}}function nt(t,e){switch(J(t).code){case 4:case 41:return ot(e);case 42:case 53:case 54:case 55:case 56:case 400:case 449:case 777:return ct(e);case 6:case 273:case 33:case 132:return it(parseInt(e,10));case 421:return function(t){let e;e="Q"===t[0]||"1"===t[0]?j.Jx(z.base58btc.decode(`z${t}`)).bytes:Q.k0.parse(t).multihash.bytes;const n=Uint8Array.from(X.encode(e.length));return(0,tt.z)([n,e],n.length+e.length)}(e);case 444:return function(t){const e=t.split(":");if(2!==e.length)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(16!==e[0].length)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);const n=U.base32.decode("b"+e[0]),r=parseInt(e[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const s=it(r);return(0,tt.z)([n,s],n.length+s.length)}(e);case 445:return function(t){const e=t.split(":");if(2!==e.length)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(56!==e[0].length)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);const n=U.base32.decode(`b${e[0]}`),r=parseInt(e[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const s=it(r);return(0,tt.z)([n,s],n.length+s.length)}(e);case 466:return function(t){const e=st.decode(t),n=Uint8Array.from(X.encode(e.length));return(0,tt.z)([n,e],n.length+e.length)}(e);default:return(0,x.m)(e,"base16")}}const rt=Object.values(A.gh).map((t=>t.decoder)),st=function(){let t=rt[0].or(rt[1]);return rt.slice(2).forEach((e=>t=t.or(e))),t}();function ot(t){if(!V.h6(t))throw new Error("invalid ip address");return q(t)}function it(t){const e=new ArrayBuffer(2);return new DataView(e).setUint16(0,t),new Uint8Array(e)}function at(t){return new DataView(t.buffer).getUint16(t.byteOffset)}function ct(t){const e=(0,x.m)(t),n=Uint8Array.from(X.encode(e.length));return(0,tt.z)([n,e],n.length+e.length)}function lt(t){const e=X.decode(t);if((t=t.slice(X.decode.bytes)).length!==e)throw new Error("inconsistent lengths");return(0,H.B)(t)}function ut(t){const e=t.slice(0,t.length-2),n=t.slice(t.length-2);return`${(0,H.B)(e,"base32")}:${at(n)}`}function dt(t){return t.map((t=>{const e=_t(t);return null!=t[1]?[e.code,et(e.code,t[1])]:[e.code]}))}function ht(t){return wt((0,tt.z)(t.map((t=>{const e=_t(t);let n=Uint8Array.from(X.encode(e.code));return t.length>1&&null!=t[1]&&(n=(0,tt.z)([n,t[1]])),n}))))}function pt(t,e){if(t.size>0)return t.size/8;if(0===t.size)return 0;return X.decode(e)+(X.decode.bytes??0)}function ft(t){const e=[];let n=0;for(;n<t.length;){const r=X.decode(t,n),s=X.decode.bytes??0,o=pt(J(r),t.slice(n+s));if(0===o){e.push([r]),n+=s;continue}const i=t.slice(n+s,n+s+o);if(n+=o+s,n>t.length)throw Et("Invalid address Uint8Array: "+(0,H.B)(t,"base16"));e.push([r,i])}return e}function yt(t){return function(t){const e=[];return t.map((t=>{const n=_t(t);return e.push(n.name),t.length>1&&null!=t[1]&&e.push(t[1]),null})),bt(e.join("/"))}(dt(ft(t)))}function gt(t){const e=function(t){const e=[],n=t.split("/").slice(1);if(1===n.length&&""===n[0])return[];for(let r=0;r<n.length;r++){const s=n[r],o=J(s);if(0!==o.size){if(r++,r>=n.length)throw Et("invalid address: "+t);if(!0===o.path){e.push([s,bt(n.slice(r).join("/"))]);break}e.push([s,n[r]])}else e.push([s])}return e}(t=bt(t));return ht(e.map((t=>{Array.isArray(t)||(t=[t]);const e=_t(t);return t.length>1?[e.code,nt(e.code,t[1])]:[e.code]})))}function wt(t){const e=mt(t);if(null!=e)throw e;return Uint8Array.from(t)}function mt(t){try{ft(t)}catch(t){return t}}function bt(t){return"/"+t.trim().split("/").filter((t=>t)).join("/")}function Et(t){return new Error("Error parsing address: "+t)}function _t(t){return J(t[0])}var vt=n(73062);var kt,Rt,St,Tt,At=function(t,e,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!r:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(t):r?r.value:e.get(t)},It=function(t,e,n,r,s){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!s:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?s.call(t,n):s?s.value=n:e.set(t,n),n};const Dt=Symbol.for("nodejs.util.inspect.custom"),Pt=[J("dns").code,J("dns4").code,J("dns6").code,J("dnsaddr").code],Nt=new Map,Ot=Symbol.for("@multiformats/js-multiaddr/multiaddr");function Lt(t){return Boolean(t?.[Ot])}class Ct{constructor(t){if(kt.set(this,void 0),Rt.set(this,void 0),St.set(this,void 0),this[Tt]=!0,null==t&&(t=""),t instanceof Uint8Array)this.bytes=wt(t);else if("string"==typeof t){if(t.length>0&&"/"!==t.charAt(0))throw new Error(`multiaddr "${t}" must start with a "/"`);this.bytes=gt(t)}else{if(!Lt(t))throw new Error("addr must be a string, Buffer, or another Multiaddr");this.bytes=wt(t.bytes)}}toString(){return null==At(this,kt,"f")&&It(this,kt,yt(this.bytes),"f"),At(this,kt,"f")}toJSON(){return this.toString()}toOptions(){let t,e,n,r,s="";const o=J("tcp"),i=J("udp"),a=J("ip4"),c=J("ip6"),l=J("dns6"),u=J("ip6zone");for(const[d,h]of this.stringTuples())d===u.code&&(s=`%${h??""}`),Pt.includes(d)&&(e=o.name,r=443,n=`${h??""}${s}`,t=d===l.code?6:4),d!==o.code&&d!==i.code||(e=J(d).name,r=parseInt(h??"")),d!==a.code&&d!==c.code||(e=J(d).name,n=`${h??""}${s}`,t=d===c.code?6:4);if(null==t||null==e||null==n||null==r)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:t,host:n,transport:e,port:r}}protos(){return this.protoCodes().map((t=>Object.assign({},J(t))))}protoCodes(){const t=[],e=this.bytes;let n=0;for(;n<e.length;){const r=X.decode(e,n),s=X.decode.bytes??0;n+=pt(J(r),e.slice(n+s))+s,t.push(r)}return t}protoNames(){return this.protos().map((t=>t.name))}tuples(){return null==At(this,Rt,"f")&&It(this,Rt,ft(this.bytes),"f"),At(this,Rt,"f")}stringTuples(){return null==At(this,St,"f")&&It(this,St,dt(this.tuples()),"f"),At(this,St,"f")}encapsulate(t){return t=new Ct(t),new Ct(this.toString()+t.toString())}decapsulate(t){const e=t.toString(),n=this.toString(),r=n.lastIndexOf(e);if(r<0)throw new Error(`Address ${this.toString()} does not contain subaddress: ${t.toString()}`);return new Ct(n.slice(0,r))}decapsulateCode(t){const e=this.tuples();for(let n=e.length-1;n>=0;n--)if(e[n][0]===t)return new Ct(ht(e.slice(0,n)));return this}getPeerId(){try{const t=this.stringTuples().filter((t=>t[0]===Z.ipfs.code)),e=t.pop();if(null!=e?.[1]){const t=e[1];return"Q"===t[0]||"1"===t[0]?(0,H.B)(z.base58btc.decode(`z${t}`),"base58btc"):(0,H.B)(Q.k0.parse(t).multihash.bytes,"base58btc")}return null}catch(t){return null}}getPath(){let t=null;try{t=this.stringTuples().filter((t=>!0===J(t[0]).path))[0][1],null==t&&(t=null)}catch{t=null}return t}equals(t){return(0,vt.f)(this.bytes,t.bytes)}async resolve(t){const e=this.protos().find((t=>t.resolvable));if(null==e)return[this];const n=Nt.get(e.name);if(null==n)throw a(new Error(`no available resolver for ${e.name}`),"ERR_NO_AVAILABLE_RESOLVER");return(await n(this,t)).map((t=>new Ct(t)))}nodeAddress(){const t=this.toOptions();if("tcp"!==t.transport&&"udp"!==t.transport)throw new Error(`multiaddr must have a valid format - no protocol with name: "${t.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:t.family,address:t.host,port:t.port}}isThinWaistAddress(t){const e=(t??this).protos();return 2===e.length&&((4===e[0].code||41===e[0].code)&&(6===e[1].code||273===e[1].code))}[(kt=new WeakMap,Rt=new WeakMap,St=new WeakMap,Tt=Ot,Dt)](){return`Multiaddr(${yt(this.bytes)})`}}function Mt(t){return new Ct(t)}const xt=ae("dns4"),Bt=ae("dns6"),zt=ae("dnsaddr"),Ut=ie(ae("dns"),zt,xt,Bt),jt=ie(ae("ip4"),ae("ip6")),$t=ie(oe(jt,ae("tcp")),oe(Ut,ae("tcp"))),Vt=oe(jt,ae("udp")),Ht=oe(Vt,ae("utp")),Ft=oe(Vt,ae("quic")),Kt=ie(oe($t,ae("ws")),oe(Ut,ae("ws"))),qt=ie(oe($t,ae("wss")),oe(Ut,ae("wss")),oe($t,ae("tls"),ae("ws")),oe(Ut,ae("tls"),ae("ws"))),Gt=ie(oe($t,ae("http")),oe(jt,ae("http")),oe(Ut,ae("http"))),Wt=ie(oe($t,ae("https")),oe(jt,ae("https")),oe(Ut,ae("https"))),Zt=oe(Vt,ae("webrtc"),ae("certhash")),Yt=ie(oe(Zt,ae("p2p")),Zt),Jt=ie(oe(Kt,ae("p2p-webrtc-star"),ae("p2p")),oe(qt,ae("p2p-webrtc-star"),ae("p2p")),oe(Kt,ae("p2p-webrtc-star")),oe(qt,ae("p2p-webrtc-star"))),Qt=(ie(oe(Kt,ae("p2p-websocket-star"),ae("p2p")),oe(qt,ae("p2p-websocket-star"),ae("p2p")),oe(Kt,ae("p2p-websocket-star")),oe(qt,ae("p2p-websocket-star"))),ie(oe(Gt,ae("p2p-webrtc-direct"),ae("p2p")),oe(Wt,ae("p2p-webrtc-direct"),ae("p2p")),oe(Gt,ae("p2p-webrtc-direct")),oe(Wt,ae("p2p-webrtc-direct")))),Xt=ie(Kt,qt,Gt,Wt,Jt,Qt,$t,Ht,Ft,Ut,Yt),te=(ie(oe(Xt,ae("p2p-stardust"),ae("p2p")),oe(Xt,ae("p2p-stardust"))),ie(oe(Xt,ae("p2p")),Jt,Qt,Yt,ae("p2p"))),ee=ie(oe(te,ae("p2p-circuit"),te),oe(te,ae("p2p-circuit")),oe(ae("p2p-circuit"),te),oe(Xt,ae("p2p-circuit")),oe(ae("p2p-circuit"),Xt),ae("p2p-circuit")),ne=()=>ie(oe(ee,ne),ee),re=ne();ie(oe(re,te,re),oe(te,re),oe(re,te),re,te);function se(t){return function(e){let n;try{n=Mt(e)}catch(t){return!1}const r=t(n.protoNames());return null!==r&&(!0===r||!1===r?r:0===r.length)}}function oe(...t){function e(e){if(e.length<t.length)return null;let n=e;return t.some((t=>(n="function"==typeof t?t().partialMatch(e):t.partialMatch(e),Array.isArray(n)&&(e=n),null===n))),n}return{toString:function(){return"{ "+t.join(" ")+" }"},input:t,matches:se(e),partialMatch:e}}function ie(...t){function e(e){let n=null;return t.some((t=>{const r="function"==typeof t?t().partialMatch(e):t.partialMatch(e);return null!=r&&(n=r,!0)})),n}return{toString:function(){return"{ "+t.join(" ")+" }"},input:t,matches:se(e),partialMatch:e}}function ae(t){const e=t;return{toString:function(){return e},matches:function(t){let n;try{n=Mt(t)}catch(t){return!1}const r=n.protoNames();return 1===r.length&&r[0]===e},partialMatch:function(t){return 0===t.length?null:t[0]===e?t.slice(1):null}}}var ce=n(17745);const le=/^\/(ip[fn]s)\/([^/?#]+)/,ue=/^https?:\/\/([^/]+)\.(ip[fn]s)\.[^/?]+/,de=/^(([a-z0-9]|[a-z0-9][a-z0-9-]*[a-z0-9])\.)+([a-z0-9]|[a-z0-9][a-z0-9-]*[a-z0-9])$/;function he(t){try{return ye(t)?Boolean(Q.k0.parse(t)):t instanceof Uint8Array?Boolean(Q.k0.decode(t)):Boolean(Q.k0.asCID(t))}catch{return!1}}function pe(t,e,n=1,r=2){const s=ge(t);if(!1===s)return!1;const o=s.match(e);if(null==o)return!1;if("ipfs"!==o[n])return!1;let i=o[r];return null!=i&&e===ue&&(i=i.toLowerCase()),he(i)}function fe(t,e,n=1,r=2){const s=ge(t);if(!1===s)return!1;const o=s.match(e);if(null==o)return!1;if("ipns"!==o[n])return!1;let i=o[r];if(null!=i&&e===ue){if(i=i.toLowerCase(),he(i))return!0;try{!i.includes(".")&&i.includes("-")&&(i=i.replace(/--/g,"@").replace(/-/g,".").replace(/@/g,"-"));const{hostname:t}=new ce.URL(`http://${i}`);return de.test(t)}catch(t){return!1}}return!0}function ye(t){return"string"==typeof t}function ge(t){return t instanceof Uint8Array?(0,H.B)(t,"base58btc"):!!ye(t)&&t}const we=t=>pe(t,le)||fe(t,le),me=t=>fe(t,le);var be=n(66699),Ee=n(45847),_e=n(41966);const ve="This command must be run in online mode. Try running 'ipfs daemon' first.",ke=new be.s("/local/filesroot"),Re=t=>t instanceof Uint8Array?Q.k0.decode(t).toString():(0===(t=t.toString()).indexOf("/ipfs/")&&(t=t.substring("/ipfs/".length)),"/"===t.charAt(t.length-1)&&(t=t.substring(0,t.length-1)),t),Se=async function(t,e,n,r={}){const{cid:s,path:o}=(0,_e.B)(n);o&&(r.path=o);let i=s,a=r.path||"";if(a.startsWith("/")&&(a=a.substring(1)),r.path)try{for await(const{value:n,remainderPath:o}of Ie(s,r.path,e,t,{signal:r.signal})){if(!Q.k0.asCID(n))break;a=o,i=n}}catch(t){throw t.message.startsWith("Object has no property")&&(t.message=`no link named "${a.split("/")[0]}" under ${i}`,t.code="ERR_NO_LINK"),t}return{cid:i,remainderPath:a||""}},Te=t=>{if("file"!==t.type&&"directory"!==t.type&&"raw"!==t.type)throw new Error(`Unknown node type '${t.type}'`);const e={cid:t.cid,path:t.path,name:t.name,size:t.size,type:"file"};return"directory"===t.type&&(e.type="dir"),"file"===t.type&&(e.size=t.unixfs.fileSize()),"file"!==t.type&&"directory"!==t.type||(e.mode=t.unixfs.mode,void 0!==t.unixfs.mtime&&(e.mtime=t.unixfs.mtime)),e},Ae=(0,Ee.a)((async(t,e)=>await t)),Ie=async function*(t,e,n,r,s){const o=async t=>{const e=await n.getCodec(t.code),o=await r.blocks.get(t,s);return e.decode(o)},i=e.split("/").filter(Boolean);let c=await o(t),l=t;for(;i.length;){const n=i.shift();if(!n)throw a(new Error(`Could not resolve path "${e}"`),"ERR_INVALID_PATH");if(t.code===v.code&&Array.isArray(c.Links)){const t=c.Links.find((t=>t.Name===n));if(t){yield{value:t.Hash,remainderPath:i.join("/")},c=await o(t.Hash),l=t.Hash;continue}}if(!Object.prototype.hasOwnProperty.call(c,n))throw a(new Error(`no link named "${n}" under ${l}`),"ERR_NO_LINK");c=c[n],yield{value:c,remainderPath:i.join("/")},Q.k0.asCID(c)&&(l=c,c=await o(c))}yield{value:c,remainderPath:""}};class De{static create({start:t,stop:e}){return new De(t,e)}static async start(t,e){const{state:n,activate:r}=t;switch(n.status){case"stopped":try{const n=r(e);t.state={status:"starting",ready:n};const s=await n;return t.state={status:"started",value:s},s}catch(e){throw t.state={status:"stopped"},e}case"starting":throw new L;case"started":throw new C;case"stopping":return await n.ready,await De.start(t,e);default:return De.panic(t)}}static async stop(t){const{state:e,deactivate:n}=t;switch(e.status){case"stopped":break;case"starting":try{await e.ready}catch(t){}return await De.stop(t);case"stopping":return await e.ready;case"started":n&&await n(e.value),t.state={status:"stopped"};break;default:De.panic(e)}}static try({state:t}){return"started"===t.status?t.value:null}static async use({state:t},e){switch(t.status){case"started":return t.value;case"starting":return await Ae(t.ready,e);default:throw new O}}static panic({state:t}){const e=JSON.stringify({status:t.status});throw RangeError(`Service in invalid state ${e}, should never happen if you see this please report a bug`)}constructor(t,e){this.activate=t,this.deactivate=e,this.state={status:"stopped"}}async use(t){return await De.use(this,t)}try(){return De.try(this)}}var Pe=n(1325);var Ne=n(23366);function Oe({repo:t,codecs:e,bases:n,name:r}){return(0,Ee.a)((async function(s,o={}){if(!we(s))throw new Error("invalid argument "+s);if(me(s))for await(const t of r.resolve(s,o))s=t;const[,i,a,...c]=s.split("/"),l=o.cidBase?await n.getBase(o.cidBase):void 0,u=function(t){try{return(0,Ne.jE)(t).toBytes()}catch{return Q.k0.parse(t).bytes}}(a);if(0===c.length){return`/${i}/${l?l.encoder.encode(u):a}`}const d=Q.k0.decode(u);s=c.join("/");const h=Ie(d,s,e,t,o);let p=d,f=s;for await(const t of h)Q.k0.asCID(t.value)&&(p=t.value,f=t.remainderPath);return`/ipfs/${p.toString(l&&l.encoder)}${f?"/"+f:""}`}))}var Le=n(68883);var Ce=n(73297),Me=n(69044);function xe(t,e,n){const r={type:t,cid:e};return n&&(r.metadata=n),r}class Be{constructor({codecs:t,repo:e}){const n=function({repo:t,codecs:e}){return(0,Ee.a)((async function*(n,r={}){const s=async function*(){for await(const{path:r,recursive:s,metadata:o}of(0,Ce.f)(n)){const{cid:n}=await Se(t,e,r),{reason:i}=await t.pins.isPinnedWithType(n,[Me.R.recursive,Me.R.direct]);if("recursive"===i&&!s)throw new Error(`${n} already pinned recursively`);s?await t.pins.pinRecursively(n,{metadata:o}):await t.pins.pinDirectly(n,{metadata:o}),yield n}};if(!Boolean(r.lock))return void(yield*s());const o=await t.gcLock.readLock();try{yield*s()}finally{o()}}))}({codecs:t,repo:e});this.addAll=n,this.add=function({addAll:t}){return(e,n={})=>{let r;const s=Q.k0.asCID(e);return r=t(s?[{cid:s,...n}]:[{path:e.toString(),...n}],n),(0,Le.Z)(r)}}({addAll:n});const r=function({repo:t,codecs:e}){return(0,Ee.a)((async function*(n,r={}){const s=await t.gcLock.readLock();try{for await(const{path:r,recursive:s}of(0,Ce.f)(n)){const{cid:n}=await Se(t,e,r),{pinned:o,reason:i}=await t.pins.isPinnedWithType(n,Me.R.all);if(!o)throw new Error(`${n} is not pinned`);switch(i){case Me.R.recursive:if(!s)throw new Error(`${n} is pinned recursively`);await t.pins.unpin(n),yield n;break;case Me.R.direct:await t.pins.unpin(n),yield n;break;default:throw new Error(`${n} is pinned indirectly under ${i}`)}}}finally{s()}}))}({codecs:t,repo:e});this.rmAll=r,this.rm=function({rmAll:t}){return async function(e,n={}){const r=await(0,Le.Z)(t([{path:e,...n}],n));if(!r)throw new Error("CID expected");return r}}({rmAll:r}),this.ls=function({repo:t,codecs:e}){return(0,Ee.a)((async function*(n={}){let r=Me.R.all;if(n.type&&(r=n.type,!Object.keys(Me.R).includes(r)))throw a(new Error("Invalid pin type"),"ERR_INVALID_PIN_TYPE");if(n.paths){let s=!1;for await(const{path:o}of(0,Ce.f)(n.paths)){const{cid:n}=await Se(t,e,o),{reason:i,pinned:c,parent:l,metadata:u}=await t.pins.isPinnedWithType(n,r);if(!c)throw a(new Error(`path '${o}' is not pinned`),"ERR_NOT_PINNED");switch(i){case Me.R.direct:case Me.R.recursive:s=!0,yield xe(i,n,u);break;default:s=!0,yield xe(`${Me.R.indirect} through ${l}`,n,u)}}if(!s)throw new Error("No match found")}else{if(r===Me.R.recursive||r===Me.R.all)for await(const{cid:e,metadata:n}of t.pins.recursiveKeys())yield xe(Me.R.recursive,e,n);if(r===Me.R.indirect||r===Me.R.all)for await(const e of t.pins.indirectKeys(n))yield xe(Me.R.indirect,e);if(r===Me.R.direct||r===Me.R.all)for await(const{cid:e,metadata:n}of t.pins.directKeys())yield xe(Me.R.direct,e,n)}}))}({codecs:t,repo:e}),this.remote={add:(t,e={})=>Promise.reject(new Error("Not implemented")),ls:async function*(t,e={}){return Promise.reject(new Error("Not implemented"))},rm:(t,e={})=>Promise.reject(new Error("Not implemented")),rmAll:(t,e={})=>Promise.reject(new Error("Not implemented")),service:{add:(t,e)=>Promise.reject(new Error("Not implemented")),rm:(t,e={})=>Promise.reject(new Error("Not implemented")),ls:(t={})=>Promise.reject(new Error("Not implemented"))}}}}var ze=n(682);function Ue(t){return t=t||new Error("Not Found"),a(t,"ERR_NOT_FOUND")}var je=n(79297),$e=n(86906);const Ve="ERR_UNRECOGNIZED_VALIDITY",He="ERR_SIGNATURE_VERIFICATION",Fe="ERR_UNDEFINED_PARAMETER";var Ke=n(77914),qe=n(97151),Ge=n(29078),We=n(48320);n(44738)._configure(),Ke._configure(qe),Ge._configure(We);const Ze=["uint64","int64","sint64","fixed64","sfixed64"];function Ye(t){return function(t){for(const e of Ze){if(null==t[e])continue;const n=t[e];t[e]=function(){return BigInt(n.call(this).toString())}}return t}(new Ke(t))}function Je(){return function(t){for(const e of Ze){if(null==t[e])continue;const n=t[e];t[e]=function(t){return n.call(this,t.toString())}}return t}(Ge.create())}var Qe,Xe;function tn(t,e,n,r){return{name:t,type:e,encode:n,decode:r}}!function(t){t[t.VARINT=0]="VARINT",t[t.BIT64=1]="BIT64",t[t.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",t[t.START_GROUP=3]="START_GROUP",t[t.END_GROUP=4]="END_GROUP",t[t.BIT32=5]="BIT32"}(Qe||(Qe={})),function(t){let e,n,r;!function(t){t.EOL="EOL"}(e=t.ValidityType||(t.ValidityType={})),function(t){t[t.EOL=0]="EOL"}(n||(n={})),function(t){t.codec=()=>function(t){function e(e){if(null==t[e.toString()])throw new Error("Invalid enum value");return t[e]}return tn("enum",Qe.VARINT,(function(t,n){const r=e(t);n.int32(r)}),(function(t){return e(t.int32())}))}(n)}(e=t.ValidityType||(t.ValidityType={})),t.codec=()=>(null==r&&(r=function(t,e){return tn("message",Qe.LENGTH_DELIMITED,t,e)}(((e,n,r={})=>{!1!==r.lengthDelimited&&n.fork(),null!=e.value&&(n.uint32(10),n.bytes(e.value)),null!=e.signature&&(n.uint32(18),n.bytes(e.signature)),null!=e.validityType&&(n.uint32(24),t.ValidityType.codec().encode(e.validityType,n)),null!=e.validity&&(n.uint32(34),n.bytes(e.validity)),null!=e.sequence&&(n.uint32(40),n.uint64(e.sequence)),null!=e.ttl&&(n.uint32(48),n.uint64(e.ttl)),null!=e.pubKey&&(n.uint32(58),n.bytes(e.pubKey)),null!=e.signatureV2&&(n.uint32(66),n.bytes(e.signatureV2)),null!=e.data&&(n.uint32(74),n.bytes(e.data)),!1!==r.lengthDelimited&&n.ldelim()}),((e,n)=>{const r={},s=null==n?e.len:e.pos+n;for(;e.pos<s;){const n=e.uint32();switch(n>>>3){case 1:r.value=e.bytes();break;case 2:r.signature=e.bytes();break;case 3:r.validityType=t.ValidityType.codec().decode(e);break;case 4:r.validity=e.bytes();break;case 5:r.sequence=e.uint64();break;case 6:r.ttl=e.uint64();break;case 7:r.pubKey=e.bytes();break;case 8:r.signatureV2=e.bytes();break;case 9:r.data=e.bytes();break;default:e.skipType(7&n)}}return r}))),r),t.encode=e=>function(t,e){const n=Je();return e.encode(t,n,{lengthDelimited:!1}),n.finish()}(e,t.codec()),t.decode=e=>function(t,e){const n=Ye(t instanceof Uint8Array?t:t.subarray());return e.decode(n)}(e,t.codec())}(Xe||(Xe={}));var en=n(64936);const nn=(0,i.kg)("ipns:utils"),rn=(0,x.m)("/ipns/");function sn(t){const e=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),n=String(t).trim().match(e);if(null==n)throw new Error("Invalid format");const r=parseInt(n[1],10),s=parseInt(n[2],10)-1,o=parseInt(n[3],10),i=parseInt(n[4],10),a=parseInt(n[5],10),c=parseInt(n[6],10),l=parseInt(n[7].slice(0,-6),10);return new Date(Date.UTC(r,s,o,i,a,c,l))}const on=t=>{const e=(0,x.m)("ipns-signature:");return(0,tt.z)([e,t])},an=t=>{const e=Xe.decode(t);return null!=e.sequence&&(e.sequence=BigInt(e.sequence)),null!=e.ttl&&(e.ttl=BigInt(e.ttl)),{value:e.value??new Uint8Array(0),signature:e.signature??new Uint8Array(0),validityType:e.validityType??Xe.ValidityType.EOL,validity:e.validity??new Uint8Array(0),sequence:e.sequence??0n,pubKey:e.pubKey,ttl:e.ttl??void 0,signatureV2:e.signatureV2,data:e.data}},cn=t=>(0,tt.z)([rn,t.toBytes()]),ln=(0,i.kg)("ipns"),un=T.identity.code,dn="/ipns/",hn=dn.length,pn=async(t,e,n,r,s,o)=>{n=BigInt(n);const i=(0,x.m)(s.toString());if(null==t.privateKey)throw a(new Error("Missing private key"),"ERR_MISSING_PRIVATE_KEY");const c=await(0,$e.unmarshalPrivateKey)(t.privateKey),l=await yn(c,e,r,i),u=((t,e,n,r,s)=>{let o;if(n!==Xe.ValidityType.EOL)throw a(new Error("Unknown validity type"),Ve);o=0;const i={Value:t,Validity:e,ValidityType:o,Sequence:r,TTL:s};return en.cv(i)})(e,i,r,n,o),d=on(u),h={value:e,signature:l,validityType:r,validity:i,sequence:n,ttl:o,signatureV2:await c.sign(d),data:u};if(null!=t.publicKey){const e=j.Jx(t.toBytes());e.code===un&&(0,vt.f)(t.publicKey,e.digest)||(h.pubKey=t.publicKey)}return ln("ipns entry for %b created",e),h},fn=t=>new be.s(`/ipns/${(t=>U.base32upper.encode(t).slice(1))(t)}`),yn=async(t,e,n,r)=>{try{const s=((t,e,n)=>{const r=(0,x.m)(e);return(0,tt.z)([t,n,r])})(e,n,r);return await t.sign(s)}catch(t){throw ln.error("record signature creation failed",t),a(new Error("record signature creation failed"),"ERR_SIGNATURE_CREATION")}},gn=(0,i.kg)("ipfs:ipns:publisher"),wn=Ue().code,mn=36e5;class bn{constructor(t,e){this._routing=t,this._datastore=e}async publishWithEOL(t,e,n,r){const s=await this._updateOrCreateRecord(t,e,n,r);return this._putRecordToRouting(s,t,r)}publish(t,e,n){return this.publishWithEOL(t,e,mn,n)}async _putRecordToRouting(t,e,n){if(!(0,ze.I)(e)){const t="peerId received is not valid";throw gn.error(t),a(new Error(t),"ERR_INVALID_PEER_ID")}if(null==e.publicKey)throw a(new Error("Public key was missing"),"ERR_MISSING_PUBLIC_KEY");const r=cn(e);return await this._publishEntry(r,t,n),t}async _publishEntry(t,e,n){try{const r=await this._routing.put(t,e,n);return gn(`ipns record for ${(0,H.B)(t,"base32")} was stored in the routing`),r}catch(e){const n=`ipns record for ${(0,H.B)(t,"base32")} could not be stored in the routing - ${e.stack}`;throw gn.error(n),gn.error(e),a(new Error(n),"ERR_PUTTING_TO_ROUTING")}}async _getPublished(t,e={}){if(!(0,ze.I)(t)){const t="peerId received is not valid";throw gn.error(t),a(new Error(t),"ERR_INVALID_PEER_ID")}const n=!1!==e.checkRouting;try{const e=await this._datastore.get(fn(t.toBytes()));return this._unmarshalData(e)}catch(e){if(e.code!==wn){const e=`unexpected error getting the ipns record ${t.toString()} from datastore`;throw gn.error(e),a(new Error(e),"ERR_UNEXPECTED_DATASTORE_RESPONSE")}if(!n)throw a(e,"ERR_NOT_FOUND_AND_CHECK_ROUTING_NOT_ENABLED");try{const e=cn(t),n=await this._routing.get(e);return this._unmarshalData(n)}catch(t){throw gn.error(t),t}}}_unmarshalData(t){try{return an(t)}catch(t){throw a(t,"ERR_INVALID_RECORD_DATA")}}async _updateOrCreateRecord(t,e,n,r){if(!(0,ze.I)(t)){const t="peerId received is not valid";throw gn.error(t),a(new Error(t),"ERR_INVALID_PEER_ID")}const s={checkRouting:!0};let o;try{o=await this._getPublished(t,s)}catch(e){if(e.code!==wn){const n=`unexpected error when determining the last published IPNS record for ${t.toString()} ${e.stack}`;throw gn.error(n),a(new Error(n),"ERR_DETERMINING_PUBLISHED_RECORD")}}let i,c=0n;o&&void 0!==o.sequence&&(c=(0,vt.f)(o.value,e)?o.sequence:o.sequence+BigInt(1));try{i=await(async(t,e,n,r)=>{const s=new je(Date.now()+Number(r)),o=Xe.ValidityType.EOL,[i,a]=r.toString().split("."),c=BigInt(i)*BigInt(1e5)+BigInt(a??"0");return await pn(t,e,n,o,s,c)})(t,e,c,n)}catch(t){const n=`ipns record for ${e} could not be created`;throw gn.error(t),a(new Error(n),"ERR_CREATING_IPNS_RECORD")}try{const n=(l=i,Xe.encode(l));return await this._datastore.put(fn(t.toBytes()),n,r),gn(`ipns record for ${(0,H.B)(e,"base32")} was stored in the datastore`),n}catch(t){const n=`ipns record for ${e} could not be stored in the datastore`;throw gn.error(n),a(new Error(n),"ERR_STORING_IN_DATASTORE")}var l}}bn.defaultRecordLifetime=mn;const En=(0,i.kg)("ipfs:ipns:republisher");class _n{constructor(t,e,n,r,s={pass:""}){this._publisher=t,this._datastore=e,this._peerId=n,this._keychain=r,this._options=s,this._republishHandle=null}async start(){if(this._republishHandle)throw a(new Error("republisher is already running"),"ERR_REPUBLISH_ALREADY_RUNNING");const t={_task:null,_inflightTask:null,_timeoutId:null,runPeriodically:e=>{t._timeoutId=setTimeout((async()=>{t._timeoutId=null;try{t._inflightTask=t._task(),await t._inflightTask,t._task&&t.runPeriodically(e)}catch(t){En.error(t)}}),e())},cancel:async()=>{null!=t._timeoutId&&clearTimeout(t._timeoutId),t._task=null,await t._inflightTask}},{pass:e}=this._options;let n=!0;t._task=async()=>{const t=new B.TimeoutController(3e4);try{await this._republishEntries(this._peerId,e,{signal:t.signal})}finally{t.clear()}},t.runPeriodically((()=>n?(n=!1,this._options.initialBroadcastInterval||6e4):this._options.broadcastInterval||144e5)),this._republishHandle=t}async stop(){const t=this._republishHandle;if(!t)throw a(new Error("republisher is not running"),"ERR_REPUBLISH_NOT_RUNNING");this._republishHandle=null,await t.cancel()}async _republishEntries(t,e,n){try{await this._republishEntry(t,n)}catch(t){const e="cannot republish entry for the node's private key";return void En.error(e)}if(e)try{const t=await this._keychain.listKeys();for(const r of t){if("self"===r.name)continue;const t=await this._keychain.exportKey(r.name,e),s=await(0,$e.importKey)(t,e),o=await(0,Ne.y5)(s.public.bytes,s.bytes);await this._republishEntry(o,n)}}catch(t){En.error(t)}}async _republishEntry(t,e){try{const n=await this._getPreviousValue(t);await this._publisher.publishWithEOL(t,n,864e5,e)}catch(t){if("ERR_NO_ENTRY_FOUND"===t.code)return;throw t}}async _getPreviousValue(t){if(!(0,ze.I)(t))throw a(new Error("invalid peer ID"),"ERR_INVALID_PEER_ID");try{const e=await this._datastore.get(fn(t.toBytes()));if(!(e instanceof Uint8Array))throw a(new Error("found ipns record that we couldn't process"),"ERR_INVALID_IPNS_RECORD");try{return an(e).value}catch(t){throw En.error(t),a(new Error("found ipns record that we couldn't convert to a value"),"ERR_INVALID_IPNS_RECORD")}}catch(e){if(e&&e.notFound)throw a(new Error(`no previous entry for record with id: ${t.toString()}`),"ERR_NO_ENTRY_FOUND");throw e}}}const vn=(0,i.kg)("ipns:validator"),kn=t=>{if(null==t.data)throw a(new Error("Record data is missing"),"ERR_INVALID_RECORD_DATA");const e=(t=>{const e=en.Jx(t);if(0!==e.ValidityType)throw a(new Error("Unknown validity type"),Ve);return e.ValidityType=Xe.ValidityType.EOL,Number.isInteger(e.Sequence)&&(e.Sequence=BigInt(e.Sequence)),Number.isInteger(e.TTL)&&(e.TTL=BigInt(e.TTL)),e})(t.data);if(!(0,vt.f)(e.Value,t.value))throw a(new Error('Field "value" did not match between protobuf and CBOR'),He);if(!(0,vt.f)(e.Validity,t.validity))throw a(new Error('Field "validity" did not match between protobuf and CBOR'),He);if(e.ValidityType!==t.validityType)throw a(new Error('Field "validityType" did not match between protobuf and CBOR'),He);if(e.Sequence!==t.sequence)throw a(new Error('Field "sequence" did not match between protobuf and CBOR'),He);if(e.TTL!==t.ttl)throw a(new Error('Field "ttl" did not match between protobuf and CBOR'),He)},Rn=async(t,e)=>{const n=(t=>(0,Ne.cv)(t.slice(rn.length)))(t),r=an(e),s=await(async(t,e)=>{if(null==e||null==t){const t=new Error("one or more of the provided parameters are not defined");throw nn.error(t),a(t,Fe)}let n;if(null!=e.pubKey){try{n=(0,$e.unmarshalPublicKey)(e.pubKey)}catch(t){throw nn.error(t),t}if(!(await(0,Ne.y5)(e.pubKey)).equals(t))throw a(new Error("Embedded public key did not match PeerID"),"ERR_INVALID_EMBEDDED_KEY")}else null!=t.publicKey&&(n=(0,$e.unmarshalPublicKey)(t.publicKey));if(null!=n)return n;throw a(new Error("no public key is available"),Fe)})(n,r);await(async(t,e)=>{const{value:n,validityType:r,validity:s}=e;let o,i,c;if(null==e.signatureV2||null==e.data)throw a(new Error("missing data or signatureV2"),He);i=e.signatureV2,o=on(e.data),kn(e);try{c=await t.verify(o,i)}catch(t){c=!1}if(!c)throw vn.error("record signature verification failed"),a(new Error("record signature verification failed"),He);if(null!=s&&r===Xe.ValidityType.EOL){let t;try{t=sn((0,H.B)(s))}catch(t){throw vn.error("unrecognized validity format (not an rfc3339 format)"),a(new Error("unrecognized validity format (not an rfc3339 format)"),"ERR_UNRECOGNIZED_FORMAT")}if(t.getTime()<Date.now())throw vn.error("record has expired"),a(new Error("record has expired"),"ERR_IPNS_EXPIRED_RECORD")}else if(null!=r)throw vn.error("unrecognized validity type"),a(new Error("unrecognized validity type"),Ve);vn("ipns entry for %b is valid",n)})(s,r)},Sn=(0,i.kg)("ipfs:ipns:resolver"),Tn=Ue().code;class An{constructor(t){this._routing=t}async resolve(t,e={}){if("string"!=typeof t)throw a(new Error("invalid name"),"ERR_INVALID_NAME");const n=e.recursive&&"true"===e.recursive.toString(),r=t.split("/");if(3!==r.length||""!==r[0])throw a(new Error("invalid name"),"ERR_INVALID_NAME");const s=r[2];let o=1/0;n&&(o=32);const i=await this.resolver(s,o,e);return Sn(`${t} was locally resolved correctly`),i}async resolver(t,e,n){if(0===e){const t="could not resolve name (recursion limit of 32 exceeded)";throw Sn.error(t),a(new Error(t),"ERR_RESOLVE_RECURSION_LIMIT")}const r=await this._resolveName(t,n),s=r.split("/");return"ipfs"!==s[1]&&e?this.resolver(s[2],e-1,n):r}async _resolveName(t,e){const n=(0,Ne.jE)(t),r=cn(n);let s;try{s=await this._routing.get(r,e)}catch(e){if(Sn.error("could not get record from routing",e),e.code===Tn)throw a(new Error(`record requested for ${t} was not found in the network`),"ERR_NO_RECORD_FOUND");throw a(new Error(`unexpected error getting the ipns record ${n.toString()}`),"ERR_UNEXPECTED_ERROR_GETTING_RECORD")}return this._validateRecord(n,s)}async _validateRecord(t,e){await Rn((0,tt.z)([(0,x.m)("/ipns/"),t.toBytes()]),e);const n=an(e);return(0,H.B)(n.value)}}var In=n(70248);class Dn{constructor(t){this.lru=In(t)}get(t){const e=this.lru.get(t);if(e)return e.expire&&e.expire<Date.now()?void this.lru.remove(t):e.value}set(t,e,n){this.lru.set(t,{value:e,expire:Date.now()+n})}has(t){return!!this.get(t)}remove(t){this.lru.remove(t)}clear(){this.lru.clear()}}const Pn=(0,i.kg)("ipfs:ipns");class Nn{constructor(t,e,n,r,s){this.publisher=new bn(t,e),this.republisher=new _n(this.publisher,e,n,r,s),this.resolver=new An(t),this.cache=new Dn(1e3),this.routing=t}async publish(t,e,n=bn.defaultRecordLifetime,r){try{await this.publisher.publishWithEOL(t,e,n,r),Pn(`IPNS value ${(0,H.B)(e,"base32")} was published correctly`);const s=t.toString(),o=parseFloat(n),i=o<6e4?o:6e4;return this.cache.set(s,e,i),Pn(`IPNS value ${(0,H.B)(e,"base32")} was cached correctly`),{name:s,value:e}}catch(t){throw Pn.error(t),t}}async resolve(t,e={}){if("string"!=typeof t)throw a(new Error("name received is not valid"),"ERR_INVALID_NAME");if(!e.nocache&&!e.recursive){const e=t.split("/")[2],n=this.cache.get(e);if(n)return n}try{const n=await this.resolver.resolve(t,e);return Pn(`IPNS record from ${t} was resolved correctly`),n}catch(t){throw Pn.error(t),t}}async initializeKeyspace(t,e,n){return this.publish(t,e,bn.defaultRecordLifetime,n)}}async function On(t){const e=[];for await(const n of t)e.push(n);return e}const Ln=(t,e)=>async function*(){const n=await On(t);yield*n.sort(e)}();var Cn=n(93361),Mn=n(44752),xn=n(56635);class Bn{open(){return Promise.reject(new Error(".open is not implemented"))}close(){return Promise.reject(new Error(".close is not implemented"))}put(t,e,n){return Promise.reject(new Error(".put is not implemented"))}get(t,e){return Promise.reject(new Error(".get is not implemented"))}has(t,e){return Promise.reject(new Error(".has is not implemented"))}delete(t,e){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(t,e={}){for await(const{key:n,value:r}of t)await this.put(n,r,e),yield{key:n,value:r}}async*getMany(t,e={}){for await(const n of t)yield this.get(n,e)}async*deleteMany(t,e={}){for await(const n of t)await this.delete(n,e),yield n}batch(){let t=[],e=[];return{put(e,n){t.push({key:e,value:n})},delete(t){e.push(t)},commit:async n=>{await(0,Cn.Z)(this.putMany(t,n)),t=[],await(0,Cn.Z)(this.deleteMany(e,n)),e=[]}}}async*_all(t,e){throw new Error("._all is not implemented")}async*_allKeys(t,e){throw new Error("._allKeys is not implemented")}query(t,e){let n=this._all(t,e);if(null!=t.prefix&&(n=(0,Mn.Z)(n,(e=>e.key.toString().startsWith(t.prefix)))),Array.isArray(t.filters)&&(n=t.filters.reduce(((t,e)=>(0,Mn.Z)(t,e)),n)),Array.isArray(t.orders)&&(n=t.orders.reduce(((t,e)=>Ln(t,e)),n)),null!=t.offset){let e=0;n=(0,Mn.Z)(n,(()=>e++>=t.offset))}return null!=t.limit&&(n=(0,xn.Z)(n,t.limit)),n}queryKeys(t,e){let n=this._allKeys(t,e);if(null!=t.prefix&&(n=(0,Mn.Z)(n,(e=>e.toString().startsWith(t.prefix)))),Array.isArray(t.filters)&&(n=t.filters.reduce(((t,e)=>(0,Mn.Z)(t,e)),n)),Array.isArray(t.orders)&&(n=t.orders.reduce(((t,e)=>Ln(t,e)),n)),null!=t.offset){let e=0;n=(0,Mn.Z)(n,(()=>e++>=t.offset))}return null!=t.limit&&(n=(0,xn.Z)(n,t.limit)),n}}var zn=n(37430);const Un=(0,i.kg)("datastore:core:tiered");class jn extends Bn{constructor(t){super(),this.stores=t.slice()}async open(){try{await Promise.all(this.stores.map((t=>t.open())))}catch(t){throw function(t){return t=t||new Error("Cannot open database"),a(t,"ERR_DB_OPEN_FAILED")}(t)}}async put(t,e,n){try{await Promise.all(this.stores.map((r=>r.put(t,e,n))))}catch(t){throw function(t){return t=t||new Error("Write failed"),a(t,"ERR_DB_WRITE_FAILED")}(t)}}async get(t,e){for(const n of this.stores)try{const r=await n.get(t,e);if(r)return r}catch(t){Un.error(t)}throw Ue()}async has(t,e){for(const n of this.stores)if(await n.has(t,e))return!0;return!1}async delete(t,e){try{await Promise.all(this.stores.map((n=>n.delete(t,e))))}catch(t){throw function(t){return t=t||new Error("Delete failed"),a(t,"ERR_DB_DELETE_FAILED")}(t)}}async*putMany(t,e={}){let n;const r=this.stores.map((t=>{const r=(0,zn.d)({objectMode:!0});return(0,Cn.Z)(t.putMany(r,e)).catch((t=>{n=t})),r}));try{for await(const e of t){if(n)throw n;r.forEach((t=>t.push(e))),yield e}}finally{r.forEach((t=>t.end()))}}async*deleteMany(t,e={}){let n;const r=this.stores.map((t=>{const r=(0,zn.d)({objectMode:!0});return(0,Cn.Z)(t.deleteMany(r,e)).catch((t=>{n=t})),r}));try{for await(const e of t){if(n)throw n;r.forEach((t=>t.push(e))),yield e}}finally{r.forEach((t=>t.end()))}}async close(){await Promise.all(this.stores.map((t=>t.close())))}batch(){const t=this.stores.map((t=>t.batch()));return{put:(e,n)=>{t.forEach((t=>t.put(e,n)))},delete:e=>{t.forEach((t=>t.delete(e)))},commit:async e=>{for(const n of t)await n.commit(e)}}}query(t,e){return this.stores[this.stores.length-1].query(t,e)}queryKeys(t,e){return this.stores[this.stores.length-1].queryKeys(t,e)}}var $n=n(26905);const Vn=(t,e)=>{const n=e.map(((t,e)=>({entry:Xe.decode(t),index:e})));return n.sort(((t,e)=>{if(null!=t.entry.signatureV2&&null==e.entry.signatureV2)return-1;if(null==t.entry.signatureV2&&null!=e.entry.signatureV2)return 1;const n=t.entry.sequence??0n,r=e.entry.sequence??0n;if(n>r)return-1;if(n<r)return 1;const s=t.entry.validity??new Uint8Array(0),o=e.entry.validity??new Uint8Array(0),i=sn((0,H.B)(s)),a=sn((0,H.B)(o));return i.getTime()>a.getTime()?-1:i.getTime()<a.getTime()?1:0})),n[0].index};var Hn=n(61711);const Fn=(0,i.kg)("ipfs:ipns:pubsub");class Kn{constructor(t,e,n){this._subscriptions={},this._handleSubscriptionKey=this._handleSubscriptionKey.bind(this),this._pubsubDs=new Hn.R(t,e,n,Rn,Vn,this._handleSubscriptionKey)}async put(t,e,n){try{await this._pubsubDs.put(t,e,n)}catch(t){throw Fn.error(t),t}}async get(t,e){let n,r;try{n=await this._pubsubDs.get(t,e)}catch(t){r=t}const s=t.slice(0,hn);if((0,H.B)(s)===dn){const e=z.base58btc.encode(t).substring(1),n=z.base58btc.encode(t.slice(hn)).substring(1);this._subscriptions[e]=n,Fn(`subscribed to pubsub topic ${e}, id ${n}`)}if(r)throw r;return n}_handleSubscriptionKey(t){t instanceof Uint8Array&&(t=(0,H.B)(t,"base58btc"));const e=this._subscriptions[t];if(!e)throw a(new Error(`key ${t} does not correspond to a subscription`),"ERR_INVALID_KEY");try{return cn((0,Ne.jE)(e))}catch(t){throw Fn.error(t),t}}getSubscriptions(){return Object.values(this._subscriptions).filter(Boolean).map((t=>`${dn}${t}`))}async cancel(t){if("string"!=typeof t)throw a(new Error("invalid subscription name"),"ERR_INVALID_SUBSCRIPTION_NAME");t.startsWith(dn)&&(t=t.substring(hn));const e=Object.keys(this._subscriptions).find((e=>this._subscriptions[e]===t));if(!e)return{canceled:!1};const n=(0,x.m)(e);return this._pubsubDs.unsubscribe(n),delete this._subscriptions[e],Fn(`unsubscribed pubsub ${e}: ${t}`),{canceled:!0}}}var qn=n(21177);const Gn=(0,i.kg)("ipfs:ipns:offline-datastore");class Wn{constructor(t){this._datastore=t,this.stores=[]}async put(t,e,n){if(!(t instanceof Uint8Array))throw a(new Error("Offline datastore key must be a Uint8Array"),"ERR_INVALID_KEY");if(!(e instanceof Uint8Array))throw a(new Error("Offline datastore value must be a Uint8Array"),"ERR_INVALID_VALUE");let r;try{r=this._routingKey(t)}catch(t){throw Gn.error(t),a(new Error("Not possible to generate the routing key"),"ERR_GENERATING_ROUTING_KEY")}const s=new qn.Y(t,e,new Date);await this._datastore.put(r,s.serialize(),n)}async get(t,e){if(!(t instanceof Uint8Array))throw a(new Error("Offline datastore key must be a Uint8Array"),"ERR_INVALID_KEY");let n;try{n=this._routingKey(t)}catch(t){throw Gn.error(t),a(new Error("Not possible to generate the routing key"),"ERR_GENERATING_ROUTING_KEY")}const r=await this._datastore.get(n,e);let s;try{s=qn.Y.deserialize(r)}catch(t){throw Gn.error(t),t}return s.value}_routingKey(t){return new be.s("/dht/record/"+(0,H.B)(t,"base32"),!1)}}const Zn=(0,i.kg)("ipfs:ipns:dht-datastore");class Yn{constructor(t){this._dht=t}async put(t,e,n){try{await(0,Cn.Z)(this._dht.put(t,e,n))}catch(t){throw Zn.error(t),t}}async get(t,e){for await(const n of this._dht.get(t,e))if("VALUE"===n.name)return n.value;throw Ue()}}const Jn=(0,i.kg)("ipfs:components:ipns");class Qn{constructor(t={pass:""}){this.options=t,this.offline=null,this.online=null}getIPNS(){const t=this.online||this.offline;if(t)return t;throw new D}get routing(){return this.getIPNS().routing}startOffline({repo:t,peerId:e,keychain:n}){if(null!=this.offline)throw new N;Jn("initializing IPNS keyspace (offline)");const r=new Wn(t.datastore),s=new Nn(r,t.datastore,e,n,this.options);this.offline=s}async startOnline({libp2p:t,repo:e,peerId:n,keychain:r}){if(null!=this.online)throw new N;const s=function({libp2p:t,repo:e,peerId:n,options:r}){const s=[];let o;if($n(r,"EXPERIMENTAL.ipnsPubsub",!1)&&(o=new Kn(t.pubsub,e.datastore,n),s.push(o)),!0!==$n(r,"offline",!1)&&["dht","dhtclient","dhtserver"].includes($n(r,"config.Routing.Type","none"))&&s.push(new Yn(t.dht)),$n(r,"offline",!1)||0===s.length){const t=new Wn(e.datastore);s.push(t)}return new jn(s)}({libp2p:t,repo:e,peerId:n,options:this.options}),o=new Nn(s,e.datastore,n,r,this.options);await o.republisher.start(),this.online=o}async stop(){const t=this.online;t&&(await t.republisher.stop(),this.online=null)}publish(t,e,n,r){return this.getIPNS().publish(t,e,n,r)}resolve(t,e){return this.getIPNS().resolve(t,e)}initializeKeyspace(t,e,n){return this.getIPNS().initializeKeyspace(t,e,n)}}var Xn=n(90072);async function tr({ipns:t,repo:e,codecs:n},r,s){if(me(r))return t.resolve(r);const{cid:o,path:i}=(0,_e.B)(r);await(0,Cn.Z)(Ie(o,i||"",n,e,s))}const er=(0,i.kg)("ipfs:name:publish");function nr({ipns:t,repo:e,codecs:n,peerId:r,isOnline:s,keychain:o}){const i=async t=>{let e;if("self"===t&&null!=r.privateKey)e=await(0,$e.unmarshalPrivateKey)(r.privateKey);else try{const n=await o.exportKey(t,"temp");e=await(0,$e.importKey)(n,"temp")}catch(t){throw er.error(t),a(t,"ERR_CANNOT_GET_KEY")}return(0,Ne.y5)(e.public.bytes,e.bytes)};return(0,Ee.a)((async function(r,o={}){const c=!(!1===o.resolve),l=o.lifetime||"24h",u=o.key||"self";if(!s())throw a(new Error(ve),"OFFLINE_ERROR");try{r=(t=>{if(Q.k0.asCID(t))return`/ipfs/${t}`;const e=t.toString();try{return`/ipfs/${Q.k0.parse(e)}`}catch{}if(we(e))return e;throw a(new Error(`invalid path: ${t}`),"ERR_BAD_PATH")})(r)}catch(t){throw er.error(t),t}let d=0;try{d=(0,Xn.Z)(l)||0,d=parseFloat(d.toFixed(6))}catch(t){throw er.error(t),t}const h=await Promise.all([i(u),c?tr({ipns:t,repo:e,codecs:n},r):Promise.resolve()]),p=(0,x.m)(r),f=await t.publish(h[0],p,d,o);return{name:f.name,value:(0,H.B)(f.value)}}))}var rr=n(68673),sr=n(82734);const or=s.Z.bind({ignoreUndefined:!0}),ir=(0,i.kg)("ipfs:name:resolve"),ar=(t,e)=>e.length>0?t+"/"+e.join("/"):t;function cr(t,e){if(!t||!e||!e.ipnsPubsub)throw a(new Error("IPNS pubsub subsystem is not enabled"),"ERR_IPNS_PUBSUB_NOT_ENABLED");if(t.routing instanceof Kn)return t.routing;const n=(t.routing.stores||[]).find((t=>t instanceof Kn));if(!n)throw a(new Error("IPNS pubsub datastore not found"),"ERR_PUBSUB_DATASTORE_NOT_FOUND");return n}class lr{constructor({ipns:t,options:e}){this.cancel=function({ipns:t,options:e}){const n=e.EXPERIMENTAL;return(0,Ee.a)((async function(e,r={}){return cr(t,n).cancel(e,r)}))}({ipns:t,options:e}),this.state=function({ipns:t,options:e}){const n=e.EXPERIMENTAL;return(0,Ee.a)((async function(e={}){try{return{enabled:Boolean(cr(t,n))}}catch(t){return{enabled:!1}}}))}({ipns:t,options:e}),this.subs=function({ipns:t,options:e}){const n=e.EXPERIMENTAL;return(0,Ee.a)((async function(e={}){return cr(t,n).getSubscriptions(e)}))}({ipns:t,options:e})}}class ur{constructor({dns:t,ipns:e,repo:n,codecs:r,peerId:s,isOnline:o,keychain:i,options:c}){this.publish=nr({ipns:e,repo:n,codecs:r,peerId:s,isOnline:o,keychain:i}),this.resolve=function({dns:t,ipns:e,isOnline:n,options:{offline:r}}){return(0,Ee.a)((async function*(s,o={}){if(o=or({nocache:!1,recursive:!0},o),r&&o&&o.nocache)throw a(new Error("cannot specify both offline and nocache"),"ERR_NOCACHE_AND_OFFLINE");if(!n()&&!r)throw a(new Error(ve),"OFFLINE_ERROR");let i=s.toString();i.startsWith("/ipns/")||(i=`/ipns/${i}`);let[c,l,...u]=i.slice(1).split("/");try{if("1"===l.substring(0,1)){const t=(0,Ne.jE)(l),e=j.Jx(t.toBytes());l=Q.k0.createV1(114,e).toString(rr.base36)}else{const t=Q.k0.parse(l);1===t.version&&(l=t.toString(rr.base36))}}catch(e){if(sr(l))return void(yield ar(await t(l,o),u));throw ir.error(e),a(new Error("Invalid IPNS name"),"ERR_IPNS_INVALID_NAME")}const d=await e.resolve(`/${c}/${l}`,o);yield ar(d instanceof Uint8Array?(0,H.B)(d):d,u)}))}({dns:t,ipns:e,isOnline:o,options:c}),this.pubsub=new lr({ipns:e,options:c})}}var dr=n(32044);const hr=Ue().code,pr={default:"<dst>",edges:"<src> -> <dst>"};function fr({repo:t,codecs:e,resolve:n,preload:r}){return async function*(s,o={}){if(0===o.maxDepth)return;if(o.edges&&o.format&&o.format!==pr.default)throw new Error("Cannot set edges to true and also specify format");if(o.format=o.edges?pr.edges:o.format,"number"!=typeof o.maxDepth&&(o.maxDepth=o.recursive?1/0:1),o.timeout){const t=[new B.TimeoutController(o.timeout).signal];o.signal&&t.push(o.signal),o.signal=(0,dr.anySignal)(t)}const i=(Array.isArray(s)?s:[s]).map((t=>function(t,e,n){const{cid:r,path:s}=(0,_e.B)(e);!1!==n.preload&&t(r);return`/ipfs/${r}${s||""}`}(r,t,o)));for(const r of i)try{yield*yr(n,t,e,r,o)}catch(t){yield{ref:"",err:t.message}}}}async function*yr(t,e,n,r,s){const o=await t(r,s),{cid:i}=(0,_e.B)(o),a=null!=s.maxDepth?s.maxDepth:1/0,c=s.unique||!1;for await(const t of async function*(t,e,n,r,s,o){const i=new Set;async function*a(n,c){const l=c+1;if(!(l>r))try{for await(const r of async function*(t,e,n,r){const s=await t.blocks.get(n,r),o=await e.getCodec(n.code),i=o.decode(s),a=n.code===v.code,c=[];for(const[t,e]of wr(i,c)){if(a){const n=t.match(/^Links\/(\d+)\/Hash$/);if(n){const t=Number(n[1]);if(t<i.Links.length){yield{name:i.Links[t].Name,cid:e};continue}}}yield{name:t,cid:e}}}(t,e,n.cid,o))yield{parent:n,node:r,isDuplicate:s&&i.has(r.cid.toString())},s&&i.add(r.cid.toString()),yield*a(r,l)}catch(t){throw t.code===hr&&(t.message=`Could not find object with CID: ${n.cid}`),t}}yield*a({cid:n},0)}(e,n,i,a,c,s))t.parent&&(t.isDuplicate||(yield{ref:gr(t.parent.cid,t.node.cid,t.node.name,s.format)}))}function gr(t,e,n="",r=pr.default){let s=r.replace(/<src>/g,t.toString());return s=s.replace(/<dst>/g,e.toString()),s=s.replace(/<linkname>/g,n),s}const wr=function*(t,e){if(null!=t&&!(t instanceof Uint8Array)){for(const[n,r]of Object.entries(t)){const t=[...e,n];if(null!=r&&"object"==typeof r)if(Array.isArray(r))for(const[e,n]of r.entries()){const r=[...t,e],s=Q.k0.asCID(n);s?yield[r.join("/"),s]:"object"==typeof n&&(yield*wr(n,r))}else{const e=Q.k0.asCID(r);e?yield[t.join("/"),e]:yield*wr(r,t)}}return[]}};function mr({repo:t}){return(0,Ee.a)((async function*(e={}){for await(const n of t.blocks.queryKeys({},{signal:e.signal}))yield{ref:n.toString()}}))}function br({network:t}){return(0,Ee.a)((async function(e={}){const n=(await t.use(e)).bitswap,r=n.stat().snapshot;return{provideBufLen:parseInt(r.providesBufferLength.toString()),blocksReceived:BigInt(r.blocksReceived.toString()),wantlist:Array.from(n.getWantlist()).map((t=>t[1].cid)),peers:n.peers(),dupBlksReceived:BigInt(r.dupBlksReceived.toString()),dupDataReceived:BigInt(r.dupDataReceived.toString()),dataReceived:BigInt(r.dataReceived.toString()),blocksSent:BigInt(r.blocksSent.toString()),dataSent:BigInt(r.dataSent.toString())}}))}class Er{constructor({network:t}){this.wantlist=function({network:t}){return(0,Ee.a)((async function(e={}){const{bitswap:n}=await t.use(e),r=n.getWantlist();return Array.from(r).map((t=>t[1].cid))}))}({network:t}),this.wantlistForPeer=function({network:t}){return(0,Ee.a)((async function(e,n={}){const{bitswap:r}=await t.use(n),s=r.wantlistForPeer(e);return Array.from(s).map((t=>t[1].cid))}))}({network:t}),this.unwant=function({network:t}){return(0,Ee.a)((async function(e,n={}){const{bitswap:r}=await t.use(n);return Array.isArray(e)||(e=[e]),r.unwant(e)}))}({network:t}),this.stat=br({network:t})}}const _r=V.C,vr=V.aY,kr=function(t){let e=0;if(t=t.toString().trim(),_r(t)){const n=new Uint8Array(e+4);return t.split(/\./g).forEach((t=>{n[e++]=255&parseInt(t,10)})),n}if(vr(t)){const n=t.split(":",8);let r;for(r=0;r<n.length;r++){let t;_r(n[r])&&(t=kr(n[r]),n[r]=(0,H.B)(t.slice(0,2),"base16")),null!=t&&++r<8&&n.splice(r,0,(0,H.B)(t.slice(2,4),"base16"))}if(""===n[0])for(;n.length<8;)n.unshift("0");else if(""===n[n.length-1])for(;n.length<8;)n.push("0");else if(n.length<8){for(r=0;r<n.length&&""!==n[r];r++);const t=[r,1];for(r=9-n.length;r>0;r--)t.push("0");n.splice.apply(n,t)}const s=new Uint8Array(e+16);for(r=0;r<n.length;r++){const t=parseInt(n[r],16);s[e++]=t>>8&255,s[e++]=255&t}return s}throw new Error("invalid ip address")},Rr=function(t,e=0,n){e=~~e,n=n??t.length-e;const r=new DataView(t.buffer);if(4===n){const r=[];for(let s=0;s<n;s++)r.push(t[e+s]);return r.join(".")}if(16===n){const t=[];for(let s=0;s<n;s+=2)t.push(r.getUint16(e+s).toString(16));return t.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""},Sr=-1,Tr={},Ar={};function Ir(t){if("number"==typeof t){if(null!=Ar[t])return Ar[t];throw new Error(`no protocol with code: ${t}`)}if("string"==typeof t){if(null!=Tr[t])return Tr[t];throw new Error(`no protocol with name: ${t}`)}throw new Error("invalid protocol id type: "+typeof t)}[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,Sr,"ip6zone"],[43,8,"ipcidr"],[53,Sr,"dns",!0],[54,Sr,"dns4",!0],[55,Sr,"dns6",!0],[56,Sr,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,Sr,"unix",!1,!0],[421,Sr,"ipfs"],[421,Sr,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,Sr,"garlic64"],[448,0,"tls"],[449,Sr,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,Sr,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[777,Sr,"memory"]].forEach((t=>{const e=function(t,e,n,r,s){return{code:t,size:e,name:n,resolvable:Boolean(r),path:Boolean(s)}}(...t);Ar[e.code]=e,Tr[e.name]=e}));var Dr=n(26104);Ir("ip4"),Ir("ip6"),Ir("ipcidr");function Pr(t,e){switch(Ir(t).code){case 4:case 41:return function(t){const e=Rr(t,0,t.length);if(null==e)throw new Error("ipBuff is required");if(!V.h6(e))throw new Error("invalid ip address");return e}(e);case 42:case 53:case 54:case 55:case 56:case 400:case 449:case 777:return zr(e);case 6:case 273:case 33:case 132:return xr(e).toString();case 421:return function(t){const e=Dr.decode(t),n=t.slice(Dr.decode.bytes);if(n.length!==e)throw new Error("inconsistent lengths");return(0,H.B)(n,"base58btc")}(e);case 444:case 445:return Ur(e);case 466:return function(t){const e=Dr.decode(t),n=t.slice(Dr.decode.bytes);if(n.length!==e)throw new Error("inconsistent lengths");return"u"+(0,H.B)(n,"base64url")}(e);default:return(0,H.B)(e,"base16")}}function Nr(t,e){switch(Ir(t).code){case 4:case 41:return Cr(e);case 42:case 53:case 54:case 55:case 56:case 400:case 449:case 777:return Br(e);case 6:case 273:case 33:case 132:return Mr(parseInt(e,10));case 421:return function(t){let e;e="Q"===t[0]||"1"===t[0]?j.Jx(z.base58btc.decode(`z${t}`)).bytes:Q.k0.parse(t).multihash.bytes;const n=Uint8Array.from(Dr.encode(e.length));return(0,tt.z)([n,e],n.length+e.length)}(e);case 444:return function(t){const e=t.split(":");if(2!==e.length)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(16!==e[0].length)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);const n=U.base32.decode("b"+e[0]),r=parseInt(e[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const s=Mr(r);return(0,tt.z)([n,s],n.length+s.length)}(e);case 445:return function(t){const e=t.split(":");if(2!==e.length)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(56!==e[0].length)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);const n=U.base32.decode(`b${e[0]}`),r=parseInt(e[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const s=Mr(r);return(0,tt.z)([n,s],n.length+s.length)}(e);case 466:return function(t){const e=Lr.decode(t),n=Uint8Array.from(Dr.encode(e.length));return(0,tt.z)([n,e],n.length+e.length)}(e);default:return(0,x.m)(e,"base16")}}const Or=Object.values(A.gh).map((t=>t.decoder)),Lr=function(){let t=Or[0].or(Or[1]);return Or.slice(2).forEach((e=>t=t.or(e))),t}();function Cr(t){if(!V.h6(t))throw new Error("invalid ip address");return kr(t)}function Mr(t){const e=new ArrayBuffer(2);return new DataView(e).setUint16(0,t),new Uint8Array(e)}function xr(t){return new DataView(t.buffer).getUint16(t.byteOffset)}function Br(t){const e=(0,x.m)(t),n=Uint8Array.from(Dr.encode(e.length));return(0,tt.z)([n,e],n.length+e.length)}function zr(t){const e=Dr.decode(t);if((t=t.slice(Dr.decode.bytes)).length!==e)throw new Error("inconsistent lengths");return(0,H.B)(t)}function Ur(t){const e=t.slice(0,t.length-2),n=t.slice(t.length-2);return`${(0,H.B)(e,"base32")}:${xr(n)}`}function jr(t){return t.map((t=>{const e=Yr(t);return null!=t[1]?[e.code,Pr(e.code,t[1])]:[e.code]}))}function $r(t){return qr((0,tt.z)(t.map((t=>{const e=Yr(t);let n=Uint8Array.from(Dr.encode(e.code));return t.length>1&&null!=t[1]&&(n=(0,tt.z)([n,t[1]])),n}))))}function Vr(t,e){if(t.size>0)return t.size/8;if(0===t.size)return 0;return Dr.decode(e)+(Dr.decode.bytes??0)}function Hr(t){const e=[];let n=0;for(;n<t.length;){const r=Dr.decode(t,n),s=Dr.decode.bytes??0,o=Vr(Ir(r),t.slice(n+s));if(0===o){e.push([r]),n+=s;continue}const i=t.slice(n+s,n+s+o);if(n+=o+s,n>t.length)throw Zr("Invalid address Uint8Array: "+(0,H.B)(t,"base16"));e.push([r,i])}return e}function Fr(t){return function(t){const e=[];return t.map((t=>{const n=Yr(t);return e.push(n.name),t.length>1&&null!=t[1]&&e.push(t[1]),null})),Wr(e.join("/"))}(jr(Hr(t)))}function Kr(t){const e=function(t){const e=[],n=t.split("/").slice(1);if(1===n.length&&""===n[0])return[];for(let r=0;r<n.length;r++){const s=n[r],o=Ir(s);if(0!==o.size){if(r++,r>=n.length)throw Zr("invalid address: "+t);if(!0===o.path){e.push([s,Wr(n.slice(r).join("/"))]);break}e.push([s,n[r]])}else e.push([s])}return e}(t=Wr(t));return $r(e.map((t=>{Array.isArray(t)||(t=[t]);const e=Yr(t);return t.length>1?[e.code,Nr(e.code,t[1])]:[e.code]})))}function qr(t){const e=Gr(t);if(null!=e)throw e;return Uint8Array.from(t)}function Gr(t){try{Hr(t)}catch(t){return t}}function Wr(t){return"/"+t.trim().split("/").filter((t=>t)).join("/")}function Zr(t){return new Error("Error parsing address: "+t)}function Yr(t){return Ir(t[0])}var Jr,Qr,Xr,ts,es=function(t,e,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!r:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(t):r?r.value:e.get(t)},ns=function(t,e,n,r,s){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!s:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?s.call(t,n):s?s.value=n:e.set(t,n),n};const rs=Symbol.for("nodejs.util.inspect.custom"),ss=[Ir("dns").code,Ir("dns4").code,Ir("dns6").code,Ir("dnsaddr").code],os=new Map,is=Symbol.for("@multiformats/js-multiaddr/multiaddr");function as(t){return Boolean(t?.[is])}class cs{constructor(t){if(Jr.set(this,void 0),Qr.set(this,void 0),Xr.set(this,void 0),this[ts]=!0,null==t&&(t=""),t instanceof Uint8Array)this.bytes=qr(t);else if("string"==typeof t){if(t.length>0&&"/"!==t.charAt(0))throw new Error(`multiaddr "${t}" must start with a "/"`);this.bytes=Kr(t)}else{if(!as(t))throw new Error("addr must be a string, Buffer, or another Multiaddr");this.bytes=qr(t.bytes)}}toString(){return null==es(this,Jr,"f")&&ns(this,Jr,Fr(this.bytes),"f"),es(this,Jr,"f")}toJSON(){return this.toString()}toOptions(){let t,e,n,r,s="";const o=Ir("tcp"),i=Ir("udp"),a=Ir("ip4"),c=Ir("ip6"),l=Ir("dns6"),u=Ir("ip6zone");for(const[d,h]of this.stringTuples())d===u.code&&(s=`%${h??""}`),ss.includes(d)&&(e=o.name,r=443,n=`${h??""}${s}`,t=d===l.code?6:4),d!==o.code&&d!==i.code||(e=Ir(d).name,r=parseInt(h??"")),d!==a.code&&d!==c.code||(e=Ir(d).name,n=`${h??""}${s}`,t=d===c.code?6:4);if(null==t||null==e||null==n||null==r)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:t,host:n,transport:e,port:r}}protos(){return this.protoCodes().map((t=>Object.assign({},Ir(t))))}protoCodes(){const t=[],e=this.bytes;let n=0;for(;n<e.length;){const r=Dr.decode(e,n),s=Dr.decode.bytes??0;n+=Vr(Ir(r),e.slice(n+s))+s,t.push(r)}return t}protoNames(){return this.protos().map((t=>t.name))}tuples(){return null==es(this,Qr,"f")&&ns(this,Qr,Hr(this.bytes),"f"),es(this,Qr,"f")}stringTuples(){return null==es(this,Xr,"f")&&ns(this,Xr,jr(this.tuples()),"f"),es(this,Xr,"f")}encapsulate(t){return t=new cs(t),new cs(this.toString()+t.toString())}decapsulate(t){const e=t.toString(),n=this.toString(),r=n.lastIndexOf(e);if(r<0)throw new Error(`Address ${this.toString()} does not contain subaddress: ${t.toString()}`);return new cs(n.slice(0,r))}decapsulateCode(t){const e=this.tuples();for(let n=e.length-1;n>=0;n--)if(e[n][0]===t)return new cs($r(e.slice(0,n)));return this}getPeerId(){try{const t=this.stringTuples().filter((t=>t[0]===Tr.ipfs.code)),e=t.pop();if(null!=e?.[1]){const t=e[1];return"Q"===t[0]||"1"===t[0]?(0,H.B)(z.base58btc.decode(`z${t}`),"base58btc"):(0,H.B)(Q.k0.parse(t).multihash.bytes,"base58btc")}return null}catch(t){return null}}getPath(){let t=null;try{t=this.stringTuples().filter((t=>!0===Ir(t[0]).path))[0][1],null==t&&(t=null)}catch{t=null}return t}equals(t){return(0,vt.f)(this.bytes,t.bytes)}async resolve(t){const e=this.protos().find((t=>t.resolvable));if(null==e)return[this];const n=os.get(e.name);if(null==n)throw a(new Error(`no available resolver for ${e.name}`),"ERR_NO_AVAILABLE_RESOLVER");return(await n(this,t)).map((t=>new cs(t)))}nodeAddress(){const t=this.toOptions();if("tcp"!==t.transport&&"udp"!==t.transport)throw new Error(`multiaddr must have a valid format - no protocol with name: "${t.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:t.family,address:t.host,port:t.port}}isThinWaistAddress(t){const e=(t??this).protos();return 2===e.length&&((4===e[0].code||41===e[0].code)&&(6===e[1].code||273===e[1].code))}[(Jr=new WeakMap,Qr=new WeakMap,Xr=new WeakMap,ts=is,rs)](){return`Multiaddr(${Fr(this.bytes)})`}}function ls(t){return new cs(t)}const us=xs("dns4"),ds=xs("dns6"),hs=xs("dnsaddr"),ps=Ms(xs("dns"),hs,us,ds),fs=Ms(xs("ip4"),xs("ip6")),ys=Ms(Cs(fs,xs("tcp")),Cs(ps,xs("tcp"))),gs=Cs(fs,xs("udp")),ws=Cs(gs,xs("utp")),ms=Cs(gs,xs("quic")),bs=Ms(Cs(ys,xs("ws")),Cs(ps,xs("ws"))),Es=Ms(Cs(ys,xs("wss")),Cs(ps,xs("wss")),Cs(ys,xs("tls"),xs("ws")),Cs(ps,xs("tls"),xs("ws"))),_s=Ms(Cs(ys,xs("http")),Cs(fs,xs("http")),Cs(ps,xs("http"))),vs=Ms(Cs(ys,xs("https")),Cs(fs,xs("https")),Cs(ps,xs("https"))),ks=Cs(gs,xs("webrtc"),xs("certhash")),Rs=Ms(Cs(ks,xs("p2p")),ks),Ss=Ms(Cs(bs,xs("p2p-webrtc-star"),xs("p2p")),Cs(Es,xs("p2p-webrtc-star"),xs("p2p")),Cs(bs,xs("p2p-webrtc-star")),Cs(Es,xs("p2p-webrtc-star"))),Ts=(Ms(Cs(bs,xs("p2p-websocket-star"),xs("p2p")),Cs(Es,xs("p2p-websocket-star"),xs("p2p")),Cs(bs,xs("p2p-websocket-star")),Cs(Es,xs("p2p-websocket-star"))),Ms(Cs(_s,xs("p2p-webrtc-direct"),xs("p2p")),Cs(vs,xs("p2p-webrtc-direct"),xs("p2p")),Cs(_s,xs("p2p-webrtc-direct")),Cs(vs,xs("p2p-webrtc-direct")))),As=Ms(bs,Es,_s,vs,Ss,Ts,ys,ws,ms,ps,Rs),Is=(Ms(Cs(As,xs("p2p-stardust"),xs("p2p")),Cs(As,xs("p2p-stardust"))),Ms(Cs(As,xs("p2p")),Ss,Ts,Rs,xs("p2p"))),Ds=Ms(Cs(Is,xs("p2p-circuit"),Is),Cs(Is,xs("p2p-circuit")),Cs(xs("p2p-circuit"),Is),Cs(As,xs("p2p-circuit")),Cs(xs("p2p-circuit"),As),xs("p2p-circuit")),Ps=()=>Ms(Cs(Ds,Ps),Ds),Ns=Ps(),Os=Ms(Cs(Ns,Is,Ns),Cs(Is,Ns),Cs(Ns,Is),Ns,Is);function Ls(t){return function(e){let n;try{n=ls(e)}catch(t){return!1}const r=t(n.protoNames());return null!==r&&(!0===r||!1===r?r:0===r.length)}}function Cs(...t){function e(e){if(e.length<t.length)return null;let n=e;return t.some((t=>(n="function"==typeof t?t().partialMatch(e):t.partialMatch(e),Array.isArray(n)&&(e=n),null===n))),n}return{toString:function(){return"{ "+t.join(" ")+" }"},input:t,matches:Ls(e),partialMatch:e}}function Ms(...t){function e(e){let n=null;return t.some((t=>{const r="function"==typeof t?t().partialMatch(e):t.partialMatch(e);return null!=r&&(n=r,!0)})),n}return{toString:function(){return"{ "+t.join(" ")+" }"},input:t,matches:Ls(e),partialMatch:e}}function xs(t){const e=t;return{toString:function(){return e},matches:function(t){let n;try{n=ls(t)}catch(t){return!1}const r=n.protoNames();return 1===r.length&&r[0]===e},partialMatch:function(t){return 0===t.length?null:t[0]===e?t.slice(1):null}}}function Bs(t){try{return Os.matches(t)}catch(t){return!1}}var zs=n(71115);class Us{constructor({repo:t}){this.add=function({repo:t}){return(0,Ee.a)((async function(e,n={}){if(!Bs(e))throw new Error(`${e} is not a valid Multiaddr`);const r=await t.config.getAll(n),s=r.Bootstrap||[];return s.push(e.toString()),r.Bootstrap=Array.from(new Set(s)).sort(((t,e)=>t.localeCompare(e))),await t.config.replace(r),{Peers:[e]}}))}({repo:t}),this.list=function({repo:t}){return(0,Ee.a)((async function(e={}){return{Peers:(await t.config.get("Bootstrap",e)||[]).map((t=>(0,$.HM)(t)))}}))}({repo:t}),this.rm=function({repo:t}){return(0,Ee.a)((async function(e,n={}){if(!Bs(e))throw new Error(`${e} is not a valid Multiaddr`);const r=await t.config.getAll(n);return r.Bootstrap=(r.Bootstrap||[]).filter((t=>t.toString()!==e.toString())),await t.config.replace(r),{Peers:[e]}}))}({repo:t}),this.clear=function({repo:t}){return(0,Ee.a)((async function(e={}){const n=await t.config.getAll(e),r=n.Bootstrap||[];return n.Bootstrap=[],await t.config.replace(n),{Peers:r.map((t=>(0,$.HM)(t)))}}))}({repo:t}),this.reset=function({repo:t}){return(0,Ee.a)((async function(e={}){const n=await t.config.getAll(e);return n.Bootstrap=(0,zs.Z)().Bootstrap,await t.config.replace(n),{Peers:(0,zs.Z)().Bootstrap.map((t=>(0,$.HM)(t)))}}))}({repo:t})}}var js=n(69849),$s=n(21007),Vs=n(52019);const Hs=(...t)=>{let e;for(;t.length>0;)e=t.shift()(e);return e},Fs=t=>null!=t&&("function"==typeof t[Symbol.asyncIterator]||"function"==typeof t[Symbol.iterator]||"function"==typeof t.next),Ks=t=>null!=t&&"function"==typeof t.sink&&Fs(t.source),qs=t=>e=>{const n=t.sink(e);if(null!=n.then){const e=(0,zn.d)({objectMode:!0});n.then((()=>{e.end()}),(t=>{e.end(t)}));const r=async function*(){yield*t.source,e.end()};return(0,Vs.Z)(e,r())}return t.source};function Gs(t,...e){if(Ks(t)){const e=t;t=()=>e.source}else if(Fs(t)){const e=t;t=()=>e}const n=[t,...e];if(n.length>1&&Ks(n[n.length-1])&&(n[n.length-1]=n[n.length-1].sink),n.length>2)for(let t=1;t<n.length-1;t++)Ks(n[t])&&(n[t]=qs(n[t]));return Hs(...n)}function Ws(t){return t instanceof Uint8Array?Q.k0.decode(t):Q.k0.parse(t.toString())}class Zs{constructor({codecs:t,hashers:e,preload:n,repo:r}){this.get=function({preload:t,repo:e}){return(0,Ee.a)((async function(n,r={}){return!1!==r.preload&&t(n),e.blocks.get(n,r)}))}({preload:n,repo:r}),this.put=function({codecs:t,hashers:e,repo:n,preload:r}){return(0,Ee.a)((async function(s,o={}){const i=o.pin?await n.gcLock.readLock():null;try{const i=null!=o.version?o.version:0,a=o.format||(0===i?"dag-pb":"raw"),c=await e.getHasher(o.mhtype||"sha2-256"),l=await c.digest(s),u=await t.getCodec(a),d=Q.k0.create(i,u.code,l);return await n.blocks.put(d,s,{signal:o.signal}),!1!==o.preload&&r(d),!0===o.pin&&await n.pins.pinRecursively(d,{signal:o.signal}),d}finally{i&&i()}}))}({codecs:t,hashers:e,preload:n,repo:r}),this.rm=function({repo:t}){return(0,Ee.a)((async function*(e,n={}){Array.isArray(e)||(e=[e]);const r=await t.gcLock.writeLock();try{yield*Gs(e,(e=>(0,$s.Z)(e,(e=>async()=>{const r={cid:e=Ws(e)};try{if(!await t.blocks.has(e))throw a(new Error("block not found"),"ERR_BLOCK_NOT_FOUND");await t.blocks.delete(e)}catch(t){n.force||(t.message=`cannot remove ${e}: ${t.message}`,r.error=t)}return r}))),(t=>(0,js.Z)(t,{concurrency:8})),(t=>(0,Mn.Z)(t,(()=>!n.quiet))))}finally{r()}}))}({repo:r}),this.stat=function({repo:t,preload:e}){return(0,Ee.a)((async function(n,r={}){return n=Ws(n),!1!==r.preload&&e(n),{cid:n,size:(await t.blocks.get(n)).length}}))}({preload:n,repo:r})}}var Ys=n(56740);var Js=n(67389),Qs=n(27353),Xs=n(12619);const to={chunker:"fixed",strategy:"balanced",rawLeaves:!1,onlyHash:!1,reduceSingleLeafToSelf:!0,hasher:Qs.sha256,leafType:"file",cidVersion:0,progress:()=>()=>{},shardSplitThreshold:1e3,fileImportConcurrency:50,blockWriteConcurrency:10,minChunkSize:262144,maxChunkSize:262144,avgChunkSize:262144,window:16,polynomial:0x3df305dfb2a804,maxChildrenPerNode:174,layerRepeat:4,wrapWithDirectory:!1,recursive:!1,hidden:!1,timeout:void 0,hamtHashFn:async function(t){return(await Xs.Pv.encode(t)).slice(0,8).reverse()},hamtHashCode:34,hamtBucketBits:8};var eo=(t={})=>s.Z.bind({ignoreUndefined:!0})(to,t),no=n(55353);const ro=no.Reader,so=no.Writer,oo=no.util,io=no.roots["ipfs-unixfs"]||(no.roots["ipfs-unixfs"]={}),ao=io.Data=(()=>{function t(t){if(this.blocksizes=[],t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.Type=0,t.prototype.Data=oo.newBuffer([]),t.prototype.filesize=oo.Long?oo.Long.fromBits(0,0,!0):0,t.prototype.blocksizes=oo.emptyArray,t.prototype.hashType=oo.Long?oo.Long.fromBits(0,0,!0):0,t.prototype.fanout=oo.Long?oo.Long.fromBits(0,0,!0):0,t.prototype.mode=0,t.prototype.mtime=null,t.encode=function(t,e){if(e||(e=so.create()),e.uint32(8).int32(t.Type),null!=t.Data&&Object.hasOwnProperty.call(t,"Data")&&e.uint32(18).bytes(t.Data),null!=t.filesize&&Object.hasOwnProperty.call(t,"filesize")&&e.uint32(24).uint64(t.filesize),null!=t.blocksizes&&t.blocksizes.length)for(var n=0;n<t.blocksizes.length;++n)e.uint32(32).uint64(t.blocksizes[n]);return null!=t.hashType&&Object.hasOwnProperty.call(t,"hashType")&&e.uint32(40).uint64(t.hashType),null!=t.fanout&&Object.hasOwnProperty.call(t,"fanout")&&e.uint32(48).uint64(t.fanout),null!=t.mode&&Object.hasOwnProperty.call(t,"mode")&&e.uint32(56).uint32(t.mode),null!=t.mtime&&Object.hasOwnProperty.call(t,"mtime")&&io.UnixTime.encode(t.mtime,e.uint32(66).fork()).ldelim(),e},t.decode=function(t,e){t instanceof ro||(t=ro.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new io.Data;t.pos<n;){var s=t.uint32();switch(s>>>3){case 1:r.Type=t.int32();break;case 2:r.Data=t.bytes();break;case 3:r.filesize=t.uint64();break;case 4:if(r.blocksizes&&r.blocksizes.length||(r.blocksizes=[]),2==(7&s))for(var o=t.uint32()+t.pos;t.pos<o;)r.blocksizes.push(t.uint64());else r.blocksizes.push(t.uint64());break;case 5:r.hashType=t.uint64();break;case 6:r.fanout=t.uint64();break;case 7:r.mode=t.uint32();break;case 8:r.mtime=io.UnixTime.decode(t,t.uint32());break;default:t.skipType(7&s)}}if(!r.hasOwnProperty("Type"))throw oo.ProtocolError("missing required 'Type'",{instance:r});return r},t.fromObject=function(t){if(t instanceof io.Data)return t;var e=new io.Data;switch(t.Type){case"Raw":case 0:e.Type=0;break;case"Directory":case 1:e.Type=1;break;case"File":case 2:e.Type=2;break;case"Metadata":case 3:e.Type=3;break;case"Symlink":case 4:e.Type=4;break;case"HAMTShard":case 5:e.Type=5}if(null!=t.Data&&("string"==typeof t.Data?oo.base64.decode(t.Data,e.Data=oo.newBuffer(oo.base64.length(t.Data)),0):t.Data.length&&(e.Data=t.Data)),null!=t.filesize&&(oo.Long?(e.filesize=oo.Long.fromValue(t.filesize)).unsigned=!0:"string"==typeof t.filesize?e.filesize=parseInt(t.filesize,10):"number"==typeof t.filesize?e.filesize=t.filesize:"object"==typeof t.filesize&&(e.filesize=new oo.LongBits(t.filesize.low>>>0,t.filesize.high>>>0).toNumber(!0))),t.blocksizes){if(!Array.isArray(t.blocksizes))throw TypeError(".Data.blocksizes: array expected");e.blocksizes=[];for(var n=0;n<t.blocksizes.length;++n)oo.Long?(e.blocksizes[n]=oo.Long.fromValue(t.blocksizes[n])).unsigned=!0:"string"==typeof t.blocksizes[n]?e.blocksizes[n]=parseInt(t.blocksizes[n],10):"number"==typeof t.blocksizes[n]?e.blocksizes[n]=t.blocksizes[n]:"object"==typeof t.blocksizes[n]&&(e.blocksizes[n]=new oo.LongBits(t.blocksizes[n].low>>>0,t.blocksizes[n].high>>>0).toNumber(!0))}if(null!=t.hashType&&(oo.Long?(e.hashType=oo.Long.fromValue(t.hashType)).unsigned=!0:"string"==typeof t.hashType?e.hashType=parseInt(t.hashType,10):"number"==typeof t.hashType?e.hashType=t.hashType:"object"==typeof t.hashType&&(e.hashType=new oo.LongBits(t.hashType.low>>>0,t.hashType.high>>>0).toNumber(!0))),null!=t.fanout&&(oo.Long?(e.fanout=oo.Long.fromValue(t.fanout)).unsigned=!0:"string"==typeof t.fanout?e.fanout=parseInt(t.fanout,10):"number"==typeof t.fanout?e.fanout=t.fanout:"object"==typeof t.fanout&&(e.fanout=new oo.LongBits(t.fanout.low>>>0,t.fanout.high>>>0).toNumber(!0))),null!=t.mode&&(e.mode=t.mode>>>0),null!=t.mtime){if("object"!=typeof t.mtime)throw TypeError(".Data.mtime: object expected");e.mtime=io.UnixTime.fromObject(t.mtime)}return e},t.toObject=function(t,e){e||(e={});var n={};if((e.arrays||e.defaults)&&(n.blocksizes=[]),e.defaults){if(n.Type=e.enums===String?"Raw":0,e.bytes===String?n.Data="":(n.Data=[],e.bytes!==Array&&(n.Data=oo.newBuffer(n.Data))),oo.Long){var r=new oo.Long(0,0,!0);n.filesize=e.longs===String?r.toString():e.longs===Number?r.toNumber():r}else n.filesize=e.longs===String?"0":0;if(oo.Long){r=new oo.Long(0,0,!0);n.hashType=e.longs===String?r.toString():e.longs===Number?r.toNumber():r}else n.hashType=e.longs===String?"0":0;if(oo.Long){r=new oo.Long(0,0,!0);n.fanout=e.longs===String?r.toString():e.longs===Number?r.toNumber():r}else n.fanout=e.longs===String?"0":0;n.mode=0,n.mtime=null}if(null!=t.Type&&t.hasOwnProperty("Type")&&(n.Type=e.enums===String?io.Data.DataType[t.Type]:t.Type),null!=t.Data&&t.hasOwnProperty("Data")&&(n.Data=e.bytes===String?oo.base64.encode(t.Data,0,t.Data.length):e.bytes===Array?Array.prototype.slice.call(t.Data):t.Data),null!=t.filesize&&t.hasOwnProperty("filesize")&&("number"==typeof t.filesize?n.filesize=e.longs===String?String(t.filesize):t.filesize:n.filesize=e.longs===String?oo.Long.prototype.toString.call(t.filesize):e.longs===Number?new oo.LongBits(t.filesize.low>>>0,t.filesize.high>>>0).toNumber(!0):t.filesize),t.blocksizes&&t.blocksizes.length){n.blocksizes=[];for(var s=0;s<t.blocksizes.length;++s)"number"==typeof t.blocksizes[s]?n.blocksizes[s]=e.longs===String?String(t.blocksizes[s]):t.blocksizes[s]:n.blocksizes[s]=e.longs===String?oo.Long.prototype.toString.call(t.blocksizes[s]):e.longs===Number?new oo.LongBits(t.blocksizes[s].low>>>0,t.blocksizes[s].high>>>0).toNumber(!0):t.blocksizes[s]}return null!=t.hashType&&t.hasOwnProperty("hashType")&&("number"==typeof t.hashType?n.hashType=e.longs===String?String(t.hashType):t.hashType:n.hashType=e.longs===String?oo.Long.prototype.toString.call(t.hashType):e.longs===Number?new oo.LongBits(t.hashType.low>>>0,t.hashType.high>>>0).toNumber(!0):t.hashType),null!=t.fanout&&t.hasOwnProperty("fanout")&&("number"==typeof t.fanout?n.fanout=e.longs===String?String(t.fanout):t.fanout:n.fanout=e.longs===String?oo.Long.prototype.toString.call(t.fanout):e.longs===Number?new oo.LongBits(t.fanout.low>>>0,t.fanout.high>>>0).toNumber(!0):t.fanout),null!=t.mode&&t.hasOwnProperty("mode")&&(n.mode=t.mode),null!=t.mtime&&t.hasOwnProperty("mtime")&&(n.mtime=io.UnixTime.toObject(t.mtime,e)),n},t.prototype.toJSON=function(){return this.constructor.toObject(this,no.util.toJSONOptions)},t.DataType=function(){const t={},e=Object.create(t);return e[t[0]="Raw"]=0,e[t[1]="Directory"]=1,e[t[2]="File"]=2,e[t[3]="Metadata"]=3,e[t[4]="Symlink"]=4,e[t[5]="HAMTShard"]=5,e}(),t})(),co=(io.UnixTime=(()=>{function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.Seconds=oo.Long?oo.Long.fromBits(0,0,!1):0,t.prototype.FractionalNanoseconds=0,t.encode=function(t,e){return e||(e=so.create()),e.uint32(8).int64(t.Seconds),null!=t.FractionalNanoseconds&&Object.hasOwnProperty.call(t,"FractionalNanoseconds")&&e.uint32(21).fixed32(t.FractionalNanoseconds),e},t.decode=function(t,e){t instanceof ro||(t=ro.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new io.UnixTime;t.pos<n;){var s=t.uint32();switch(s>>>3){case 1:r.Seconds=t.int64();break;case 2:r.FractionalNanoseconds=t.fixed32();break;default:t.skipType(7&s)}}if(!r.hasOwnProperty("Seconds"))throw oo.ProtocolError("missing required 'Seconds'",{instance:r});return r},t.fromObject=function(t){if(t instanceof io.UnixTime)return t;var e=new io.UnixTime;return null!=t.Seconds&&(oo.Long?(e.Seconds=oo.Long.fromValue(t.Seconds)).unsigned=!1:"string"==typeof t.Seconds?e.Seconds=parseInt(t.Seconds,10):"number"==typeof t.Seconds?e.Seconds=t.Seconds:"object"==typeof t.Seconds&&(e.Seconds=new oo.LongBits(t.Seconds.low>>>0,t.Seconds.high>>>0).toNumber())),null!=t.FractionalNanoseconds&&(e.FractionalNanoseconds=t.FractionalNanoseconds>>>0),e},t.toObject=function(t,e){e||(e={});var n={};if(e.defaults){if(oo.Long){var r=new oo.Long(0,0,!1);n.Seconds=e.longs===String?r.toString():e.longs===Number?r.toNumber():r}else n.Seconds=e.longs===String?"0":0;n.FractionalNanoseconds=0}return null!=t.Seconds&&t.hasOwnProperty("Seconds")&&("number"==typeof t.Seconds?n.Seconds=e.longs===String?String(t.Seconds):t.Seconds:n.Seconds=e.longs===String?oo.Long.prototype.toString.call(t.Seconds):e.longs===Number?new oo.LongBits(t.Seconds.low>>>0,t.Seconds.high>>>0).toNumber():t.Seconds),null!=t.FractionalNanoseconds&&t.hasOwnProperty("FractionalNanoseconds")&&(n.FractionalNanoseconds=t.FractionalNanoseconds),n},t.prototype.toJSON=function(){return this.constructor.toObject(this,no.util.toJSONOptions)},t})(),io.Metadata=(()=>{function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.MimeType="",t.encode=function(t,e){return e||(e=so.create()),null!=t.MimeType&&Object.hasOwnProperty.call(t,"MimeType")&&e.uint32(10).string(t.MimeType),e},t.decode=function(t,e){t instanceof ro||(t=ro.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new io.Metadata;t.pos<n;){var s=t.uint32();if(s>>>3==1)r.MimeType=t.string();else t.skipType(7&s)}return r},t.fromObject=function(t){if(t instanceof io.Metadata)return t;var e=new io.Metadata;return null!=t.MimeType&&(e.MimeType=String(t.MimeType)),e},t.toObject=function(t,e){e||(e={});var n={};return e.defaults&&(n.MimeType=""),null!=t.MimeType&&t.hasOwnProperty("MimeType")&&(n.MimeType=t.MimeType),n},t.prototype.toJSON=function(){return this.constructor.toObject(this,no.util.toJSONOptions)},t})(),ao),lo=["raw","directory","file","metadata","symlink","hamt-sharded-directory"],uo=["directory","hamt-sharded-directory"],ho=parseInt("0644",8),po=parseInt("0755",8);function fo(t){if(null!=t)return"number"==typeof t?4095&t:"0"===(t=t.toString()).substring(0,1)?4095&parseInt(t,8):4095&parseInt(t,10)}function yo(t){if(null==t)return;let e;if(null!=t.secs&&(e={secs:t.secs,nsecs:t.nsecs}),null!=t.Seconds&&(e={secs:t.Seconds,nsecs:t.FractionalNanoseconds}),Array.isArray(t)&&(e={secs:t[0],nsecs:t[1]}),t instanceof Date){const n=t.getTime(),r=Math.floor(n/1e3);e={secs:r,nsecs:1e3*(n-1e3*r)}}if(Object.prototype.hasOwnProperty.call(e,"secs")){if(null!=e&&null!=e.nsecs&&(e.nsecs<0||e.nsecs>999999999))throw a(new Error("mtime-nsecs must be within the range [0,999999999]"),"ERR_INVALID_MTIME_NSECS");return e}}class go{static unmarshal(t){const e=co.decode(t),n=co.toObject(e,{defaults:!1,arrays:!0,longs:Number,objects:!1}),r=new go({type:lo[n.Type],data:n.Data,blockSizes:n.blocksizes,mode:n.mode,mtime:n.mtime?{secs:n.mtime.Seconds,nsecs:n.mtime.FractionalNanoseconds}:void 0});return r._originalMode=n.mode||0,r}constructor(t={type:"file"}){const{type:e,data:n,blockSizes:r,hashType:s,fanout:o,mtime:i,mode:c}=t;if(e&&!lo.includes(e))throw a(new Error("Type: "+e+" is not valid"),"ERR_INVALID_TYPE");this.type=e||"file",this.data=n,this.hashType=s,this.fanout=o,this.blockSizes=r||[],this._originalMode=0,this.mode=fo(c),i&&(this.mtime=yo(i),this.mtime&&!this.mtime.nsecs&&(this.mtime.nsecs=0))}set mode(t){this._mode=this.isDirectory()?po:ho;const e=fo(t);void 0!==e&&(this._mode=e)}get mode(){return this._mode}isDirectory(){return Boolean(this.type&&uo.includes(this.type))}addBlockSize(t){this.blockSizes.push(t)}removeBlockSize(t){this.blockSizes.splice(t,1)}fileSize(){if(this.isDirectory())return 0;let t=0;return this.blockSizes.forEach((e=>{t+=e})),this.data&&(t+=this.data.length),t}marshal(){let t;switch(this.type){case"raw":t=co.DataType.Raw;break;case"directory":t=co.DataType.Directory;break;case"file":t=co.DataType.File;break;case"metadata":t=co.DataType.Metadata;break;case"symlink":t=co.DataType.Symlink;break;case"hamt-sharded-directory":t=co.DataType.HAMTShard;break;default:throw a(new Error("Type: "+t+" is not valid"),"ERR_INVALID_TYPE")}let e,n,r=this.data;if(this.data&&this.data.length||(r=void 0),null!=this.mode&&(e=4294963200&this._originalMode|(fo(this.mode)||0),e!==ho||this.isDirectory()||(e=void 0),e===po&&this.isDirectory()&&(e=void 0)),null!=this.mtime){const t=yo(this.mtime);t&&(n={Seconds:t.secs,FractionalNanoseconds:t.nsecs},0===n.FractionalNanoseconds&&delete n.FractionalNanoseconds)}const s={Type:t,Data:r,filesize:this.isDirectory()?void 0:this.fileSize(),blocksizes:this.blockSizes,hashType:this.hashType,fanout:this.fanout,mode:e,mtime:n};return co.encode(s).finish()}}var wo=async(t,e,n)=>{n.codec||(n.codec=v),n.hasher||(n.hasher=Qs.sha256),void 0===n.cidVersion&&(n.cidVersion=1),n.codec===v&&n.hasher!==Qs.sha256&&(n.cidVersion=1);const r=await n.hasher.digest(t),s=Q.k0.create(n.cidVersion,n.codec.code,r);return n.onlyHash||await e.put(s,t,{signal:n.signal}),s};var mo=async(t,e,n)=>{const r=new go({type:"directory",mtime:t.mtime,mode:t.mode}),s=(0,v.encode)((0,v.prepare)({Data:r.marshal()}));return{cid:await wo(s,e,n),path:t.path,unixfs:r,size:s.length}},bo=n(53137);var Eo=async function(t,e){return e(await async function(t){const e=[];for await(const n of t)e.push(n);return e}(t))},_o=n(14205);async function vo(t,e,n){const r=[];for await(const s of(0,_o.Z)(t,n.maxChildrenPerNode))r.push(await e(s));return r.length>1?vo(r,e,n):r[0]}var ko=function(t,e,n){return vo(t,e,n)};var Ro=async function(t,e,n){const r=new To(n.layerRepeat);let s=0,o=1,i=r;for await(const a of(0,_o.Z)(t,n.maxChildrenPerNode))i.isFull()&&(i!==r&&r.addChild(await i.reduce(e)),s&&s%n.layerRepeat==0&&o++,i=new So(o,n.layerRepeat,s),s++),i.append(a);return i&&i!==r&&r.addChild(await i.reduce(e)),r.reduce(e)};class So{constructor(t,e,n=0){this.maxDepth=t,this.layerRepeat=e,this.currentDepth=1,this.iteration=n,this.root=this.node=this.parent={children:[],depth:this.currentDepth,maxDepth:t,maxChildren:(this.maxDepth-this.currentDepth)*this.layerRepeat}}isFull(){if(!this.root.data)return!1;if(this.currentDepth<this.maxDepth&&this.node.maxChildren)return this._addNextNodeToParent(this.node),!1;const t=this._findParent(this.node,this.currentDepth);return!t||(this._addNextNodeToParent(t),!1)}_addNextNodeToParent(t){this.parent=t;const e={children:[],depth:t.depth+1,parent:t,maxDepth:this.maxDepth,maxChildren:Math.floor(t.children.length/this.layerRepeat)*this.layerRepeat};t.children.push(e),this.currentDepth=e.depth,this.node=e}append(t){this.node.data=t}reduce(t){return this._reduce(this.root,t)}async _reduce(t,e){let n=[];return t.children.length&&(n=await Promise.all(t.children.filter((t=>t.data)).map((t=>this._reduce(t,e))))),e((t.data||[]).concat(n))}_findParent(t,e){const n=t.parent;if(n&&0!==n.depth)return n.children.length!==n.maxChildren&&n.maxChildren?n:this._findParent(n,e)}}class To extends So{constructor(t){super(0,t),this.root.depth=0,this.currentDepth=1}addChild(t){this.root.children.push(t)}reduce(t){return t((this.root.data||[]).concat(this.root.children))}}var Ao=async function*(t,e,n){for await(let r of t.content)yield async()=>{let s;n.progress(r.length,t.path);const o={codec:v,cidVersion:n.cidVersion,hasher:n.hasher,onlyHash:n.onlyHash};return n.rawLeaves?(o.codec=bo,o.cidVersion=1):(s=new go({type:n.leafType,data:r}),r=v.encode({Data:s.marshal(),Links:[]})),{cid:await wo(r,e,o),unixfs:s,size:r.length}}};const Io={flat:Eo,balanced:ko,trickle:Ro};var Do=function(t,e,n){const r=Io[n.strategy];if(!r)throw a(new Error(`Unknown importer build strategy name: ${n.strategy}`),"ERR_BAD_STRATEGY");return r(async function*(t,e,n){let r,s,o=-1;s="function"==typeof n.bufferImporter?n.bufferImporter:Ao;for await(const i of(0,Js.Z)(s(t,e,n),n.blockWriteConcurrency))o++,0!==o?(1===o&&r&&(yield r,r=null),yield i):r=i;r&&(r.single=!0,yield r)}(t,e,n),((t,e,n)=>async function(r){if(1===r.length&&r[0].single&&n.reduceSingleLeafToSelf){const s=r[0];if(void 0!==t.mtime||void 0!==t.mode){let r=await e.get(s.cid);s.unixfs=new go({type:"file",mtime:t.mtime,mode:t.mode,data:r}),r=(0,v.encode)((0,v.prepare)({Data:s.unixfs.marshal()})),s.cid=await wo(r,e,{...n,codec:v,hasher:n.hasher,cidVersion:n.cidVersion}),s.size=r.length}return{cid:s.cid,path:t.path,unixfs:s.unixfs,size:s.size}}const s=new go({type:"file",mtime:t.mtime,mode:t.mode}),o=r.filter((t=>!(t.cid.code!==bo.code||!t.size)||!(!t.unixfs||t.unixfs.data||!t.unixfs.fileSize())||Boolean(t.unixfs&&t.unixfs.data&&t.unixfs.data.length))).map((t=>t.cid.code===bo.code?(s.addBlockSize(t.size),{Name:"",Tsize:t.size,Hash:t.cid}):(t.unixfs&&t.unixfs.data?s.addBlockSize(t.unixfs.data.length):s.addBlockSize(t.unixfs&&t.unixfs.fileSize()||0),{Name:"",Tsize:t.size,Hash:t.cid}))),i={Data:s.marshal(),Links:o},a=(0,v.encode)((0,v.prepare)(i));return{cid:await wo(a,e,n),path:t.path,unixfs:s,size:a.length+i.Links.reduce(((t,e)=>t+e.Tsize),0)}})(t,e,n),n)},Po=n(62308),No=n(63060);var Oo=async function*(t,e){let n,r,s;if(e.minChunkSize&&e.maxChunkSize&&e.avgChunkSize)s=e.avgChunkSize,n=e.minChunkSize,r=e.maxChunkSize;else{if(!e.avgChunkSize)throw a(new Error("please specify an average chunk size"),"ERR_INVALID_AVG_CHUNK_SIZE");s=e.avgChunkSize,n=s/3,r=s+s/2}if(n<16)throw a(new Error("rabin min must be greater than 16"),"ERR_INVALID_MIN_CHUNK_SIZE");r<n&&(r=n),s<n&&(s=n);const o=Math.floor(Math.log2(s));for await(const s of async function*(t,e){const n=await(0,No.create)(e.bits,e.min,e.max,e.window),r=new Po.H;for await(const e of t){r.append(e);const t=n.fingerprint(e);for(let e=0;e<t.length;e++){const n=t[e],s=r.slice(0,n);r.consume(n),yield s}}r.length&&(yield r.subarray(0))}(t,{min:n,max:r,bits:o,window:e.window,polynomial:e.polynomial}))yield s};var Lo=async function*(t,e){let n=new Po.H,r=0,s=!1;const o=e.maxChunkSize;for await(const e of t)for(n.append(e),r+=e.length;r>=o;)if(yield n.slice(0,o),s=!0,o===n.length)n=new Po.H,r=0;else{const t=new Po.H;t.append(n.sublist(o)),n=t,r-=o}s&&!r||(yield n.subarray(0,r))};var Co=async function*(t){for await(const e of t){if(void 0===e.length)throw a(new Error("Content was invalid"),"ERR_INVALID_CONTENT");if("string"==typeof e||e instanceof String)yield(0,x.m)(e.toString());else if(Array.isArray(e))yield Uint8Array.from(e);else{if(!(e instanceof Uint8Array))throw a(new Error("Content was invalid"),"ERR_INVALID_CONTENT");yield e}}};function Mo(t){try{if(t instanceof Uint8Array)return async function*(){yield t}();if(e=t,Symbol.iterator in e)return async function*(){yield*t}();if(function(t){return Symbol.asyncIterator in t}(t))return t}catch{throw a(new Error("Content was invalid"),"ERR_INVALID_CONTENT")}var e;throw a(new Error("Content was invalid"),"ERR_INVALID_CONTENT")}var xo=async function*(t,e,n){for await(const r of t)if(r.path&&("./"===r.path.substring(0,2)&&(n.wrapWithDirectory=!0),r.path=r.path.split("/").filter((t=>t&&"."!==t)).join("/")),r.content){let t,s;t="function"==typeof n.chunker?n.chunker:"rabin"===n.chunker?Oo:Lo,s="function"==typeof n.chunkValidator?n.chunkValidator:Co;const o={path:r.path,mtime:r.mtime,mode:r.mode,content:t(s(Mo(r.content),n),n)};yield()=>Do(o,e,n)}else{if(!r.path)throw new Error("Import candidate must have content or path or both");{const t={path:r.path,mtime:r.mtime,mode:r.mode};yield()=>mo(t,e,n)}}};var Bo=class{constructor(t,e){this.options=e||{},this.root=t.root,this.dir=t.dir,this.path=t.path,this.dirty=t.dirty,this.flat=t.flat,this.parent=t.parent,this.parentKey=t.parentKey,this.unixfs=t.unixfs,this.mode=t.mode,this.mtime=t.mtime,this.cid=void 0,this.size=void 0}async put(t,e){}get(t){return Promise.resolve(this)}async*eachChildSeries(){}async*flush(t){}};var zo=class extends Bo{constructor(t,e){super(t,e),this._children={}}async put(t,e){this.cid=void 0,this.size=void 0,this._children[t]=e}get(t){return Promise.resolve(this._children[t])}childCount(){return Object.keys(this._children).length}directChildrenCount(){return this.childCount()}onlyChild(){return this._children[Object.keys(this._children)[0]]}async*eachChildSeries(){const t=Object.keys(this._children);for(let e=0;e<t.length;e++){const n=t[e];yield{key:n,child:this._children[n]}}}async*flush(t){const e=Object.keys(this._children),n=[];for(let r=0;r<e.length;r++){let s=this._children[e[r]];if(s instanceof Bo)for await(const e of s.flush(t))s=e,yield s;null!=s.size&&s.cid&&n.push({Name:e[r],Tsize:s.size,Hash:s.cid})}const r=new go({type:"directory",mtime:this.mtime,mode:this.mode}),s={Data:r.marshal(),Links:n},o=(0,v.encode)((0,v.prepare)(s)),i=await wo(o,t,this.options),a=o.length+s.Links.reduce(((t,e)=>t+(null==e.Tsize?0:e.Tsize)),0);this.cid=i,this.size=a,yield{cid:i,unixfs:r,path:this.path,size:a}}},Uo=n(96991);var jo=class extends Bo{constructor(t,e){super(t,e),this._bucket=(0,Uo.$)({hashFn:e.hamtHashFn,bits:e.hamtBucketBits})}async put(t,e){await this._bucket.put(t,e)}get(t){return this._bucket.get(t)}childCount(){return this._bucket.leafCount()}directChildrenCount(){return this._bucket.childrenCount()}onlyChild(){return this._bucket.onlyChild()}async*eachChildSeries(){for await(const{key:t,value:e}of this._bucket.eachLeafSeries())yield{key:t,child:e}}async*flush(t){for await(const e of $o(this._bucket,t,this,this.options))yield{...e,path:this.path}}};async function*$o(t,e,n,r){const s=t._children,o=[];let i=0;for(let t=0;t<s.length;t++){const n=s.get(t);if(!n)continue;const a=t.toString(16).toUpperCase().padStart(2,"0");if(n instanceof Uo.r){let t;for await(const s of await $o(n,e,null,r))t=s;if(!t)throw new Error("Could not flush sharded directory, no subshard found");o.push({Name:a,Tsize:t.size,Hash:t.cid}),i+=t.size}else if("function"==typeof n.value.flush){const t=n.value;let r;for await(const n of t.flush(e))r=n,yield r;const s=a+n.key;o.push({Name:s,Tsize:r.size,Hash:r.cid}),i+=r.size}else{const t=n.value;if(!t.cid)continue;const e=a+n.key,r=t.size;o.push({Name:e,Tsize:r,Hash:t.cid}),i+=r}}const a=Uint8Array.from(s.bitField().reverse()),c=new go({type:"hamt-sharded-directory",data:a,fanout:t.tableSize(),hashType:r.hamtHashCode,mtime:n&&n.mtime,mode:n&&n.mode}),l={Data:c.marshal(),Links:o},u=(0,v.encode)((0,v.prepare)(l)),d=await wo(u,e,r),h=u.length+i;yield{cid:d,unixfs:c,size:h}}var Vo=async function t(e,n,r,s){let o=n;n instanceof zo&&n.directChildrenCount()>=r&&(o=await async function(t,e){const n=new jo({root:t.root,dir:!0,parent:t.parent,parentKey:t.parentKey,path:t.path,dirty:t.dirty,flat:!1,mtime:t.mtime,mode:t.mode},e);for await(const{key:e,child:r}of t.eachChildSeries())await n.put(e,r);return n}(n,s));const i=o.parent;if(i){if(o!==n){if(e&&(e.parent=o),!o.parentKey)throw new Error("No parent key found");await i.put(o.parentKey,o)}return t(o,i,r,s)}return o};var Ho=(t="")=>(t.trim().match(/([^\\/]|\\\/)+/g)||[]).filter(Boolean);async function Fo(t,e,n){const r=Ho(t.path||""),s=r.length-1;let o=e,i="";for(let a=0;a<r.length;a++){const c=r[a];i+=`${i?"/":""}${c}`;const l=a===s;if(o.dirty=!0,o.cid=void 0,o.size=void 0,l)await o.put(c,t),e=await Vo(null,o,n.shardSplitThreshold,n);else{let t=await o.get(c);t&&t instanceof Bo||(t=new zo({root:!1,dir:!0,parent:o,parentKey:c,path:i,dirty:!0,flat:!0,mtime:t&&t.unixfs&&t.unixfs.mtime,mode:t&&t.unixfs&&t.unixfs.mode},n)),await o.put(c,t),o=t}}return e}async function*Ko(t,e){t instanceof Bo?yield*t.flush(e):t&&t.unixfs&&t.unixfs.isDirectory()&&(yield t)}var qo=async function*(t,e,n){let r=new zo({root:!0,dir:!0,path:"",dirty:!0,flat:!0},n);for await(const e of t)e&&(r=await Fo(e,r,n),e.unixfs&&e.unixfs.isDirectory()||(yield e));if(n.wrapWithDirectory)yield*Ko(r,e);else for await(const t of r.eachChildSeries())t&&(yield*Ko(t.child,e))};async function*Go(t,e,n={}){const r=eo(n);let s,o,i;s="function"==typeof n.dagBuilder?n.dagBuilder:xo,o="function"==typeof n.treeBuilder?n.treeBuilder:qo,i=Symbol.asyncIterator in t||Symbol.iterator in t?t:[t];for await(const t of o((0,Js.Z)(s(i,e,r),r.fileImportConcurrency),e,r))yield{cid:t.cid,path:t.path,unixfs:t.unixfs,size:t.size}}var Wo=n(3064);const Zo=t=>{if(t){if(t.startsWith("size-")){const e=t.split("-")[1],n=parseInt(e);if(isNaN(n))throw new Error("Chunker parameter size must be an integer");return{chunker:"fixed",maxChunkSize:n}}if(t.startsWith("rabin"))return{chunker:"rabin",...Yo(t)};throw new Error(`Unrecognized chunker option: ${t}`)}return{chunker:"fixed"}},Yo=t=>{const e={},n=t.split("-");switch(n.length){case 1:e.avgChunkSize=262144;break;case 2:e.avgChunkSize=Jo(n[1],"avg");break;case 4:e.minChunkSize=Jo(n[1],"min"),e.avgChunkSize=Jo(n[2],"avg"),e.maxChunkSize=Jo(n[3],"max");break;default:throw new Error('Incorrect chunker format (expected "rabin" "rabin-[avg]" or "rabin-[min]-[avg]-[max]"')}return e},Jo=(t,e)=>{const n=parseInt(t);if(isNaN(n))throw new Error(`Chunker parameter ${e} must be an integer`);return n},Qo=s.Z.bind({ignoreUndefined:!0});var Xo=n(68653);const ti=Xo.Reader,ei=Xo.Writer,ni=Xo.util,ri=Xo.roots["ipfs-unixfs"]||(Xo.roots["ipfs-unixfs"]={}),si=ri.Data=(()=>{function t(t){if(this.blocksizes=[],t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.Type=0,t.prototype.Data=ni.newBuffer([]),t.prototype.filesize=ni.Long?ni.Long.fromBits(0,0,!0):0,t.prototype.blocksizes=ni.emptyArray,t.prototype.hashType=ni.Long?ni.Long.fromBits(0,0,!0):0,t.prototype.fanout=ni.Long?ni.Long.fromBits(0,0,!0):0,t.prototype.mode=0,t.prototype.mtime=null,t.encode=function(t,e){if(e||(e=ei.create()),e.uint32(8).int32(t.Type),null!=t.Data&&Object.hasOwnProperty.call(t,"Data")&&e.uint32(18).bytes(t.Data),null!=t.filesize&&Object.hasOwnProperty.call(t,"filesize")&&e.uint32(24).uint64(t.filesize),null!=t.blocksizes&&t.blocksizes.length)for(var n=0;n<t.blocksizes.length;++n)e.uint32(32).uint64(t.blocksizes[n]);return null!=t.hashType&&Object.hasOwnProperty.call(t,"hashType")&&e.uint32(40).uint64(t.hashType),null!=t.fanout&&Object.hasOwnProperty.call(t,"fanout")&&e.uint32(48).uint64(t.fanout),null!=t.mode&&Object.hasOwnProperty.call(t,"mode")&&e.uint32(56).uint32(t.mode),null!=t.mtime&&Object.hasOwnProperty.call(t,"mtime")&&ri.UnixTime.encode(t.mtime,e.uint32(66).fork()).ldelim(),e},t.decode=function(t,e){t instanceof ti||(t=ti.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new ri.Data;t.pos<n;){var s=t.uint32();switch(s>>>3){case 1:r.Type=t.int32();break;case 2:r.Data=t.bytes();break;case 3:r.filesize=t.uint64();break;case 4:if(r.blocksizes&&r.blocksizes.length||(r.blocksizes=[]),2==(7&s))for(var o=t.uint32()+t.pos;t.pos<o;)r.blocksizes.push(t.uint64());else r.blocksizes.push(t.uint64());break;case 5:r.hashType=t.uint64();break;case 6:r.fanout=t.uint64();break;case 7:r.mode=t.uint32();break;case 8:r.mtime=ri.UnixTime.decode(t,t.uint32());break;default:t.skipType(7&s)}}if(!r.hasOwnProperty("Type"))throw ni.ProtocolError("missing required 'Type'",{instance:r});return r},t.fromObject=function(t){if(t instanceof ri.Data)return t;var e=new ri.Data;switch(t.Type){case"Raw":case 0:e.Type=0;break;case"Directory":case 1:e.Type=1;break;case"File":case 2:e.Type=2;break;case"Metadata":case 3:e.Type=3;break;case"Symlink":case 4:e.Type=4;break;case"HAMTShard":case 5:e.Type=5}if(null!=t.Data&&("string"==typeof t.Data?ni.base64.decode(t.Data,e.Data=ni.newBuffer(ni.base64.length(t.Data)),0):t.Data.length&&(e.Data=t.Data)),null!=t.filesize&&(ni.Long?(e.filesize=ni.Long.fromValue(t.filesize)).unsigned=!0:"string"==typeof t.filesize?e.filesize=parseInt(t.filesize,10):"number"==typeof t.filesize?e.filesize=t.filesize:"object"==typeof t.filesize&&(e.filesize=new ni.LongBits(t.filesize.low>>>0,t.filesize.high>>>0).toNumber(!0))),t.blocksizes){if(!Array.isArray(t.blocksizes))throw TypeError(".Data.blocksizes: array expected");e.blocksizes=[];for(var n=0;n<t.blocksizes.length;++n)ni.Long?(e.blocksizes[n]=ni.Long.fromValue(t.blocksizes[n])).unsigned=!0:"string"==typeof t.blocksizes[n]?e.blocksizes[n]=parseInt(t.blocksizes[n],10):"number"==typeof t.blocksizes[n]?e.blocksizes[n]=t.blocksizes[n]:"object"==typeof t.blocksizes[n]&&(e.blocksizes[n]=new ni.LongBits(t.blocksizes[n].low>>>0,t.blocksizes[n].high>>>0).toNumber(!0))}if(null!=t.hashType&&(ni.Long?(e.hashType=ni.Long.fromValue(t.hashType)).unsigned=!0:"string"==typeof t.hashType?e.hashType=parseInt(t.hashType,10):"number"==typeof t.hashType?e.hashType=t.hashType:"object"==typeof t.hashType&&(e.hashType=new ni.LongBits(t.hashType.low>>>0,t.hashType.high>>>0).toNumber(!0))),null!=t.fanout&&(ni.Long?(e.fanout=ni.Long.fromValue(t.fanout)).unsigned=!0:"string"==typeof t.fanout?e.fanout=parseInt(t.fanout,10):"number"==typeof t.fanout?e.fanout=t.fanout:"object"==typeof t.fanout&&(e.fanout=new ni.LongBits(t.fanout.low>>>0,t.fanout.high>>>0).toNumber(!0))),null!=t.mode&&(e.mode=t.mode>>>0),null!=t.mtime){if("object"!=typeof t.mtime)throw TypeError(".Data.mtime: object expected");e.mtime=ri.UnixTime.fromObject(t.mtime)}return e},t.toObject=function(t,e){e||(e={});var n={};if((e.arrays||e.defaults)&&(n.blocksizes=[]),e.defaults){if(n.Type=e.enums===String?"Raw":0,e.bytes===String?n.Data="":(n.Data=[],e.bytes!==Array&&(n.Data=ni.newBuffer(n.Data))),ni.Long){var r=new ni.Long(0,0,!0);n.filesize=e.longs===String?r.toString():e.longs===Number?r.toNumber():r}else n.filesize=e.longs===String?"0":0;if(ni.Long){r=new ni.Long(0,0,!0);n.hashType=e.longs===String?r.toString():e.longs===Number?r.toNumber():r}else n.hashType=e.longs===String?"0":0;if(ni.Long){r=new ni.Long(0,0,!0);n.fanout=e.longs===String?r.toString():e.longs===Number?r.toNumber():r}else n.fanout=e.longs===String?"0":0;n.mode=0,n.mtime=null}if(null!=t.Type&&t.hasOwnProperty("Type")&&(n.Type=e.enums===String?ri.Data.DataType[t.Type]:t.Type),null!=t.Data&&t.hasOwnProperty("Data")&&(n.Data=e.bytes===String?ni.base64.encode(t.Data,0,t.Data.length):e.bytes===Array?Array.prototype.slice.call(t.Data):t.Data),null!=t.filesize&&t.hasOwnProperty("filesize")&&("number"==typeof t.filesize?n.filesize=e.longs===String?String(t.filesize):t.filesize:n.filesize=e.longs===String?ni.Long.prototype.toString.call(t.filesize):e.longs===Number?new ni.LongBits(t.filesize.low>>>0,t.filesize.high>>>0).toNumber(!0):t.filesize),t.blocksizes&&t.blocksizes.length){n.blocksizes=[];for(var s=0;s<t.blocksizes.length;++s)"number"==typeof t.blocksizes[s]?n.blocksizes[s]=e.longs===String?String(t.blocksizes[s]):t.blocksizes[s]:n.blocksizes[s]=e.longs===String?ni.Long.prototype.toString.call(t.blocksizes[s]):e.longs===Number?new ni.LongBits(t.blocksizes[s].low>>>0,t.blocksizes[s].high>>>0).toNumber(!0):t.blocksizes[s]}return null!=t.hashType&&t.hasOwnProperty("hashType")&&("number"==typeof t.hashType?n.hashType=e.longs===String?String(t.hashType):t.hashType:n.hashType=e.longs===String?ni.Long.prototype.toString.call(t.hashType):e.longs===Number?new ni.LongBits(t.hashType.low>>>0,t.hashType.high>>>0).toNumber(!0):t.hashType),null!=t.fanout&&t.hasOwnProperty("fanout")&&("number"==typeof t.fanout?n.fanout=e.longs===String?String(t.fanout):t.fanout:n.fanout=e.longs===String?ni.Long.prototype.toString.call(t.fanout):e.longs===Number?new ni.LongBits(t.fanout.low>>>0,t.fanout.high>>>0).toNumber(!0):t.fanout),null!=t.mode&&t.hasOwnProperty("mode")&&(n.mode=t.mode),null!=t.mtime&&t.hasOwnProperty("mtime")&&(n.mtime=ri.UnixTime.toObject(t.mtime,e)),n},t.prototype.toJSON=function(){return this.constructor.toObject(this,Xo.util.toJSONOptions)},t.DataType=function(){const t={},e=Object.create(t);return e[t[0]="Raw"]=0,e[t[1]="Directory"]=1,e[t[2]="File"]=2,e[t[3]="Metadata"]=3,e[t[4]="Symlink"]=4,e[t[5]="HAMTShard"]=5,e}(),t})(),oi=(ri.UnixTime=(()=>{function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.Seconds=ni.Long?ni.Long.fromBits(0,0,!1):0,t.prototype.FractionalNanoseconds=0,t.encode=function(t,e){return e||(e=ei.create()),e.uint32(8).int64(t.Seconds),null!=t.FractionalNanoseconds&&Object.hasOwnProperty.call(t,"FractionalNanoseconds")&&e.uint32(21).fixed32(t.FractionalNanoseconds),e},t.decode=function(t,e){t instanceof ti||(t=ti.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new ri.UnixTime;t.pos<n;){var s=t.uint32();switch(s>>>3){case 1:r.Seconds=t.int64();break;case 2:r.FractionalNanoseconds=t.fixed32();break;default:t.skipType(7&s)}}if(!r.hasOwnProperty("Seconds"))throw ni.ProtocolError("missing required 'Seconds'",{instance:r});return r},t.fromObject=function(t){if(t instanceof ri.UnixTime)return t;var e=new ri.UnixTime;return null!=t.Seconds&&(ni.Long?(e.Seconds=ni.Long.fromValue(t.Seconds)).unsigned=!1:"string"==typeof t.Seconds?e.Seconds=parseInt(t.Seconds,10):"number"==typeof t.Seconds?e.Seconds=t.Seconds:"object"==typeof t.Seconds&&(e.Seconds=new ni.LongBits(t.Seconds.low>>>0,t.Seconds.high>>>0).toNumber())),null!=t.FractionalNanoseconds&&(e.FractionalNanoseconds=t.FractionalNanoseconds>>>0),e},t.toObject=function(t,e){e||(e={});var n={};if(e.defaults){if(ni.Long){var r=new ni.Long(0,0,!1);n.Seconds=e.longs===String?r.toString():e.longs===Number?r.toNumber():r}else n.Seconds=e.longs===String?"0":0;n.FractionalNanoseconds=0}return null!=t.Seconds&&t.hasOwnProperty("Seconds")&&("number"==typeof t.Seconds?n.Seconds=e.longs===String?String(t.Seconds):t.Seconds:n.Seconds=e.longs===String?ni.Long.prototype.toString.call(t.Seconds):e.longs===Number?new ni.LongBits(t.Seconds.low>>>0,t.Seconds.high>>>0).toNumber():t.Seconds),null!=t.FractionalNanoseconds&&t.hasOwnProperty("FractionalNanoseconds")&&(n.FractionalNanoseconds=t.FractionalNanoseconds),n},t.prototype.toJSON=function(){return this.constructor.toObject(this,Xo.util.toJSONOptions)},t})(),ri.Metadata=(()=>{function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.MimeType="",t.encode=function(t,e){return e||(e=ei.create()),null!=t.MimeType&&Object.hasOwnProperty.call(t,"MimeType")&&e.uint32(10).string(t.MimeType),e},t.decode=function(t,e){t instanceof ti||(t=ti.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new ri.Metadata;t.pos<n;){var s=t.uint32();if(s>>>3==1)r.MimeType=t.string();else t.skipType(7&s)}return r},t.fromObject=function(t){if(t instanceof ri.Metadata)return t;var e=new ri.Metadata;return null!=t.MimeType&&(e.MimeType=String(t.MimeType)),e},t.toObject=function(t,e){e||(e={});var n={};return e.defaults&&(n.MimeType=""),null!=t.MimeType&&t.hasOwnProperty("MimeType")&&(n.MimeType=t.MimeType),n},t.prototype.toJSON=function(){return this.constructor.toObject(this,Xo.util.toJSONOptions)},t})(),si),ii=["raw","directory","file","metadata","symlink","hamt-sharded-directory"],ai=["directory","hamt-sharded-directory"],ci=parseInt("0644",8),li=parseInt("0755",8);function ui(t){if(null!=t)return"number"==typeof t?4095&t:"0"===(t=t.toString()).substring(0,1)?4095&parseInt(t,8):4095&parseInt(t,10)}function di(t){if(null==t)return;let e;if(null!=t.secs&&(e={secs:t.secs,nsecs:t.nsecs}),null!=t.Seconds&&(e={secs:t.Seconds,nsecs:t.FractionalNanoseconds}),Array.isArray(t)&&(e={secs:t[0],nsecs:t[1]}),t instanceof Date){const n=t.getTime(),r=Math.floor(n/1e3);e={secs:r,nsecs:1e3*(n-1e3*r)}}if(Object.prototype.hasOwnProperty.call(e,"secs")){if(null!=e&&null!=e.nsecs&&(e.nsecs<0||e.nsecs>999999999))throw a(new Error("mtime-nsecs must be within the range [0,999999999]"),"ERR_INVALID_MTIME_NSECS");return e}}class hi{static unmarshal(t){const e=oi.decode(t),n=oi.toObject(e,{defaults:!1,arrays:!0,longs:Number,objects:!1}),r=new hi({type:ii[n.Type],data:n.Data,blockSizes:n.blocksizes,mode:n.mode,mtime:n.mtime?{secs:n.mtime.Seconds,nsecs:n.mtime.FractionalNanoseconds}:void 0});return r._originalMode=n.mode||0,r}constructor(t={type:"file"}){const{type:e,data:n,blockSizes:r,hashType:s,fanout:o,mtime:i,mode:c}=t;if(e&&!ii.includes(e))throw a(new Error("Type: "+e+" is not valid"),"ERR_INVALID_TYPE");this.type=e||"file",this.data=n,this.hashType=s,this.fanout=o,this.blockSizes=r||[],this._originalMode=0,this.mode=ui(c),i&&(this.mtime=di(i),this.mtime&&!this.mtime.nsecs&&(this.mtime.nsecs=0))}set mode(t){this._mode=this.isDirectory()?li:ci;const e=ui(t);void 0!==e&&(this._mode=e)}get mode(){return this._mode}isDirectory(){return Boolean(this.type&&ai.includes(this.type))}addBlockSize(t){this.blockSizes.push(t)}removeBlockSize(t){this.blockSizes.splice(t,1)}fileSize(){if(this.isDirectory())return 0;let t=0;return this.blockSizes.forEach((e=>{t+=e})),this.data&&(t+=this.data.length),t}marshal(){let t;switch(this.type){case"raw":t=oi.DataType.Raw;break;case"directory":t=oi.DataType.Directory;break;case"file":t=oi.DataType.File;break;case"metadata":t=oi.DataType.Metadata;break;case"symlink":t=oi.DataType.Symlink;break;case"hamt-sharded-directory":t=oi.DataType.HAMTShard;break;default:throw a(new Error("Type: "+t+" is not valid"),"ERR_INVALID_TYPE")}let e,n,r=this.data;if(this.data&&this.data.length||(r=void 0),null!=this.mode&&(e=4294963200&this._originalMode|(ui(this.mode)||0),e!==ci||this.isDirectory()||(e=void 0),e===li&&this.isDirectory()&&(e=void 0)),null!=this.mtime){const t=di(this.mtime);t&&(n={Seconds:t.secs,FractionalNanoseconds:t.nsecs},0===n.FractionalNanoseconds&&delete n.FractionalNanoseconds)}const s={Type:t,Data:r,filesize:this.isDirectory()?void 0:this.fileSize(),blocksizes:this.blockSizes,hashType:this.hashType,fanout:this.fanout,mode:e,mtime:n};return oi.encode(s).finish()}}const pi=async function(t){return(await Xs.Pv.encode(t)).slice(0,8).reverse()},fi=t=>t.toString(16).toUpperCase().padStart(2,"0").substring(0,2),yi=async(t,e,n,r,s)=>{if(!r){const t=(0,Uo.$)({hashFn:pi});r={rootBucket:t,hamtDepth:1,lastBucket:t}}await((t,e,n)=>Promise.all(t.map((t=>{if(null==t.Name)throw new Error("Unexpected Link without a Name");if(2===t.Name.length){const r=parseInt(t.Name,16);return e._putObjectAt(r,new Uo.r({hash:n._options.hash,bits:n._options.bits},e,r))}return n.put(t.Name.substring(2),!0)}))))(t.Links,r.lastBucket,r.rootBucket);const o=await r.rootBucket._findNewBucketAndPos(e);let i=fi(o.pos);const a=(t=>{let e=t.bucket;const n=[];for(;e._parent;)n.push(e),e=e._parent;return n.push(e),n.reverse()})(o);a.length>r.hamtDepth&&(r.lastBucket=a[r.hamtDepth],i=fi(r.lastBucket._posAtParent));const c=t.Links.find((t=>{if(null==t.Name)return!1;const n=t.Name.substring(0,2),r=t.Name.substring(2);return n===i&&(!r||r===e)}));if(!c)return null;if(null!=c.Name&&c.Name.substring(2)===e)return c.Hash;r.hamtDepth++;const l=await n.get(c.Hash,s);return t=(0,v.decode)(l),yi(t,e,n,r,s)};var gi=yi;var wi=function(t,e,n,r){const s=e+t.length;return n>=s||r<e?new Uint8Array(0):(r>=e&&r<s&&(t=t.subarray(0,r-e)),n>=e&&n<s&&(t=t.subarray(n-e)),t)};var mi=(t,e,n)=>{if(e||(e=0),e<0)throw a(new Error("Offset must be greater than or equal to 0"),"ERR_INVALID_PARAMS");if(e>t)throw a(new Error("Offset must be less than the file size"),"ERR_INVALID_PARAMS");if(n||0===n||(n=t-e),n<0)throw a(new Error("Length must be greater than or equal to 0"),"ERR_INVALID_PARAMS");return e+n>t&&(n=t-e),{offset:e,length:n}};const bi=(...t)=>{let e;for(;t.length>0;)e=t.shift()(e);return e},Ei=t=>null!=t&&("function"==typeof t[Symbol.asyncIterator]||"function"==typeof t[Symbol.iterator]||"function"==typeof t.next),_i=t=>null!=t&&"function"==typeof t.sink&&Ei(t.source),vi=t=>e=>{const n=t.sink(e);if(null!=n.then){const e=(0,zn.d)({objectMode:!0});n.then((()=>{e.end()}),(t=>{e.end(t)}));const r=async function*(){yield*t.source,e.end()};return(0,Vs.Z)(e,r())}return t.source};var ki=n(95972);async function Ri(t,e,n,r,s,o,i,c){if(e instanceof Uint8Array)return void n.push(wi(e,r,s,o));if(null==e.Data)throw a(new Error("no data in PBNode"),"ERR_NOT_UNIXFS");let l;try{l=hi.unmarshal(e.Data)}catch(t){throw a(t,"ERR_NOT_UNIXFS")}if(null!=l.data){const t=l.data,e=wi(t,r,s,o);n.push(e),r+=e.byteLength}const u=[];for(let t=0;t<e.Links.length;t++){const n=e.Links[t],i=r,a=i+l.blockSizes[t];if((s>=i&&s<a||o>=i&&o<=a||s<i&&o>a)&&u.push({link:n,blockStart:r}),(r=a)>o)break}await function(t,...e){if(_i(t)){const e=t;t=()=>e.source}else if(Ei(t)){const e=t;t=()=>e}const n=[t,...e];if(n.length>1&&_i(n[n.length-1])&&(n[n.length-1]=n[n.length-1].sink),n.length>2)for(let t=1;t<n.length-1;t++)_i(n[t])&&(n[t]=vi(n[t]));return bi(...n)}(u,(e=>(0,$s.Z)(e,(e=>async()=>{const n=await t.get(e.link.Hash,{signal:c.signal});return{...e,block:n}}))),(t=>(0,js.Z)(t,{ordered:!0})),(async e=>{for await(const{link:r,block:l,blockStart:u}of e){let e;switch(r.Hash.code){case v.code:e=v.decode(l);break;case bo.code:e=l;break;default:return void n.end(a(new Error(`Unsupported codec: ${r.Hash.code}`),"ERR_NOT_UNIXFS"))}i.add((async()=>{await Ri(t,e,n,u,s,o,i,c)}))}}))}var Si=(t,e,n,r,s,o,i)=>async function*(t={}){const r=n.fileSize();if(void 0===r)throw new Error("File was a directory");const{offset:s,length:o}=mi(r,t.offset,t.length);if(0===o)return;const a=new ki.Z({concurrency:1}),c=(0,zn.d)();a.add((async()=>{await Ri(i,e,c,0,s,s+o,a,t)})),a.on("error",(t=>{c.end(t)}));let l=0;for await(const t of c)null!=t&&(l+=t.byteLength,l===o&&c.end(),yield t)};var Ti=(t,e,n,r,s,o,i)=>async function*(t={}){const n=t.offset||0,a=t.length||e.Links.length,c=e.Links.slice(n,a);for(const e of c){const n=await s(e.Hash,e.Name||"",`${r}/${e.Name||""}`,[],o+1,i,t);n.entry&&(yield n.entry)}};async function*Ai(t,e,n,r,s,o){const i=t.Links;for(const a of i){const i=null!=a.Name?a.Name.substring(2):null;if(i){const t=await n(a.Hash,i,`${e}/${i}`,[],r+1,s,o);yield t.entry}else{const i=await s.get(a.Hash);t=(0,v.decode)(i);for await(const i of Ai(t,e,n,r,s,o))yield i}}}var Ii=(t,e,n,r,s,o,i)=>function(t={}){return Ai(e,r,s,o,i,t)};const Di={raw:Si,file:Si,directory:Ti,"hamt-sharded-directory":Ii,metadata:(t,e,n,r,s,o,i)=>()=>[],symlink:(t,e,n,r,s,o,i)=>()=>[]};var Pi=async(t,e,n,r,s,o,i,c)=>{const l=await i.get(t,c),u=(0,v.decode)(l);let d,h;if(e||(e=t.toString()),null==u.Data)throw a(new Error("no data in PBNode"),"ERR_NOT_UNIXFS");try{d=hi.unmarshal(u.Data)}catch(t){throw a(t,"ERR_NOT_UNIXFS")}if(n||(n=e),r.length){let t;if(t=d&&"hamt-sharded-directory"===d.type?await gi(u,r[0],i):((t,e)=>{const n=t.Links.find((t=>t.Name===e));return n&&n.Hash})(u,r[0]),!t)throw a(new Error("file does not exist"),"ERR_NOT_FOUND");const e=r.shift();h={cid:t,toResolve:r,name:e||"",path:`${n}/${e}`}}return{entry:{type:d.isDirectory()?"directory":"file",name:e,path:n,cid:t,content:Di[d.type](t,u,d,n,s,o,i),unixfs:d,depth:o,node:u,size:d.fileSize()},next:h}};var Ni=async(t,e,n,r,s,o,i,c)=>{if(r.length)throw a(new Error(`No link named ${n} found in raw node ${t}`),"ERR_NOT_FOUND");const l=await i.get(t,c);return{entry:{type:"raw",name:e,path:n,cid:t,content:(u=l,async function*(t={}){const{offset:e,length:n}=mi(u.length,t.offset,t.length);yield wi(u,0,e,e+n)}),depth:o,size:l.length,node:l}};var u};var Oi=async(t,e,n,r,s,o,i,c)=>{const l=await i.get(t),u=k.decode(l);let d=u,h=n;for(;r.length;){const s=r[0];if(!(s in d))throw a(new Error(`No property named ${s} found in cbor node ${t}`),"ERR_NO_PROP");{r.shift(),h=`${h}/${s}`;const i=Q.k0.asCID(d[s]);if(i)return{entry:{type:"object",name:e,path:n,cid:t,node:l,depth:o,size:l.length,content:async function*(){yield u}},next:{cid:i,name:s,path:h,toResolve:r}};d=d[s]}}return{entry:{type:"object",name:e,path:n,cid:t,node:l,depth:o,size:l.length,content:async function*(){yield u}}}};var Li=async(t,e,n,r,s,o,i,c)=>{if(r.length)throw a(new Error(`No link named ${n} found in raw node ${t}`),"ERR_NOT_FOUND");const l=await j.Jx(t.multihash.bytes);return{entry:{type:"identity",name:e,path:n,cid:t,content:(u=l.digest,async function*(t={}){const{offset:e,length:n}=mi(u.length,t.offset,t.length);yield wi(u,0,e,e+n)}),depth:o,size:l.digest.length,node:l.digest}};var u};const Ci={[v.code]:Pi,[bo.code]:Ni,[k.code]:Oi,[T.identity.code]:Li};var Mi=function t(e,n,r,s,o,i,c){const l=Ci[e.code];if(!l)throw a(new Error(`No resolver for code ${e.code}`),"ERR_NO_RESOLVER");return l(e,n,r,s,t,o,i,c)};const xi=t=>{if(t instanceof Uint8Array)return{cid:Q.k0.decode(t),toResolve:[]};const e=Q.k0.asCID(t);if(e)return{cid:e,toResolve:[]};if("string"==typeof t){0===t.indexOf("/ipfs/")&&(t=t.substring(6));const e=((t="")=>(t.trim().match(/([^\\^/]|\\\/)+/g)||[]).filter(Boolean))(t);return{cid:Q.k0.parse(e[0]),toResolve:e.slice(1)}}throw a(new Error(`Unknown path type ${t}`),"ERR_BAD_PATH")};async function*Bi(t,e,n={}){let{cid:r,toResolve:s}=xi(t),o=r.toString(),i=o;const c=s.length;for(;;){const l=await Mi(r,o,i,s,c,e,n);if(!l.entry&&!l.next)throw a(new Error(`Could not resolve ${t}`),"ERR_NOT_FOUND");if(l.entry&&(yield l.entry),!l.next)return;s=l.next.toResolve,r=l.next.cid,o=l.next.name,i=l.next.path}}async function zi(t,e,n={}){const r=await(0,Le.Z)(Bi(t,e,n));if(!r)throw a(new Error(`Could not resolve ${t}`),"ERR_NOT_FOUND");return r}async function*Ui(t,e,n={}){const r=await zi(t,e,n);if(r&&(yield r,"directory"===r.type))for await(const t of async function*t(e,n){for await(const r of e.content(n))yield r,r instanceof Uint8Array||"directory"===r.type&&(yield*t(r,n))}(r,n))yield t}var ji=n(95105),$i=n(88424),Vi=n(17833);class Hi{constructor({preload:t,repo:e,hashers:n,options:r}){const s=function({repo:t,preload:e,hashers:n,options:r}){const s=r&&r.sharding;return(0,Ee.a)((async function*(r,o={}){const i=Qo({shardSplitThreshold:s?1e3:1/0,strategy:"balanced"},o,{...Zo(o.chunker)});i.hashAlg&&"sha2-256"!==i.hashAlg&&1!==i.cidVersion&&(i.cidVersion=1),i.trickle&&(i.strategy="trickle"),"trickle"===i.strategy&&(i.leafType="raw",i.reduceSingleLeafToSelf=!1),i.cidVersion>0&&void 0===i.rawLeaves&&(i.rawLeaves=!0),void 0!==i.hashAlg&&void 0===i.rawLeaves&&(i.rawLeaves=!0),delete i.trickle;const a={};if(i.progress){const t=i.progress;i.progress=(e,n)=>{a[n]||(a[n]=0),a[n]+=e,t(a[n],n)}}let c;null!=i.hashAlg&&(c=await n.getHasher(i.hashAlg));const l=Gs((0,Wo.f)(r),(e=>Go(e,t.blocks,{...i,hasher:c,pin:!1})),function(t){async function*e(e){for await(const n of e){let e=n.cid;1===t.cidVersion&&(e=e.toV1());let r=n.path?n.path:e.toString();t.wrapWithDirectory&&!n.path&&(r=""),yield{path:r,cid:e,size:n.size,mode:n.unixfs&&n.unixfs.mode,mtime:n.unixfs&&n.unixfs.mtime}}}return e}(i),function(t,e){async function*n(n){for await(const r of n)(!r.path||e.wrapWithDirectory?""===r.path:!r.path.includes("/"))&&!e.onlyHash&&!1!==e.preload&&t(r.cid),yield r}return n}(e,i),function(t,e){async function*n(n){for await(const r of n){const n=!(r.path&&r.path.includes("/"));(null==e.pin||e.pin)&&n&&!e.onlyHash&&await t.pins.pinRecursively(r.cid),yield r}}return n}(t,i)),u=await t.gcLock.readLock();try{for await(const t of l){const e=t.path??t.cid.toString();delete a[e],yield{...t,path:e}}}finally{u()}}))}({preload:t,repo:e,options:r,hashers:n});this.addAll=s,this.add=function({addAll:t}){return async function(e,n={}){const r=await(0,Le.Z)(t((0,Ys.f)(e),n));if(null==r)throw Error("Failed to add a file, if you see this please report a bug");return r}}({addAll:s}),this.cat=function({repo:t,preload:e}){return(0,Ee.a)((async function*(n,r={}){if(n=Re(n),!1!==r.preload){const t=n.split("/");e(Q.k0.parse(t[0]))}const s=await zi(n,t.blocks,r);if("directory"===s.type)throw new Error("this dag node is a directory");if(!s.content)throw new Error("this dag node has no content");yield*s.content(r)}))}({repo:e,preload:t}),this.get=function({repo:t,preload:e}){return(0,Ee.a)((async function*(n,r={}){if(null!=r.compressionLevel&&(r.compressionLevel<-1||r.compressionLevel>9))throw a(new Error("Compression level must be between -1 and 9"),"ERR_INVALID_PARAMS");if(!1!==r.preload){let t;try{t=Re(n).split("/")}catch(t){throw a(t,"ERR_INVALID_PATH")}e(Q.k0.parse(t[0]))}const s=Q.k0.asCID(n)||n,o=await zi(s,t.blocks,r);if("file"===o.type||"raw"===o.type){const t=[];return r.compress&&!0!==r.archive?t.push(o.content):t.push([{header:{name:o.path,mode:"file"===o.type&&o.unixfs.mode,mtime:"file"===o.type&&o.unixfs.mtime?new Date(1e3*o.unixfs.mtime.secs):void 0,size:o.size,type:"file"},body:o.content()}],(0,ji.P)()),r.compress&&t.push((async function*(t){const e=await(0,Vi.Z)(t);yield $i.ZP.gzip(e,{level:r.compressionLevel||6})})),void(yield*Gs(...t))}if("directory"!==o.type)throw a(new Error("Not a UnixFS node"),"ERR_NOT_UNIXFS");{const e=[Ui(s,t.blocks,r),async function*(t){for await(const e of t){const t={header:{name:e.path,size:e.size}};if("file"===e.type)t.header.type="file",t.header.mode=null!=e.unixfs.mode?e.unixfs.mode:void 0,t.header.mtime=e.unixfs.mtime?new Date(1e3*e.unixfs.mtime.secs):void 0,t.body=e.content();else if("raw"===e.type)t.header.type="file",t.body=e.content();else{if("directory"!==e.type)throw a(new Error("Not a UnixFS node"),"ERR_NOT_UNIXFS");t.header.type="directory",t.header.mode=null!=e.unixfs.mode?e.unixfs.mode:void 0,t.header.mtime=e.unixfs.mtime?new Date(1e3*e.unixfs.mtime.secs):void 0}yield t}},(0,ji.P)()];if(r.compress){if(!r.archive)throw a(new Error("file is not regular"),"ERR_INVALID_PATH");r.compress&&e.push((async function*(t){const e=await(0,Vi.Z)(t);yield $i.ZP.gzip(e,{level:r.compressionLevel||6})}))}yield*Gs(...e)}}))}({repo:e,preload:t}),this.ls=function({repo:t,preload:e}){return(0,Ee.a)((async function*(n,r={}){const s=Re(n),o=s.split("/");!1!==r.preload&&e(Q.k0.parse(o[0]));const i=Q.k0.asCID(s)||s,c=await zi(i,t.blocks,r);if("file"!==c.type){if("directory"!==c.type)throw a(new Error(`Unknown UnixFS type ${c.type}`),"ERR_UNKNOWN_UNIXFS_TYPE");for await(const t of c.content())yield Te(t)}else yield Te(c)}))}({repo:e,preload:t})}}const Fi="0.18.0";const Ki=(0,i.kg)("ipfs:components:id");function qi({peerId:t,network:e}){return(0,Ee.a)((async function(n={}){const r=e.try();if(!r){if(n.peerId)throw new O;if(null==t.publicKey)throw a(new Error("Public key missing"),"ERR_MISSING_PUBLIC_KEY");return{id:t,publicKey:(0,H.B)(t.publicKey,"base64pad"),addresses:[],agentVersion:`js-ipfs/${Fi}`,protocolVersion:"9000",protocols:[]}}const{libp2p:s}=r,o=n.peerId?n.peerId:t,i=await async function(t,e,n){let r=await e.peerStore.get(t);r||(r=await async function(t,e,n){if(null==e.dht)throw a(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");for await(const r of e.dht.findPeer(t,n))if("FINAL_PEER"===r.name)break;const r=await e.peerStore.get(t);if(!r)throw a(new Error("Could not find peer"),"ERR_NOT_FOUND");return r}(t,e,n));let s=t.publicKey?t.publicKey:await e.peerStore.keyBook.get(t);if(null==s)try{s=await e.getPublicKey(t,n)}catch(e){Ki.error("Could not load public key for",t.toString(),e)}return{...r,publicKey:s,metadata:r.metadata||new Map,addresses:r.addresses.map((t=>t.multiaddr))}}(o,s,n),c=(0,H.B)(i.metadata.get("AgentVersion")||new Uint8Array),l=(0,H.B)(i.metadata.get("ProtocolVersion")||new Uint8Array),u=i.id.toString();return{id:o,publicKey:i.publicKey?(0,H.B)(i.publicKey,"base64pad"):"",addresses:(i.addresses||[]).map((t=>{const e=t.toString();return e.endsWith(`/p2p/${u}`)?e:`${e}/p2p/${u}`})).sort().map((t=>(0,$.HM)(t))),agentVersion:c,protocolVersion:l,protocols:(i.protocols||[]).sort()}}))}var Gi=n(2302);const Wi={server:{description:"Recommended for nodes with public IPv4 address (servers, VPSes, etc.), disables host and content discovery and UPnP in local networks.",transform:t=>((0,Gi.Z)(t,"Discovery.MDNS.Enabled",!1),(0,Gi.Z)(t,"Discovery.webRTCStar.Enabled",!1),t.Swarm={...t.Swarm||{},DisableNatPortMap:!0},t)},"local-discovery":{description:"Sets default values to fields affected by `server` profile, enables discovery and UPnP in local networks.",transform:t=>((0,Gi.Z)(t,"Discovery.MDNS.Enabled",!0),(0,Gi.Z)(t,"Discovery.webRTCStar.Enabled",!0),(0,Gi.Z)(t,"Swarm",{...t.Swarm||{},DisableNatPortMap:!1}),t)},test:{description:"Reduces external interference, useful for running ipfs in test environments. Note that with these settings node won't be able to talk to the rest of the network without manual bootstrap.",transform:t=>{const e=(0,zs.Z)();return(0,Gi.Z)(t,"Addresses.API",e.Addresses.API?"/ip4/127.0.0.1/tcp/0":""),(0,Gi.Z)(t,"Addresses.Gateway",e.Addresses.Gateway?"/ip4/127.0.0.1/tcp/0":""),(0,Gi.Z)(t,"Addresses.Swarm",e.Addresses.Swarm.length?["/ip4/127.0.0.1/tcp/0"]:[]),(0,Gi.Z)(t,"Addresses.Delegates",[]),(0,Gi.Z)(t,"Bootstrap",[]),(0,Gi.Z)(t,"Discovery.MDNS.Enabled",!1),(0,Gi.Z)(t,"Discovery.webRTCStar.Enabled",!1),(0,Gi.Z)(t,"Swarm",{...t.Swarm||{},DisableNatPortMap:!0}),t}},"default-networking":{description:"Restores default network settings. Inverse profile of the `test` profile.",transform:t=>{const e=(0,zs.Z)();return(0,Gi.Z)(t,"Addresses.API",e.Addresses.API),(0,Gi.Z)(t,"Addresses.Gateway",e.Addresses.Gateway),(0,Gi.Z)(t,"Addresses.Swarm",e.Addresses.Swarm),(0,Gi.Z)(t,"Addresses.Delegates",e.Addresses.Delegates),(0,Gi.Z)(t,"Bootstrap",e.Bootstrap),(0,Gi.Z)(t,"Discovery.MDNS.Enabled",e.Discovery.MDNS.Enabled),(0,Gi.Z)(t,"Discovery.webRTCStar.Enabled",e.Discovery.webRTCStar.Enabled),(0,Gi.Z)(t,"Swarm",{...t.Swarm||{},DisableNatPortMap:!1}),t}},lowpower:{description:"Reduces daemon overhead on the system. May affect node functionality,performance of content discovery and data fetching may be degraded. Recommended for low power systems.",transform:t=>{const e=t.Swarm||{},n=e.ConnMgr||{};return n.LowWater=20,n.HighWater=40,e.ConnMgr=n,t.Swarm=e,t}},"default-power":{description:'Inverse of "lowpower" profile.',transform:t=>{const e=(0,zs.Z)();return t.Swarm=e.Swarm,t}}},Zi=(0,i.kg)("ipfs:core:config");async function Yi(t){return Object.keys(Wi).map((t=>({name:t,description:Wi[t].description})))}var Ji=n(7618),Qi=n(89003);function Xi(t){const e=(0,k.encode)({version:1,roots:t}),n=Qi.encode(e.length),r=new Uint8Array(n.length+e.length);return r.set(n,0),r.set(e,n.length),r}function ta(){}const ea={Null:t=>null===t,Int:t=>Number.isInteger(t),Float:t=>"number"==typeof t&&Number.isFinite(t),String:t=>"string"==typeof t,Bool:t=>"boolean"==typeof t,Bytes:t=>t instanceof Uint8Array,Link:t=>!ea.Null(t)&&"object"==typeof t&&t.asCID===t,List:t=>Array.isArray(t),Map:t=>!ea.Null(t)&&"object"==typeof t&&t.asCID!==t&&!ea.List(t)&&!ea.Bytes(t)},na={Int:ea.Int,"CarHeader > version":t=>na.Int(t),"CarHeader > roots (anon) > valueType (anon)":ea.Link,"CarHeader > roots (anon)":t=>ea.List(t)&&Array.prototype.every.call(t,na["CarHeader > roots (anon) > valueType (anon)"]),"CarHeader > roots":t=>na["CarHeader > roots (anon)"](t),CarHeader:t=>{const e=t&&Object.keys(t);return ea.Map(t)&&["version"].every((t=>e.includes(t)))&&Object.entries(t).every((([t,e])=>na["CarHeader > "+t]&&na["CarHeader > "+t](e)))}},ra=na.CarHeader,sa={SHA2_256:18,LENGTH:32,DAG_PB:112},oa=40;function ia(t,e){if(!t.length)throw new Error("Unexpected end of data");const n=Qi.decode(t);return e.seek(Qi.decode.bytes),n}async function aa(t,e){const n=ia(await t.upTo(8),t);if(0===n)throw new Error("Invalid CAR header (zero length)");const r=await t.exactly(n,!0),s=(0,k.decode)(r);if(!ra(s))throw new Error("Invalid CAR header format");if(1!==s.version&&2!==s.version||void 0!==e&&s.version!==e)throw new Error(`Invalid CAR version: ${s.version}${void 0!==e?` (expected ${e})`:""}`);const o=Array.isArray(s.roots);if(1===s.version&&!o||2===s.version&&o)throw new Error("Invalid CAR header format");if(1===s.version)return s;const i=function(t){const e=new DataView(t.buffer,t.byteOffset,t.byteLength);let n=0;return{version:2,characteristics:[e.getBigUint64(n,!0),e.getBigUint64(n+=8,!0)],dataOffset:Number(e.getBigUint64(n+=8,!0)),dataSize:Number(e.getBigUint64(n+=8,!0)),indexOffset:Number(e.getBigUint64(n+=8,!0))}}(await t.exactly(oa,!0));t.seek(i.dataOffset-t.pos);const a=await aa(t,1);return Object.assign(a,i)}async function ca(t){const e=await t.exactly(2,!1);if(e[0]===sa.SHA2_256&&e[1]===sa.LENGTH){const e=await t.exactly(34,!0),n=j.Jx(e);return Q.k0.create(0,sa.DAG_PB,n)}const n=ia(await t.upTo(8),t);if(1!==n)throw new Error(`Unexpected CID version (${n})`);const r=ia(await t.upTo(8),t),s=await t.exactly(function(t){Qi.decode(t);const e=Qi.decode.bytes,n=Qi.decode(t.subarray(Qi.decode.bytes));return e+Qi.decode.bytes+n}(await t.upTo(8)),!0),o=j.Jx(s);return Q.k0.create(n,r,o)}async function la(t){const e=t.pos;let n=ia(await t.upTo(8),t);if(0===n)throw new Error("Invalid CAR section (zero length)");n+=t.pos-e;return{cid:await ca(t),length:n,blockLength:n-Number(t.pos-e)}}async function ua(t){const{cid:e,blockLength:n}=await la(t);return{bytes:await t.exactly(n,!0),cid:e}}async function da(t){const e=t.pos,{cid:n,length:r,blockLength:s}=await la(t),o={cid:n,length:r,blockLength:s,offset:e,blockOffset:t.pos};return t.seek(o.blockLength),o}function ha(t){const e=(async()=>{const e=await aa(t);if(2===e.version){const n=t.pos-e.dataOffset;t=function(t,e){let n=0;return{async upTo(r){let s=await t.upTo(r);return s.length+n>e&&(s=s.subarray(0,e-n)),s},async exactly(r,s=!1){const o=await t.exactly(r,s);if(o.length+n>e)throw new Error("Unexpected end of data");return s&&(n+=r),o},seek(e){n+=e,t.seek(e)},get pos(){return t.pos}}}(t,e.dataSize-n)}return e})();return{header:()=>e,async*blocks(){for(await e;(await t.upTo(8)).length>0;)yield await ua(t)},async*blocksIndex(){for(await e;(await t.upTo(8)).length>0;)yield await da(t)}}}function pa(t){let e=0;return{upTo:async n=>t.subarray(e,e+Math.min(n,t.length-e)),async exactly(n,r=!1){if(n>t.length-e)throw new Error("Unexpected end of data");const s=t.subarray(e,e+n);return r&&(e+=n),s},seek(t){e+=t},get pos(){return e}}}function fa(t){const e=t[Symbol.asyncIterator]();return function(t){let e=0,n=0,r=0,s=new Uint8Array(0);const o=async e=>{n=s.length-r;const o=[s.subarray(r)];for(;n<e;){const e=await t();if(null==e)break;n<0?e.length>n&&o.push(e.subarray(-n)):o.push(e),n+=e.length}s=new Uint8Array(o.reduce(((t,e)=>t+e.length),0));let i=0;for(const t of o)s.set(t,i),i+=t.length;r=0};return{upTo:async t=>(s.length-r<t&&await o(t),s.subarray(r,r+Math.min(s.length-r,t))),async exactly(t,n=!1){if(s.length-r<t&&await o(t),s.length-r<t)throw new Error("Unexpected end of data");const i=s.subarray(r,r+t);return n&&(e+=t,r+=t),i},seek(t){e+=t,r+=t},get pos(){return e}}}((async function(){const t=await e.next();return t.done?null:t.value}))}class ya{constructor(t,e){this._encoder=e,this._mutex=e.setRoots(t),this._ended=!1}async put(t){if(!(t.bytes instanceof Uint8Array&&t.cid))throw new TypeError("Can only write {cid, bytes} objects");if(this._ended)throw new Error("Already closed");const e=Q.k0.asCID(t.cid);if(!e)throw new TypeError("Can only write {cid, bytes} objects");return this._mutex=this._mutex.then((()=>this._encoder.writeBlock({cid:e,bytes:t.bytes}))),this._mutex}async close(){if(this._ended)throw new Error("Already closed");return await this._mutex,this._ended=!0,this._encoder.close()}static create(t){t=function(t){if(void 0===t)return[];if(!Array.isArray(t)){const e=Q.k0.asCID(t);if(!e)throw new TypeError("roots must be a single CID or an array of CIDs");return[e]}const e=[];for(const n of t){const t=Q.k0.asCID(n);if(!t)throw new TypeError("roots must be a single CID or an array of CIDs");e.push(t)}return e}(t);const{encoder:e,iterator:n}=wa();return{writer:new ya(t,e),out:new ga(n)}}static createAppender(){const{encoder:t,iterator:e}=wa();t.setRoots=()=>Promise.resolve();return{writer:new ya([],t),out:new ga(e)}}static async updateRootsInBytes(t,e){const n=pa(t);await aa(n);const r=Xi(e);if(Number(n.pos)!==r.length)throw new Error(`updateRoots() can only overwrite a header of the same length (old header is ${n.pos} bytes, new header is ${r.length} bytes)`);return t.set(r,0),t}}class ga{constructor(t){this._iterator=t}[Symbol.asyncIterator](){if(this._iterating)throw new Error("Multiple iterator not supported");return this._iterating=!0,this._iterator}}function wa(){const t=function(){const t=[];let e=null,n=ta,r=!1,s=null,o=ta;const i=()=>(e||(e=new Promise((t=>{n=()=>{e=null,n=ta,t()}}))),e),a={write(e){t.push(e);const n=i();return o(),n},async end(){r=!0;const t=i();o(),await t}},c={async next(){const e=t.shift();return e?(0===t.length&&n(),{done:!1,value:e}):r?(n(),{done:!0,value:void 0}):(s||(s=new Promise((t=>{o=()=>(s=null,o=ta,t(c.next()))}))),s)}};return{writer:a,iterator:c}}(),{writer:e,iterator:n}=t,r=function(t){return{async setRoots(e){const n=Xi(e);await t.write(n)},async writeBlock(e){const{cid:n,bytes:r}=e;await t.write(new Uint8Array(Qi.encode(n.bytes.length+r.length))),await t.write(n.bytes),r.length&&await t.write(r)},async close(){await t.end()}}}(e);return{encoder:r,iterator:n}}var ma=n(22188),ba=n(41232);const Ea=(0,i.kg)("ipfs:components:dag:import"),_a=[bo.code,ma.code];function va({repo:t,preload:e,codecs:n}){return(0,Ee.a)((async function*(r,s={}){!1!==s.preload&&e(r);const o=Q.k0.asCID(r);if(!o)throw new Error(`Unexpected error converting CID type: ${r}`);Ea(`Exporting ${o} as car`);const{writer:i,out:a}=await ya.create([o]);let c=null;(async()=>{try{const e=function(t,e,n,r){return async s=>{const o=await r.getCodec(s.code);if(!o)throw new Error(`Can't decode links in block with codec 0x${s.code.toString(16)} to form complete DAG`);const i=await t.blocks.get(s,n);return Ea(`Adding block ${s} to car`),await e.put({cid:s,bytes:i}),_a.includes(s.code)?null:(0,Ji.OV)({bytes:i,cid:s,codec:o})}}(t,i,{signal:s.signal,timeout:s.timeout},n);await(0,ba._)({cid:o,load:e})}catch(t){c=t}finally{i.close()}})();for await(const t of a){if(c)break;yield t}if(c)throw c}))}var ka=n(91486);class Ra{constructor(t,e,n){this._version=t,this._roots=e,this._iterable=n,this._decoded=!1}get version(){return this._version}async getRoots(){return this._roots}}class Sa extends Ra{[Symbol.asyncIterator](){if(this._decoded)throw new Error("Cannot decode more than once");if(!this._iterable)throw new Error("Block iterable not found");return this._decoded=!0,this._iterable[Symbol.asyncIterator]()}static async fromBytes(t){const{version:e,roots:n,iterator:r}=await Aa(t);return new Sa(e,n,r)}static async fromIterable(t){const{version:e,roots:n,iterator:r}=await Ia(t);return new Sa(e,n,r)}}class Ta extends(null){[Symbol.asyncIterator](){if(this._decoded)throw new Error("Cannot decode more than once");if(!this._iterable)throw new Error("Block iterable not found");this._decoded=!0;const t=this._iterable[Symbol.asyncIterator]();return{async next(){const e=await t.next();return e.done?e:{done:!1,value:e.value.cid}}}}static async fromBytes(t){const{version:e,roots:n,iterator:r}=await Aa(t);return new Ta(e,n,r)}static async fromIterable(t){const{version:e,roots:n,iterator:r}=await Ia(t);return new Ta(e,n,r)}}async function Aa(t){if(!(t instanceof Uint8Array))throw new TypeError("fromBytes() requires a Uint8Array");return Da(pa(t))}async function Ia(t){if(!t||"function"!=typeof t[Symbol.asyncIterator])throw new TypeError("fromIterable() requires an async iterable");return Da(fa(t))}async function Da(t){const e=ha(t),{version:n,roots:r}=await e.header();return{version:n,roots:r,iterator:e.blocks()}}const Pa=(0,i.kg)("ipfs:components:dag:import");function Na({repo:t}){return(0,Ee.a)((async function*(e,n={}){const r=await t.gcLock.readLock();try{const r={signal:n.signal,timeout:n.timeout},s=function(t){const[e,n]=null!=t[Symbol.asyncIterator]?[t[Symbol.asyncIterator](),Symbol.asyncIterator]:[t[Symbol.iterator](),Symbol.iterator],r=[];return{peek:()=>e.next(),push:t=>{r.push(t)},next:()=>r.length>0?{done:!1,value:r.shift()}:e.next(),[n](){return this}}}(e),{value:o,done:i}=await s.peek();if(i)return;let a;o&&s.push(o),a=o instanceof Uint8Array?[s]:s;for await(const e of a){const s=await Oa(t,r,e);if(!1!==n.pinRoots)for(const e of s){let n="";try{await t.blocks.has(e)?(Pa(`Pinning root ${e}`),await t.pins.pinRecursively(e)):n="blockstore: block not found"}catch(t){n=t.message}yield{root:{cid:e,pinErrorMsg:n}}}}}finally{r()}}))}async function Oa(t,e,n){const r=await Sa.fromIterable(n),s=await r.getRoots();return await(0,Cn.Z)(t.blocks.putMany((0,$s.Z)(r,(({cid:t,bytes:e})=>(Pa(`Import block ${t}`),{key:t,value:e}))),{signal:e.signal})),s}class La{constructor({repo:t,codecs:e,hashers:n,preload:r}){this.export=va({repo:t,preload:r,codecs:e}),this.get=function({codecs:t,repo:e,preload:n}){return(0,Ee.a)((async function(r,s={}){if(!1!==s.preload&&n(r),s.path){const n=s.localResolve?await(0,ka.Z)(Ie(r,s.path,t,e,s)):await(0,Le.Z)(Ie(r,s.path,t,e,s));if(!n)throw a(new Error("Not found"),"ERR_NOT_FOUND");return n}const o=await t.getCodec(r.code),i=await e.blocks.get(r,s);return{value:o.decode(i),remainderPath:""}}))}({codecs:e,repo:t,preload:r}),this.import=Na({repo:t}),this.resolve=function({repo:t,codecs:e,preload:n}){return(0,Ee.a)((async function(r,s={}){const{cid:o}=(0,_e.B)(r);return!1!==s.preload&&n(o),Se(t,e,r,s)}))}({repo:t,codecs:e,preload:r}),this.put=function({repo:t,codecs:e,hashers:n,preload:r}){return(0,Ee.a)((async function(s,o={}){const i=o.pin?await t.gcLock.readLock():null;try{const i=await e.getCodec(o.storeCodec||"dag-cbor");if(!i)throw new Error(`Unknown storeCodec ${o.storeCodec}, please configure additional BlockCodecs for this IPFS instance`);if(o.inputCodec){if(!(s instanceof Uint8Array))throw new Error("Can only inputCodec on raw bytes that can be decoded");const t=await e.getCodec(o.inputCodec);if(!t)throw new Error(`Unknown inputCodec ${o.inputCodec}, please configure additional BlockCodecs for this IPFS instance`);s=t.decode(s)}const a=null!=o.version?o.version:1,c=await n.getHasher(o.hashAlg||"sha2-256");if(!c)throw new Error(`Unknown hash algorithm ${o.hashAlg}, please configure additional MultihashHashers for this IPFS instance`);const l=i.encode(s),u=await c.digest(l),d=Q.k0.create(a,i.code,u);return await t.blocks.put(d,l,{signal:o.signal}),o.pin&&await t.pins.pinRecursively(d),!1!==o.preload&&r(d),d}finally{i&&i()}}))}({repo:t,codecs:e,hashers:n,preload:r})}}var Ca=n(45182),Ma=n(7688),xa=n(6);const Ba=(0,i.kg)("ipfs:preload");const za=(0,i.kg)("ipfs:mfs-preload");var Ua=n(56027);let ja;function $a(t=!1){if(ja)return ja;const e=(0,Ua.Z)({singleProcess:t});return ja={readLock:t=>async(...n)=>{const r=await e.readLock();try{return await t.apply(null,n)}finally{r()}},writeLock:t=>async(...n)=>{const r=await e.writeLock();try{return await t.apply(null,n)}finally{r()}}},ja}const Va=(0,i.kg)("ipfs:mfs:utils:with-mfs-root");async function Ha(t,e){if(e&&e.signal&&e.signal.aborted)throw a(new Error("Request aborted"),"ERR_ABORTED",{name:"Aborted"});let n;await t.repo.datastore.open();try{const e=await t.repo.datastore.get(ke);n=Q.k0.decode(e)}catch(r){if("ERR_NOT_FOUND"!==r.code)throw r;Va("Creating new MFS root");const s=v.encode({Data:new _({type:"directory"}).marshal(),Links:[]}),o=await Qs.sha256.digest(s);if(n=Q.k0.createV0(o),await t.repo.blocks.put(n,s),e&&e.signal&&e.signal.aborted)throw a(new Error("Request aborted"),"ERR_ABORTED",{name:"Aborted"});await t.repo.datastore.put(ke,n.bytes)}return Va(`Loaded MFS root /ipfs/${n}`),n}function Fa(t=""){return(t.trim().match(/([^\\^/]|\\\/)+/g)||[]).filter(Boolean)}const Ka="ipfs",qa=async(t,e,n)=>{const r=await Ha(t,n);let s={entryType:"file"},o="";if(o=Q.k0.asCID(e)?`/ipfs/${e}`:e.toString(),o=o.trim(),o=o.replace(/(\/\/+)/g,"/"),o.endsWith("/")&&o.length>1&&(o=o.substring(0,o.length-1)),!o)throw a(new Error("paths must not be empty"),"ERR_NO_PATH");if("/"!==o.substring(0,1))throw a(new Error("paths must start with a leading slash"),"ERR_INVALID_PATH");"/"===o.substring(o.length-1)&&(o=o.substring(0,o.length-1));const i=Fa(o);if(i[0]===Ka){let t;t=2===i.length?`/${i.join("/")}`:`/${i.slice(0,i.length-1).join("/")}`,s={type:"ipfs",depth:i.length-2,entryType:"file",mfsPath:`/${i.join("/")}`,mfsDirectory:t,parts:i,path:`/${i.join("/")}`,name:i[i.length-1]}}else{const t=`/${Ka}/${r}${i.length?"/"+i.join("/"):""}`,e=`/${Ka}/${r}/${i.slice(0,i.length-1).join("/")}`;s={type:"mfs",depth:i.length,entryType:"file",mfsDirectory:e,mfsPath:t,parts:i,path:`/${i.join("/")}`,name:i[i.length-1]}}const c="mfs"===s.type?s.mfsPath:s.path;try{const e=await zi(c,t.repo.blocks,n);s.cid=e.cid,s.mfsPath=`/ipfs/${e.path}`,s.entryType=e.type,s.content=e.content,"file"!==s.entryType&&"directory"!==s.entryType||"file"!==e.type&&"directory"!==e.type||(s.unixfs=e.unixfs)}catch(t){if("ERR_NOT_FOUND"!==t.code)throw t}return s.exists=Boolean(s.cid),s},Ga=s.Z.bind({ignoreUndefined:!0}),Wa=(0,i.kg)("ipfs:mfs:stat"),Za={withLocal:!1};function Ya(t){return(0,Ee.a)((async function(e,n={}){n=Ga(Za,n),Wa(`Fetching stats for ${e}`);const{type:r,cid:s,mfsPath:o}=await qa(t,e,n),i="ipfs"===r&&s?s:o;let c;try{c=await zi(i,t.repo.blocks)}catch(t){if("ERR_NOT_FOUND"===t.code)throw a(new Error(`${e} does not exist`),"ERR_NOT_FOUND");throw t}if(!Ja[c.type])throw new Error(`Cannot stat codec ${c.cid.code}`);return Ja[c.type](c)}))}const Ja={raw:t=>({cid:t.cid,size:t.node.length,cumulativeSize:t.node.length,blocks:0,type:"file",local:void 0,sizeLocal:void 0,withLocality:!1}),file:t=>{const e={cid:t.cid,type:"file",size:t.unixfs.fileSize(),cumulativeSize:v.encode(t.node).length+(t.node.Links||[]).reduce(((t,e)=>t+(e.Tsize||0)),0),blocks:t.unixfs.blockSizes.length,local:void 0,sizeLocal:void 0,withLocality:!1,mode:t.unixfs.mode};return t.unixfs.mtime&&(e.mtime=t.unixfs.mtime),e},directory:t=>{const e={cid:t.cid,type:"directory",size:0,cumulativeSize:v.encode(t.node).length+(t.node.Links||[]).reduce(((t,e)=>t+(e.Tsize||0)),0),blocks:t.node.Links.length,local:void 0,sizeLocal:void 0,withLocality:!1,mode:t.unixfs.mode};return t.unixfs.mtime&&(e.mtime=t.unixfs.mtime),e},object:t=>({cid:t.cid,size:t.node.length,cumulativeSize:t.node.length,type:"file",blocks:0,local:void 0,sizeLocal:void 0,withLocality:!1}),identity:t=>({cid:t.cid,size:t.node.length,cumulativeSize:t.node.length,blocks:0,type:"file",local:void 0,sizeLocal:void 0,withLocality:!1})},Qa=(0,i.kg)("ipfs:mfs:utils:to-trail");async function Xa(t,e){Qa(`Creating trail for path ${e}`);const n=[];for await(const r of Bi(e,t.repo.blocks))n.push({name:r.name,cid:r.cid,size:r.size,type:r.type});return n}const tc=async(t,e,n)=>{n.codec||(n.codec=v),n.hasher||(n.hasher=Qs.sha256),void 0===n.cidVersion&&(n.cidVersion=1),n.codec===v&&n.hasher!==Qs.sha256&&(n.cidVersion=1);const r=await n.hasher.digest(t),s=Q.k0.create(n.cidVersion,n.codec.code,r);return n.onlyHash||await e.put(s,t,{signal:n.signal}),s},ec=Xs.Pv.code;async function nc(t){return(await Xs.Pv.encode(t)).subarray(0,8).reverse()}class rc{constructor(t,e){this.options=e||{},this.root=t.root,this.dir=t.dir,this.path=t.path,this.dirty=t.dirty,this.flat=t.flat,this.parent=t.parent,this.parentKey=t.parentKey,this.unixfs=t.unixfs,this.mode=t.mode,this.mtime=t.mtime,this.cid=void 0,this.size=void 0}async put(t,e){}get(t){return Promise.resolve(this)}async*eachChildSeries(){}async*flush(t){}}class sc extends rc{constructor(t,e){super(t,e),this._bucket=(0,Uo.$)({hashFn:nc,bits:8})}async put(t,e){await this._bucket.put(t,e)}get(t){return this._bucket.get(t)}childCount(){return this._bucket.leafCount()}directChildrenCount(){return this._bucket.childrenCount()}onlyChild(){return this._bucket.onlyChild()}async*eachChildSeries(){for await(const{key:t,value:e}of this._bucket.eachLeafSeries())yield{key:t,child:e}}async*flush(t){yield*oc(this._bucket,t,this,this.options)}}async function*oc(t,e,n,r){const s=t._children,o=[];let i=0;for(let t=0;t<s.length;t++){const n=s.get(t);if(!n)continue;const a=t.toString(16).toUpperCase().padStart(2,"0");if(n instanceof Uo.r){let t;for await(const s of await oc(n,e,null,r))t=s;if(!t)throw new Error("Could not flush sharded directory, no subshard found");o.push({Name:a,Tsize:t.size,Hash:t.cid}),i+=t.size}else if("function"==typeof n.value.flush){const t=n.value;let r;for await(const n of t.flush(e))r=n,yield r;const s=a+n.key;o.push({Name:s,Tsize:r.size,Hash:r.cid}),i+=r.size}else{const t=n.value;if(!t.cid)continue;const e=a+n.key,r=t.size;o.push({Name:e,Tsize:r,Hash:t.cid}),i+=r}}const a=Uint8Array.from(s.bitField().reverse()),c={Data:new _({type:"hamt-sharded-directory",data:a,fanout:t.tableSize(),hashType:ec,mtime:n&&n.mtime,mode:n&&n.mode}).marshal(),Links:o},l=(0,v.encode)((0,v.prepare)(c)),u=await tc(l,e,r),d=l.length+i;yield{cid:u,node:c,size:d}}const ic=(0,i.kg)("ipfs:mfs:core:utils:hamt-utils"),ac=async(t,e,n,r)=>{if(!r.parent.Data)throw new Error("Could not update HAMT directory because parent had no data");const s=Uint8Array.from(n._children.bitField().reverse()),o=_.unmarshal(r.parent.Data),i=new _({type:"hamt-sharded-directory",data:s,fanout:n.tableSize(),hashType:ec,mode:o.mode,mtime:o.mtime}),a=await t.hashers.getHasher(r.hashAlg),c={Data:i.marshal(),Links:e.sort(((t,e)=>(t.Name||"").localeCompare(e.Name||"")))},l=v.encode(c),u=await a.digest(l),d=Q.k0.create(r.cidVersion,v.code,u);return r.flush&&await t.repo.blocks.put(d,l),{node:c,cid:d,size:e.reduce(((t,e)=>t+(e.Tsize||0)),l.length)}},cc=async(t,e,n,r,s)=>{const o=new Uo.r({hash:n._options.hash,bits:n._options.bits},r,s);return r._putObjectAt(s,o),await uc(t,e,o,n),o},lc=async t=>{const e=(0,Uo.$)({hashFn:nc,bits:8});return await Promise.all(t.map((async t=>{const n=t.Name||"";if(2===n.length){const t=parseInt(n,16),r=new Uo.r({hash:e._options.hash,bits:e._options.bits},e,t);return e._putObjectAt(t,r),Promise.resolve()}return e.put(n.substring(2),{size:t.Tsize,cid:t.Hash})}))),e},uc=async(t,e,n,r)=>{await Promise.all(e.map((async e=>{const s=e.Name||"";if(2===s.length){ic("Populating sub bucket",s);const o=parseInt(s,16),i=await t.repo.blocks.get(e.Hash),a=v.decode(i),c=new Uo.r({hash:r._options.hash,bits:r._options.bits},n,o);return n._putObjectAt(o,c),await uc(t,a.Links,c,r),Promise.resolve()}return r.put(s.substring(2),{size:e.Tsize,cid:e.Hash})})))},dc=t=>t.toString(16).toUpperCase().padStart(2,"0").substring(0,2),hc=(0,i.kg)("ipfs:mfs:core:utils:add-link");async function pc(t,e){let n=e.parent;if(e.parentCid){const r=Q.k0.asCID(e.parentCid);if(null===r)throw a(new Error("Invalid CID passed to addLink"),"EINVALIDPARENTCID");if(r.code!==v.code)throw a(new Error("Unsupported codec. Only DAG-PB is supported"),"EINVALIDPARENTCID");hc(`Loading parent node ${r}`);const s=await t.repo.blocks.get(r);n=v.decode(s)}if(!n)throw a(new Error("No parent node or CID passed to addLink"),"EINVALIDPARENT");if(!e.cid)throw a(new Error("No child cid passed to addLink"),"EINVALIDCHILDCID");if(!e.name)throw a(new Error("No child name passed to addLink"),"EINVALIDCHILDNAME");if(!e.size&&0!==e.size)throw a(new Error("No child size passed to addLink"),"EINVALIDCHILDSIZE");if(!n.Data)throw a(new Error("Parent node with no data passed to addLink"),"ERR_INVALID_PARENT");const r=_.unmarshal(n.Data);return"hamt-sharded-directory"===r.type?(hc("Adding link to sharded directory"),gc(t,{...e,parent:n})):n.Links.length>=e.shardSplitThreshold?(hc("Converting directory to sharded directory"),fc(t,{...e,parent:n,mtime:r.mtime,mode:r.mode})):(hc(`Adding ${e.name} (${e.cid}) to regular directory`),yc(t,{...e,parent:n}))}const fc=async(t,e)=>{const n=await(async(t,e,n={})=>{const r=new sc({root:!0,dir:!0,parent:void 0,parentKey:void 0,path:"",dirty:!0,flat:!1,mtime:n.mtime,mode:n.mode},n);for(let t=0;t<e.length;t++)await r._bucket.put(e[t].name,{size:e[t].size,cid:e[t].cid});const s=await(0,Le.Z)(r.flush(t.repo.blocks));if(!s)throw new Error("Flushing shard yielded no result");return s})(t,e.parent.Links.map((t=>({name:t.Name||"",size:t.Tsize||0,cid:t.Hash}))).concat({name:e.name,size:e.size,cid:e.cid}),e);return hc(`Converted directory to sharded directory ${n.cid}`),n},yc=async(t,e)=>{const n=e.parent.Links.filter((t=>t.Name!==e.name));if(n.push({Name:e.name,Tsize:e.size,Hash:e.cid}),!e.parent.Data)throw a(new Error("Parent node with no data passed to addToDirectory"),"ERR_INVALID_PARENT");const r=_.unmarshal(e.parent.Data);let s;if(r.mtime){const t=Date.now(),e=Math.floor(t/1e3);r.mtime={secs:e,nsecs:1e3*(t-1e3*e)},s=r.marshal()}else s=e.parent.Data;e.parent=v.prepare({Data:s,Links:n});const o=await t.hashers.getHasher(e.hashAlg),i=v.encode(e.parent),c=await o.digest(i),l=Q.k0.create(e.cidVersion,v.code,c);return e.flush&&await t.repo.blocks.put(l,i),{node:e.parent,cid:l,size:i.length}},gc=async(t,e)=>{const{shard:n,path:r}=await wc(t,e),s=await(0,Le.Z)(n.flush(t.repo.blocks));if(!s)throw new Error("No result from flushing shard");const o=await t.repo.blocks.get(s.cid),i=v.decode(o),a=e.parent.Links.filter((t=>(t.Name||"").substring(0,2)!==r[0].prefix)),c=i.Links.find((t=>(t.Name||"").substring(0,2)===r[0].prefix));if(!c)throw new Error(`No link found with prefix ${r[0].prefix}`);return a.push(c),ac(t,a,r[0].bucket,e)},wc=async(t,e)=>{const n={name:e.name,cid:e.cid,size:e.size};if(!e.parent.Data)throw a(new Error("Parent node with no data passed to addFileToShardedDirectory"),"ERR_INVALID_PARENT");const r=await lc(e.parent.Links),s=_.unmarshal(e.parent.Data),o=new sc({root:!0,dir:!0,parent:void 0,parentKey:void 0,path:"",dirty:!0,flat:!1,mode:s.mode},e);o._bucket=r,s.mtime&&(o.mtime={secs:Math.round(Date.now()/1e3)});const i=await r._findNewBucketAndPos(n.name),c=mc(i);c[0].node=e.parent;let l=0;for(;l<c.length;){const e=c[l];l++;const s=e.node;if(!s)throw new Error("Segment had no node");const o=s.Links.find((t=>(t.Name||"").substring(0,2)===e.prefix));if(!o){hc(`Link ${e.prefix}${n.name} will be added`),l=c.length;break}if(o.Name===`${e.prefix}${n.name}`){hc(`Link ${e.prefix}${n.name} will be replaced`),l=c.length;break}if((o.Name||"").length>2){hc(`Link ${o.Name} ${o.Hash} will be replaced with a subshard`),l=c.length;break}hc(`Found subshard ${e.prefix}`);const i=await t.repo.blocks.get(o.Hash),a=v.decode(i);if(!c[l]){hc(`Loaded new subshard ${e.prefix}`),await cc(t,a.Links,r,e.bucket,parseInt(e.prefix,16));const s=await r._findNewBucketAndPos(n.name);c.push({bucket:s.bucket,prefix:dc(s.pos),node:a});break}const u=c[l];await uc(t,a.Links,u.bucket,r),u.node=a}return await o._bucket.put(n.name,{size:n.size,cid:n.cid}),{shard:o,path:c}},mc=t=>{const e=[{bucket:t.bucket,prefix:dc(t.pos)}];let n=t.bucket._parent,r=t.bucket._posAtParent;for(;n;)e.push({bucket:n,prefix:dc(r)}),r=n._posAtParent,n=n._parent;return e.reverse(),e},bc=(0,i.kg)("ipfs:mfs:utils:update-tree"),Ec={shardSplitThreshold:1e3};async function _c(t,e,n){n=Object.assign({},Ec,n),bc("Trail",e),e=e.slice().reverse();let r,s=0;for await(const o of t.repo.blocks.getMany(e.map((t=>t.cid)))){const i=(0,v.decode)(o),a=e[s].cid,c=e[s].name;if(s++,!r){r={cid:a,name:c,size:o.length};continue}const l=await pc(t,{parent:i,name:r.name,cid:r.cid,size:r.size,flush:n.flush,shardSplitThreshold:n.shardSplitThreshold,hashAlg:n.hashAlg,cidVersion:n.cidVersion});r={cid:l.cid,name:c,size:l.size}}const{cid:o}=r;return bc(`Final CID ${o}`),o}const vc=(0,i.kg)("ipfs:mfs:utils:update-mfs-root");async function kc(t,e,n){if(n&&n.signal&&n.signal.aborted)throw a(new Error("Request aborted"),"ERR_ABORTED",{name:"Aborted"});return vc(`New MFS root will be ${e}`),await t.repo.datastore.put(ke,e.bytes),e}const Rc=s.Z.bind({ignoreUndefined:!0}),Sc=(0,i.kg)("ipfs:mfs:mkdir"),Tc={parents:!1,hashAlg:"sha2-256",cidVersion:0,shardSplitThreshold:1e3,flush:!0};function Ac(t){return(0,Ee.a)((async function(e,n={}){const r=Rc(Tc,n);if(!e)throw new Error("no path given to Mkdir");if("/"===(e=e.trim())){if(r.parents)return;throw a(new Error("cannot create directory '/': Already exists"),"ERR_INVALID_PATH")}if("/"!==e.substring(0,1))throw a(new Error("paths must start with a leading slash"),"ERR_INVALID_PATH");Sc(`Creating ${e}`);const s=Fa(e);if("ipfs"===s[0])throw a(new Error("path cannot have the prefix 'ipfs'"),"ERR_INVALID_PATH");const o=await Ha(t,r);let i;const c=[],l=await async function(t,e,n){const r=new _({type:e,mode:n.mode,mtime:n.mtime}),s=await t.hashers.getHasher(n.hashAlg),o={Data:r.marshal(),Links:[]},i=v.encode(o),a=await s.digest(i),c=Q.k0.create(n.cidVersion,v.code,a);return n.flush&&await t.repo.blocks.put(c,i),{cid:c,node:o}}(t,"directory",r);for(let n=0;n<=s.length;n++){const u=s.slice(0,n),d=`/ipfs/${o}/${u.join("/")}`;try{if(i=await zi(d,t.repo.blocks),"file"!==i.type&&"directory"!==i.type)throw a(new Error(`${e} was not a UnixFS node`),"ERR_NOT_UNIXFS");if(n===s.length){if(r.parents)return;throw a(new Error("file already exists"),"ERR_ALREADY_EXISTS")}c.push({name:i.name,cid:i.cid})}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e;if(n<s.length&&!r.parents)throw a(new Error(`Intermediate directory path ${d} does not exist, use the -p flag to create it`),"ERR_NOT_FOUND");await Ic(t,u[u.length-1],l,c[c.length-1],c,r)}}const u=await _c(t,c,r);await kc(t,u,r)}))}const Ic=async(t,e,n,r,s,o)=>{Sc(`Adding empty dir called ${e} to ${r.cid}`);const i=await pc(t,{parent:r.node,parentCid:r.cid,size:0,cid:n.cid,name:e,hashAlg:o.hashAlg,cidVersion:o.cidVersion,flush:o.flush,shardSplitThreshold:o.shardSplitThreshold});s[s.length-1].cid=i.cid,s.push({name:e,cid:n.cid})},Dc=s.Z.bind({ignoreUndefined:!0}),Pc=(0,i.kg)("ipfs:mfs:cp"),Nc={parents:!1,flush:!0,hashAlg:"sha2-256",cidVersion:0,shardSplitThreshold:1e3};function Oc(t){return(0,Ee.a)((async function(e,n,r={}){const s=Dc(Nc,r);Array.isArray(e)||(e=[e]);const o=await Promise.all(e.map((e=>qa(t,e,s))));let i=await qa(t,n,s);if(!o.length||!i)throw a(new Error("Please supply at least one source"),"ERR_INVALID_PARAMS");const c=o.find((t=>!t.exists));if(c)throw a(new Error(`${c.path} does not exist`),"ERR_INVALID_PARAMS");const l=Lc(i);if(i.exists){if(Pc("Destination exists"),1===o.length&&!l)throw a(new Error("directory already has entry by that name"),"ERR_ALREADY_EXISTS")}else if(Pc("Destination does not exist"),o.length>1){if(!s.parents)throw a(new Error("destination did not exist, pass -p to create intermediate directories"),"ERR_INVALID_PARAMS");await Ac(t)(i.path,s),i=await qa(t,i.path,s)}else if(i.parts.length>1){const e=`/${i.parts.slice(0,-1).join("/")}`;try{await Ya(t)(e,s)}catch(n){if("ERR_NOT_FOUND"!==n.code)throw n;if(!s.parents)throw a(new Error("destination did not exist, pass -p to create intermediate directories"),"ERR_INVALID_PARAMS");await Ac(t)(e,s),i=await qa(t,i.path,s)}}const u=Lc(i)?i.mfsPath:i.mfsDirectory,d=await Xa(t,u);if(1===o.length){const e=o.pop();if(!e)throw a(new Error("could not find source"),"ERR_INVALID_PARAMS");const n=l?e.name:i.name;return Pc(`Only one source, copying to destination ${l?"directory":"file"} ${n}`),Cc(t,e,n,d,s)}return Pc("Multiple sources, wrapping in a directory"),Mc(t,o,i,d,s)}))}const Lc=t=>t.unixfs&&t.unixfs.type&&t.unixfs.type.includes("directory"),Cc=async(t,e,n,r,s)=>{let o=r.pop();if(!o)throw a(new Error("destination had no parent"),"ERR_INVALID_PARAMS");o=await xc(t,e,n,o,s),r.push(o);const i=await _c(t,r,s);await kc(t,i,s)},Mc=async(t,e,n,r,s)=>{for(let r=0;r<e.length;r++){const o=e[r];n=await xc(t,o,o.name,n,s)}r[r.length-1]=n;const o=await _c(t,r,s);await kc(t,o,s)},xc=async(t,e,n,r,s)=>{const o=await t.repo.blocks.get(e.cid),{node:i,cid:a,size:c}=await pc(t,{parentCid:r.cid,size:o.length,cid:e.cid,name:n,hashAlg:s.hashAlg,cidVersion:s.cidVersion,flush:s.flush,shardSplitThreshold:s.shardSplitThreshold});return r.node=i,r.cid=a,r.size=c,r},Bc=(0,i.kg)("ipfs:mfs:core:utils:remove-link");const zc=async(t,e)=>{e.parent.Links=e.parent.Links.filter((t=>t.Name!==e.name));const n=await v.encode(e.parent),r=await t.hashers.getHasher(e.hashAlg),s=await r.digest(n),o=Q.k0.create(e.cidVersion,v.code,s);return await t.repo.blocks.put(o,n),Bc(`Updated regular directory ${o}`),{node:e.parent,cid:o}},Uc=async(t,e)=>{const{rootBucket:n,path:r}=await(async(t,e,n)=>{const r=await lc(n.Links),s=await r._findNewBucketAndPos(e),o=[{bucket:s.bucket,prefix:dc(s.pos)}];let i=s.bucket;for(;i!==r;)o.push({bucket:i,prefix:dc(i._posAtParent)}),i=i._parent;o.reverse(),o[0].node=n;for(let n=0;n<o.length;n++){const s=o[n];if(!s.node)throw new Error("Could not generate HAMT path");const i=s.node.Links.filter((t=>(t.Name||"").substring(0,2)===s.prefix)).pop();if(!i){ic(`Link ${s.prefix}${e} will be added`);continue}if(i.Name===`${s.prefix}${e}`){ic(`Link ${s.prefix}${e} will be replaced`);continue}ic(`Found subshard ${s.prefix}`);const a=await t.repo.blocks.get(i.Hash),c=v.decode(a);if(!o[n+1]){ic(`Loaded new subshard ${s.prefix}`),await cc(t,c.Links,r,s.bucket,parseInt(s.prefix,16));const n=await r._findNewBucketAndPos(e);o.push({bucket:n.bucket,prefix:dc(n.pos),node:c});continue}const l=o[n+1];await uc(t,c.Links,l.bucket,r),l.node=c}return await r.put(e,!0),o.reverse(),{rootBucket:r,path:o}})(t,e.name,e.parent);await n.del(e.name);const{node:s}=await jc(t,r,e.name,e);return ac(t,s.Links,n,e)},jc=async(t,e,n,r)=>{const s=e.pop();if(!s)throw a(new Error("Could not find parent"),"EINVALIDPARENT");const{bucket:o,prefix:i,node:c}=s;if(!c)throw a(new Error("Could not find parent"),"EINVALIDPARENT");const l=c.Links.find((t=>(t.Name||"").substring(0,2)===i));if(!l)throw a(new Error(`No link found with prefix ${i} for file ${n}`),"ERR_NOT_FOUND");if(l.Name===`${i}${n}`){Bc(`Removing existing link ${l.Name}`);const e=c.Links.filter((t=>t.Name!==l.Name));return await o.del(n),ac(t,e,o,r)}Bc(`Descending into sub-shard ${l.Name} for ${i}${n}`);const u=await jc(t,e,n,r);let d=u.cid,h=u.size,p=i;if(1===u.node.Links.length){Bc(`Removing subshard for ${i}`);const t=u.node.Links[0];p=`${i}${(t.Name||"").substring(2)}`,d=t.Hash,h=t.Tsize||0}return Bc(`Updating shard ${i} with name ${p}`),$c(t,o,c,i,p,h,d,r)},$c=(t,e,n,r,s,o,i,a)=>{const c=n.Links.filter((t=>t.Name!==r));return c.push({Name:s,Tsize:o,Hash:i}),ac(t,c,e,a)},Vc=s.Z.bind({ignoreUndefined:!0}),Hc={recursive:!1,cidVersion:0,hashAlg:"sha2-256",flush:!0,shardSplitThreshold:1e3};function Fc(t){return(0,Ee.a)((async function(e,n={}){const r=Vc(Hc,n);Array.isArray(e)||(e=[e]);const s=await Promise.all(e.map((e=>qa(t,e,r))));if(!s.length)throw a(new Error("Please supply at least one path to remove"),"ERR_INVALID_PARAMS");s.forEach((t=>{if("/"===t.path)throw a(new Error("Cannot delete root"),"ERR_INVALID_PARAMS")}));for(const e of s)await Kc(t,e.path,r)}))}const Kc=async(t,e,n)=>{const r=await qa(t,e,n),s=await Xa(t,r.mfsPath),o=s[s.length-1];s.pop();const i=s[s.length-1];if(!i)throw a(new Error(`${e} does not exist`),"ERR_NOT_FOUND");if("directory"===o.type&&!n.recursive)throw a(new Error(`${e} is a directory, use -r to remove directories`),"ERR_WAS_DIR");const{cid:c}=await async function(t,e){let n=e.parent;if(e.parentCid){const r=Q.k0.asCID(e.parentCid);if(null===r)throw a(new Error("Invalid CID passed to removeLink"),"EINVALIDPARENTCID");Bc(`Loading parent node ${r}`);const s=await t.repo.blocks.get(r);n=v.decode(s)}if(!n)throw a(new Error("No parent node or CID passed to removeLink"),"EINVALIDPARENT");if(!e.name)throw a(new Error("No child name passed to removeLink"),"EINVALIDCHILDNAME");if(!n.Data)throw a(new Error("Parent node had no data"),"ERR_INVALID_NODE");return"hamt-sharded-directory"===_.unmarshal(n.Data).type?(Bc(`Removing ${e.name} from sharded directory`),Uc(t,{...e,parent:n})):(Bc(`Removing link ${e.name} regular directory`),zc(t,{...e,parent:n}))}(t,{parentCid:i.cid,name:o.name,hashAlg:n.hashAlg,cidVersion:n.cidVersion,flush:n.flush,shardSplitThreshold:n.shardSplitThreshold});i.cid=c;const l=await _c(t,s,n);await kc(t,l,n)},qc=s.Z.bind({ignoreUndefined:!0}),Gc=(0,i.kg)("ipfs:mfs:touch"),Wc={flush:!0,shardSplitThreshold:1e3,hashAlg:"sha2-256",cidVersion:0,recursive:!1};function Zc(t,e,n){e||(e=0);const r=t.match(/^(u?g?o?a?)(-?\+?=?)?(r?w?x?X?s?t?)$/);if(!r)throw new Error(`Invalid file mode: ${t}`);let[,s,o,i]=r;"a"!==s&&s||(s="ugo");let a=function(t,e,n){let r=0;return(t.includes("x")||t.includes("X")&&(n||1&e||8&e||64&e))&&(r+=1),t.includes("w")&&(r+=2),t.includes("r")&&(r+=4),r}(i,e,n);return a=function(t,e){let n=0;return t.includes("u")&&(n+=e<<6),t.includes("g")&&(n+=e<<3),t.includes("o")&&(n+=e),n}(s,a),a=function(t,e,n){return e.includes("t")&&(n+=parseInt("1000",8)),e.includes("s")&&(t.includes("u")&&(n+=parseInt("4000",8)),t.includes("g")&&(n+=parseInt("2000",8))),n}(s,i,a),"="===o?(s.includes("u")&&(e&=parseInt("7077",8),e|=a),s.includes("g")&&(e&=parseInt("7707",8),e|=a),s.includes("o")&&(e&=parseInt("7770",8),e|=a),e):"+"===o?a|e:"-"===o?a^e:e}function Yc(t,e){if(t instanceof String||"string"==typeof t){const n=`${t}`;t=n.match(/^\d+$/g)?parseInt(n,8):0+n.split(",").reduce(((t,n)=>Zc(n,t,e.isDirectory())),e.mode||0)}return t}const Jc=s.Z.bind({ignoreUndefined:!0}),Qc={};const Xc=s.Z.bind({ignoreUndefined:!0}),tl={parents:!1,flush:!0,cidVersion:0,hashAlg:"sha2-256",shardSplitThreshold:1e3};const el=s.Z.bind({ignoreUndefined:!0}),nl=(0,i.kg)("ipfs:mfs:touch"),rl={flush:!0,shardSplitThreshold:1e3,cidVersion:0,hashAlg:"sha2-256"};const sl=s.Z.bind({ignoreUndefined:!0}),ol={offset:0,length:1/0};var il=n(53597);const al=(0,i.kg)("ipfs:mfs:utils:to-async-iterator");const cl=s.Z.bind({ignoreUndefined:!0}),ll=(0,i.kg)("ipfs:mfs:write"),ul={offset:0,length:1/0,create:!1,truncate:!1,rawLeaves:!1,reduceSingleLeafToSelf:!1,cidVersion:0,hashAlg:"sha2-256",parents:!1,progress:(t,e)=>{},strategy:"trickle",flush:!0,leafType:"raw",shardSplitThreshold:1e3};const dl=async(t,e,n,r,s)=>{const o=await hl(t,n,r,s);await $a().writeLock((async()=>{const n=Fa(e),r=n.pop();if(null==r)throw a(new Error("source does not exist"),"ERR_NO_EXIST");let i=!1;try{await Ya(t)(`/${n.join("/")}`,s),i=!0}catch(t){if("ERR_NOT_FOUND"!==t.code)throw t}i||await Ac(t)(`/${n.join("/")}`,s);const c=await qa(t,e,s),l=await Xa(t,c.mfsDirectory),u=l[l.length-1];if(!u)throw a(new Error("directory does not exist"),"ERR_NO_EXIST");if(!u.type||!u.type.includes("directory"))throw a(new Error(`cannot write to ${u.name}: Not a directory`),"ERR_NOT_A_DIRECTORY");const d=await t.repo.blocks.get(u.cid),h=(0,v.decode)(d),p=await pc(t,{parent:h,name:r,cid:o.cid,size:o.size,flush:s.flush,shardSplitThreshold:s.shardSplitThreshold,hashAlg:s.hashAlg,cidVersion:s.cidVersion});u.cid=p.cid;const f=await _c(t,l,s);await kc(t,f,s)}))()},hl=async(t,e,n,r)=>{n.exists?ll(`Overwriting file ${n.cid} offset ${r.offset} length ${r.length}`):ll(`Writing file offset ${r.offset} length ${r.length}`);const s=[];if(r.offset>0)if(n.unixfs){if(ll(`Writing first ${r.offset} bytes of original file`),s.push((()=>n.content({offset:0,length:r.offset}))),n.unixfs.fileSize()<r.offset){const t=r.offset-n.unixfs.fileSize();ll(`Writing zeros for extra ${t} bytes`),s.push(fl(t))}}else ll(`Writing zeros for first ${r.offset} bytes`),s.push(fl(r.offset));s.push(pl(e,r.length));const o=gl(yl(s),(t=>{if(n.unixfs&&!r.truncate){const e=n.unixfs.fileSize();if(e>t)return ll(`Writing last ${e-t} of ${e} bytes from original file starting at offset ${t}`),n.content({offset:t});ll("Not writing last bytes from original file")}return{[Symbol.asyncIterator]:async function*(){}}}));let i,c;void 0!==r.mode&&null!==r.mode?i=b(r.mode):n&&n.unixfs&&(i=n.unixfs.mode),null!=r.mtime?c=E(r.mtime):n&&n.unixfs&&(c=n.unixfs.mtime);const l=await t.hashers.getHasher(r.hashAlg),u=await(0,Le.Z)(Go([{content:o,mode:i,mtime:c}],t.repo.blocks,{progress:r.progress,hasher:l,cidVersion:r.cidVersion,strategy:r.strategy,rawLeaves:r.rawLeaves,reduceSingleLeafToSelf:r.reduceSingleLeafToSelf,leafType:r.leafType}));if(!u)throw a(new Error(`cannot write to ${parent.name}`),"ERR_COULD_NOT_WRITE");return ll(`Wrote ${u.cid}`),{cid:u.cid,size:u.size}},pl=(t,e)=>async function*(){let n=0;for await(const r of t){if(n+=r.length,n>e)return void(yield r.subarray(0,e-n));yield r}},fl=(t,e=262144)=>{const n=new Uint8Array(e);return pl(async function*(){for(;;)yield n}(),t)},yl=async function*(t){for(let e=0;e<t.length;e++)yield*t[e]()},gl=async function*(t,e){let n=0;for await(const e of t)n+=e.length,yield e;for await(const t of e(n))n+=t.length,yield t},wl=t=>{const e={cid:t.cid,name:t.name,type:"directory"===t.type?"directory":"file",size:t.size};return"file"!==t.type&&"directory"!==t.type||(e.mode=t.unixfs.mode,e.mtime=t.unixfs.mtime),e};const ml={stat:Ya},bl={chmod:function(t){return(0,Ee.a)((async function(e,n,r={}){const s=qc(Wc,r);Gc(`Fetching stats for ${e}`);const{cid:o,mfsDirectory:i,name:c}=await qa(t,e,s);if(o.code!==v.code)throw a(new Error(`${e} was not a UnixFS node`),"ERR_NOT_UNIXFS");if(s.recursive){const r=await Gs((async function*(){for await(const r of Ui(o,t.repo.blocks)){if("file"!==r.type&&"directory"!==r.type)throw a(new Error(`${e} was not a UnixFS node`),"ERR_NOT_UNIXFS");r.unixfs.mode=Yc(n,r.unixfs);const t=v.prepare({Data:r.unixfs.marshal(),Links:r.node.Links});yield{path:r.path,content:t}}}),(e=>Go(e,t.repo.blocks,{...s,pin:!1,dagBuilder:async function*(t,e,n){for await(const r of t)yield async function(){const t=r.content,s=v.encode(t),o=await tc(s,e,n);if(!t.Data)throw a(new Error(`${o} had no data`),"ERR_INVALID_NODE");const i=_.unmarshal(t.Data);return{cid:o,size:s.length,path:r.path,unixfs:i}}}})),(t=>(0,Le.Z)(t)));if(!r)throw a(new Error(`Could not chmod ${e}`),"ERR_COULD_NOT_CHMOD");return await Fc(t)(e,s),void await Oc(t)(`/ipfs/${r.cid}`,e,s)}const l=await t.repo.blocks.get(o),u=v.decode(l);if(!u.Data)throw a(new Error(`${o} had no data`),"ERR_INVALID_NODE");const d=_.unmarshal(u.Data);d.mode=Yc(n,d);const h=v.encode({Data:d.marshal(),Links:u.Links}),p=s.hashAlg||Wc.hashAlg,f=await t.hashers.getHasher(p),y=await f.digest(h),g=Q.k0.create(s.cidVersion,v.code,y);s.flush&&await t.repo.blocks.put(g,h);const w=await Xa(t,i),m=w[w.length-1],b=Q.k0.decode(m.cid.bytes),E=await t.repo.blocks.get(b),k=v.decode(E),R=await pc(t,{parent:k,name:c,cid:g,size:h.length,flush:s.flush,hashAlg:p,cidVersion:o.version,shardSplitThreshold:1/0});m.cid=R.cid;const S=await _c(t,w,s);await kc(t,S,s)}))},cp:Oc,flush:function(t){return(0,Ee.a)((async function(e,n={}){n=Jc(Qc,n);const{cid:r}=await Ya(t)(e,n);return r}))},mkdir:Ac,mv:function(t){return(0,Ee.a)((async function(e,n,r={}){const s=Xc(tl,r);await Oc(t)(e,n,s),await Fc(t)(e,{...s,recursive:!0})}))},rm:Fc,touch:function(t){return(0,Ee.a)((async function(e,n={}){const r=el(rl,n);r.mtime=r.mtime||new Date,nl(`Touching ${e} mtime: ${r.mtime}`);const{cid:s,mfsDirectory:o,name:i,exists:c}=await qa(t,e,r),l=n.hashAlg||rl.hashAlg,u=await t.hashers.getHasher(l);let d,h,p=r.cidVersion;if(c){if(s.code!==v.code)throw a(new Error(`${e} was not a UnixFS node`),"ERR_NOT_UNIXFS");p=s.version;const n=await t.repo.blocks.get(s),o=v.decode(n);if(!o.Data)throw a(new Error(`${e} had no data`),"ERR_INVALID_NODE");const i=_.unmarshal(o.Data);i.mtime=r.mtime,d=v.encode({Data:i.marshal(),Links:o.Links});const c=await u.digest(d);h=Q.k0.create(r.cidVersion,v.code,c),r.flush&&await t.repo.blocks.put(h,d)}else{const e=new _({type:"file",mtime:r.mtime});d=v.encode({Data:e.marshal(),Links:[]});const n=await u.digest(d);h=Q.k0.create(r.cidVersion,v.code,n),r.flush&&await t.repo.blocks.put(h,d)}const f=await Xa(t,o),y=f[f.length-1],g=y.cid,w=await t.repo.blocks.get(g),m=v.decode(w),b=await pc(t,{parent:m,name:i,cid:h,size:d.length,flush:r.flush,shardSplitThreshold:r.shardSplitThreshold,hashAlg:r.hashAlg,cidVersion:p});y.cid=b.cid;const E=await _c(t,f,r);await kc(t,E,r)}))}},El={write:function(t){return(0,Ee.a)((async function(e,n,r={}){const s=cl(ul,r);let o,i,c;if(ll("Reading source, destination and parent"),await $a().readLock((async()=>{o=await function(t){if(!t)throw a(new Error("paths must start with a leading slash"),"ERR_INVALID_PATH");if(("string"==typeof t||t instanceof String)&&(al("Content was a string"),t=(0,x.m)(t.toString())),t.length)return al("Content was array-like"),{[Symbol.asyncIterator]:function*(){yield t}};if(t[Symbol.asyncIterator])return al("Content was an async iterator"),t;if(t[Symbol.iterator])return al("Content was an iterator"),t;if(global.Blob&&t instanceof global.Blob)return al("Content was an HTML5 Blob"),(0,il.Z)(t.stream());throw a(new Error(`Don't know how to convert ${t} into an async iterator`),"ERR_INVALID_PARAMS")}(n),i=await qa(t,e,s),c=await qa(t,i.mfsDirectory,s)}))(),ll("Read source, destination and parent"),!s.parents&&!c.exists)throw a(new Error("directory does not exist"),"ERR_NO_EXIST");if(null==o)throw a(new Error("could not create source"),"ERR_NO_SOURCE");if(null==i)throw a(new Error("could not create destination"),"ERR_NO_DESTINATION");if(!s.create&&!i.exists)throw a(new Error("file does not exist"),"ERR_NO_EXIST");if("file"!==i.entryType)throw a(new Error("not a file"),"ERR_NOT_A_FILE");return dl(t,e,o,i,s)}))},read:function(t){return(0,Ee.a)((function(e,n={}){return n=sl(ol,n),{[Symbol.asyncIterator]:async function*(){const r=await qa(t,e,n),s=await zi(r.mfsPath,t.repo.blocks);if("file"!==s.type&&"raw"!==s.type)throw a(new Error(`${e} was not a file or raw bytes`),"ERR_NOT_FILE");if(!s.content)throw a(new Error(`Could not load content stream from ${e}`),"ERR_NO_CONTENT");for await(const t of s.content({offset:n.offset,length:n.length}))yield t}}}))},ls:function(t){return(0,Ee.a)((async function*(e,n={}){const r=await qa(t,e,n),s=await zi(r.mfsPath,t.repo.blocks);"directory"!==s.type?yield wl(s):yield*(0,$s.Z)(s.content(n),wl)}))}},_l=({options:t,mfs:e,operations:n,lock:r})=>{Object.keys(n).forEach((s=>{e[s]=r(n[s](t))}))},vl={repoOwner:!0,repo:null};function kl({repo:t,preload:e,hashers:n,options:r}){const s=function(t){const{repoOwner:e}=Object.assign({},vl||{},t),n=$a(e),r={};return _l({options:t,mfs:r,operations:ml,lock:t=>n.readLock(t)}),_l({options:t,mfs:r,operations:bl,lock:t=>n.writeLock(t)}),Object.keys(El).forEach((e=>{r[e]=El[e](t)})),r}({repo:t,repoOwner:!1!==r.repoOwner,hashers:n}),o=t=>(...n)=>{const r=n.filter((t=>pe(t,le)||he(t)));if(r.length){const t=n[n.length-1];t&&!1!==t.preload&&r.forEach((t=>e(t)))}return t(...n)};return{...s,chmod:s.chmod,cp:o(s.cp),mkdir:s.mkdir,stat:o(s.stat),rm:s.rm,read:o(s.read),touch:s.touch,write:s.write,mv:o(s.mv),flush:s.flush,ls:o((async function*(...t){for await(const e of s.ls(...t))yield{...e,size:e.size||0}}))}}const Rl="Ed25519";class Sl{constructor({keychain:t}){this.gen=function({keychain:t}){return(0,Ee.a)(((e,n={type:Rl,size:2048})=>t.createKey(e,n.type||Rl,n.size||2048)))}({keychain:t}),this.list=function({keychain:t}){return(0,Ee.a)((()=>t.listKeys()))}({keychain:t}),this.rm=function({keychain:t}){return(0,Ee.a)((e=>t.removeKey(e)))}({keychain:t}),this.rename=function({keychain:t}){return(0,Ee.a)((async(e,n)=>{const r=await t.renameKey(e,n);return{was:e,now:r.name,id:r.id,overwrite:!1}}))}({keychain:t}),this.export=function({keychain:t}){return(0,Ee.a)(((e,n)=>t.exportKey(e,n)))}({keychain:t}),this.import=function({keychain:t}){return(0,Ee.a)(((e,n,r)=>t.importKey(e,n,r)))}({keychain:t}),this.info=function({keychain:t}){return(0,Ee.a)((e=>t.findKeyByName(e)))}({keychain:t})}}function Tl({repo:t,preload:e}){return(0,Ee.a)((async function(n,r={}){!1!==r.preload&&e(n);const s=await t.blocks.get(n,r);return v.decode(s)}))}function Al(t,e=[]){for(const n in t){const r=t[n];if("/"===n&&1===Object.keys(t).length)try{e.push({Name:"",Tsize:0,Hash:Q.k0.parse(r)});continue}catch(t){}const s=Q.k0.asCID(r);s?e.push({Name:"",Tsize:0,Hash:s}):(Array.isArray(r)&&Al(r,e),r&&"object"==typeof r&&Al(r,e))}return e}function Il({repo:t,codecs:e}){return(0,Ee.a)((async function(n,r={}){const s=await e.getCodec(n.code),o=await t.blocks.get(n,r),i=s.decode(o);switch(n.code){case bo.code:return[];case v.code:return i.Links;case k.code:case R.code:return Al(i);default:throw new Error(`Cannot resolve links from codec ${n.code}`)}}))}function Dl({repo:t,preload:e}){return(0,Ee.a)((async function(n,r={}){const s=await t.gcLock.readLock();try{const s=v.encode(n),o=await Qs.sha256.digest(s),i=Q.k0.createV1(v.code,o);return await t.blocks.put(i,s,{signal:r.signal}),!1!==r.preload&&e(i),r.pin&&await t.pins.pinRecursively(i,{signal:r.signal}),i}finally{s()}}))}class Pl{constructor({repo:t,preload:e}){this.addLink=function({repo:t,preload:e}){const n=Tl({repo:t,preload:e}),r=Dl({repo:t,preload:e});return(0,Ee.a)((async function(t,e,s={}){const o=await n(t,s);return r({...o,Links:o.Links.concat([e])},s)}))}({repo:t,preload:e}),this.appendData=function({repo:t,preload:e}){const n=Tl({repo:t,preload:e}),r=Dl({repo:t,preload:e});return(0,Ee.a)((async function(t,e,s={}){const o=await n(t,s),i=(0,tt.z)([o.Data||[],e]);return r({...o,Data:i},s)}))}({repo:t,preload:e}),this.rmLink=function({repo:t,preload:e}){const n=Tl({repo:t,preload:e}),r=Dl({repo:t,preload:e});return(0,Ee.a)((async function(t,e,s={}){const o=await n(t,s),i=("string"==typeof e?e:e.Name)||"";return o.Links=o.Links.filter((t=>t.Name!==i)),r(o,s)}))}({repo:t,preload:e}),this.setData=function({repo:t,preload:e}){const n=Tl({repo:t,preload:e}),r=Dl({repo:t,preload:e});return(0,Ee.a)((async function(t,e,s={}){const o=await n(t,s);return r({...o,Data:e},s)}))}({repo:t,preload:e})}}class Nl{constructor({repo:t,codecs:e,preload:n}){this.data=function({repo:t,preload:e}){const n=Tl({repo:t,preload:e});return(0,Ee.a)((async function(t,e={}){return(await n(t,e)).Data||new Uint8Array(0)}))}({repo:t,preload:n}),this.get=Tl({repo:t,preload:n}),this.links=Il({repo:t,codecs:e}),this.new=function({repo:t,preload:e}){return(0,Ee.a)((async function(n={}){let r;if(n.template){if("unixfs-dir"!==n.template)throw new Error("unknown template");r=new _({type:"directory"}).marshal()}const s=v.encode({Data:r,Links:[]}),o=await Qs.sha256.digest(s),i=Q.k0.createV0(o);return await t.blocks.put(i,s,{signal:n.signal}),!1!==n.preload&&e(i),i}))}({repo:t,preload:n}),this.put=Dl({repo:t,preload:n}),this.stat=function({repo:t,preload:e}){const n=Tl({repo:t,preload:e});return(0,Ee.a)((async function(t,e={}){const r=await n(t,e),s=v.encode(r).length,o=r.Links.reduce(((t,e)=>t+(e.Tsize||0)),0);return{Hash:t,NumLinks:r.Links.length,BlockSize:s,LinksSize:s-(r.Data||[]).length,DataSize:(r.Data||[]).length,CumulativeSize:s+o}}))}({repo:t,preload:n}),this.patch=new Pl({repo:t,preload:n})}}const Ol=(0,i.kg)("ipfs:repo:gc");function Ll({repo:t}){return(0,Ee.a)((async function(e={}){const n=await t.stat();return{numObjects:BigInt(n.numObjects.toString()),repoSize:BigInt(n.repoSize.toString()),repoPath:n.repoPath,version:`${n.version}`,storageMax:BigInt(n.storageMax.toString())}}))}var Cl=n(45895);class Ml{constructor({repo:t,hashers:e}){this.gc=function({repo:t,hashers:e}){return(0,Ee.a)((async function*(n={}){const r=Date.now();let s;try{s=await Ha({repo:t,hashers:e},n),await t.pins.pinRecursively(s),yield*t.gc()}finally{s&&await t.pins.unpin(s)}Ol(`Complete (${Date.now()-r}ms)`)}))}({repo:t,hashers:e}),this.stat=Ll({repo:t}),this.version=function({repo:t}){return(0,Ee.a)((async function(e={}){try{await t._checkInitialized(e)}catch(t){if([/Key not found in database \[\/version\]/,/ENOENT/,/repo is not initialized yet/].some((e=>e.test(t.message))))return Cl._;throw t}return t.version.get()}))}({repo:t}),this.setApiAddr=e=>t.apiAddr.set(e)}}function xl(t,e){return{totalIn:BigInt(0),totalOut:BigInt(0),rateIn:0,rateOut:0}}class Bl{constructor({repo:t,network:e}){this.repo=Ll({repo:t}),this.bw=function({network:t}){return(0,Ee.a)((async function*(e={}){const{libp2p:n}=await t.use(e);if(!e.poll)return void(yield xl());const r=e.interval||1e3;let s,o=-1;try{if(o="string"==typeof r?(0,Xn.Z)(r)||-1:r,!o||o<0)throw new Error("invalid duration")}catch(t){throw a(t,"ERR_INVALID_POLL_INTERVAL")}try{for(;;)yield xl(),await new Promise((t=>{s=setTimeout(t,o)}))}finally{clearTimeout(s)}}))}({network:e}),this.bitswap=br({network:e})}}var zl=n(83523),Ul=n(37608),jl=n(38532),$l=n(35505),Vl=n(51392),Hl=n(52890),Fl=n(55101),Kl=n(67137),ql=n(63181),Gl=n(97295);const Wl=(0,i.kg)("ipfs-http-client:lib:error-handler"),Zl=s.Z.bind({ignoreUndefined:!0}),Yl=o.isBrowser||o.isWebWorker?location.protocol:"http",Jl=o.isBrowser||o.isWebWorker?location.hostname:"localhost",Ql=o.isBrowser||o.isWebWorker?location.port:"5001",Xl=async t=>{let e;try{if((t.headers.get("Content-Type")||"").startsWith("application/json")){const n=await t.json();Wl(n),e=n.Message||n.message}else e=await t.text()}catch(t){Wl("Failed to parse error response",t),e=t.message}let n=new Kl.HTTPError(t);throw e&&(e.includes("deadline has elapsed")&&(n=new Kl.TimeoutError),e&&e.includes("context deadline exceeded")&&(n=new Kl.TimeoutError)),e&&e.includes("request timed out")&&(n=new Kl.TimeoutError),e&&(n.message=e),n},tu=/[A-Z\u00C0-\u00D6\u00D8-\u00DE]/g,eu=t=>t.replace(tu,(function(t){return"-"+t.toLowerCase()}));class nu extends Kl{constructor(t={}){const e=((t={})=>{let e,n,r={};if("string"==typeof t||(0,$.h2)(t))e=new URL((0,ql.d)(t));else if(t instanceof URL)e=t;else if("string"==typeof t.url||(0,$.h2)(t.url))e=new URL((0,ql.d)(t.url)),r=t;else if(t.url instanceof URL)e=t.url,r=t;else{r=t||{};const n=(r.protocol||Yl).replace(":",""),s=(r.host||Jl).split(":")[0],o=r.port||Ql;e=new URL(`${n}://${s}:${o}`)}if(r.apiPath?e.pathname=r.apiPath:"/"!==e.pathname&&void 0!==e.pathname||(e.pathname="api/v0"),o.isNode){const t=(0,Gl.Z)(e);n=r.agent||new t({keepAlive:!0,maxSockets:6})}return{...r,host:e.host,protocol:e.protocol.replace(":",""),port:Number(e.port),apiPath:e.pathname,url:e,agent:n}})(t);var n;super({timeout:(n=e.timeout||0,("string"==typeof n?(0,Xn.Z)(n):n)||void 0),headers:e.headers,base:`${e.url}`,handleError:Xl,transformSearchParams:t=>{const e=new URLSearchParams;for(const[n,r]of t)"undefined"!==r&&"null"!==r&&"signal"!==n&&e.append(eu(n),r),"timeout"!==n||isNaN(r)||e.append(eu(n),r);return e},agent:e.agent}),delete this.get,delete this.put,delete this.delete,delete this.options;const r=this.fetch;this.fetch=(t,n={})=>("string"!=typeof t||t.startsWith("/")||(t=`${e.url}/${t}`),r.call(this,t,Zl(n,{method:"POST"})))}}Kl.HTTPError;const ru=t=>e=>t(new nu(e),e);function su(t){if(null!=t)return"string"==typeof t?t:t.toString(8).padStart(4,"0")}function ou(t){if(null==t)return;let e;if(null!=t.secs&&(e={secs:t.secs,nsecs:t.nsecs}),null!=t.Seconds&&(e={secs:t.Seconds,nsecs:t.FractionalNanoseconds}),Array.isArray(t)&&(e={secs:t[0],nsecs:t[1]}),t instanceof Date){const n=t.getTime(),r=Math.floor(n/1e3);e={secs:r,nsecs:1e3*(n-1e3*r)}}if(Object.prototype.hasOwnProperty.call(e,"secs")){if(null!=e&&null!=e.nsecs&&(e.nsecs<0||e.nsecs>999999999))throw a(new Error("mtime-nsecs must be within the range [0,999999999]"),"ERR_INVALID_MTIME_NSECS");return e}}function iu({arg:t,searchParams:e,hashAlg:n,mtime:r,mode:s,...o}={}){e&&(o={...o,...e}),n&&(o.hash=n),null!=r&&(r=ou(r),o.mtime=r.secs,o.mtimeNsecs=r.nsecs),null!=s&&(o.mode=su(s)),o.timeout&&!isNaN(o.timeout)&&(o.timeout=`${o.timeout}ms`),null==t?t=[]:Array.isArray(t)||(t=[t]);const i=new URLSearchParams(o);return t.forEach((t=>i.append("arg",t))),i}const au=ru((t=>async function(e={}){return((await(await t.post("bitswap/wantlist",{signal:e.signal,searchParams:iu(e),headers:e.headers})).json()).Keys||[]).map((t=>Q.k0.parse(t["/"])))})),cu=ru((t=>async function(e,n={}){return((await(await t.post("bitswap/wantlist",{signal:n.signal,searchParams:iu({...n,peer:e.toString()}),headers:n.headers})).json()).Keys||[]).map((t=>Q.k0.parse(t["/"])))})),lu=ru((t=>async function(e={}){const n=await t.post("bitswap/stat",{searchParams:iu(e),signal:e.signal,headers:e.headers});return function(t){return{provideBufLen:t.ProvideBufLen,wantlist:(t.Wantlist||[]).map((t=>Q.k0.parse(t["/"]))),peers:(t.Peers||[]).map((t=>(0,Ne.jE)(t))),blocksReceived:BigInt(t.BlocksReceived),dataReceived:BigInt(t.DataReceived),blocksSent:BigInt(t.BlocksSent),dataSent:BigInt(t.DataSent),dupBlksReceived:BigInt(t.DupBlksReceived),dupDataReceived:BigInt(t.DupDataReceived)}}(await n.json())}));const uu=ru((t=>async function(e,n={}){return(await t.post("bitswap/unwant",{signal:n.signal,searchParams:iu({arg:e.toString(),...n}),headers:n.headers})).json()}));const du=ru((t=>async function(e,n={}){const r=await t.post("block/get",{signal:n.signal,searchParams:iu({arg:e.toString(),...n}),headers:n.headers});return new Uint8Array(await r.arrayBuffer())}));var hu=n(47498);function pu(...t){return(0,dr.anySignal)(function(t){return t.filter(Boolean)}(t))}const fu=ru((t=>async function e(n,r={}){const s=new AbortController,o=pu(s.signal,r.signal);let i;try{const e=await t.post("block/put",{signal:o,searchParams:iu(r),...await(0,hu.x)([n],s,r.headers)});i=await e.json()}catch(t){if("dag-pb"===r.format)return e(n,{...r,format:"protobuf"});if("dag-cbor"===r.format)return e(n,{...r,format:"cbor"});throw t}return Q.k0.parse(i.Key)})),yu=ru((t=>async function*(e,n={}){Array.isArray(e)||(e=[e]);const r=await t.post("block/rm",{signal:n.signal,searchParams:iu({arg:e.map((t=>t.toString())),"stream-channels":!0,...n}),headers:n.headers});for await(const t of r.ndjson())yield gu(t)}));function gu(t){const e={cid:Q.k0.parse(t.Hash)};return t.Error&&(e.error=new Error(t.Error)),e}const wu=ru((t=>async function(e,n={}){const r=await t.post("block/stat",{signal:n.signal,searchParams:iu({arg:e.toString(),...n}),headers:n.headers}),s=await r.json();return{cid:Q.k0.parse(s.Key),size:s.Size}}));function mu(t){return{get:du(t),put:fu(t),rm:yu(t),stat:wu(t)}}const bu=ru((t=>async function(e,n={}){const r=await t.post("bootstrap/add",{signal:n.signal,searchParams:iu({arg:e,...n}),headers:n.headers}),{Peers:s}=await r.json();return{Peers:s.map((t=>(0,$.HM)(t)))}})),Eu=ru((t=>async function(e={}){const n=await t.post("bootstrap/rm",{signal:e.signal,searchParams:iu({...e,all:!0}),headers:e.headers}),{Peers:r}=await n.json();return{Peers:r.map((t=>(0,$.HM)(t)))}})),_u=ru((t=>async function(e={}){const n=await t.post("bootstrap/list",{signal:e.signal,searchParams:iu(e),headers:e.headers}),{Peers:r}=await n.json();return{Peers:r.map((t=>(0,$.HM)(t)))}})),vu=ru((t=>async function(e={}){const n=await t.post("bootstrap/add",{signal:e.signal,searchParams:iu({...e,default:!0}),headers:e.headers}),{Peers:r}=await n.json();return{Peers:r.map((t=>(0,$.HM)(t)))}})),ku=ru((t=>async function(e,n={}){const r=await t.post("bootstrap/rm",{signal:n.signal,searchParams:iu({arg:e,...n}),headers:n.headers}),{Peers:s}=await r.json();return{Peers:s.map((t=>(0,$.HM)(t)))}}));function Ru(t){return{add:bu(t),clear:Eu(t),list:_u(t),reset:vu(t),rm:ku(t)}}const Su=ru((t=>async function(e,n={}){const r=await t.post("config/profile/apply",{signal:n.signal,searchParams:iu({arg:e,...n}),headers:n.headers}),s=await r.json();return{original:s.OldCfg,updated:s.NewCfg}}));function Tu(t){if(null==t)return t;const e=/^[A-Z]+$/;return Object.keys(t).reduce(((n,r)=>(e.test(r)?n[r.toLowerCase()]=t[r]:e.test(r[0])?n[r[0].toLowerCase()+r.slice(1)]=t[r]:n[r]=t[r],n)),{})}const Au=ru((t=>async function(e={}){const n=await t.post("config/profile/list",{signal:e.signal,searchParams:iu(e),headers:e.headers});return(await n.json()).map((t=>Tu(t)))}));function Iu(t){return{apply:Su(t),list:Au(t)}}const Du=ru((t=>async(e,n={})=>{if(!e)throw new Error("key argument is required");const r=await t.post("config",{signal:n.signal,searchParams:iu({arg:e,...n}),headers:n.headers});return(await r.json()).Value})),Pu=ru((t=>async(e={})=>{const n=await t.post("config/show",{signal:e.signal,searchParams:iu({...e}),headers:e.headers});return await n.json()})),Nu=ru((t=>async(e,n={})=>{const r=new AbortController,s=pu(r.signal,n.signal),o=await t.post("config/replace",{signal:s,searchParams:iu(n),...await(0,hu.x)([(0,x.m)(JSON.stringify(e))],r,n.headers)});await o.text()})),Ou=ru((t=>async(e,n,r={})=>{if("string"!=typeof e)throw new Error("Invalid key type");const s={...r,...Lu(e,n)},o=await t.post("config",{signal:r.signal,searchParams:iu(s),headers:r.headers});await o.text()})),Lu=(t,e)=>{switch(typeof e){case"boolean":return{arg:[t,e.toString()],bool:!0};case"string":return{arg:[t,e]};default:return{arg:[t,JSON.stringify(e)],json:!0}}};function Cu(t){return{getAll:Pu(t),get:Du(t),set:Ou(t),replace:Nu(t),profiles:Iu(t)}}const Mu=ru((t=>async function*(e,n={}){const r=await t.post("dag/export",{signal:n.signal,searchParams:iu({arg:e.toString()}),headers:n.headers});yield*r.iterator()}));async function*xu(t,e,n,r,s){const o=async t=>{const e=await n.getCodec(t.code),o=await r(t,s);return e.decode(o)},i=e.split("/").filter(Boolean);let c=await o(t),l=t;for(;i.length;){const t=i.shift();if(!t)throw a(new Error(`Could not resolve path "${e}"`),"ERR_INVALID_PATH");if(!Object.prototype.hasOwnProperty.call(c,t))throw a(new Error(`no link named "${t}" under ${l}`),"ERR_NO_LINK");c=c[t],yield{value:c,remainderPath:i.join("/")};const n=Q.k0.asCID(c);n&&(l=n,c=await o(c))}yield{value:c,remainderPath:""}}const Bu=(t,e)=>{const n=ru(((e,n)=>{const r=du(n);return async(e,n={})=>{if(n.path){const s=n.localResolve?await(0,ka.Z)(xu(e,n.path,t,r,n)):await(0,Le.Z)(xu(e,n.path,t,r,n));if(!s)throw a(new Error("Not found"),"ERR_NOT_FOUND");return s}const s=await t.getCodec(e.code),o=await r(e,n);return{value:s.decode(o),remainderPath:""}}}));return n(e)},zu=ru((t=>async function*(e,n={}){const r=new AbortController,s=pu(r.signal,n.signal),{headers:o,body:i}=await(0,hu.x)(e,r,n.headers),a=await t.post("dag/import",{signal:s,headers:o,body:i,searchParams:iu({"pin-roots":n.pinRoots})});for await(const{Root:t}of a.ndjson())if(void 0!==t){const{Cid:{"/":e},PinErrorMsg:n}=t;yield{root:{cid:Q.k0.parse(e),pinErrorMsg:n}}}})),Uu=(t,e)=>{const n=ru((e=>async(n,r={})=>{const s={storeCodec:"dag-cbor",hashAlg:"sha2-256",...r};let o;if(s.inputCodec){if(!(n instanceof Uint8Array))throw new Error("Can only inputCodec on raw bytes that can be decoded");o=n}else{o=(await t.getCodec(s.storeCodec)).encode(n),s.inputCodec=s.storeCodec}const i=new AbortController,a=pu(i.signal,s.signal),c=await e.post("dag/put",{timeout:s.timeout,signal:a,searchParams:iu(s),...await(0,hu.x)([o],i,s.headers)}),l=await c.json();return Q.k0.parse(l.Cid["/"])}));return n(e)},ju=ru((t=>async(e,n={})=>{const r=await t.post("dag/resolve",{signal:n.signal,searchParams:iu({arg:`${e}${n.path?`/${n.path}`.replace(/\/[/]+/g,"/"):""}`,...n}),headers:n.headers}),s=await r.json();return{cid:Q.k0.parse(s.Cid["/"]),remainderPath:s.RemPath}}));function $u(t,e){return{export:Mu(e),get:Bu(t,e),import:zu(e),put:Uu(t,e),resolve:ju(e)}}const Vu=t=>{if(0===t.Type)return{name:"SENDING_QUERY",type:t.Type};if(1===t.Type)return{from:(0,Ne.jE)(t.ID),name:"PEER_RESPONSE",type:t.Type,messageType:0,messageName:"PUT_VALUE",closer:(t.Responses||[]).map((({ID:t,Addrs:e})=>({id:(0,Ne.jE)(t),multiaddrs:e.map((t=>(0,$.HM)(t))),protocols:[]}))),providers:(t.Responses||[]).map((({ID:t,Addrs:e})=>({id:(0,Ne.jE)(t),multiaddrs:e.map((t=>(0,$.HM)(t))),protocols:[]})))};if(2===t.Type){let e={id:t.ID??(0,Ne.jE)(t.ID),multiaddrs:[],protocols:[]};return t.Responses&&t.Responses.length&&(e={id:(0,Ne.jE)(t.Responses[0].ID),multiaddrs:t.Responses[0].Addrs.map((t=>(0,$.HM)(t))),protocols:[]}),{name:"FINAL_PEER",type:t.Type,peer:e}}if(3===t.Type)return{name:"QUERY_ERROR",type:t.Type,error:new Error(t.Extra)};if(4===t.Type)return{name:"PROVIDER",type:t.Type,providers:t.Responses.map((({ID:t,Addrs:e})=>({id:(0,Ne.jE)(t),multiaddrs:e.map((t=>(0,$.HM)(t))),protocols:[]})))};if(5===t.Type)return{name:"VALUE",type:t.Type,value:(0,x.m)(t.Extra,"base64pad")};if(6===t.Type){const e=t.Responses.map((({ID:t})=>(0,Ne.jE)(t)));if(!e.length)throw new Error("No peer found");return{name:"ADDING_PEER",type:t.Type,peer:e[0]}}if(7===t.Type)return{name:"DIALING_PEER",type:t.Type,peer:(0,Ne.jE)(t.ID)};throw new Error("Unknown DHT event type")},Hu=ru((t=>async function*(e,n={}){const r=await t.post("dht/findpeer",{signal:n.signal,searchParams:iu({arg:e,...n}),headers:n.headers});for await(const t of r.ndjson())yield Vu(t)})),Fu=ru((t=>async function*(e,n={}){const r=await t.post("dht/findprovs",{signal:n.signal,searchParams:iu({arg:e.toString(),...n}),headers:n.headers});for await(const t of r.ndjson())yield Vu(t)})),Ku=ru((t=>async function*(e,n={}){const r=await t.post("dht/get",{signal:n.signal,searchParams:iu({arg:e instanceof Uint8Array?(0,H.B)(e):e.toString(),...n}),headers:n.headers});for await(const t of r.ndjson())yield Vu(t)})),qu=ru((t=>async function*(e,n={recursive:!1}){const r=Array.isArray(e)?e:[e],s=await t.post("dht/provide",{signal:n.signal,searchParams:iu({arg:r.map((t=>t.toString())),...n}),headers:n.headers});for await(const t of s.ndjson())yield Vu(t)})),Gu=ru((t=>async function*(e,n,r={}){const s=new AbortController,o=pu(s.signal,r.signal),i=await t.post("dht/put",{signal:o,searchParams:iu({arg:e instanceof Uint8Array?(0,H.B)(e):e.toString(),...r}),...await(0,hu.x)([n],s,r.headers)});for await(const t of i.ndjson())yield Vu(t)})),Wu=ru((t=>async function*(e,n={}){const r=await t.post("dht/query",{signal:n.signal,searchParams:iu({arg:e.toString(),...n}),headers:n.headers});for await(const t of r.ndjson())yield Vu(t)}));function Zu(t){return{findPeer:Hu(t),findProvs:Fu(t),get:Ku(t),provide:qu(t),put:Gu(t),query:Wu(t)}}const Yu=ru((t=>async function(e={}){return(await t.post("diag/cmds",{signal:e.signal,searchParams:iu(e),headers:e.headers})).json()})),Ju=ru((t=>async function(e={}){return(await t.post("diag/net",{signal:e.signal,searchParams:iu(e),headers:e.headers})).json()})),Qu=ru((t=>async function(e={}){return(await t.post("diag/sys",{signal:e.signal,searchParams:iu(e),headers:e.headers})).json()}));function Xu(t){return{cmds:Yu(t),net:Ju(t),sys:Qu(t)}}const td=ru((t=>async function(e,n,r={}){const s=await t.post("files/chmod",{signal:r.signal,searchParams:iu({arg:e,mode:n,...r}),headers:r.headers});await s.text()})),ed=ru((t=>async function(e,n,r={}){const s=Array.isArray(e)?e:[e],o=await t.post("files/cp",{signal:r.signal,searchParams:iu({arg:s.concat(n).map((t=>Q.k0.asCID(t)?`/ipfs/${t}`:t)),...r}),headers:r.headers});await o.text()})),nd=ru((t=>async function(e,n={}){if(!e||"string"!=typeof e)throw new Error("ipfs.files.flush requires a path");const r=await t.post("files/flush",{signal:n.signal,searchParams:iu({arg:e,...n}),headers:n.headers}),s=await r.json();return Q.k0.parse(s.Cid)}));function rd(t){const e=Tu(t);return Object.prototype.hasOwnProperty.call(e,"mode")&&(e.mode=parseInt(e.mode,8)),Object.prototype.hasOwnProperty.call(e,"mtime")&&(e.mtime={secs:e.mtime,nsecs:e.mtimeNsecs||0},delete e.mtimeNsecs),e}const sd=ru((t=>async function*(e,n={}){if(!e)throw new Error("ipfs.files.ls requires a path");const r=await t.post("files/ls",{signal:n.signal,searchParams:iu({arg:Q.k0.asCID(e)?`/ipfs/${e}`:e,long:!0,...n,stream:!0}),headers:n.headers});for await(const t of r.ndjson())if("Entries"in t)for(const e of t.Entries||[])yield od(rd(e));else yield od(rd(t))}));function od(t){return t.hash&&(t.cid=Q.k0.parse(t.hash)),delete t.hash,t.type=1===t.type?"directory":"file",t}const id=ru((t=>async function(e,n={}){const r=await t.post("files/mkdir",{signal:n.signal,searchParams:iu({arg:e,...n}),headers:n.headers});await r.text()})),ad=ru((t=>async function(e,n,r={}){Array.isArray(e)||(e=[e]);const s=await t.post("files/mv",{signal:r.signal,searchParams:iu({arg:e.concat(n),...r}),headers:r.headers});await s.text()}));var cd=n(50590);const ld=ru((t=>async function*(e,n={}){const r=await t.post("files/read",{signal:n.signal,searchParams:iu({arg:e,count:n.length,...n}),headers:n.headers});yield*cd(r.body)})),ud=ru((t=>async function(e,n={}){const r=await t.post("files/rm",{signal:n.signal,searchParams:iu({arg:e,...n}),headers:n.headers}),s=await r.text();if(""!==s){const t=new Kl.HTTPError(r);throw t.message=s,t}})),dd=ru((t=>async function(e,n={}){const r=await t.post("files/stat",{signal:n.signal,searchParams:iu({arg:e,...n}),headers:n.headers}),s=await r.json();return s.WithLocality=s.WithLocality||!1,(o=rd(s)).cid=Q.k0.parse(o.hash),delete o.hash,o;var o}));const hd=ru((t=>async function(e,n={}){const r=await t.post("files/touch",{signal:n.signal,searchParams:iu({arg:e,...n}),headers:n.headers});await r.text()})),pd=ru((t=>async function(e,n,r={}){const s=new AbortController,o=pu(s.signal,r.signal),i=await t.post("files/write",{signal:o,searchParams:iu({arg:e,streamChannels:!0,count:r.length,...r}),...await(0,hu.x)([{content:n,path:"arg",mode:su(r.mode),mtime:ou(r.mtime)}],s,r.headers)});await i.text()}));function fd(t){return{chmod:td(t),cp:ed(t),flush:nd(t),ls:sd(t),mkdir:id(t),mv:ad(t),read:ld(t),rm:ud(t),stat:dd(t),touch:hd(t),write:pd(t)}}const yd=ru((t=>async(t,e,n={})=>{throw a(new Error("Not implemented"),"ERR_NOT_IMPLEMENTED")})),gd=ru((t=>async function(e,n){const r=n??{type:"Ed25519"},s=await t.post("key/gen",{signal:r.signal,searchParams:iu({arg:e,...r}),headers:r.headers});return Tu(await s.json())})),wd=ru((t=>async function(e,n,r,s={}){const o=await t.post("key/import",{signal:s.signal,searchParams:iu({arg:e,pem:n,password:r,...s}),headers:s.headers});return Tu(await o.json())})),md=ru((t=>async(t,e={})=>{throw a(new Error("Not implemented"),"ERR_NOT_IMPLEMENTED")})),bd=ru((t=>async function(e={}){const n=await t.post("key/list",{signal:e.signal,searchParams:iu(e),headers:e.headers});return((await n.json()).Keys||[]).map((t=>Tu(t)))})),Ed=ru((t=>async function(e,n,r={}){const s=await t.post("key/rename",{signal:r.signal,searchParams:iu({arg:[e,n],...r}),headers:r.headers});return Tu(await s.json())})),_d=ru((t=>async function(e,n={}){const r=await t.post("key/rm",{signal:n.signal,searchParams:iu({arg:e,...n}),headers:n.headers});return Tu((await r.json()).Keys[0])}));function vd(t){return{export:yd(t),gen:gd(t),import:wd(t),info:md(t),list:bd(t),rename:Ed(t),rm:_d(t)}}const kd=ru((t=>async function(e,n,r={}){const s=await t.post("log/level",{signal:r.signal,searchParams:iu({arg:[e,n],...r}),headers:r.headers});return Tu(await s.json())})),Rd=ru((t=>async function(e={}){const n=await t.post("log/ls",{signal:e.signal,searchParams:iu(e),headers:e.headers});return(await n.json()).Strings})),Sd=ru((t=>async function*(e={}){const n=await t.post("log/tail",{signal:e.signal,searchParams:iu(e),headers:e.headers});yield*n.ndjson()}));function Td(t){return{level:kd(t),ls:Rd(t),tail:Sd(t)}}const Ad=ru((t=>async function(e,n={}){const r=await t.post("name/publish",{signal:n.signal,searchParams:iu({arg:`${e}`,...n}),headers:n.headers});return Tu(await r.json())})),Id=ru((t=>async function*(e,n={}){const r=await t.post("name/resolve",{signal:n.signal,searchParams:iu({arg:e,stream:!0,...n}),headers:n.headers});for await(const t of r.ndjson())yield t.Path})),Dd=ru((t=>async function(e,n={}){const r=await t.post("name/pubsub/cancel",{signal:n.signal,searchParams:iu({arg:e,...n}),headers:n.headers});return Tu(await r.json())})),Pd=ru((t=>async function(e={}){const n=await t.post("name/pubsub/state",{signal:e.signal,searchParams:iu(e),headers:e.headers});return Tu(await n.json())})),Nd=ru((t=>async function(e={}){const n=await t.post("name/pubsub/subs",{signal:e.signal,searchParams:iu(e),headers:e.headers});return(await n.json()).Strings||[]}));function Od(t){return{cancel:Dd(t),state:Pd(t),subs:Nd(t)}}function Ld(t){return{publish:Ad(t),resolve:Id(t),pubsub:Od(t)}}const Cd=ru((t=>async function(e,n={}){const r=await t.post("object/data",{signal:n.signal,searchParams:iu({arg:`${e instanceof Uint8Array?Q.k0.decode(e):e}`,...n}),headers:n.headers}),s=await r.arrayBuffer();return new Uint8Array(s,0,s.byteLength)})),Md=ru((t=>async function(e,n={}){const r=await t.post("object/get",{signal:n.signal,searchParams:iu({arg:`${e instanceof Uint8Array?Q.k0.decode(e):e}`,dataEncoding:"base64",...n}),headers:n.headers}),s=await r.json();return{Data:(0,x.m)(s.Data,"base64pad"),Links:(s.Links||[]).map((t=>({Name:t.Name,Hash:Q.k0.parse(t.Hash),Tsize:t.Size})))}})),xd=ru((t=>async function(e,n={}){const r=await t.post("object/links",{signal:n.signal,searchParams:iu({arg:`${e instanceof Uint8Array?Q.k0.decode(e):e}`,...n}),headers:n.headers});return((await r.json()).Links||[]).map((t=>({Name:t.Name,Tsize:t.Size,Hash:Q.k0.parse(t.Hash)})))})),Bd=ru((t=>async function(e={}){const n=await t.post("object/new",{signal:e.signal,searchParams:iu({arg:e.template,...e}),headers:e.headers}),{Hash:r}=await n.json();return Q.k0.parse(r)})),zd=(t,e)=>{const n=ru((n=>{const r=Uu(t,e);return async function(t,e={}){return r(t,{...e,storeCodec:"dag-pb",hashAlg:"sha2-256",version:1})}}));return n(e)},Ud=ru((t=>async function(e,n={}){const r=await t.post("object/stat",{signal:n.signal,searchParams:iu({arg:`${e}`,...n}),headers:n.headers}),s=await r.json();return{...s,Hash:Q.k0.parse(s.Hash)}})),jd=ru((t=>async function(e,n,r={}){const s=await t.post("object/patch/add-link",{signal:r.signal,searchParams:iu({arg:[`${e}`,n.Name||n.name||"",(n.Hash||n.cid||"").toString()||null],...r}),headers:r.headers}),{Hash:o}=await s.json();return Q.k0.parse(o)})),$d=ru((t=>async function(e,n,r={}){const s=new AbortController,o=pu(s.signal,r.signal),i=await t.post("object/patch/append-data",{signal:o,searchParams:iu({arg:`${e}`,...r}),...await(0,hu.x)([n],s,r.headers)}),{Hash:a}=await i.json();return Q.k0.parse(a)})),Vd=ru((t=>async function(e,n,r={}){const s=await t.post("object/patch/rm-link",{signal:r.signal,searchParams:iu({arg:[`${e}`,n.Name||n.name||null],...r}),headers:r.headers}),{Hash:o}=await s.json();return Q.k0.parse(o)})),Hd=ru((t=>async function(e,n,r={}){const s=new AbortController,o=pu(s.signal,r.signal),i=await t.post("object/patch/set-data",{signal:o,searchParams:iu({arg:[`${e}`],...r}),...await(0,hu.x)([n],s,r.headers)}),{Hash:a}=await i.json();return Q.k0.parse(a)}));function Fd(t){return{addLink:jd(t),appendData:$d(t),rmLink:Vd(t),setData:Hd(t)}}function Kd(t,e){return{data:Cd(e),get:Md(e),links:xd(e),new:Bd(e),put:zd(t,e),stat:Ud(e),patch:Fd(e)}}const qd=ru((t=>async function*(e,n={}){for await(const{path:r,recursive:s,metadata:o}of(0,Ce.f)(e)){const e=await t.post("pin/add",{signal:n.signal,searchParams:iu({...n,arg:r,recursive:s,metadata:o?JSON.stringify(o):void 0,stream:!0}),headers:n.headers});for await(const t of e.ndjson())if(t.Pins)for(const e of t.Pins)yield Q.k0.parse(e);else yield Q.k0.parse(t)}}));function Gd(t){const e=qd(t);return ru((()=>async function(t,n={}){return(0,Le.Z)(e([{path:t,...n}],n))}))(t)}function Wd(t,e,n){const r={type:t,cid:Q.k0.parse(e)};return n&&(r.metadata=n),r}const Zd=ru((t=>async function*(e={}){let n=[];e.paths&&(n=Array.isArray(e.paths)?e.paths:[e.paths]);const r=await t.post("pin/ls",{signal:e.signal,searchParams:iu({...e,arg:n.map((t=>`${t}`)),stream:!0}),headers:e.headers});for await(const t of r.ndjson()){if(t.Keys){for(const e of Object.keys(t.Keys))yield Wd(t.Keys[e].Type,e,t.Keys[e].Metadata);return}yield Wd(t.Type,t.Cid,t.Metadata)}})),Yd=ru((t=>async function*(e,n={}){for await(const{path:r,recursive:s}of(0,Ce.f)(e)){const e=new URLSearchParams(n.searchParams);e.append("arg",`${r}`),null!=s&&e.set("recursive",String(s));const o=await t.post("pin/rm",{signal:n.signal,headers:n.headers,searchParams:iu({...n,arg:`${r}`,recursive:s})});for await(const t of o.ndjson())t.Pins?yield*t.Pins.map((t=>Q.k0.parse(t))):yield Q.k0.parse(t)}})),Jd=t=>{const e=Yd(t);return ru((()=>async function(t,n={}){return(0,Le.Z)(e([{path:t,...n}],n))}))(t)},Qd=({Name:t,Status:e,Cid:n})=>({cid:Q.k0.parse(n),name:t,status:e}),Xd=t=>{if("string"==typeof t&&""!==t)return t;throw new TypeError("service name must be passed")},th=t=>{if(Q.k0.asCID(t))return t.toString();throw new TypeError("CID instance expected instead of "+typeof t)},eh=({service:t,cid:e,name:n,status:r,all:s})=>{const o=iu({service:Xd(t),name:n,force:!!s||void 0});if(e)for(const t of e)o.append("cid",th(t));if(r)for(const t of r)o.append("status",t);return o},nh=({cid:t,service:e,background:n,name:r,origins:s})=>{const o=iu({arg:th(t),service:Xd(e),name:r,background:!!n||void 0});if(s)for(const t of s)o.append("origin",t.toString());return o};function rh(t){return async function(e,{timeout:n,signal:r,headers:s,...o}){const i=await t.post("pin/remote/add",{timeout:n,signal:r,headers:s,searchParams:nh({cid:e,...o})});return Qd(await i.json())}}function sh(t){return async function*({timeout:e,signal:n,headers:r,...s}){const o=await t.post("pin/remote/ls",{timeout:e,signal:n,headers:r,searchParams:eh(s)});for await(const t of o.ndjson())yield Qd(t)}}function oh(t){return async function({timeout:e,signal:n,headers:r,...s}){await t.post("pin/remote/rm",{timeout:e,signal:n,headers:r,searchParams:eh({...s,all:!1})})}}function ih(t){return async function({timeout:e,signal:n,headers:r,...s}){await t.post("pin/remote/rm",{timeout:e,signal:n,headers:r,searchParams:eh({...s,all:!0})})}}function ah(t){const e=String(t);if("undefined"===e)throw Error("endpoint is required");return"/"===e[e.length-1]?e.slice(0,-1):e}function ch(t){return{service:t.Service,endpoint:new URL(t.ApiEndpoint),...t.Stat&&{stat:lh(t.Stat)}}}function lh(t){switch(t.Status){case"valid":{const{Pinning:e,Pinned:n,Queued:r,Failed:s}=t.PinCount;return{status:"valid",pinCount:{queued:r,pinning:e,pinned:n,failed:s}}}case"invalid":return{status:"invalid"};default:return{status:t.Status}}}function uh(t){return async function(e,n){const{endpoint:r,key:s,headers:o,timeout:i,signal:a}=n;await t.post("pin/remote/service/add",{timeout:i,signal:a,searchParams:iu({arg:[e,ah(r),s]}),headers:o})}}function dh(t){return async function(e={}){const{stat:n,headers:r,timeout:s,signal:o}=e,i=await t.post("pin/remote/service/ls",{timeout:s,signal:o,headers:r,searchParams:!0===n?iu({stat:n}):void 0}),{RemoteServices:a}=await i.json();return a.map(ch)}}function hh(t){return async function(e,n={}){await t.post("pin/remote/service/rm",{signal:n.signal,headers:n.headers,searchParams:iu({arg:e})})}}function ph(t){const e=new nu(t);return{add:uh(e),ls:dh(e),rm:hh(e)}}function fh(t){const e=new nu(t);return{add:rh(e),ls:sh(e),rm:oh(e),rmAll:ih(e),service:ph(t)}}function yh(t){return{addAll:qd(t),add:Gd(t),ls:Zd(t),rmAll:Yd(t),rm:Jd(t),remote:fh(t)}}var gh=n(99382);const wh=t=>(0,H.B)(mh(t)),mh=t=>gh.base64url.decode(t),bh=t=>BigInt(`0x${(0,H.B)(gh.base64url.decode(t),"base16")}`),Eh=t=>gh.base64url.encode((0,x.m)(t)),_h=ru((t=>async function(e={}){const{Strings:n}=await(await t.post("pubsub/ls",{signal:e.signal,searchParams:iu(e),headers:e.headers})).json();return r=n,(Array.isArray(r)?r.map(wh):r)||[];var r})),vh=ru((t=>async function(e,n={}){const r=await t.post("pubsub/peers",{signal:n.signal,searchParams:iu({arg:Eh(e),...n}),headers:n.headers}),{Strings:s}=await r.json();return s||[]})),kh=ru((t=>async function(e,n,r={}){const s=iu({arg:Eh(e),...r}),o=new AbortController,i=pu(o.signal,r.signal),a=await t.post("pubsub/pub",{signal:i,searchParams:s,...await(0,hu.x)([n],o,r.headers)});await a.text()})),Rh=(0,i.kg)("ipfs-http-client:pubsub:subscribe"),Sh=(t,e)=>ru((t=>async function(n,r,s={}){let o,i;s.signal=e.subscribe(n,r,s.signal);const a=new Promise(((t,e)=>{o=t,i=e})),c=setTimeout((()=>o()),1e3);return t.post("pubsub/sub",{signal:s.signal,searchParams:iu({arg:Eh(n),...s}),headers:s.headers}).catch((t=>{e.unsubscribe(n,r),i(t)})).then((t=>{clearTimeout(c),t&&(!async function(t,{onMessage:e,onEnd:n,onError:r}){r=r||Rh;try{for await(const n of t.ndjson())try{if(!n.from)continue;null!=n.from&&null!=n.seqno?e({type:"signed",from:(0,Ne.jE)(n.from),data:mh(n.data),sequenceNumber:bh(n.seqno),topic:wh(n.topicIDs[0]),key:mh(n.key??"u"),signature:mh(n.signature??"u")}):e({type:"unsigned",data:mh(n.data),topic:wh(n.topicIDs[0])})}catch(t){t.message=`Failed to parse pubsub message: ${t.message}`,r(t,!1,n)}}catch(t){Th(t)||r(t,!0)}finally{n()}}(t,{onMessage:t=>{r&&("function"!=typeof r?"function"==typeof r.handleEvent&&r.handleEvent(t):r(t))},onEnd:()=>e.unsubscribe(n,r),onError:s.onError}),o())})),a}))(t);const Th=t=>{switch(t.type){case"aborted":case"abort":return!0;default:return"AbortError"===t.name}},Ah=(t,e)=>async function(t,n){e.unsubscribe(t,n)};class Ih{constructor(){this._subs=new Map}subscribe(t,e,n){const r=this._subs.get(t)||[];if(r.find((t=>t.handler===e)))throw new Error(`Already subscribed to ${t} with this handler`);const s=new AbortController;return this._subs.set(t,[{handler:e,controller:s}].concat(r)),n&&n.addEventListener("abort",(()=>this.unsubscribe(t,e))),s.signal}unsubscribe(t,e){const n=this._subs.get(t)||[];let r;e?(this._subs.set(t,n.filter((t=>t.handler!==e))),r=n.filter((t=>t.handler===e))):(this._subs.set(t,[]),r=n),(this._subs.get(t)||[]).length||this._subs.delete(t),r.forEach((t=>t.controller.abort()))}}function Dh(t){const e=new Ih;return{ls:_h(t),peers:vh(t),publish:kh(t),subscribe:Sh(t,e),unsubscribe:Ah(t,e)}}const Ph=ru((t=>async function*(e={}){const n=await t.post("refs/local",{signal:e.signal,transform:Tu,searchParams:iu(e),headers:e.headers});yield*n.ndjson()})),Nh=ru(((t,e)=>Object.assign((async function*(e,n={}){const r=Array.isArray(e)?e:[e],s=await t.post("refs",{signal:n.signal,searchParams:iu({arg:r.map((t=>`${t instanceof Uint8Array?Q.k0.decode(t):t}`)),...n}),headers:n.headers,transform:Tu});yield*s.ndjson()}),{local:Ph(e)}))),Oh=ru((t=>async function*(e={}){const n=await t.post("repo/gc",{signal:e.signal,searchParams:iu(e),headers:e.headers,transform:t=>({err:t.Error?new Error(t.Error):null,cid:(t.Key||{})["/"]?Q.k0.parse(t.Key["/"]):null})});yield*n.ndjson()})),Lh=ru((t=>async function(e={}){const n=await t.post("repo/stat",{signal:e.signal,searchParams:iu(e),headers:e.headers}),r=await n.json();return{numObjects:BigInt(r.NumObjects),repoSize:BigInt(r.RepoSize),repoPath:r.RepoPath,version:r.Version,storageMax:BigInt(r.StorageMax)}})),Ch=ru((t=>async function(e={}){return(await(await t.post("repo/version",{signal:e.signal,searchParams:iu(e),headers:e.headers})).json()).Version}));function Mh(t){return{gc:Oh(t),stat:Lh(t),version:Ch(t)}}const xh=ru((t=>async function*(e={}){const n=await t.post("stats/bw",{signal:e.signal,searchParams:iu(e),headers:e.headers,transform:t=>({totalIn:BigInt(t.TotalIn),totalOut:BigInt(t.TotalOut),rateIn:parseFloat(t.RateIn),rateOut:parseFloat(t.RateOut)})});yield*n.ndjson()}));function Bh(t){return{bitswap:lu(t),repo:Lh(t),bw:xh(t)}}const zh=ru((t=>async function(e={}){const n=await t.post("swarm/addrs",{signal:e.signal,searchParams:iu(e),headers:e.headers}),{Addrs:r}=await n.json();return Object.keys(r).map((t=>({id:(0,Ne.jE)(t),addrs:(r[t]||[]).map((t=>(0,$.HM)(t)))})))})),Uh=ru((t=>async function(e,n={}){const r=await t.post("swarm/connect",{signal:n.signal,searchParams:iu({arg:e,...n}),headers:n.headers}),{Strings:s}=await r.json();return s||[]})),jh=ru((t=>async function(e,n={}){const r=await t.post("swarm/disconnect",{signal:n.signal,searchParams:iu({arg:e,...n}),headers:n.headers}),{Strings:s}=await r.json();return s||[]})),$h=ru((t=>async function(e={}){const n=await t.post("swarm/addrs/local",{signal:e.signal,searchParams:iu(e),headers:e.headers}),{Strings:r}=await n.json();return(r||[]).map((t=>(0,$.HM)(t)))})),Vh=ru((t=>async function(e={}){const n=await t.post("swarm/peers",{signal:e.signal,searchParams:iu(e),headers:e.headers}),{Peers:r}=await n.json();return(r||[]).map((t=>({addr:(0,$.HM)(t.Addr),peer:(0,Ne.jE)(t.Peer),muxer:t.Muxer,latency:t.Latency,streams:t.Streams,direction:null==t.Direction?void 0:0===t.Direction?"inbound":"outbound"})))}));function Hh(t){return{addrs:zh(t),connect:Uh(t),disconnect:jh(t),localAddrs:$h(t),peers:Vh(t)}}const Fh=ru((t=>async function*(e,n={}){const r=new AbortController,s=pu(r.signal,n.signal),{headers:o,body:i,total:a,parts:c}=await(0,hu.x)(e,r,n.headers),[l,u]="function"==typeof n.progress?Kh(a,c,n.progress):[void 0,void 0],d=await t.post("add",{searchParams:iu({"stream-channels":!0,...n,progress:Boolean(l)}),onUploadProgress:u,signal:s,headers:o,body:i});for await(let t of d.ndjson())t=Tu(t),void 0!==t.hash?yield Gh(t):l&&l(t.bytes||0,t.name)})),Kh=(t,e,n)=>e?[void 0,qh(t,e,n)]:[n,void 0],qh=(t,e,n)=>{let r=0;const s=e.length;return({loaded:o,total:i})=>{const a=Math.floor(o/i*t);for(;r<s;){const{start:t,end:s,name:o}=e[r];if(a<s){n(a-t,o);break}n(s-t,o),r+=1}}};function Gh({name:t,hash:e,size:n,mode:r,mtime:s,mtimeNsecs:o}){const i={path:t,cid:Q.k0.parse(e),size:parseInt(n)};return null!=r&&(i.mode=parseInt(r,8)),null!=s&&(i.mtime={secs:s,nsecs:o||0}),i}function Wh(t){const e=Fh(t);return ru((()=>async function(t,n={}){return await(0,Le.Z)(e((0,Ys.f)(t),n))}))(t)}const Zh=ru((t=>async function*(e,n={}){const r=await t.post("cat",{signal:n.signal,searchParams:iu({arg:e.toString(),...n}),headers:n.headers});yield*r.iterator()})),Yh=ru((t=>async(e={})=>(await t.post("commands",{signal:e.signal,searchParams:iu(e),headers:e.headers})).json())),Jh=ru((t=>async(e,n={})=>{const r=await t.post("dns",{signal:n.signal,searchParams:iu({arg:e,...n}),headers:n.headers});return(await r.json()).Path})),Qh=ru((t=>()=>{const e=new URL(t.opts.base||"");return{host:e.hostname,port:e.port,protocol:e.protocol,pathname:e.pathname,"api-path":e.pathname}})),Xh=ru((t=>async function*(e,n={}){const r={arg:`${e instanceof Uint8Array?Q.k0.decode(e):e}`,...n};r.compressionLevel&&(r["compression-level"]=r.compressionLevel,delete r.compressionLevel);const s=await t.post("get",{signal:n.signal,searchParams:iu(r),headers:n.headers});yield*s.iterator()})),tp=ru((t=>async function(e={}){const n=await t.post("id",{signal:e.signal,searchParams:iu({arg:e.peerId?e.peerId.toString():void 0,...e}),headers:e.headers}),r={...Tu(await n.json())};return r.id=(0,Ne.jE)(r.id),r.addresses&&(r.addresses=r.addresses.map((t=>(0,$.HM)(t)))),r})),ep=t=>{const e=tp(t);return async function(t={}){const n=await e(t);return Boolean(n&&n.addresses&&n.addresses.length)}},np=ru(((t,e)=>async function*(n,r={}){const s=`${n instanceof Uint8Array?Q.k0.decode(n):n}`;async function o(t){let n=t.Hash;if(n.includes("/")){const t=n.startsWith("/ipfs/")?n:`/ipfs/${n}`;n=(await dd(e)(t)).cid}else n=Q.k0.parse(n);const r={name:t.Name,path:s+(t.Name?`/${t.Name}`:""),size:t.Size,cid:n,type:rp(t)};return t.Mode&&(r.mode=parseInt(t.Mode,8)),void 0!==t.Mtime&&null!==t.Mtime&&(r.mtime={secs:t.Mtime},void 0!==t.MtimeNsecs&&null!==t.MtimeNsecs&&(r.mtime.nsecs=t.MtimeNsecs)),r}const i=await t.post("ls",{signal:r.signal,searchParams:iu({arg:s,...r}),headers:r.headers});for await(let t of i.ndjson()){if(t=t.Objects,!t)throw new Error("expected .Objects in results");if(t=t[0],!t)throw new Error("expected one array in results.Objects");const e=t.Links;if(!Array.isArray(e))throw new Error("expected one array in results.Objects[0].Links");if(!e.length)return void(yield o(t));yield*e.map(o)}}));function rp(t){switch(t.Type){case 1:case 5:return"dir";default:return"file"}}const sp=ru((t=>async function(e={}){const n=await t.post("dns",{signal:e.signal,searchParams:iu(e),headers:e.headers});return Tu(await n.json())})),op=ru((t=>async function*(e,n={}){const r=await t.post("ping",{signal:n.signal,searchParams:iu({arg:`${e}`,...n}),headers:n.headers,transform:Tu});yield*r.ndjson()})),ip=ru((t=>async function(e,n={}){const r=await t.post("resolve",{signal:n.signal,searchParams:iu({arg:e,...n}),headers:n.headers}),{Path:s}=await r.json();return s})),ap=ru((t=>async(t={})=>{throw a(new Error("Not implemented"),"ERR_NOT_IMPLEMENTED")})),cp=ru((t=>async function(e={}){const n=await t.post("shutdown",{signal:e.signal,searchParams:iu(e),headers:e.headers});await n.text()})),lp=ru((t=>async function(e={}){const n=await t.post("version",{signal:e.signal,searchParams:iu(e),headers:e.headers});return{...Tu(await n.json()),"ipfs-http-client":"1.0.0"}}));n(63897),n(46953);var up,dp,hp=n(42637),pp=n(46857),fp=n(57447);class yp extends Bn{constructor(){super(),this.data={}}open(){return Promise.resolve()}close(){return Promise.resolve()}async put(t,e){this.data[t.toString()]=e}async get(t){if(!await this.has(t))throw Ue();return this.data[t.toString()]}async has(t){return void 0!==this.data[t.toString()]}async delete(t){delete this.data[t.toString()]}async*_all(){yield*Object.entries(this.data).map((([t,e])=>({key:new be.s(t),value:e})))}async*_allKeys(){yield*Object.entries(this.data).map((([t])=>new be.s(t)))}}async function*gp(t,e){yield*(0,$s.Z)(t,(async t=>(await e.addressBook.add(t.id,t.multiaddrs),t)))}function wp(t){const e=new Set;return(0,Mn.Z)(t,(t=>!e.has(t.id.toString())&&(e.add(t.id.toString()),!0)))}async function*mp(t,e=1){let n=0;for await(const e of t)n++,yield e;if(n<e)throw a(new Error("not found"),"NOT_FOUND")}!function(t){t.NOT_STARTED_YET="The libp2p node is not started yet",t.DHT_DISABLED="DHT is not available",t.PUBSUB_DISABLED="PubSub is not available",t.CONN_ENCRYPTION_REQUIRED="At least one connection encryption module is required",t.ERR_TRANSPORTS_REQUIRED="At least one transport module is required",t.ERR_PROTECTOR_REQUIRED="Private network is enforced, but no protector was provided",t.NOT_FOUND="Not found"}(up||(up={})),function(t){t.DHT_DISABLED="ERR_DHT_DISABLED",t.ERR_PUBSUB_DISABLED="ERR_PUBSUB_DISABLED",t.PUBSUB_NOT_STARTED="ERR_PUBSUB_NOT_STARTED",t.DHT_NOT_STARTED="ERR_DHT_NOT_STARTED",t.CONN_ENCRYPTION_REQUIRED="ERR_CONN_ENCRYPTION_REQUIRED",t.ERR_TRANSPORTS_REQUIRED="ERR_TRANSPORTS_REQUIRED",t.ERR_PROTECTOR_REQUIRED="ERR_PROTECTOR_REQUIRED",t.ERR_PEER_DIAL_INTERCEPTED="ERR_PEER_DIAL_INTERCEPTED",t.ERR_CONNECTION_INTERCEPTED="ERR_CONNECTION_INTERCEPTED",t.ERR_INVALID_PROTOCOLS_FOR_STREAM="ERR_INVALID_PROTOCOLS_FOR_STREAM",t.ERR_CONNECTION_ENDED="ERR_CONNECTION_ENDED",t.ERR_CONNECTION_FAILED="ERR_CONNECTION_FAILED",t.ERR_NODE_NOT_STARTED="ERR_NODE_NOT_STARTED",t.ERR_ALREADY_ABORTED="ERR_ALREADY_ABORTED",t.ERR_TOO_MANY_ADDRESSES="ERR_TOO_MANY_ADDRESSES",t.ERR_NO_VALID_ADDRESSES="ERR_NO_VALID_ADDRESSES",t.ERR_RELAYED_DIAL="ERR_RELAYED_DIAL",t.ERR_DIALED_SELF="ERR_DIALED_SELF",t.ERR_DISCOVERED_SELF="ERR_DISCOVERED_SELF",t.ERR_DUPLICATE_TRANSPORT="ERR_DUPLICATE_TRANSPORT",t.ERR_ENCRYPTION_FAILED="ERR_ENCRYPTION_FAILED",t.ERR_HOP_REQUEST_FAILED="ERR_HOP_REQUEST_FAILED",t.ERR_INVALID_KEY="ERR_INVALID_KEY",t.ERR_INVALID_MESSAGE="ERR_INVALID_MESSAGE",t.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",t.ERR_INVALID_PEER="ERR_INVALID_PEER",t.ERR_MUXER_UNAVAILABLE="ERR_MUXER_UNAVAILABLE",t.ERR_NOT_FOUND="ERR_NOT_FOUND",t.ERR_TIMEOUT="ERR_TIMEOUT",t.ERR_TRANSPORT_UNAVAILABLE="ERR_TRANSPORT_UNAVAILABLE",t.ERR_TRANSPORT_DIAL_FAILED="ERR_TRANSPORT_DIAL_FAILED",t.ERR_UNSUPPORTED_PROTOCOL="ERR_UNSUPPORTED_PROTOCOL",t.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED="ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED",t.ERR_INVALID_MULTIADDR="ERR_INVALID_MULTIADDR",t.ERR_SIGNATURE_NOT_VALID="ERR_SIGNATURE_NOT_VALID",t.ERR_FIND_SELF="ERR_FIND_SELF",t.ERR_NO_ROUTERS_AVAILABLE="ERR_NO_ROUTERS_AVAILABLE",t.ERR_CONNECTION_NOT_MULTIPLEXED="ERR_CONNECTION_NOT_MULTIPLEXED",t.ERR_NO_DIAL_TOKENS="ERR_NO_DIAL_TOKENS",t.ERR_KEYCHAIN_REQUIRED="ERR_KEYCHAIN_REQUIRED",t.ERR_INVALID_CMS="ERR_INVALID_CMS",t.ERR_MISSING_KEYS="ERR_MISSING_KEYS",t.ERR_NO_KEY="ERR_NO_KEY",t.ERR_INVALID_KEY_NAME="ERR_INVALID_KEY_NAME",t.ERR_INVALID_KEY_TYPE="ERR_INVALID_KEY_TYPE",t.ERR_KEY_ALREADY_EXISTS="ERR_KEY_ALREADY_EXISTS",t.ERR_INVALID_KEY_SIZE="ERR_INVALID_KEY_SIZE",t.ERR_KEY_NOT_FOUND="ERR_KEY_NOT_FOUND",t.ERR_OLD_KEY_NAME_INVALID="ERR_OLD_KEY_NAME_INVALID",t.ERR_NEW_KEY_NAME_INVALID="ERR_NEW_KEY_NAME_INVALID",t.ERR_PASSWORD_REQUIRED="ERR_PASSWORD_REQUIRED",t.ERR_PEM_REQUIRED="ERR_PEM_REQUIRED",t.ERR_CANNOT_READ_KEY="ERR_CANNOT_READ_KEY",t.ERR_MISSING_PRIVATE_KEY="ERR_MISSING_PRIVATE_KEY",t.ERR_MISSING_PUBLIC_KEY="ERR_MISSING_PUBLIC_KEY",t.ERR_INVALID_OLD_PASS_TYPE="ERR_INVALID_OLD_PASS_TYPE",t.ERR_INVALID_NEW_PASS_TYPE="ERR_INVALID_NEW_PASS_TYPE",t.ERR_INVALID_PASS_LENGTH="ERR_INVALID_PASS_LENGTH",t.ERR_NOT_IMPLEMENTED="ERR_NOT_IMPLEMENTED",t.ERR_WRONG_PING_ACK="ERR_WRONG_PING_ACK",t.ERR_INVALID_RECORD="ERR_INVALID_RECORD",t.ERR_ALREADY_SUCCEEDED="ERR_ALREADY_SUCCEEDED",t.ERR_NO_HANDLER_FOR_PROTOCOL="ERR_NO_HANDLER_FOR_PROTOCOL",t.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS",t.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS",t.ERR_CONNECTION_DENIED="ERR_CONNECTION_DENIED"}(dp||(dp={}));var bp=n(27695),Ep=n(17187);const _p=(0,i.kg)("libp2p:peer-routing");class vp{constructor(t,e){this.components=t,this.routers=e.routers??[],this.refreshManagerInit=e.refreshManager??{},this.started=!1,this._findClosestPeersTask=this._findClosestPeersTask.bind(this)}isStarted(){return this.started}async start(){this.started||0===this.routers.length||null!=this.timeoutId||!1===this.refreshManagerInit.enabled||(this.timeoutId=(0,bp.setDelayedInterval)(this._findClosestPeersTask,this.refreshManagerInit.interval,this.refreshManagerInit.bootDelay),this.started=!0)}async _findClosestPeersTask(){if(null==this.abortController)try{this.abortController=new B.TimeoutController(this.refreshManagerInit.timeout??1e4);try{(0,Ep.setMaxListeners)?.(1/0,this.abortController.signal)}catch{}await(0,Cn.Z)(this.getClosestPeers(this.components.peerId.toBytes(),{signal:this.abortController.signal}))}catch(t){_p.error(t)}finally{this.abortController?.clear(),this.abortController=void 0}}async stop(){(0,bp.clearDelayedInterval)(this.timeoutId),this.abortController?.abort(),this.started=!1}async findPeer(t,e){if(0===this.routers.length)throw a(new Error("No peer routers available"),dp.ERR_NO_ROUTERS_AVAILABLE);if(t.toString()===this.components.peerId.toString())throw a(new Error("Should not try to find self"),dp.ERR_FIND_SELF);const n=await Gs((0,Vs.Z)(...this.routers.map((n=>async function*(){try{yield await n.findPeer(t,e)}catch(t){_p.error(t)}}()))),(t=>(0,Mn.Z)(t,Boolean)),(t=>gp(t,this.components.peerStore)),(async t=>await(0,ka.Z)(t)));if(null!=n)return n;throw a(new Error(up.NOT_FOUND),dp.ERR_NOT_FOUND)}async*getClosestPeers(t,e){if(0===this.routers.length)throw a(new Error("No peer routers available"),dp.ERR_NO_ROUTERS_AVAILABLE);yield*Gs((0,Vs.Z)(...this.routers.map((n=>n.getClosestPeers(t,e)))),(t=>gp(t,this.components.peerStore)),(t=>wp(t)),(t=>mp(t)))}}class kp{constructor(t,e){this.routers=e.routers??[],this.started=!1,this.components=t}isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(t,e={}){if(0===this.routers.length)throw a(new Error("No content this.routers available"),dp.ERR_NO_ROUTERS_AVAILABLE);yield*Gs((0,Vs.Z)(...this.routers.map((n=>n.findProviders(t,e)))),(t=>gp(t,this.components.peerStore)),(t=>wp(t)),(t=>mp(t)))}async provide(t,e={}){if(0===this.routers.length)throw a(new Error("No content routers available"),dp.ERR_NO_ROUTERS_AVAILABLE);await Promise.all(this.routers.map((async n=>await n.provide(t,e))))}async put(t,e,n){if(!this.isStarted())throw a(new Error(up.NOT_STARTED_YET),dp.DHT_NOT_STARTED);const r=this.components.dht;null!=r&&await(0,Cn.Z)(r.put(t,e,n))}async get(t,e){if(!this.isStarted())throw a(new Error(up.NOT_STARTED_YET),dp.DHT_NOT_STARTED);const n=this.components.dht;if(null!=n)for await(const r of n.get(t,e))if("VALUE"===r.name)return r.value;throw a(new Error(up.NOT_FOUND),dp.ERR_NOT_FOUND)}async*getMany(t,e,n){if(!this.isStarted())throw a(new Error(up.NOT_STARTED_YET),dp.DHT_NOT_STARTED);if(null==e||0===e)return;let r=0;const s=this.components.dht;if(null!=s)for await(const o of s.get(t,n))if("VALUE"===o.name&&(yield{from:o.from,val:o.value},r++,r===e))break;if(0===r)throw a(new Error(up.NOT_FOUND),dp.ERR_NOT_FOUND)}}const Rp=t=>t;class Sp extends pp.v{constructor(t,e){super();const{listen:n=[],announce:r=[]}=e;this.components=t,this.listen=n.map((t=>t.toString())),this.announce=new Set(r.map((t=>t.toString()))),this.observed=new Set,this.announceFilter=e.announceFilter??Rp}getListenAddrs(){return Array.from(this.listen).map((t=>(0,$.HM)(t)))}getAnnounceAddrs(){return Array.from(this.announce).map((t=>(0,$.HM)(t)))}getObservedAddrs(){return Array.from(this.observed).map((t=>(0,$.HM)(t)))}confirmObservedAddr(t){}removeObservedAddr(t){}addObservedAddr(t){let e=(0,$.HM)(t);const n=e.getPeerId();if(null!=n){(0,Ne.jE)(n).equals(this.components.peerId)&&(e=e.decapsulate((0,$.HM)(`/p2p/${this.components.peerId.toString()}`)))}const r=e.toString();this.observed.has(r)||(this.observed.add(r),this.dispatchEvent(new pp.A("change:addresses")))}getAddresses(){let t=this.getAnnounceAddrs().map((t=>t.toString()));0===t.length&&(t=this.components.transportManager.getAddrs().map((t=>t.toString()))),t=t.concat(this.getObservedAddrs().map((t=>t.toString())));const e=new Set(t);return this.announceFilter(Array.from(e).map((t=>(0,$.HM)(t)))).map((t=>!0===t.protos().pop()?.path||t.getPeerId()===this.components.peerId.toString()?t:t.encapsulate(`/p2p/${this.components.peerId.toString()}`)))}}const Tp=(0,i.kg)("libp2p:connection-manager:latency-monitor:visibility-change-emitter");class Ap extends pp.v{constructor(){super(),this.hidden="hidden",this.visibilityChange="visibilityChange",null!=globalThis.document&&(this._initializeVisibilityVarNames(),this._addVisibilityChangeListener())}_initializeVisibilityVarNames(){let t="hidden",e="visibilitychange";void 0!==globalThis.document.hidden?(t="hidden",e="visibilitychange"):void 0!==globalThis.document.mozHidden?(t="mozHidden",e="mozvisibilitychange"):void 0!==globalThis.document.msHidden?(t="msHidden",e="msvisibilitychange"):void 0!==globalThis.document.webkitHidden&&(t="webkitHidden",e="webkitvisibilitychange"),this.hidden=t,this.visibilityChange=e}_addVisibilityChangeListener(){void 0===globalThis.document.addEventListener||void 0===document[this.hidden]?Tp("Checking page visibility requires a browser that supports the Page Visibility API."):globalThis.document.addEventListener(this.visibilityChange,this._handleVisibilityChange.bind(this),!1)}isVisible(){if(void 0!==this.hidden&&void 0!==document[this.hidden])return null==document[this.hidden]}_handleVisibilityChange(){const t=!1===globalThis.document[this.hidden];Tp(t?"Page Visible":"Page Hidden"),this.dispatchEvent(new pp.A("visibilityChange",{detail:t}))}}const Ip=(0,i.kg)("libp2p:connection-manager:latency-monitor");class Dp extends pp.v{constructor(t={}){super();const{latencyCheckIntervalMs:e,dataEmitIntervalMs:n,asyncTestFn:r,latencyRandomPercentage:s}=t;this.latencyCheckIntervalMs=e??500,this.latencyRandomPercentage=s??10,this.latencyCheckMultiply=this.latencyRandomPercentage/100*2*this.latencyCheckIntervalMs,this.latencyCheckSubtract=this.latencyCheckMultiply/2,this.dataEmitIntervalMs=null===n||0===n?void 0:n??5e3,Ip("latencyCheckIntervalMs: %s dataEmitIntervalMs: %s",this.latencyCheckIntervalMs,this.dataEmitIntervalMs),null!=this.dataEmitIntervalMs?Ip("Expecting ~%s events per summary",this.latencyCheckIntervalMs/this.dataEmitIntervalMs):Ip("Not emitting summaries"),this.asyncTestFn=r,null!=globalThis.process?.hrtime?(Ip("Using process.hrtime for timing"),this.now=globalThis.process.hrtime,this.getDeltaMS=t=>{const e=this.now(t);return 1e3*e[0]+e[1]/1e6}):"undefined"!=typeof window&&null!=window.performance?.now?(Ip("Using performance.now for timing"),this.now=window.performance.now.bind(window.performance),this.getDeltaMS=t=>Math.round(this.now()-t)):(Ip("Using Date.now for timing"),this.now=Date.now,this.getDeltaMS=t=>this.now()-t),this.latencyData=this.initLatencyData()}start(){void 0!==globalThis.window&&(this.visibilityChangeEmitter=new Ap,this.visibilityChangeEmitter.addEventListener("visibilityChange",(t=>{const{detail:e}=t;e?this._startTimers():(this._emitSummary(),this._stopTimers())}))),!0===this.visibilityChangeEmitter?.isVisible()&&this._startTimers()}stop(){this._stopTimers()}_startTimers(){null==this.checkLatencyID&&(this.checkLatency(),null!=this.dataEmitIntervalMs&&(this.emitIntervalID=setInterval((()=>this._emitSummary()),this.dataEmitIntervalMs),"function"==typeof this.emitIntervalID.unref&&this.emitIntervalID.unref()))}_stopTimers(){null!=this.checkLatencyID&&(clearTimeout(this.checkLatencyID),this.checkLatencyID=void 0),null!=this.emitIntervalID&&(clearInterval(this.emitIntervalID),this.emitIntervalID=void 0)}_emitSummary(){const t=this.getSummary();t.events>0&&this.dispatchEvent(new pp.A("data",{detail:t}))}getSummary(){const t={events:this.latencyData.events,minMs:this.latencyData.minMs,maxMs:this.latencyData.maxMs,avgMs:this.latencyData.events>0?this.latencyData.totalMs/this.latencyData.events:Number.POSITIVE_INFINITY,lengthMs:this.getDeltaMS(this.latencyData.startTime)};return this.latencyData=this.initLatencyData(),Ip.trace("Summary: %O",t),t}checkLatency(){const t=Math.random()*this.latencyCheckMultiply-this.latencyCheckSubtract,e={deltaOffset:Math.ceil(this.latencyCheckIntervalMs+t),startTime:this.now()},n=()=>{if(null==this.checkLatencyID)return;const t=this.getDeltaMS(e.startTime)-e.deltaOffset;this.checkLatency(),this.latencyData.events++,this.latencyData.minMs=Math.min(this.latencyData.minMs,t),this.latencyData.maxMs=Math.max(this.latencyData.maxMs,t),this.latencyData.totalMs+=t,Ip.trace("MS: %s Data: %O",t,this.latencyData)};Ip.trace("localData: %O",e),this.checkLatencyID=setTimeout((()=>{null!=this.asyncTestFn?(e.deltaOffset=0,e.startTime=this.now(),this.asyncTestFn(n)):(e.deltaOffset-=1,n())}),e.deltaOffset),"function"==typeof this.checkLatencyID.unref&&this.checkLatencyID.unref()}initLatencyData(){return{startTime:this.now(),minMs:Number.POSITIVE_INFINITY,maxMs:Number.NEGATIVE_INFINITY,events:0,totalMs:0}}}var Pp=n(80486);function Np(t,e){const n={[Symbol.iterator]:()=>n,next:()=>{const n=t.next(),r=n.value;if(!0===n.done||null==r){return{done:!0,value:void 0}}return{done:!1,value:e(r)}}};return n}class Op{constructor(t){if(this.map=new Map,null!=t)for(const[e,n]of t.entries())this.map.set(e.toString(),n)}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(t){this.map.delete(t.toString())}entries(){return Np(this.map.entries(),(t=>[(0,Ne.jE)(t[0]),t[1]]))}forEach(t){this.map.forEach(((e,n)=>{t(e,(0,Ne.jE)(n),this)}))}get(t){return this.map.get(t.toString())}has(t){return this.map.has(t.toString())}set(t,e){this.map.set(t.toString(),e)}keys(){return Np(this.map.keys(),(t=>(0,Ne.jE)(t)))}values(){return this.map.values()}get size(){return this.map.size}}class Lp{constructor(t){if(this.set=new Set,null!=t)for(const e of t)this.set.add(e.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(t){this.set.add(t.toString())}clear(){this.set.clear()}delete(t){this.set.delete(t.toString())}entries(){return Np(this.set.entries(),(t=>{const e=(0,Ne.jE)(t[0]);return[e,e]}))}forEach(t){this.set.forEach((e=>{const n=(0,Ne.jE)(e);t(n,n,this)}))}has(t){return this.set.has(t.toString())}values(){return Np(this.set.values(),(t=>(0,Ne.jE)(t)))}intersection(t){const e=new Lp;for(const n of t)this.has(n)&&e.add(n);return e}difference(t){const e=new Lp;for(const n of this)t.has(n)||e.add(n);return e}union(t){const e=new Lp;for(const n of t)e.add(n);for(const t of this)e.add(t);return e}}class Cp{constructor(t){if(this.list=[],null!=t)for(const e of t)this.list.push(e.toString())}[Symbol.iterator](){return mapIterable(this.list.entries(),(t=>peerIdFromString(t[1])))}concat(t){const e=new Cp(this);for(const n of t)e.push(n);return e}entries(){return mapIterable(this.list.entries(),(t=>[t[0],peerIdFromString(t[1])]))}every(t){return this.list.every(((e,n)=>t(peerIdFromString(e),n,this)))}filter(t){const e=new Cp;return this.list.forEach(((n,r)=>{const s=peerIdFromString(n);t(s,r,this)&&e.push(s)})),e}find(t){const e=this.list.find(((e,n)=>t(peerIdFromString(e),n,this)));if(null!=e)return peerIdFromString(e)}findIndex(t){return this.list.findIndex(((e,n)=>t(peerIdFromString(e),n,this)))}forEach(t){this.list.forEach(((e,n)=>{t(peerIdFromString(e),n,this)}))}includes(t){return this.list.includes(t.toString())}indexOf(t){return this.list.indexOf(t.toString())}pop(){const t=this.list.pop();if(null!=t)return peerIdFromString(t)}push(...t){for(const e of t)this.list.push(e.toString())}shift(){const t=this.list.shift();if(null!=t)return peerIdFromString(t)}unshift(...t){let e=this.list.length;for(let e=t.length-1;e>-1;e--)this.list.unshift(t[e].toString());return e}get length(){return this.list.length}}var Mp=n(43710),xp=n(8558);function Bp(t){if((0,ze.I)(t))return{peerId:t};if((0,$.h2)(t)){const e=t.getPeerId();return{multiaddr:t,peerId:null==e?void 0:(0,Ne.jE)(e)}}throw a(new Error(`${t} is not a PeerId or a Multiaddr`),dp.ERR_INVALID_MULTIADDR)}const zp=(0,i.kg)("libp2p:connection-manager"),Up={maxConnections:1/0,minConnections:0,maxEventLoopDelay:1/0,pollInterval:2e3,autoDialInterval:1e4,inboundConnectionThreshold:5,maxIncomingPendingConnections:10};class jp extends pp.v{constructor(t,e){if(super(),this.opts=s.Z.call({ignoreUndefined:!0},Up,e),this.opts.maxConnections<this.opts.minConnections)throw a(new Error("Connection Manager maxConnections must be greater than minConnections"),dp.ERR_INVALID_PARAMETERS);zp("options: %o",this.opts),this.components=t,this.connections=new Map,this.started=!1,null!=e.maxEventLoopDelay&&e.maxEventLoopDelay>0&&e.maxEventLoopDelay!==1/0&&(this.latencyMonitor=new Dp({latencyCheckIntervalMs:e.pollInterval,dataEmitIntervalMs:e.pollInterval}));try{(0,Ep.setMaxListeners)?.(1/0,this)}catch{}this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.startupReconnectTimeout=e.startupReconnectTimeout??6e4,this.dialTimeout=e.dialTimeout??3e4,this.allow=(e.allow??[]).map((t=>(0,$.HM)(t))),this.deny=(e.deny??[]).map((t=>(0,$.HM)(t))),this.inboundConnectionRateLimiter=new xp.RateLimiterMemory({points:this.opts.inboundConnectionThreshold,duration:1}),this.incomingPendingConnections=0}isStarted(){return this.started}async start(){this.components.metrics?.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{const t={inbound:0,outbound:0};for(const e of this.connections.values())for(const n of e)"inbound"===n.stat.direction?t.inbound++:t.outbound++;return t}}),this.components.metrics?.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{const t={};for(const e of this.connections.values())for(const n of e)for(const e of n.streams){const n=`${e.stat.direction} ${e.stat.protocol??"unnegotiated"}`;t[n]=(t[n]??0)+1}return t}}),this.components.metrics?.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{const t={};for(const e of this.connections.values())for(const n of e){const e={};for(const t of n.streams){const n=`${t.stat.direction} ${t.stat.protocol??"unnegotiated"}`;e[n]=(e[n]??0)+1}for(const[n,r]of Object.entries(e))t[n]=t[n]??[],t[n].push(r)}const e={};for(let[n,r]of Object.entries(t)){r=r.sort(((t,e)=>t-e));const t=Math.floor(.9*r.length);e[n]=r[t]}return e}}),this.latencyMonitor?.start(),this._onLatencyMeasure=this._onLatencyMeasure.bind(this),this.latencyMonitor?.addEventListener("data",this._onLatencyMeasure),this.started=!0,zp("started")}async afterStart(){this.components.upgrader.addEventListener("connection",this.onConnect),this.components.upgrader.addEventListener("connectionEnd",this.onDisconnect),Promise.resolve().then((async()=>{const t=[];for(const e of await this.components.peerStore.all()){(await this.components.peerStore.getTags(e.id)).filter((t=>t.name===Mp.$)).length>0&&t.push(e.id)}this.connectOnStartupController?.clear(),this.connectOnStartupController=new B.TimeoutController(this.startupReconnectTimeout);try{(0,Ep.setMaxListeners)?.(1/0,this.connectOnStartupController.signal)}catch{}await Promise.all(t.map((async t=>{await this.openConnection(t,{signal:this.connectOnStartupController?.signal}).catch((t=>{zp.error(t)}))})))})).catch((t=>{zp.error(t)})).finally((()=>{this.connectOnStartupController?.clear()}))}async beforeStop(){this.connectOnStartupController?.abort(),this.components.upgrader.removeEventListener("connection",this.onConnect),this.components.upgrader.removeEventListener("connectionEnd",this.onDisconnect)}async stop(){this.latencyMonitor?.removeEventListener("data",this._onLatencyMeasure),this.latencyMonitor?.stop(),this.started=!1,await this._close(),zp("stopped")}async _close(){const t=[];for(const e of this.connections.values())for(const n of e)t.push((async()=>{try{await n.close()}catch(t){zp.error(t)}})());zp("closing %d connections",t.length),await Promise.all(t),this.connections.clear()}onConnect(t){this._onConnect(t).catch((t=>{zp.error(t)}))}async _onConnect(t){const{detail:e}=t;if(!this.started)return void await e.close();const n=e.remotePeer,r=n.toString(),s=this.connections.get(r);null!=s?s.push(e):this.connections.set(r,[e]),null!=n.publicKey&&await this.components.peerStore.keyBook.set(n,n.publicKey);const o=this.getConnections().length,i=o-this.opts.maxConnections;await this._checkMaxLimit("maxConnections",o,i),this.dispatchEvent(new pp.A("peer:connect",{detail:e}))}onDisconnect(t){const{detail:e}=t;if(!this.started)return;const n=e.remotePeer.toString();let r=this.connections.get(n);null!=r&&r.length>1?(r=r.filter((t=>t.id!==e.id)),this.connections.set(n,r)):null!=r&&(this.connections.delete(n),this.dispatchEvent(new pp.A("peer:disconnect",{detail:e})))}getConnections(t){if(null!=t)return this.connections.get(t.toString())??[];let e=[];for(const t of this.connections.values())e=e.concat(t);return e}async openConnection(t,e={}){const{peerId:n,multiaddr:r}=Bp(t);if(null==n&&null==r)throw a(new TypeError("Can only open connections to PeerIds or Multiaddrs"),dp.ERR_INVALID_PARAMETERS);if(null!=n){zp("dial to",n);const t=this.getConnections(n);if(t.length>0)return zp("had an existing connection to %p",n),t[0]}let s;if(null==e?.signal){s=new B.TimeoutController(this.dialTimeout),e.signal=s.signal;try{(0,Ep.setMaxListeners)?.(1/0,s.signal)}catch{}}try{const n=await this.components.dialer.dial(t,e);let r=this.connections.get(n.remotePeer.toString());null==r&&(r=[],this.connections.set(n.remotePeer.toString(),r));let s=!1;for(const t of r)t.id===n.id&&(s=!0);return s||r.push(n),n}finally{null!=s&&s.clear()}}async closeConnections(t){const e=this.connections.get(t.toString())??[];await Promise.all(e.map((async t=>await t.close())))}getAll(t){if(!(0,ze.I)(t))throw a(new Error("peerId must be an instance of peer-id"),dp.ERR_INVALID_PARAMETERS);const e=t.toString(),n=this.connections.get(e);return null!=n?n.filter((t=>t.stat.status===Pp.o1)):[]}_onLatencyMeasure(t){const{detail:e}=t;this._checkMaxLimit("maxEventLoopDelay",e.avgMs,1).catch((t=>{zp.error(t)}))}async _checkMaxLimit(t,e,n=1){const r=this.opts[t];null!=r?(zp.trace("checking limit of %s. current value: %d of %d",t,e,r),e>r&&(zp("%s: limit exceeded: %p, %d/%d, pruning %d connection(s)",this.components.peerId,t,e,r,n),await this._pruneConnections(n))):zp.trace("limit %s was not set so it cannot be applied",t)}async _pruneConnections(t){const e=this.getConnections(),n=new Op;for(const t of e){const e=t.remotePeer;if(n.has(e))continue;const r=await this.components.peerStore.getTags(e);n.set(e,r.reduce(((t,e)=>t+e.value),0))}const r=e.sort(((t,e)=>{const r=n.get(t.remotePeer)??0,s=n.get(e.remotePeer)??0;if(r>s)return 1;if(r<s)return-1;const o=t.stat.timeline.open,i=e.stat.timeline.open;return o<i?1:o>i?-1:0})),s=[];for(const e of r)if(zp("too many connections open - closing a connection to %p",e.remotePeer),s.push(e),s.length===t)break;await Promise.all(s.map((async t=>{try{await t.close()}catch(t){zp.error(t)}this.onDisconnect(new pp.A("connectionEnd",{detail:t}))})))}async acceptIncomingConnection(t){if(this.deny.some((e=>t.remoteAddr.toString().startsWith(e.toString()))))return zp("connection from %s refused - connection remote address was in deny list",t.remoteAddr),!1;if(this.allow.some((e=>t.remoteAddr.toString().startsWith(e.toString()))))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.opts.maxIncomingPendingConnections)return zp("connection from %s refused - incomingPendingConnections exceeded by peer %s",t.remoteAddr),!1;if(t.remoteAddr.isThinWaistAddress()){const e=t.remoteAddr.nodeAddress().address;try{await this.inboundConnectionRateLimiter.consume(e,1)}catch{return zp("connection from %s refused - inboundConnectionThreshold exceeded by host %s",e,t.remoteAddr),!1}}return this.getConnections().length<this.opts.maxConnections?(this.incomingPendingConnections++,!0):(zp("connection from %s refused - maxConnections exceeded",t.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}}var $p=n(82916),Vp=n(34751);const Hp=(0,i.kg)("libp2p:connection-manager:auto-dialler"),Fp={enabled:!0,minConnections:0,autoDialInterval:1e4};class Kp{constructor(t,e){this.components=t,this.options=s.Z.call({ignoreUndefined:!0},Fp,e),this.running=!1,this._autoDial=this._autoDial.bind(this),Hp("options: %j",this.options)}isStarted(){return this.running}async start(){this.options.enabled?(this.running=!0,this._autoDial().catch((t=>{Hp.error("could start autodial",t)})),Hp("started")):Hp("not enabled")}async stop(){this.options.enabled?(this.running=!1,null!=this.autoDialTimeout&&this.autoDialTimeout.clear(),Hp("stopped")):Hp("not enabled")}async _autoDial(){null!=this.autoDialTimeout&&this.autoDialTimeout.clear();const t=this.options.minConnections;if(this.components.connectionManager.getConnections().length>=t)return void(this.autoDialTimeout=$p(this._autoDial,this.options.autoDialInterval));const e=await this.components.peerStore.all(),n=await Gs(e.sort((()=>Math.random()>.5?1:-1)),(t=>(0,Mn.Z)(t,(t=>!t.id.equals(this.components.peerId)))),(t=>(0,Vp.Z)(t,((t,e)=>e.protocols.length>t.protocols.length||null!=e.id.publicKey&&null==t.id.publicKey?1:-1))),(async t=>await On(t)));for(let e=0;this.running&&e<n.length&&this.components.connectionManager.getConnections().length<t;e++){if(!this.running)return;const t=n[e];if(0===this.components.connectionManager.getConnections(t.id).length){Hp("connecting to a peerStore stored peer %p",t.id);try{await this.components.connectionManager.openConnection(t.id)}catch(t){Hp.error("could not connect to peerStore stored peer",t)}}}this.running&&(this.autoDialTimeout=$p(this._autoDial,this.options.autoDialInterval))}}var qp=n(96115),Gp=n(86890),Wp=n(40834),Zp=n(88832),Yp=n(27957);Yp._configure(),qp._configure(Gp),Wp._configure(Zp);const Jp=["uint64","int64","sint64","fixed64","sfixed64"];function Qp(t){return function(t){for(const e of Jp){if(null==t[e])continue;const n=t[e];t[e]=function(){return BigInt(n.call(this).toString())}}return t}(new qp(t))}function Xp(){return function(t){for(const e of Jp){if(null==t[e])continue;const n=t[e];t[e]=function(t){return n.call(this,t.toString())}}return t}(Wp.create())}function tf(t,e){const n=Qp(t instanceof Uint8Array?t:t.subarray());return e.decode(n)}function ef(t,e){const n=Xp();return e.encode(t,n,{lengthDelimited:!1}),n.finish()}var nf,rf;function sf(t,e,n,r){return{name:t,type:e,encode:n,decode:r}}function of(t){function e(e){if(null==t[e.toString()])throw new Error("Invalid enum value");return t[e]}return sf("enum",nf.VARINT,(function(t,n){const r=e(t);n.int32(r)}),(function(t){return e(t.int32())}))}function af(t,e){return sf("message",nf.LENGTH_DELIMITED,t,e)}!function(t){t[t.VARINT=0]="VARINT",t[t.BIT64=1]="BIT64",t[t.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",t[t.START_GROUP=3]="START_GROUP",t[t.END_GROUP=4]="END_GROUP",t[t.BIT32=5]="BIT32"}(nf||(nf={})),function(t){let e,n,r,s,o,i;!function(t){t.SUCCESS="SUCCESS",t.HOP_SRC_ADDR_TOO_LONG="HOP_SRC_ADDR_TOO_LONG",t.HOP_DST_ADDR_TOO_LONG="HOP_DST_ADDR_TOO_LONG",t.HOP_SRC_MULTIADDR_INVALID="HOP_SRC_MULTIADDR_INVALID",t.HOP_DST_MULTIADDR_INVALID="HOP_DST_MULTIADDR_INVALID",t.HOP_NO_CONN_TO_DST="HOP_NO_CONN_TO_DST",t.HOP_CANT_DIAL_DST="HOP_CANT_DIAL_DST",t.HOP_CANT_OPEN_DST_STREAM="HOP_CANT_OPEN_DST_STREAM",t.HOP_CANT_SPEAK_RELAY="HOP_CANT_SPEAK_RELAY",t.HOP_CANT_RELAY_TO_SELF="HOP_CANT_RELAY_TO_SELF",t.STOP_SRC_ADDR_TOO_LONG="STOP_SRC_ADDR_TOO_LONG",t.STOP_DST_ADDR_TOO_LONG="STOP_DST_ADDR_TOO_LONG",t.STOP_SRC_MULTIADDR_INVALID="STOP_SRC_MULTIADDR_INVALID",t.STOP_DST_MULTIADDR_INVALID="STOP_DST_MULTIADDR_INVALID",t.STOP_RELAY_REFUSED="STOP_RELAY_REFUSED",t.MALFORMED_MESSAGE="MALFORMED_MESSAGE"}(e=t.Status||(t.Status={})),function(t){t[t.SUCCESS=100]="SUCCESS",t[t.HOP_SRC_ADDR_TOO_LONG=220]="HOP_SRC_ADDR_TOO_LONG",t[t.HOP_DST_ADDR_TOO_LONG=221]="HOP_DST_ADDR_TOO_LONG",t[t.HOP_SRC_MULTIADDR_INVALID=250]="HOP_SRC_MULTIADDR_INVALID",t[t.HOP_DST_MULTIADDR_INVALID=251]="HOP_DST_MULTIADDR_INVALID",t[t.HOP_NO_CONN_TO_DST=260]="HOP_NO_CONN_TO_DST",t[t.HOP_CANT_DIAL_DST=261]="HOP_CANT_DIAL_DST",t[t.HOP_CANT_OPEN_DST_STREAM=262]="HOP_CANT_OPEN_DST_STREAM",t[t.HOP_CANT_SPEAK_RELAY=270]="HOP_CANT_SPEAK_RELAY",t[t.HOP_CANT_RELAY_TO_SELF=280]="HOP_CANT_RELAY_TO_SELF",t[t.STOP_SRC_ADDR_TOO_LONG=320]="STOP_SRC_ADDR_TOO_LONG",t[t.STOP_DST_ADDR_TOO_LONG=321]="STOP_DST_ADDR_TOO_LONG",t[t.STOP_SRC_MULTIADDR_INVALID=350]="STOP_SRC_MULTIADDR_INVALID",t[t.STOP_DST_MULTIADDR_INVALID=351]="STOP_DST_MULTIADDR_INVALID",t[t.STOP_RELAY_REFUSED=390]="STOP_RELAY_REFUSED",t[t.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE"}(n||(n={})),function(t){t.codec=()=>of(n)}(e=t.Status||(t.Status={})),function(t){t.HOP="HOP",t.STOP="STOP",t.STATUS="STATUS",t.CAN_HOP="CAN_HOP"}(r=t.Type||(t.Type={})),function(t){t[t.HOP=1]="HOP",t[t.STOP=2]="STOP",t[t.STATUS=3]="STATUS",t[t.CAN_HOP=4]="CAN_HOP"}(s||(s={})),function(t){t.codec=()=>of(s)}(r=t.Type||(t.Type={})),function(t){let e;t.codec=()=>(null==e&&(e=af(((t,e,n={})=>{if(!1!==n.lengthDelimited&&e.fork(),(!0===n.writeDefaults||null!=t.id&&t.id.byteLength>0)&&(e.uint32(10),e.bytes(t.id)),null!=t.addrs)for(const n of t.addrs)e.uint32(18),e.bytes(n);!1!==n.lengthDelimited&&e.ldelim()}),((t,e)=>{const n={id:new Uint8Array(0),addrs:[]},r=null==e?t.len:t.pos+e;for(;t.pos<r;){const e=t.uint32();switch(e>>>3){case 1:n.id=t.bytes();break;case 2:n.addrs.push(t.bytes());break;default:t.skipType(7&e)}}return n}))),e),t.encode=e=>ef(e,t.codec()),t.decode=e=>tf(e,t.codec())}(o=t.Peer||(t.Peer={})),t.codec=()=>(null==i&&(i=af(((e,n,r={})=>{!1!==r.lengthDelimited&&n.fork(),null!=e.type&&(n.uint32(8),t.Type.codec().encode(e.type,n)),null!=e.srcPeer&&(n.uint32(18),t.Peer.codec().encode(e.srcPeer,n,{writeDefaults:!1})),null!=e.dstPeer&&(n.uint32(26),t.Peer.codec().encode(e.dstPeer,n,{writeDefaults:!1})),null!=e.code&&(n.uint32(32),t.Status.codec().encode(e.code,n)),!1!==r.lengthDelimited&&n.ldelim()}),((e,n)=>{const r={},s=null==n?e.len:e.pos+n;for(;e.pos<s;){const n=e.uint32();switch(n>>>3){case 1:r.type=t.Type.codec().decode(e);break;case 2:r.srcPeer=t.Peer.codec().decode(e,e.uint32());break;case 3:r.dstPeer=t.Peer.codec().decode(e,e.uint32());break;case 4:r.code=t.Status.codec().decode(e);break;default:e.skipType(7&n)}}return r}))),i),t.encode=e=>ef(e,t.codec()),t.decode=e=>tf(e,t.codec())}(rf||(rf={}));var cf=n(66146);const lf="/libp2p/circuit/relay/0.1.0";function uf(t,e){t.write({type:rf.Type.STATUS,code:e})}function df(t,e){try{null!=t.dstPeer?.addrs&&t.dstPeer.addrs.forEach((t=>(0,$.HM)(t)))}catch(n){throw uf(e,t.type===rf.Type.HOP?rf.Status.HOP_DST_MULTIADDR_INVALID:rf.Status.STOP_DST_MULTIADDR_INVALID),n}try{null!=t.srcPeer?.addrs&&t.srcPeer.addrs.forEach((t=>(0,$.HM)(t)))}catch(n){throw uf(e,t.type===rf.Type.HOP?rf.Status.HOP_SRC_MULTIADDR_INVALID:rf.Status.STOP_SRC_MULTIADDR_INVALID),n}}var hf=n(72004),pf=n(66574);const ff=Math.pow(2,7),yf=Math.pow(2,14),gf=Math.pow(2,21),wf=Math.pow(2,28),mf=Math.pow(2,35),bf=Math.pow(2,42),Ef=Math.pow(2,49),_f=Math.pow(2,56),vf=Math.pow(2,63),kf={encodingLength:t=>t<ff?1:t<yf?2:t<gf?3:t<wf?4:t<mf?5:t<bf?6:t<Ef?7:t<_f?8:t<vf?9:10,encode(t,e,n=0){if(null!=Number.MAX_SAFE_INTEGER&&t>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return null==e&&(e=(0,pf.E)(kf.encodingLength(t))),hf.Z.fromNumber(t).toBytes(e,n),e},decode:(t,e=0)=>hf.Z.fromBytes(t,e).toNumber(!0)};const Rf=t=>{const e=kf.encodingLength(t),n=(r=e,null!=globalThis?.Buffer?.allocUnsafe?globalThis.Buffer.allocUnsafe(r):new Uint8Array(r));var r;return kf.encode(t,n),Rf.bytes=e,n};function Sf(t){const e=(t=t??{}).lengthEncoder??Rf;return async function*(t){for await(const n of t){const t=e(n.byteLength);t instanceof Uint8Array?yield t:yield*t,n instanceof Uint8Array?yield n:yield*n}}}Rf.bytes=0,Sf.single=(t,e)=>{const n=(e=e??{}).lengthEncoder??Rf;return new Po.H(n(t.byteLength),t)};const Tf=8,Af=4194304;var If;!function(t){t[t.LENGTH=0]="LENGTH",t[t.DATA=1]="DATA"}(If||(If={}));const Df=t=>{const e=kf.decode(t);return Df.bytes=kf.encodingLength(e),e};function Pf(t){return async function*(e){const n=new Po.H;let r=If.LENGTH,s=-1;const o=t?.lengthDecoder??Df,i=t?.maxLengthLength??Tf,c=t?.maxDataLength??Af;for await(const l of e)for(n.append(l);n.byteLength>0;){if(r===If.LENGTH)try{if(s=o(n),s<0)throw a(new Error("invalid message length"),"ERR_INVALID_MSG_LENGTH");if(s>c)throw a(new Error("message length too long"),"ERR_MSG_DATA_TOO_LONG");const e=o.bytes;n.consume(e),null!=t?.onLength&&t.onLength(s),r=If.DATA}catch(t){if(t instanceof RangeError){if(n.byteLength>i)throw a(new Error("message length length too long"),"ERR_MSG_LENGTH_TOO_LONG");break}throw t}if(r===If.DATA){if(n.byteLength<s)break;const e=n.sublist(0,s);n.consume(s),null!=t?.onData&&t.onData(e),yield e,r=If.LENGTH}}if(n.byteLength>0)throw a(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}}Df.bytes=0,Pf.fromReader=(t,e)=>{let n=1;const r=async function*(){for(;;)try{const{done:e,value:r}=await t.next(n);if(!0===e)return;null!=r&&(yield r)}catch(t){if("ERR_UNDER_READ"===t.code)return{done:!0,value:null};throw t}finally{n=1}}();return Pf({...e??{},onLength:t=>{n=t}})(r)};var Nf=n(51816);const Of=(0,i.kg)("libp2p:circuit:stream-handler");class Lf{constructor(t){const{stream:e,maxLength:n=4096}=t;this.stream=e,this.shake=(0,Nf.Y)(this.stream),this.decoder=Pf.fromReader(this.shake.reader,{maxDataLength:n})}async read(){const t=await this.decoder.next();if(null!=t.value){const e=rf.decode(t.value);return Of("read message type",e.type),e}Of("read received no value, closing stream"),this.close()}write(t){Of("write message type %s",t.type),this.shake.write(Sf.single(rf.encode(t)))}rest(){return this.shake.rest(),this.shake.stream}end(t){this.write(t),this.close()}close(){Of("closing the stream"),this.rest().sink([]).catch((t=>{Of.error(t)}))}}const Cf=(0,i.kg)("libp2p:circuit:stop");const Mf=(0,i.kg)("libp2p:circuit:hop");async function xf(t){const{connection:e,request:n,streamHandler:r,circuit:s,connectionManager:o}=t;if(!s.hopEnabled())return Mf("HOP request received but we are not acting as a relay"),r.end({type:rf.Type.STATUS,code:rf.Status.HOP_CANT_SPEAK_RELAY});try{df(n,r)}catch(t){return void Mf.error("invalid hop request via peer %p %o",e.remotePeer,t)}if(null==n.dstPeer)return void Mf("HOP request received but we do not receive a dstPeer");const i=(0,Ne.cv)(n.dstPeer.id),a=o.getConnections(i);if(0===a.length&&!s.hopActive())return Mf("HOP request received but we are not connected to the destination peer"),r.end({type:rf.Type.STATUS,code:rf.Status.HOP_NO_CONN_TO_DST});if(0===a.length)return Mf("did not have connection to remote peer"),r.end({type:rf.Type.STATUS,code:rf.Status.HOP_NO_CONN_TO_DST});const c={type:rf.Type.STOP,dstPeer:n.dstPeer,srcPeer:n.srcPeer};let l;try{Mf("performing STOP request");const t=await async function(t){const{connection:e,request:n,signal:r}=t,s=await e.newStream(lf,{signal:r});Cf("starting stop request to %p",e.remotePeer);const o=new Lf({stream:s});o.write(n);const i=await o.read();if(null!=i){if(i.code===rf.Status.SUCCESS)return Cf("stop request to %p was successful",e.remotePeer),o.rest();Cf("stop request failed with code %d",i.code),o.close()}else o.close()}({connection:a[0],request:c});if(null==t)throw new Error("Could not stop");l=t}catch(t){return void Mf.error(t)}Mf("hop request from %p is valid",e.remotePeer),r.write({type:rf.Type.STATUS,code:rf.Status.SUCCESS});const u=r.rest();return Mf("creating related connections"),await Gs(u,l,u)}var Bf=n(12348),zf=n(28391);const Uf=(0,i.kg)("libp2p:circuit");class jf{constructor(t,e){this._init=e,this.components=t,this._started=!1}isStarted(){return this._started}async start(){this._started||(this._started=!0,await this.components.registrar.handle(lf,(t=>{this._onProtocol(t).catch((t=>{Uf.error(t)}))}),{...this._init}).catch((t=>{Uf.error(t)})))}async stop(){await this.components.registrar.unhandle(lf)}hopEnabled(){return!0}hopActive(){return!0}get[Bf.NA](){return!0}get[Symbol.toStringTag](){return"libp2p/circuit-relay-v1"}async _onProtocol(t){const{connection:e,stream:n}=t,r=new B.TimeoutController(this._init.hop.timeout);try{(0,Ep.setMaxListeners)?.(1/0,r.signal)}catch{}try{const t=(0,zf.D7)(n,r.signal),s=new Lf({stream:{...n,...t}}),o=await s.read();if(null==o)return Uf("request was invalid, could not read from stream"),s.write({type:rf.Type.STATUS,code:rf.Status.MALFORMED_MESSAGE}),void s.close();let i;switch(o.type){case rf.Type.CAN_HOP:Uf("received CAN_HOP request from %p",e.remotePeer),await function(t){const{connection:e,streamHandler:n,circuit:r}=t,s=r.hopEnabled();Mf("can hop (%s) request from %p",s,e.remotePeer),n.end({type:rf.Type.STATUS,code:s?rf.Status.SUCCESS:rf.Status.HOP_CANT_SPEAK_RELAY})}({circuit:this,connection:e,streamHandler:s});break;case rf.Type.HOP:Uf("received HOP request from %p",e.remotePeer),await xf({connection:e,request:o,streamHandler:s,circuit:this,connectionManager:this.components.connectionManager});break;case rf.Type.STOP:Uf("received STOP request from %p",e.remotePeer),i=await function(t){const{connection:e,request:n,streamHandler:r}=t;try{df(n,r)}catch(t){return void Cf.error("invalid stop request via peer %p %o",e.remotePeer,t)}return Cf("stop request is valid"),r.write({type:rf.Type.STATUS,code:rf.Status.SUCCESS}),r.rest()}({connection:e,request:o,streamHandler:s});break;default:return Uf("Request of type %s not supported",o.type),s.write({type:rf.Type.STATUS,code:rf.Status.MALFORMED_MESSAGE}),void s.close()}if(null!=i){const t=e.remoteAddr.encapsulate("/p2p-circuit").encapsulate((0,$.HM)(o.dstPeer?.addrs[0])),n=(0,$.HM)(o.srcPeer?.addrs[0]),r=(0,cf.j)({stream:i,remoteAddr:t,localAddr:n}),s=o.type===rf.Type.HOP?"relay":"inbound";Uf("new %s connection %s",s,r.remoteAddr);const a=await this.components.upgrader.upgradeInbound(r);Uf("%s connection %s upgraded",s,r.remoteAddr),null!=this.handler&&this.handler(a)}}finally{r.clear()}}async dial(t,e={}){const n=t.toString().split("/p2p-circuit"),r=(0,$.HM)(n[0]),s=(0,$.HM)(n[n.length-1]),o=r.getPeerId(),i=s.getPeerId();if(null==o||null==i){const t="Circuit relay dial failed as addresses did not have peer id";throw Uf.error(t),a(new Error(t),dp.ERR_RELAYED_DIAL)}const c=(0,Ne.jE)(o),l=(0,Ne.jE)(i);let u=!1;let d=this.components.connectionManager.getConnections(c)[0];null==d&&(await this.components.peerStore.addressBook.add(c,[r]),d=await this.components.connectionManager.openConnection(c,e),u=!0);try{const n=await async function(t){const{connection:e,request:n,signal:r}=t,s=await e.newStream(lf,{signal:r}),o=new Lf({stream:s});o.write(n);const i=await o.read();if(null==i)throw a(new Error("HOP request had no response"),dp.ERR_HOP_REQUEST_FAILED);if(i.code===rf.Status.SUCCESS)return Mf("hop request was successful"),o.rest();throw Mf("hop request failed with code %d, closing stream",i.code),o.close(),a(new Error(`HOP request failed with code "${i.code??"unknown"}"`),dp.ERR_HOP_REQUEST_FAILED)}({...e,connection:d,request:{type:rf.Type.HOP,srcPeer:{id:this.components.peerId.toBytes(),addrs:this.components.addressManager.getAddresses().map((t=>t.bytes))},dstPeer:{id:l.toBytes(),addrs:[(0,$.HM)(s).bytes]}}}),o=r.encapsulate(`/p2p-circuit/p2p/${this.components.peerId.toString()}`),i=(0,cf.j)({stream:n,remoteAddr:t,localAddr:o});return Uf("new outbound connection %s",i.remoteAddr),await this.components.upgrader.upgradeOutbound(i)}catch(t){throw Uf.error("Circuit relay dial failed",t),u&&await d.close(),t}}createListener(t){return this.handler=t.handler,function(t){const e=new Map,n=Object.assign(new pp.v,{close:async()=>await Promise.resolve(),listen:async function(r){const s=r.toString().split("/p2p-circuit").find((t=>""!==t)),o=(0,$.HM)(s),i=o.getPeerId();if(null==i)throw new Error("Could not determine relay peer from multiaddr");const a=(0,Ne.jE)(i);await t.peerStore.addressBook.add(a,[o]);const c=await t.connectionManager.openConnection(a),l=c.remoteAddr.encapsulate("/p2p-circuit");e.set(c.remotePeer.toString(),l),n.dispatchEvent(new pp.A("listening"))},getAddrs:function(){const t=[];for(const n of e.values())t.push(n);return t}});return t.connectionManager.addEventListener("peer:disconnect",(t=>{const{detail:r}=t;e.delete(r.remotePeer.toString())&&n.dispatchEvent(new pp.A("close"))})),n}({connectionManager:this.components.connectionManager,peerStore:this.components.peerStore})}filter(t){return(t=Array.isArray(t)?t:[t]).filter((t=>Ns.matches(t)))}}async function $f(t){const e=(new TextEncoder).encode(t),n=await Qs.sha256.digest(e);return Q.k0.createV0(n)}const Vf="hop_relay",Hf="true",Ff="/libp2p/relay";var Kf=n(37706);const qf=(0,i.kg)("libp2p:auto-relay"),Gf=()=>{};class Wf{constructor(t,e){this.components=t,this.addressSorter=e.addressSorter??Kf.F,this.maxListeners=e.maxListeners??1,this.listenRelays=new Set,this.onError=e.onError??Gf,this._onProtocolChange=this._onProtocolChange.bind(this),this._onPeerDisconnected=this._onPeerDisconnected.bind(this),this.components.peerStore.addEventListener("change:protocols",(t=>{this._onProtocolChange(t).catch((t=>{qf.error(t)}))})),this.components.connectionManager.addEventListener("peer:disconnect",this._onPeerDisconnected)}async _onProtocolChange(t){const{peerId:e,protocols:n}=t.detail,r=e.toString();if(null!=n.find((t=>t===lf))){if(!this.listenRelays.has(r))try{const t=this.components.connectionManager.getConnections(e);if(0===t.length)return;const n=t[0];if(n.remoteAddr.protoCodes().includes(290))return void qf(`relayed connection to ${r} will not be used to hop on`);const s=await async function(t){const{connection:e,signal:n}=t,r=await e.newStream(lf,{signal:n}),s=new Lf({stream:r});s.write({type:rf.Type.CAN_HOP});const o=await s.read();return await s.close(),null!=o&&o.code===rf.Status.SUCCESS}({connection:n});s&&(await this.components.peerStore.metadataBook.setValue(e,Vf,(0,x.m)(Hf)),await this._addListenRelay(n,r))}catch(t){this.onError(t)}}else this.listenRelays.has(r)&&await this._removeListenRelay(r)}_onPeerDisconnected(t){const e=t.detail.remotePeer.toString();this.listenRelays.has(e)&&this._removeListenRelay(e).catch((t=>{qf.error(t)}))}async _addListenRelay(t,e){try{if(this.listenRelays.size>=this.maxListeners)return;const n=await Gs(await this.components.peerStore.addressBook.get(t.remotePeer),(t=>(0,Vp.Z)(t,this.addressSorter)),(async t=>await On(t)));(await Promise.all(n.map((async e=>{try{let n=e.multiaddr;return null==n.getPeerId()&&(n=n.encapsulate(`/p2p/${t.remotePeer.toString()}`)),n=n.encapsulate("/p2p-circuit"),await this.components.transportManager.listen([n]),!0}catch(t){qf.error("error listening on circuit address",t),this.onError(t)}return!1})))).includes(!0)&&this.listenRelays.add(e)}catch(t){this.onError(t),this.listenRelays.delete(e)}}async _removeListenRelay(t){this.listenRelays.delete(t)&&await this._listenOnAvailableHopRelays([t])}async _listenOnAvailableHopRelays(t=[]){if(this.listenRelays.size>=this.maxListeners)return;const e=[],n=await this.components.peerStore.all();for(const{id:r,metadata:s}of n){const n=r.toString();if(this.listenRelays.has(n))continue;if(t.includes(n))continue;const o=s.get(Vf);if(null==o||(0,H.B)(o)!==Hf)continue;const i=this.components.connectionManager.getConnections(r);if(0!==i.length){if(await this._addListenRelay(i[0],n),this.listenRelays.size>=this.maxListeners)return}else e.push(r)}for(const t of e)if(await this._tryToListenOnRelay(t),this.listenRelays.size>=this.maxListeners)return;try{const t=await $f(Ff);for await(const e of this.components.contentRouting.findProviders(t)){if(0===e.multiaddrs.length)continue;const t=e.id;if(!t.equals(this.components.peerId)&&(await this.components.peerStore.addressBook.add(t,e.multiaddrs),await this._tryToListenOnRelay(t),this.listenRelays.size>=this.maxListeners))return}}catch(t){this.onError(t)}}async _tryToListenOnRelay(t){try{const e=await this.components.connectionManager.openConnection(t);await this._addListenRelay(e,t.toString())}catch(e){qf.error("Could not use %p as relay",t,e),this.onError(e,`could not connect and listen on known hop relay ${t.toString()}`)}}}const Zf=(0,i.kg)("libp2p:relay");class Yf{constructor(t,e){this.components=t,this.autoRelay=!1!==e.autoRelay?.enabled?new Wf(t,{addressSorter:e.addressSorter,...e.autoRelay}):void 0,this.started=!1,this.init=e,this._advertiseService=this._advertiseService.bind(this)}isStarted(){return this.started}async start(){!1!==this.init.hop.enabled&&!1!==this.init.advertise.enabled&&(this.timeout=(0,bp.setDelayedInterval)(this._advertiseService,this.init.advertise.ttl,this.init.advertise.bootDelay)),this.started=!0}async stop(){null!=this.timeout&&(0,bp.clearDelayedInterval)(this.timeout),this.started=!1}async _advertiseService(){try{const t=await $f(Ff);await this.components.contentRouting.provide(t)}catch(t){t.code===dp.ERR_NO_ROUTERS_AVAILABLE?(Zf.error("a content router, such as a DHT, must be provided in order to advertise the relay service",t),await this.stop()):Zf.error(t)}}}var Jf=n(50202),Qf=(n(79437),n(97450),n(3832));n(25414);const Xf=Qf.pki;const ty=(0,i.kg)("libp2p:keychain:cms"),ey=new WeakMap;class ny{constructor(t,e){if(null==t)throw a(new Error("keychain is required"),dp.ERR_KEYCHAIN_REQUIRED);this.keychain=t,ey.set(this,{dek:e})}async encrypt(t,e){if(!(e instanceof Uint8Array))throw a(new Error("Plain data must be a Uint8Array"),dp.ERR_INVALID_PARAMETERS);const n=await this.keychain.findKeyByName(t),r=await this.keychain.getPrivateKey(t),s=ey.get(this);if(null==s)throw a(new Error("dek missing"),dp.ERR_INVALID_PARAMETERS);const o=s.dek,i=Qf.pki.decryptRsaPrivateKey(r,o),c=await((t,e)=>{const n=Xf.rsa.setPublicKey(e.n,e.e),r=Xf.createCertificate();r.publicKey=n,r.serialNumber="01",r.validity.notBefore=new Date,r.validity.notAfter=new Date,r.validity.notAfter.setFullYear(r.validity.notBefore.getFullYear()+10);const s=[{name:"organizationName",value:"ipfs"},{shortName:"OU",value:"keystore"},{name:"commonName",value:t.id}];return r.setSubject(s),r.setIssuer(s),r.setExtensions([{name:"basicConstraints",cA:!0},{name:"keyUsage",keyCertSign:!0,digitalSignature:!0,nonRepudiation:!0,keyEncipherment:!0,dataEncipherment:!0},{name:"extKeyUsage",serverAuth:!0,clientAuth:!0,codeSigning:!0,emailProtection:!0,timeStamping:!0},{name:"nsCertType",client:!0,server:!0,email:!0,objsign:!0,sslCA:!0,emailCA:!0,objCA:!0}]),r.sign(e),r})(n,i),l=Qf.pkcs7.createEnvelopedData();l.addRecipient(c),l.content=Qf.util.createBuffer(e),l.encrypt();const u=Qf.asn1.toDer(l.toAsn1()).getBytes();return(0,x.m)(u,"ascii")}async decrypt(t){if(!(t instanceof Uint8Array))throw a(new Error("CMS data is required"),dp.ERR_INVALID_PARAMETERS);let e;try{const n=Qf.util.createBuffer((0,H.B)(t,"ascii")),r=Qf.asn1.fromDer(n);e=Qf.pkcs7.messageFromAsn1(r)}catch(t){throw ty.error(t),a(new Error("Invalid CMS"),dp.ERR_INVALID_CMS)}const n=e.recipients.filter((t=>t.issuer.find((t=>"O"===t.shortName&&"ipfs"===t.value)))).filter((t=>t.issuer.find((t=>"CN"===t.shortName)))).map((t=>({recipient:t,keyId:t.issuer.find((t=>"CN"===t.shortName)).value}))),r=await async function(t,e){const n=t.map(e);return t[(await Promise.all(n)).findIndex((t=>t))]}(n,(async t=>{try{if(null!=await this.keychain.findKeyById(t.keyId))return!0}catch(t){return!1}return!1}));if(null==r){const t=n.map((t=>t.keyId));throw a(new Error(`Decryption needs one of the key(s): ${t.join(", ")}`),dp.ERR_MISSING_KEYS,{missingKeys:t})}const s=await this.keychain.findKeyById(r.keyId);if(null==s)throw a(new Error("No key available to decrypto"),dp.ERR_NO_KEY);const o=await this.keychain.getPrivateKey(s.name),i=ey.get(this);if(null==i)throw a(new Error("dek missing"),dp.ERR_INVALID_PARAMETERS);const c=i.dek,l=Qf.pki.decryptRsaPrivateKey(o,c);return e.decrypt(r.recipient,l),(0,x.m)(e.content.getBytes(),"ascii")}}var ry=n(79944);const sy=(0,i.kg)("libp2p:keychain"),oy="/info/",iy=new WeakMap,ay=14,cy=16,ly=1e3,uy={dek:{keyLength:64,iterationCount:1e4,salt:"you should override this value with a crypto secure random number",hash:"sha2-512"}};function dy(t){return null!=t&&("string"==typeof t&&(t===Jf(t.trim())&&t.length>0))}async function hy(){const t=800*Math.random()+200;await new Promise((e=>setTimeout(e,t)))}function py(t){return new be.s("/pkcs8/"+t)}function fy(t){return new be.s(oy+t)}class yy{constructor(t,e){if(this.components=t,this.init=(0,s.Z)(uy,e),null!=this.init.pass&&this.init.pass?.length<20)throw new Error("pass must be least 20 characters");if(null!=this.init.dek?.keyLength&&this.init.dek.keyLength<ay)throw new Error(`dek.keyLength must be least ${ay} bytes`);if(null!=this.init.dek?.salt?.length&&this.init.dek.salt.length<cy)throw new Error(`dek.saltLength must be least ${cy} bytes`);if(null!=this.init.dek?.iterationCount&&this.init.dek.iterationCount<ly)throw new Error(`dek.iterationCount must be least ${ly}`);const n=null!=this.init.pass&&null!=this.init.dek?.salt?(0,ry.nk)(this.init.pass,this.init.dek?.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";iy.set(this,{dek:n}),this.started=!1}isStarted(){return this.started}async start(){const t=fy("self");await this.components.datastore.has(t)||await this.importPeer("self",this.components.peerId),this.started=!0}stop(){this.started=!1}get cms(){const t=iy.get(this);if(null==t)throw a(new Error("dek missing"),dp.ERR_INVALID_PARAMETERS);const e=t.dek;return new ny(this,e)}static generateOptions(){const t=Object.assign({},uy),e=3*Math.ceil(cy/3);return t.dek.salt=(0,H.B)((0,ry.O6)(e),"base64"),t}static get options(){return uy}async createKey(t,e,n=2048){if(!dy(t)||"self"===t)throw await hy(),a(new Error("Invalid key name"),dp.ERR_INVALID_KEY_NAME);if("string"!=typeof e)throw await hy(),a(new Error("Invalid key type"),dp.ERR_INVALID_KEY_TYPE);const r=py(t);if(await this.components.datastore.has(r))throw await hy(),a(new Error("Key name already exists"),dp.ERR_KEY_ALREADY_EXISTS);if("rsa"===e.toLowerCase())if(!Number.isSafeInteger(n)||n<2048)throw await hy(),a(new Error("Invalid RSA key size"),dp.ERR_INVALID_KEY_SIZE);let s;try{const o=await(0,$e.generateKeyPair)(e,n),i=await o.id(),c=iy.get(this);if(null==c)throw a(new Error("dek missing"),dp.ERR_INVALID_PARAMETERS);const l=c.dek,u=await o.export(l);s={name:t,id:i};const d=this.components.datastore.batch();d.put(r,(0,x.m)(u)),d.put(fy(t),(0,x.m)(JSON.stringify(s))),await d.commit()}catch(t){throw await hy(),t}return s}async listKeys(){const t={prefix:oy},e=[];for await(const n of this.components.datastore.query(t))e.push(JSON.parse((0,H.B)(n.value)));return e}async findKeyById(t){try{return(await this.listKeys()).find((e=>e.id===t))}catch(t){throw await hy(),t}}async findKeyByName(t){if(!dy(t))throw await hy(),a(new Error(`Invalid key name '${t}'`),dp.ERR_INVALID_KEY_NAME);const e=fy(t);try{const t=await this.components.datastore.get(e);return JSON.parse((0,H.B)(t))}catch(e){throw await hy(),sy.error(e),a(new Error(`Key '${t}' does not exist.`),dp.ERR_KEY_NOT_FOUND)}}async removeKey(t){if(!dy(t)||"self"===t)throw await hy(),a(new Error(`Invalid key name '${t}'`),dp.ERR_INVALID_KEY_NAME);const e=py(t),n=await this.findKeyByName(t),r=this.components.datastore.batch();return r.delete(e),r.delete(fy(t)),await r.commit(),n}async renameKey(t,e){if(!dy(t)||"self"===t)throw await hy(),a(new Error(`Invalid old key name '${t}'`),dp.ERR_OLD_KEY_NAME_INVALID);if(!dy(e)||"self"===e)throw await hy(),a(new Error(`Invalid new key name '${e}'`),dp.ERR_NEW_KEY_NAME_INVALID);const n=py(t),r=py(e),s=fy(t),o=fy(e);if(await this.components.datastore.has(r))throw await hy(),a(new Error(`Key '${e}' already exists`),dp.ERR_KEY_ALREADY_EXISTS);try{const t=await this.components.datastore.get(n),i=await this.components.datastore.get(s),a=JSON.parse((0,H.B)(i));a.name=e;const c=this.components.datastore.batch();return c.put(r,t),c.put(o,(0,x.m)(JSON.stringify(a))),c.delete(n),c.delete(s),await c.commit(),a}catch(t){throw await hy(),t}}async exportKey(t,e){if(!dy(t))throw await hy(),a(new Error(`Invalid key name '${t}'`),dp.ERR_INVALID_KEY_NAME);if(null==e)throw await hy(),a(new Error("Password is required"),dp.ERR_PASSWORD_REQUIRED);const n=py(t);try{const t=await this.components.datastore.get(n),r=(0,H.B)(t),s=iy.get(this);if(null==s)throw a(new Error("dek missing"),dp.ERR_INVALID_PARAMETERS);const o=s.dek,i=await(0,$e.importKey)(r,o);return await i.export(e)}catch(t){throw await hy(),t}}async exportPeerId(t){const e="temporary-password",n=await this.exportKey(t,e),r=await(0,$e.importKey)(n,e);return await(0,Ne.y5)(r.public.bytes,r.bytes)}async importKey(t,e,n){if(!dy(t)||"self"===t)throw await hy(),a(new Error(`Invalid key name '${t}'`),dp.ERR_INVALID_KEY_NAME);if(null==e)throw await hy(),a(new Error("PEM encoded key is required"),dp.ERR_PEM_REQUIRED);const r=py(t);if(await this.components.datastore.has(r))throw await hy(),a(new Error(`Key '${t}' already exists`),dp.ERR_KEY_ALREADY_EXISTS);let s,o;try{s=await(0,$e.importKey)(e,n)}catch(t){throw await hy(),a(new Error("Cannot read the key, most likely the password is wrong"),dp.ERR_CANNOT_READ_KEY)}try{o=await s.id();const t=iy.get(this);if(null==t)throw a(new Error("dek missing"),dp.ERR_INVALID_PARAMETERS);const n=t.dek;e=await s.export(n)}catch(t){throw await hy(),t}const i={name:t,id:o},c=this.components.datastore.batch();return c.put(r,(0,x.m)(e)),c.put(fy(t),(0,x.m)(JSON.stringify(i))),await c.commit(),i}async importPeer(t,e){try{if(!dy(t))throw a(new Error(`Invalid key name '${t}'`),dp.ERR_INVALID_KEY_NAME);if(null==e)throw a(new Error("PeerId is required"),dp.ERR_MISSING_PRIVATE_KEY);if(null==e.privateKey)throw a(new Error("PeerId.privKey is required"),dp.ERR_MISSING_PRIVATE_KEY);const n=await(0,$e.unmarshalPrivateKey)(e.privateKey),r=py(t);if(await this.components.datastore.has(r))throw await hy(),a(new Error(`Key '${t}' already exists`),dp.ERR_KEY_ALREADY_EXISTS);const s=iy.get(this);if(null==s)throw a(new Error("dek missing"),dp.ERR_INVALID_PARAMETERS);const o=s.dek,i=await n.export(o),c={name:t,id:e.toString()},l=this.components.datastore.batch();return l.put(r,(0,x.m)(i)),l.put(fy(t),(0,x.m)(JSON.stringify(c))),await l.commit(),c}catch(t){throw await hy(),t}}async getPrivateKey(t){if(!dy(t))throw await hy(),a(new Error(`Invalid key name '${t}'`),dp.ERR_INVALID_KEY_NAME);try{const e=py(t),n=await this.components.datastore.get(e);return(0,H.B)(n)}catch(e){throw await hy(),sy.error(e),a(new Error(`Key '${t}' does not exist.`),dp.ERR_KEY_NOT_FOUND)}}async rotateKeychainPass(t,e){if("string"!=typeof t)throw await hy(),a(new Error(`Invalid old pass type '${typeof t}'`),dp.ERR_INVALID_OLD_PASS_TYPE);if("string"!=typeof e)throw await hy(),a(new Error(`Invalid new pass type '${typeof e}'`),dp.ERR_INVALID_NEW_PASS_TYPE);if(e.length<20)throw await hy(),a(new Error(`Invalid pass length ${e.length}`),dp.ERR_INVALID_PASS_LENGTH);sy("recreating keychain");const n=iy.get(this);if(null==n)throw a(new Error("dek missing"),dp.ERR_INVALID_PARAMETERS);const r=n.dek;this.init.pass=e;const s=null!=e&&null!=this.init.dek?.salt?(0,ry.nk)(e,this.init.dek.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";iy.set(this,{dek:s});const o=await this.listKeys();for(const t of o){const e=await this.components.datastore.get(py(t.name)),n=(0,H.B)(e),o=await(0,$e.importKey)(n,r),i=s.toString(),a=await o.export(i),c=this.components.datastore.batch(),l={name:t.name,id:t.id};c.put(py(t.name),(0,x.m)(a)),c.put(fy(t.name),(0,x.m)(JSON.stringify(l))),await c.commit()}sy("keychain reconstructed")}}var gy=n(16615),wy=n(20199);const my=(0,i.kg)("libp2p:transports");class by extends pp.v{constructor(t,e={}){super(),this.components=t,this.started=!1,this.transports=new Map,this.listeners=(0,wy.s)({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=e.faultTolerance??Bf.P7.FATAL_ALL}add(t){const e=t[Symbol.toStringTag];if(null==e)throw a(new Error("Transport must have a valid tag"),dp.ERR_INVALID_KEY);if(this.transports.has(e))throw a(new Error("There is already a transport with this tag"),dp.ERR_DUPLICATE_TRANSPORT);my("adding transport %s",e),this.transports.set(e,t),this.listeners.has(e)||this.listeners.set(e,[])}isStarted(){return this.started}async start(){const t=this.components.addressManager.getListenAddrs();await this.listen(t),this.started=!0}async stop(){const t=[];for(const[e,n]of this.listeners)for(my("closing listeners for %s",e);n.length>0;){const e=n.pop();null!=e&&t.push(e.close())}await Promise.all(t),my("all listeners closed");for(const t of this.listeners.keys())this.listeners.set(t,[]);this.started=!1}async dial(t,e){const n=this.transportForMultiaddr(t);if(null==n)throw a(new Error(`No transport available for address ${String(t)}`),dp.ERR_TRANSPORT_UNAVAILABLE);try{return await n.dial(t,{...e,upgrader:this.components.upgrader})}catch(t){throw null==t.code&&(t.code=dp.ERR_TRANSPORT_DIAL_FAILED),t}}getAddrs(){let t=[];for(const e of this.listeners.values())for(const n of e)t=[...t,...n.getAddrs()];return t}getTransports(){return Array.of(...this.transports.values())}transportForMultiaddr(t){for(const e of this.transports.values()){if(e.filter([t]).length>0)return e}}async listen(t){if(null==t||0===t.length)return void my("no addresses were provided for listening, this node is dial only");const e=[];for(const[n,r]of this.transports.entries()){const s=r.filter(t),o=[];for(const t of s){my("creating listener for %s on %s",n,t);const e=r.createListener({upgrader:this.components.upgrader});let s=this.listeners.get(n);null==s&&(s=[],this.listeners.set(n,s)),s.push(e),e.addEventListener("listening",(()=>{this.dispatchEvent(new pp.A("listener:listening",{detail:e}))})),e.addEventListener("close",(()=>{this.dispatchEvent(new pp.A("listener:close",{detail:e}))})),o.push(e.listen(t))}if(0===o.length){e.push(n);continue}if(null==(await(0,gy.Z)(o)).find((t=>t.isFulfilled))&&this.faultTolerance!==Bf.P7.NO_FATAL)throw a(new Error(`Transport (${n}) could not listen on any available address`),dp.ERR_NO_VALID_ADDRESSES)}if(e.length===this.transports.size){const t=`no valid addresses were provided for transports [${e.join(", ")}]`;if(this.faultTolerance===Bf.P7.FATAL_ALL)throw a(new Error(t),dp.ERR_NO_VALID_ADDRESSES);my(`libp2p in dial mode only: ${t}`)}}async remove(t){my("removing %s",t);for(const e of this.listeners.get(t)??[])await e.close();this.transports.delete(t),this.listeners.delete(t)}async removeAll(){const t=[];for(const e of this.transports.keys())t.push(this.remove(e));await Promise.all(t)}}const Ey="/multistream/1.0.0",_y=1024,vy=(0,i.kg)("libp2p:mss"),ky=(0,x.m)("\n");function Ry(t){const e=new Po.H(t,ky);return Sf.single(e)}function Sy(t,e,n={}){const r=Ry(e);!0===n.writeBytes?t.push(r.subarray()):t.push(r)}async function Ty(t,e){const n=await async function(t,e){let n=1;const r={[Symbol.asyncIterator]:()=>r,next:async()=>await t.next(n)};let s=r;null!=e?.signal&&(s=(0,zf.wJ)(r,e.signal));const o=await Gs(s,Pf({onLength:t=>{n=t},maxDataLength:_y}),(async t=>await(0,ka.Z)(t)));if(null==o||0===o.length)throw a(new Error("no buffer returned"),"ERR_INVALID_MULTISTREAM_SELECT_MESSAGE");if(o.get(o.byteLength-1)!==ky[0])throw vy.error("Invalid mss message - missing newline - %s",o.subarray()),a(new Error("missing newline"),"ERR_INVALID_MULTISTREAM_SELECT_MESSAGE");return o.sublist(0,-1)}(t,e);return(0,H.B)(n.subarray())}n(93489);const Ay=(0,i.kg)("libp2p:mss:select");async function Iy(t,e,n={}){e=Array.isArray(e)?[...e]:[e];const{reader:r,writer:s,rest:o,stream:i}=(0,Nf.Y)(t),c=e.shift();if(null==c)throw new Error("At least one protocol must be specified");Ay('select: write ["%s", "%s"]',Ey,c);!function(t,e,n={}){const r=new Po.H;for(const t of e)r.append(Ry(t));!0===n.writeBytes?t.push(r.subarray()):t.push(r)}(s,[(0,x.m)(Ey),(0,x.m)(c)],n);let l=await Ty(r,n);if(Ay('select: read "%s"',l),l===Ey&&(l=await Ty(r,n),Ay('select: read "%s"',l)),l===c)return o(),{stream:i,protocol:c};for(const t of e){Ay('select: write "%s"',t),Sy(s,(0,x.m)(t),n);const e=await Ty(r,n);if(Ay('select: read "%s" for "%s"',e,t),e===t)return o(),{stream:i,protocol:t}}throw o(),a(new Error("protocol selection failed"),"ERR_UNSUPPORTED_PROTOCOL")}const Dy=(0,i.kg)("libp2p:mss:handle");async function Py(t,e,n){e=Array.isArray(e)?e:[e];const{writer:r,reader:s,rest:o,stream:i}=(0,Nf.Y)(t);for(;;){const t=await Ty(s,n);if(Dy('read "%s"',t),t!==Ey){if(e.includes(t))return Sy(r,(0,x.m)(t),n),Dy('respond with "%s" for "%s"',t,t),o(),{stream:i,protocol:t};"ls"!==t?(Sy(r,(0,x.m)("na"),n),Dy('respond with "na" for "%s"',t)):(Sy(r,new Po.H(...e.map((t=>Ry((0,x.m)(t))))),n),Dy('respond with "%s" for %s',e,t))}else Dy('respond with "%s" for "%s"',Ey,t),Sy(r,(0,x.m)(Ey),n)}}var Ny=n(48302);const Oy=(0,i.kg)("libp2p:connection");class Ly{constructor(t){const{remoteAddr:e,remotePeer:n,newStream:r,close:s,getStreams:o,stat:i}=t;this.id=`${parseInt(String(1e9*Math.random())).toString(36)}${Date.now()}`,this.remoteAddr=e,this.remotePeer=n,this.stat={...i,status:Pp.o1},this._newStream=r,this._close=s,this._getStreams=o,this.tags=[],this._closing=!1}get[Symbol.toStringTag](){return"Connection"}get[Ny.N](){return!0}get streams(){return this._getStreams()}async newStream(t,e){if(this.stat.status===Pp.Z5)throw a(new Error("the connection is being closed"),"ERR_CONNECTION_BEING_CLOSED");if(this.stat.status===Pp.m$)throw a(new Error("the connection is closed"),"ERR_CONNECTION_CLOSED");Array.isArray(t)||(t=[t]);const n=await this._newStream(t,e);return n.stat.direction="outbound",n}addStream(t){t.stat.direction="inbound"}removeStream(t){}async close(){if(this.stat.status!==Pp.m$&&!this._closing){this.stat.status=Pp.Z5;try{this.streams.forEach((t=>t.close()))}catch(t){Oy.error(t)}this._closing=!0,await this._close(),this._closing=!1,this.stat.timeline.close=Date.now(),this.stat.status=Pp.m$}}}var Cy=n(1388);const My=(0,i.kg)("libp2p:registrar");class xy{constructor(t){this.topologies=new Map,this.handlers=new Map,this.components=t,this._onDisconnect=this._onDisconnect.bind(this),this._onProtocolChange=this._onProtocolChange.bind(this),this._onConnect=this._onConnect.bind(this),this.components.connectionManager.addEventListener("peer:disconnect",this._onDisconnect),this.components.connectionManager.addEventListener("peer:connect",this._onConnect),this.components.peerStore.addEventListener("change:protocols",this._onProtocolChange)}getProtocols(){return Array.from(new Set([...this.topologies.keys(),...this.handlers.keys()])).sort()}getHandler(t){const e=this.handlers.get(t);if(null==e)throw a(new Error(`No handler registered for protocol ${t}`),dp.ERR_NO_HANDLER_FOR_PROTOCOL);return e}getTopologies(t){const e=this.topologies.get(t);return null==e?[]:[...e.values()]}async handle(t,e,n){if(this.handlers.has(t))throw a(new Error(`Handler already registered for protocol ${t}`),dp.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED);const r=s.Z.bind({ignoreUndefined:!0})({maxInboundStreams:32,maxOutboundStreams:64},n);this.handlers.set(t,{handler:e,options:r}),await this.components.peerStore.protoBook.add(this.components.peerId,[t])}async unhandle(t){const e=Array.isArray(t)?t:[t];e.forEach((t=>{this.handlers.delete(t)})),await this.components.peerStore.protoBook.remove(this.components.peerId,e)}async register(t,e){if(!(0,Cy.w)(e))throw My.error("topology must be an instance of interfaces/topology"),a(new Error("topology must be an instance of interfaces/topology"),dp.ERR_INVALID_PARAMETERS);const n=`${(1e9*Math.random()).toString(36)}${Date.now()}`;let r=this.topologies.get(t);return null==r&&(r=new Map,this.topologies.set(t,r)),r.set(n,e),await e.setRegistrar(this),n}unregister(t){for(const[e,n]of this.topologies.entries())n.has(t)&&(n.delete(t),0===n.size&&this.topologies.delete(e))}_onDisconnect(t){const e=t.detail;this.components.peerStore.protoBook.get(e.remotePeer).then((t=>{for(const n of t){const t=this.topologies.get(n);if(null!=t)for(const n of t.values())n.onDisconnect(e.remotePeer)}})).catch((t=>{My.error(t)}))}_onConnect(t){const e=t.detail;this.components.peerStore.protoBook.get(e.remotePeer).then((t=>{for(const n of t){const t=this.topologies.get(n);if(null!=t)for(const n of t.values())n.onConnect(e.remotePeer,e)}})).catch((t=>{My.error(t)}))}_onProtocolChange(t){const{peerId:e,protocols:n,oldProtocols:r}=t.detail,s=r.filter((t=>!n.includes(t))),o=n.filter((t=>!r.includes(t)));for(const t of s){const n=this.topologies.get(t);if(null!=n)for(const t of n.values())t.onDisconnect(e)}for(const t of o){const n=this.topologies.get(t);if(null!=n)for(const t of n.values()){const n=this.components.connectionManager.getConnections(e)[0];null!=n&&t.onConnect(e,n)}}}}const By=(0,i.kg)("libp2p:upgrader");function zy(t,e,n){let r=0;return n.streams.forEach((n=>{n.stat.direction===e&&n.stat.protocol===t&&r++})),r}class Uy extends pp.v{constructor(t,e){super(),this.components=t,this.connectionEncryption=new Map,e.connectionEncryption.forEach((t=>{this.connectionEncryption.set(t.protocol,t)})),this.muxers=new Map,e.muxers.forEach((t=>{this.muxers.set(t.protocol,t)})),this.inboundUpgradeTimeout=e.inboundUpgradeTimeout}async upgradeInbound(t,e){if(!await this.components.connectionManager.acceptIncomingConnection(t))throw a(new Error("connection denied"),dp.ERR_CONNECTION_DENIED);let n,r,s,o,i;const c=new B.TimeoutController(this.inboundUpgradeTimeout);try{(0,Ep.setMaxListeners)?.(1/0,c.signal)}catch{}try{const l=(0,zf.D7)(t,c.signal);if(t.source=l.source,t.sink=l.sink,await this.components.connectionGater.denyInboundConnection(t))throw a(new Error("The multiaddr connection is blocked by gater.acceptConnection"),dp.ERR_CONNECTION_INTERCEPTED);this.components.metrics?.trackMultiaddrConnection(t),By("starting the inbound connection upgrade");let u=t;if(!0!==e?.skipProtection){const e=this.components.connectionProtector;null!=e&&(By("protecting the inbound connection"),u=await e.protect(t))}try{if(n=u,!0!==e?.skipEncryption){if(({conn:n,remotePeer:r,protocol:i}=await this._encryptInbound(u)),await this.components.connectionGater.denyInboundEncryptedConnection(r,{...u,...n}))throw a(new Error("The multiaddr connection is blocked by gater.acceptEncryptedConnection"),dp.ERR_CONNECTION_INTERCEPTED)}else{const e=t.remoteAddr.getPeerId();if(null==e)throw a(new Error("inbound connection that skipped encryption must have a peer id"),dp.ERR_INVALID_MULTIADDR);const n=(0,Ne.jE)(e);i="native",r=n}if(s=n,null!=e?.muxerFactory)o=e.muxerFactory;else if(this.muxers.size>0){const t=await this._multiplexInbound({...u,...n},this.muxers);o=t.muxerFactory,s=t.stream}}catch(t){throw By.error("Failed to upgrade inbound connection",t),t}if(await this.components.connectionGater.denyInboundUpgradedConnection(r,{...u,...n}))throw a(new Error("The multiaddr connection is blocked by gater.acceptEncryptedConnection"),dp.ERR_CONNECTION_INTERCEPTED);return By("Successfully upgraded inbound connection"),this._createConnection({cryptoProtocol:i,direction:"inbound",maConn:t,upgradedConn:s,muxerFactory:o,remotePeer:r})}finally{this.components.connectionManager.afterUpgradeInbound(),c.clear()}}async upgradeOutbound(t,e){const n=t.remoteAddr.getPeerId();let r,s,o,i,c,l;if(null!=n&&(r=(0,Ne.jE)(n),await this.components.connectionGater.denyOutboundConnection(r,t)))throw a(new Error("The multiaddr connection is blocked by connectionGater.denyOutboundConnection"),dp.ERR_CONNECTION_INTERCEPTED);this.components.metrics?.trackMultiaddrConnection(t),By("Starting the outbound connection upgrade");let u=t;if(!0!==e?.skipProtection){const e=this.components.connectionProtector;null!=e&&(u=await e.protect(t))}try{if(s=u,!0!==e?.skipEncryption){if(({conn:s,remotePeer:o,protocol:c}=await this._encryptOutbound(u,r)),await this.components.connectionGater.denyOutboundEncryptedConnection(o,{...u,...s}))throw a(new Error("The multiaddr connection is blocked by gater.acceptEncryptedConnection"),dp.ERR_CONNECTION_INTERCEPTED)}else{if(null==r)throw a(new Error("Encryption was skipped but no peer id was passed"),dp.ERR_INVALID_PEER);c="native",o=r}if(i=s,null!=e?.muxerFactory)l=e.muxerFactory;else if(this.muxers.size>0){const t=await this._multiplexOutbound({...u,...s},this.muxers);l=t.muxerFactory,i=t.stream}}catch(e){throw By.error("Failed to upgrade outbound connection",e),await t.close(e),e}if(await this.components.connectionGater.denyOutboundUpgradedConnection(o,{...u,...s}))throw a(new Error("The multiaddr connection is blocked by gater.acceptEncryptedConnection"),dp.ERR_CONNECTION_INTERCEPTED);return By("Successfully upgraded outbound connection"),this._createConnection({cryptoProtocol:c,direction:"outbound",maConn:t,upgradedConn:i,muxerFactory:l,remotePeer:o})}_createConnection(t){const{cryptoProtocol:e,direction:n,maConn:r,upgradedConn:s,remotePeer:o,muxerFactory:i}=t;let c,l,u;null!=i&&(c=i.createStreamMuxer({direction:n,onIncomingStream:t=>{null!=u&&Promise.resolve().then((async()=>{const e=this.components.registrar.getProtocols(),{stream:r,protocol:s}=await Py(t,e);if(By("%s: incoming stream opened on %s",n,s),null==u)return;const i=function(t,e){try{const{options:n}=e.getHandler(t);return n.maxInboundStreams}catch(t){if(t.code!==dp.ERR_NO_HANDLER_FOR_PROTOCOL)throw t}return 32}(s,this.components.registrar);zy(s,"inbound",u)!==i?(t.source=r.source,t.sink=r.sink,t.stat.protocol=s,this.components.peerStore.protoBook.add(o,[s]).catch((t=>By.error(t))),u.addStream(t),this.components.metrics?.trackProtocolStream(t,u),this._onStream({connection:u,stream:t,protocol:s})):t.abort(a(new Error(`Too many inbound protocol streams for protocol "${s}" - limit ${i}`),dp.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS))})).catch((e=>{By.error(e),null==t.stat.timeline.close&&t.close()}))},onStreamEnd:t=>{u?.removeStream(t.id)}}),l=async(t,e={})=>{if(null==c)throw a(new Error("Stream is not multiplexed"),dp.ERR_MUXER_UNAVAILABLE);By("%s: starting new stream on %s",n,t);const r=await c.newStream();let s;try{if(null==e.signal){By("No abort signal was passed while trying to negotiate protocols %s falling back to default timeout",t),s=new B.TimeoutController(3e4),e.signal=s.signal;try{(0,Ep.setMaxListeners)?.(1/0,s.signal)}catch{}}const{stream:n,protocol:i}=await Iy(r,t,e),c=function(t,e){try{const{options:n}=e.getHandler(t);return n.maxOutboundStreams}catch(t){if(t.code!==dp.ERR_NO_HANDLER_FOR_PROTOCOL)throw t}return 64}(i,this.components.registrar);if(zy(i,"outbound",u)===c){const t=a(new Error(`Too many outbound protocol streams for protocol "${i}" - limit ${c}`),dp.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS);throw r.abort(t),t}return this.components.peerStore.protoBook.add(o,[i]).catch((t=>By.error(t))),r.source=n.source,r.sink=n.sink,r.stat.protocol=i,this.components.metrics?.trackProtocolStream(r,u),r}catch(t){if(By.error("could not create new stream",t),null==r.stat.timeline.close&&r.close(),null!=t.code)throw t;throw a(t,dp.ERR_UNSUPPORTED_PROTOCOL)}finally{null!=s&&s.clear()}},Promise.all([c.sink(s.source),s.sink(c.source)]).catch((t=>{By.error(t)})));const d=r.timeline;r.timeline=new Proxy(d,{set:(...t)=>(null!=u&&"close"===t[1]&&null!=t[2]&&null==d.close&&(async()=>{try{"OPEN"===u.stat.status&&await u.close()}catch(t){By.error(t)}finally{this.dispatchEvent(new pp.A("connectionEnd",{detail:u}))}})().catch((t=>{By.error(t)})),Reflect.set(...t))}),r.timeline.upgraded=Date.now();const h=()=>{throw a(new Error("connection is not multiplexed"),dp.ERR_CONNECTION_NOT_MULTIPLEXED)};var p;return p={remoteAddr:r.remoteAddr,remotePeer:o,stat:{status:"OPEN",direction:n,timeline:r.timeline,multiplexer:c?.protocol,encryption:e},newStream:l??h,getStreams:()=>null!=c?c.streams:h(),close:async()=>{await r.close(),null!=c&&c.close()}},u=new Ly(p),this.dispatchEvent(new pp.A("connection",{detail:u})),u}_onStream(t){const{connection:e,stream:n,protocol:r}=t,{handler:s}=this.components.registrar.getHandler(r);s({connection:e,stream:n})}async _encryptInbound(t){const e=Array.from(this.connectionEncryption.keys());By("handling inbound crypto protocol selection",e);try{const{stream:n,protocol:r}=await Py(t,e,{writeBytes:!0}),s=this.connectionEncryption.get(r);if(null==s)throw new Error(`no crypto module found for ${r}`);return By("encrypting inbound connection..."),{...await s.secureInbound(this.components.peerId,n),protocol:r}}catch(t){throw a(t,dp.ERR_ENCRYPTION_FAILED)}}async _encryptOutbound(t,e){const n=Array.from(this.connectionEncryption.keys());By("selecting outbound crypto protocol",n);try{const{stream:r,protocol:s}=await Iy(t,n,{writeBytes:!0}),o=this.connectionEncryption.get(s);if(null==o)throw new Error(`no crypto module found for ${s}`);return By("encrypting outbound connection to %p",e),{...await o.secureOutbound(this.components.peerId,r,e),protocol:s}}catch(t){throw a(t,dp.ERR_ENCRYPTION_FAILED)}}async _multiplexOutbound(t,e){const n=Array.from(e.keys());By("outbound selecting muxer %s",n);try{const{stream:r,protocol:s}=await Iy(t,n,{writeBytes:!0});By("%s selected as muxer protocol",s);return{stream:r,muxerFactory:e.get(s)}}catch(t){throw By.error("error multiplexing outbound stream",t),a(t,dp.ERR_MUXER_UNAVAILABLE)}}async _multiplexInbound(t,e){const n=Array.from(e.keys());By("inbound handling muxers %s",n);try{const{stream:r,protocol:s}=await Py(t,n,{writeBytes:!0});return{stream:r,muxerFactory:e.get(s)}}catch(t){throw By.error("error multiplexing inbound stream",t),a(t,dp.ERR_MUXER_UNAVAILABLE)}}}var jy;!function(t){let e;t.codec=()=>(null==e&&(e=af(((t,e,n={})=>{if(!1!==n.lengthDelimited&&e.fork(),null!=t.protocolVersion&&(e.uint32(42),e.string(t.protocolVersion)),null!=t.agentVersion&&(e.uint32(50),e.string(t.agentVersion)),null!=t.publicKey&&(e.uint32(10),e.bytes(t.publicKey)),null!=t.listenAddrs)for(const n of t.listenAddrs)e.uint32(18),e.bytes(n);if(null!=t.observedAddr&&(e.uint32(34),e.bytes(t.observedAddr)),null!=t.protocols)for(const n of t.protocols)e.uint32(26),e.string(n);null!=t.signedPeerRecord&&(e.uint32(66),e.bytes(t.signedPeerRecord)),!1!==n.lengthDelimited&&e.ldelim()}),((t,e)=>{const n={listenAddrs:[],protocols:[]},r=null==e?t.len:t.pos+e;for(;t.pos<r;){const e=t.uint32();switch(e>>>3){case 5:n.protocolVersion=t.string();break;case 6:n.agentVersion=t.string();break;case 1:n.publicKey=t.bytes();break;case 2:n.listenAddrs.push(t.bytes());break;case 4:n.observedAddr=t.bytes();break;case 3:n.protocols.push(t.string());break;case 8:n.signedPeerRecord=t.bytes();break;default:t.skipType(7&e)}}return n}))),e),t.encode=e=>ef(e,t.codec()),t.decode=e=>tf(e,t.codec())}(jy||(jy={}));var $y=n(64306);const Vy="0.0.0",Hy=`js-libp2p/${Vy}`,Fy=(0,i.kg)("libp2p:identify");class Ky{constructor(t,e){this.components=t,this.started=!1,this.init=e,this.identifyProtocolStr=`/${e.protocolPrefix}/id/1.0.0`,this.identifyPushProtocolStr=`/${e.protocolPrefix}/id/push/1.0.0`,this.host={protocolVersion:`${e.protocolPrefix}/0.1.0`,...e.host},this.components.connectionManager.addEventListener("peer:connect",(t=>{const e=t.detail;this.identify(e).catch(Fy.error)})),this.components.peerStore.addEventListener("change:multiaddrs",(t=>{const{peerId:e}=t.detail;this.components.peerId.equals(e)&&this.pushToPeerStore().catch((t=>Fy.error(t)))})),this.components.peerStore.addEventListener("change:protocols",(t=>{const{peerId:e}=t.detail;this.components.peerId.equals(e)&&this.pushToPeerStore().catch((t=>Fy.error(t)))}))}isStarted(){return this.started}async start(){this.started||(await this.components.peerStore.metadataBook.setValue(this.components.peerId,"AgentVersion",(0,x.m)(this.host.agentVersion)),await this.components.peerStore.metadataBook.setValue(this.components.peerId,"ProtocolVersion",(0,x.m)(this.host.protocolVersion)),await this.components.registrar.handle(this.identifyProtocolStr,(t=>{this._handleIdentify(t).catch((t=>{Fy.error(t)}))}),{maxInboundStreams:this.init.maxInboundStreams,maxOutboundStreams:this.init.maxOutboundStreams}),await this.components.registrar.handle(this.identifyPushProtocolStr,(t=>{this._handlePush(t).catch((t=>{Fy.error(t)}))}),{maxInboundStreams:this.init.maxPushIncomingStreams,maxOutboundStreams:this.init.maxPushOutgoingStreams}),this.started=!0)}async stop(){await this.components.registrar.unhandle(this.identifyProtocolStr),await this.components.registrar.unhandle(this.identifyPushProtocolStr),this.started=!1}async push(t){const e=await this.components.peerStore.addressBook.getRawEnvelope(this.components.peerId),n=this.components.addressManager.getAddresses().map((t=>t.bytes)),r=await this.components.peerStore.protoBook.get(this.components.peerId),s=t.map((async t=>{let s;const o=new B.TimeoutController(this.init.timeout);try{(0,Ep.setMaxListeners)?.(1/0,o.signal)}catch{}try{s=await t.newStream([this.identifyPushProtocolStr],{signal:o.signal});const i=(0,zf.D7)(s,o.signal);await i.sink(Gs([jy.encode({listenAddrs:n,signedPeerRecord:e,protocols:r})],Sf()))}catch(t){Fy.error("could not push identify update to peer",t)}finally{null!=s&&s.close(),o.clear()}}));await Promise.all(s)}async pushToPeerStore(){if(!this.isStarted())return;const t=[];for(const e of this.components.connectionManager.getConnections()){const n=e.remotePeer;(await this.components.peerStore.get(n)).protocols.includes(this.identifyPushProtocolStr)&&t.push(e)}await this.push(t)}async _identify(t,e={}){let n,r,s=e.signal;if(null==s){n=new B.TimeoutController(this.init.timeout),s=n.signal;try{(0,Ep.setMaxListeners)?.(1/0,n.signal)}catch{}}try{r=await t.newStream([this.identifyProtocolStr],{signal:s});const e=(0,zf.D7)(r,s),n=await Gs([],e,Pf({maxDataLength:this.init.maxIdentifyMessageSize??8192}),(async t=>await(0,ka.Z)(t)));if(null==n)throw a(new Error("No data could be retrieved"),dp.ERR_CONNECTION_ENDED);try{return jy.decode(n)}catch(t){throw a(t,dp.ERR_INVALID_MESSAGE)}}finally{null!=n&&n.clear(),null!=r&&r.close()}}async identify(t,e={}){const n=await this._identify(t,e),{publicKey:r,listenAddrs:s,protocols:o,observedAddr:i,signedPeerRecord:c,agentVersion:l,protocolVersion:u}=n;if(null==r)throw a(new Error("public key was missing from identify message"),dp.ERR_MISSING_PUBLIC_KEY);const d=await(0,Ne.y5)(r);if(!t.remotePeer.equals(d))throw a(new Error("identified peer does not match the expected peer"),dp.ERR_INVALID_PEER);if(this.components.peerId.equals(d))throw a(new Error("identified peer is our own peer id?"),dp.ERR_INVALID_PEER);const h=Ky.getCleanMultiaddr(i);if(null!=c){Fy("received signed peer record from %p",d);try{const t=await $y.X.openAndCertify(c,$y.K.DOMAIN);if(!t.peerId.equals(d))throw a(new Error("identified peer does not match the expected peer"),dp.ERR_INVALID_PEER);if(await this.components.peerStore.addressBook.consumePeerRecord(t))return await this.components.peerStore.protoBook.set(d,o),null!=l&&await this.components.peerStore.metadataBook.setValue(d,"AgentVersion",(0,x.m)(l)),null!=u&&await this.components.peerStore.metadataBook.setValue(d,"ProtocolVersion",(0,x.m)(u)),void Fy("identify completed for peer %p and protocols %o",d,o)}catch(t){Fy("received invalid envelope, discard it and fallback to listenAddrs is available",t)}}else Fy("no signed peer record received from %p",d);Fy("falling back to legacy addresses from %p",d);try{await this.components.peerStore.addressBook.set(d,s.map((t=>(0,$.HM)(t))))}catch(t){Fy.error("received invalid addrs",t)}await this.components.peerStore.protoBook.set(d,o),null!=l&&await this.components.peerStore.metadataBook.setValue(d,"AgentVersion",(0,x.m)(l)),null!=u&&await this.components.peerStore.metadataBook.setValue(d,"ProtocolVersion",(0,x.m)(u)),Fy("identify completed for peer %p and protocols %o",d,o),Fy("received observed address of %s",h?.toString())}async _handleIdentify(t){const{connection:e,stream:n}=t,r=new B.TimeoutController(this.init.timeout);try{(0,Ep.setMaxListeners)?.(1/0,r.signal)}catch{}try{const t=this.components.peerId.publicKey??new Uint8Array(0),s=await this.components.peerStore.get(this.components.peerId),o=this.components.addressManager.getAddresses().map((t=>t.decapsulateCode((0,$.a_)("p2p").code)));let i=s.peerRecordEnvelope;if(o.length>0&&null==i){const t=new $y.K({peerId:this.components.peerId,multiaddrs:o}),e=await $y.X.seal(t,this.components.peerId);await this.components.peerStore.addressBook.consumePeerRecord(e),i=e.marshal().subarray()}const a=jy.encode({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:t,listenAddrs:o.map((t=>t.bytes)),signedPeerRecord:i,observedAddr:e.remoteAddr.bytes,protocols:s.protocols}),c=(0,zf.D7)(n,r.signal),l=Gs([a],Sf());await c.sink(l)}catch(t){Fy.error("could not respond to identify request",t)}finally{n.close(),r.clear()}}async _handlePush(t){const{connection:e,stream:n}=t,r=new B.TimeoutController(this.init.timeout);try{(0,Ep.setMaxListeners)?.(1/0,r.signal)}catch{}let s;try{const t=(0,zf.D7)(n,r.signal),e=await Gs([],t,Pf({maxDataLength:this.init.maxIdentifyMessageSize??8192}),(async t=>await(0,ka.Z)(t)));null!=e&&(s=jy.decode(e))}catch(t){return Fy.error("received invalid message",t)}finally{n.close(),r.clear()}if(null==s)return Fy.error("received invalid message");const o=e.remotePeer;if(this.components.peerId.equals(o))Fy("received push from ourselves?");else{if(Fy("received push from %p",o),null!=s.signedPeerRecord){Fy("received signedPeerRecord in push");try{const t=await $y.X.openAndCertify(s.signedPeerRecord,$y.K.DOMAIN);if(await this.components.peerStore.addressBook.consumePeerRecord(t))return Fy("consumed signedPeerRecord sent in push"),void await this.components.peerStore.protoBook.set(o,s.protocols);Fy("failed to consume signedPeerRecord sent in push")}catch(t){Fy("received invalid envelope, discard it and fallback to listenAddrs is available",t)}}else Fy("did not receive signedPeerRecord in push");try{await this.components.peerStore.addressBook.set(o,s.listenAddrs.map((t=>(0,$.HM)(t))))}catch(t){Fy.error("received invalid addrs",t)}try{await this.components.peerStore.protoBook.set(o,s.protocols)}catch(t){Fy.error("received invalid protocols",t)}Fy("handled push from %p",o)}}static getCleanMultiaddr(t){if(null!=t&&t.length>0)try{return(0,$.HM)(t)}catch{}}}var qy,Gy;!function(t){let e;t.codec=()=>(null==e&&(e=af(((t,e,n={})=>{!1!==n.lengthDelimited&&e.fork(),!0!==n.writeDefaults&&""===t.identifier||(e.uint32(10),e.string(t.identifier)),!1!==n.lengthDelimited&&e.ldelim()}),((t,e)=>{const n={identifier:""},r=null==e?t.len:t.pos+e;for(;t.pos<r;){const e=t.uint32();if(e>>>3==1)n.identifier=t.string();else t.skipType(7&e)}return n}))),e),t.encode=e=>ef(e,t.codec()),t.decode=e=>tf(e,t.codec())}(qy||(qy={})),function(t){let e,n,r;!function(t){t.OK="OK",t.NOT_FOUND="NOT_FOUND",t.ERROR="ERROR"}(e=t.StatusCode||(t.StatusCode={})),function(t){t[t.OK=0]="OK",t[t.NOT_FOUND=1]="NOT_FOUND",t[t.ERROR=2]="ERROR"}(n||(n={})),function(t){t.codec=()=>of(n)}(e=t.StatusCode||(t.StatusCode={})),t.codec=()=>(null==r&&(r=af(((e,r,s={})=>{!1!==s.lengthDelimited&&r.fork(),(!0===s.writeDefaults||null!=e.status&&0!==n[e.status])&&(r.uint32(8),t.StatusCode.codec().encode(e.status,r)),(!0===s.writeDefaults||null!=e.data&&e.data.byteLength>0)&&(r.uint32(18),r.bytes(e.data)),!1!==s.lengthDelimited&&r.ldelim()}),((n,r)=>{const s={status:e.OK,data:new Uint8Array(0)},o=null==r?n.len:n.pos+r;for(;n.pos<o;){const e=n.uint32();switch(e>>>3){case 1:s.status=t.StatusCode.codec().decode(n);break;case 2:s.data=n.bytes();break;default:n.skipType(7&e)}}return s}))),r),t.encode=e=>ef(e,t.codec()),t.decode=e=>tf(e,t.codec())}(Gy||(Gy={}));const Wy=(0,i.kg)("libp2p:fetch");class Zy{constructor(t,e){this.started=!1,this.components=t,this.protocol=`/${e.protocolPrefix??"libp2p"}/fetch/0.0.1`,this.lookupFunctions=new Map,this.handleMessage=this.handleMessage.bind(this),this.init=e}async start(){await this.components.registrar.handle(this.protocol,(t=>{this.handleMessage(t).catch((t=>{Wy.error(t)})).finally((()=>{t.stream.close()}))}),{maxInboundStreams:this.init.maxInboundStreams,maxOutboundStreams:this.init.maxOutboundStreams}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}async fetch(t,e,n={}){Wy("dialing %s to %p",this.protocol,t);const r=await this.components.connectionManager.openConnection(t,n);let s,o,i=n.signal;if(null==i){Wy("using default timeout of %d ms",this.init.timeout),s=new B.TimeoutController(this.init.timeout),i=s.signal;try{(0,Ep.setMaxListeners)?.(1/0,s.signal)}catch{}}try{o=await r.newStream(this.protocol,{signal:i});const t=(0,zf.D7)(o,i);Wy("fetch %s",e);const n=await Gs([qy.encode({identifier:e})],Sf(),t,Pf(),(async function(t){const n=await(0,ka.Z)(t);if(null==n)throw a(new Error("No data received"),dp.ERR_INVALID_MESSAGE);const r=Gy.decode(n);switch(r.status){case Gy.StatusCode.OK:return Wy("received status for %s ok",e),r.data;case Gy.StatusCode.NOT_FOUND:return Wy("received status for %s not found",e),null;case Gy.StatusCode.ERROR:{Wy("received status for %s error",e);const t=(0,H.B)(r.data);throw a(new Error("Error in fetch protocol response: "+t),dp.ERR_INVALID_PARAMETERS)}default:throw Wy("received status for %s unknown",e),a(new Error("Unknown response status"),dp.ERR_INVALID_MESSAGE)}}));return n??null}finally{null!=s&&s.clear(),null!=o&&o.close()}}async handleMessage(t){const{stream:e}=t,n=this;await Gs(e,Pf(),(async function*(t){const e=await(0,ka.Z)(t);if(null==e)throw a(new Error("No data received"),dp.ERR_INVALID_MESSAGE);const r=qy.decode(e);let s;const o=n._getLookupFunction(r.identifier);if(null!=o){Wy("look up data with identifier %s",r.identifier);const t=await o(r.identifier);null!=t?(Wy("sending status for %s ok",r.identifier),s={status:Gy.StatusCode.OK,data:t}):(Wy("sending status for %s not found",r.identifier),s={status:Gy.StatusCode.NOT_FOUND,data:new Uint8Array(0)})}else{Wy("sending status for %s error",r.identifier);const t=(0,x.m)(`No lookup function registered for key: ${r.identifier}`);s={status:Gy.StatusCode.ERROR,data:t}}yield Gy.encode(s)}),Sf(),e)}_getLookupFunction(t){for(const e of this.lookupFunctions.keys())if(t.startsWith(e))return this.lookupFunctions.get(e)}registerLookupFunction(t,e){if(this.lookupFunctions.has(t))throw a(new Error("Fetch protocol handler for key prefix '"+t+"' already registered"),dp.ERR_KEY_ALREADY_EXISTS);this.lookupFunctions.set(t,e)}unregisterLookupFunction(t,e){if(null!=e){if(this.lookupFunctions.get(t)!==e)return}this.lookupFunctions.delete(t)}}const Yy=(0,i.kg)("libp2p:ping");class Jy{constructor(t,e){this.components=t,this.started=!1,this.protocol=`/${e.protocolPrefix}/ping/1.0.0`,this.init=e}async start(){await this.components.registrar.handle(this.protocol,this.handleMessage,{maxInboundStreams:this.init.maxInboundStreams,maxOutboundStreams:this.init.maxOutboundStreams}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}handleMessage(t){const{stream:e}=t;Gs(e,e).catch((t=>{Yy.error(t)}))}async ping(t,e={}){Yy("dialing %s to %p",this.protocol,t);const n=Date.now(),r=(0,ry.O6)(32),s=await this.components.connectionManager.openConnection(t,e);let o,i,c=e.signal;if(null==c){o=new B.TimeoutController(this.init.timeout),c=o.signal;try{(0,Ep.setMaxListeners)?.(1/0,o.signal)}catch{}}try{i=await s.newStream([this.protocol],{signal:c});const t=(0,zf.D7)(i,c),e=await Gs([r],t,(async t=>await(0,ka.Z)(t))),o=Date.now();if(null==e||!(0,vt.f)(r,e.subarray()))throw a(new Error("Received wrong ping ack"),dp.ERR_WRONG_PING_ACK);return o-n}finally{null!=o&&o.clear(),null!=i&&i.close()}}}var Qy=n(14560),Xy=n(53749),tg=n(72265);const eg=(0,i.kg)("libp2p:nat"),ng=7200;function rg(t=1024,e=65535){return Math.floor(Math.random()*(e-t+1)+t)}class sg{constructor(t,e){if(this.components=t,this.started=!1,this.enabled=e.enabled,this.externalAddress=e.externalAddress,this.localAddress=e.localAddress,this.description=e.description??`libp2p@${Vy} ${this.components.peerId.toString()}`,this.ttl=e.ttl??ng,this.keepAlive=e.keepAlive??!0,this.gateway=e.gateway,this.ttl<ng)throw a(new Error("NatManager ttl should be at least 7200 seconds"),dp.ERR_INVALID_PARAMETERS)}isStarted(){return this.started}start(){}afterStart(){Qy.jU||!this.enabled||this.started||(this.started=!0,this._start().catch((t=>{eg.error(t)})))}async _start(){const t=this.components.transportManager.getAddrs();for(const e of t){const{family:t,host:n,port:r,transport:s}=e.toOptions();if(!e.isThinWaistAddress()||"tcp"!==s)continue;if((0,tg.Y)(e))continue;if(4!==t)continue;const o=await this._getClient(),i=this.externalAddress??await o.externalIp(),a=(0,Xy.Z)(i);if(!0===a)throw new Error(`${i} is private - please set config.nat.externalIp to an externally routable IP or ensure you are not behind a double NAT`);if(null==a)throw new Error(`${i} is not an IP address`);const c=rg();eg(`opening uPnP connection from ${i}:${c} to ${n}:${r}`),await o.map({publicPort:c,localPort:r,localAddress:this.localAddress,protocol:"TCP"===s.toUpperCase()?"TCP":"UDP"}),this.components.addressManager.addObservedAddr((0,$.uv)({family:4,address:i,port:c},s))}}async _getClient(){return null!=this.client||(this.client=await async function(){throw new Error("Not supported in browsers")}((this.description,this.ttl,this.keepAlive,this.gateway))),this.client}async stop(){if(!Qy.jU&&null!=this.client)try{await this.client.close(),this.client=void 0}catch(t){eg.error(t)}}}const og=(0,i.kg)("libp2p:peer-record-updater");class ig{constructor(t){this.components=t,this.started=!1,this.update=this.update.bind(this)}isStarted(){return this.started}async start(){this.started=!0,this.components.transportManager.addEventListener("listener:listening",this.update),this.components.transportManager.addEventListener("listener:close",this.update),this.components.addressManager.addEventListener("change:addresses",this.update)}async stop(){this.started=!1,this.components.transportManager.removeEventListener("listener:listening",this.update),this.components.transportManager.removeEventListener("listener:close",this.update),this.components.addressManager.removeEventListener("change:addresses",this.update)}update(){Promise.resolve().then((async()=>{const t=new $y.K({peerId:this.components.peerId,multiaddrs:this.components.addressManager.getAddresses().map((t=>t.decapsulateCode((0,$.a_)("p2p").code)))}),e=await $y.X.seal(t,this.components.peerId);await this.components.peerStore.addressBook.consumePeerRecord(e)})).catch((t=>{og.error("Could not update self peer record: %o",t)}))}}class ag{constructor(t){this.dht=t}async findPeer(t,e={}){for await(const n of this.dht.findPeer(t,e))if("FINAL_PEER"===n.name)return n.peer;throw a(new Error(up.NOT_FOUND),dp.ERR_NOT_FOUND)}async*getClosestPeers(t,e={}){for await(const n of this.dht.getClosestPeers(t,e))"FINAL_PEER"===n.name&&(yield n.peer)}}var cg=n(52770);const lg={ERR_INVALID_PARAMETERS:"ERR_INVALID_PARAMETERS",ERR_NOT_FOUND:"ERR_NOT_FOUND"},ug=(0,i.kg)("libp2p:peer-store:address-book"),dg="change:multiaddrs";async function hg(){return!0}class pg{constructor(t,e,n){this.dispatchEvent=t,this.store=e,this.addressFilter=n??hg}async consumePeerRecord(t){ug.trace("consumePeerRecord await write lock");const e=await this.store.lock.writeLock();let n,r,s;ug.trace("consumePeerRecord got write lock");try{let e;try{e=$y.K.createFromProtobuf(t.payload)}catch(t){return ug.error("invalid peer record received"),!1}n=e.peerId;const o=e.multiaddrs;if(!n.equals(t.peerId))return ug("signing key does not match PeerId in the PeerRecord"),!1;if(null==o||0===o.length)return!1;if(await this.store.has(n)&&(r=await this.store.load(n),null!=r.peerRecordEnvelope)){const t=await $y.X.createFromProtobuf(r.peerRecordEnvelope),n=$y.K.createFromProtobuf(t.payload);if(n.seqNumber>=e.seqNumber)return ug("sequence number was lower or equal to existing sequence number - stored: %d received: %d",n.seqNumber,e.seqNumber),!1}const i=await fg(n,o,this.addressFilter,!0);s=await this.store.patchOrCreate(n,{addresses:i,peerRecordEnvelope:t.marshal().subarray()}),ug("stored provided peer record for %p",e.peerId)}finally{ug.trace("consumePeerRecord release write lock"),e()}return this.dispatchEvent(new pp.A(dg,{detail:{peerId:n,multiaddrs:s.addresses.map((({multiaddr:t})=>t)),oldMultiaddrs:null==r?[]:r.addresses.map((({multiaddr:t})=>t))}})),!0}async getRawEnvelope(t){ug.trace("getRawEnvelope await read lock");const e=await this.store.lock.readLock();ug.trace("getRawEnvelope got read lock");try{return(await this.store.load(t)).peerRecordEnvelope}catch(t){if(t.code!==lg.ERR_NOT_FOUND)throw t}finally{ug.trace("getRawEnvelope release read lock"),e()}}async getPeerRecord(t){const e=await this.getRawEnvelope(t);if(null!=e)return await $y.X.createFromProtobuf(e)}async get(t){t=(0,Ne.vL)(t),ug.trace("get wait for read lock");const e=await this.store.lock.readLock();ug.trace("get got read lock");try{return(await this.store.load(t)).addresses}catch(t){if(t.code!==lg.ERR_NOT_FOUND)throw t}finally{ug.trace("get release read lock"),e()}return[]}async set(t,e){if(t=(0,Ne.vL)(t),!Array.isArray(e))throw ug.error("multiaddrs must be an array of Multiaddrs"),new cg.s("multiaddrs must be an array of Multiaddrs",lg.ERR_INVALID_PARAMETERS);ug.trace("set await write lock");const n=await this.store.lock.writeLock();ug.trace("set got write lock");let r,s,o=!1;try{const n=await fg(t,e,this.addressFilter);if(0===n.length)return;try{if(r=await this.store.load(t),o=!0,new Set([...n.map((({multiaddr:t})=>t.toString())),...r.addresses.map((({multiaddr:t})=>t.toString()))]).size===r.addresses.length&&n.length===r.addresses.length)return}catch(t){if(t.code!==lg.ERR_NOT_FOUND)throw t}s=await this.store.patchOrCreate(t,{addresses:n}),ug("set multiaddrs for %p",t)}finally{ug.trace("set multiaddrs for %p",t),ug("set release write lock"),n()}this.dispatchEvent(new pp.A(dg,{detail:{peerId:t,multiaddrs:s.addresses.map((t=>t.multiaddr)),oldMultiaddrs:null==r?[]:r.addresses.map((({multiaddr:t})=>t))}})),o||this.dispatchEvent(new pp.A("peer",{detail:{id:t,multiaddrs:s.addresses.map((t=>t.multiaddr)),protocols:s.protocols}}))}async add(t,e){if(t=(0,Ne.vL)(t),!Array.isArray(e))throw ug.error("multiaddrs must be an array of Multiaddrs"),new cg.s("multiaddrs must be an array of Multiaddrs",lg.ERR_INVALID_PARAMETERS);ug.trace("add await write lock");const n=await this.store.lock.writeLock();let r,s,o;ug.trace("add got write lock");try{const n=await fg(t,e,this.addressFilter);if(0===n.length)return;try{if(s=await this.store.load(t),r=!0,new Set([...n.map((({multiaddr:t})=>t.toString())),...s.addresses.map((({multiaddr:t})=>t.toString()))]).size===s.addresses.length)return}catch(t){if(t.code!==lg.ERR_NOT_FOUND)throw t}o=await this.store.mergeOrCreate(t,{addresses:n}),ug("added multiaddrs for %p",t)}finally{ug.trace("set release write lock"),n()}this.dispatchEvent(new pp.A(dg,{detail:{peerId:t,multiaddrs:o.addresses.map((t=>t.multiaddr)),oldMultiaddrs:null==s?[]:s.addresses.map((({multiaddr:t})=>t))}})),!0===r&&this.dispatchEvent(new pp.A("peer",{detail:{id:t,multiaddrs:o.addresses.map((t=>t.multiaddr)),protocols:o.protocols}}))}async delete(t){t=(0,Ne.vL)(t),ug.trace("delete await write lock");const e=await this.store.lock.writeLock();let n;ug.trace("delete got write lock");try{try{n=await this.store.load(t)}catch(t){if(t.code!==lg.ERR_NOT_FOUND)throw t}await this.store.patchOrCreate(t,{addresses:[]})}finally{ug.trace("delete release write lock"),e()}null!=n&&this.dispatchEvent(new pp.A(dg,{detail:{peerId:t,multiaddrs:[],oldMultiaddrs:null==n?[]:n.addresses.map((({multiaddr:t})=>t))}}))}}async function fg(t,e,n,r=!1){const s=[];return await Promise.all(e.map((async e=>{if(!(0,$.h2)(e))throw ug.error("multiaddr must be an instance of Multiaddr"),new cg.s("multiaddr must be an instance of Multiaddr",lg.ERR_INVALID_PARAMETERS);await n(t,e)&&s.push({multiaddr:e,isCertified:r})}))),s}const yg=(0,i.kg)("libp2p:peer-store:key-book"),gg="change:pubkey";class wg{constructor(t,e){this.dispatchEvent=t,this.store=e}async set(t,e){if(t=(0,Ne.vL)(t),!(e instanceof Uint8Array))throw yg.error("publicKey must be an instance of Uint8Array to store data"),new cg.s("publicKey must be an instance of PublicKey",lg.ERR_INVALID_PARAMETERS);yg.trace("set await write lock");const n=await this.store.lock.writeLock();yg.trace("set got write lock");let r,s=!1;try{try{if(r=await this.store.load(t),null!=r.pubKey&&(0,vt.f)(r.pubKey,e))return}catch(t){if(t.code!==lg.ERR_NOT_FOUND)throw t}await this.store.patchOrCreate(t,{pubKey:e}),s=!0}finally{yg.trace("set release write lock"),n()}s&&this.dispatchEvent(new pp.A(gg,{detail:{peerId:t,publicKey:e,oldPublicKey:null==r?void 0:r.pubKey}}))}async get(t){t=(0,Ne.vL)(t),yg.trace("get await write lock");const e=await this.store.lock.readLock();yg.trace("get got write lock");try{return(await this.store.load(t)).pubKey}catch(t){if(t.code!==lg.ERR_NOT_FOUND)throw t}finally{yg("get release write lock"),e()}}async delete(t){t=(0,Ne.vL)(t),yg.trace("delete await write lock");const e=await this.store.lock.writeLock();let n;yg.trace("delete got write lock");try{try{n=await this.store.load(t)}catch(t){if(t.code!==lg.ERR_NOT_FOUND)throw t}await this.store.patchOrCreate(t,{pubKey:void 0})}catch(t){if(t.code!==lg.ERR_NOT_FOUND)throw t}finally{yg.trace("delete release write lock"),e()}this.dispatchEvent(new pp.A(gg,{detail:{peerId:t,publicKey:void 0,oldPublicKey:null==n?void 0:n.pubKey}}))}}const mg=(0,i.kg)("libp2p:peer-store:metadata-book"),bg="change:metadata";class Eg{constructor(t,e){this.dispatchEvent=t,this.store=e}async get(t){t=(0,Ne.vL)(t),mg.trace("get await read lock");const e=await this.store.lock.readLock();mg.trace("get got read lock");try{return(await this.store.load(t)).metadata}catch(t){if(t.code!==lg.ERR_NOT_FOUND)throw t}finally{mg.trace("get release read lock"),e()}return new Map}async getValue(t,e){t=(0,Ne.vL)(t),mg.trace("getValue await read lock");const n=await this.store.lock.readLock();mg.trace("getValue got read lock");try{return(await this.store.load(t)).metadata.get(e)}catch(t){if(t.code!==lg.ERR_NOT_FOUND)throw t}finally{mg.trace("getValue release write lock"),n()}}async set(t,e){if(t=(0,Ne.vL)(t),!(e instanceof Map))throw mg.error("valid metadata must be provided to store data"),new cg.s("valid metadata must be provided",lg.ERR_INVALID_PARAMETERS);mg.trace("set await write lock");const n=await this.store.lock.writeLock();let r;mg.trace("set got write lock");try{try{r=await this.store.load(t)}catch(t){if(t.code!==lg.ERR_NOT_FOUND)throw t}await this.store.mergeOrCreate(t,{metadata:e})}finally{mg.trace("set release write lock"),n()}this.dispatchEvent(new pp.A(bg,{detail:{peerId:t,metadata:e,oldMetadata:null==r?new Map:r.metadata}}))}async setValue(t,e,n){if(t=(0,Ne.vL)(t),"string"!=typeof e||!(n instanceof Uint8Array))throw mg.error("valid key and value must be provided to store data"),new cg.s("valid key and value must be provided",lg.ERR_INVALID_PARAMETERS);mg.trace("setValue await write lock");const r=await this.store.lock.writeLock();let s,o;mg.trace("setValue got write lock");try{try{s=await this.store.load(t);const r=s.metadata.get(e);if(null!=r&&(0,vt.f)(n,r))return}catch(t){if(t.code!==lg.ERR_NOT_FOUND)throw t}o=await this.store.mergeOrCreate(t,{metadata:new Map([[e,n]])})}finally{mg.trace("setValue release write lock"),r()}this.dispatchEvent(new pp.A(bg,{detail:{peerId:t,metadata:o.metadata,oldMetadata:null==s?new Map:s.metadata}}))}async delete(t){t=(0,Ne.vL)(t),mg.trace("delete await write lock");const e=await this.store.lock.writeLock();let n;mg.trace("delete got write lock");try{try{n=await this.store.load(t)}catch(t){if(t.code!==lg.ERR_NOT_FOUND)throw t}null!=n&&await this.store.patch(t,{metadata:new Map})}finally{mg.trace("delete release write lock"),e()}null!=n&&this.dispatchEvent(new pp.A(bg,{detail:{peerId:t,metadata:new Map,oldMetadata:n.metadata}}))}async deleteValue(t,e){t=(0,Ne.vL)(t),mg.trace("deleteValue await write lock");const n=await this.store.lock.writeLock();let r,s;mg.trace("deleteValue got write lock");try{s=await this.store.load(t),r=s.metadata,r.delete(e),await this.store.patch(t,{metadata:r})}catch(t){if(t.code!==lg.ERR_NOT_FOUND)throw t}finally{mg.trace("deleteValue release write lock"),n()}null!=r&&this.dispatchEvent(new pp.A(bg,{detail:{peerId:t,metadata:r,oldMetadata:null==s?new Map:s.metadata}}))}}const _g=(0,i.kg)("libp2p:peer-store:proto-book"),vg="change:protocols";class kg{constructor(t,e){this.dispatchEvent=t,this.store=e}async get(t){_g.trace("get wait for read lock");const e=await this.store.lock.readLock();_g.trace("get got read lock");try{return(await this.store.load(t)).protocols}catch(t){if(t.code!==lg.ERR_NOT_FOUND)throw t}finally{_g.trace("get release read lock"),e()}return[]}async set(t,e){if(t=(0,Ne.vL)(t),!Array.isArray(e))throw _g.error("protocols must be provided to store data"),new cg.s("protocols must be provided",lg.ERR_INVALID_PARAMETERS);_g.trace("set await write lock");const n=await this.store.lock.writeLock();let r,s;_g.trace("set got write lock");try{try{if(r=await this.store.load(t),new Set([...e]).size===r.protocols.length)return}catch(t){if(t.code!==lg.ERR_NOT_FOUND)throw t}s=await this.store.patchOrCreate(t,{protocols:e}),_g("stored provided protocols for %p",t)}finally{_g.trace("set release write lock"),n()}this.dispatchEvent(new pp.A(vg,{detail:{peerId:t,protocols:s.protocols,oldProtocols:null==r?[]:r.protocols}}))}async add(t,e){if(t=(0,Ne.vL)(t),!Array.isArray(e))throw _g.error("protocols must be provided to store data"),new cg.s("protocols must be provided",lg.ERR_INVALID_PARAMETERS);_g.trace("add await write lock");const n=await this.store.lock.writeLock();let r,s;_g.trace("add got write lock");try{try{if(r=await this.store.load(t),new Set([...r.protocols,...e]).size===r.protocols.length)return}catch(t){if(t.code!==lg.ERR_NOT_FOUND)throw t}s=await this.store.mergeOrCreate(t,{protocols:e}),_g("added provided protocols for %p",t)}finally{_g.trace("add release write lock"),n()}this.dispatchEvent(new pp.A(vg,{detail:{peerId:t,protocols:s.protocols,oldProtocols:null==r?[]:r.protocols}}))}async remove(t,e){if(t=(0,Ne.vL)(t),!Array.isArray(e))throw _g.error("protocols must be provided to store data"),new cg.s("protocols must be provided",lg.ERR_INVALID_PARAMETERS);_g.trace("remove await write lock");const n=await this.store.lock.writeLock();let r,s;_g.trace("remove got write lock");try{try{r=await this.store.load(t);const n=new Set(r.protocols);for(const t of e)n.delete(t);if(r.protocols.length===n.size)return;e=Array.from(n)}catch(t){if(t.code!==lg.ERR_NOT_FOUND)throw t}s=await this.store.patchOrCreate(t,{protocols:e})}finally{_g.trace("remove release write lock"),n()}this.dispatchEvent(new pp.A(vg,{detail:{peerId:t,protocols:s.protocols,oldProtocols:null==r?[]:r.protocols}}))}async delete(t){t=(0,Ne.vL)(t),_g.trace("delete await write lock");const e=await this.store.lock.writeLock();let n;_g.trace("delete got write lock");try{try{n=await this.store.load(t)}catch(t){if(t.code!==lg.ERR_NOT_FOUND)throw t}await this.store.patchOrCreate(t,{protocols:[]})}finally{_g.trace("delete release write lock"),e()}null!=n&&this.dispatchEvent(new pp.A(vg,{detail:{peerId:t,protocols:[],oldProtocols:n.protocols}}))}}Yp._configure(),qp._configure(Gp),Wp._configure(Zp);const Rg=["uint64","int64","sint64","fixed64","sfixed64"];function Sg(t){return function(t){for(const e of Rg){if(null==t[e])continue;const n=t[e];t[e]=function(){return BigInt(n.call(this).toString())}}return t}(new qp(t))}function Tg(){return function(t){for(const e of Rg){if(null==t[e])continue;const n=t[e];t[e]=function(t){return n.call(this,t.toString())}}return t}(Wp.create())}function Ag(t,e){const n=Sg(t instanceof Uint8Array?t:t.subarray());return e.decode(n)}function Ig(t,e){const n=Tg();return e.encode(t,n,{lengthDelimited:!1}),n.finish()}var Dg,Pg,Ng,Og;function Lg(t,e){return function(t,e,n,r){return{name:t,type:e,encode:n,decode:r}}("message",Dg.LENGTH_DELIMITED,t,e)}!function(t){t[t.VARINT=0]="VARINT",t[t.BIT64=1]="BIT64",t[t.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",t[t.START_GROUP=3]="START_GROUP",t[t.END_GROUP=4]="END_GROUP",t[t.BIT32=5]="BIT32"}(Dg||(Dg={})),function(t){let e;t.codec=()=>(null==e&&(e=Lg(((t,e,n={})=>{if(!1!==n.lengthDelimited&&e.fork(),null!=t.addresses)for(const n of t.addresses)e.uint32(10),Ng.codec().encode(n,e);if(null!=t.protocols)for(const n of t.protocols)e.uint32(18),e.string(n);if(null!=t.metadata)for(const n of t.metadata)e.uint32(26),Og.codec().encode(n,e);null!=t.pubKey&&(e.uint32(34),e.bytes(t.pubKey)),null!=t.peerRecordEnvelope&&(e.uint32(42),e.bytes(t.peerRecordEnvelope)),!1!==n.lengthDelimited&&e.ldelim()}),((t,e)=>{const n={addresses:[],protocols:[],metadata:[]},r=null==e?t.len:t.pos+e;for(;t.pos<r;){const e=t.uint32();switch(e>>>3){case 1:n.addresses.push(Ng.codec().decode(t,t.uint32()));break;case 2:n.protocols.push(t.string());break;case 3:n.metadata.push(Og.codec().decode(t,t.uint32()));break;case 4:n.pubKey=t.bytes();break;case 5:n.peerRecordEnvelope=t.bytes();break;default:t.skipType(7&e)}}return n}))),e),t.encode=e=>Ig(e,t.codec()),t.decode=e=>Ag(e,t.codec())}(Pg||(Pg={})),function(t){let e;t.codec=()=>(null==e&&(e=Lg(((t,e,n={})=>{!1!==n.lengthDelimited&&e.fork(),null!=t.multiaddr&&t.multiaddr.byteLength>0&&(e.uint32(10),e.bytes(t.multiaddr)),null!=t.isCertified&&(e.uint32(16),e.bool(t.isCertified)),!1!==n.lengthDelimited&&e.ldelim()}),((t,e)=>{const n={multiaddr:new Uint8Array(0)},r=null==e?t.len:t.pos+e;for(;t.pos<r;){const e=t.uint32();switch(e>>>3){case 1:n.multiaddr=t.bytes();break;case 2:n.isCertified=t.bool();break;default:t.skipType(7&e)}}return n}))),e),t.encode=e=>Ig(e,t.codec()),t.decode=e=>Ag(e,t.codec())}(Ng||(Ng={})),function(t){let e;t.codec=()=>(null==e&&(e=Lg(((t,e,n={})=>{!1!==n.lengthDelimited&&e.fork(),null!=t.key&&""!==t.key&&(e.uint32(10),e.string(t.key)),null!=t.value&&t.value.byteLength>0&&(e.uint32(18),e.bytes(t.value)),!1!==n.lengthDelimited&&e.ldelim()}),((t,e)=>{const n={key:"",value:new Uint8Array(0)},r=null==e?t.len:t.pos+e;for(;t.pos<r;){const e=t.uint32();switch(e>>>3){case 1:n.key=t.string();break;case 2:n.value=t.bytes();break;default:t.skipType(7&e)}}return n}))),e),t.encode=e=>Ig(e,t.codec()),t.decode=e=>Ag(e,t.codec())}(Og||(Og={}));const Cg=(0,i.kg)("libp2p:peer-store:store"),Mg="/peers/";class xg{constructor(t){this.components=t,this.lock=(0,Ua.Z)({name:"peer-store",singleProcess:!0})}_peerIdToDatastoreKey(t){if(null==t.type)throw Cg.error("peerId must be an instance of peer-id to store data"),new cg.s("peerId must be an instance of peer-id",lg.ERR_INVALID_PARAMETERS);const e=t.toCID().toString();return new be.s(`${Mg}${e}`)}async has(t){return await this.components.datastore.has(this._peerIdToDatastoreKey(t))}async delete(t){await this.components.datastore.delete(this._peerIdToDatastoreKey(t))}async load(t){const e=await this.components.datastore.get(this._peerIdToDatastoreKey(t)),n=Pg.decode(e),r=new Map;for(const t of n.metadata)r.set(t.key,t.value);return{...n,id:t,addresses:n.addresses.map((({multiaddr:t,isCertified:e})=>({multiaddr:(0,$.HM)(t),isCertified:e??!1}))),metadata:r,pubKey:n.pubKey??void 0,peerRecordEnvelope:n.peerRecordEnvelope??void 0}}async save(t){if(null!=t.pubKey&&null!=t.id.publicKey&&!(0,vt.f)(t.pubKey,t.id.publicKey))throw Cg.error("peer publicKey bytes do not match peer id publicKey bytes"),new cg.s("publicKey bytes do not match peer id publicKey bytes",lg.ERR_INVALID_PARAMETERS);const e=new Set,n=t.addresses.filter((t=>!e.has(t.multiaddr.toString())&&(e.add(t.multiaddr.toString()),!0))).sort(((t,e)=>t.multiaddr.toString().localeCompare(e.multiaddr.toString()))).map((({multiaddr:t,isCertified:e})=>({multiaddr:t.bytes,isCertified:e}))),r=[];[...t.metadata.keys()].sort().forEach((e=>{const n=t.metadata.get(e);null!=n&&r.push({key:e,value:n})}));const s=Pg.encode({addresses:n,protocols:t.protocols.sort(),pubKey:t.pubKey,metadata:r,peerRecordEnvelope:t.peerRecordEnvelope});return await this.components.datastore.put(this._peerIdToDatastoreKey(t.id),s.subarray()),await this.load(t.id)}async patch(t,e){const n=await this.load(t);return await this._patch(t,e,n)}async patchOrCreate(t,e){let n;try{n=await this.load(t)}catch(e){if(e.code!==lg.ERR_NOT_FOUND)throw e;n={id:t,addresses:[],protocols:[],metadata:new Map}}return await this._patch(t,e,n)}async _patch(t,e,n){return await this.save({...n,...e,id:t})}async merge(t,e){const n=await this.load(t);return await this._merge(t,e,n)}async mergeOrCreate(t,e){let n;try{n=await this.load(t)}catch(e){if(e.code!==lg.ERR_NOT_FOUND)throw e;n={id:t,addresses:[],protocols:[],metadata:new Map}}return await this._merge(t,e,n)}async _merge(t,e,n){const r=new Map;return n.addresses.forEach((t=>{r.set(t.multiaddr.toString(),t.isCertified)})),(e.addresses??[]).forEach((t=>{const e=t.multiaddr.toString(),n=Boolean(r.get(e))||t.isCertified;r.set(e,n)})),await this.save({id:t,addresses:Array.from(r.entries()).map((([t,e])=>({multiaddr:(0,$.HM)(t),isCertified:e}))),protocols:Array.from(new Set([...n.protocols??[],...e.protocols??[]])),metadata:new Map([...n.metadata?.entries()??[],...e.metadata?.entries()??[]]),pubKey:e.pubKey??(null!=n?n.pubKey:void 0),peerRecordEnvelope:e.peerRecordEnvelope??(null!=n?n.peerRecordEnvelope:void 0)})}async*all(){for await(const t of this.components.datastore.queryKeys({prefix:Mg})){const e=t.toString().split("/")[2],n=U.base32.decode(e);yield this.load((0,Ne.cv)(n))}}}var Bg,zg;!function(t){let e;t.codec=()=>(null==e&&(e=Lg(((t,e,n={})=>{if(!1!==n.lengthDelimited&&e.fork(),null!=t.tags)for(const n of t.tags)e.uint32(10),zg.codec().encode(n,e);!1!==n.lengthDelimited&&e.ldelim()}),((t,e)=>{const n={tags:[]},r=null==e?t.len:t.pos+e;for(;t.pos<r;){const e=t.uint32();if(e>>>3==1)n.tags.push(zg.codec().decode(t,t.uint32()));else t.skipType(7&e)}return n}))),e),t.encode=e=>Ig(e,t.codec()),t.decode=e=>Ag(e,t.codec())}(Bg||(Bg={})),function(t){let e;t.codec=()=>(null==e&&(e=Lg(((t,e,n={})=>{!1!==n.lengthDelimited&&e.fork(),null!=t.name&&""!==t.name&&(e.uint32(10),e.string(t.name)),null!=t.value&&(e.uint32(16),e.uint32(t.value)),null!=t.expiry&&(e.uint32(24),e.uint64(t.expiry)),!1!==n.lengthDelimited&&e.ldelim()}),((t,e)=>{const n={name:""},r=null==e?t.len:t.pos+e;for(;t.pos<r;){const e=t.uint32();switch(e>>>3){case 1:n.name=t.string();break;case 2:n.value=t.uint32();break;case 3:n.expiry=t.uint64();break;default:t.skipType(7&e)}}return n}))),e),t.encode=e=>Ig(e,t.codec()),t.decode=e=>Ag(e,t.codec())}(zg||(zg={}));const Ug=(0,i.kg)("libp2p:peer-store");class jg extends pp.v{constructor(t,e={}){super(),this.components=t,this.store=new xg(t),this.addressBook=new pg(this.dispatchEvent.bind(this),this.store,e.addressFilter),this.keyBook=new wg(this.dispatchEvent.bind(this),this.store),this.metadataBook=new Eg(this.dispatchEvent.bind(this),this.store),this.protoBook=new kg(this.dispatchEvent.bind(this),this.store)}async forEach(t){Ug.trace("getPeers await read lock");const e=await this.store.lock.readLock();Ug.trace("getPeers got read lock");try{for await(const e of this.store.all())e.id.equals(this.components.peerId)||t(e)}finally{Ug.trace("getPeers release read lock"),e()}}async all(){const t=[];return await this.forEach((e=>{t.push(e)})),t}async delete(t){Ug.trace("delete await write lock");const e=await this.store.lock.writeLock();Ug.trace("delete got write lock");try{await this.store.delete(t)}finally{Ug.trace("delete release write lock"),e()}}async get(t){Ug.trace("get await read lock");const e=await this.store.lock.readLock();Ug.trace("get got read lock");try{return await this.store.load(t)}finally{Ug.trace("get release read lock"),e()}}async has(t){Ug.trace("has await read lock");const e=await this.store.lock.readLock();Ug.trace("has got read lock");try{return await this.store.has(t)}finally{Ug.trace("has release read lock"),e()}}async tagPeer(t,e,n={}){const r=n.value??0,s=Math.round(r),o=n.ttl??void 0;if(s!==r||s<0||s>100)throw new cg.s("Tag value must be between 0-100","ERR_TAG_VALUE_OUT_OF_BOUNDS");const i=await this.metadataBook.getValue(t,"tags");let a=[];null!=i&&(a=Bg.decode(i).tags),a=a.filter((t=>t.name!==e)),a.push({name:e,value:s,expiry:null==o?void 0:BigInt(Date.now()+o)}),await this.metadataBook.setValue(t,"tags",Bg.encode({tags:a}).subarray())}async unTagPeer(t,e){const n=await this.metadataBook.getValue(t,"tags");let r=[];null!=n&&(r=Bg.decode(n).tags),r=r.filter((t=>t.name!==e)),await this.metadataBook.setValue(t,"tags",Bg.encode({tags:r}).subarray())}async getTags(t){const e=await this.metadataBook.getValue(t,"tags");let n=[];null!=e&&(n=Bg.decode(e).tags);const r=BigInt(Date.now()),s=n.filter((t=>null==t.expiry||t.expiry>r));return s.length!==n.length&&await this.metadataBook.setValue(t,"tags",Bg.encode({tags:s}).subarray()),s.map((t=>({name:t.name,value:t.value??0})))}}class $g{constructor(t){this.dht=t}async provide(t){await(0,Cn.Z)(this.dht.provide(t))}async*findProviders(t,e={}){for await(const n of this.dht.findProviders(t,e))"PROVIDER"===n.name&&(yield*n.providers)}async put(t,e,n){await(0,Cn.Z)(this.dht.put(t,e,n))}async get(t,e){for await(const n of this.dht.get(t,e))if("VALUE"===n.name)return n.value;throw a(new Error("Not found"),"ERR_NOT_FOUND")}}class Vg{constructor(t={}){this._started=!1,this._peerId=t.peerId,this._addressManager=t.addressManager,this._peerStore=t.peerStore,this._upgrader=t.upgrader,this._metrics=t.metrics,this._registrar=t.registrar,this._connectionManager=t.connectionManager,this._transportManager=t.transportManager,this._connectionGater=t.connectionGater,this._contentRouting=t.contentRouting,this._peerRouting=t.peerRouting,this._datastore=t.datastore,this._connectionProtector=t.connectionProtector,this._dht=t.dht,this._pubsub=t.pubsub,this._dialer=t.dialer}isStarted(){return this._started}async beforeStart(){await Promise.all(Object.values(this).filter((t=>(0,fp.qK)(t))).map((async t=>{null!=t.beforeStart&&await t.beforeStart()})))}async start(){await Promise.all(Object.values(this).filter((t=>(0,fp.qK)(t))).map((async t=>{await t.start()}))),this._started=!0}async afterStart(){await Promise.all(Object.values(this).filter((t=>(0,fp.qK)(t))).map((async t=>{null!=t.afterStart&&await t.afterStart()})))}async beforeStop(){await Promise.all(Object.values(this).filter((t=>(0,fp.qK)(t))).map((async t=>{null!=t.beforeStop&&await t.beforeStop()})))}async stop(){await Promise.all(Object.values(this).filter((t=>(0,fp.qK)(t))).map((async t=>{await t.stop()}))),this._started=!1}async afterStop(){await Promise.all(Object.values(this).filter((t=>(0,fp.qK)(t))).map((async t=>{null!=t.afterStop&&await t.afterStop()})))}get peerId(){if(null==this._peerId)throw a(new Error("peerId not set"),"ERR_SERVICE_MISSING");return this._peerId}set peerId(t){this._peerId=t}get addressManager(){if(null==this._addressManager)throw a(new Error("addressManager not set"),"ERR_SERVICE_MISSING");return this._addressManager}set addressManager(t){this._addressManager=t}get peerStore(){if(null==this._peerStore)throw a(new Error("peerStore not set"),"ERR_SERVICE_MISSING");return this._peerStore}set peerStore(t){this._peerStore=t}get upgrader(){if(null==this._upgrader)throw a(new Error("upgrader not set"),"ERR_SERVICE_MISSING");return this._upgrader}set upgrader(t){this._upgrader=t}get registrar(){if(null==this._registrar)throw a(new Error("registrar not set"),"ERR_SERVICE_MISSING");return this._registrar}set registrar(t){this._registrar=t}get connectionManager(){if(null==this._connectionManager)throw a(new Error("connectionManager not set"),"ERR_SERVICE_MISSING");return this._connectionManager}set connectionManager(t){this._connectionManager=t}get transportManager(){if(null==this._transportManager)throw a(new Error("transportManager not set"),"ERR_SERVICE_MISSING");return this._transportManager}set transportManager(t){this._transportManager=t}get connectionGater(){if(null==this._connectionGater)throw a(new Error("connectionGater not set"),"ERR_SERVICE_MISSING");return this._connectionGater}set connectionGater(t){this._connectionGater=t}get contentRouting(){if(null==this._contentRouting)throw a(new Error("contentRouting not set"),"ERR_SERVICE_MISSING");return this._contentRouting}set contentRouting(t){this._contentRouting=t}get peerRouting(){if(null==this._peerRouting)throw a(new Error("peerRouting not set"),"ERR_SERVICE_MISSING");return this._peerRouting}set peerRouting(t){this._peerRouting=t}get datastore(){if(null==this._datastore)throw a(new Error("datastore not set"),"ERR_SERVICE_MISSING");return this._datastore}set datastore(t){this._datastore=t}get connectionProtector(){return this._connectionProtector}set connectionProtector(t){this._connectionProtector=t}get dialer(){if(null==this._dialer)throw a(new Error("dialer not set"),"ERR_SERVICE_MISSING");return this._dialer}set dialer(t){this._dialer=t}get metrics(){return this._metrics}set metrics(t){this._metrics=t}get dht(){return this._dht}set dht(t){this._dht=t}get pubsub(){return this._pubsub}set pubsub(t){this._pubsub=t}}var Hg=n(78431);const Fg={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:t=>t},connectionManager:{maxConnections:300,minConnections:50,autoDial:!0,autoDialInterval:1e4,maxParallelDials:100,maxDialsPerPeer:4,dialTimeout:3e4,inboundUpgradeTimeout:3e4,resolvers:{dnsaddr:Hg.I},addressSorter:Kf.F},connectionGater:{},transportManager:{faultTolerance:Bf.P7.FATAL_ALL},peerRouting:{refreshManager:{enabled:!0,interval:6e5,bootDelay:1e4}},nat:{enabled:!0,ttl:7200,keepAlive:!0},relay:{enabled:!0,advertise:{bootDelay:9e5,enabled:!1,ttl:18e5},hop:{enabled:!1,active:!1,timeout:3e4},autoRelay:{enabled:!1,maxListeners:2}},identify:{protocolPrefix:"ipfs",host:{agentVersion:Hy},timeout:6e4,maxInboundStreams:1,maxOutboundStreams:1,maxPushIncomingStreams:1,maxPushOutgoingStreams:1},ping:{protocolPrefix:"ipfs",maxInboundStreams:1,maxOutboundStreams:1,timeout:1e4},fetch:{protocolPrefix:"libp2p",maxInboundStreams:1,maxOutboundStreams:1,timeout:1e4}};var Kg=n(21017),qg=n(59769);class Gg extends pp.v{get[qg.N](){return!0}get[Symbol.toStringTag](){return"@libp2p/dummy-dht"}get wan(){throw a(new Error(up.DHT_DISABLED),dp.DHT_DISABLED)}get lan(){throw a(new Error(up.DHT_DISABLED),dp.DHT_DISABLED)}get(){throw a(new Error(up.DHT_DISABLED),dp.DHT_DISABLED)}findProviders(){throw a(new Error(up.DHT_DISABLED),dp.DHT_DISABLED)}findPeer(){throw a(new Error(up.DHT_DISABLED),dp.DHT_DISABLED)}getClosestPeers(){throw a(new Error(up.DHT_DISABLED),dp.DHT_DISABLED)}provide(){throw a(new Error(up.DHT_DISABLED),dp.DHT_DISABLED)}put(){throw a(new Error(up.DHT_DISABLED),dp.DHT_DISABLED)}async getMode(){throw a(new Error(up.DHT_DISABLED),dp.DHT_DISABLED)}async setMode(){throw a(new Error(up.DHT_DISABLED),dp.DHT_DISABLED)}async refreshRoutingTable(){throw a(new Error(up.DHT_DISABLED),dp.DHT_DISABLED)}}class Wg extends pp.v{constructor(){super(...arguments),this.topicValidators=new Map}isStarted(){return!1}start(){}stop(){}get globalSignaturePolicy(){throw a(new Error(up.PUBSUB_DISABLED),dp.ERR_PUBSUB_DISABLED)}get multicodecs(){throw a(new Error(up.PUBSUB_DISABLED),dp.ERR_PUBSUB_DISABLED)}getPeers(){throw a(new Error(up.PUBSUB_DISABLED),dp.ERR_PUBSUB_DISABLED)}getTopics(){throw a(new Error(up.PUBSUB_DISABLED),dp.ERR_PUBSUB_DISABLED)}subscribe(){throw a(new Error(up.PUBSUB_DISABLED),dp.ERR_PUBSUB_DISABLED)}unsubscribe(){throw a(new Error(up.PUBSUB_DISABLED),dp.ERR_PUBSUB_DISABLED)}getSubscribers(){throw a(new Error(up.PUBSUB_DISABLED),dp.ERR_PUBSUB_DISABLED)}async publish(){throw a(new Error(up.PUBSUB_DISABLED),dp.ERR_PUBSUB_DISABLED)}}var Zg=n(35103);const Yg=(0,i.kg)("libp2p:dialer:dial-request");class Jg{constructor(t){const{addrs:e,dialAction:n,dialer:r}=t;this.addrs=e,this.dialer=r,this.dialAction=n}async run(t={}){const e=this.dialer.getTokens(this.addrs.length);if(e.length<1)throw a(new Error("No dial tokens available"),dp.ERR_NO_DIAL_TOKENS);const n=new Zg;for(const t of e)n.push(t).catch((t=>{Yg.error(t)}));const r=this.addrs.map((()=>{const t=new AbortController;try{(0,Ep.setMaxListeners)?.(1/0,t.signal)}catch{}return t}));if(null!=t.signal)try{(0,Ep.setMaxListeners)?.(1/0,t.signal)}catch{}let s=0,o=!1;try{return await Promise.any(this.addrs.map((async(i,c)=>{const l=await n.shift();if(o)throw this.dialer.releaseToken(e.splice(e.indexOf(l),1)[0]),a(new Error("dialAction already succeeded"),dp.ERR_ALREADY_SUCCEEDED);const u=r[c];if(null==u)throw a(new Error("dialAction did not come with an AbortController"),dp.ERR_INVALID_PARAMETERS);let d;try{const e=u.signal;d=await this.dialAction(i,{...t,signal:null!=t.signal?(0,dr.anySignal)([e,t.signal]):e}),r[c]=void 0}finally{s++,this.addrs.length-s>=e.length?n.push(l).catch((t=>{Yg.error(t)})):this.dialer.releaseToken(e.splice(e.indexOf(l),1)[0])}if(null==d)throw a(new Error("dialAction led to empty object"),dp.ERR_TRANSPORT_DIAL_FAILED);return o=!0,d})))}finally{r.forEach((t=>{void 0!==t&&t.abort()})),e.forEach((t=>this.dialer.releaseToken(t)))}}}const Qg=(0,i.kg)("libp2p:dialer");class Xg{constructor(t,e={}){this.started=!1,this.addressSorter=e.addressSorter??Kf.F,this.maxAddrsToDial=e.maxAddrsToDial??25,this.timeout=e.dialTimeout??3e4,this.maxDialsPerPeer=e.maxDialsPerPeer??4,this.tokens=[...new Array(e.maxParallelDials??100)].map(((t,e)=>e)),this.components=t,this.pendingDials=(0,wy.s)({name:"libp2p_dialler_pending_dials",metrics:t.metrics}),this.pendingDialTargets=(0,wy.s)({name:"libp2p_dialler_pending_dial_targets",metrics:t.metrics});for(const[t,n]of Object.entries(e.resolvers??{}))$.s_.set(t,n)}isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1;for(const t of this.pendingDials.values())try{t.controller.abort()}catch(t){Qg.error(t)}this.pendingDials.clear();for(const t of this.pendingDialTargets.values())t.abort();this.pendingDialTargets.clear()}async dial(t,e={}){const{peerId:n,multiaddr:r}=Bp(t);if(null!=n){if(this.components.peerId.equals(n))throw a(new Error("Tried to dial self"),dp.ERR_DIALED_SELF);if(null!=r&&(Qg("storing multiaddrs %p",n,r),await this.components.peerStore.addressBook.add(n,[r])),await this.components.connectionGater.denyDialPeer(n))throw a(new Error("The dial request is blocked by gater.allowDialPeer"),dp.ERR_PEER_DIAL_INTERCEPTED)}Qg("creating dial target for %p",n);const s=new AbortController,o=ew();this.pendingDialTargets.set(o,s);let i,c=s.signal;null!=e.signal&&(c=(0,dr.anySignal)([c,e.signal]));try{i=await this._createDialTarget({peerId:n,multiaddr:r},{...e,signal:c})}finally{this.pendingDialTargets.delete(o)}if(0===i.addrs.length)throw a(new Error("The dial request has no valid addresses"),dp.ERR_NO_VALID_ADDRESSES);const l=this.pendingDials.get(i.id)??this._createPendingDial(i,e);try{const t=await l.promise;return Qg("dial succeeded to %s",i.id),t}catch(t){throw Qg("dial failed to %s",i.id,t),l.controller.signal.aborted&&(t.code=dp.ERR_TIMEOUT),Qg.error(t),t}finally{l.destroy()}}async _createDialTarget(t,e){let n=[];if((0,$.h2)(t.multiaddr)&&n.push(t.multiaddr),!(0,$.h2)(t.multiaddr)&&(0,ze.I)(t.peerId)&&n.push(...await this._loadAddresses(t.peerId)),n=(await Promise.all(n.map((async t=>await this._resolve(t,e))))).flat().filter((t=>Boolean(this.components.transportManager.transportForMultiaddr(t)))),n=[...new Set(n.map((t=>t.toString())))].map((t=>(0,$.HM)(t))),n.length>this.maxAddrsToDial)throw a(new Error("dial with more addresses than allowed"),dp.ERR_TOO_MANY_ADDRESSES);const r=(0,ze.I)(t.peerId)?t.peerId:void 0;if(null!=r){const t=`/p2p/${r.toString()}`;n=n.map((e=>{const n=e.getPeerId();return null!=n&&r.equals(n)?e:e.encapsulate(t)}))}return{id:null==r?ew():r.toString(),addrs:n}}async _loadAddresses(t){const e=await this.components.peerStore.addressBook.get(t);return(await Promise.all(e.map((async e=>!await this.components.connectionGater.denyDialMultiaddr(t,e.multiaddr)&&e)))).filter(tw).sort(this.addressSorter).map((t=>t.multiaddr))}_createPendingDial(t,e={}){const n=new Jg({addrs:t.addrs,dialAction:async(t,e={})=>{if(!0===e.signal?.aborted)throw a(new Error("already aborted"),dp.ERR_ALREADY_ABORTED);return await this.components.transportManager.dial(t,e).catch((e=>{throw Qg.error("dial to %s failed",t,e),e}))},dialer:this}),r=new B.TimeoutController(this.timeout),s=[r.signal];null!=e.signal&&s.push(e.signal);const o=(0,dr.anySignal)(s);try{(0,Ep.setMaxListeners)?.(1/0,o)}catch{}const i={dialRequest:n,controller:r,promise:n.run({...e,signal:o}),destroy:()=>{r.clear(),this.pendingDials.delete(t.id)}};return this.pendingDials.set(t.id,i),i}getTokens(t){const e=Math.min(t,this.maxDialsPerPeer,this.tokens.length),n=this.tokens.splice(0,e);return Qg("%d tokens request, returning %d, %d remaining",t,e,this.tokens.length),n}releaseToken(t){this.tokens.includes(t)||(Qg("token %d released",t),this.tokens.push(t))}async _resolve(t,e){if(!t.protoNames().includes("dnsaddr"))return[t];const n=await this._resolveRecord(t,e);return(await Promise.all(n.map((async t=>await this._resolve(t,e))))).flat().reduce(((t,e)=>(null==t.find((t=>t.equals(e)))&&t.push(e),t)),[])}async _resolveRecord(t,e){try{t=(0,$.HM)(t.toString());return await t.resolve(e)}catch(e){return Qg.error(`multiaddr ${t.toString()} could not be resolved`,e),[]}}}function tw(t){return Boolean(t)}function ew(){return`${parseInt(String(1e9*Math.random()),10).toString()}${Date.now()}`}const nw=(0,i.kg)("libp2p");class rw extends pp.v{constructor(t){super(),this.started=!1,this.peerId=t.peerId;const e=this.components=new Vg({peerId:t.peerId,datastore:t.datastore??new yp,connectionGater:{denyDialPeer:async()=>await Promise.resolve(!1),denyDialMultiaddr:async()=>await Promise.resolve(!1),denyInboundConnection:async()=>await Promise.resolve(!1),denyOutboundConnection:async()=>await Promise.resolve(!1),denyInboundEncryptedConnection:async()=>await Promise.resolve(!1),denyOutboundEncryptedConnection:async()=>await Promise.resolve(!1),denyInboundUpgradedConnection:async()=>await Promise.resolve(!1),denyOutboundUpgradedConnection:async()=>await Promise.resolve(!1),filterMultiaddrForPeer:async()=>await Promise.resolve(!0),...t.connectionGater}});e.peerStore=new jg(e,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...t.peerStore}),this.services=[e],null!=t.metrics&&(this.metrics=this.components.metrics=this.configureComponent(t.metrics(this.components))),this.peerStore=this.components.peerStore,this.peerStore.addEventListener("peer",(t=>{const{detail:e}=t;this.dispatchEvent(new pp.A("peer:discovery",{detail:e}))})),null!=t.connectionProtector&&(this.components.connectionProtector=t.connectionProtector(e)),this.components.upgrader=new Uy(this.components,{connectionEncryption:(t.connectionEncryption??[]).map((t=>this.configureComponent(t(this.components)))),muxers:(t.streamMuxers??[]).map((t=>this.configureComponent(t(this.components)))),inboundUpgradeTimeout:t.connectionManager.inboundUpgradeTimeout}),this.components.dialer=new Xg(this.components,t.connectionManager),this.connectionManager=this.components.connectionManager=new jp(this.components,t.connectionManager),this.components.connectionManager.addEventListener("peer:disconnect",(t=>{this.dispatchEvent(new pp.A("peer:disconnect",{detail:t.detail}))})),this.components.connectionManager.addEventListener("peer:connect",(t=>{this.dispatchEvent(new pp.A("peer:connect",{detail:t.detail}))})),this.registrar=this.components.registrar=new xy(this.components),this.components.transportManager=new by(this.components,t.transportManager),this.components.addressManager=new Sp(this.components,t.addresses),this.configureComponent(new ig(this.components)),this.configureComponent(new Kp(this.components,{enabled:t.connectionManager.autoDial,minConnections:t.connectionManager.minConnections,autoDialInterval:t.connectionManager.autoDialInterval}));const n=yy.generateOptions();this.keychain=this.configureComponent(new yy(this.components,{...n,...t.keychain})),this.services.push(new sg(this.components,t.nat)),t.transports.forEach((t=>{this.components.transportManager.add(this.configureComponent(t(this.components)))})),this.identifyService=new Ky(this.components,{...t.identify}),this.configureComponent(this.identifyService),null!=t.dht?this.dht=this.components.dht=t.dht(this.components):this.dht=new Gg,null!=t.pubsub?this.pubsub=this.components.pubsub=t.pubsub(this.components):this.pubsub=new Wg;const r=(t.peerRouters??[]).map((t=>this.configureComponent(t(this.components))));null!=t.dht&&(r.push(this.configureComponent(new ag(this.dht))),this.dht.addEventListener("peer",(t=>{this.onDiscoveryPeer(t)}))),this.peerRouting=this.components.peerRouting=this.configureComponent(new vp(this.components,{...t.peerRouting,routers:r}));const s=(t.contentRouters??[]).map((t=>this.configureComponent(t(this.components))));null!=t.dht&&s.push(this.configureComponent(new $g(this.dht))),this.contentRouting=this.components.contentRouting=this.configureComponent(new kp(this.components,{routers:s})),t.relay.enabled&&(this.components.transportManager.add(this.configureComponent(new jf(this.components,t.relay))),this.configureComponent(new Yf(this.components,{addressSorter:t.connectionManager.addressSorter,...t.relay}))),this.fetchService=this.configureComponent(new Zy(this.components,{...t.fetch})),this.pingService=this.configureComponent(new Jy(this.components,{...t.ping}));for(const e of t.peerDiscovery??[]){this.configureComponent(e(this.components)).addEventListener("peer",(t=>{this.onDiscoveryPeer(t)}))}}configureComponent(t){return(0,fp.qK)(t)&&this.services.push(t),t}async start(){if(!this.started){this.started=!0,nw("libp2p is starting");try{await Promise.all(this.services.map((async t=>{null!=t.beforeStart&&await t.beforeStart()}))),await Promise.all(this.services.map((t=>t.start()))),await Promise.all(this.services.map((async t=>{null!=t.afterStart&&await t.afterStart()}))),nw("libp2p has started")}catch(t){throw nw.error("An error occurred starting libp2p",t),await this.stop(),t}}}async stop(){this.started&&(nw("libp2p is stopping"),this.started=!1,await Promise.all(this.services.map((async t=>{null!=t.beforeStop&&await t.beforeStop()}))),await Promise.all(this.services.map((t=>t.stop()))),await Promise.all(this.services.map((async t=>{null!=t.afterStop&&await t.afterStop()}))),nw("libp2p has stopped"))}isStarted(){return this.started}getConnections(t){return this.components.connectionManager.getConnections(t)}getPeers(){const t=new Lp;for(const e of this.components.connectionManager.getConnections())t.add(e.remotePeer);return Array.from(t)}async dial(t,e={}){return await this.components.connectionManager.openConnection(t,e)}async dialProtocol(t,e,n={}){if(null==e)throw a(new Error("no protocols were provided to open a stream"),dp.ERR_INVALID_PROTOCOLS_FOR_STREAM);if(0===(e=Array.isArray(e)?e:[e]).length)throw a(new Error("no protocols were provided to open a stream"),dp.ERR_INVALID_PROTOCOLS_FOR_STREAM);const r=await this.dial(t,n);return await r.newStream(e,n)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(t){(0,$.h2)(t)&&(t=(0,Ne.jE)(t.getPeerId()??"")),await this.components.connectionManager.closeConnections(t)}async getPublicKey(t,e={}){if(nw("getPublicKey %p",t),null!=t.publicKey)return t.publicKey;const n=await this.peerStore.get(t);if(null!=n.pubKey)return n.pubKey;if(null==this.dht)throw a(new Error("Public key was not in the peer store and the DHT is not enabled"),dp.ERR_NO_ROUTERS_AVAILABLE);const r=(0,tt.z)([(0,x.m)("/pk/"),t.multihash.digest]);for await(const n of this.dht.get(r,e))if("VALUE"===n.name){const e=(0,$e.unmarshalPublicKey)(n.value);return await this.peerStore.keyBook.set(t,n.value),e.bytes}throw a(new Error(`Node not responding with its public key: ${t.toString()}`),dp.ERR_INVALID_RECORD)}async fetch(t,e,n={}){if((0,$.h2)(t)){const e=(0,Ne.jE)(t.getPeerId()??"");await this.components.peerStore.addressBook.add(e,[t]),t=e}return await this.fetchService.fetch(t,e,n)}async ping(t,e={}){if((0,$.h2)(t)){const e=(0,Ne.jE)(t.getPeerId()??"");await this.components.peerStore.addressBook.add(e,[t]),t=e}return await this.pingService.ping(t,e)}async handle(t,e,n){Array.isArray(t)||(t=[t]),await Promise.all(t.map((async t=>{await this.components.registrar.handle(t,e,n)})))}async unhandle(t){Array.isArray(t)||(t=[t]),await Promise.all(t.map((async t=>{await this.components.registrar.unhandle(t)})))}async register(t,e){return await this.registrar.register(t,e)}unregister(t){this.registrar.unregister(t)}onDiscoveryPeer(t){const{detail:e}=t;e.id.toString()!==this.peerId.toString()?(e.multiaddrs.length>0&&this.components.peerStore.addressBook.add(e.id,e.multiaddrs).catch((t=>nw.error(t))),e.protocols.length>0&&this.components.peerStore.protoBook.set(e.id,e.protocols).catch((t=>nw.error(t))),this.dispatchEvent(new pp.A("peer:discovery",{detail:e}))):nw.error(new Error(dp.ERR_DISCOVERED_SELF))}}async function sw(t){if(null==t.peerId){const e=t.datastore;if(null!=e)try{const n=new yy({datastore:e},{...yy.generateOptions(),...t.keychain??{}});t.peerId=await n.exportPeerId("self")}catch(t){if("ERR_NOT_FOUND"!==t.code)throw t}}return null==t.peerId&&(t.peerId=await(0,Kg.n9)()),new rw(function(t){const e=(0,s.Z)(Fg,t);if(null==e.transports||e.transports.length<1)throw a(new Error(up.ERR_TRANSPORTS_REQUIRED),dp.ERR_TRANSPORTS_REQUIRED);if(null==e.connectionEncryption||0===e.connectionEncryption.length)throw a(new Error(up.CONN_ENCRYPTION_REQUIRED),dp.CONN_ENCRYPTION_REQUIRED);if(null===e.connectionProtector&&null!=globalThis.process?.env?.LIBP2P_FORCE_PNET)throw a(new Error(up.ERR_PROTECTOR_REQUIRED),dp.ERR_PROTECTOR_REQUIRED);return e.identify.host.agentVersion===Hy&&(Qy.UG||Qy.$l?e.identify.host.agentVersion+=` UserAgent=${globalThis.process.version}`:(Qy.jU||Qy.n2||Qy.iP||Qy.b$)&&(e.identify.host.agentVersion+=` UserAgent=${globalThis.navigator.userAgent}`)),e}(t))}var ow=n(99507);const iw="/dht/provider",aw=20,cw=3,lw=Number(3e5),uw=Number(3e4),dw=Number(3e5),hw=Number(3e4),pw=Number(3e4),fw=(0,x.m)("/pk/");function yw(t){return{...t,multiaddrs:t.multiaddrs.filter((t=>{const[[e,n]]=t.stringTuples();if(53===e||54===e||55===e)return"localhost"!==n;if(4!==e&&6!==e)return!1;if(null==n)return!1;const r=(0,Xy.Z)(n);return null==r||!r}))}}function gw(t){return{...t,multiaddrs:t.multiaddrs.filter((t=>{const[[e,n]]=t.stringTuples();if("localhost"===n)return!0;if(4!==e&&6!==e)return!1;if(null==n)return!1;const r=(0,Xy.Z)(n);return null!=r&&r}))}}async function ww(t){return(await Qs.sha256.digest(t)).digest}async function mw(t){return await ww(t.toBytes())}function bw(t){return new be.s(`/dht/record/${(0,H.B)(t,"base32")}`,!1)}function Ew(t,e){const n=new Date;return new qn.Y(t,e,n).serialize()}class _w{constructor(t,e){const{kBucketSize:n,pingTimeout:r,lan:s,pingConcurrency:o,protocol:a,tagName:c,tagValue:l}=e;this.components=t,this.log=(0,i.kg)(`libp2p:kad-dht:${s?"lan":"wan"}:routing-table`),this.kBucketSize=n??20,this.pingTimeout=r??1e4,this.pingConcurrency=o??10,this.lan=s,this.running=!1,this.protocol=a,this.tagName=c??"kad-close",this.tagValue=l??50;const u=()=>{this.metrics?.pingQueueSize.update(this.pingQueue.size),this.metrics?.pingRunning.update(this.pingQueue.pending)};this.pingQueue=new ki.Z({concurrency:this.pingConcurrency}),this.pingQueue.addListener("add",u),this.pingQueue.addListener("next",u),this._onPing=this._onPing.bind(this)}isStarted(){return this.running}async start(){this.running=!0,null!=this.components.metrics&&(this.metrics={routingTableSize:this.components.metrics.registerMetric(`libp2p_kad_dht_${this.lan?"lan":"wan"}_routing_table_size`),pingQueueSize:this.components.metrics.registerMetric(`libp2p_kad_dht_${this.lan?"lan":"wan"}_ping_queue_size`),pingRunning:this.components.metrics.registerMetric(`libp2p_kad_dht_${this.lan?"lan":"wan"}_ping_running`)});const t=new ow({localNodeId:await mw(this.components.peerId),numberOfNodesPerKBucket:this.kBucketSize,numberOfNodesToPing:1});this.kb=t,t.on("ping",this._onPing),this._tagPeers(t)}async stop(){this.running=!1,this.pingQueue.clear(),this.kb=void 0}_tagPeers(t){let e=new Lp;const n=function(t,e=100){let n;return()=>{clearTimeout(n),n=setTimeout((()=>{t()}),e)}}((()=>{const n=new Lp(t.closest(t.localNodeId,20).map((t=>t.peer))),r=n.difference(e),s=e.difference(n);Promise.resolve().then((async()=>{for(const t of r)await this.components.peerStore.tagPeer(t,this.tagName,{value:this.tagValue});for(const t of s)await this.components.peerStore.unTagPeer(t,this.tagName)})).catch((t=>{this.log.error("Could not update peer tags",t)})),e=n}));t.on("added",(()=>{n()})),t.on("removed",(()=>{n()}))}_onPing(t,e){this.pingQueue.add((async()=>{if(!this.running)return;let n=0;try{await Promise.all(t.map((async t=>{let e;try{e=new B.TimeoutController(this.pingTimeout);const r={signal:e.signal};this.log("pinging old contact %p",t.peer);const s=await this.components.connectionManager.openConnection(t.peer,r);(await s.newStream(this.protocol,r)).close(),n++}catch(e){this.running&&null!=this.kb&&(this.log.error("could not ping peer %p",t.peer,e),this.log("evicting old contact after ping failed %p",t),this.kb.remove(t.id))}finally{null!=e&&e.clear(),this.metrics?.routingTableSize.update(this.size)}}))),this.running&&n<t.length&&null!=this.kb&&(this.log("adding new contact %p",e.peer),this.kb.add(e))}catch(t){this.log.error("could not process k-bucket ping event",t)}})).catch((t=>{this.log.error("could not process k-bucket ping event",t)}))}get size(){return null==this.kb?0:this.kb.count()}async find(t){const e=await mw(t),n=this.closestPeer(e);if(null!=n&&t.equals(n))return n}closestPeer(t){const e=this.closestPeers(t,1);if(e.length>0)return e[0]}closestPeers(t,e=this.kBucketSize){if(null==this.kb)return[];return this.kb.closest(t,e).map((t=>t.peer))}async add(t){if(null==this.kb)throw new Error("RoutingTable is not started");const e=await mw(t);this.kb.add({id:e,peer:t}),this.log("added %p with kad id %b",t,e),this.metrics?.routingTableSize.update(this.size)}async remove(t){if(null==this.kb)throw new Error("RoutingTable is not started");const e=await mw(t);this.kb.remove(e),this.metrics?.routingTableSize.update(this.size)}}var vw=n(10460),kw=[77591,22417,43971,28421,740,29829,71467,228973,196661,78537,27689,36431,44415,14362,19456,106025,96308,2882,49509,21149,87173,131409,75844,23676,121838,30291,17492,2953,7564,110620,129477,127283,53113,72417,165166,109690,21200,102125,24049,71504,90342,25307,72039,26812,26715,32264,133800,71161,88956,171987,51779,24425,16671,30251,186294,247761,14202,2121,8465,35024,4876,85917,169730,3638,256836,96184,943,18678,6583,52907,35807,112254,214097,18796,11595,9243,23554,887,268203,382004,24590,111335,11625,16619,29039,102425,69006,97976,92362,32552,63717,41433,128974,137630,59943,10019,13986,35430,33665,108037,43799,43280,38195,29078,58629,18265,14425,46832,235538,40830,77881,110717,58937,3463,325358,51300,47623,117252,19007,10170,20540,91237,294813,4951,79841,56232,36270,128547,69209,66275,100156,32063,73531,34439,80937,28892,44466,88595,216307,32583,49620,16605,82127,45807,21630,78726,20235,40163,111007,96926,5567,72083,21665,58844,39419,179767,48328,42662,51550,5251,37811,49608,81056,50854,55513,20922,18891,197409,164656,32593,71449,220474,58919,85682,67854,13758,35066,3565,61905,214793,119572,141419,21504,10302,27354,67003,46131,32668,15165,64871,34450,17821,2757,11452,34189,5160,12257,85523,560,53385,65887,119549,135620,312353,115979,122356,10867,193231,124537,54783,90675,120791,4715,142253,50943,17271,43358,25331,4917,120566,34580,12878,33786,160528,32523,4869,301307,104817,81491,23276,8832,97911,31265,52065,7998,49622,9715,43998,34091,84587,20664,69041,29419,53205,10838,58288,116145,6185,5154,141795,35924,21307,144738,43730,12085,8279,10002,119,133779,199668,72938,31768,39176,67875,38453,9700,44144,4121,116048,41733,12868,82669,92308,128,34262,11332,7712,90764,36141,13553,71312,77470,117314,96549,49135,23602,54468,28605,6327,62308,17171,67531,21319,14105,894,107722,46157,8503,51069,100472,45138,15246,14577,35609,191464,1757,13364,161349,32067,91705,81144,52339,5408,91066,21983,14157,100545,4372,26630,129112,1423,29676,213626,4397,88436,99190,6877,49958,26122,114348,60661,29818,293118,50042,179738,16400,163423,89627,31040,43973,36638,45952,5153,1894,109322,1898,134021,12402,112077,68309,190269,69866,31938,107383,11522,105232,11248,14868,39852,71707,186525,16530,38162,106212,11700,5130,16608,26998,59586,108399,230033,43683,48135,82179,2073,5015,196684,189293,16378,23452,8301,35640,11632,214551,29240,57644,33137,91949,55157,52384,117313,5090,17717,89668,49363,82238,241035,66216,29066,184088,97206,62820,26595,4241,135635,173672,8202,459,71355,146294,29587,3008,135385,141203,14803,6634,45094,69362,50925,546,51884,62011,83296,234584,44515,56050,89476,87751,19373,12691,149923,19794,13833,35846,87557,58339,2884,19145,25647,12224,11024,77338,64608,122297,53025,7205,36189,36294,170779,21750,7739,173883,75192,35664,224240,113121,30181,26267,27036,117827,92015,106516,55628,203549,67949,60462,60844,35911,20457,1820,920,19773,8738,73173,181993,38521,98254,76257,46008,92796,5384,26868,151566,22124,2411,15919,186872,180021,28099,152961,78811,80237,62352,102653,74259,184890,16792,123702,224945,29940,19512,75283,14059,112691,92811,233329,20411,138569,53341,109802,50600,134528,66747,5529,166531,31578,64732,67189,1596,126357,967,167999,206598,109752,119431,207825,78791,91938,10301,27311,24233,252343,28831,32812,66002,112267,90895,8786,8095,16824,22866,21813,60507,174833,19549,130985,117051,52110,6938,81923,123864,38061,919,18680,53534,46739,112893,161529,85429,26761,11900,81121,91968,15390,217947,56524,1713,6654,37089,85630,138866,61850,16491,75577,16884,98296,73523,6140,44645,6062,36366,29844,57946,37932,42472,5266,20834,19309,33753,127182,134259,35810,41805,45878,312001,14881,47757,49251,120050,44252,3708,25856,107864,120347,1228,36550,41682,34496,47025,8393,173365,246526,12894,161607,35670,90785,126572,2095,124731,157033,58694,554,12786,9642,4817,16136,47864,174698,66992,4639,69284,10625,40710,27763,51738,30404,264105,137904,109882,52487,42824,57514,2740,10479,146799,107390,16586,88038,174951,9410,16185,44158,5568,40658,46108,12763,97385,26175,108859,664,230732,67470,46663,14395,50750,141320,93140,15361,47997,55784,6791,307840,118569,107326,18056,58281,260415,54691,8790,73332,45633,7511,45674,143373,14031,11799,94491,35646,96544,14560,26049,32983,25791,83814,42094,231370,63955,139212,2359,169908,3108,183486,105867,28197,32941,124968,26402,88267,149768,23053,3078,19091,52924,25383,19209,111548,97361,3959,24880,235061,9099,24921,161254,151405,20508,7159,34381,20133,11434,74036,19974,34769,36585,1076,22454,17354,38727,235160,111547,96454,117448,156940,91330,37299,7310,26915,117060,51369,22620,61861,322264,106850,111694,15091,2624,40345,300446,177064,1707,27389,54792,327783,132669,183543,59003,17744,20603,151134,106923,53084,71803,279424,319816,11579,21946,16728,38274,72711,5085,83391,88646,40159,25027,34680,10752,12988,54126,30365,18338,100445,230674,44874,84974,143877,123253,139372,28082,91477,144002,13096,219729,46016,50029,42377,14601,6660,58244,58978,23918,88206,113611,64452,17541,41032,10942,12021,49189,10978,40175,37156,10947,71709,106894,112538,57007,137486,150608,152719,40615,7746,279716,13101,19524,28708,40578,72320,1096,182051,94527,51275,22833,45164,81917,77519,48508,5421,140302,37845,149830,5587,27579,5357,428725,248187,6326,206760,39814,32585,89923,44341,288753,284443,96368,31201,94189,119504,20359,52073,103216,179,27934,32801,96035,34111,34309,101326,18198,20704,210266,37643,27880,141873,106e3,19414,56614,167714,66483,107885,86602,4379,20796,75467,4987,5017,118857,26003,34308,114428,29198,6686,29697,73632,3739,69795,16798,41504,7207,30722,21436,36735,28067,28545,3239,11221,36031,41889,100010,19247,317673,29495,174554,6424,129725,53845,94986,7955,59676,2604,191497,19735,102214,62954,23844,11872,179525,261436,34492,428,78404,142035,16747,17246,27578,37021,33672,57944,26056,135760,2369,61674,122066,31327,19374,157065,40553,130982,69619,71290,38855,72100,92903,95940,51422,165999,65713,57873,50726,7288,20272,2081,42326,22624,81120,57914,79352,19447,1684,72302,11774,302559,161481,96396,13692,414988,3721,79066,56627,46883,21150,11747,12184,5856,113458,176117,84416,52079,27933,3354,59765,141359,2212,216309,2555,23458,196722,142463,45701,44548,28798,19418,215,29916,9396,10574,114226,84475,13520,18694,34056,4524,90302,62930,13539,19407,77209,7728,38088,9535,2263,23875,183945,17750,26274,67172,10585,28042,22199,7478,51331,66030,26774,192929,31434,25850,50197,52926,178158,4679,181256,70184,229600,9959,105594,72158,73974,2726,35085,78087,23284,35568,51713,155676,5401,27254,11966,17569,223253,71993,103357,111477,55722,30504,26034,46774,35392,36285,214814,41143,163465,1051,16094,81044,6636,76489,179102,20712,39178,35683,125177,54219,30617,52994,25324,50123,2543,87529,58995,10688,125199,12388,60158,125481,131646,7642,133350,65874,3438,97277,101450,10075,56344,116821,50778,60547,98016,106135,13859,14255,16300,77373,173521,8285,45932,37426,4054,114295,55947,7703,39114,52,51119,128135,19714,60715,9554,50492,88180,2823,118271,52993,122625,97919,23859,37895,25040,33614,32102,20431,3577,9275,15686,43031,157741,110358,1884,40291,125391,13736,5008,64881,87336,77381,70711,43032,49155,118587,70494,4318,10168,30126,12580,10524,280104,104001,145413,2862,84140,6603,106005,13566,12780,11251,42830,571,179910,82443,13146,469,42714,32591,265217,424024,92553,54721,134100,6007,15242,114681,59030,16718,85465,200214,85982,55174,165013,23493,56964,82529,109150,32706,27568,82442,5350,14976,13165,44890,60021,21343,33978,17264,4655,22328,27819,75730,16567,55483,14510,17926,45827,150609,3704,7385,272531,161543,76904,122163,52405,2039,19165,41623,14423,228354,3369,176360,85491,7122,35789,303724,4465,13628,2233,55311,118771,20713,10006,221519,45115,71021,35650,29775,7337,10864,20665,21142,1746,15080,1624,32449,10905,105743,229797,7701,3940,22997,178467,57208,389057,39683,59403,63344,63125,54847,69691,18336,56448,3362,37202,18282,29648,138224,35867,10495,5911,28814,26653,31514,176702,26550,45621,11734,4525,40543,73944,121080,27858,155561,14887,44670,30742,8796,107455,113472,56369,75581,183777,240095,133699,153299,8768,160464,26058,49078,103971,21875,71486,44888,17156,9678,89541,123019,102337,3972,83930,21245,87852,109660,287918,183019,686,10100,39177,283941,11274,24736,26793,26214,25995,77011,141580,4070,23742,46285,46632,30700,26669,19056,35951,115575,174034,56097,35463,87425,24575,44245,38701,82317,85922,281616,100333,147697,61503,7730,84330,8530,59917,61597,17173,9092,32658,90288,193136,39023,20381,56654,31132,7779,1919,1375,117128,30819,11169,40938,23935,115201,101155,151034,4835,11231,74550,89388,59951,91704,107312,167882,115062,12732,72738,88703,464019,158267,57995,60496,737,14371,123867,4174,243339,159946,7568,16025,134556,110916,38103,191,80226,88794,29688,27230,10454,76308,57647,77409,113483,66864,14745,19808,12023,46583,84805,16015,17102,2231,20611,3547,95740,250131,34559,108894,8498,15853,159169,148920,20942,2813,93160,45188,210613,45531,52587,149062,39782,28194,57849,60965,84954,89766,84453,100927,16501,27658,165311,103841,54192,207341,19558,20084,319622,5672,205467,98462,61849,36279,13609,147177,24726,165015,209489,59591,31157,6551,117580,75060,141146,277310,21072,22023,106474,63041,137443,122965,68371,5383,42146,98961,113467,30863,23794,4843,99630,30392,82679,13699,241612,33601,93146,24319,18643,32155,95669,40440,15333,34089,67799,142144,58245,38633,114531,117400,77861,188726,5507,2568,8853,10987,107222,2663,2421,11530,13345,30075,41785,118661,104786,17459,12490,16281,71936,193555,17431,5944,71758,26485,77317,20803,367167,158,7362,93430,11735,172445,46002,11532,54482,930,62911,2235,23004,179236,4764,101859,208113,22477,55163,95579,14098,67320,162556,90709,156949,3826,57492,4025,34092,87442,104565,6718,186015,28214,14209,10039,107186,233912,58877,81637,55265,39828,6194,145813,50831,105849,4974,88319,122296,10272,197216,95714,51540,72418,23324,91555,8743,140452,250249,51666,34124,7229,38592,129641,78169,174242,22464,149964,51450,14034,10026,95376,26190,120062,14401,8700,265,31386,143573,7203,229889,61567,4227,140981,2466,72052,10787,10062,30958,6099,38471,30103,23202,208101,70847,467,58934,32271,32984,36637,24107,30771,17109,73353,13650,2098,157040,67366,66904,106018,265380,107238,18535,44025,32681,144983,62505,91295,56120,3082,77508,10322,63023,36700,81885,224127,16721,45023,239261,111272,13852,7866,149243,204199,32309,22084,42029,38316,126644,104973,14406,43454,67322,61310,15789,40285,24026,181047,6301,70927,23319,115823,27248,66693,115875,278566,63007,146844,56841,59007,87368,180001,22370,42114,80605,12022,10374,308,25079,14689,12618,63368,7936,264973,212291,136713,95999,105801,18965,32075,48700,52230,35119,96912,32992,8586,16606,101333,101812,14969,39930,759,193090,27387,42914,12937,5058,62646,64528,38624,25743,37502,3716,4435,30352,178687,26461,132611,42002,138442,35833,59582,16345,8048,60319,49349,309,47800,49739,90482,26405,34470,63786,32479,85028,39866,47846,11649,23934,29466,2816,42864,31828,7410,74885,49632,47629,111801,90749,19536,18767,105764,59606,21223,10746,76298,22220,39408,7190,79654,64856,11602,82156,272765,17079,70089,245473,51813,184407,384678,1576,122249,5064,27481,6188,25790,74361,27541,318284,45430,31488,620,93579,45723,192118,22670,51913,4162,70244,35966,26397,16199,50899,209613,121702,287507,2993,36101,132229,67345,33062,76295,118628,78705,52316,34375,107083,107454,44863,127561,33964,3073,154010,190914,55967,39074,6272,31047,5550,41123,26154,98638,47110,19998,148091,50229,31329,59900,195442,19106,61347,73497,70015,682,45850,25776,38022,148951,6288,37411,232526,109277,27286,32342,9262,5220,16651,23175,46740,129438,78614,121925,66914,88710,127952,5563,21500,34521,10739,14863,191006,62956,17359,16749,67027,56284,69134,43301,35039,58883,54466,60823,404451,75743,59856,86979,7923,34273,83785,32142,7693,268986,197428,282681,17049,22346,22990,92245,107180,3357,37104,96724,49153,7683,31197,43267,82231,164276,23696,20848,188364,22309,24821,158707,1018,22514,70922,27792,45589,59709,10765,736,35218,63479,51987,24275,63588,55361,92929,81964,4658,20122,12330,44058,13065,311456,72224,8337,211229,38979,22590,138478,52757,32595,133600,8838,31549,94412,43391,90056,1585,94802,127271,6223,31889,137038,132910,2165,57616,230152,6080,10748,36737,74579,134062,50525,180532,119270,34556,76155,82394,52595,29258,31435,87820,67996,26943,183878,38007,2410,13526,180297,69856,3503,187396,167700,7838,16701,9199,56267,3661,37407,65994,23767,5708,62508,221700,67088,86978,46776,84434,32088,5612,9149,88244,21685,95151,46750,189612,2979,506311,2594,3628,40074,105039,78243,28523,6651,38058,71999,30992,12764,68261,108991,6165,26450,61961,13400,22426,7490,60890,109623,2070,12958,50355,67979,257096,7213,42578,52121,35716,65461,7516,124758,39268,302,64712,14977,1467,219452,2840,34229,11121,21602,19270,63574,8024,1532,17331,79839,78885,52029,180767,57957,6069,91265,61380,55767,8927,32881,287603,22149,35029,68876,6428,199567,46926,13412,104132,21434,366616,45060,110046,81924,128910,45886,52821,130416,29416,77342,21762,67329,121432,79924,11724,38625,81006,102033,28338,13326,3250,82056,82526,38212,21112,12382,111495,3263,7414,86274,93490,40844,30224,45212,24019,48411,71367,24941,76729,57776,3769,38114,202019,197745,31953,237533,33270,201580,255648,100798,44741,32241,98468,106931,10085,15090,170358,33154,66787,18819,69760,25061,234005,82660,6295,131975,16874,9076,4094,25005,17740,40908,19533,220019,44330,99792,50040,19619,13950,55228,24423,31253,95308,103177,184795,28590,82285,5059,3210,75525,49894,70007,56178,10580,36051,139681,21617,98736,3555,106306,164189,37352,63915,47824,24883,145530,61904,28444,11483,19837,145446,30420,112972,85939,11835,191233,2262,20705,58630,1753,148334,1197,144714,6887,11223,107667,60879,77914,4151,57417,81594,96681,169430,1784,20444,95138,254041,27038,596,7117,72808,13759,3353,126776,21074,55322,27081,36942,39547,139830,179275,4453,713,8722,71399,19204,25785,22794,23923,104114,11291,25458,102309,88396,75288,230440,206396,104551,58447,130857,37247,94734,31548,176529,226077,65159,20104,10096,66881,94191,237909,27109,37404,1520,27421,25220,113003,23423,24884,50585,6286,231877,150800,11789,3226,90004,60642,5053,202400,61442,132531,175329,57138,30116,103847,9973,75367,16452,32360,59119,21246,10191,164804,23305,61051,37348,154530,13214,5468,50403,66754,130976,50559,80515,14436,155492,84017,5472,43107,41240,2890,90431,70188,382,76234,48040,50211,281038,237007,32115,142178,1536,22761,96429,1811,31243,1679,49143,55209,17402,235054,61494,7462,77030,34925,87609,78002,9499,9027,73289,201078,101379,63544,27666,5469,10642,30029,49816,132979,95620,58086,351930,116300,2110,2043,30845,6154,11279,16727,4122,2277,27281,4971,3650,39060,61970,65951,39674,75686,38151,11370,130809,177895,32665,63725,122267,7857,39618,118483,44792,157755,178624,136994,24260,41308,22471,12404,21707,12486,30473,52781,50246,20247,39065,909,56825,103158,128603,31542,1089,41935,32744,12428,37963,84420,33134,72921,208449,42622,168151,127335,147107,46699,38216,12591,94342,85814,31423,24944,2605,87542,67473,192551,4496,56321,91819,17630,6300,256183,114569,202090,33209,35289,34897,24967,40520,43470,5344,10199,34810,14283,10381,10017,62923,49924,23233,64539,13051,35686,19698,11570,135555,120868,44924,87065,52318,52335,47586,140906,245885,109834,78668,9065,46990,25258,72022,61243,40838,4545,146387,10537,11557,17470,36930,68104,46711,24264,79401,81043,18225,120488,24746,84338,81652,28266,13776,21878,46973,1047,230465,73357,95777,24973,210160,62210,58404,110633,169651,6937,41870,9909,26822,191062,76553,27519,96256,239070,2478,205678,67955,58532,20601,50120,19148,78501,195724,110740,8249,109665,27446,30568,57631,31425,49752,32820,65504,50079,3663,102256,219898,23849,211315,14645,4359,91767,9528,12449,49366,7941,49763,107848,8930,27086,50686,9744,10447,81935,39513,46514,1670,29229,6172,22312,137280,97759,9806,14445,22976,56458,73391,34983,93760,174219,52573,33149,59747,2429,136277,75123,165263,91040,7446,57632,48633,97140,246081,84766,151684,79918,93268,120346,54059,54875,77858,32996,103590,45276,11968,19600,25849,17159,132907,42828,16817,4913,99462,103303,27395,5737,74184,20749,21160,14377,77062,131403,158735,10999,27799,77785,9320,34366,51593,61070,33746,47048,29268,36675,30262,53297,9832,82e3,20188,122292,39917,7331,18160,68301,185935,134830,15031,4935,10004,165845,185534,46923,30109,44134,122631,18874,22903,112790,26561,18549,348902,82871,140345,255565,135390,63556,103747,145055,179600,145662,296111,61661,211987,23952,52342,126343,48450,32919,44277,82185,9591,62139,205363,376969,394874,108461,18040,120885,14798,39863,16571,16794,58271,81025,55206,14640,118656,6361,44092,85970,6262,153863,108244,180200,72264,79947,38044,10050,5735,61221,80712,5471,115689,11391,11661,184257,20010,60116,30320,19327,134598,45455,27542,18004,125092,452272,1549,91523,46567,180063,156026,2608,11174,58848,37788,65907,80194,30490,5786,40775,119519,106241,11323,156297,8425,61495,2617,29675,2425,59886,112582,49142,59618,4863,50597,86710,50650,168632,27693,85641,83643,18993,25768,84284,28090,93592,36627,312804,43381,9887,9402,100931,97165,3311,173330,66805,28935,4963,184460,3201,78102,19126,21607,37496,24938,22615,16153,32862,134792,153318,61120,6067,2812,12826,12792,23825,37559,64662,202250,102694,155488,85881,149193,46233,65383,15521,106982,11358,176786,25752,39717,34208,24510,32464,77742,39371,72028,138229,60688,71386,102834,132477,2208,11548,63670,271279,28351,30338,38620,32491,99845,143885,152266,13252,2825,178663,108097,1775,78201,14897,113573,163346,62292,171129,22183,96598,38733,64971,166776,117445,9968,146393,44677,74867,20908,97328,12761,25656,26785,9148,112344,26115,99176,110121,22437,49547,6180,79320,5835,31392,43328,33377,75870,119860,69497,80273,7325,155219,43167,111173,28347,20222,3763,71752,55041,47252,14618,28088,15012,97805,194698,54636,2036,41349,6173,96604,61530,51859,43782,13361,24334,22668,24792,7070,23441,16789,3209,36211,208475,26242,32880,122181,182407,21444,31060,88459,29929,77907,12716,10934,97005,20599,31690,8403,58445,30303,22700,10336,86731,103115,337709,72556,46788,112566,47684,67089,53548,36874,56487,41387,125985,26893,40071,106683,73712,18787,40105,72992,67246,137276,50802,36790,70328,138827,22466,39263,183295,29858,50975,9322,57397,10654,24364,30383,55799,41600,23584,127295,296610,129078,143558,244131,86397,36049,1085,80677,3820,108139,5476,34767,24683,7758,13060,7239,131671,250593,59556,103392,29810,4188,252323,39404,116877,7651,43600,40338,13554,157253,39196,25978,144387,61211,234,50104,6129,10449,93777,9240,356378,274148,4439,72970,3724,147770,78680,62570,115877,40027,40547,36817,224392,64609,34795,165027,67440,2477,37206,23431,50754,164797,46018,94995,170982,27051,7957,22767,3674,27900,56419,18930,60701,41302,2692,84749,339721,61996,111094,80221,50129,1045,8153,62945,19202,8250,37208,37418,32560,79477,41106,88569,33963,36693,5892,30570,1581,66471,49647,11922,160717,29442,5643,114865,82962,95982,132098,22633,22838,94726,54556,28566,205039,162340,33216,16849,35847,221339,94851,26533,71469,1805,3804,12935,45483,71020,36310,65381,192960,34240,35165,59773,1248,46954,155332,96864,4246,388800,16129,57133,74592,44807,442014,38203,42574,80818,91592,26377,36424,65760,977,77387,22628,147610,28018,30561,98454,6969,119628,63648,18170,36854,26601,64018,22027,37279,51395,152934,21153,9430,58760,194742,5330,55115,34158,28917,174111,13171,122326,1526,43896,66094,25325,4234,148354,11450,275,18999,112191,44365,22723,68409,8733,57746,96565,75007,14196,108844,29475,88599,177563,100792,106156,86323,93726,14248,135341,194131,40126,47099,14779,8272,39597,95983,171398,65882,28052,10393,47213,40689,22120,72212,106829,34964,109146,753,648,21660,30047,17527,181025,5619,145357,4085,216883,9359,186951,24779,53931,24545,36197,223296,62628,168101,4243,107313,30321,26642,13049,51059,31027,107912,807,73550,26551,84369,122422,165872,49754,74213,234264,33151,52014,33100,87183,22365,52500,40013,23302,5652,72723,21404,26107,48434,587,94049,168493,96418,32871,70860,31709,25128,443,71597,166253,15670,70994,26341,133675,28280,75491,54756,47955,56028,26182,11952,113272,472197,64640,110753,17919,337,50642,22576,142,87371,53391,93210,126694,15285,19642,85667,14148,1506,42092,52962,33243,11970,20734,135843,57044,58880,13002,219134,22876,64754,232519,4257,43120,321573,24799,64526,124728,52579,81472,70831,276848,17403,74359,23021,182101,74597,23744,148267,12055,7976,5349,11772,67540,167347,65318,18720,127832,108238,22828,90233,9987,259080,118185,73209,79270,13775,90100,137742,90799,70569,15699,19961,9087,67475,57872,39731,8810,134897,131868,146849,19898,3334,2281,167061,91073,60356,467742,74712,188,53179,137679,92769,29241,9537,132595,80119,1041,88962,5976,40171,44911,102859,139059,104558,98987,47761,19272,71472,113864,175377,73338,10857,23402,23758,1591,139864,5644,4076,118760,16427,134198,18853,20291,100849,37423,22038,36677,19071,195521,57445,11069,31869,55718,66882,148490,44,41296,75242,49704,166810,9906,20943,122258,49112,105667,15969,10344,6408,187694,21399,72742,58970,14867,14376,81889,41856,23225,15042,56993,16074,131389,74276,72407,53875,383108,53597,37363,68993,44854,122548,430927,198279,38430,80409,12245,2981,628,2818,17760,37437,238229,7968,46892,2200,3730,34190,65983,37959,112291,87850,70827,6522,20750,73913,111621,41652,19587,2780,58668,25916,85259,18200,168962,95781,42445,102050,7776,57662,103313,47742,96358,41964,66174,100396,29069,204735,19679,27978,7479,40264,22534,61183,36081,107436,58223,14680,23002,101311,24716,124108,12908,5646,31750,40380,14215,232799,102772,14122,96775,61398,50917,12096,149880,67833,598749,124194,155871,49216,790,14677,65319,56917,7440,145744,95701,12206,49405,129269,76199,45732,9767,11058,9047,210885,11051,7392,26307,2130,8132,147526,20802,232698,115660,50060,59789,57344,107623,80343,112676,23291,9866,160971,34032,118291,15719,59730,164911,28975,2659,58046,78480,21854,66209,53863,109085,116045,29021,46481,107552,22130,18764,70254,31272,11300,52460,43933,84738,20721,53869,190840,79673,105300,7561,321817,66924,13940,33281,101046,183181,32176,71878,5678,62924,79535,56646,40303,19559,27703,93042,73368,42187,3670,37376,46440,7023,36816,109628,20680,5940,276440,275233,170848,112093,136996,14984,20226,111441,77693,112960,48577,39370,55707,50314,123404,26570,54281,61372,123391,4857,35928,246740,132507,106646,44241,7196,92258,9825,37688,51197,303141,5590,15476,132986,10955,85782,34486,26696,7991,28813,18858,39546,11703,11365,38185,5716,93555,11925,40121,60002,6985,10976,171384,3887,43394,13337,56346,6381,252336,39573,75042,53711,1028,31781,44295,95925,131713,7214,68125,43571,70954,213234,1628,8760,13391,65485,17320,56038,1710,25248,60803,57399,19839,3870,326,281556,50945,72400,21460,316244,75619,56246,98775,481,13513,55765,50427,7388,123519,32929,57908,27124,61316,101097,57467,30228,48792,10788,20402,37318,50526,155730,34456,158065,145305,17832,43733,64052,4506,35072,205355,177028,184004,187081,68616,35938,83703,10367,36892,93186,260137,51934,89970,4985,23445,26755,21558,7948,78741,23376,124405,85594,68596,57536,49351,12619,56593,132668,99924,109728,71844,71935,196018,65464,17617,14987,89701,143773,33997,8687,22701,33258,2914,4436,72108,85610,9671,49067,2327,82988,1361,1672,44033,35777,30269,24057,10605,82236,616,15793,13919,47249,112086,116698,9484,80207,90574,33304,68624,93127,56101,42210,160929,4827,38995,38095,4701,125119,5027,33680,9236,231236,14135,87837,23318,70261,78893,30151,81482,14332,1084,74256,27532,46644,79185,3148,62615,6981,55672,31668,36825,1849,14536,37446,14738,23779,43058,162749,72199,1168,21346,5592,85932,85302,9668,18351,57135,150360,2080,228015,77953,34670,119302,151751,31009,106725,84265,45214,59289,74178,113071,263206,111009,4021,44449,188119,192629,123592,392506,292847,114487,12831,205858,9852,20780,79648,75767,357014,97721,18166,21005,67950,33226,204009,16536,2987,11335,66717,144910,47950,17262,55060,15063,2934,51038,26775,178497,66008,3427,49433,128592,20036,157553,63861,3089,23015,51210,28696,35933,49942,71135,231518,99620,17248,21835,176536,20676,16944,38700,165831,233253,295625,36723,13023,52745,10907,19423,67972,125868,95473,82875,1183,108455,52685,33417,64095,21433,52438,33191,127809,44505,211823,7810,2752,95548,162031,7185,91196,47563,61721,33359,17897,23682,42806,178101,22874,49707,199897,75419,82456,8618,11171,79712,116847,18783,44190,46564,5346,59046,95032,7893,14916,3214,26800,24172,121453,34362,10250,17408,18888,4840,68696,22831,13162,36005,32512,14800,62357,41723,45046,27247,37486,5372,2564,34261,298500,66509,133920,89138,31305,117697,19097,108304,81386,84106,23802,46411,63304,946,51417,41777,41041,19501,115864,60743,294354,37955,94165,18116,1156,17937,20645,57114,90804,58042,48643,92288,9861,2557,88546,61333,101008,12853,5148,87856,4152,144503,73841,18718,9789,147565,10846,42085,12789,30223,8993,56352,67203,2448,28215,6052,23540,126319,75933,36689,80235,23231,23561,21383,38800,77548,102798,21234,31468,158608,46188,63960,191679,8051,67014,11185,170078,42186,28827,34777,41930,212079,12421,34750,24111,110344,73918,45171,70826,141949,40063,23979,24254,37309,26724,27179,24718,83648,54938,14591,17425,29525,102675,48975,48654,12316,8929,60640,41709,50168,63264,89812,50716,48632,38755,138583,160123,55579,71829,24230,233277,46322,39650,166388,34718,24108,98252,7031,106695,62498,18258,35062,217827,78731,34824,33354,19520,60852,2432,60224,8587,2836,62955,702,20227,42285,40560,95592,62486,11094,53035,143291,18842,46177,77994,1770,9657,107422,172915,32655,128716,25886,25164,156740,119928,165875,85817,11007,89110,33956,12652,65156,180266,8494,36889,19958,20955,96,1264,118288,135769,44754,86671,5632,19026,168220,289120,33569,93821,66144,70635,7687,5642,2714,55445,56636,71545,184182,93133,7332,37389,12643,52315,22729,11014,158742,17050,152889,50178,34601,41945,52136,9948,26914,63548,95721,115951,40759,8960,158258,38938,49232,48325,42234,81523,253019,66128,40978,20048,238048,38760,62928,122560,118532,43687,137472,163689,26680,9878,17448,51035,16211,60834,36749,29178,14241,59868,150086,2305,26477,42422,34342,165341,83279,33894,14257,29928,12743,13957,125571,89134,66712,10952,16507,147839,30146,7249,16565,45399,39874,114565,215780,31990,230881,171477,102,196546,44538,10880,84948,281705,86651,10617,31395,2342,453658,43569,60561,132901,21845,17727,58556,258242,22262,58728,4008,77997,11806,37431,30599,81375,109137,185787,114085,217292,97453,169085,30593,60212,11544,102056,65580,2384,91655,4855,95725,7295,157994,16228,20669,53276,141590,105246,17334,25440,76067,17967,39321,38911,11362,28559,63807,21627,26468,85816,40120,1025,15234,58319,69516,66512,124548,75845,78873,22137,46681,51242,85683,32909,76747,35555,43396,101465,1765,73094,1077,2962,39028,66777,57831,42048,15828,13962,36041,63657,52412,5242,58846,2141,5506,219012,134451,3936,182230,17558,17153,152237,22621,49377,170216,35257,68233,65374,6510,11126,212151,7184,2480,22517,3437,33073,30156,16557,3768,55067,86829,91e3,12350,148650,66017,79424,70885,49066,28250,21369,51213,34533,11510,3258,18176,18465,84413,6315,36411,163765,4346,356,107618,598,13727,285026,162695,8749,14583,7132,63521,184253,32378,25991,5604,30961,53675,4874,84693,5086,34811,26978,56564,7904,33519,51221,113942,69253,6664,125563,22055,220680,102008,742,51930,19494,176108,44424,35123,13025,75685,11759,74335,22250,181453,131147,16984,132115,154311,11991,76452,52609,85351,196,30969,9198,74919,2529,56838,71779,29187,116304,3504,62330,41190,86153,28393,254926,104228,105189,13264,84359,3574,12415,8534,57147,10175,188174,59504,60932,66318,16407,107921,17638,99103,49278,28403,39786,145865,8462,3558,43406,142271,29139,21989,36552,93955,72365,7176,13556,106185,37957,321774,17782,129017,51154,27938,24952,1935,39366,2791,33489,41582,56078,24558,9311,5449,218786,27808,190429,68013,36020,86003,29735,3404,87348,119357,115714,2324,86796,81973,40992,43376,93621,28784,16808,36367,2517,2909,191926,24978,55303,53308,205724,60068,3098,21375,64784,23949,26579,63121,12319,80145,39967,97861,6757,70143,67642,37082,34698,69140,122883,46151,62187,80934,429,19437,135071,137885,222647,13331,154065,327,61778,74257,40116,37493,14855,85079,237641,42342,102164,199965,71204,4662,29368,5042,113914,122214,8955,13149,102503,43173,5659,163787,69003,307084,63392,171080,21390,81918,86666,36622,24126,28887,5736,28054,207170,163428,79891,346467,95363,38980,111806,80828,9200,19288,294896,114468,87405,111715,141705,7015,72754,68463,48738,243147,33397,101210,37051,98801,82847,20397,4940,185559,18716,54718,83491,11725,40803,1128,12128,23060,5174,7745,67007,46701,1571,27807,180186,256996,18975,16837,7877,212758,250379,15440,87954,57755,24719,124057,83461,258,50864,8874,29038,71289,31627,15429,9005,4061,113851,107716,82819,13651,79656,117851,17539,111446,12938,39724,190787,4352,15402,21070,62708,8539,23777,73853,13552,38810,86117,16285,56400,1718,75342,142863,29033,378,110113,180321,32586,23606,26393,160984,207987,23783,8406,16904,24596,47274,11693,46539,60524,78595,48423,31718,20170,9009,146268,15183,191060,172765,1349,138436,37365,10970,40509,225817,20021,70394,152138,21541,66559,66544,89352,2725,17258,91345,7313,3815,115868,8660,40362,4071,103524,39388,118275,21950,6549,38226,32754,209574,29201,43495,18028,20296,40597,18370,47520,202450,24134,2219,8195,69545,38041,136934,46374,19041,159811,84865,58620,846,98749,13569,30714,97246,32186,4479,27355,92973,35214,151491,75963,37631,1561,27200,238083,23182,60756,12291,25766,39355,102333,87362,65741,59906,19538,201575,48772,102938,24438,292580,39964,66366,9004,61379,50548,37622,38732,28379,68180,76622,17488,69849,5963,7219,48143,43413,55358,540,58691,29506,19245,52193,48621,5518,13048,118625,44755,191081,42061,89197,2259,60665,66994,71210,51232,3585,142096,55024,7892,8345,58653,463307,65658,64319,137941,136323,53499,12746,43492,6978,95163,29925,60175,5128,7352,41463,184756,121146,20473,18426,4598,5309,54580,14277,121151,10691,56711,43880,63409,76682,11830,172218,264898,32632,66536,81062,31649,25788,92774,60222,11100,63159,9432,224657,25240,53613,152,138620,163829,2397,85345,12501,37507,64932,38575,43522,65789,80198,78796,35226,3851,108891,73311,3060,28391,93671,39663,46142,30982,66041,37281,68157,26553,71872,81142,211527,39747,118119,22695,2859,11066,20232,168911,7933,197005,17066,111071,44434,133994,120798,12766,227798,45756,132852,29917,36076,55352,65281,129800,41958,18944,84678,18580,168093,132621,39997,54092,27740,32354,3770,114118,103242,43918,15899,18574,145944,3190,123469,219903,24169,100571,62403,16776,92779,14535,17168,16475,14304,37231,1712,28218,242754,61688,28980,1318,51359,222657,99200,67989,31772,23932,35351,201251,49041,27306,19128,40135,3986,77333,19649,120683,151927,21081,7076,78375,77501,101599,8011,89585,96715,58179,5378,102138,106793,26051,217276,4197,16297,27014,46721,13322,22806,5278,29629,70632,9647,71519,58818,40603,128530,8903,36770,56900,31483,26935,43845,34265,34920,87658,6114,84767,64250,47318,50720,19264,162514,33357,13117,6705,46696,75032,71054,87004,42035,69138,11903,99854,102328,19611,34525,69312,6431,49842,101600,133178,108751,41829,89939,225664,48916,99556,9195,130387,5960,36857,116724,53518,94002,39077,53996,6945,22261,64291,8314,152785,57588,16522,9091,5048,87671,35441,39509,1945,12423,158923,178413,37549,14095,1475,73188,62878,4819,24012,68534,42606,4010,120809,57497,59564,101758,103718,32701,80116,12345,95834,46918,21468,53213,15665,31200,3867,5140,96013,250744,21016,10069,13968,35449,180829,27683,39704,59956,22893,3115,26293,32785,75934,62445,141162,62720,2018,83638,19949,114012,95006,3330,99829,130935,309272,9565,55874,121727,37017,23586,319858,40970,27602,8625,112329,61060,100088,118525,25922,16232,1907,60671,51583,44553,80993,5262,94679,8676,940,20736,11823,3020,16476,12340,152600,97416,3703,25744,66826,16245,16876,46446,84798,74227,176020,45192,61955,75496,23946,23626,40372,26036,6149,11822,30582,16541,41914,82385,232823,40921,80773,14930,3631,7517,39619,4348,36180,126106,138939,62611,1477,113512,47321,25052,14546,118881,29060,23589,128322,36795,18401,137921,104699,267929,36194,172791,18113,4766,188215,30083,332586,94089,5805,77909,22194,68234,154976,43220,40660,70001,184893,138095,11128,103010,22663,5108,212615,8485,5565,49222,54614,26530,42639,16319,55062,152662,105595,21114,22216,10294,68158,10436,86950,7206,62115,3977,3657,59874,456,118617,18156,106663,112229,80992,17442,8217,55551,5133,34344,251927,51153,39364,201321,7816,66803,23057,156724,145664,14276,95705,979,2796,6875,13429,212525,50602,26276,28284,3424,19465,52397,46963,31420,51399,206476,92317,48851,637,100820,83349,10317,60227,21972,6908,282439,32857,224767,95629,83882,42106,87338,69757,29840,68709,37665,45244,114577,49188,175943,54009,186746,106158,70168,3358,234002,50555,9221,129338,9562,20118,32923,78479,118280,65752,4977,10474,102174,60947,129006,10570,83451,8598,8078,159367,123785,80438,16742,5905,5281,181513,42402,6977,163136,93179,42191,14968,50421,112401,105440,33456,57347,121611,4221,94954,36517,24046,27796,6255,33394,72990,135408,116627,1233,57874,25654,95419,68156,401399,313338,55208,45573,93124,119251,47200,38196,11909,130667,45391,73904,64964,167846,4137,115606,52036,62214,7969,160925,7187,1132,134835,40309,73195,64494,80472,444841,61111,26500,45323,40743,53625,52797,22659,15631,29739,36706,28841,39147,102836,26794,10536,14845,87305,45874,12241,127587,83833,57183,79722,30844,41304,84655,20825,92500,3722,25655,27811,10157,81634,31362,34088,92487,70123,22190,185100,72658,139035,192523,88241,2078,230490,44528,85638,100198,22088,29982,291233,241062,13865,4445,137791,37835,107218,31726,19718,38234,72528,23046,19177,66695,5109,17251,28077,5617,21554,47839,72425,133825,1486,73065,181275,141508,21768,62971,63082,2512,34200,9904,120309,6392,91243,68416,268253,41199,116757,138551,185526,41246,28986,4093,19057,17295,4148,245766,122360,35356,112075,20301,75441,10998,7977,19769,62922,937,63547,100196,26427,157820,20983,236696,22935,8140,90315,156004,47204,140973,7726,45097,52725,22636,23436,257282,105247,522,88389,216031,202204,46812,211666,19693,68828,81691,45925,11256,30292,372,5236,167826,88328,232776,151611,5360,82104,18841,80393,25465,18285,20320,72377,31730,33160,45803,38715,27705,37379,24163,18360,103586,4015,32305,269494,91252,20080,36567,54650,7797,57073,12650,31164,42209,6375,261663,105528,81661,106002,2800,5375,17247,43151,4442,15727,194619,100855,144898,62320,78465,39929,16454,1967,28311,61363,17219,9395,8745,121445,76939,80385,162380,22009,54191,44248,16299,122830,48151,74429,78291,64755,14238,44966,2511,17712,67954,93583,829,105899,49935,84750,11591,33185,85447,42717,27409,208542,28965,62052,52525,5597,25694,65594,16343,63224,276188,12475,9331,127507,38522,57287,24128,133161,79723,105548,133695,48917,27558,43278,46520,13778,141954,110785,83366,17715,46317,105763,66298,147013,41086,94180,16478,220447,44611,730,19722,78975,117889,125643,26254,16574,18480,65006,15806,38549,246418,46052,36056,8440,34984,30170,3163,59800,4458,115442,4283,41970,33507,104078,1653,22,121158,276486,3655,6338,24048,133421,23641,2161,24422,36006,8086,10675,181474,12307,29514,59143,14729,52509,87128,122470,19446,80852,33314,24573,119864,14237,9652,57779,6612,51851,15284,98871,90581,124466,156831,21190,22015,71380,161906,87247,69201,18392,17908,108470,72962,40719,14338,17911,95260,43339,20610,78916,20710,72451,11315,31448,17263,58853,178878,48111,116002,45497,80506,82605,85880,36300,121755,25215,36118,301929,88728,405223,276136,553,34704,212438,49970,78329,922,20711,25036,257130,38295,145369,18128,15385,30829,55656,48345,8012,3561,28004,122041,192900,58338,112508,41085,29976,87040,47117,23905,4336,92061,138880,97407,42083,172121,6256,25192,172671,5,93568,1420,12677,31605,56743,40620,6015,78415,231077,31298,80026,13902,19048,24924,170586,32955,176119,87859,36731,6773,27711,24658,26475,115216,133207,93250,95820,88522,8317,5714,124047,55219,86860,19677,23961,22928,162209,8904,225992,359835,56084,96201,29392,96558,86071,93643,55114,13347,8183,95129,82012,2017,123336,34219,115554,157159,47747,101684,41008,18735,193781,104151,226906,7552,179874,124113,31159,21162,44010,14771,51268,166128,31382,73124,77438,92830,205709,12113,1292,38937,13114,1334,2118,15597,69581,14449,21934,76618,48728,67038,14967,51495,24243,87736,147249,26720,11119,46063,43749,5843,44147,152629,133428,65703,14269,45604,57982,28672,55616,45957,8438,95433,37698,220862,132034,39456,61870,4161,26501,73560,56418,9845,4654,20916,10456,88920,119358,9015,65931,96507,48029,38534,21676,109081,43078,34943,25089,6131,28766,23665,5477,10255,16695,67,45778,42443,42770,29534,23733,100513,62617,42630,48746,14191,43753,50295,26007,8792,57243,43119,54725,164253,58250,112304,131796,25165,4651,3188,24831,47748,3705,19540,13211,102095,5593,18699,23666,32005,117571,33541,60584,74573,86311,99443,25172,27222,168938,7143,11853,53560,18834,19960,86522,28217,53266,117700,72989,34323,18721,66450,34346,74056,47217,202002,46269,9429,68582,75458,37823,82843,96652,32549,145144,27958,19820,158086,31955,201406,135379,31207,192545,12950,51704,9094,248263,76147,64028,110009,79407,89345,99284,223492,47966,26848,15359,201137,2861,110507,71231,72297,31851,118777,71039,151051,240855,16333,50766,14727,7939,4149,80908,418780,88378,59276,1327,7284,38576,79814,65820,42199,84860,49574,62596,12396,70598,40117,8648,7994,16836,7630,14047,359699,106878,525,29037,28064,13380,11675,50669,74216,103539,180314,27449,56299,172344,19274,7301,246099,32043,19422,36506,129317,6806,30140,4614,46639,66926,932,86600,6322,27847,233103,10541,39025,34887,3517,12972,26220,2031,66561,115015,48658,47596,12714,33845,3893,16165,35237,89983,14769,11962,147224,47018,29977,27979,5552,82338,86023,131368,1218,24853,237840,132193,15455,40873,3668,65351,53388,15229,59889,272245,47934,11858,34347,18038,90853,86981,300602,19343,114181,29362,84921,6095,106059,79472,38015,1206,48741,6208,8e4,21916,17423,6002,108083,24479,34931,56661,9511,26995,100694,163853,35997,81254,58321,18919,171890,86877,91341,74503,70477,53412,7027,59281,39892,131302,5864,15947,61301,67466,162369,47956,27874,35624,282324,21270,111847,102548,41482,30955,116737,28264,8592,55458,22301,75090,29821,30697,51709,3041,19208,8038,24634,30467,87509,126428,19389,18814,152686,20701,83474,45832,80891,105808,11378,153223,120770,98186,150633,49838,9141,12755,30962,5260,74490,21256,31678,65062,33326,289838,187831,20595,89768,2805,58535,10844,70085,12090,2451,138068,98544,24461,4511,6754,41684,28203,3383,65355,82833,30161,83924,234361,128424,28921,222594,33975,125491,34069,11508,67464,144226,41850,98703,34371,7901,21254,38398,65651,23549,53883,213340,123269,12028,71764,177701,28758,2623,68395,11549,15232,68603,9660,63116,36079,57093,31198,20475,48467,89984,35619,186847,107469,31389,43631,73867,41949,68841,114250,1605,30564,63403,17588,27680,99533,12641,70325,50428,73426,78379,11855,91651,72081,91720,60198,15743,12065,83398,140046,6761,46598,45900,5068,886,62448,148968,37347,19405,9680,15819,43496,63370,75667,163700,37639,3633,22774,34341,183131,134335,37200,23915,7054,14194,12970,26438,13350,285521,25594,8219,104410,91039,168804,138480,149734,15907,33818,61132,60082,4622,110187,56736,13551,73571,3945,73463,65498,17758,263266,17593,2710,27585,54469,38200,45367,63754,28881,3473,12791,98287,31895,65787,4463,94536,24951,36332,59901,28803,52130,86403,7668,181822,74831,18977,9850,177206,145485,109798,7292,31421,26280,77211,58511,12507,127004,11113,147,8729,56208,43066,79926,129937,31345,83947,39915,46146,98763,42566,1337,13192,18323,105163,80570,117753,16555,72883,11077,159438,40764,70933,83329,26066,12276,72059,21655,173836,126713,69454,153482,91585,70644,102558,110483,6764,127864,190133,3961,101798,20945,71138,82402,90884,69669,44753,923,16939,59700,164258,25969,27082,31399,43846,6306,246093,51342,6153,151581,202801,182731,56475,162188,89426,141356,14355,121815,27536,28023,65257,77523,106668,127314,24947,12790,38796,169698,23555,10725,44573,183083,42088,62716,43265,105958,32050,44067,50118,1668,3874,6243,318411,16599,1691,94999,52378,28671,216728,123258,2059,34969,69225,5913,136280,171443,141515,91662,22175,135282,80020,92270,1663,4808,4482,3495,34691,5226,109830,108512,17342,107488,11606,123190,100247,29666,146527,113014,15794,30894,13224,39585,243192,22351,9903,7836,47699,11078,25468,122291,48821,26780,122679,75521,81450,630,4895,92900,55074,74293,17441,3563,111657,103102,51613,12318,52370,36191,68245,34269,40445,41354,122901,168604,182500,62012,42557,11259,24428,115113,86345,12362,3909,78430,86852,134602,20459,47853,93879,22577,7659,3688,38555,13349,17381,56715,91639,12493,10895,92438,3142,37057,28928,2004,36427,32268,34222,209974,10432,67436,41989,173518,107930,27079,62729,30908,55558,5828,45031,14902,53546,8204,144263,60255,14520,88212,86582,109589,69356,8064,47449,8505,66558,16886,4844,52817,111260,215129,12941,91118,650,20770,6273,73089,40618,62790,2873,35002,14023,97208,19386,102646,36993,143736,135457,35385,113601,17893,32627,84439,100619,56016,6581,57264,172160,45452,111710,203627,70131,24100,322787,1996,35665,70078,22358,90922,83658,4097,63200,58499,14542,99153,52159,6615,12414,63415,31986,16823,1579,65405,137809,8841,16898,48082,259,33014,42375,12260,179850,73667,91389,98882,29532,17311,326251,41092,5928,20742,44964,48019,43505,9317,49265,6643,192712,48424,163487,19861,20113,70848,31928,105333,23685,78563,14638,54755,7158,24142,44018,20774,125255,20331,24280,10163,1285,2336,39851,4299,117269,46714,63816,87779,159624,11731,9971,990,137317,108831,50994,74554,162680,23640,131597,146962,170620,34829,91205,21184,1913,63616,18427,93136,156592,17519,67565,115882,138220,78622,88535,18115,2711,33554,109492,54298,971,24914,25863,36363,45715,27099,194995,14299,178181,111488,72395,322385,157719,130787,11897,81843,83999,11369,49280,118604,40922,61332,110343,53407,75639,40582,300440,54722,25637,13694,48248,48278,194521,56203,52779,48783,72627,10953,376,16733,280238,26351,230789,15132,25168,137270,3588,63704,73376,94031,74284,19443,159557,9697,39901,13351,119050,15406,146455,3460,29556,75195,37673,102524,92329,47289,98413,15311,100684,56345,7116,95480,11590,7200,167,23610,58426,17730,136656,27944,53151,2701,8824,103124,3017,90744,113588,53216,79736,65940,26931,498,29568,80540,143543,21292,1740,59268,16561,180816,42323,50174,40890,52866,10703,57169,4700,17191,4424,93511,49698,166650,26972,48631,165169,82879,69326,202970,4007,2376,231325,139592,22119,62851,37504,68816,58345,67398,186643,43331,277416,53749,15746,23102,17432,4793,151138,48822,54265,48203,198688,14305,54287,2291,18018,113378,123260,7180,97549,87027,120085,2920,76080,8190,102005,5641,64580,14955,59802,54028,58884,19367,81779,412567,85957,97053,103637,78871,29364,27637,141728,4767,30686,112738,130146,42745,12730,105040,14844,232,210944,36581,152317,135543,29744,3129,55647,58149,46319,27265,17499,28005,59948,7170,34138,5702,293047,110892,408,91760,218674,18469,46095,81403,14389,4610,35672,73060,11006,74848,104820,118143,190357,20043,105358,141735,5115,27093,45924,123073,52599,29433,9616,238350,78610,24851,58858,26769,31969,24613,18294,4982,32735,39639,143563,112073,202205,12567,4873,88601,44897,81503,101648,81362,34662,85277,17574,48173,21435,221188,40215,39576,80786,26544,64668,81841,10731,37733,247986,149188,127703,495,18382,54388,72446,43071,30974,198723,89608,41360,190,33045,8386,31658,19992,237838,119015,137622,50890,100913,6460,116233,267230,26621,104129,65114,14190,41542,14888,85962,23342,23041,26453,43725,71809,45186,4770,46452,53894,56616,221286,18973,9038,109299,55365,19366,26863,18808,60909,69353,41738,83463,12100,68561,72860,3980,13796,49340,12332,31311,27418,4255,53430,18976,45523,510,14224,30477,26581,4530,3651,101663,139840,22709,150861,31996,63923,120623,262522,3076,10528,2929,14672,130238,18087,9816,121894,100308,25085,55111,14565,18952,53293,2042,369988,23674,61789,133529,28783,108293,35477,47119,36448,71049,40015,33055,78598,198442,1833,159937,40654,77444,189245,113153,8621,18599,38553,35223,166072,2375,11659,21786,89523,6032,12116,63046,159398,18454,3678,32521,47626,11411,103527,38896,42946,15696,26370,10185,8413,37080,165583,4331,63555,14907,72220,50056,6623,62236,36565,49783,10049,17503,100581,55951,146244,24724,9626,17969,25524,109300,173965,99994,101056,46459,43647,53737,277968,8347,123521,74858,33829,44762,77574,877,81377,222525,123532,30602,43881,53145,2973,16284,81940,61281,127044,63620,9875,14756,114829,19032,9202,52759,119141,23928,120551,19607,3599,33401,76821,73233,117430,39968,36539,7071,5446,121735,194059,15206,45283,6706,15603,65615,1207,165723,92275,34773,104447,8396,32353,205240,164323,13600,60555,79205,25532,22907,33410,57480,107111,69630,32137,47832,70913,33161,20321,2371,117348,10714,86246,1625,11763,17900,268,78457,99175,97940,101092,86660,32221,14041,128504,125080,53744,124263,31017,13897,403,31859,21964,5633,111630,5547,77329,17961,18241,84995,25984,12983,67491,62168,47262,5241,297,51191,7351,8967,147212,82060,16821,782,11033,82431,62957,5026,43459,77963,203477,53528,6247,191852,87774,74164,215654,13467,1522,219964,28589,244104,16242,117821,67725,72570,156792,17186,15979,26990,44128,193014,35276,57125,16212,166451,68017,6905,77608,16364,53777,75921,76426,37975,26203,269296,64099,84122,12077,38533,830,4407,20139,963,43028,38902,42911,37503,83343,85045,16979,1165,60835,137387,58380,86990,110066,134540,56331,193845,81238,17922,163093,38744,110641,12502,56404,34862,26865,125964,12965,111648,25547,7771,27196,136980,9555,29551,107158,57885,18831,37705,35505,101742,13970,102109,62548,124657,23328,11124,89592,146376,248050,6241,22033,18337,80685,29898,11908,216623,67721,106162,146610,21377,15085,91552,42041,62560,122532,125336,102365,121537,142559,29693,223919,11515,110495,18776,22494,5895,185059,103592,229351,51220,100102,37027,257855,29359,54123,36066,106493,12244,79258,32002,432,56205,94836,90182,6726,14762,29391,48938,26864,38083,60364,3310,60192,14766,205567,57504,110760,22649,24666,46333,21517,3430,13135,28873,27052,158809,11597,20529,6695,23138,22960,37137,45574,6545,305877,43423,26153,24769,59844,14501,10430,134352,56169,13213,103432,49523,35181,13435,12408,129475,64620,230854,77390,51990,15653,83248,33466,44571,117828,51481,2187,10559,68019,18021,54895,48247,18354,33737,4554,108595,37288,39767,116707,9175,3726,108877,21616,83684,49862,1938,8543,276466,20134,108498,48770,102254,31914,131520,185291,100559,51890,209,19526,76471,50544,71814,99351,8172,198526,28816,20419,9109,98389,136777,76479,75596,30635,165417,48216,120220,25955,211071,39314,24308,32164,2559,146280,43403,9233,17947,90585,1786,86920,125662,2457,64741,32152,32918,122882,78538,44001,31723,56426,23375,103172,88177,145697,52506,49319,68016,31664,41488,18486,110400,7030,28241,986,109199,19900,42147,56864,65287,49183,7858,24e3,30453,840,16673,25907,68916,89927,6309,158335,36407,199737,130464,13137,59603,201778,195292,21015,42466,179062,172561,89492,11075,180407,31868,72493,20998,60217,9865,19530,39274,130266,54539,21623,12535,13505,40641,73375,4087,85633,2153,3117,70680,55788,92096,47509,98493,37490,271936,151475,3032,16171,96642,34106,78425,125761,19591,3366,19316,54508,24183,50786,194248,91528,33253,34622,108355,41741,705,3814,3883,108929,13203,67831,10142,59754,68208,29128,84820,56880,38794,24972,48571,40821,40476,18137,164254,24064,236309,79181,11282,395,39169,2013,51587,28551,9645,701,109513,115899,113566,12762,62045,58322,103726,41343,40866,244102,143816,2490,70346,40973,52618,15412,30720,104315,38917,42027,93676,17513,107418,20706,123890,13399,97727,24044,87962,65606,44250,98044,65276,74790,101473,19350,91570,1326,87790,172042,7577,100813,86896,85891,41512,108130,27794,14875,71431,12835,156250,58135,3759,22476,42176,115873,34686,56523,73643,108505,51491,20838,12721,32863,45700,29496,13700,34294,55360,29206,155942,123812,7706,163234,203,132720,49358,144431,8130,175788,35818,3270,76832,25710,54095,97274,28779,94621,74396,19092,128242,58067,20885,14670,93255,15107,63291,23654,126900,129421,59294,262659,9798,3251,67344,28600,44629,50672,29072,26999,31526,23183,49175,165843,175455,17282,175411,32022,45989,30298,90690,78118,83156,23749,35636,31317,7069,80381,94561,133756,14960,97404,6138,41065,78041,32843,16601,34123,9559,146529,123377,96395,54441,42012,84257,123541,10745,22139,106459,11720,150883,172651,154996,110538,4728,53447,25704,2009,71152,119354,21166,66604,1429,216162,8637,122250,63520,27180,29172,36124,276428,107787,77184,4680,14952,104903,24418,14793,51561,52931,8371,26342,48526,7118,92066,67280,40653,8847,34597,105438,14198,50163,61188,146286,50315,41205,170829,161496,585,197359,95056,1687,365794,91349,48507,5804,49263,5146,104902,96365,117343,132222,46084,96919,16875,8073,262381,79982,52663,13928,16056,153908,15145,109256,132308,18763,24904,167644,13618,40750,18686,147124,114709,150038,52849,2938,12568,48617,8778,5459,44202,44591,74914,17183,248689,13878,7822,80060,23116,194037,18487,2067,7798,43077,33678,244028,31320,74273,2794,19466,8218,36280,183997,48124,19416,29656,19280,98734,7715,18311,30701,133602,150307,126956,7378,2933,79903,13178,12593,86571,26604,92446,13574,44205,65699,427599,21118,8245,14407,27877,47936,33542,7916,26460,117762,21596,37818,2249,127359,209394,60044,47677,308089,36791,154971,31417,6998,150042,174360,12255,43009,29335,48739,3912,101398,53340,2580,146939,151295,45360,125275,15273,45383,27456,48761,23314,8750,60801,85823,104759,27894,123685,66968,39480,26917,55290,83305,2696,98390,57569,145853,340733,4919,20024,52268,30884,7413,203685,70989,112855,4129,50536,349518,68205,332641,159581,135361,236026,37563,176404,64899,6578,122033,63871,1850,85234,82089,66124,74145,121098,107351,12687,36881,117334,13136,14698,85933,93866,18047,32620,310,15094,46e3,88451,23632,36645,27940,87618,80520,58892,20976,27702,140090,96075,67841,103292,238964,87778,107338,17019,83427,67522,7302,8261,47570,116787,8730,80484,61772,174422,56005,131193,52875,14588,28471,59817,9586,15720,158155,51307,109734,15196,11025,59331,3884,52626,102602,84797,25158,27314,4437,20488,76214,189248,35023,114952,157376,2827,62439,102878,129749,36405,10329,109339,108633,36662,1254,13267,5470,87105,58004,15397,10434,159667,21864,52022,179464,3013,32147,31496,116832,18494,105502,129227,107267,50033,13481,9954,24267,22141,16257,116154,36185,950,115685,11305,176708,2048,178671,112573,287867,162328,497663,95170,50979,193861,50987,30368,136257,31830,46549,15119,169876,23788,17462,249887,57377,1949,35448,14791,43769,210091,3783,34612,282103,88380,245190,5457,20491,98908,11402,86899,117916,16028,162584,60644,320177,156096,31065,55876,22e3,77655,9992,23397,13757,317623,63978,215255,2443,17648,93231,27388,104529,93807,55505,140477,12046,112040,70887,40152,94365,112353,25063,114679,266061,71248,119555,15589,2244,617,14129,211431,70110,100652,7777,4383,85911,89221,21010,120615,58357,86405,37554,41647,18,15143,69662,60491,14714,186134,148344,42347,5410,168175,44535,42449,343894,129417,99682,20659,27272,140483,63455,222159,17536,13722,42637,62324,11976,114691,148109,2283,32057,182393,4295,147364,33705,2075,44303,30274,28331,63740,69740,29148,10346,44862,33716,73937,153333,12930,38784,247159,2515,41053,20256,83368,256189,54639,115240,5096,24661,175419,153552,26516,141,138176,63885,34115,47222,55709,2765,28479,38875,236608,12229,22921,77291,54426,45388,2860,57787,114579,295139,105782,17826,71066,19119,54364,69385,16568,12323,28057,33346,34919,124763,155533,101386,31644,8627,49001,303600,29868,63213,9103,77280,71333,9696,138789,37059,24823,5057,21352,32368,114208,56803,19424,10445,58514,8661,209508,26187,171838,10460,63454,14016,122504,41328,21329,46618,32493,38225,7855,31763,7945,29876,8734,6438,24205,97490,139977,130740,47323,33195,85390,57194,13813,60600,21313,96251,7699,27584,170521,139271,1363,4402,336738,129223,84983,69150,13147,3590,163929,207225,155260,55916,20288,4503,8398,98490,11773,27512,37113,84976,86558,28365,11756,116005,182148,13733,115313,47644,67208,85069,9347,14995,226141,14704,101835,41159,35314,13113,63526,214039,29978,50446,83339,17440,129441,72522,118641,97816,24907,73844,15717,118884,167255,96509,162793,30847,36849,51297,78974,77793,10427,1873,2972,9999,35074,28190,64297,146836,46298,60038,163007,108919,61219,2403,75022,127339,4233,110389,69022,9833,128097,88016,79390,222936,22570,94657,28462,56956,38803,81536,30474,152794,19566,16481,147408,74574,81895,20731,1918,1366,76367,187321,54494,24366,21690,61696,33283,107477,77499,31112,414383,74362,18463,218441,120929,59848,258629,201924,69269,454,19989,13054,59894,3623,58908,20681,35723,78523,102680,38988,184112,108087,50944,132704,52966,21699,18860,96349,201411,82697,85395,95658,5093,6427,177894,44191,32755,26961,155739,6249,31310,81030,26574,84311,120155,86730,113535,7424,48888,13516,45747,98098,20077,183995,81945,43210,26704,40420,75831,45648,11180,6855,57927,65528,124096,34851,2598,156633,107572,127352,38169,123845,60142,62722,105584,232364,23211,68120,1601,22169,89299,747,258039,80572,7258,152249,11862,101204,8834,121434,33761,19175,133142,46343,40178,48723,3589,41977,30210,38868,62257,10087,82658,87827,90646,16415,47552,351723,28298,72225,91146,272760,1701,11295,1652,109651,300747,51863,198800,29446,11794,32345,37538,22356,33102,37590,113544,37970,11478,179743,25454,103417,59905,221970,105196,145604,7817,164809,102360,16974,75840,255333,56902,6659,1954,645,59400,67769,7689,18675,5215,13793,20536,27852,3387,29523,259718,16860,94625,43143,29245,15848,233581,22685,63631,78557,22836,133302,84513,1348,51826,47129,98836,58284,1830,1749,94642,10933,6145,12506,10975,13879,103781,144434,10268,28409,32346,52968,121567,107374,77268,23686,35097,10501,155275,15303,47136,21102,168741,55332,90385,15996,84817,681,137803,25054,142275,6163,38175,8056,124296,240642,65621,4934,178205,16101,62803,60964,18230,100622,76465,44689,14545,9543,47514,16852,93380,28048,12047,107106,37575,101485,77047,57326,34819,96137,76916,6469,46264,115983,75768,87668,69942,13027,165,8373,114231,26434,52844,42799,182044,23580,146254,38081,43236,33883,146220,382894,14606,46035,36481,166621,35417,95382,2957,59384,60428,36358,66343,75378,22267,22950,83528,17577,56474,25285,4619,179691,75355,95836,53295,34588,171410,4487,14679,84208,44015,18562,109133,54101,11531,86052,174479,303157,28095,9953,35642,14564,39802,16145,77606,117406,53038,121117,53624,22062,1212,7632,127157,237292,189087,10478,127345,102515,181997,86752,87623,10966,121602,68783,68681,83042,114380,138349,191305,67176,50085,39016,1427,42384,1412,67118,122616,72389,25260,2237,13576,137346,19938,20304,2191,68759,5373,61364,238507,75814,23931,69565,38993,131741,38364,12528,87762,5679,129853,5310,186831,32653,90338,260176,389531,108118,26843,43985,50175,30563,25106,56965,18130,140428,4542,165503,117991,24219,229605,1819,129663,1240,3797,76093,18398,71339,51919,93043,27175,47060,216257,6483,35051,1217,16512,80798,129064,13225,69339,8548,237079,72298,2575,34280,51379,117910,55671,53345,247552,29486,39328,140821,34681,57045,60177,5004,90269,78522,2479,322607,48474,61296,13057,31558,4678,59271,6699,27044,31988,35944,12503,83480,4389,136508,3781,114121,70279,4488,155829,42214,2898,68191,75695,305850,45041,74344,106509,30087,17429,93292,12477,290,23080,114802,35714,18751,26554,105424,17775,2144,2412,100610,65192,113975,52975,180272,135050,129815,76238,106483,21440,63186,4260,46189,9711,28249,4169,23429,23390,8324,141585,63809,67668,38457,38063,39226,59972,1189,203916,62368,14403,16949,61767,85801,1739,40147,35049,76757,33124,62102,15780,103593,103009,53484,22952,67973,114645,6566,5245,50462,7601,8288,3513,194571,80276,1908,54592,5124,58571,2513,6800,273997,193904,1119,17991,117245,2508,129156,82366,26278,71465,63341,56943,39662,106116,94966,156875,9736,2204,122308,94418,27134,1280,24539,49022,45314,3764,50904,46424,30699,28087,293839,9400,33646,40165,822,147499,50263,116179,29085,11863,31314,5578,17797,5104,12454,1604,15342,219206,10232,67800,94261,25872,13565,90339,78971,75377,26649,41184,47695,11514,35369,20767,14227,41953,309396,148270,147938,33074,14453,27499,109019,39018,25738,240196,158931,52820,8612,95853,21524,137010,84901,70869,70021,116794,48404,38771,6732,1070,70990,187297,49140,5238,576,3564,253975,16027,16483,2811,37775,19034,25259,4053,2e3,70083,95774,19713,33431,92703,91314,42381,288770,48194,95985,3991,77418,13406,241328,245086,56533,35275,62725,9246,51924,70181,95331,16163,31410,79016,39312,120878,119371,275987,80124,27712,9186,220,23598,146167,85209,68238,282190,57048,31273,30555,80913,17594,75779,59160,135002,101219,189377,29225,96735,60126,62522,104e3,27620,86814,17240,147533,11001,5425,43682,410,49460,87270,69480,46315,59448,1816,76201,9431,11788,87960,29063,65539,47347,11678,33846,7008,196704,9895,6753,8633,120892,59970,572824,115934,6646,202559,892,48351,37611,251282,57823,67263,57750,26527,34485,90747,7685,88370,6144,64182,1709,41969,21458,62327,181657,49247,225330,122600,114574,107124,85361,111833,63243,71420,15655,191178,72430,18063,51425,54002,12364,53225,86557,18193,97580,41232,138398,67821,128724,8944,233212,101353,52099,42127,14006,120107,32789,32132,3498,18123,33758,56058,5779,128760,59888,98869,18445,84702,51911,13234,218379,20093,39031,8074,70195,20708,23462,24355,131384,60189,26390,10403,41060,7140,10781,49410,42261,87202,82566,41663,43105,60276,2768,5733,74176,28329,2297,145430,131632,83615,122915,105441,655,224102,5284,136426,67763,16294,188511,32538,61049,27893,3394,13951,159099,28542,17930,145360,9492,190122,32285,78855,26440,13570,58648,73908,4239,124561,2444,74172,53131,11468,10794,73566,11623,35343,64710,30481,4163,10328,38309,29901,10538,154377,76132,92405,24839,11679,3465,13449,11637,7824,2337,57754,1260,14458,41118,19878,38661,13416,159180,37074,163164,54137,28627,52134,184900,8520,40385,29546,30502,22386,66527,107458,6850,24022,47983,30603,35083,8934,304066,39500,9,28261,33026,77251,9374,44833,116312,34990,29236,63563,125639,135405,165398,159055,55690,88141,69643,236964,31983,25572,20436,36746,60896,31850,16179,11828,5888,3043,66368,9750,31167,7915,53111,36430,1333,64344,93659,20061,60596,180191,51630,6792,30244,43509,101058,22409,420,44210,109783,43223,27030,72477,72831,32679,29235,7675,47556,12258,39907,149412,84926,118247,24692,71717,105038,86009,45941,41189,89453,29856,52543,30627,226798,67303,59230,67415,34408,1367,99685,16867,128419,52147,4111,125381,117881,16173,44093,102224,31575,23234,24870,83790,127407,239098,3200,994,1255,100903,242275,117266,55116,38205,16140,29662,11307,40414,208793,123355,56470,4862,75600,30119,58218,70828,24075,26974,7802,192353,4851,5475,78720,66596,3409,28573,64396,30381,30690,59859,88256,5406,99945,103064,34463,37727,24238,86643,60088,4057,23741,5967,162904,38240,28356,93858,25510,122879,6897,3278,7057,11971,4400,35461,211413,21395,59615,39471,87233,55795,128426,3051,22470,41950,14705,3974,180108,80476,78442,204996,91987,15634,67610,139015,142373,35611,51134,10387,4353,153456,57749,181039,14183,68447,151532,21107,36452,20551,3186,46247,46383,129666,88736,140662,146243,2066,8360,7978,64818,106963,17896,47801,10723,114821,223295,74192,3293,3393,16987,74064,11277,91622,4270,29828,27951,387869,103235,1374,61988,120083,477,145892,128378,11779,211263,61354,18221,17869,46530,83061,108538,157981,90608,67199,95080,49064,195814,12302,66307,10348,231346,160732,112859,63633,146558,21271,31037,198802,47622,12862,95710,3910,77850,73961,85585,34752,61e3,4082,24595,103679,71107,8208,79568,150019,16615,24961,139857,32664,197366,4559,54735,32696,4126,162019,75698,13916,70108,159638,19834,9349,24675,175560,49643,18206,52459,27992,10809,88865,401975,133172,29e3,34558,30915,3658,25834,42430,36562,125265,18182,10155,40149,97082,208980,19575,60853,90529,66545,9600,789,46420,2317,88593,55595,98980,115302,5742,169155,1073,177901,3472,11189,63711,78643,65472,50459,127979,93,42202,67053,21720,157650,11145,141378,42033,22824,85705,79114,35584,15974,1510,54172,28562,12451,104226,19190,97151,73024,20948,5151,81741,21499,29006,84183,198074,54003,45120,170125,26240,35177,28389,64863,79974,60778,176915,232183,45342,2038,80253,41564,40703,32689,5430,100689,5366,23007,134279,14266,26712,73993,24934,64242,52113,102887,61801,46415,201049,54251,62133,122757,164883,30815,139966,2319,30842,766,13362,10287,134518,86111,81665,82440,28333,43019,18963,8804,161944,23439,102144,101145,80029,39052,248708,30350,117340,11878,128467,974,138625,63961,5237,74778,61834,67040,43814,13690,65947,33809,232476,115258,181745,28824,94013,9510,10246,93722,81976,7217,114383,3493,16014,69045,72692,12145,80981,9507,6692,1620,60820,330444,35474,33962,4797,7053,295463,46445,27026,12491,77988,49524,35675,90947,29114,166705,101385,133782,32704,6186,84595,176031,185623,45966,151302,63069,1699,107491,947,15458,74452,196212,6046,10498,12163,10239,35191,243951,9277,9090,29539,54460,22820,26514,112549,60372,51753,48756,21812,70861,260326,41,44222,10441,16961,48148,138771,216194,5914,52153,53400,212036,56519,26245,10117,45888,15294,138019,90913,26368,43842,42111,23348,6082,194845,161089,156206,51546,11647,30759,302912,262094,8635,78876,26535,35283,54183,31183,85484,147873,12989,5197,6356,72894,65347,20150,27370,73787,1493,45918,12366,190217,20724,13858,10981,67449,81213,7553,14115,72242,271517,11842,48310,88743,143726,22177,3290,243231,58452,62937,12592,1654,40066,33477,13751,9921,128442,15868,7106,75236,83773,10775,36938,10482,170465,17368,17469,161508,32752,98340,800,19824,264456,3901,87319,2867,26782,9630,113102,185815,24197,44584,86366,40224,3636,140916,31731,267731,9567,53678,72984,29389,27963,17106,50282,284911,60170,8322,12608,23374,89652,5268,39044,229766,8869,151350,31436,177342,12269,183212,120418,116270,2843,78888,69192,7865,184099,1086,129897,18383,70508,20242,18508,229924,124569,35749,50589,55626,9884,83115,40971,30671,18135,14452,38861,17844,201826,5549,26413,17189,13561,38539,10679,143331,3314,36785,171194,49685,187713,67506,4618,104039,17060,195080,50648,33159,19238,67559,134840,28599,157523,17130,38064,117398,94355,31918,13575,34538,40326,13997,3494,348283,62481,26862,3603,104426,244363,153709,112487,304612,199674,41239,35545,54869,293005,28223,26277,26899,4533,18518,15492,38587,80488,70485,160395,263,60162,11382,222152,4696,250751,51921,182609,10707,48463,46243,1227,49111,111564,46502,33342,56846,68541,63559,858,139927,16654,229375,76759,26478,33205,95828,23399,92945,2637,35630,28470,143992,50214,14174,21456,166191,65665,1711,21594,78019,97599,111701,36,147151,110246,189022,43021,30397,40757,131935,42065,73335,48039,26596,28984,15102,2361,7421,202167,69744,43766,52826,3642,83304,33873,75140,63169,192389,36551,92748,13039,123959,233220,21738,84447,77230,20228,187852,19095,25799,92136,108774,29237,53947,2299,118106,2687,8830,42331,202924,33667,2023,73763,30704,19363,19779,16737,35629,48081,24068,101013,162338,291912,13749,24745,328289,167679,70086,48299,23306,16732,17801,43322,54589,3586,63653,43624,53474,925,109177,251316,43805,13082,19511,86565,142182,92461,17117,101033,103319,64589,4022,4351,235897,5352,82705,107142,46391,156084,5860,61365,10558,13045,7717,18357,33922,12590,33065,6928,46993,783,46937,67846,8952,26295,6107,119656,18799,17458,50747,4229,179559,112727,118080,20683,41464,125468,51560,49749,44231,7359,35339,62988,136487,67015,5208,29150,24956,105186,48858,6143,18097,6972,16404,73489,58742,97196,36357,164616,5834,32267,13746,147733,15113,132091,34127,106298,39729,106426,22294,9780,15602,36213,71502,42808,66802,599,60755,5851,39120,67363,108623,126368,72770,91263,32486,30596,151717,7951,52002,43103,11768,68942,40901,39344,24037,127500,116890,48403,16926,86750,17745,48648,159545,34460,58419,5634,114317,67865,31462,23352,24010,98185,125708,69686,68337,13610,26271,70691,2980,4768,27225,102402,75453,28106,8104,6931,1176,6274,6475,112635,22498,6176,238686,26832,28893,90319,14441,15682,15087,39517,45270,109134,104440,45965,47645,81772,7876,52683,87720,12898,4505,185665,2769,113401,15664,57592,105229,137381,97059,119268,6876,43309,33886,128363,35476,144249,67013,143587,83367,25703,91436,59347,53236,2289,16519,19844,46309,58558,99834,23313,218816,231303,36388,51333,183535,109792,139277,54306,90139,18235,8275,32710,37677,82464,86025,92204,88842,117723,37570,128723,234242,76350,73795,34896,148247,58424,11105,11744,45746,63372,17118,49772,199520,81902,38004,22911,33752,3125,1995,53792,4689,26909,108150,146062,69674,41811,161444,84855,8999,28561,16731,93937,3189,21967,24890,22943,1356,145300,51569,28802,517,118679,31703,40607,48098,108854,25003,10233,73969,177495,5248,24516,215347,146192,48712,60626,69188,40735,5866,586,101541,6509,47590,52129,5969,222045,110933,25733,24223,65339,62812,2414,155418,35819,16022,78423,43138,20995,128255,240673,46745,236093,72176,57085,97841,61248,107,36068,193177,105427,55726,215229,20446,47228,100420,87091,14429,121708,23605,21157,187721,21880,2997,203976,99166,95068,25877,7724,98925,83401,4829,13182,18229,13718,239662,38653,116505,153497,30589,89029,38962,181302,43853,78872,180301,4786,248240,7401,106136,112590,77745,19731,60880,77789,125748,135487,5975,48627,34084,12419,215770,47557,254582,10364,106495,21856,67539,88981,38805,21428,48732,42316,12149,16078,52808,25327,51322,33850,51147,12253,122354,46077,56483,254553,115417,81834,150991,94662,86668,7381,12841,100650,18218,15741,22372,68294,50705,15535,84660,61887,22553,72299,31361,24824,17743,46820,64288,31582,77006,111674,116384,30760,80920,86149,77192,51979,79691,60342,122805,103800,240873,160744,233114,78962,54920,8608,3484,316104,72548,24337,5088,230040,21926,10172,36838,26,86221,83458,102176,12062,17571,41929,41170,28428,68239,41750,103930,2634,18313,53019,34825,97837,63115,24606,73157,152474,14715,91439,37033,109806,140259,30668,174760,380,135597,95673,136073,65073,134249,13829,17279,122305,4420,46444,10237,64848,203623,70728,10349,182885,65075,24519,25783,40318,34139,22222,63394,55266,102764,41422,20126,65100,90408,53640,35128,48932,11192,38935,96839,34782,39492,19396,41332,6250,5511,19492,51304,25936,104466,54099,73771,86115,5080,7669,30891,111700,13931,25276,72289,135447,14820,258641,25265,31005,281179,75286,393,95359,14623,13584,6680,101227,80173,44933,76666,54542,13244,39348,458,25379,109451,134348,81143,6959,65554,12027,51311,8716,57589,140731,28467,23316,17272,30458,25980,55229,77197,83798,28302,114784,7428,34548,26241,14712,39336,103304,18928,54080,12870,334,87722,15208,16895,142098,114262,39820,83913,57817,28682,7721,14900,108672,11250,62246,42849,415188,1724,26555,24549,25505,26443,107450,145899,61035,43528,6901,60726,65906,267741,21338,147590,42079,18924,73017,135236,15393,5206,4026,84185,1531,5988,113890,82647,303391,7386,69844,71611,189865,76523,31877,13315,19314,198575,32821,1928,67641,25913,104475,103489,3297,70391,18406,15446,113347,19295,93790,27856,1792,167471,116449,8541,4408,41757,63233,25765,86680,64501,27034,24816,34975,6079,4486,49693,36229,16917,21581,62426,27862,11612,54284,35702,194034,355,24277,48262,87411,70504,310164,118018,12516,47559,43502,57433,107139,9290,66533,80863,14634,34312,91725,28606,21342,67241,72355,43244,375789,37402,174015,105070,8342,44167,67494,1890,16365,11723,271002,1865,47918,8350,45564,27742,25110,125803,8553,49504,81925,62211,4534,15491,19011,80373,206920,667,102405,128623,245524,5553,113309,192739,65766,19567,22832,261958,29679,21293,71134,20962,105123,24721,860,21752,33448,18372,157167,94822,35770,173224,232737,75729,28937,46828,28062,25453,5207,140366,36665,30652,6169,67920,150458,92040,23186,184604,92330,20891,176492,49427,27828,38305,42495,143982,49560,25503,90043,29747,65328,47830,12932,11068,77721,9003,25213,94205,140426,46090,89945,138173,192691,33329,112232,129905,35709,27514,1841,19957,31411,127476,53572,17497,173549,55063,175135,19841,69314,5192,237921,117660,150697,4060,273045,50414,98940,65348,153665,164423,58804,156695,48994,213928,86036,28608,8355,39574,34540,16927,135680,18374,151587,10830,53805,16878,16623,4282,48030,8537,14986,46102,13062,72897,72,33050,108227,39451,45935,651,113320,40535,95176,57450,48843,5003,19019,10407,211163,3848,1068,4988,32091,30095,41692,15099,43602,107434,50744,7627,171349,16313,150832,352665,207750,33937,38256,51091,156e3,87889,90663,84175,24908,114900,50365,31494,83829,5398,169342,47521,54818,18935,8356,43094,41212,174536,10082,92550,6678,60614,23355,69721,14796,34149,128830,58187,3179,208,40325,28399,225029,401412,51150,31580,207268,6657,10993,69818,64282,289845,23308,12961,38447,6681,52944,31855,2572,47646,120728,179148,37240,45196,218274,4816,3695,21961,50084,35209,18073,51452,27004,6100,33941,1377,84831,171214,85,141510,9078,99227,32610,6417,11718,49868,65579,87902,73018,49062,46280,61742,21512,40862,107733,15941,29168,157765,144919,14487,5767,158014,140070,7241,573,71584,16921,223566,40331,179473,35081,47926,140885,41508,52104,59180,42310,32811,29048,123517,102413,80208,10104,14746,12649,153641,126022,37965,113017,4171,83,142592,2809,6362,50416,71323,116894,260776,16204,1524,5760,30351,12658,20703,54403,36083,45408,74772,4946,14485,50759,111222,10890,2195,167147,92962,130534,16283,177256,35016,15472,210156,151187,73922,117691,43250,52051,37392,24811,24358,30830,5775,818,21969,1476,127322,151783,58392,31021,106913,65215,89407,90802,28531,11690,20234,95249,44602,37256,18707,11928,5161,4410,26571,51903,49768,22008,25252,65780,209499,68769,203726,13249,137363,48845,86823,6658,5674,31881,1083,1823,108676,34518,166752,13791,14287,91576,91429,8665,11529,26401,16191,91972,30964,5254,28486,54697,79613,66520,18447,22870,45203,194466,22822,51703,12278,76716,44595,73455,33546,12235,144843,36154,51247,11116,33040,3180,225753,60864,1972,28469,12891,28879,10338,144157,56294,353058,38302,41447,87532,110616,27065,168438,6557,1213,50804,144643,24817,2390,136531,38174,247513,16190,4059,122791,131994,137430,39506,57650,16305,5188,54309,106128,20628,88071,67394,395446,250285,66176,91254,1399,114196,43915,60230,44853,27206,106353,43013,18733,345105,226453,51202,16607,57106,117175,35492,10476,89598,127439,15187,39624,13688,61570,10615,31111,59370,6238,175252,32143,224492,41388,95408,34384,148238,78307,38959,9340,160091,61443,15737,11216,41244,170,38299,102443,113097,26382,14027,33707,3957,76300,66160,19431,18900,6952,1717,108656,82206,188021,257335,27295,43999,41210,31777,46956,57457,12657,11489,15697,48060,204748,53583,82422,284790,30503,137341,8120,19615,220311,15991,10217,63424,9808,67431,70976,98221,4491,15177,28535,144789,751,13230,2394,1504,33977,132104,30316,22230,931,97193,185240,24826,22687,174322,15307,22988,1390,188745,180325,29580,59068,74903,18994,29195,79,15436,7622,38462,11566,138710,44828,45774,37768,99236,68137,84083,19282,22698,17134,74807,126662,173497,46248,16938,119735,3212,28292,213652,49013,9975,32180,45660,86250,4801,68788,95490,77482,113751,11994,44624,94452,46839,128497,100316,5798,58588,73184,202987,65417,37790,88524,1606,43156,97964,105717,34947,11203,100060,37742,130074,93653,107799,94311,196106,41347,8035,10780,16390,27883,118236,167395,1979,25006,19375,31628,18916,144723,78502,114047,103107,86492,107686,5844,20934,206963,23556,22591,16562,146333,20167,10471,117434,33085,2863,9740,36669,41849,37271,22790,18209,28979,8231,12952,54408,21731,25130,45208,55748,138120,75826,414,29593,9925,292865,25999,683,123149,7036,92159,86055,61827,103680,23176,54918,58466,57578,13305,5709,86479,16697,31064,17660,200919,10770,49793,33423,32370,52047,16488,62555,6459,8426,83493,7763,59725,82812,18628,67760,79405,68557,9612,7673,28102,56517,69620,171797,32458,29541,15870,81109,32080,207644,71495,21202,11039,91036,61230,2810,130800,32260,4613,60590,37112,75214,33979,126402,155062,30642,63875,12810,194463,82799,47664,16725,36685,43367,61099,449,172150,102867,21691,301838,36745,7130,18671,57316,34852,38034,54182,35578,65900,99486,19771,3456,2658,16914,99866,28390,28109,8262,21147,34353,20006,4228,137085,1675,203023,283196,198286,214375,163329,290603,152574,40471,83506,30068,14730,23177,131539,34759,27668,32178,71896,104799,116305,85430,119262,42860,25160,8911,23428,49437,105322,6519,16203,6349,74711,1230,38045,8540,75165,44736,25909,51026,317034,4984,32281,91312,27060,44431,17817,45363,155937,239085,35697,59784,91993,29531,126740,213757,76560,167776,285273,24262,8237,65030,41160,74437,48804,118916,13159,37842,1031,75349,1478,11655,108777,23435,277425,101734,67469,70231,124711,43532,28514,65526,54956,1e3,21882,17728,25302,40952,52214,149632,1999,2111,3259,63362,89961,220561,39777,26335,9063,10572,12416,34551,34623,38604,24723,5947,15588,69927,66252,119177,69173,46629,28714,70715,212408,20521,406913,74380,11716,50659,50862,37009,88460,130101,7210,53853,538,65120,151950,55806,163748,52837,13153,21100,16674,64536,6091,138201,44837,58547,3723,163,2177,32288,85454,34033,8497,14282,25742,10535,10741,79559,117493,243787,49337,100718,79495,40139,42956,7551,55433,15421,31509,23034,45081,547,61176,53434,328001,8470,36263,30145,4519,74173,53935,11845,73774,60211,78025,3,4102,73782,109293,315332,48412,26683,13714,6865,20128,18490,104141,325,39470,171970,115860,15707,7268,73301,74336,31370,2368,111827,107757,136231,142844,97138,96638,84053,38691,23801,1588,10573,122098,77039,240,186135,146101,11996,18143,112963,46171,155836,348769,47795,121213,116266,132515,3344,144804,31286,99187,255838,129694,35894,48779,55235,148582,71967,65282,15174,13920,47080,6147,108242,157593,125025,7136,1286,28957,127956,28402,98813,20805,7532,109417,40610,5041,32958,15142,18408,108596,33543,50517,27748,80114,233434,91447,487,37094,100048,30541,43477,10639,89862,155868,37667,8726,60684,237903,73408,99589,12190,38739,97348,3914,13594,2680,149016,13907,30171,28343,23530,115225,61104,35821,147679,14337,4297,244282,24085,326976,56428,7851,21303,131620,71446,83253,68692,111870,5224,15813,38197,49026,45057,13660,3306,76345,40671,27905,91072,996,68527,62085,91351,122634,55109,168209,2024,27560,112707,17352,8306,167115,169921,166958,5031,46020,11844,67284,19130,76185,6920,32849,5450,14610,22451,21002,17392,31872,66682,84796,13709,40210,59898,12029,8719,53564,21462,91884,21647,88379,194428,12754,37797,132826,160016,22567,54383,53186,77611,31107,8339,4694,19185,90355,23597,17222,140675,28442,23668,55977,9128,61555,28774,155229,17658,9390,24379,69357,15752,127381,239631,62460,93181,55913,45133,140155,18676,25249,33164,29581,82837,67223,22362,29975,7317,52813,1943,29613,20012,207130,49617,49651,5636,15334,36313,29226,28084,95247,72072,19e3,224932,15811,114,32127,38097,37508,88507,37225,27359,91626,12193,69279,20608,11055,88156,92808,2152,57259,55275,72789,24475,104414,1708,9882,3818,48661,66897,1631,34806,227930,85815,87753,18321,250664,72733,25107,206797,50891,8082,196411,92596,96764,152823,65514,22819,387277,62176,51225,40329,15563,189,3659,73670,64357,51793,275136,33482,86653,74615,67058,11318,125720,15388,22388,8267,1730,102663,170910,40784,7144,85373,13040,7088,94309,583,44224,140424,77439,18496,164026,36578,4722,9151,5824,63365,26510,35199,40500,79277,32495,44614,35233,9566,203293,152144,7097,2330,183480,98629,13423,330887,44130,68600,30939,97829,31012,345465,56747,94879,4939,160027,149761,99423,46099,32251,15332,8761,96094,128555,5763,235318,222223,55729,30241,55420,201746,3987,81382,8259,49325,23287,7719,24633,251100,92311,18591,110533,64759,170260,393860,7175,21144,132887,3593,75346,101277,91109,16387,259187,11627,57459,173829,44694,55780,49797,89192,120443,62622,3904,14814,23887,1027,112258,64955,99800,11132,66353,36202,48624,18158,88481,96882,43059,11040,2455,7077,21651,181159,99126,100434,61388,68186,19161,110468,120052,8819,55324,41494,7014,37689,3618,87729,92615,207943,9823,128657,12587,15857,6379,67628,51216,71775,157617,63244,1503,3864,218754,110864,5769,21492,7243,1192,87921,85529,31512,18537,42698,35350,73510,84474,34301,8991,21013,35034,566,38832,19838,35586,37216,39413,55006,12178,59742,856,84563,6900,25632,17437,49786,30723,13847,70845,4044,7843,23944,235976,55530,48942,6518,20939,73769,192653,52936,95207,23895,132542,142982,22632,87452,48042,54018,178468,10728,26230,23559,363,81269,142012,5718,346258,31456,84333,246476,51018,66692,101804,120570,39962,30373,70593,2864,60541,19425,54209,104092,7201,31545,48018,25865,15442,46257,40443,8328,6451,111782,47527,97754,33046,470,245116,31095,39,91934,87208,73470,36708,36521,12801,70624,36272,8892,79768,12427,55454,103756,5908,52390,62962,22720,141138,94634,41689,128402,126390,6628,106394,35527,134394,82727,254651,194502,148064,89549,3202,28359,957,21954,27906,49840,142747,8307,24206,48978,1186,71728,133038,71474,91306,6333,110959,74600,70387,18983,62609,56057,22970,1147,135850,1321,28834,3578,59715,102227,32827,81415,99952,55636,257598,390,22702,35701,85872,402916,39216,189795,14929,19467,10112,144422,61514,5279,63421,134686,41436,8424,51925,10598,132295,124416,4604,194739,210929,57866,31829,51626,50007,9976,91878,61906,56168,81906,60918,61859,40017,23059,16887,40927,62064,12785,32893,32913,21782,93965,20169,44387,79084,38463,11457,93950,27127,157050,2697,337088,5116,54128,48255,33279,8821,27352,25515,124022,65710,28906,38557,33390,1722,104435,72215,38551,12094,30978,25113,6671,37355,175109,42862,98024,65406,221276,59624,118012,64637,78760,86697,21426,1639,40350,12584,67193,84144,31396,7863,143011,69629,63112,9454,28666,65798,46372,134721,6314,51402,30837,151922,2847,38676,38008,92823,136245,17540,5504,109295,205242,37606,5211,214892,1586,20670,208711,137743,19328,40652,16995,20023,14657,154919,34422,12996,13918,38221,47690,16398,2959,37680,89122,6721,198469,91876,172043,83898,101992,26084,94570,3635,76958,22853,76497,38266,176590,168403,44464,142840,79180,184594,1984,41806,83147,11985,6546,366068,59732,24533,271505,8736,39084,222992,93429,28962,58985,86665,8432,30028,14548,32439,54424,165029,55175,27458,69046,121277,46168,33732,20661,24581,135574,123110,37556,79260,72611,16957,12939,46162,58238,44907,72936,253758,41324,32518,96480,11949,124438,65280,43256,34107,53533,43531,37037,28366,45970,32741,173438,6121,194202,62969,26355,30314,58370,28455,1848,50519,82830,90393,21761,295490,10936,256940,133568,44050,20269,4089,27457,21610,219460,36743,14821,101388,52005,13124,30979,140816,167362,26054,18458,60789,34917,40447,26606,33422,9066,3452,83614,5761,20263,137238,25038,91310,101,52322,74548,42572,38084,214054,186568,31802,17665,30620,141936,37730,14420,4265,187218,49640,188208,51441,55388,96452,66659,40869,42039,60967,221027,19234,178581,29105,96050,9165,196118,157335,3738,40354,117436,2965,34136,59659,15570,50843,230035,31444,71260,43886,18316,5387,38500,168508,17406,32174,8828,103373,143806,90367,3560,18719,122310,16508,26719,2541,105429,6645,37998,73190,10591,235916,49737,87112,233941,53188,32193,79154,4544,52905,126477,7580,63501,57314,3216,31337,6541,103083,60846,49,9756,15481,1355,43840,14319,13743,27486,10222,73114,230718,418644,16706,6674,279748,23058,45273,295831,86306,2743,5535,88773,21829,35253,120938,31153,3169,16839,42847,8751,80974,33942,36867,35514,16485,26474,77775,56877,5391,48346,3882,108713,31403,27804,55248,26235,43821,136104,40118,175507,28034,203908,18732,1788,34030,106427,36958,54359,7251,44936,15356,69139,455,157915,22173,140291,50348,43275,82066,49621,54952,15216,36226,96695,66855,6936,1987,8227,196087,4631,68827,99004,47541,110265,17953,147605,110242,58520,31312,38724,329975,642,3155,34497,75937,6207,73843,6120,17249,51429,117746,3218,910,68961,319671,14938,29555,34700,1649,66673,72268,9655,76800,153087,6941,210168,27130,35398,1780,73242,3135,56689,19556,165307,8765,35967,121458,13333,70453,17350,117253,22265,13340,44265,39869,441,3742,135025,23581,33309,16543,17731,13291,157637,283005,21408,101360,63887,52312,83873,5338,233779,23759,186949,34531,177320,38069,156465,91004,19353,59852,68160,14891,1338,1072,29823,1950,28901,81407,313445,73038,84807,162348,240257,37162,138934,16111,58013,41253,102951,16457,96056,19541,56402,67217,41638,94381,89674,29481,37456,80815,151579,13937,13683,132537,19699,134545,67020,29816,222341,141235,427578,48868,129557,233342,23077,87871,16213,18728,16184,9469,37913,19680,2798,171356,178328,13216,50049,72690,71904,124644,55455,7504,29052,41036,266546,19899,30391,188755,8659,59469,16,104298,112943,53865,76203,138226,68857,139953,14125,107625,119795,173133,4398,50273,48808,54390,16466,122086,31835,67035,50971,48859,7508,46427,66477,73021,84615,39985,83076,46779,201569,53336,36443,60865,168164,143810,51393,25548,169307,32896,24485,38424,21837,29087,275813,51674,6714,64883,46169,187369,55186,76192,12852,12018,62134,31067,118303,16542,12125,10579,4928,26291,43854,7091,10946,253716,109062,39283,17261,113012,258512,47764,125126,32646,55892,80279,201623,149872,3192,385,1208,48750,5376,58738,22335,5427,82416,47811,32435,143086,38930,94128,59975,156037,37977,38224,62485,7698,50405,71027,16462,21559,136153,34131,107506,162069,63703,3101,215029,40407,4178,3774,9187,80019,17880,97926,67579,2600,18405,8351,47924,86638,70820,92206,86453,29610,42241,119200,3198,15466,67813,57863,35454,4779,99518,4649,104641,144269,33730,38073,65864,6838,109456,193298,154007,5623,45741,30846,182578,25573,157224,1543,58575,138703,146140,44971,49356,18275,59064,20300,13122,11848,24453,11973,9797,86843,2919,25530,49210,1130,161220,76788,75373,85604,34926,36014,17777,17255,51533,11676,92226,51845,119859,21525,5936,18507,28050,1140,31418,14857,34207,47859,10750,36382,32079,106909,59426,87757,38393,110042,15965,97104,33757,35344,97993,53979,33651,45407,41884,82515,173089,7177,58371,35365,47543,51927,35587,10670,23544,29306,84233,39976,76076,62097,9007,8668,28119,78281,120790,19835,143020,54968,18670,64959,20649,34469,42570,33001,136570,87796,120044,1106,58700,63951,127623,12805,83057,40212,31773,49850,7361,54336,347524,101314,23751,19569,48791,29174,49369,20467,7465,75842,38281,623,112457,60210,28849,51003,94720,6426,90047,85560,43761,3579,85105,34607,90410,118528,7224,42907,111163,18168,6960,161135,191298,5247,100584,127552,171568,20121,91173,12636,54615,20199,63730,98105,2396,40387,14438,125012,4765,33235,12865,45299,37728,82098,77872,114037,59253,19675,24838,398016,102561,11446,17069,57508,178277,65836,99941,26114,2585,271882,136866,50126,11027,155648,118367,14585,8910,123015,335383,40434,41016,53021,14439,87098,176860,201543,121888,2358,9286,5739,22666,54270,37884,169381,33984,93859,16124,89364,72207,51639,76366,99029,65812,2198,12147,174891,194289,6986,30252,88822,21284,11445,288337,160821,33034,100869,43852,25761,52882,1144,103809,1924,84458,86079,43411,13542,139276,18141,34978,41298,7276,26481,173800,33210,17951,142652,33616,33677,2210,19941,98568,2486,192414,80136,12058,235883,50963,249638,29572,27221,47034,6124,72107,63346,97620,158513,299699,40388,23235,37176,224244,198386,121323,67992,23827,63170,17838,106622,158590,26807,5345,23489,91891,55474,74834,37981,13058,5977,72552,34706,26828,145172,19904,21367,34043,960,77092,91381,4733,47446,7680,41697,5170,16960,14741,46101,13656,473,51842,37433,11103,11551,121951,13191,97536,165932,50397,51628,129028,9069,44885,6590,59195,47045,32940,225472,90345,21833,13303,29407,96615,141951,5198,6028,18395,7181,3861,14966,156358,167182,36529,55253,25942,173153,30959,27261,50691,150176,162201,38467,48462,80602,42163,118482,168,108756,26011,17166,54149,456538,22512,91374,13816,90358,131615,18132,226707,1824,28139,26860,42253,93877,77351,65575,8980,80574,22020,27948,40422,91324,76376,13528,39281,91685,82215,122541,144066,1983,193851,17283,26320,2739,194978,4790,26845,42627,61300,65815,174612,55133,4200,191130,79771,158321,52280,166796,221620,62461,11278,4067,88152,83409,31717,121367,13522,47325,37945,10406,174348,249321,154101,64912,29938,51775,17220,15776,166138,78890,84425,54121,42861,16368,24572,291647,10197,32073,22651,11677,97509,26952,35787,18424,41910,71614,94977,72318,41594,70024,275419,37702,60199,7335,39107,61315,18271,18394,33768,87884,104277,123724,7277,56288,71981,189803,49320,3352,6798,14240,8954,69220,94433,57372,28620,68863,193727,85575,42309,41667,67689,42081,22543,44824,12719,28540,114236,101553,27638,27296,4300,5353,4663,19379,94098,3758,95888,95144,80344,87320,28447,259518,12718,71391,152731,37063,24132,31911,104896,15672,103782,1521,4945,72541,23717,122632,15619,87175,206120,29428,189780,61416,28350,44457,972,1175,47233,198738,95789,41907,21953,97034,59341,22864,53713,16873,32971,20693,20954,31336,21477,16169,38370,16412,9019,3841,24599,21938,17085,6484,81198,76413,5849,72514,12320,65247,276175,37234,59796,52642,16312,57349,198507,94148,46134,18958,125552,1747,18725,151873,14901,5490,68287,29470,3689,64794,40814,26018,25692,54450,2703,88278,124886,173087,174e3,24159,179477,24276,46004,201876,209202,445,52876,31948,30206,157610,39180,18439,44124,50469,5774,96278,222758,200216,50290,45486,20435,46986,46276,140133,142326,15569,13363,47522,92583,2182,7135,16853,22998,30272,4952,63263,35623,39096,53789,44864,20053,110392,124213,4630,16087,28221,127787,25839,77481,44693,13464,113146,6983,27069,55717,50102,4760,7107,26186,66507,59145,36032,104182,71328,29425,64317,50781,47465,94298,69706,74899,22754,120756,25108,93077,56834,73286,39928,16218,41699,176763,7555,70819,50083,26895,23315,26014,16773,123079,41712,5719,31516,90427,158540,85051,183128,40864,27505,55392,9058,45224,96857,30901,136622,96557,56304,120061,11501,151448,5773,89743,7769,86069,2935,18471,41628,10114,33660,110170,49479,26745,92846,33221,26731,18795,87076,8550,2100,29972,120289,3077,72490,33784,2630,208722,50861,63483,79029,6419,39467,14302,45286,64207,9686,67513,44170,1050,77246,59266,17055,53801,7150,11111,42432,4278,94579,362117,36175,42902,41933,39002,98489,22913,74161,84773,57036,17556,162288,74485,178760,93867,73635,128860,50362,261,67455,80001,46080,35662,4368,25247,19230,74393,22588,1822,27682,235324,13798,85998,13194,235067,23514,71669,147632,23191,134748,214683,105101,1518,25489,247114,7380,54842,26922,3971,26361,20844,68642,170517,77339,123255,8963,77818,150998,48466,36806,2732,23261,11741,236162,18243,126216,28690,50546,16385,92760,197383,246558,201295,88255,67588,71687,176076,172653,169058,33906,63747,24835,157621,43338,30050,46152,132741,2770,51371,94835,6614,15112,11749,56936,1250,19027,399017,58036,100215,23388,55815,308768,124152,94803,9521,64186,8971,28,30427,62163,7616,103838,35079,29203,131235,7743,17389,10882,37420,61460,228512,85363,41581,131077,62822,119647,10130,54445,26925,19968,29016,24446,74028,24176,61448,67185,9254,8563,119129,9771,99184,37716,39514,10532,221512,258753,218630,55980,23394,32141,61924,66749,32411,3741,36475,26678,77010,44946,91203,128749,116953,20476,49625,53116,13735,102335,29376,51946,83407,67892,59212,34685,21083,1546,112982,32972,74397,1078,190545,16082,86140,58591,89611,101531,10061,105104,76319,20035,17551,52611,169061,190842,100780,23907,90413,115619,9675,34710,193435,49443,129734,11183,258877,16318,136182,126808,44635,27304,192375,2599,125648,47051,12091,23814,721,58800,40137,66726,97930,60877,74487,7942,54326,9841,41428,13762,8211,85383,6950,99177,79806,201786,296464,124087,13144,29741,41721,47634,55088,254286,106408,17041,99064,12942,64086,45233,14005,2612,55827,255,7984,13980,38574,12776,46654,73499,249951,2101,26676,25996,132326,116415,119062,50449,31033,23038,11589,179252,20007,14860,129270,21143,17796,144715,60106,70758,69842,34674,282133,44014,16774,57268,38528,24053,46373,201667,28327,471023,51889,102667,21193,114909,84132,69317,96723,67969,16134,68145,15058,28765,32035,2524,101089,98664,25045,76571,14957,86040,118506,262428,154764,81573,39681,283900,73287,127825,544,80448,52347,38512,175971,15180,45467,33086,46552,48894,81107,43213,36672,54025,76703,8053,7608,13299,56619,20752,238099,54164,105133,1444,32942,953,37564,8e3,66316,119463,106817,404,13667,149108,128597,31267,10269,49836,106150,1484,52330,76965,160486,171648,38456,31263,22424,37738,66245,67467,143369,60471,75610,20895,115528,86070,60854,40796,49347,18989,15030,11371,37578,15779,79867,10187,86462,46402,155626,93200,40229,7090,57547,108053,99598,11088,47505,41218,206017,2173,20988,30219,22919,80563,57566,42369,93141,41675,2407,182519,120495,27154,16702,29456,14349,7958,16688,117177,140375,42467,261919,74916,153569,10836,34742,49526,7621,105997,12212,2270,392377,7755,17959,25086,232152,138791,33847,13860,35316,5811,1344,71259,50452,207539,92635,50359,5821,33674,30255,2086,2587,96264,17543,42,6029,9580,43007,139248,82831,12917,29607,25786,51467,42137,85161,100698,31561,88989,121990,278500,3602,109344,37982,15279,116442,28936,30880,87894,58079,128661,126731,67392,28051,146885,4861,16216,97344,42827,147561,153948,22684,21335,47685,1853,43349,15185,59642,10229,25520,187921,108972,5579,98037,24945,6697,19193,63734,137934,75056,89740,19767,224268,56138,63643,151661,39313,70618,84031,89723,84074,13703,85626,35460,8867,64845,3439,57906,99776,63968,49270,81130,34356,16210,23547,36446,34090,140028,72439,2221,22163,57058,363492,113754,18913,95451,48663,54464,54037,176097,68425,3023,34906,29482,117389,341780,80431,58330,16753,92616,60907,94846,147486,4498,48646,7773,46801,7778,18946,464978,47558,33223,177444,7328,15626,63337,94700,11743,9351,255024,39098,16447,42647,96230,39769,58840,10068,63439,35800,65843,58823,413844,9156,51258,7434,61791,85018,6872,3692,28096,7121,33024,6009,75532,31997,192535,9661,3304,9547,14753,31987,25314,55689,15896,20430,39472,31340,99744,25398,115569,54883,28719,205423,23071,57855,64638,149867,25671,82403,37616,20668,39989,77996,74948,140555,175248,64810,36515,46595,4958,248773,24045,28728,136673,168704,20804,114833,100325,27135,21205,96151,153134,45992,7093,13992,76047,1980,19432,145001,75159,87462,17710,1013,45556,34297,144882,20648,26061,11319,129567,108555,18872,464580,33386,22717,65948,167189,5603,135042,79542,8801,202632,18114,91882,5973,5239,67315,4431,60916,47819,71693,32597,32606,18183,45072,80329,76385,24749,51305,40314,156514,14693,130345,13168,66214,18029,12858,34801,27628,14544,10823,40522,40185,33739,148694,23548,9923,61012,28859,17933,19442,34364,99849,164107,141167,30629,21054,6744,36491,8096,42474,41706,155060,30650,10600,163442,1143,96655,61390,52359,7559,51568,64256,203854,4467,22453,14504,436398,7878,6980,8293,63610,293747,16167,35763,19627,147603,15419,18032,110744,51346,33681,54571,40472,48615,39073,21604,13754,173027,92560,11083,47299,63062,11813,52007,29883,9734,139722,15953,1550,20651,13616,49306,16113,90089,92326,7584,30712,72424,164858,6831,152871,55746,197721,34167,196442,6022,112107,55215,7538,123381,4920,43539,77165,8939,50392,34192,20225,79762,22505,58667,40770,29788,97180,82835,4568,8579,13273,363569,35898,49983,436,36598,3237,131691,62418,35591,8101,4073,379438,65218,76072,33887,2968,27573,212619,288680,68278,72851,150504,217896,6913,121339,22017,35340,51072,43616,75043,31437,10833,81487,4364,22968,41454,106687,85446,19863,109625,149241,524,141850,214404,54376,657,237023,9401,108137,53800,32474,49712,53334,126876,27337,45552,177696,8269,15036,12097,42240,2328,125374,119295,99715,2500,19624,39441,27220,102691,60957,94543,39101,18566,67362,13975,78230,25017,34017,239007,90027,39351,41681,35354,43822,1043,916,58587,141983,94818,38799,75459,41114,67432,16195,36606,59568,22272,126769,31424,68659,12287,134302,257977,5756,207285,95637,47248,117689,19583,77451,22373,12200,54993,117118,34244,29386,34562,53819,71267,64172,77665,49368,7716,59301,25749,45426,194789,17297,2650,1766,32501,45198,20403,20984,6600,14171,94604,19037,5402,29896,9938,59935,109708,88081,145182,44844,39167,352626,164173,35374,45982,6122,154,73419,220487,53834,53601,17992,8609,229321,5610,68098,66815,71012,95069,140968,27396,8957,134489,24656,86659,56598,134852,17316,123838,255436,6613,41610,138033,81452,32023,32396,123687,63398,8693,29712,30407,19296,121188,3551,36099,20032,111948,56624,16547,27453,35916,15378,52039,56849,13489,22214,73177,53097,277349,2157,14029,187886,10260,141743,246460,91880,50869,3788,49486,133566,54950,33120,129337,53768,18333,9525,26902,312251,10297,9020,70759,16647,112432,59260,84609,9818,82766,73569,468,46001,75780,55028,52106,11498,43645,108069,17150,17753,29417,16705,31799,9606,289,122254,115975,8620,6133,255357,56908,14456,133464,43554,79224,11247,29630,160,12756,25464,65960,350428,62521,321796,100359,67358,35169,46172,113128,48988,88868,31094,33266,6847,60887,98188,49659,69117,92977,220228,13947,80181,35103,62170,97351,13475,2440,199768,19498,36597,46971,25234,67806,62881,84717,73648,181966,10488,94149,21550,26655,63436,48375,14405,165650,9621,24439,28043,42735,4490,29963,56674,45373,1934,262446,50855,67098,26898,5261,52696,40644,33900,9440,180286,87162,22940,19704,26936,69769,10254,101759,27406,12243,48e3,73926,113215,54935,5726,192787,4312,106216,9366,11550,52949,23457,212271,277152,133895,108374,6191,96477,29980,218916,58024,54696,40853,91124,65894,91170,65908,252552,6793,29212,15389,44516,122515,52617,35058,9017,103536,39510,49136,19242,130652,662077,74699,47024,31422,8517,73351,24399,13867,128360,4810,4434,61779,111983,61036,17798,110240,59722,102960,39688,10001,23803,23039,176498,56659,44814,134295,17188,77577,74466,226175,102472,154333,63900,111747,18062,41171,79669,32773,408933,42562,28931,30907,107388,43487,2946,240310,23938,24354,319,184983,7927,6488,1422,10790,68809,68209,64775,4361,202,17123,59634,51200,44391,18188,17843,2619,74278,3230,9540,47187,21702,36274,56894,43907,16310,34790,16866,6150,5561,13587,107545,108873,126867,86986,28640,33427,19017,5762,80637,17430,46903,2047,131055,25958,13558,5444,47152,13900,44563,122857,45348,70863,39593,54332,38068,33637,318,40310,143467,18502,24520,11377,62013,28942,27246,28269,83545,17999,59015,90707,30065,15161,34720,1263,37008,2012,6060,98575,92933,5721,299,199555,24578,29223,2985,743,115825,109523,136657,47454,26378,53586,3733,174945,93340,244456,5693,37386,28782,89767,27545,23573,18798,136425,34320,84778,20041,48453,38215,7477,71958,40621,8773,5874,187927,105965,51100,43533,18083,8443,10180,43597,2003,183999,69689,12216,129696,146188,62389,34044,68410,12765,43273,26949,266807,3345,34477,79197,5688,47539,213110,21634,22257,50092,32222,42346,39530,63668,98,134978,74022,5152,59088,174145,37220,9934,9545,118937,5724,87240,19875,15784,40143,23263,87513,181654,285152,37881,263241,4966,43934,10433,186657,6470,74416,225854,25908,142677,246262,32280,6192,75890,45546,143264,135305,29742,47013,77787,11732,126658,8763,37950,21806,57557,113464,89465,108995,164574,23894,22996,23169,15369,23117,17642,130607,40503,36239,280990,44666,9981,40427,147487,26869,168452,32886,32991,46798,240839,15111,70502,65697,88548,44145,28701,48767,31139,206777,35659,181164,166262,14554,171445,31786,66523,76607,17956,6507,31279,90476,116611,167918,6560,1243,115324,80128,41867,55897,187323,37069,32596,189444,145931,13390,105530,65709,26805,6999,55714,41300,22915,68951,22138,21120,22264,10058,19945,33635,56123,99085,10032,5818,6016,46649,57476,35264,94413,112522,262288,93686,83038,14341,23204,28807,66084,77987,6101,126673,7133,38126,5923,122091,170240,97772,46874,215746,43948,41622,3272,55596,8332,146411,251315,13533,8561,81521,115449,48616,175175,2063,186556,3036,134537,75772,29728,82360,22973,186559,86348,89100,38388,82297,45610,2613,87082,9986,177812,57884,23591,47485,42543,33582,44713,74439,257444,252451,31825,35631,38540,33066,5147,13973,4343,51830,70378,22827,26448,95560,36896,241741,48067,203953,298860,61620,20450,3220,67272,6586,107662,100160,108684,6929,57226,4762,7457,1320,40404,77204,99309,62750,208653,59977,44e3,74315,34332,5819,172217,64904,114077,18147,84012,1791,98456,90930,21446,116669,103938,7422,85140,59713,5768,326211,16239,75411,13229,29398,10758,236107,1539,112472,95979,152154,151294,306,21196,38146,10700,6891,84282,109646,56492,40539,6589,119491,51354,30685,140209,136906,29622,73617,49553,70525,51671,166869,139616,74395,37439,49595,45678,11959,33211,86560,52434,9282,62690,112155,130810,5243,108261,99970,265613,72551,80049,6391,33365,90721,66737,69872,87011,1860,9032,112544,60905,37371,89015,140351,19076,850,373531,2802,36725,218795,72062,28990,16550,24614,7815,6187,26336,33373,32162,42791,73555,32062,23386,10244,56392,49442,27076,136262,12412,14883,1134,33675,97153,199281,15608,100152,74072,47942,254301,36451,16026,10687,65067,56708,254030,30290,50490,13864,57941,259331,35588,23485,43486,24869,21620,92971,22072,88645,1048,182050,13343,32452,14825,19509,3325,216938,45740,99716,189082,53740,78245,25609,24311,176777,47340,308354,40669,66085,14102,125339,9225,128709,97207,1271,200933,78439,113451,88975,18324,46521,11819,18570,141756,72512,170020,52754,63550,118515,103073,93330,32736,50499,14722,31600,68452,398867,29316,172786,18417,104924,2606,5670,84818,16288,67106,59580,82929,607401,291,85829,359,15897,35830,50696,65630,52672,22115,356968,29895,40837,231192,34024,38957,26722,406,23335,124952,72068,68804,13268,147101,164740,276569,162596,66943,11569,26654,66358,4777,23229,102127,5848,978,2921,59666,5371,28212,90108,42938,39320,2499,4271,108792,33510,125072,71653,65239,38250,66357,38577,13964,86251,35708,50755,36010,29448,12209,3844,38222,206337,100876,67827,137088,14167,252225,84163,195270,1306,5703,54198,779,46802,22028,51124,86759,70560,113164,35685,162145,45471,34561,422,2611,6464,47486,19223,38246,9191,18331,89942,243642,212364,15893,17518,22617,6409,30046,126182,59716,36560,104428,18846,26592,19458,50793,147333,30826,1388,27647,10922,14495,33545,19269,135828,39727,41601,46931,233379,49169,131130,182112,16276,82381,118209,142445,128310,19672,28740,82907,33436,3118,102206,28723,24819,41937,38854,5157,3881,111491,1142,9776,421673,152241,29309,14961,87854,6054,15424,3796,82656,54996,2108,55367,239450,154525,9643,118103,106041,64601,68549,48707,30266,25772,18740,9462,229669,91798,112152,191327,14493,72828,8175,66636,236474,25817,87351,129027,76653,20422,22983,71240,27846,44661,12399,46158,77704,53101,35032,11072,17300,109294,33638,24408,1895,11241,760,17584,82479,125877,63150,141075,34259,23274,81698,15732,43577,48340,91584,14688,16379,24481,150280,96420,262050,48635,43727,61819,56268,72003,88178,17281,79912,13218,122519,125295,166396,11811,2171,118930,67746,17636,178278,174656,95661,173039,83845,79689,17473,98555,127696,203415,54730,22925,232239,9309,12136,175026,20740,180188,10747,39816,314017,266131,10040,175732,112550,220651,31974,37393,888,23008,86799,4303,64905,148467,75337,251,3284,370102,50264,9835,5438,23655,4481,29851,329,12855,7162,64931,78141,12804,42372,296771,83547,18624,34874,86271,3360,48665,77735,88767,11463,63527,28889,22258,29140,194315,113924,25499,6406,31334,1845,4802,49184,43455,35469,127594,92970,61038,115005,38840,87761,106838,8811,20572,55637,11162,96721,132425,108925,2948,125457,36356,3502,75270,27622,127192,2561,123095,49394,61155,16897,110064,9699,89448,53356,19628,220310,21622,83036,9885,112214,6087,26713,17901,161912,91492,3440,68594,9266,92238,8087,6866,150194,72175,80701,13459,31836,43243,239700,95846,44749,50647,21945,230538,120612,132371,244604,5193,105637,34661,41341,68775,85393,1874,8771,33718,49672,77403,595452,99507,6490,58895,128742,7704,39239,73217,43816,62824,37804,199976,22361,80005,87514,94832,14089,4574,139975,59142,75523,100268,43906,53442,15152,2547,186002,17011,19513,204282,3343,60568,128318,119250,4298,51871,41336,71759,21921,45074,98169,145889,99427,11350,1237,5520,28799,7803,53702,21026,136352,38293,128690,12158,90132,44600,10184,26957,39459,126025,78904,82999,59373,39301,150198,120529,153042,20177,50089,14764,271571,30530,123161,38975,101562,22941,5648,124654,109243,69817,71675,49162,106884,21241,107795,30258,16572,188262,141456,7688,60718,8271,11044,32440,104608,103419,236109,93156,43293,128929,42107,67180,25201,115254,185488,130954,72813,167547,20537,39969,38432,22582,184022,1139,27199,5655,17767,97412,122606,209377,27070,35871,326617,188954,42680,73512,80911,22629,3011,95021,315242,157737,383,41821,41808,19335,27950,15674,25677,110950,35375,76835,59108,57370,35262,16569,160415,37706,78086,32041,49691,137143,9782,172080,50148,77917,6323,10110,69172,17711,21795,59511,76184,135114,31046,132319,59105,157578,20549,80778,57649,158421,65143,4575,72235,21899,10797,92745,34035,106079,80159,4508,78304,25350,75457,46458,32937,25623,47,8531,104751,84953,8138,36508,187199,66310,115274,13253,32461,38536,1916,42007,187160,35055,26325,84394,35963,94216,45590,97782],Rw=n(95918);class Sw{constructor(t){const{peerRouting:e,routingTable:n,refreshInterval:r,refreshQueryTimeout:s,lan:o}=t;this.log=(0,i.kg)(`libp2p:kad-dht:${o?"lan":"wan"}:routing-table:refresh`),this.peerRouting=e,this.routingTable=n,this.refreshInterval=r??dw,this.refreshQueryTimeout=s??hw,this.commonPrefixLengthRefreshedAt=[],this.refreshTable=this.refreshTable.bind(this)}async start(){this.log(`refreshing routing table every ${this.refreshInterval}ms`),this.refreshTable(!0)}async stop(){null!=this.refreshTimeoutId&&clearTimeout(this.refreshTimeoutId)}refreshTable(t=!1){this.log("refreshing routing table");const e=this._maxCommonPrefix(),n=this._getTrackedCommonPrefixLengthsForRefresh(e);this.log(`max common prefix length ${e}`),this.log(`tracked CPLs [ ${n.map((t=>t.toISOString())).join(", ")} ]`),Promise.all(n.map((async(r,s)=>{try{if(await this._refreshCommonPrefixLength(s,r,t),0===this._numPeersForCpl(e)){const e=Math.min(2*(s+1),n.length-1);for(let n=s+1;n<e+1;n++)try{await this._refreshCommonPrefixLength(n,r,t)}catch(t){this.log.error(t)}}}catch(t){this.log.error(t)}}))).catch((t=>{this.log.error(t)})).then((()=>{this.refreshTimeoutId=setTimeout(this.refreshTable,this.refreshInterval),null!=this.refreshTimeoutId.unref&&this.refreshTimeoutId.unref()})).catch((t=>{this.log.error(t)}))}async _refreshCommonPrefixLength(t,e,n){if(!n&&e.getTime()>Date.now()-this.refreshInterval)return void this.log("not running refresh for cpl %s as time since last refresh not above interval",t);const r=await this._generateRandomPeerId(t);this.log("starting refreshing cpl %s with key %p (routing table size was %s)",t,r,this.routingTable.size);const s=new B.TimeoutController(this.refreshQueryTimeout);try{const e=await(0,Rw.Z)(this.peerRouting.getClosestPeers(r.toBytes(),{signal:s.signal}));this.log(`found ${e} peers that were close to imaginary peer %p`,r),this.log("finished refreshing cpl %s with key %p (routing table size is now %s)",t,r,this.routingTable.size)}finally{s.clear()}}_getTrackedCommonPrefixLengthsForRefresh(t){t>15&&(t=15);const e=[];for(let n=0;n<=t;n++)e[n]=this.commonPrefixLengthRefreshedAt[n]??new Date;return e}async _generateRandomPeerId(t){if(null==this.routingTable.kb)throw new Error("Routing table not started");const e=(0,ry.O6)(2),n=(e[1]<<8)+e[0],r=await this._makePeerId(this.routingTable.kb.localNodeId,n,t);return(0,Ne.cv)(r)}async _makePeerId(t,e,n){if(n>15)throw new Error("Cannot generate peer ID for common prefix length greater than 15");const r=new DataView(t.buffer,t.byteOffset,t.byteLength).getUint16(0,!1),s=65535<<16-(n+1),o=kw[(r^32768>>n)&s|e&~s],i=new ArrayBuffer(34),a=new DataView(i,0,i.byteLength);return a.setUint8(0,Qs.sha256.code),a.setUint8(1,32),a.setUint32(2,o,!1),new Uint8Array(a.buffer,a.byteOffset,a.byteLength)}_maxCommonPrefix(){let t=0;for(const e of this._prefixLengths())e>t&&(t=e);return t}_numPeersForCpl(t){let e=0;for(const n of this._prefixLengths())n===t&&e++;return e}*_prefixLengths(){if(null!=this.routingTable.kb)for(const{id:t}of this.routingTable.kb.toIterable()){const e=(0,vw.d)(this.routingTable.kb.localNodeId,t);let n=0;for(const t of e){if(0!==t)break;n++}yield n}}}Yp._configure(),qp._configure(Gp),Wp._configure(Zp);const Tw=["uint64","int64","sint64","fixed64","sfixed64"];function Aw(t){return function(t){for(const e of Tw){if(null==t[e])continue;const n=t[e];t[e]=function(){return BigInt(n.call(this).toString())}}return t}(new qp(t))}function Iw(){return function(t){for(const e of Tw){if(null==t[e])continue;const n=t[e];t[e]=function(t){return n.call(this,t.toString())}}return t}(Wp.create())}function Dw(t,e){const n=Aw(t instanceof Uint8Array?t:t.subarray());return e.decode(n)}function Pw(t,e){const n=Iw();return e.encode(t,n,{lengthDelimited:!1}),n.finish()}var Nw,Ow,Lw;function Cw(t,e,n,r){return{name:t,type:e,encode:n,decode:r}}function Mw(t){function e(e){if(null==t[e.toString()])throw new Error("Invalid enum value");return t[e]}return Cw("enum",Nw.VARINT,(function(t,n){const r=e(t);n.int32(r)}),(function(t){return e(t.int32())}))}function xw(t,e){return Cw("message",Nw.LENGTH_DELIMITED,t,e)}!function(t){t[t.VARINT=0]="VARINT",t[t.BIT64=1]="BIT64",t[t.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",t[t.START_GROUP=3]="START_GROUP",t[t.END_GROUP=4]="END_GROUP",t[t.BIT32=5]="BIT32"}(Nw||(Nw={})),function(t){let e;t.codec=()=>(null==e&&(e=xw(((t,e,n={})=>{!1!==n.lengthDelimited&&e.fork(),null!=t.key&&(e.uint32(10),e.bytes(t.key)),null!=t.value&&(e.uint32(18),e.bytes(t.value)),null!=t.author&&(e.uint32(26),e.bytes(t.author)),null!=t.signature&&(e.uint32(34),e.bytes(t.signature)),null!=t.timeReceived&&(e.uint32(42),e.string(t.timeReceived)),!1!==n.lengthDelimited&&e.ldelim()}),((t,e)=>{const n={},r=null==e?t.len:t.pos+e;for(;t.pos<r;){const e=t.uint32();switch(e>>>3){case 1:n.key=t.bytes();break;case 2:n.value=t.bytes();break;case 3:n.author=t.bytes();break;case 4:n.signature=t.bytes();break;case 5:n.timeReceived=t.string();break;default:t.skipType(7&e)}}return n}))),e),t.encode=e=>Pw(e,t.codec()),t.decode=e=>Dw(e,t.codec())}(Ow||(Ow={})),function(t){let e,n,r,s,o,i;!function(t){t.PUT_VALUE="PUT_VALUE",t.GET_VALUE="GET_VALUE",t.ADD_PROVIDER="ADD_PROVIDER",t.GET_PROVIDERS="GET_PROVIDERS",t.FIND_NODE="FIND_NODE",t.PING="PING"}(e=t.MessageType||(t.MessageType={})),function(t){t[t.PUT_VALUE=0]="PUT_VALUE",t[t.GET_VALUE=1]="GET_VALUE",t[t.ADD_PROVIDER=2]="ADD_PROVIDER",t[t.GET_PROVIDERS=3]="GET_PROVIDERS",t[t.FIND_NODE=4]="FIND_NODE",t[t.PING=5]="PING"}(n||(n={})),function(t){t.codec=()=>Mw(n)}(e=t.MessageType||(t.MessageType={})),function(t){t.NOT_CONNECTED="NOT_CONNECTED",t.CONNECTED="CONNECTED",t.CAN_CONNECT="CAN_CONNECT",t.CANNOT_CONNECT="CANNOT_CONNECT"}(r=t.ConnectionType||(t.ConnectionType={})),function(t){t[t.NOT_CONNECTED=0]="NOT_CONNECTED",t[t.CONNECTED=1]="CONNECTED",t[t.CAN_CONNECT=2]="CAN_CONNECT",t[t.CANNOT_CONNECT=3]="CANNOT_CONNECT"}(s||(s={})),function(t){t.codec=()=>Mw(s)}(r=t.ConnectionType||(t.ConnectionType={})),function(e){let n;e.codec=()=>(null==n&&(n=xw(((e,n,r={})=>{if(!1!==r.lengthDelimited&&n.fork(),null!=e.id&&(n.uint32(10),n.bytes(e.id)),null!=e.addrs)for(const t of e.addrs)n.uint32(18),n.bytes(t);null!=e.connection&&(n.uint32(24),t.ConnectionType.codec().encode(e.connection,n)),!1!==r.lengthDelimited&&n.ldelim()}),((e,n)=>{const r={addrs:[]},s=null==n?e.len:e.pos+n;for(;e.pos<s;){const n=e.uint32();switch(n>>>3){case 1:r.id=e.bytes();break;case 2:r.addrs.push(e.bytes());break;case 3:r.connection=t.ConnectionType.codec().decode(e);break;default:e.skipType(7&n)}}return r}))),n),e.encode=t=>Pw(t,e.codec()),e.decode=t=>Dw(t,e.codec())}(o=t.Peer||(t.Peer={})),t.codec=()=>(null==i&&(i=xw(((e,n,r={})=>{if(!1!==r.lengthDelimited&&n.fork(),null!=e.type&&(n.uint32(8),t.MessageType.codec().encode(e.type,n)),null!=e.clusterLevelRaw&&(n.uint32(80),n.int32(e.clusterLevelRaw)),null!=e.key&&(n.uint32(18),n.bytes(e.key)),null!=e.record&&(n.uint32(26),n.bytes(e.record)),null!=e.closerPeers)for(const r of e.closerPeers)n.uint32(66),t.Peer.codec().encode(r,n);if(null!=e.providerPeers)for(const r of e.providerPeers)n.uint32(74),t.Peer.codec().encode(r,n);!1!==r.lengthDelimited&&n.ldelim()}),((e,n)=>{const r={closerPeers:[],providerPeers:[]},s=null==n?e.len:e.pos+n;for(;e.pos<s;){const n=e.uint32();switch(n>>>3){case 1:r.type=t.MessageType.codec().decode(e);break;case 10:r.clusterLevelRaw=e.int32();break;case 2:r.key=e.bytes();break;case 3:r.record=e.bytes();break;case 8:r.closerPeers.push(t.Peer.codec().decode(e,e.uint32()));break;case 9:r.providerPeers.push(t.Peer.codec().decode(e,e.uint32()));break;default:e.skipType(7&n)}}return r}))),i),t.encode=e=>Pw(e,t.codec()),t.decode=e=>Dw(e,t.codec())}(Lw||(Lw={}));const Bw=Lw.MessageType,zw=Lw.ConnectionType,Uw=Object.keys(Bw);class jw{constructor(t,e,n){if(!(e instanceof Uint8Array))throw new Error("Key must be a Uint8Array");this.type=t,this.key=e,this.clusterLevelRaw=n,this.closerPeers=[],this.providerPeers=[],this.record=void 0}get clusterLevel(){const t=this.clusterLevelRaw-1;return t<0?0:t}set clusterLevel(t){this.clusterLevelRaw=t}serialize(){return Lw.encode({key:this.key,type:this.type,clusterLevelRaw:this.clusterLevelRaw,closerPeers:this.closerPeers.map($w),providerPeers:this.providerPeers.map($w),record:null==this.record?void 0:this.record.serialize().subarray()})}static deserialize(t){const e=Lw.decode(t),n=new jw(e.type??Lw.MessageType.PUT_VALUE,e.key??Uint8Array.from([]),e.clusterLevelRaw??0);return n.closerPeers=e.closerPeers.map(Vw),n.providerPeers=e.providerPeers.map(Vw),null!=e.record?.length&&(n.record=qn.Y.deserialize(e.record)),n}}function $w(t){return{id:t.id.toBytes(),addrs:(t.multiaddrs??[]).map((t=>t.bytes)),connection:zw.CONNECTED}}function Vw(t){if(null==t.id)throw new Error("Invalid peer in message");return{id:(0,Ne.cv)(t.id),multiaddrs:(t.addrs??[]).map((t=>(0,$.HM)(t))),protocols:[]}}function Hw(t){return{...t,name:"SENDING_QUERY",type:0,messageName:t.type,messageType:Uw.indexOf(t.type.toString())}}function Fw(t){return{...t,name:"PEER_RESPONSE",type:1,messageName:t.messageType,closer:null!=t.closer?t.closer:[],providers:null!=t.providers?t.providers:[]}}function Kw(t){return{...t,name:"FINAL_PEER",type:2}}function qw(t){return{...t,name:"QUERY_ERROR",type:3}}function Gw(t){return{...t,name:"PROVIDER",type:4}}function Ww(t){return{...t,name:"VALUE",type:5}}function Zw(t){return{...t,name:"DIALING_PEER",type:7}}class Yw extends pp.v{constructor(t,e){super();const{protocol:n,lan:r}=e;this.components=t,this.log=(0,i.kg)(`libp2p:kad-dht:${r?"lan":"wan"}:network`),this.running=!1,this.protocol=n}async start(){this.running||(this.running=!0)}async stop(){this.running=!1}isStarted(){return this.running}async*sendRequest(t,e,n={}){if(!this.running)return;this.log("sending %s to %p",e.type,t),yield Zw({peer:t}),yield Hw({to:t,type:e.type});try{const r=await this.components.connectionManager.openConnection(t,n),s=await r.newStream(this.protocol,n),o=await this._writeReadMessage(s,e.serialize(),n);yield Fw({from:t,messageType:o.type,closer:o.closerPeers,providers:o.providerPeers,record:o.record})}catch(e){yield qw({from:t,error:e})}finally{0}}async*sendMessage(t,e,n={}){if(!this.running)return;this.log("sending %s to %p",e.type,t),yield Zw({peer:t}),yield Hw({to:t,type:e.type});try{const r=await this.components.connectionManager.openConnection(t,n),s=await r.newStream(this.protocol,n);await this._writeMessage(s,e.serialize(),n),yield Fw({from:t,messageType:e.type})}catch(e){yield qw({from:t,error:e})}finally{0}}async _writeMessage(t,e,n){null!=n.signal&&(t=(0,zf.D7)(t,n.signal)),await Gs([e],Sf(),t,Cn.Z)}async _writeReadMessage(t,e,n){null!=n.signal&&(t=(0,zf.D7)(t,n.signal));const r=await Gs([e],Sf(),t,Pf(),(async t=>{const e=await(0,ka.Z)(t);if(null!=e)return e;throw new cg.s("No message received","ERR_NO_MESSAGE_RECEIVED")})),s=jw.deserialize(r);return s.closerPeers.forEach((t=>{this.dispatchEvent(new pp.A("peer",{detail:t}))})),s.providerPeers.forEach((t=>{this.dispatchEvent(new pp.A("peer",{detail:t}))})),s}}var Jw=n(69256),Qw=n(90153);class Xw{constructor(t,e){const{validators:n,selectors:r,peerRouting:s,queryManager:o,routingTable:a,network:c,lan:l}=e;this.components=t,this.log=(0,i.kg)(`libp2p:kad-dht:${l?"lan":"wan"}:content-fetching`),this.validators=n,this.selectors=r,this.peerRouting=s,this.queryManager=o,this.routingTable=a,this.network=c}async putLocal(t,e){const n=bw(t);await this.components.datastore.put(n,e)}async getLocal(t){this.log("getLocal %b",t);const e=bw(t);this.log("fetching record for key %k",e);const n=await this.components.datastore.get(e);this.log("found %k in local datastore",e);const r=qn.Y.deserialize(n);return await(0,Jw.c)(this.validators,r),r}async*sendCorrectionRecord(t,e,n,r={}){this.log("sendCorrection for %b",t);const s=Ew(t,n);for(const{value:o,from:i}of e){if((0,vt.f)(o,n)){this.log("record was ok");continue}if(this.components.peerId.equals(i)){try{const e=bw(t);this.log(`Storing corrected record for key ${e.toString()}`),await this.components.datastore.put(e,s.subarray())}catch(t){this.log.error("Failed error correcting self",t)}continue}let e=!1;const a=new jw(Bw.PUT_VALUE,t,0);a.record=qn.Y.deserialize(s);for await(const t of this.network.sendRequest(i,a,r))"PEER_RESPONSE"===t.name&&null!=t.record&&(0,vt.f)(t.record.value,qn.Y.deserialize(s).value)&&(e=!0),yield t;e||(yield qw({from:i,error:new cg.s("value not put correctly","ERR_PUT_VALUE_INVALID")})),this.log.error("Failed error correcting entry")}}async*put(t,e,n={}){this.log("put key %b value %b",t,e);const r=Ew(t,e),s=bw(t);this.log(`storing record for key ${s.toString()}`),await this.components.datastore.put(s,r.subarray()),yield*Gs(this.peerRouting.getClosestPeers(t,{signal:n.signal}),(e=>(0,$s.Z)(e,(e=>async()=>{if("FINAL_PEER"!==e.name)return[e];const s=[],o=new jw(Bw.PUT_VALUE,t,0);o.record=qn.Y.deserialize(r),this.log("send put to %p",e.peer.id);for await(const t of this.network.sendRequest(e.peer.id,o,n))s.push(t),"PEER_RESPONSE"===t.name&&(null!=t.record&&(0,vt.f)(t.record.value,qn.Y.deserialize(r).value)||s.push(qw({from:e.peer.id,error:new cg.s("value not put correctly","ERR_PUT_VALUE_INVALID")})));return s}))),(t=>(0,js.Z)(t,{ordered:!1,concurrency:cw})),(async function*(t){for await(const e of t)yield*e}))}async*get(t,e={}){this.log("get %b",t);const n=[];for await(const r of this.getMany(t,e))"VALUE"===r.name&&n.push(r),yield r;if(0===n.length)return;const r=n.map((t=>t.value));let s=0;try{s=(0,Qw.o)(this.selectors,t,r)}catch(t){if("ERR_NO_SELECTOR_FUNCTION_FOR_RECORD_KEY"!==t.code)throw t}const o=r[s];if(this.log("GetValue %b %b",t,o),null==o)throw new cg.s("best value was not found","ERR_NOT_FOUND");yield*this.sendCorrectionRecord(t,n,o,e),yield n[s]}async*getMany(t,e={}){this.log("getMany values for %b",t);try{const e=await this.getLocal(t);yield Ww({value:e.value,from:this.components.peerId})}catch(e){this.log("error getting local value for %b",t,e)}const n=await ww(t),r=this.routingTable.closestPeers(n);this.log("found %d peers in routing table",r.length);const s=this;yield*this.queryManager.run(t,r,(async function*({peer:e,signal:n}){for await(const r of s.peerRouting.getValueOrPeers(e,t,{signal:n}))yield r,"PEER_RESPONSE"===r.name&&null!=r.record&&(yield Ww({from:e,value:r.record.value}))}),e)}}class tm{constructor(t,e){const{network:n,peerRouting:r,queryManager:s,routingTable:o,providers:a,lan:c}=e;this.components=t,this.log=(0,i.kg)(`libp2p:kad-dht:${c?"lan":"wan"}:content-routing`),this.network=n,this.peerRouting=r,this.queryManager=s,this.routingTable=o,this.providers=a}async*provide(t,e,n={}){this.log("provide %s",t),await this.providers.addProvider(t,this.components.peerId);const r=new jw(Bw.ADD_PROVIDER,t.multihash.bytes,0);r.providerPeers=[{id:this.components.peerId,multiaddrs:e,protocols:[]}];let s=0;const o=e=>async()=>{if("FINAL_PEER"!==e.name)return[e];const o=[];this.log("putProvider %s to %p",t,e.peer.id);try{this.log("sending provider record for %s to %p",t,e.peer.id);for await(const i of this.network.sendMessage(e.peer.id,r,n))"PEER_RESPONSE"===i.name&&(this.log("sent provider record for %s to %p",t,e.peer.id),s++),o.push(i)}catch(t){this.log.error("error sending provide record to peer %p",e.peer.id,t),o.push(qw({from:e.peer.id,error:t}))}return o};yield*Gs(this.peerRouting.getClosestPeers(t.multihash.bytes,n),(t=>(0,$s.Z)(t,(t=>o(t)))),(t=>(0,js.Z)(t,{ordered:!1,concurrency:cw})),(async function*(t){for await(const e of t)yield*e})),this.log("sent provider records to %d peers",s)}async*findProviders(t,e){const n=this.routingTable.kBucketSize,r=t.multihash.bytes,s=await ww(r),o=this;this.log("findProviders %c",t);const i=await this.providers.getProviders(t);if(i.length>0){const t=[];for(const e of i.slice(0,n))t.push({id:e,multiaddrs:(await this.components.peerStore.addressBook.get(e)??[]).map((t=>t.multiaddr)),protocols:[]});yield Fw({from:this.components.peerId,messageType:Bw.GET_PROVIDERS,providers:t}),yield Gw({from:this.components.peerId,providers:t})}if(i.length>=n)return;const a=async function*({peer:t,signal:e}){const n=new jw(Bw.GET_PROVIDERS,r,0);yield*o.network.sendRequest(t,n,{signal:e})},c=new Set(i.map((t=>t.toString())));for await(const o of this.queryManager.run(r,this.routingTable.closestPeers(s),a,e))if(yield o,"PEER_RESPONSE"===o.name){this.log("Found %d provider entries for %c and %d closer peers",o.providers.length,t,o.closer.length);const e=[];for(const t of o.providers)c.has(t.id.toString())||(c.add(t.id.toString()),e.push(t));if(e.length>0&&(yield Gw({from:o.from,providers:e})),c.size===n)return}}}var em=n(20295);class nm{constructor(t,e){this.originDhtKey=t,this.capacity=e,this.peerDistances=[]}get length(){return this.peerDistances.length}get peers(){return this.peerDistances.map((t=>t.peerId))}async add(t){if(null!=this.peerDistances.find((e=>e.peerId.equals(t))))return;const e=await mw(t),n={peerId:t,distance:(0,vw.d)(this.originDhtKey,e)};this.peerDistances.push(n),this.peerDistances.sort(((t,e)=>(0,em.q)(t.distance,e.distance))),this.peerDistances=this.peerDistances.slice(0,this.capacity)}async anyCloser(t){if(0===t.length)return!1;if(0===this.length)return!0;const e=await Promise.all(t.map(mw)),n=this.peerDistances[this.peerDistances.length-1].distance;for(const t of e){const e=(0,vw.d)(this.originDhtKey,t);if((0,em.q)(e,n)<0)return!0}return!1}}class rm{constructor(t,e){const{routingTable:n,network:r,validators:s,queryManager:o,lan:a}=e;this.components=t,this.routingTable=n,this.network=r,this.validators=s,this.queryManager=o,this.log=(0,i.kg)(`libp2p:kad-dht:${a?"lan":"wan"}:peer-routing`)}async findPeerLocal(t){let e;const n=await this.routingTable.find(t);if(null!=n){this.log("findPeerLocal found %p in routing table",t);try{e=await this.components.peerStore.get(n)}catch(t){if("ERR_NOT_FOUND"!==t.code)throw t}}if(null==e)try{e=await this.components.peerStore.get(t)}catch(t){if("ERR_NOT_FOUND"!==t.code)throw t}if(null!=e)return this.log("findPeerLocal found %p in peer store",t),{id:e.id,multiaddrs:e.addresses.map((t=>t.multiaddr)),protocols:[]}}async*_getValueSingle(t,e,n={}){const r=new jw(Bw.GET_VALUE,e,0);yield*this.network.sendRequest(t,r,n)}async*getPublicKeyFromNode(t,e={}){const n=function(t){return(0,tt.z)([fw,t.toBytes()])}(t);for await(const r of this._getValueSingle(t,n,e))if(yield r,"PEER_RESPONSE"===r.name&&null!=r.record){const e=await(0,Ne.y5)(ry.XP.marshalPublicKey({bytes:r.record.value}));if(!e.equals(t))throw new cg.s("public key does not match id","ERR_PUBLIC_KEY_DOES_NOT_MATCH_ID");if(null==e.publicKey)throw new cg.s("public key missing","ERR_PUBLIC_KEY_MISSING");yield Ww({from:t,value:e.publicKey})}throw new cg.s(`Node not responding with its public key: ${t.toString()}`,"ERR_INVALID_RECORD")}async*findPeer(t,e={}){this.log("findPeer %p",t);const n=await this.findPeerLocal(t);if(null!=n)return this.log("found local"),void(yield Kw({from:this.components.peerId,peer:n}));const r=await mw(t),s=this.routingTable.closestPeers(r);if(null!=s.find((e=>e.equals(t))))try{const e=await this.components.peerStore.get(t);return this.log("found in peerStore"),void(yield Kw({from:this.components.peerId,peer:{id:e.id,multiaddrs:e.addresses.map((t=>t.multiaddr)),protocols:[]}}))}catch(t){if("ERR_NOT_FOUND"!==t.code)throw t}const o=this,i=async function*({peer:e,signal:n}){const r=new jw(Bw.FIND_NODE,t.toBytes(),0);for await(const s of o.network.sendRequest(e,r,{signal:n}))if(yield s,"PEER_RESPONSE"===s.name){const e=s.closer.find((e=>e.id.equals(t)));null!=e&&(yield Kw({from:s.from,peer:e}))}};let a=!1;for await(const n of this.queryManager.run(t.toBytes(),s,i,e))"FINAL_PEER"===n.name&&(a=!0),yield n;a||(yield qw({from:this.components.peerId,error:new cg.s("Not found","ERR_NOT_FOUND")}))}async*getClosestPeers(t,e={}){this.log("getClosestPeers to %b",t);const n=await ww(t),r=this.routingTable.closestPeers(n),s=this,o=new nm(n,this.routingTable.kBucketSize);await Promise.all(r.map((async t=>{await o.add(t)})));const i=async function*({peer:e,signal:n}){s.log("closerPeersSingle %s from %p",(0,H.B)(t,"base32"),e);const r=new jw(Bw.FIND_NODE,t,0);yield*s.network.sendRequest(e,r,{signal:n})};for await(const n of this.queryManager.run(t,r,i,e))yield n,"PEER_RESPONSE"===n.name&&await Promise.all(n.closer.map((async t=>{await o.add(t.id)})));this.log("found %d peers close to %b",o.length,t);for(const t of o.peers)yield Kw({from:this.components.peerId,peer:{id:t,multiaddrs:(await this.components.peerStore.addressBook.get(t)??[]).map((t=>t.multiaddr)),protocols:[]}})}async*getValueOrPeers(t,e,n={}){for await(const r of this._getValueSingle(t,e,n)){if("PEER_RESPONSE"===r.name&&null!=r.record)try{await this._verifyRecordOnline(r.record)}catch(t){const e="invalid record received, discarded";this.log(e),yield qw({from:r.from,error:new cg.s(e,"ERR_INVALID_RECORD")});continue}yield r}}async _verifyRecordOnline(t){if(null==t.timeReceived)throw new cg.s("invalid record received","ERR_INVALID_RECORD");await(0,Jw.c)(this.validators,new qn.Y(t.key,t.value,t.timeReceived))}async getCloserPeersOffline(t,e){const n=await ww(t),r=this.routingTable.closestPeers(n),s=[];for(const t of r)if(!t.equals(e))try{const e=await this.components.peerStore.addressBook.get(t),n=await this.components.peerStore.protoBook.get(t);s.push({id:t,multiaddrs:e.map((t=>t.multiaddr)),protocols:n})}catch(t){if("ERR_NOT_FOUND"!==t.code)throw t}return s.length>0?this.log("getCloserPeersOffline found %d peer(s) closer to %b than %p",s.length,t,e):this.log("getCloserPeersOffline could not find peer closer to %b than %p",t,e),s}}const sm=(0,i.kg)("libp2p:kad-dht:providers");class om{constructor(t,e={}){const{cacheSize:n,cleanupInterval:r,provideValidity:s}=e;this.components=t,this.cleanupInterval=r??36e5,this.provideValidity=s??864e5,this.cache=In(n??256),this.syncQueue=new ki.Z({concurrency:1}),this.started=!1}isStarted(){return this.started}async start(){this.started||(this.started=!0,this.cleaner=setInterval((()=>{this._cleanup().catch((t=>{sm.error(t)}))}),this.cleanupInterval))}async stop(){this.started=!1,null!=this.cleaner&&(clearInterval(this.cleaner),this.cleaner=void 0)}async _cleanup(){await this.syncQueue.add((async()=>{const t=Date.now();let e=0,n=0;const r=new Map,s=this.components.datastore.batch(),o=this.components.datastore.query({prefix:iw});for await(const t of o)try{const{cid:o,peerId:i}=am(t.key),a=cm(t.value).getTime(),c=Date.now(),l=c-a,u=l>this.provideValidity;if(sm("comparing: %d - %d = %d > %d %s",c,a,l,this.provideValidity,u?"(expired)":""),u){n++,s.delete(t.key);const e=r.get(o)??new Set;e.add(i),r.set(o,e)}e++}catch(t){sm.error(t.message)}r.size>0?(sm("deleting %d / %d entries",n,e),await s.commit()):sm("nothing to delete");for(const[t,e]of r){const n=im(t),r=this.cache.get(n);if(null!=r){for(const t of e)r.delete(t);0===r.size?this.cache.remove(n):this.cache.set(n,r)}}sm("Cleanup successful (%dms)",Date.now()-t)}))}async _getProvidersMap(t){const e=im(t);let n=this.cache.get(e);return null==n&&(n=await async function(t,e){const n=new Map,r=t.query({prefix:im(e)});for await(const t of r){const{peerId:e}=am(t.key);n.set(e,cm(t.value))}return n}(this.components.datastore,t),this.cache.set(e,n)),n}async addProvider(t,e){await this.syncQueue.add((async()=>{sm("%p provides %s",e,t);const n=await this._getProvidersMap(t);sm("loaded %s provs",n.size);const r=new Date;n.set(e.toString(),r);const s=im(t);this.cache.set(s,n),await async function(t,e,n,r){const s=[im(e),"/",n.toString()].join(""),o=new be.s(s),i=Uint8Array.from(Dr.encode(r.getTime()));await t.put(o,i)}(this.components.datastore,t,e,r)}))}async getProviders(t){return await this.syncQueue.add((async()=>{sm("get providers for %s",t);return[...(await this._getProvidersMap(t)).keys()].map((t=>(0,Ne.jE)(t)))}),{throwOnTimeout:!0})}}function im(t){const e="string"==typeof t?t:(0,H.B)(t.multihash.bytes,"base32");return`${iw}/${e}`}function am(t){const e=t.toString().split("/");if(5!==e.length)throw new Error(`incorrectly formatted provider entry key in datastore: ${t.toString()}`);return{cid:e[3],peerId:e[4]}}function cm(t){return new Date(Dr.decode(t))}var lm=n(85275);const um=BigInt("0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF");async function*dm(t){const{key:e,startingPeer:n,ourPeerId:r,signal:s,query:o,alpha:i,pathIndex:a,numPaths:c,cleanUp:l,queryFuncTimeout:u,log:d,peersSeen:h}=t,p=new ki.Z({concurrency:i}),f=await ww(e);!function t(n,i){if(null==n)return;h.add(n);const l=BigInt("0x"+(0,H.B)((0,vw.d)(i,f),"base16"));p.add((async()=>{let i;const y=[s];null!=u&&(i=new B.TimeoutController(u),y.push(i.signal));const g=(0,dr.anySignal)(y);try{for await(const s of o({key:e,peer:n,signal:g,pathIndex:a,numPaths:c})){if(g.aborted)return;if("PEER_RESPONSE"===s.name)for(const o of s.closer){if(h.has(o.id)){d("already seen %p in query",o.id);continue}if(r.equals(o.id)){d("not querying ourselves");continue}const s=await mw(o.id);BigInt("0x"+(0,H.B)((0,vw.d)(s,f),"base16"))>l?d("skipping %p as they are not closer to %b than %p",o.id,e,n):(d("querying closer peer %p",o.id),t(o.id,s))}p.emit("completed",s)}i?.clear()}catch(t){s.aborted?p.emit("error",t):p.emit("completed",qw({from:n,error:t}))}finally{i?.clear()}}),{priority:um-l}).catch((t=>{d.error(t)}))}(n,await mw(n)),yield*async function*(t,e,n,r){let s=(0,lm.Z)(),o=!0;const i=[],a=()=>{o&&(r("clean up queue, results %d, queue size %d, pending tasks %d",i.length,t.size,t.pending),o=!1,t.clear(),i.splice(0,i.length))};t.on("completed",(t=>{i.push(t),s.resolve()})),t.on("error",(t=>{r("queue error",t),a(),s.reject(t)})),t.on("idle",(()=>{r("queue idle"),o=!1,s.resolve()})),e.addEventListener("abort",(()=>{r("abort queue");const t=o;a(),t&&s.reject(new cg.s("Query aborted","ERR_QUERY_ABORTED"))})),n.addEventListener("cleanup",(()=>{a(),s.resolve()}));for(;o;)for(await s.promise,s=(0,lm.Z)();i.length>0;){const t=i.shift();null!=t&&(yield t)}yield*i}(p,s,l,d)}class hm{constructor(t,e){const{lan:n=!1,disjointPaths:r=aw,alpha:s=cw}=e;this.components=t,this.disjointPaths=r??aw,this.controllers=new Set,this.running=!1,this.alpha=s??cw,this.lan=n,this.queries=0}isStarted(){return this.running}async start(){this.running=!0,null!=this.components.metrics&&null==this.metrics&&(this.metrics={runningQueries:this.components.metrics.registerMetric(`libp2p_kad_dht_${this.lan?"lan":"wan"}_running_queries`),queryTime:this.components.metrics.registerMetric(`libp2p_kad_dht_${this.lan?"lan":"wan"}_query_time_seconds`)})}async stop(){this.running=!1;for(const t of this.controllers)t.abort();this.controllers.clear()}async*run(t,e,n,r={}){if(!this.running)throw new Error("QueryManager not started");const s=this.metrics?.queryTime.timer();let o;if(null==r.signal){o=new B.TimeoutController(pw),r.signal=o.signal;try{null!=Ep.setMaxListeners&&(0,Ep.setMaxListeners)(1/0,o.signal)}catch{}}const a=new AbortController;this.controllers.add(a);const c=[a.signal];null!=r.signal&&c.push(r.signal);const l=(0,dr.anySignal)(c);try{null!=Ep.setMaxListeners&&(0,Ep.setMaxListeners)(1/0,l)}catch{}const u=(0,i.kg)(`libp2p:kad-dht:${this.lan?"lan":"wan"}:query:`+(0,H.B)(t,"base58btc")),d=e.slice(0,Math.min(this.disjointPaths,e.length)),h=Date.now(),p=new pp.v;try{if(u("query:start"),this.queries++,this.metrics?.runningQueries.update(this.queries),0===e.length)return void u.error("Running query with no peers");const s=new Lp,o=d.map(((e,o)=>dm({key:t,startingPeer:e,ourPeerId:this.components.peerId,signal:l,query:n,pathIndex:o,numPaths:d.length,alpha:this.alpha,cleanUp:p,queryFuncTimeout:r.queryFuncTimeout,log:u,peersSeen:s})));for await(const t of(0,Vs.Z)(...o))yield t,"QUERY_ERROR"===t.name&&u("error",t.error)}catch(t){if(this.running||"ERR_QUERY_ABORTED"!==t.code)throw t}finally{this.controllers.delete(a),null!=o&&o.clear(),this.queries--,this.metrics?.runningQueries.update(this.queries),null!=s&&s(),p.dispatchEvent(new pp.A("cleanup")),u("query:done in %dms",Date.now()-h)}}}const pm=(0,i.kg)("libp2p:kad-dht:rpc:handlers:add-provider");class fm{constructor(t){const{providers:e}=t;this.providers=e}async handle(t,e){if(pm("start"),null==e.key||0===e.key.length)throw new cg.s("Missing key","ERR_MISSING_KEY");let n;try{n=Q.k0.decode(e.key)}catch(t){throw new cg.s("Invalid CID","ERR_INVALID_CID")}null!=e.providerPeers&&0!==e.providerPeers.length||pm.error("no providers found in message"),await Promise.all(e.providerPeers.map((async e=>{e.id.equals(t)?e.multiaddrs.length<1?pm("no valid addresses for provider %p. Ignore",t):(pm("received provider %p for %s (addrs %s)",t,n,e.multiaddrs.map((t=>t.toString()))),await this.providers.addProvider(n,e.id)):pm("invalid provider peer %p from %p",e.id,t)})))}}var ym=n(738);const gm=(0,i.kg)("libp2p:kad-dht:rpc:handlers:find-node");class wm{constructor(t,e){const{peerRouting:n,lan:r}=e;this.components=t,this.peerRouting=n,this.lan=Boolean(r)}async handle(t,e){gm("incoming request from %p for peers closer to %b",t,e.key);let n=[];n=(0,ym.fS)(this.components.peerId.toBytes(),e.key)?[{id:this.components.peerId,multiaddrs:this.components.addressManager.getAddresses().map((t=>t.decapsulateCode((0,$.a_)("p2p").code))),protocols:[]}]:await this.peerRouting.getCloserPeersOffline(e.key,t),n=n.map(this.lan?gw:yw).filter((({multiaddrs:t})=>t.length));const r=new jw(e.type,new Uint8Array(0),e.clusterLevel);return n.length>0?r.closerPeers=n:gm("could not find any peers closer to %b than %p",e.key,t),r}}const mm=(0,i.kg)("libp2p:kad-dht:rpc:handlers:get-providers");class bm{constructor(t,e){const{peerRouting:n,providers:r,lan:s}=e;this.components=t,this.peerRouting=n,this.providers=r,this.lan=Boolean(s)}async handle(t,e){let n;try{n=Q.k0.decode(e.key)}catch(t){throw new cg.s("Invalid CID","ERR_INVALID_CID")}mm("%p asking for providers for %s",t,n);const[r,s]=await Promise.all([this.providers.getProviders(n),this.peerRouting.getCloserPeersOffline(e.key,t)]),o=await this._getPeers(r),i=await this._getPeers(s.map((({id:t})=>t))),a=new jw(e.type,e.key,e.clusterLevel);return o.length>0&&(a.providerPeers=o),i.length>0&&(a.closerPeers=i),mm("got %s providers %s closerPeers",o.length,i.length),a}async _getAddresses(t){return(await this.components.peerStore.addressBook.get(t)).map((t=>t.multiaddr))}async _getPeers(t){const e=[],n=this.lan?gw:yw;for(const r of t){const t=n({id:r,multiaddrs:await this._getAddresses(r),protocols:[]});t.multiaddrs.length>0&&e.push(t)}return e}}const Em=(0,i.kg)("libp2p:kad-dht:rpc:handlers:get-value");class _m{constructor(t,e){const{peerRouting:n}=e;this.components=t,this.peerRouting=n}async handle(t,e){const n=e.key;if(Em("%p asked for key %b",t,n),null==n||0===n.length)throw new cg.s("Invalid key","ERR_INVALID_KEY");const r=new jw(Bw.GET_VALUE,n,e.clusterLevel);if(function(t){return"/pk/"===(0,H.B)(t.subarray(0,4))}(n)){Em("is public key");const t=function(t){return(0,Ne.cv)(t.subarray(4))}(n);let e;try{const n=await this.components.peerStore.keyBook.get(t);if(null==n)throw new cg.s("No public key found in key book","ERR_NOT_FOUND");e=n}catch(t){if("ERR_NOT_FOUND"!==t.code)throw t}if(null!=e)return Em("returning found public key"),r.record=new qn.Y(n,e,new Date),r}const[s,o]=await Promise.all([this._checkLocalDatastore(n),this.peerRouting.getCloserPeersOffline(e.key,t)]);return null!=s&&(Em("had record for %b in local datastore",n),r.record=s),o.length>0&&(Em("had %s closer peers in routing table",o.length),r.closerPeers=o),r}async _checkLocalDatastore(t){Em("checkLocalDatastore looking for %b",t);const e=bw(t);let n;try{n=await this.components.datastore.get(e)}catch(t){if("ERR_NOT_FOUND"===t.code)return;throw t}const r=qn.Y.deserialize(n);if(null==r)throw new cg.s("Invalid record","ERR_INVALID_RECORD");if(!(null==r.timeReceived||Date.now()-r.timeReceived.getTime()>1296e5))return r;await this.components.datastore.delete(e)}}const vm=(0,i.kg)("libp2p:kad-dht:rpc:handlers:ping");class km{async handle(t,e){return vm("ping from %p",t),e}}class Rm{constructor(t,e){const{validators:n}=e;this.components=t,this.log=(0,i.kg)("libp2p:kad-dht:rpc:handlers:put-value"),this.validators=n}async handle(t,e){const n=e.key;this.log("%p asked us to store value for key %b",t,n);const r=e.record;if(null==r){const e=`Empty record from: ${t.toString()}`;throw this.log.error(e),new cg.s(e,"ERR_EMPTY_RECORD")}try{await(0,Jw.c)(this.validators,r),r.timeReceived=new Date;const t=bw(r.key);await this.components.datastore.put(t,r.serialize().subarray()),this.log("put record for %b into datastore under key %k",n,t)}catch(t){this.log("did not put record for key %b into datastore %o",n,t)}return e}}class Sm{constructor(t,e){const{providers:n,peerRouting:r,validators:s,lan:o}=e;this.log=(0,i.kg)("libp2p:kad-dht:rpc"),this.routingTable=e.routingTable,this.handlers={[Bw.GET_VALUE]:new _m(t,{peerRouting:r}),[Bw.PUT_VALUE]:new Rm(t,{validators:s}),[Bw.FIND_NODE]:new wm(t,{peerRouting:r,lan:o}),[Bw.ADD_PROVIDER]:new fm({providers:n}),[Bw.GET_PROVIDERS]:new bm(t,{peerRouting:r,providers:n,lan:o}),[Bw.PING]:new km}}async handleMessage(t,e){try{await this.routingTable.add(t)}catch(t){this.log.error("Failed to update the kbucket store",t)}const n=this.handlers[e.type];if(null!=n)return await n.handle(t,e);this.log.error(`no handler found for message type: ${e.type}`)}onIncomingStream(t){Promise.resolve().then((async()=>{const{stream:e,connection:n}=t,r=n.remotePeer;try{await this.routingTable.add(r)}catch(t){this.log.error(t)}const s=this;await Gs(e,Pf(),(async function*(t){for await(const e of t){const t=jw.deserialize(e);s.log("incoming %s from %p",t.type,r);const n=await s.handleMessage(r,t);null!=n&&(yield n.serialize())}}),Sf(),e)})).catch((t=>{this.log.error(t)}))}}var Tm=n(55305);class Am extends pp.v{constructor(t,e){super();const{protocol:n,lan:r}=e;this.components=t,this.log=(0,i.kg)("libp2p:kad-dht:topology-listener:"+(r?"lan":"wan")),this.running=!1,this.protocol=n}isStarted(){return this.running}async start(){if(this.running)return;this.running=!0;const t=(0,Tm.a)({onConnect:t=>{this.log("observed peer %p with protocol %s",t,this.protocol),this.dispatchEvent(new pp.A("peer",{detail:t}))}});this.registrarId=await this.components.registrar.register(this.protocol,t)}async stop(){this.running=!1,null!=this.registrarId&&(this.components.registrar.unregister(this.registrarId),this.registrarId=void 0)}}class Im{constructor(t,e){const{peerRouting:n,lan:r,count:s,interval:o,queryTimeout:a}=e;this.components=t,this.log=(0,i.kg)(`libp2p:kad-dht:${r?"lan":"wan"}:query-self`),this.running=!1,this.peerRouting=n,this.count=s??aw,this.interval=o??lw,this.queryTimeout=a??uw}isStarted(){return this.running}async start(){this.running||(this.running=!0,this._querySelf())}async stop(){this.running=!1,null!=this.timeoutId&&clearTimeout(this.timeoutId),null!=this.controller&&this.controller.abort()}_querySelf(){Promise.resolve().then((async()=>{const t=new B.TimeoutController(this.queryTimeout);try{this.controller=new AbortController;const e=(0,dr.anySignal)([this.controller.signal,t.signal]);try{null!=Ep.setMaxListeners&&(0,Ep.setMaxListeners)(1/0,e)}catch{}const n=await Gs(this.peerRouting.getClosestPeers(this.components.peerId.toBytes(),{signal:e}),(t=>(0,xn.Z)(t,this.count)),(async t=>await(0,Rw.Z)(t)));this.log("query ran successfully - found %d peers",n)}catch(t){this.log("query error",t)}finally{this.timeoutId=setTimeout(this._querySelf.bind(this),this.interval),t.clear()}})).catch((t=>{this.log("query error",t)}))}}class Dm extends pp.v{constructor(t,e){super();const{kBucketSize:n,clientMode:r,validators:s,selectors:o,querySelfInterval:a,lan:c,protocolPrefix:l,pingTimeout:u,pingConcurrency:d,maxInboundStreams:h,maxOutboundStreams:p,providers:f}=e;this.running=!1,this.components=t,this.lan=Boolean(c),this.log=(0,i.kg)("libp2p:kad-dht:"+(!0===c?"lan":"wan")),this.protocol=`${l??"/ipfs"}${!0===c?"/lan":""}/kad/1.0.0`,this.kBucketSize=n??20,this.clientMode=r??!0,this.maxInboundStreams=h??32,this.maxOutboundStreams=p??64,this.routingTable=new _w(t,{kBucketSize:n,lan:this.lan,pingTimeout:u,pingConcurrency:d,protocol:this.protocol}),this.providers=new om(t,f??{}),this.validators={...Jw.z,...s},this.selectors={...Qw.w,...o},this.network=new Yw(t,{protocol:this.protocol,lan:this.lan}),this.queryManager=new hm(t,{disjointPaths:Math.ceil(this.kBucketSize/2),lan:c}),this.peerRouting=new rm(t,{routingTable:this.routingTable,network:this.network,validators:this.validators,queryManager:this.queryManager,lan:this.lan}),this.contentFetching=new Xw(t,{validators:this.validators,selectors:this.selectors,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,network:this.network,lan:this.lan}),this.contentRouting=new tm(t,{network:this.network,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,providers:this.providers,lan:this.lan}),this.routingTableRefresh=new Sw({peerRouting:this.peerRouting,routingTable:this.routingTable,lan:this.lan}),this.rpc=new Sm(t,{routingTable:this.routingTable,providers:this.providers,peerRouting:this.peerRouting,validators:this.validators,lan:this.lan}),this.topologyListener=new Am(t,{protocol:this.protocol,lan:this.lan}),this.querySelf=new Im(t,{peerRouting:this.peerRouting,interval:a,lan:this.lan}),this.network.addEventListener("peer",(t=>{const e=t.detail;this.onPeerConnect(e).catch((t=>{this.log.error("could not add %p to routing table",e.id,t)})),this.dispatchEvent(new pp.A("peer",{detail:e}))})),this.topologyListener.addEventListener("peer",(t=>{const e=t.detail;Promise.resolve().then((async()=>{const t=await this.components.peerStore.addressBook.get(e),n={id:e,multiaddrs:t.map((t=>t.multiaddr)),protocols:[]};await this.onPeerConnect(n)})).catch((t=>{this.log.error("could not add %p to routing table",e,t)}))}))}get[qg.N](){return!0}get[Symbol.toStringTag](){return"@libp2p/kad-dht"}async onPeerConnect(t){if(this.log("peer %p connected with protocols %s",t.id,t.protocols),0!==(t=this.lan?gw(t):yw(t)).multiaddrs.length)try{await this.routingTable.add(t.id)}catch(e){this.log.error("could not add %p to routing table",t.id,e)}else this.log("ignoring %p as they do not have any %s addresses in %s",t.id,this.lan?"private":"public",t.multiaddrs.map((t=>t.toString())))}isStarted(){return this.running}async getMode(){return this.clientMode?"client":"server"}async setMode(t){await this.components.registrar.unhandle(this.protocol),"client"===t?(this.log("enabling client mode"),this.clientMode=!0):(this.log("enabling server mode"),this.clientMode=!1,await this.components.registrar.handle(this.protocol,this.rpc.onIncomingStream.bind(this.rpc),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}))}async start(){this.running=!0,await this.setMode(this.clientMode?"client":"server"),await Promise.all([this.providers.start(),this.queryManager.start(),this.network.start(),this.routingTable.start(),this.topologyListener.start(),this.querySelf.start()]),await this.routingTableRefresh.start()}async stop(){this.running=!1,await Promise.all([this.providers.stop(),this.queryManager.stop(),this.network.stop(),this.routingTable.stop(),this.routingTableRefresh.stop(),this.topologyListener.stop(),this.querySelf.stop()])}async*put(t,e,n={}){yield*this.contentFetching.put(t,e,n)}async*get(t,e={}){yield*this.contentFetching.get(t,e)}async*provide(t,e={}){yield*this.contentRouting.provide(t,this.components.addressManager.getAddresses(),e)}async*findProviders(t,e={}){yield*this.contentRouting.findProviders(t,e)}async*findPeer(t,e={}){yield*this.peerRouting.findPeer(t,e)}async*getClosestPeers(t,e={}){yield*this.peerRouting.getClosestPeers(t,e)}async refreshRoutingTable(){this.routingTableRefresh.refreshTable(!0)}}const Pm=(0,i.kg)("libp2p:kad-dht");class Nm extends pp.v{constructor(t,e,n){super(),this.components=t,this.wan=e,this.lan=n,this.wan.addEventListener("peer",(t=>{this.dispatchEvent(new pp.A("peer",{detail:t.detail}))})),this.lan.addEventListener("peer",(t=>{this.dispatchEvent(new pp.A("peer",{detail:t.detail}))}))}get[qg.N](){return!0}get[Symbol.toStringTag](){return"@libp2p/dual-kad-dht"}isStarted(){return this.wan.isStarted()&&this.lan.isStarted()}async getMode(){return await this.wan.getMode()}async setMode(t){await this.wan.setMode(t)}async start(){await Promise.all([this.lan.start(),this.wan.start()])}async stop(){await Promise.all([this.lan.stop(),this.wan.stop()])}async*put(t,e,n={}){for await(const r of(0,Vs.Z)(this.lan.put(t,e,n),this.wan.put(t,e,n)))yield r}async*get(t,e={}){let n=!1,r=!1;for await(const s of(0,Vs.Z)(this.lan.get(t,e),this.wan.get(t,e)))yield s,"DIALING_PEER"===s.name&&(n=!0),"VALUE"===s.name&&(n=!0,null!=s.value&&(r=!0)),"SENDING_QUERY"===s.name&&(n=!0);if(!n)throw new cg.s("No peers found in routing table!","ERR_NO_PEERS_IN_ROUTING_TABLE");r||(yield qw({from:this.components.peerId,error:new cg.s("Not found","ERR_NOT_FOUND")}))}async*provide(t,e={}){let n=0,r=0;const s=[],o=[this.lan];"server"===await this.wan.getMode()&&o.push(this.wan);for await(const i of(0,Vs.Z)(...o.map((n=>n.provide(t,e)))))yield i,"SENDING_QUERY"===i.name&&n++,"QUERY_ERROR"===i.name&&s.push(i.error),"PEER_RESPONSE"===i.name&&"ADD_PROVIDER"===i.messageName&&(Pm("sent provider record for %s to %p",t,i.from),r++);if(0===r){if(s.length>0)throw new cg.s(`Failed to provide to ${s.length} of ${n} peers`,"ERR_PROVIDES_FAILED",{errors:s});throw new cg.s("Failed to provide - no peers found","ERR_PROVIDES_FAILED")}}async*findProviders(t,e={}){yield*(0,Vs.Z)(this.lan.findProviders(t,e),this.wan.findProviders(t,e))}async*findPeer(t,e={}){let n=!1;for await(const r of(0,Vs.Z)(this.lan.findPeer(t,e),this.wan.findPeer(t,e)))yield r,"SENDING_QUERY"!==r.name&&"FINAL_PEER"!==r.name||(n=!0);if(!n)throw new cg.s("Peer lookup failed","ERR_LOOKUP_FAILED")}async*getClosestPeers(t,e={}){yield*(0,Vs.Z)(this.lan.getClosestPeers(t,e),this.wan.getClosestPeers(t,e))}async refreshRoutingTable(){await Promise.all([this.lan.refreshRoutingTable(),this.wan.refreshRoutingTable()])}}class Om extends Nm{constructor(t,e){super(t,new Dm(t,{protocolPrefix:"/ipfs",...e,lan:!1}),new Dm(t,{protocolPrefix:"/ipfs",...e,clientMode:!1,lan:!0}))}}const Lm=V.C,Cm=V.aY,Mm=function(t){let e=0;if(t=t.toString().trim(),Lm(t)){const n=new Uint8Array(e+4);return t.split(/\./g).forEach((t=>{n[e++]=255&parseInt(t,10)})),n}if(Cm(t)){const n=t.split(":",8);let r;for(r=0;r<n.length;r++){let t;Lm(n[r])&&(t=Mm(n[r]),n[r]=(0,H.B)(t.slice(0,2),"base16")),null!=t&&++r<8&&n.splice(r,0,(0,H.B)(t.slice(2,4),"base16"))}if(""===n[0])for(;n.length<8;)n.unshift("0");else if(""===n[n.length-1])for(;n.length<8;)n.push("0");else if(n.length<8){for(r=0;r<n.length&&""!==n[r];r++);const t=[r,1];for(r=9-n.length;r>0;r--)t.push("0");n.splice.apply(n,t)}const s=new Uint8Array(e+16);for(r=0;r<n.length;r++){const t=parseInt(n[r],16);s[e++]=t>>8&255,s[e++]=255&t}return s}throw new Error("invalid ip address")},xm=function(t,e=0,n){e=~~e,n=n??t.length-e;const r=new DataView(t.buffer);if(4===n){const r=[];for(let s=0;s<n;s++)r.push(t[e+s]);return r.join(".")}if(16===n){const t=[];for(let s=0;s<n;s+=2)t.push(r.getUint16(e+s).toString(16));return t.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""},Bm=-1,zm={},Um={};function jm(t){if("number"==typeof t){if(null!=Um[t])return Um[t];throw new Error(`no protocol with code: ${t}`)}if("string"==typeof t){if(null!=zm[t])return zm[t];throw new Error(`no protocol with name: ${t}`)}throw new Error("invalid protocol id type: "+typeof t)}[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,Bm,"ip6zone"],[43,8,"ipcidr"],[53,Bm,"dns",!0],[54,Bm,"dns4",!0],[55,Bm,"dns6",!0],[56,Bm,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,Bm,"unix",!1,!0],[421,Bm,"ipfs"],[421,Bm,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,Bm,"garlic64"],[448,0,"tls"],[449,Bm,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,Bm,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[777,Bm,"memory"]].forEach((t=>{const e=function(t,e,n,r,s){return{code:t,size:e,name:n,resolvable:Boolean(r),path:Boolean(s)}}(...t);Um[e.code]=e,zm[e.name]=e}));jm("ip4"),jm("ip6"),jm("ipcidr");function $m(t,e){switch(jm(t).code){case 4:case 41:return function(t){const e=xm(t,0,t.length);if(null==e)throw new Error("ipBuff is required");if(!V.h6(e))throw new Error("invalid ip address");return e}(e);case 42:case 53:case 54:case 55:case 56:case 400:case 449:case 777:return Zm(e);case 6:case 273:case 33:case 132:return Gm(e).toString();case 421:return function(t){const e=Dr.decode(t),n=t.slice(Dr.decode.bytes);if(n.length!==e)throw new Error("inconsistent lengths");return(0,H.B)(n,"base58btc")}(e);case 444:case 445:return Ym(e);case 466:return function(t){const e=Dr.decode(t),n=t.slice(Dr.decode.bytes);if(n.length!==e)throw new Error("inconsistent lengths");return"u"+(0,H.B)(n,"base64url")}(e);default:return(0,H.B)(e,"base16")}}function Vm(t,e){switch(jm(t).code){case 4:case 41:return Km(e);case 42:case 53:case 54:case 55:case 56:case 400:case 449:case 777:return Wm(e);case 6:case 273:case 33:case 132:return qm(parseInt(e,10));case 421:return function(t){let e;e="Q"===t[0]||"1"===t[0]?j.Jx(z.base58btc.decode(`z${t}`)).bytes:Q.k0.parse(t).multihash.bytes;const n=Uint8Array.from(Dr.encode(e.length));return(0,tt.z)([n,e],n.length+e.length)}(e);case 444:return function(t){const e=t.split(":");if(2!==e.length)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(16!==e[0].length)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);const n=U.base32.decode("b"+e[0]),r=parseInt(e[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const s=qm(r);return(0,tt.z)([n,s],n.length+s.length)}(e);case 445:return function(t){const e=t.split(":");if(2!==e.length)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(56!==e[0].length)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);const n=U.base32.decode(`b${e[0]}`),r=parseInt(e[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const s=qm(r);return(0,tt.z)([n,s],n.length+s.length)}(e);case 466:return function(t){const e=Fm.decode(t),n=Uint8Array.from(Dr.encode(e.length));return(0,tt.z)([n,e],n.length+e.length)}(e);default:return(0,x.m)(e,"base16")}}const Hm=Object.values(A.gh).map((t=>t.decoder)),Fm=function(){let t=Hm[0].or(Hm[1]);return Hm.slice(2).forEach((e=>t=t.or(e))),t}();function Km(t){if(!V.h6(t))throw new Error("invalid ip address");return Mm(t)}function qm(t){const e=new ArrayBuffer(2);return new DataView(e).setUint16(0,t),new Uint8Array(e)}function Gm(t){return new DataView(t.buffer).getUint16(t.byteOffset)}function Wm(t){const e=(0,x.m)(t),n=Uint8Array.from(Dr.encode(e.length));return(0,tt.z)([n,e],n.length+e.length)}function Zm(t){const e=Dr.decode(t);if((t=t.slice(Dr.decode.bytes)).length!==e)throw new Error("inconsistent lengths");return(0,H.B)(t)}function Ym(t){const e=t.slice(0,t.length-2),n=t.slice(t.length-2);return`${(0,H.B)(e,"base32")}:${Gm(n)}`}function Jm(t){return t.map((t=>{const e=ab(t);return null!=t[1]?[e.code,$m(e.code,t[1])]:[e.code]}))}function Qm(t){return rb((0,tt.z)(t.map((t=>{const e=ab(t);let n=Uint8Array.from(Dr.encode(e.code));return t.length>1&&null!=t[1]&&(n=(0,tt.z)([n,t[1]])),n}))))}function Xm(t,e){if(t.size>0)return t.size/8;if(0===t.size)return 0;return Dr.decode(e)+(Dr.decode.bytes??0)}function tb(t){const e=[];let n=0;for(;n<t.length;){const r=Dr.decode(t,n),s=Dr.decode.bytes??0,o=Xm(jm(r),t.slice(n+s));if(0===o){e.push([r]),n+=s;continue}const i=t.slice(n+s,n+s+o);if(n+=o+s,n>t.length)throw ib("Invalid address Uint8Array: "+(0,H.B)(t,"base16"));e.push([r,i])}return e}function eb(t){return function(t){const e=[];return t.map((t=>{const n=ab(t);return e.push(n.name),t.length>1&&null!=t[1]&&e.push(t[1]),null})),ob(e.join("/"))}(Jm(tb(t)))}function nb(t){const e=function(t){const e=[],n=t.split("/").slice(1);if(1===n.length&&""===n[0])return[];for(let r=0;r<n.length;r++){const s=n[r],o=jm(s);if(0!==o.size){if(r++,r>=n.length)throw ib("invalid address: "+t);if(!0===o.path){e.push([s,ob(n.slice(r).join("/"))]);break}e.push([s,n[r]])}else e.push([s])}return e}(t=ob(t));return Qm(e.map((t=>{Array.isArray(t)||(t=[t]);const e=ab(t);return t.length>1?[e.code,Vm(e.code,t[1])]:[e.code]})))}function rb(t){const e=sb(t);if(null!=e)throw e;return Uint8Array.from(t)}function sb(t){try{tb(t)}catch(t){return t}}function ob(t){return"/"+t.trim().split("/").filter((t=>t)).join("/")}function ib(t){return new Error("Error parsing address: "+t)}function ab(t){return jm(t[0])}var cb,lb,ub,db,hb=function(t,e,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!r:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(t):r?r.value:e.get(t)},pb=function(t,e,n,r,s){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!s:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?s.call(t,n):s?s.value=n:e.set(t,n),n};const fb=Symbol.for("nodejs.util.inspect.custom"),yb=[jm("dns").code,jm("dns4").code,jm("dns6").code,jm("dnsaddr").code],gb=new Map,wb=Symbol.for("@multiformats/js-multiaddr/multiaddr");function mb(t){return Boolean(t?.[wb])}class bb{constructor(t){if(cb.set(this,void 0),lb.set(this,void 0),ub.set(this,void 0),this[db]=!0,null==t&&(t=""),t instanceof Uint8Array)this.bytes=rb(t);else if("string"==typeof t){if(t.length>0&&"/"!==t.charAt(0))throw new Error(`multiaddr "${t}" must start with a "/"`);this.bytes=nb(t)}else{if(!mb(t))throw new Error("addr must be a string, Buffer, or another Multiaddr");this.bytes=rb(t.bytes)}}toString(){return null==hb(this,cb,"f")&&pb(this,cb,eb(this.bytes),"f"),hb(this,cb,"f")}toJSON(){return this.toString()}toOptions(){let t,e,n,r,s="";const o=jm("tcp"),i=jm("udp"),a=jm("ip4"),c=jm("ip6"),l=jm("dns6"),u=jm("ip6zone");for(const[d,h]of this.stringTuples())d===u.code&&(s=`%${h??""}`),yb.includes(d)&&(e=o.name,r=443,n=`${h??""}${s}`,t=d===l.code?6:4),d!==o.code&&d!==i.code||(e=jm(d).name,r=parseInt(h??"")),d!==a.code&&d!==c.code||(e=jm(d).name,n=`${h??""}${s}`,t=d===c.code?6:4);if(null==t||null==e||null==n||null==r)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:t,host:n,transport:e,port:r}}protos(){return this.protoCodes().map((t=>Object.assign({},jm(t))))}protoCodes(){const t=[],e=this.bytes;let n=0;for(;n<e.length;){const r=Dr.decode(e,n),s=Dr.decode.bytes??0;n+=Xm(jm(r),e.slice(n+s))+s,t.push(r)}return t}protoNames(){return this.protos().map((t=>t.name))}tuples(){return null==hb(this,lb,"f")&&pb(this,lb,tb(this.bytes),"f"),hb(this,lb,"f")}stringTuples(){return null==hb(this,ub,"f")&&pb(this,ub,Jm(this.tuples()),"f"),hb(this,ub,"f")}encapsulate(t){return t=new bb(t),new bb(this.toString()+t.toString())}decapsulate(t){const e=t.toString(),n=this.toString(),r=n.lastIndexOf(e);if(r<0)throw new Error(`Address ${this.toString()} does not contain subaddress: ${t.toString()}`);return new bb(n.slice(0,r))}decapsulateCode(t){const e=this.tuples();for(let n=e.length-1;n>=0;n--)if(e[n][0]===t)return new bb(Qm(e.slice(0,n)));return this}getPeerId(){try{const t=this.stringTuples().filter((t=>t[0]===zm.ipfs.code)),e=t.pop();if(null!=e?.[1]){const t=e[1];return"Q"===t[0]||"1"===t[0]?(0,H.B)(z.base58btc.decode(`z${t}`),"base58btc"):(0,H.B)(Q.k0.parse(t).multihash.bytes,"base58btc")}return null}catch(t){return null}}getPath(){let t=null;try{t=this.stringTuples().filter((t=>!0===jm(t[0]).path))[0][1],null==t&&(t=null)}catch{t=null}return t}equals(t){return(0,vt.f)(this.bytes,t.bytes)}async resolve(t){const e=this.protos().find((t=>t.resolvable));if(null==e)return[this];const n=gb.get(e.name);if(null==n)throw a(new Error(`no available resolver for ${e.name}`),"ERR_NO_AVAILABLE_RESOLVER");return(await n(this,t)).map((t=>new bb(t)))}nodeAddress(){const t=this.toOptions();if("tcp"!==t.transport&&"udp"!==t.transport)throw new Error(`multiaddr must have a valid format - no protocol with name: "${t.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:t.family,address:t.host,port:t.port}}isThinWaistAddress(t){const e=(t??this).protos();return 2===e.length&&((4===e[0].code||41===e[0].code)&&(6===e[1].code||273===e[1].code))}[(cb=new WeakMap,lb=new WeakMap,ub=new WeakMap,db=wb,fb)](){return`Multiaddr(${eb(this.bytes)})`}}function Eb(t){return new bb(t)}const _b=Gb("dns4"),vb=Gb("dns6"),kb=Gb("dnsaddr"),Rb=qb(Gb("dns"),kb,_b,vb),Sb=qb(Gb("ip4"),Gb("ip6")),Tb=qb(Kb(Sb,Gb("tcp")),Kb(Rb,Gb("tcp"))),Ab=Kb(Sb,Gb("udp")),Ib=Kb(Ab,Gb("utp")),Db=Kb(Ab,Gb("quic")),Pb=qb(Kb(Tb,Gb("ws")),Kb(Rb,Gb("ws"))),Nb=qb(Kb(Tb,Gb("wss")),Kb(Rb,Gb("wss")),Kb(Tb,Gb("tls"),Gb("ws")),Kb(Rb,Gb("tls"),Gb("ws"))),Ob=qb(Kb(Tb,Gb("http")),Kb(Sb,Gb("http")),Kb(Rb,Gb("http"))),Lb=qb(Kb(Tb,Gb("https")),Kb(Sb,Gb("https")),Kb(Rb,Gb("https"))),Cb=Kb(Ab,Gb("webrtc-direct"),Gb("certhash")),Mb=qb(Kb(Cb,Gb("p2p")),Cb),xb=qb(Kb(Pb,Gb("p2p-webrtc-star"),Gb("p2p")),Kb(Nb,Gb("p2p-webrtc-star"),Gb("p2p")),Kb(Pb,Gb("p2p-webrtc-star")),Kb(Nb,Gb("p2p-webrtc-star"))),Bb=(qb(Kb(Pb,Gb("p2p-websocket-star"),Gb("p2p")),Kb(Nb,Gb("p2p-websocket-star"),Gb("p2p")),Kb(Pb,Gb("p2p-websocket-star")),Kb(Nb,Gb("p2p-websocket-star"))),qb(Kb(Ob,Gb("p2p-webrtc-direct"),Gb("p2p")),Kb(Lb,Gb("p2p-webrtc-direct"),Gb("p2p")),Kb(Ob,Gb("p2p-webrtc-direct")),Kb(Lb,Gb("p2p-webrtc-direct")))),zb=qb(Pb,Nb,Ob,Lb,xb,Bb,Tb,Ib,Db,Rb,Mb),Ub=(qb(Kb(zb,Gb("p2p-stardust"),Gb("p2p")),Kb(zb,Gb("p2p-stardust"))),qb(Kb(zb,Gb("p2p")),xb,Bb,Mb,Gb("p2p"))),jb=qb(Kb(Ub,Gb("p2p-circuit"),Ub),Kb(Ub,Gb("p2p-circuit")),Kb(Gb("p2p-circuit"),Ub),Kb(zb,Gb("p2p-circuit")),Kb(Gb("p2p-circuit"),zb),Gb("p2p-circuit")),$b=()=>qb(Kb(jb,$b),jb),Vb=$b(),Hb=qb(Kb(Vb,Ub,Vb),Kb(Ub,Vb),Kb(Vb,Ub),Vb,Ub);qb(Kb(Vb,Gb("webrtc")),Kb(zb,Gb("webrtc")),Gb("webrtc"));function Fb(t){return function(e){let n;try{n=Eb(e)}catch(t){return!1}const r=t(n.protoNames());return null!==r&&(!0===r||!1===r?r:0===r.length)}}function Kb(...t){function e(e){if(e.length<t.length)return null;let n=e;return t.some((t=>(n="function"==typeof t?t().partialMatch(e):t.partialMatch(e),Array.isArray(n)&&(e=n),null===n))),n}return{toString:function(){return"{ "+t.join(" ")+" }"},input:t,matches:Fb(e),partialMatch:e}}function qb(...t){function e(e){let n=null;return t.some((t=>{const r="function"==typeof t?t().partialMatch(e):t.partialMatch(e);return null!=r&&(n=r,!0)})),n}return{toString:function(){return"{ "+t.join(" ")+" }"},input:t,matches:Fb(e),partialMatch:e}}function Gb(t){const e=t;return{toString:function(){return e},matches:function(t){let n;try{n=Eb(t)}catch(t){return!1}const r=n.protoNames();return 1===r.length&&r[0]===e},partialMatch:function(t){return 0===t.length?null:t[0]===e?t.slice(1):null}}}const Wb=(0,i.kg)("libp2p:bootstrap");class Zb extends pp.v{constructor(t,e={list:[]}){if(null==e.list||0===e.list.length)throw new Error("Bootstrap requires a list of peer addresses");super(),this.components=t,this.timeout=e.timeout??1e3,this.list=[];for(const t of e.list){if(!Hb.matches(t)){Wb.error("Invalid multiaddr");continue}const e=Eb(t),n=e.getPeerId();if(null==n){Wb.error("Invalid bootstrap multiaddr without peer id");continue}const r={id:(0,Ne.jE)(n),multiaddrs:[e],protocols:[]};this.list.push(r)}this._init=e}get[qg.N](){return!0}get[Symbol.toStringTag](){return"@libp2p/bootstrap"}isStarted(){return Boolean(this.timer)}start(){this.isStarted()||(Wb("Starting bootstrap node discovery, discovering peers after %s ms",this.timeout),this.timer=setTimeout((()=>{this._discoverBootstrapPeers().catch((t=>{Wb.error(t)}))}),this.timeout))}async _discoverBootstrapPeers(){if(null!=this.timer)for(const t of this.list){if(await this.components.peerStore.tagPeer(t.id,this._init.tagName??"bootstrap",{value:this._init.tagValue??50,ttl:this._init.tagTTL??12e4}),null==this.timer)return;this.dispatchEvent(new pp.A("peer",{detail:t}))}}stop(){null!=this.timer&&clearTimeout(this.timer),this.timer=void 0}}Zb.tag="bootstrap";var Yb=WebSocket,Jb=n(90507);function Qb(t){return t instanceof ArrayBuffer||"ArrayBuffer"===t?.constructor?.name&&"number"==typeof t?.byteLength}var Xb=t=>{if(t.readyState>=2)throw new Error("socket closed");if(1!==t.readyState)return new Promise(((e,n)=>{function r(){t.removeEventListener("open",s),t.removeEventListener("error",o)}function s(){r(),e()}function o(e){r(),n(e.error??new Error(`connect ECONNREFUSED ${t.url}`))}t.addEventListener("open",s),t.addEventListener("error",o)}))},tE=(t,e)=>{(e=e??{}).closeOnEnd=!1!==e.closeOnEnd;return async n=>{for await(const e of n){try{await Xb(t)}catch(t){if("socket closed"===t.message)break;throw t}t.send(e)}if(null!=e.closeOnEnd&&t.readyState<=1)return await new Promise(((e,n)=>{t.addEventListener("close",(t=>{if(t.wasClean||1006===t.code)e();else{const e=Object.assign(new Error("ws error"),{event:t});n(e)}})),setTimeout((()=>t.close()))}))}},eE=(t,e)=>{e=e??{};const n=(t=>{t.binaryType="arraybuffer";const e=async()=>await new Promise(((e,n)=>{if(s)return e();if(null!=r)return n(r);const o=e=>{t.removeEventListener("open",i),t.removeEventListener("error",a),e()},i=()=>o(e),a=e=>{o((()=>n(e.error??new Error(`connect ECONNREFUSED ${t.url}`))))};t.addEventListener("open",i),t.addEventListener("error",a)})),n=async function*(){const n=new Jb.zN((({push:e,stop:n,fail:r})=>{const s=t=>{let n=null;"string"==typeof t.data&&(n=(0,x.m)(t.data)),Qb(t.data)&&(n=new Uint8Array(t.data)),t.data instanceof Uint8Array&&(n=t.data),null!=n&&e(n)},o=t=>r(t.error??new Error("Socket error"));return t.addEventListener("message",s),t.addEventListener("error",o),t.addEventListener("close",n),()=>{t.removeEventListener("message",s),t.removeEventListener("error",o),t.removeEventListener("close",n)}}),{highWaterMark:1/0});await e();for await(const t of n)yield Qb(t)?new Uint8Array(t):t}();let r,s=1===t.readyState;return t.addEventListener("open",(()=>{s=!0,r=null})),t.addEventListener("close",(()=>{s=!1,r=null})),t.addEventListener("error",(e=>{s||(r=e.error??new Error(`connect ECONNREFUSED ${t.url}`))})),Object.assign(n,{connected:e})})(t);let r=e.remoteAddress,s=e.remotePort;if(null!=t.url)try{const e=new URL(t.url);r=e.hostname,s=parseInt(e.port,10)}catch{}if(null==r||null==s)throw new Error("Remote connection did not have address and/or port");const o={sink:tE(t,e),source:n,connected:async()=>await n.connected(),close:async()=>{t.readyState!==t.CONNECTING&&t.readyState!==t.OPEN||await new Promise((e=>{t.addEventListener("close",(()=>{e()})),t.close()}))},destroy:()=>{null!=t.terminate?t.terminate():t.close()},remoteAddress:r,remotePort:s,socket:t};return o};const nE={http:"ws",https:"wss"};function rE(t,e){e=e??{};const n=((t,e)=>(0,ce.relative)(t,e,nE,"ws"))(t,("undefined"==typeof window?"":window.location).toString()),r=new Yb(n,e.websocket);return eE(r,e)}class sE extends Error{constructor(t){super(t),this.name="TimeoutError"}}class oE extends Error{constructor(t){super(),this.name="AbortError",this.message=t}}const iE=t=>void 0===globalThis.DOMException?new oE(t):new DOMException(t),aE=t=>{const e=void 0===t.reason?iE("This operation was aborted."):t.reason;return e instanceof Error?e:iE(e)};const cE=(0,i.kg)("libp2p:websockets:socket");function lE(t,e,n){const r={async sink(e){null!=n?.signal&&(e=(0,zf.wJ)(e,n.signal));try{await t.sink(e)}catch(t){"aborted"!==t.type&&cE.error(t)}},source:null!=(n=n??{}).signal?(0,zf.wJ)(t.source,n.signal):t.source,remoteAddr:e,timeline:{open:Date.now()},async close(){const e=Date.now();try{await function(t,e){const{milliseconds:n,fallback:r,message:s,customTimers:o={setTimeout:setTimeout,clearTimeout:clearTimeout}}=e;let i;const a=new Promise(((a,c)=>{if("number"!=typeof n||1!==Math.sign(n))throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${n}\``);if(n===Number.POSITIVE_INFINITY)return void a(t);if(e.signal){const{signal:t}=e;t.aborted&&c(aE(t)),t.addEventListener("abort",(()=>{c(aE(t))}))}const l=new sE;i=o.setTimeout.call(void 0,(()=>{if(r)try{a(r())}catch(t){c(t)}else"function"==typeof t.cancel&&t.cancel(),!1===s?a():s instanceof Error?c(s):(l.message=s??`Promise timed out after ${n} milliseconds`,c(l))}),n),(async()=>{try{a(await t)}catch(t){c(t)}finally{o.clearTimeout.call(void 0,i)}})()}));return a.clear=()=>{o.clearTimeout.call(void 0,i),i=void 0},a}(t.close(),{milliseconds:2e3})}catch(n){const{host:s,port:o}=r.remoteAddr.toOptions();cE("timeout closing stream to %s:%s after %dms, destroying it manually",s,o,Date.now()-e),t.destroy()}finally{r.timeline.close=Date.now()}}};return t.socket.addEventListener("close",(()=>{null==r.timeline.close&&(r.timeline.close=Date.now())}),{once:!0}),r}const uE=V.C,dE=V.aY,hE=function(t){let e=0;if(t=t.toString().trim(),uE(t)){const n=new Uint8Array(e+4);return t.split(/\./g).forEach((t=>{n[e++]=255&parseInt(t,10)})),n}if(dE(t)){const n=t.split(":",8);let r;for(r=0;r<n.length;r++){let t;uE(n[r])&&(t=hE(n[r]),n[r]=(0,H.B)(t.slice(0,2),"base16")),null!=t&&++r<8&&n.splice(r,0,(0,H.B)(t.slice(2,4),"base16"))}if(""===n[0])for(;n.length<8;)n.unshift("0");else if(""===n[n.length-1])for(;n.length<8;)n.push("0");else if(n.length<8){for(r=0;r<n.length&&""!==n[r];r++);const t=[r,1];for(r=9-n.length;r>0;r--)t.push("0");n.splice.apply(n,t)}const s=new Uint8Array(e+16);for(r=0;r<n.length;r++){const t=parseInt(n[r],16);s[e++]=t>>8&255,s[e++]=255&t}return s}throw new Error("invalid ip address")},pE=function(t,e=0,n){e=~~e,n=n??t.length-e;const r=new DataView(t.buffer);if(4===n){const r=[];for(let s=0;s<n;s++)r.push(t[e+s]);return r.join(".")}if(16===n){const t=[];for(let s=0;s<n;s+=2)t.push(r.getUint16(e+s).toString(16));return t.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""},fE=-1,yE={},gE={};function wE(t){if("number"==typeof t){if(null!=gE[t])return gE[t];throw new Error(`no protocol with code: ${t}`)}if("string"==typeof t){if(null!=yE[t])return yE[t];throw new Error(`no protocol with name: ${t}`)}throw new Error("invalid protocol id type: "+typeof t)}[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,fE,"ip6zone"],[43,8,"ipcidr"],[53,fE,"dns",!0],[54,fE,"dns4",!0],[55,fE,"dns6",!0],[56,fE,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,fE,"unix",!1,!0],[421,fE,"ipfs"],[421,fE,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,fE,"garlic64"],[448,0,"tls"],[449,fE,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,fE,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[777,fE,"memory"]].forEach((t=>{const e=function(t,e,n,r,s){return{code:t,size:e,name:n,resolvable:Boolean(r),path:Boolean(s)}}(...t);gE[e.code]=e,yE[e.name]=e}));wE("ip4"),wE("ip6"),wE("ipcidr");function mE(t,e){switch(wE(t).code){case 4:case 41:return function(t){const e=pE(t,0,t.length);if(null==e)throw new Error("ipBuff is required");if(!V.h6(e))throw new Error("invalid ip address");return e}(e);case 42:case 53:case 54:case 55:case 56:case 400:case 449:case 777:return TE(e);case 6:case 273:case 33:case 132:return RE(e).toString();case 421:return function(t){const e=Dr.decode(t),n=t.slice(Dr.decode.bytes);if(n.length!==e)throw new Error("inconsistent lengths");return(0,H.B)(n,"base58btc")}(e);case 444:case 445:return AE(e);case 466:return function(t){const e=Dr.decode(t),n=t.slice(Dr.decode.bytes);if(n.length!==e)throw new Error("inconsistent lengths");return"u"+(0,H.B)(n,"base64url")}(e);default:return(0,H.B)(e,"base16")}}function bE(t,e){switch(wE(t).code){case 4:case 41:return vE(e);case 42:case 53:case 54:case 55:case 56:case 400:case 449:case 777:return SE(e);case 6:case 273:case 33:case 132:return kE(parseInt(e,10));case 421:return function(t){let e;e="Q"===t[0]||"1"===t[0]?j.Jx(z.base58btc.decode(`z${t}`)).bytes:Q.k0.parse(t).multihash.bytes;const n=Uint8Array.from(Dr.encode(e.length));return(0,tt.z)([n,e],n.length+e.length)}(e);case 444:return function(t){const e=t.split(":");if(2!==e.length)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(16!==e[0].length)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);const n=U.base32.decode("b"+e[0]),r=parseInt(e[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const s=kE(r);return(0,tt.z)([n,s],n.length+s.length)}(e);case 445:return function(t){const e=t.split(":");if(2!==e.length)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(56!==e[0].length)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);const n=U.base32.decode(`b${e[0]}`),r=parseInt(e[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const s=kE(r);return(0,tt.z)([n,s],n.length+s.length)}(e);case 466:return function(t){const e=_E.decode(t),n=Uint8Array.from(Dr.encode(e.length));return(0,tt.z)([n,e],n.length+e.length)}(e);default:return(0,x.m)(e,"base16")}}const EE=Object.values(A.gh).map((t=>t.decoder)),_E=function(){let t=EE[0].or(EE[1]);return EE.slice(2).forEach((e=>t=t.or(e))),t}();function vE(t){if(!V.h6(t))throw new Error("invalid ip address");return hE(t)}function kE(t){const e=new ArrayBuffer(2);return new DataView(e).setUint16(0,t),new Uint8Array(e)}function RE(t){return new DataView(t.buffer).getUint16(t.byteOffset)}function SE(t){const e=(0,x.m)(t),n=Uint8Array.from(Dr.encode(e.length));return(0,tt.z)([n,e],n.length+e.length)}function TE(t){const e=Dr.decode(t);if((t=t.slice(Dr.decode.bytes)).length!==e)throw new Error("inconsistent lengths");return(0,H.B)(t)}function AE(t){const e=t.slice(0,t.length-2),n=t.slice(t.length-2);return`${(0,H.B)(e,"base32")}:${RE(n)}`}function IE(t){return t.map((t=>{const e=zE(t);return null!=t[1]?[e.code,mE(e.code,t[1])]:[e.code]}))}function DE(t){return CE((0,tt.z)(t.map((t=>{const e=zE(t);let n=Uint8Array.from(Dr.encode(e.code));return t.length>1&&null!=t[1]&&(n=(0,tt.z)([n,t[1]])),n}))))}function PE(t,e){if(t.size>0)return t.size/8;if(0===t.size)return 0;return Dr.decode(e)+(Dr.decode.bytes??0)}function NE(t){const e=[];let n=0;for(;n<t.length;){const r=Dr.decode(t,n),s=Dr.decode.bytes??0,o=PE(wE(r),t.slice(n+s));if(0===o){e.push([r]),n+=s;continue}const i=t.slice(n+s,n+s+o);if(n+=o+s,n>t.length)throw BE("Invalid address Uint8Array: "+(0,H.B)(t,"base16"));e.push([r,i])}return e}function OE(t){return function(t){const e=[];return t.map((t=>{const n=zE(t);return e.push(n.name),t.length>1&&null!=t[1]&&e.push(t[1]),null})),xE(e.join("/"))}(IE(NE(t)))}function LE(t){const e=function(t){const e=[],n=t.split("/").slice(1);if(1===n.length&&""===n[0])return[];for(let r=0;r<n.length;r++){const s=n[r],o=wE(s);if(0!==o.size){if(r++,r>=n.length)throw BE("invalid address: "+t);if(!0===o.path){e.push([s,xE(n.slice(r).join("/"))]);break}e.push([s,n[r]])}else e.push([s])}return e}(t=xE(t));return DE(e.map((t=>{Array.isArray(t)||(t=[t]);const e=zE(t);return t.length>1?[e.code,bE(e.code,t[1])]:[e.code]})))}function CE(t){const e=ME(t);if(null!=e)throw e;return Uint8Array.from(t)}function ME(t){try{NE(t)}catch(t){return t}}function xE(t){return"/"+t.trim().split("/").filter((t=>t)).join("/")}function BE(t){return new Error("Error parsing address: "+t)}function zE(t){return wE(t[0])}var UE,jE,$E,VE,HE=function(t,e,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!r:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(t):r?r.value:e.get(t)},FE=function(t,e,n,r,s){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!s:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?s.call(t,n):s?s.value=n:e.set(t,n),n};const KE=Symbol.for("nodejs.util.inspect.custom"),qE=[wE("dns").code,wE("dns4").code,wE("dns6").code,wE("dnsaddr").code],GE=new Map,WE=Symbol.for("@multiformats/js-multiaddr/multiaddr");function ZE(t){return Boolean(t?.[WE])}class YE{constructor(t){if(UE.set(this,void 0),jE.set(this,void 0),$E.set(this,void 0),this[VE]=!0,null==t&&(t=""),t instanceof Uint8Array)this.bytes=CE(t);else if("string"==typeof t){if(t.length>0&&"/"!==t.charAt(0))throw new Error(`multiaddr "${t}" must start with a "/"`);this.bytes=LE(t)}else{if(!ZE(t))throw new Error("addr must be a string, Buffer, or another Multiaddr");this.bytes=CE(t.bytes)}}toString(){return null==HE(this,UE,"f")&&FE(this,UE,OE(this.bytes),"f"),HE(this,UE,"f")}toJSON(){return this.toString()}toOptions(){let t,e,n,r,s="";const o=wE("tcp"),i=wE("udp"),a=wE("ip4"),c=wE("ip6"),l=wE("dns6"),u=wE("ip6zone");for(const[d,h]of this.stringTuples())d===u.code&&(s=`%${h??""}`),qE.includes(d)&&(e=o.name,r=443,n=`${h??""}${s}`,t=d===l.code?6:4),d!==o.code&&d!==i.code||(e=wE(d).name,r=parseInt(h??"")),d!==a.code&&d!==c.code||(e=wE(d).name,n=`${h??""}${s}`,t=d===c.code?6:4);if(null==t||null==e||null==n||null==r)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:t,host:n,transport:e,port:r}}protos(){return this.protoCodes().map((t=>Object.assign({},wE(t))))}protoCodes(){const t=[],e=this.bytes;let n=0;for(;n<e.length;){const r=Dr.decode(e,n),s=Dr.decode.bytes??0;n+=PE(wE(r),e.slice(n+s))+s,t.push(r)}return t}protoNames(){return this.protos().map((t=>t.name))}tuples(){return null==HE(this,jE,"f")&&FE(this,jE,NE(this.bytes),"f"),HE(this,jE,"f")}stringTuples(){return null==HE(this,$E,"f")&&FE(this,$E,IE(this.tuples()),"f"),HE(this,$E,"f")}encapsulate(t){return t=new YE(t),new YE(this.toString()+t.toString())}decapsulate(t){const e=t.toString(),n=this.toString(),r=n.lastIndexOf(e);if(r<0)throw new Error(`Address ${this.toString()} does not contain subaddress: ${t.toString()}`);return new YE(n.slice(0,r))}decapsulateCode(t){const e=this.tuples();for(let n=e.length-1;n>=0;n--)if(e[n][0]===t)return new YE(DE(e.slice(0,n)));return this}getPeerId(){try{const t=this.stringTuples().filter((t=>t[0]===yE.ipfs.code)),e=t.pop();if(null!=e?.[1]){const t=e[1];return"Q"===t[0]||"1"===t[0]?(0,H.B)(z.base58btc.decode(`z${t}`),"base58btc"):(0,H.B)(Q.k0.parse(t).multihash.bytes,"base58btc")}return null}catch(t){return null}}getPath(){let t=null;try{t=this.stringTuples().filter((t=>!0===wE(t[0]).path))[0][1],null==t&&(t=null)}catch{t=null}return t}equals(t){return(0,vt.f)(this.bytes,t.bytes)}async resolve(t){const e=this.protos().find((t=>t.resolvable));if(null==e)return[this];const n=GE.get(e.name);if(null==n)throw a(new Error(`no available resolver for ${e.name}`),"ERR_NO_AVAILABLE_RESOLVER");return(await n(this,t)).map((t=>new YE(t)))}nodeAddress(){const t=this.toOptions();if("tcp"!==t.transport&&"udp"!==t.transport)throw new Error(`multiaddr must have a valid format - no protocol with name: "${t.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:t.family,address:t.host,port:t.port}}isThinWaistAddress(t){const e=(t??this).protos();return 2===e.length&&((4===e[0].code||41===e[0].code)&&(6===e[1].code||273===e[1].code))}[(UE=new WeakMap,jE=new WeakMap,$E=new WeakMap,VE=WE,KE)](){return`Multiaddr(${OE(this.bytes)})`}}function JE(t){return new YE(t)}const QE=k_("dns4"),XE=k_("dns6"),t_=k_("dnsaddr"),e_=v_(k_("dns"),t_,QE,XE),n_=v_(k_("ip4"),k_("ip6")),r_=v_(__(n_,k_("tcp")),__(e_,k_("tcp"))),s_=__(n_,k_("udp")),o_=__(s_,k_("utp")),i_=__(s_,k_("quic")),a_=v_(__(r_,k_("ws")),__(e_,k_("ws"))),c_=v_(__(r_,k_("wss")),__(e_,k_("wss")),__(r_,k_("tls"),k_("ws")),__(e_,k_("tls"),k_("ws"))),l_=v_(__(r_,k_("http")),__(n_,k_("http")),__(e_,k_("http"))),u_=v_(__(r_,k_("https")),__(n_,k_("https")),__(e_,k_("https"))),d_=__(s_,k_("webrtc-direct"),k_("certhash")),h_=v_(__(d_,k_("p2p")),d_),p_=v_(__(a_,k_("p2p-webrtc-star"),k_("p2p")),__(c_,k_("p2p-webrtc-star"),k_("p2p")),__(a_,k_("p2p-webrtc-star")),__(c_,k_("p2p-webrtc-star"))),f_=(v_(__(a_,k_("p2p-websocket-star"),k_("p2p")),__(c_,k_("p2p-websocket-star"),k_("p2p")),__(a_,k_("p2p-websocket-star")),__(c_,k_("p2p-websocket-star"))),v_(__(l_,k_("p2p-webrtc-direct"),k_("p2p")),__(u_,k_("p2p-webrtc-direct"),k_("p2p")),__(l_,k_("p2p-webrtc-direct")),__(u_,k_("p2p-webrtc-direct")))),y_=v_(a_,c_,l_,u_,p_,f_,r_,o_,i_,e_,h_),g_=(v_(__(y_,k_("p2p-stardust"),k_("p2p")),__(y_,k_("p2p-stardust"))),v_(__(y_,k_("p2p")),p_,f_,h_,k_("p2p"))),w_=v_(__(g_,k_("p2p-circuit"),g_),__(g_,k_("p2p-circuit")),__(k_("p2p-circuit"),g_),__(y_,k_("p2p-circuit")),__(k_("p2p-circuit"),y_),k_("p2p-circuit")),m_=()=>v_(__(w_,m_),w_),b_=m_();v_(__(b_,g_,b_),__(g_,b_),__(b_,g_),b_,g_),v_(__(b_,k_("webrtc")),__(y_,k_("webrtc")),k_("webrtc"));function E_(t){return function(e){let n;try{n=JE(e)}catch(t){return!1}const r=t(n.protoNames());return null!==r&&(!0===r||!1===r?r:0===r.length)}}function __(...t){function e(e){if(e.length<t.length)return null;let n=e;return t.some((t=>(n="function"==typeof t?t().partialMatch(e):t.partialMatch(e),Array.isArray(n)&&(e=n),null===n))),n}return{toString:function(){return"{ "+t.join(" ")+" }"},input:t,matches:E_(e),partialMatch:e}}function v_(...t){function e(e){let n=null;return t.some((t=>{const r="function"==typeof t?t().partialMatch(e):t.partialMatch(e);return null!=r&&(n=r,!0)})),n}return{toString:function(){return"{ "+t.join(" ")+" }"},input:t,matches:E_(e),partialMatch:e}}function k_(t){const e=t;return{toString:function(){return e},matches:function(t){let n;try{n=JE(t)}catch(t){return!1}const r=n.protoNames();return 1===r.length&&r[0]===e},partialMatch:function(t){return 0===t.length?null:t[0]===e?t.slice(1):null}}}const R_=(0,i.kg)("libp2p:websockets");class S_{constructor(t){this.init=t}get[Symbol.toStringTag](){return"@libp2p/websockets"}get[Bf.NA](){return!0}async dial(t,e){R_("dialing %s",t),e=e??{};const n=lE(await this._connect(t,e),t);R_("new outbound connection %s",n.remoteAddr);const r=await e.upgrader.upgradeOutbound(n);return R_("outbound connection %s upgraded",n.remoteAddr),r}async _connect(t,e){if(!0===e?.signal?.aborted)throw new cg._;const n=t.toOptions();R_("dialing %s:%s",n.host,n.port);const r=(0,lm.Z)(),s=t=>{R_.error("connection error:",t),r.reject(t)},o=rE((0,Ca.k)(t),this.init);if(null!=o.socket.on?o.socket.on("error",s):o.socket.onerror=s,null==e.signal)return await Promise.race([o.connected(),r.promise]),R_("connected %s",t),o;let i;const a=new Promise(((t,n)=>{i=()=>{n(new cg._),o.close().catch((t=>{R_.error("error closing raw socket",t)}))},!0!==e?.signal?.aborted?e?.signal?.addEventListener("abort",i):i()}));try{await Promise.race([a,r.promise,o.connected()])}finally{null!=i&&e?.signal?.removeEventListener("abort",i)}return R_("connected %s",t),o}createListener(t){return function(){throw new Error("WebSocket Servers can not be created in the browser!")}(this.init)}filter(t){return t=Array.isArray(t)?t:[t],null!=this.init?.filter?this.init?.filter(t):Qy.jU||Qy.n2?function(t){return t.filter((t=>{if(t.protoCodes().includes(290))return!1;const e=t.decapsulateCode(421);return c_.matches(e)}))}(t):function(t){return t.filter((t=>{if(t.protoCodes().includes(290))return!1;const e=t.decapsulateCode(421);return a_.matches(e)||c_.matches(e)}))}(t)}}var T_=n(66978),A_=n(85809),I_=n(83204);const D_=65535,P_=Boolean(globalThis.process?.env?.DUMP_SESSION_KEYS);var N_=n(512),O_=n(57664),L_=n(73294),C_=n(15501);const M_={hashSHA256:t=>(0,L_.vp)(t),getHKDF(t,e){const n=new N_.t(L_.mE,e,t).expand(96);return[n.subarray(0,32),n.subarray(32,64),n.subarray(64,96)]},generateX25519KeyPair(){const t=O_.Au();return{publicKey:t.publicKey,privateKey:t.secretKey}},generateX25519KeyPairFromSeed(t){const e=O_._w(t);return{publicKey:e.publicKey,privateKey:e.secretKey}},generateX25519SharedKey:(t,e)=>O_.gi(t,e),chaCha20Poly1305Encrypt:(t,e,n,r)=>new C_.OK(r).seal(e,t,n),chaCha20Poly1305Decrypt:(t,e,n,r,s)=>new C_.OK(r).open(e,t,n,s)},x_=t=>{const e=(n=2,globalThis.Buffer?globalThis.Buffer.allocUnsafe(n):new Uint8Array(n));var n;return new DataView(e.buffer,e.byteOffset,e.byteLength).setUint16(0,t,!1),e};x_.bytes=2;const B_=t=>{if(t.length<2)throw RangeError("Could not decode int16BE");return t instanceof Uint8Array?new DataView(t.buffer,t.byteOffset,t.byteLength).getUint16(0,!1):t.getUint16(0)};B_.bytes=2;var z_=n(19859);Yp._configure(),qp._configure(Gp),Wp._configure(Zp);const U_=["uint64","int64","sint64","fixed64","sfixed64"];function j_(t){return function(t){for(const e of U_){if(null==t[e])continue;const n=t[e];t[e]=function(){return BigInt(n.call(this).toString())}}return t}(new qp(t))}function $_(){return function(t){for(const e of U_){if(null==t[e])continue;const n=t[e];t[e]=function(t){return n.call(this,t.toString())}}return t}(Wp.create())}function V_(t,e){const n=j_(t instanceof Uint8Array?t:t.subarray());return e.decode(n)}function H_(t,e){const n=$_();return e.encode(t,n,{lengthDelimited:!1}),n.finish()}var F_,K_,q_;function G_(t,e){return function(t,e,n,r){return{name:t,type:e,encode:n,decode:r}}("message",F_.LENGTH_DELIMITED,t,e)}async function W_(t,e,n){const r=await async function(t,e){if(null==t.privateKey)throw new Error("PrivateKey was missing from PeerId");const n=await(0,$e.unmarshalPrivateKey)(t.privateKey);return await n.sign(e)}(t,J_(e));if(null==t.publicKey)throw new Error("PublicKey was missing from local PeerId");return function(t,e,n){return q_.encode({identityKey:t,identitySig:e,extensions:n??{webtransportCerthashes:[]}}).subarray()}(t.publicKey,r,n)}async function Z_(t){return await(0,Ne.y5)(t.identityKey)}function Y_(t){return q_.decode(t)}function J_(t){const e=(0,x.m)("noise-libp2p-static-key:");return(0,tt.z)([e,t],e.length+t.length)}async function Q_(t,e,n){const r=await(0,Ne.y5)(e.identityKey);if(!r.equals(n))throw new Error(`Payload identity key ${r.toString()} does not match expected remote peer ${n.toString()}`);const s=J_(t);if(null==r.publicKey)throw new Error("PublicKey was missing from PeerId");if(null==e.identitySig)throw new Error("Signature was missing from message");const o=(0,$e.unmarshalPublicKey)(r.publicKey);if(!await o.verify(s,e.identitySig))throw new Error("Static key doesn't match to peer that signed payload!");return r}function X_(t){return t instanceof Uint8Array&&32===t.length}!function(t){t[t.VARINT=0]="VARINT",t[t.BIT64=1]="BIT64",t[t.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",t[t.START_GROUP=3]="START_GROUP",t[t.END_GROUP=4]="END_GROUP",t[t.BIT32=5]="BIT32"}(F_||(F_={})),function(t){let e;t.codec=()=>(null==e&&(e=G_(((t,e,n={})=>{if(!1!==n.lengthDelimited&&e.fork(),null!=t.webtransportCerthashes)for(const n of t.webtransportCerthashes)e.uint32(10),e.bytes(n);!1!==n.lengthDelimited&&e.ldelim()}),((t,e)=>{const n={webtransportCerthashes:[]},r=null==e?t.len:t.pos+e;for(;t.pos<r;){const e=t.uint32();if(e>>>3==1)n.webtransportCerthashes.push(t.bytes());else t.skipType(7&e)}return n}))),e),t.encode=e=>H_(e,t.codec()),t.decode=e=>V_(e,t.codec())}(K_||(K_={})),function(t){let e;t.codec=()=>(null==e&&(e=G_(((t,e,n={})=>{!1!==n.lengthDelimited&&e.fork(),(!0===n.writeDefaults||null!=t.identityKey&&t.identityKey.byteLength>0)&&(e.uint32(10),e.bytes(t.identityKey??new Uint8Array(0))),(!0===n.writeDefaults||null!=t.identitySig&&t.identitySig.byteLength>0)&&(e.uint32(18),e.bytes(t.identitySig??new Uint8Array(0))),null!=t.extensions&&(e.uint32(34),K_.codec().encode(t.extensions,e,{writeDefaults:!1})),!1!==n.lengthDelimited&&e.ldelim()}),((t,e)=>{const n={identityKey:new Uint8Array(0),identitySig:new Uint8Array(0)},r=null==e?t.len:t.pos+e;for(;t.pos<r;){const e=t.uint32();switch(e>>>3){case 1:n.identityKey=t.bytes();break;case 2:n.identitySig=t.bytes();break;case 4:n.extensions=K_.codec().decode(t,t.uint32());break;default:t.skipType(7&e)}}return n}))),e),t.encode=e=>H_(e,t.codec()),t.decode=e=>V_(e,t.codec())}(q_||(q_={}));const tv=(0,i.kg)("libp2p:noise");let ev;function nv(t){t?(ev(`LOCAL_PUBLIC_EPHEMERAL_KEY ${(0,H.B)(t.publicKey,"hex")}`),ev(`LOCAL_PRIVATE_EPHEMERAL_KEY ${(0,H.B)(t.privateKey,"hex")}`)):ev("Missing local ephemeral keys.")}function rv(t){ev(`REMOTE_EPHEMERAL_PUBLIC_KEY ${(0,H.B)(t,"hex")}`)}ev=P_?tv:Object.assign((()=>{}),{enabled:!1,trace:()=>{},error:()=>{}});class sv{constructor(t=0){this.n=t,this.bytes=new Uint8Array(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,t,!0)}increment(){this.n++,this.view.setUint32(4,this.n,!0)}getBytes(){return this.bytes}getUint64(){return this.n}assertValue(){if(this.n>4294967295)throw new Error("Cipherstate has reached maximum n, a new handshake must be performed")}}class ov{constructor(t){this.crypto=t}encryptWithAd(t,e,n){const r=this.encrypt(t.k,t.n,e,n);return t.n.increment(),r}decryptWithAd(t,e,n,r){const{plaintext:s,valid:o}=this.decrypt(t.k,t.n,e,n,r);return o&&t.n.increment(),{plaintext:s,valid:o}}hasKey(t){return!this.isEmptyKey(t.k)}createEmptyKey(){return new Uint8Array(32)}isEmptyKey(t){const e=this.createEmptyKey();return(0,vt.f)(e,t)}encrypt(t,e,n,r){return e.assertValue(),this.crypto.chaCha20Poly1305Encrypt(r,e.getBytes(),n,t)}encryptAndHash(t,e){let n;return n=this.hasKey(t.cs)?this.encryptWithAd(t.cs,t.h,e):e,this.mixHash(t,n),n}decrypt(t,e,n,r,s){e.assertValue();const o=this.crypto.chaCha20Poly1305Decrypt(r,e.getBytes(),n,t,s);return o?{plaintext:o,valid:!0}:{plaintext:new Uint8Array(0),valid:!1}}decryptAndHash(t,e){let n,r=!0;return this.hasKey(t.cs)?({plaintext:n,valid:r}=this.decryptWithAd(t.cs,t.h,e)):n=e,this.mixHash(t,e),{plaintext:n,valid:r}}dh(t,e){try{const n=this.crypto.generateX25519SharedKey(t,e);return 32===n.length?n:n.subarray(0,32)}catch(t){return tv(t.message),new Uint8Array(32)}}mixHash(t,e){t.h=this.getHash(t.h,e)}getHash(t,e){return this.crypto.hashSHA256((0,tt.z)([t,e],t.length+e.length))}mixKey(t,e){const[n,r]=this.crypto.getHKDF(t.ck,e);t.cs=this.initializeKey(r),t.ck=n}initializeKey(t){return{k:t,n:new sv}}initializeSymmetric(t){const e=(0,ym.mL)(t,"utf-8"),n=this.hashProtocolName(e),r=n,s=this.createEmptyKey();return{cs:this.initializeKey(s),ck:r,h:n}}hashProtocolName(t){if(t.length<=32){const e=new Uint8Array(32);return e.set(t),e}return this.getHash(t,new Uint8Array(0))}split(t){const[e,n]=this.crypto.getHKDF(t.ck,new Uint8Array(0));return{cs1:this.initializeKey(e),cs2:this.initializeKey(n)}}writeMessageRegular(t,e){const n=this.encryptWithAd(t,new Uint8Array(0),e);return{ne:this.createEmptyKey(),ns:new Uint8Array(0),ciphertext:n}}readMessageRegular(t,e){return this.decryptWithAd(t,new Uint8Array(0),e.ciphertext)}}class iv extends ov{initializeInitiator(t,e,n,r){const s=this.initializeSymmetric("Noise_XX_25519_ChaChaPoly_SHA256");this.mixHash(s,t);return{ss:s,s:e,rs:n,psk:r,re:new Uint8Array(32)}}initializeResponder(t,e,n,r){const s=this.initializeSymmetric("Noise_XX_25519_ChaChaPoly_SHA256");this.mixHash(s,t);return{ss:s,s:e,rs:n,psk:r,re:new Uint8Array(32)}}writeMessageA(t,e,n){const r=new Uint8Array(0);t.e=void 0!==n?n:this.crypto.generateX25519KeyPair();const s=t.e.publicKey;this.mixHash(t.ss,s);return{ne:s,ns:r,ciphertext:this.encryptAndHash(t.ss,e)}}writeMessageB(t,e){t.e=this.crypto.generateX25519KeyPair();const n=t.e.publicKey;this.mixHash(t.ss,n),this.mixKey(t.ss,this.dh(t.e.privateKey,t.re));const r=t.s.publicKey,s=this.encryptAndHash(t.ss,r);this.mixKey(t.ss,this.dh(t.s.privateKey,t.re));return{ne:n,ns:s,ciphertext:this.encryptAndHash(t.ss,e)}}writeMessageC(t,e){const n=t.s.publicKey,r=this.encryptAndHash(t.ss,n);this.mixKey(t.ss,this.dh(t.s.privateKey,t.re));const s=this.encryptAndHash(t.ss,e),o={ne:this.createEmptyKey(),ns:r,ciphertext:s},{cs1:i,cs2:a}=this.split(t.ss);return{h:t.ss.h,messageBuffer:o,cs1:i,cs2:a}}readMessageA(t,e){return X_(e.ne)&&(t.re=e.ne),this.mixHash(t.ss,t.re),this.decryptAndHash(t.ss,e.ciphertext)}readMessageB(t,e){if(X_(e.ne)&&(t.re=e.ne),this.mixHash(t.ss,t.re),!t.e)throw new Error("Handshake state `e` param is missing.");this.mixKey(t.ss,this.dh(t.e.privateKey,t.re));const{plaintext:n,valid:r}=this.decryptAndHash(t.ss,e.ns);r&&X_(n)&&(t.rs=n),this.mixKey(t.ss,this.dh(t.e.privateKey,t.rs));const{plaintext:s,valid:o}=this.decryptAndHash(t.ss,e.ciphertext);return{plaintext:s,valid:r&&o}}readMessageC(t,e){const{plaintext:n,valid:r}=this.decryptAndHash(t.ss,e.ns);if(r&&X_(n)&&(t.rs=n),!t.e)throw new Error("Handshake state `e` param is missing.");this.mixKey(t.ss,this.dh(t.e.privateKey,t.rs));const{plaintext:s,valid:o}=this.decryptAndHash(t.ss,e.ciphertext),{cs1:i,cs2:a}=this.split(t.ss);return{h:t.ss.h,plaintext:s,valid:r&&o,cs1:i,cs2:a}}initSession(t,e,n){const r=this.createEmptyKey(),s=new Uint8Array(32);let o;return o=t?this.initializeInitiator(e,n,s,r):this.initializeResponder(e,n,s,r),{hs:o,i:t,mc:0}}sendMessage(t,e,n){let r;if(0===t.mc)r=this.writeMessageA(t.hs,e,n);else if(1===t.mc)r=this.writeMessageB(t.hs,e);else if(2===t.mc){const{h:n,messageBuffer:s,cs1:o,cs2:i}=this.writeMessageC(t.hs,e);r=s,t.h=n,t.cs1=o,t.cs2=i}else{if(!(t.mc>2))throw new Error("Session invalid.");if(t.i){if(!t.cs1)throw new Error("CS1 (cipher state) is not defined");r=this.writeMessageRegular(t.cs1,e)}else{if(!t.cs2)throw new Error("CS2 (cipher state) is not defined");r=this.writeMessageRegular(t.cs2,e)}}return t.mc++,r}recvMessage(t,e){let n=new Uint8Array(0),r=!1;if(0===t.mc)({plaintext:n,valid:r}=this.readMessageA(t.hs,e));else if(1===t.mc)({plaintext:n,valid:r}=this.readMessageB(t.hs,e));else if(2===t.mc){const{h:s,plaintext:o,valid:i,cs1:a,cs2:c}=this.readMessageC(t.hs,e);n=o,r=i,t.h=s,t.cs1=a,t.cs2=c}return t.mc++,{plaintext:n,valid:r}}}class av{constructor(t,e,n,r,s,o,i,a){this.remoteExtensions={webtransportCerthashes:[]},this.isInitiator=t,this.payload=e,this.prologue=n,this.staticKeypair=s,this.connection=o,i&&(this.remotePeer=i),this.xx=a??new iv(r),this.session=this.xx.initSession(this.isInitiator,this.prologue,this.staticKeypair)}async propose(){var t;if(t=this.session.hs.s,ev(`LOCAL_STATIC_PUBLIC_KEY ${(0,H.B)(t.publicKey,"hex")}`),ev(`LOCAL_STATIC_PRIVATE_KEY ${(0,H.B)(t.privateKey,"hex")}`),this.isInitiator){tv("Stage 0 - Initiator starting to send first message.");const t=this.xx.sendMessage(this.session,new Uint8Array(0));this.connection.writeLP(function(t){return(0,tt.z)([t.ne,t.ciphertext],t.ne.length+t.ciphertext.length)}(t)),tv("Stage 0 - Initiator finished sending first message."),nv(this.session.hs.e)}else{tv("Stage 0 - Responder waiting to receive first message...");const t=function(t){if(t.length<32)throw new Error("Cannot decode stage 0 MessageBuffer: length less than 32 bytes.");return{ne:t.subarray(0,32),ciphertext:t.subarray(32,t.length),ns:new Uint8Array(0)}}((await this.connection.readLP()).subarray()),{valid:e}=this.xx.recvMessage(this.session,t);if(!e)throw new z_.kz("xx handshake stage 0 validation fail");tv("Stage 0 - Responder received first message."),rv(this.session.hs.re)}}async exchange(){if(this.isInitiator){tv("Stage 1 - Initiator waiting to receive first message from responder...");const e=function(t){if(t.length<80)throw new Error("Cannot decode stage 1 MessageBuffer: length less than 80 bytes.");return{ne:t.subarray(0,32),ns:t.subarray(32,80),ciphertext:t.subarray(80,t.length)}}((await this.connection.readLP()).subarray()),{plaintext:n,valid:r}=this.xx.recvMessage(this.session,e);if(!r)throw new z_.kz("xx handshake stage 1 validation fail");tv("Stage 1 - Initiator received the message."),rv(this.session.hs.re),t=this.session.hs.rs,ev(`REMOTE_STATIC_PUBLIC_KEY ${(0,H.B)(t,"hex")}`),tv("Initiator going to check remote's signature...");try{const t=Y_(n);this.remotePeer=this.remotePeer||await Z_(t),await Q_(this.session.hs.rs,t,this.remotePeer),this.setRemoteNoiseExtension(t.extensions)}catch(t){const e=t;throw new z_.kT(`Error occurred while verifying signed payload: ${e.message}`)}tv("All good with the signature!")}else{tv("Stage 1 - Responder sending out first message with signed payload and static key.");const t=this.xx.sendMessage(this.session,this.payload);this.connection.writeLP(function(t){return(0,tt.z)([t.ne,t.ns,t.ciphertext],t.ne.length+t.ns.length+t.ciphertext.length)}(t)),tv("Stage 1 - Responder sent the second handshake message with signed payload."),nv(this.session.hs.e)}var t}async finish(){if(this.isInitiator){tv("Stage 2 - Initiator sending third handshake message.");const t=this.xx.sendMessage(this.session,this.payload);this.connection.writeLP(function(t){return(0,tt.z)([t.ns,t.ciphertext],t.ns.length+t.ciphertext.length)}(t)),tv("Stage 2 - Initiator sent message with signed payload.")}else{tv("Stage 2 - Responder waiting for third handshake message...");const t=function(t){if(t.length<48)throw new Error("Cannot decode stage 2 MessageBuffer: length less than 48 bytes.");return{ne:new Uint8Array(0),ns:t.subarray(0,48),ciphertext:t.subarray(48,t.length)}}((await this.connection.readLP()).subarray()),{plaintext:e,valid:n}=this.xx.recvMessage(this.session,t);if(!n)throw new z_.kz("xx handshake stage 2 validation fail");tv("Stage 2 - Responder received the message, finished handshake.");try{const t=Y_(e);this.remotePeer=this.remotePeer||await Z_(t),await Q_(this.session.hs.rs,t,this.remotePeer),this.setRemoteNoiseExtension(t.extensions)}catch(t){const e=t;throw new z_.kT(`Error occurred while verifying signed payload: ${e.message}`)}}var t;(t=this.session).cs1&&t.cs2?(ev(`CIPHER_STATE_1 ${t.cs1.n.getUint64()} ${(0,H.B)(t.cs1.k,"hex")}`),ev(`CIPHER_STATE_2 ${t.cs2.n.getUint64()} ${(0,H.B)(t.cs2.k,"hex")}`)):ev("Missing cipher state.")}encrypt(t,e){const n=this.getCS(e);return this.xx.encryptWithAd(n,new Uint8Array(0),t)}decrypt(t,e,n){const r=this.getCS(e,!1);return this.xx.decryptWithAd(r,new Uint8Array(0),t,n)}getRemoteStaticKey(){return this.session.hs.rs}getCS(t,e=!0){if(!t.cs1||!t.cs2)throw new z_.kz("Handshake not completed properly, cipher state does not exist.");return this.isInitiator?e?t.cs1:t.cs2:e?t.cs2:t.cs1}setRemoteNoiseExtension(t){t&&(this.remoteExtensions=t)}}class cv{constructor(t={}){this.protocol="/noise";const{staticNoiseKey:e,extensions:n,crypto:r,prologueBytes:s,metrics:o}=t;this.crypto=r??M_,this.extensions=n,this.metrics=o?function(t){return{xxHandshakeSuccesses:t.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:t.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:t.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:t.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:t.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}(o):void 0,this.staticKeys=e?this.crypto.generateX25519KeyPairFromSeed(e):this.crypto.generateX25519KeyPair(),this.prologue=s??new Uint8Array(0)}async secureOutbound(t,e,n){const r=(0,A_.z)(e,{lengthEncoder:x_,lengthDecoder:B_,maxDataLength:D_}),s=await this.performHandshake({connection:r,isInitiator:!0,localPeer:t,remotePeer:n});return{conn:await this.createSecureConnection(r,s),remoteExtensions:s.remoteExtensions,remotePeer:s.remotePeer}}async secureInbound(t,e,n){const r=(0,A_.z)(e,{lengthEncoder:x_,lengthDecoder:B_,maxDataLength:D_}),s=await this.performHandshake({connection:r,isInitiator:!1,localPeer:t,remotePeer:n});return{conn:await this.createSecureConnection(r,s),remotePeer:s.remotePeer,remoteExtensions:s.remoteExtensions}}async performHandshake(t){const e=await W_(t.localPeer,this.staticKeys.publicKey,this.extensions);return await this.performXXHandshake(t,e)}async performXXHandshake(t,e){const{isInitiator:n,remotePeer:r,connection:s}=t,o=new av(n,e,this.prologue,this.crypto,this.staticKeys,s,r);try{await o.propose(),await o.exchange(),await o.finish(),this.metrics?.xxHandshakeSuccesses.increment()}catch(t){if(this.metrics?.xxHandshakeErrors.increment(),t instanceof Error)throw t.message=`Error occurred during XX handshake: ${t.message}`,t}return o}async createSecureConnection(t,e){const[n,r]=(0,I_.K)(),s=t.unwrap();return await Gs(n,function(t,e){return async function*(n){for await(const r of n)for(let n=0;n<r.length;n+=65519){let s=n+65519;s>r.length&&(s=r.length);const o=t.encrypt(r.subarray(n,s),t.session);e?.encryptedPackets.increment(),yield x_(o.byteLength),yield o}}}(e,this.metrics),s,Pf({lengthDecoder:B_}),function(t,e){return async function*(n){for await(const r of n)for(let n=0;n<r.length;n+=D_){let s=n+D_;if(s>r.length&&(s=r.length),s-C_.pg<n)throw new Error("Invalid chunk");const o=r.subarray(n,s),i=r.subarray(n,s-C_.pg),{plaintext:a,valid:c}=t.decrypt(o,t.session,i);if(!c)throw e?.decryptErrors.increment(),new Error("Failed to validate decrypted chunk");e?.decryptedPackets.increment(),yield a}}}(e,this.metrics),n),r}}function lv(t={}){return()=>new cv(t)}const uv=s.Z.bind({ignoreUndefined:!0,concatArrays:!0});function dv({options:t={},peerId:e,multiaddrs:n=[],repo:r,keychainConfig:s={},config:o={}}){const{datastore:i}=r,c=function({options:t,config:e,datastore:n,keychainConfig:r,peerId:s,multiaddrs:o}){const i=()=>{const t=$n(e,"Pubsub.Router")||"gossipsub",n=(0,Ul.M)();if(!n[t])throw a(new Error(`Router unavailable. Configure libp2p.modules.pubsub to use the ${t} router.`),"ERR_NOT_SUPPORTED");return n[t]},c={datastore:n,peerId:s},l={addresses:{listen:o.map((t=>t.toString())),announce:$n(t,"addresses.announce",$n(e,"Addresses.Announce",[])),noAnnounce:$n(t,"addresses.noAnnounce",$n(e,"Addresses.NoAnnounce",[]))},connectionManager:$n(t,"connectionManager",{maxConnections:$n(t,"config.Swarm.ConnMgr.HighWater",$n(e,"Swarm.ConnMgr.HighWater")),minConnections:$n(t,"config.Swarm.ConnMgr.LowWater",$n(e,"Swarm.ConnMgr.LowWater"))}),keychain:r,identify:{host:{agentVersion:`js-ipfs/${Fi}`}},contentRouters:[],peerRouters:[],peerDiscovery:[],transports:[],streamMuxers:[(0,T_.R)({maxInboundStreams:256,maxOutboundStreams:1024})],connectionEncryption:[lv()],relay:{enabled:$n(t,"relay.enabled",$n(e,"relay.enabled",!0)),hop:{enabled:$n(t,"relay.hop.enabled",$n(e,"relay.hop.enabled",!1)),active:$n(t,"relay.hop.active",$n(e,"relay.hop.active",!1))}},nat:{enabled:!$n(e,"Swarm.DisableNatPortMap",!1)}};$n(t,"config.Pubsub.Enabled",$n(e,"Pubsub.Enabled",!0))&&(l.pubsub=i());"none"!==$n(e,"Routing.Type","dhtclient")&&(l.dht=(u={clientMode:"dhtserver"!==$n(e,"Routing.Type","dht"),kBucketSize:$n(t,"dht.kBucketSize",20),validators:{ipns:Rn},selectors:{ipns:Vn}},t=>new Om(t,u)));var u;const d=$n(t,"config.Bootstrap",$n(e,"Bootstrap",[]));d.length>0&&l.peerDiscovery?.push(function(t){return e=>new Zb(e,t)}({list:d}));let h=$n(t,"libp2p",void 0);"function"==typeof h&&(h=void 0);const p=uv(c,(0,hp.s)(),l,h),f=$n(t,"config.Addresses.Delegates",$n(e,"Addresses.Delegates",[]));if(f.length>0){const t=f[Math.floor(Math.random()*f.length)],e=(0,$.HM)(t).toOptions(),n=function(t={}){const e={name:T.identity.name,code:T.identity.code,encode:t=>t,decode:t=>t},n=Object.values(A.gh);(t.ipld&&t.ipld.bases?t.ipld.bases:[]).forEach((t=>n.push(t)));const r=new Vl.x({bases:n,loadBase:t.ipld&&t.ipld.loadBase}),s=Object.values(A.QB);[v,k,R,S,e].concat(t.ipld&&t.ipld.codecs||[]).forEach((t=>s.push(t)));const o=new Hl.w({codecs:s,loadCodec:t.ipld&&t.ipld.loadCodec}),i=Object.values(A.kq);(t.ipld&&t.ipld.hashers?t.ipld.hashers:[]).forEach((t=>i.push(t)));const a=new Fl.d({hashers:i,loadHasher:t.ipld&&t.ipld.loadHasher});var c;return{add:Wh(t),addAll:Fh(t),bitswap:(c=t,{wantlist:au(c),wantlistForPeer:cu(c),unwant:uu(c),stat:lu(c)}),block:mu(t),bootstrap:Ru(t),cat:Zh(t),commands:Yh(t),config:Cu(t),dag:$u(o,t),dht:Zu(t),diag:Xu(t),dns:Jh(t),files:fd(t),get:Xh(t),getEndpointConfig:Qh(t),id:tp(t),isOnline:ep(t),key:vd(t),log:Td(t),ls:np(t),mount:sp(t),name:Ld(t),object:Kd(o,t),pin:yh(t),ping:op(t),pubsub:Dh(t),refs:Nh(t),repo:Mh(t),resolve:ip(t),start:ap(t),stats:Bh(t),stop:cp(t),swarm:Hh(t),version:lp(t),bases:r,codecs:o,hashers:a}}({host:e.host,protocol:443===parseInt(e.port)?"https":"http",port:e.port});p.contentRouters?.push((0,$l.OP)(n)),p.peerRouters?.push((0,jl.e8)(n))}$n(t,"config.Discovery.MDNS.Enabled",$n(e,"Discovery.MDNS.Enabled",!0))||(p.peerDiscovery=p.peerDiscovery?.filter((t=>{try{if("function"==typeof t)return"@libp2p/mdns"!==t({})[Symbol.toStringTag]}catch{}return!0})));null==p.transports&&(p.transports=[]);null==p.transports.find((t=>{try{if("function"==typeof t)return"@libp2p/websockets"===t({})[Symbol.toStringTag]}catch{}return!1}))&&p.transports.push(function(t={}){return()=>new S_(t)}());return p}({options:t,config:o,datastore:i,keychainConfig:s,peerId:e,multiaddrs:n});return"function"==typeof t.libp2p?t.libp2p({libp2pOptions:c,options:t,config:o,datastore:i,peerId:e}):(c.start=!1,async function(t){const e=await sw(t);return!1!==t.start&&await e.start(),e}(c))}var hv=n(68919);const pv=s.Z.bind({ignoreUndefined:!0}),fv=(0,i.kg)("ipfs:components:peer:storage");class yv{constructor(t,e,n,r,s){this.print=r,this.peerId=t,this.keychain=e,this.repo=n,this.print=r,this.isNew=s}static async start(t,e,n){const{repoAutoMigrate:r,repo:s,onMigrationProgress:o}=n,i="string"==typeof s||null==s?(0,zl.x)(t,e,{path:s,autoMigrate:r,onMigrationProgress:o}):s,{peerId:a,keychain:c,isNew:l}=await gv(t,i,n);return new yv(a,c,i,t,l)}}const gv=async(t,e,n)=>{if(!e.closed)return{...await _v(e,n),isNew:!1};try{return await e.open(),{...await _v(e,n),isNew:!1}}catch(r){if(r.code!==hv.uF)throw r;if(n.init&&!1===n.init.allowNew)throw new M("Initialization of new repos disabled by config, pass `config.init.isNew: true` to enable it");return{...await wv(t,e,n),isNew:!0}}},wv=async(t,e,n)=>{const r=n.init||{},s=await e.exists();if(fv("repo exists?",s),!0===s)throw new Error("repo already exists");const o=r.privateKey?await mv(r.privateKey):await bv(t,r),i=Ev(o);fv("peer identity: %s",i.PeerID);const a={...pv(kv((0,zs.Z)(),r.profiles),n.config),Identity:i};await e.init(a),await e.open(),fv("repo opened");const c={pass:n.pass};try{c.dek=await e.config.get("Keychain.DEK")}catch(t){if("ERR_NOT_FOUND"!==t.code)throw t}const l=await dv({options:void 0,multiaddrs:void 0,peerId:o,repo:e,config:a,keychainConfig:c});return await e.datastore.has(new be.s("/info/self"))||await l.keychain.importPeer("self",o),await e.config.set("Keychain",{DEK:l.keychain.init.dek}),{peerId:o,keychain:l.keychain}},mv=async t=>{if(fv("using user-supplied private-key"),(0,ze.I)(t))return t;const e=(0,x.m)(t,"base64pad"),n=await(0,$e.unmarshalPrivateKey)(e);return await(0,Ne.y5)(n.public.bytes,n.bytes)},bv=(t,{algorithm:e="Ed25519",bits:n=2048})=>{if(t("generating %s keypair...",e),"Ed25519"===e)return(0,Kg.n9)();if("RSA"===e)return(0,Kg.W$)({bits:n});throw a(new Error("Unknown PeerId algorithm"),"ERR_UNKNOWN_PEER_ID_ALGORITHM")},Ev=t=>{if(null==t.privateKey)throw a(new Error("Private key missing"),"ERR_MISSING_PRIVATE_KEY");return{PeerID:t.toString(),PrivKey:(0,H.B)(t.privateKey,"base64pad")}},_v=async(t,e)=>{const n=e.config,r=e.init&&e.init.profiles||[],s=e.pass,o=await t.config.getAll(),i=vv(kv(o,r),n);if(o!==i&&await t.config.replace(i),!i.Identity||!i.Identity.PrivKey)throw new D("No private key was found in the config, please intialize the repo");const a=(0,x.m)(i.Identity.PrivKey,"base64pad"),c=await(0,$e.unmarshalPrivateKey)(a),l=await(0,Ne.y5)(c.public.bytes,c.bytes);return{peerId:l,keychain:(await dv({options:void 0,multiaddrs:void 0,peerId:l,repo:t,config:i,keychainConfig:{pass:s,...i.Keychain}})).keychain}},vv=(t,e)=>e?pv(t,e):t,kv=(t,e)=>(e||[]).reduce(((t,e)=>{const n=Wi[e];if(!n)throw new Error(`Could not find profile with name '${e}'`);return fv("applying profile %s",e),n.transform(t)}),t);var Rv=n(82838);var Sv=function(t){let e=new Uint8Array(t.reduce(((t,e)=>t+Dr.encodingLength(e)),0)),n=0;for(const r of t)e=Dr.encode(r,e,n),n+=Dr.encodingLength(r);return e};class Tv{constructor(t,e,n){this._refCounter=1,this.cid=t,this.priority=e||1,this.wantType=n}inc(){this._refCounter+=1}dec(){this._refCounter=Math.max(0,this._refCounter-1)}hasRefs(){return this._refCounter>0}get[Symbol.toStringTag](){return`WantlistEntry <key: ${this.cid.toString(z.base58btc)}, priority: ${this.priority}, refs: ${this._refCounter}>`}equals(t){return this._refCounter===t._refCounter&&this.cid.equals(t.cid)&&this.priority===t.priority&&this.wantType===t.wantType}}const Av=c.Reader,Iv=c.Writer,Dv=c.util,Pv=c.roots["ipfs-bitswap"]||(c.roots["ipfs-bitswap"]={}),Nv=Pv.Message=(()=>{function t(t){if(this.blocks=[],this.payload=[],this.blockPresences=[],t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.wantlist=null,t.prototype.blocks=Dv.emptyArray,t.prototype.payload=Dv.emptyArray,t.prototype.blockPresences=Dv.emptyArray,t.prototype.pendingBytes=0,t.encode=function(t,e){if(e||(e=Iv.create()),null!=t.wantlist&&Object.hasOwnProperty.call(t,"wantlist")&&Pv.Message.Wantlist.encode(t.wantlist,e.uint32(10).fork()).ldelim(),null!=t.blocks&&t.blocks.length)for(var n=0;n<t.blocks.length;++n)e.uint32(18).bytes(t.blocks[n]);if(null!=t.payload&&t.payload.length)for(n=0;n<t.payload.length;++n)Pv.Message.Block.encode(t.payload[n],e.uint32(26).fork()).ldelim();if(null!=t.blockPresences&&t.blockPresences.length)for(n=0;n<t.blockPresences.length;++n)Pv.Message.BlockPresence.encode(t.blockPresences[n],e.uint32(34).fork()).ldelim();return null!=t.pendingBytes&&Object.hasOwnProperty.call(t,"pendingBytes")&&e.uint32(40).int32(t.pendingBytes),e},t.decode=function(t,e){t instanceof Av||(t=Av.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new Pv.Message;t.pos<n;){var s=t.uint32();switch(s>>>3){case 1:r.wantlist=Pv.Message.Wantlist.decode(t,t.uint32());break;case 2:r.blocks&&r.blocks.length||(r.blocks=[]),r.blocks.push(t.bytes());break;case 3:r.payload&&r.payload.length||(r.payload=[]),r.payload.push(Pv.Message.Block.decode(t,t.uint32()));break;case 4:r.blockPresences&&r.blockPresences.length||(r.blockPresences=[]),r.blockPresences.push(Pv.Message.BlockPresence.decode(t,t.uint32()));break;case 5:r.pendingBytes=t.int32();break;default:t.skipType(7&s)}}return r},t.fromObject=function(t){if(t instanceof Pv.Message)return t;var e=new Pv.Message;if(null!=t.wantlist){if("object"!=typeof t.wantlist)throw TypeError(".Message.wantlist: object expected");e.wantlist=Pv.Message.Wantlist.fromObject(t.wantlist)}if(t.blocks){if(!Array.isArray(t.blocks))throw TypeError(".Message.blocks: array expected");e.blocks=[];for(var n=0;n<t.blocks.length;++n)"string"==typeof t.blocks[n]?Dv.base64.decode(t.blocks[n],e.blocks[n]=Dv.newBuffer(Dv.base64.length(t.blocks[n])),0):t.blocks[n].length>=0&&(e.blocks[n]=t.blocks[n])}if(t.payload){if(!Array.isArray(t.payload))throw TypeError(".Message.payload: array expected");e.payload=[];for(n=0;n<t.payload.length;++n){if("object"!=typeof t.payload[n])throw TypeError(".Message.payload: object expected");e.payload[n]=Pv.Message.Block.fromObject(t.payload[n])}}if(t.blockPresences){if(!Array.isArray(t.blockPresences))throw TypeError(".Message.blockPresences: array expected");e.blockPresences=[];for(n=0;n<t.blockPresences.length;++n){if("object"!=typeof t.blockPresences[n])throw TypeError(".Message.blockPresences: object expected");e.blockPresences[n]=Pv.Message.BlockPresence.fromObject(t.blockPresences[n])}}return null!=t.pendingBytes&&(e.pendingBytes=0|t.pendingBytes),e},t.toObject=function(t,e){e||(e={});var n={};if((e.arrays||e.defaults)&&(n.blocks=[],n.payload=[],n.blockPresences=[]),e.defaults&&(n.wantlist=null,n.pendingBytes=0),null!=t.wantlist&&t.hasOwnProperty("wantlist")&&(n.wantlist=Pv.Message.Wantlist.toObject(t.wantlist,e)),t.blocks&&t.blocks.length){n.blocks=[];for(var r=0;r<t.blocks.length;++r)n.blocks[r]=e.bytes===String?Dv.base64.encode(t.blocks[r],0,t.blocks[r].length):e.bytes===Array?Array.prototype.slice.call(t.blocks[r]):t.blocks[r]}if(t.payload&&t.payload.length){n.payload=[];for(r=0;r<t.payload.length;++r)n.payload[r]=Pv.Message.Block.toObject(t.payload[r],e)}if(t.blockPresences&&t.blockPresences.length){n.blockPresences=[];for(r=0;r<t.blockPresences.length;++r)n.blockPresences[r]=Pv.Message.BlockPresence.toObject(t.blockPresences[r],e)}return null!=t.pendingBytes&&t.hasOwnProperty("pendingBytes")&&(n.pendingBytes=t.pendingBytes),n},t.prototype.toJSON=function(){return this.constructor.toObject(this,c.util.toJSONOptions)},t.getTypeUrl=function(t){return void 0===t&&(t="type.googleapis.com"),t+"/Message"},t.Wantlist=function(){function t(t){if(this.entries=[],t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.entries=Dv.emptyArray,t.prototype.full=!1,t.encode=function(t,e){if(e||(e=Iv.create()),null!=t.entries&&t.entries.length)for(var n=0;n<t.entries.length;++n)Pv.Message.Wantlist.Entry.encode(t.entries[n],e.uint32(10).fork()).ldelim();return null!=t.full&&Object.hasOwnProperty.call(t,"full")&&e.uint32(16).bool(t.full),e},t.decode=function(t,e){t instanceof Av||(t=Av.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new Pv.Message.Wantlist;t.pos<n;){var s=t.uint32();switch(s>>>3){case 1:r.entries&&r.entries.length||(r.entries=[]),r.entries.push(Pv.Message.Wantlist.Entry.decode(t,t.uint32()));break;case 2:r.full=t.bool();break;default:t.skipType(7&s)}}return r},t.fromObject=function(t){if(t instanceof Pv.Message.Wantlist)return t;var e=new Pv.Message.Wantlist;if(t.entries){if(!Array.isArray(t.entries))throw TypeError(".Message.Wantlist.entries: array expected");e.entries=[];for(var n=0;n<t.entries.length;++n){if("object"!=typeof t.entries[n])throw TypeError(".Message.Wantlist.entries: object expected");e.entries[n]=Pv.Message.Wantlist.Entry.fromObject(t.entries[n])}}return null!=t.full&&(e.full=Boolean(t.full)),e},t.toObject=function(t,e){e||(e={});var n={};if((e.arrays||e.defaults)&&(n.entries=[]),e.defaults&&(n.full=!1),t.entries&&t.entries.length){n.entries=[];for(var r=0;r<t.entries.length;++r)n.entries[r]=Pv.Message.Wantlist.Entry.toObject(t.entries[r],e)}return null!=t.full&&t.hasOwnProperty("full")&&(n.full=t.full),n},t.prototype.toJSON=function(){return this.constructor.toObject(this,c.util.toJSONOptions)},t.getTypeUrl=function(t){return void 0===t&&(t="type.googleapis.com"),t+"/Message.Wantlist"},t.WantType=function(){const t={},e=Object.create(t);return e[t[0]="Block"]=0,e[t[1]="Have"]=1,e}(),t.Entry=function(){function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.block=Dv.newBuffer([]),t.prototype.priority=0,t.prototype.cancel=!1,t.prototype.wantType=0,t.prototype.sendDontHave=!1,t.encode=function(t,e){return e||(e=Iv.create()),null!=t.block&&Object.hasOwnProperty.call(t,"block")&&e.uint32(10).bytes(t.block),null!=t.priority&&Object.hasOwnProperty.call(t,"priority")&&e.uint32(16).int32(t.priority),null!=t.cancel&&Object.hasOwnProperty.call(t,"cancel")&&e.uint32(24).bool(t.cancel),null!=t.wantType&&Object.hasOwnProperty.call(t,"wantType")&&e.uint32(32).int32(t.wantType),null!=t.sendDontHave&&Object.hasOwnProperty.call(t,"sendDontHave")&&e.uint32(40).bool(t.sendDontHave),e},t.decode=function(t,e){t instanceof Av||(t=Av.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new Pv.Message.Wantlist.Entry;t.pos<n;){var s=t.uint32();switch(s>>>3){case 1:r.block=t.bytes();break;case 2:r.priority=t.int32();break;case 3:r.cancel=t.bool();break;case 4:r.wantType=t.int32();break;case 5:r.sendDontHave=t.bool();break;default:t.skipType(7&s)}}return r},t.fromObject=function(t){if(t instanceof Pv.Message.Wantlist.Entry)return t;var e=new Pv.Message.Wantlist.Entry;switch(null!=t.block&&("string"==typeof t.block?Dv.base64.decode(t.block,e.block=Dv.newBuffer(Dv.base64.length(t.block)),0):t.block.length>=0&&(e.block=t.block)),null!=t.priority&&(e.priority=0|t.priority),null!=t.cancel&&(e.cancel=Boolean(t.cancel)),t.wantType){case"Block":case 0:e.wantType=0;break;case"Have":case 1:e.wantType=1}return null!=t.sendDontHave&&(e.sendDontHave=Boolean(t.sendDontHave)),e},t.toObject=function(t,e){e||(e={});var n={};return e.defaults&&(e.bytes===String?n.block="":(n.block=[],e.bytes!==Array&&(n.block=Dv.newBuffer(n.block))),n.priority=0,n.cancel=!1,n.wantType=e.enums===String?"Block":0,n.sendDontHave=!1),null!=t.block&&t.hasOwnProperty("block")&&(n.block=e.bytes===String?Dv.base64.encode(t.block,0,t.block.length):e.bytes===Array?Array.prototype.slice.call(t.block):t.block),null!=t.priority&&t.hasOwnProperty("priority")&&(n.priority=t.priority),null!=t.cancel&&t.hasOwnProperty("cancel")&&(n.cancel=t.cancel),null!=t.wantType&&t.hasOwnProperty("wantType")&&(n.wantType=e.enums===String?Pv.Message.Wantlist.WantType[t.wantType]:t.wantType),null!=t.sendDontHave&&t.hasOwnProperty("sendDontHave")&&(n.sendDontHave=t.sendDontHave),n},t.prototype.toJSON=function(){return this.constructor.toObject(this,c.util.toJSONOptions)},t.getTypeUrl=function(t){return void 0===t&&(t="type.googleapis.com"),t+"/Message.Wantlist.Entry"},t}(),t}(),t.Block=function(){function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.prefix=Dv.newBuffer([]),t.prototype.data=Dv.newBuffer([]),t.encode=function(t,e){return e||(e=Iv.create()),null!=t.prefix&&Object.hasOwnProperty.call(t,"prefix")&&e.uint32(10).bytes(t.prefix),null!=t.data&&Object.hasOwnProperty.call(t,"data")&&e.uint32(18).bytes(t.data),e},t.decode=function(t,e){t instanceof Av||(t=Av.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new Pv.Message.Block;t.pos<n;){var s=t.uint32();switch(s>>>3){case 1:r.prefix=t.bytes();break;case 2:r.data=t.bytes();break;default:t.skipType(7&s)}}return r},t.fromObject=function(t){if(t instanceof Pv.Message.Block)return t;var e=new Pv.Message.Block;return null!=t.prefix&&("string"==typeof t.prefix?Dv.base64.decode(t.prefix,e.prefix=Dv.newBuffer(Dv.base64.length(t.prefix)),0):t.prefix.length>=0&&(e.prefix=t.prefix)),null!=t.data&&("string"==typeof t.data?Dv.base64.decode(t.data,e.data=Dv.newBuffer(Dv.base64.length(t.data)),0):t.data.length>=0&&(e.data=t.data)),e},t.toObject=function(t,e){e||(e={});var n={};return e.defaults&&(e.bytes===String?n.prefix="":(n.prefix=[],e.bytes!==Array&&(n.prefix=Dv.newBuffer(n.prefix))),e.bytes===String?n.data="":(n.data=[],e.bytes!==Array&&(n.data=Dv.newBuffer(n.data)))),null!=t.prefix&&t.hasOwnProperty("prefix")&&(n.prefix=e.bytes===String?Dv.base64.encode(t.prefix,0,t.prefix.length):e.bytes===Array?Array.prototype.slice.call(t.prefix):t.prefix),null!=t.data&&t.hasOwnProperty("data")&&(n.data=e.bytes===String?Dv.base64.encode(t.data,0,t.data.length):e.bytes===Array?Array.prototype.slice.call(t.data):t.data),n},t.prototype.toJSON=function(){return this.constructor.toObject(this,c.util.toJSONOptions)},t.getTypeUrl=function(t){return void 0===t&&(t="type.googleapis.com"),t+"/Message.Block"},t}(),t.BlockPresenceType=function(){const t={},e=Object.create(t);return e[t[0]="Have"]=0,e[t[1]="DontHave"]=1,e}(),t.BlockPresence=function(){function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.cid=Dv.newBuffer([]),t.prototype.type=0,t.encode=function(t,e){return e||(e=Iv.create()),null!=t.cid&&Object.hasOwnProperty.call(t,"cid")&&e.uint32(10).bytes(t.cid),null!=t.type&&Object.hasOwnProperty.call(t,"type")&&e.uint32(16).int32(t.type),e},t.decode=function(t,e){t instanceof Av||(t=Av.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new Pv.Message.BlockPresence;t.pos<n;){var s=t.uint32();switch(s>>>3){case 1:r.cid=t.bytes();break;case 2:r.type=t.int32();break;default:t.skipType(7&s)}}return r},t.fromObject=function(t){if(t instanceof Pv.Message.BlockPresence)return t;var e=new Pv.Message.BlockPresence;switch(null!=t.cid&&("string"==typeof t.cid?Dv.base64.decode(t.cid,e.cid=Dv.newBuffer(Dv.base64.length(t.cid)),0):t.cid.length>=0&&(e.cid=t.cid)),t.type){case"Have":case 0:e.type=0;break;case"DontHave":case 1:e.type=1}return e},t.toObject=function(t,e){e||(e={});var n={};return e.defaults&&(e.bytes===String?n.cid="":(n.cid=[],e.bytes!==Array&&(n.cid=Dv.newBuffer(n.cid))),n.type=e.enums===String?"Have":0),null!=t.cid&&t.hasOwnProperty("cid")&&(n.cid=e.bytes===String?Dv.base64.encode(t.cid,0,t.cid.length):e.bytes===Array?Array.prototype.slice.call(t.cid):t.cid),null!=t.type&&t.hasOwnProperty("type")&&(n.type=e.enums===String?Pv.Message.BlockPresenceType[t.type]:t.type),n},t.prototype.toJSON=function(){return this.constructor.toObject(this,c.util.toJSONOptions)},t.getTypeUrl=function(t){return void 0===t&&(t="type.googleapis.com"),t+"/Message.BlockPresence"},t}(),t})(),Ov=Nv.Wantlist.WantType.Block,Lv=Nv.Wantlist.WantType.Have;class Cv{constructor(t,e){this.set=e?(0,wy.s)({name:"ipfs_bitswap_wantlist",metrics:e.metrics}):new Map,this._stats=t}get length(){return this.set.size}add(t,e,n){const r=t.toString(z.base58btc),s=this.set.get(r);s?(s.inc(),s.priority=e,s.wantType===Lv&&n===Ov&&(s.wantType=n)):(this.set.set(r,new Tv(t,e,n)),this._stats&&this._stats.push(null,"wantListSize",1))}remove(t){const e=t.toString(z.base58btc),n=this.set.get(e);n&&(n.dec(),n.hasRefs()||(this.set.delete(e),this._stats&&this._stats.push(null,"wantListSize",-1)))}removeForce(t){this.set.has(t)&&this.set.delete(t)}forEach(t){return this.set.forEach(t)}entries(){return this.set.entries()}sortedEntries(){return new Map((t=t=>t[1].key,e=Array.from(this.set.entries()),Array.prototype.slice.call(e,0).sort(((e,n)=>{const r=t(e),s=t(n);return r<s?-1:r>s?1:0}))));var t,e}contains(t){const e=t.toString(z.base58btc);return this.set.has(e)}get(t){const e=t.toString(z.base58btc);return this.set.get(e)}}Cv.Entry=Tv;const Mv=Cv.Entry;class xv{constructor(t,e,n,r,s){this.entry=new Mv(t,e,n),this.cancel=Boolean(r),this.sendDontHave=Boolean(s)}get cid(){return this.entry.cid}set cid(t){this.entry.cid=t}get priority(){return this.entry.priority}set priority(t){this.entry.priority=t}get wantType(){return this.entry.wantType}set wantType(t){this.entry.wantType=t}get[Symbol.toStringTag](){return`BitswapMessageEntry ${this.cid.toString(z.base58btc)} <cancel: ${this.cancel}, priority: ${this.priority}>`}equals(t){return this.cancel===t.cancel&&this.sendDontHave===t.sendDontHave&&this.wantType===t.wantType&&this.entry.equals(t.entry)}}const Bv=(t,e)=>{const n=["bitswap"];return e&&n.push(e),t&&n.push(`${t.toString().slice(0,8)}`),(0,i.kg)(n.join(":"))},zv=(t,e)=>{if(t.size!==e.size)return!1;for(const[n,r]of t){const t=e.get(n);if(void 0===t)return!1;if(r instanceof Uint8Array&&t instanceof Uint8Array&&!(0,vt.f)(r,t))return!1;if(r instanceof xv&&t instanceof xv&&!r.equals(t))return!1}return!0};class Uv{constructor(t){this.full=t,this.wantlist=new Map,this.blocks=new Map,this.blockPresences=new Map,this.pendingBytes=0}get empty(){return 0===this.blocks.size&&0===this.wantlist.size&&0===this.blockPresences.size}addEntry(t,e,n,r,s){null==n&&(n=Uv.WantType.Block);const o=t.toString(z.base58btc),i=this.wantlist.get(o);i?(i.wantType===n&&(i.priority=e),r&&(i.cancel=Boolean(r)),s&&(i.sendDontHave=Boolean(s)),n===Uv.WantType.Block&&i.wantType===Uv.WantType.Have&&(i.wantType=n)):this.wantlist.set(o,new xv(t,e,n,r,s))}addBlock(t,e){const n=t.toString(z.base58btc);this.blocks.set(n,e)}addHave(t){const e=t.toString(z.base58btc);this.blockPresences.has(e)||this.blockPresences.set(e,Uv.BlockPresenceType.Have)}addDontHave(t){const e=t.toString(z.base58btc);this.blockPresences.has(e)||this.blockPresences.set(e,Uv.BlockPresenceType.DontHave)}cancel(t){const e=t.toString(z.base58btc);this.wantlist.delete(e),this.addEntry(t,0,Uv.WantType.Block,!0,!1)}setPendingBytes(t){this.pendingBytes=t}serializeToBitswap100(){const t={wantlist:{entries:Array.from(this.wantlist.values()).map((t=>({block:t.cid.bytes,priority:Number(t.priority),cancel:Boolean(t.cancel)}))),full:!!this.full||void 0},blocks:Array.from(this.blocks.values())};return Nv.encode(t).finish()}serializeToBitswap110(){const t={wantlist:{entries:Array.from(this.wantlist.values()).map((t=>({block:t.cid.bytes,priority:Number(t.priority),wantType:t.wantType,cancel:Boolean(t.cancel),sendDontHave:Boolean(t.sendDontHave)}))),full:!!this.full||void 0},blockPresences:[],payload:[],pendingBytes:this.pendingBytes};for(const[e,n]of this.blocks.entries()){const r=Q.k0.parse(e),s=r.version,o=r.code,i=r.multihash.code,a=r.multihash.digest.length,c=Sv([s,o,i,a]);t.payload.push(new Nv.Block({prefix:c,data:n}))}for(const[e,n]of this.blockPresences)t.blockPresences.push(new Nv.BlockPresence({cid:Q.k0.parse(e).bytes,type:n}));return this.pendingBytes>0&&(t.pendingBytes=this.pendingBytes),Nv.encode(t).finish()}equals(t){return!!(this.full===t.full&&this.pendingBytes===t.pendingBytes&&zv(this.wantlist,t.wantlist)&&zv(this.blocks,t.blocks)&&zv(this.blockPresences,t.blockPresences))}get[Symbol.toStringTag](){const t=Array.from(this.wantlist.keys()),e=Array.from(this.blocks.keys());return`BitswapMessage <full: ${this.full}, list: ${t}, blocks: ${e}>`}}Uv.deserialize=async(t,e)=>{const n=Nv.decode(t),r=n.wantlist&&n.wantlist.full||!1,s=new Uv(r);return n.wantlist&&n.wantlist.entries&&n.wantlist.entries.forEach((t=>{if(!t.block)return;const e=Q.k0.decode(t.block);s.addEntry(e,t.priority||0,t.wantType,Boolean(t.cancel),Boolean(t.sendDontHave))})),n.blockPresences&&n.blockPresences.forEach((t=>{if(!t.cid)return;const e=Q.k0.decode(t.cid);t.type===Uv.BlockPresenceType.Have?s.addHave(e):s.addDontHave(e)})),n.blocks.length>0?(await Promise.all(n.blocks.map((async t=>{const e=await Qs.sha256.digest(t),n=Q.k0.createV0(e);s.addBlock(n,t)}))),s):n.payload.length>0?(await Promise.all(n.payload.map((async t=>{if(!t.prefix||!t.data)return;const n=Rv(t.prefix),r=n[0],o=n[1],i=n[2],a=i===Qs.sha256.code?Qs.sha256:e&&await e.getHasher(i);if(!a)throw new cg.s("Unknown hash algorithm","ERR_UNKNOWN_HASH_ALG");const c=await a.digest(t.data),l=Q.k0.create(r,o,c);s.addBlock(l,t.data)}))),s.setPendingBytes(n.pendingBytes),s):s},Uv.blockPresenceSize=t=>t.bytes.length+1,Uv.Entry=xv,Uv.WantType={Block:Nv.Wantlist.WantType.Block,Have:Nv.Wantlist.WantType.Have},Uv.BlockPresenceType={Have:Nv.BlockPresenceType.Have,DontHave:Nv.BlockPresenceType.DontHave};const jv=Math.pow(2,31)-1;var $v=n(24810);class Vv{constructor(t,e,n){this.peerId=e,this.network=n,this.refcnt=1,this._entries=[],this._log=Bv(t,"msgqueue"),this.sendEntries=(0,$v.Z)(this._sendEntries.bind(this),1)}addMessage(t){t.empty||this.send(t)}addEntries(t){this._entries=this._entries.concat(t),this.sendEntries()}_sendEntries(){if(!this._entries.length)return;const t=new Uv(!1);this._entries.forEach((e=>{e.cancel?t.cancel(e.cid):t.addEntry(e.cid,e.priority)})),this._entries=[],this.addMessage(t)}async send(t){try{await this.network.connectTo(this.peerId)}catch(t){return void this._log.error("cant connect to peer %s: %s",this.peerId.toString(),t.message)}this._log("sending message to peer %s",this.peerId.toString()),this.network.sendMessage(this.peerId,t).catch((t=>{this._log.error("send error: %s",t.message)}))}}class Hv{constructor(t,e,n,r){this.peers=(0,wy.s)({name:"ipfs_bitswap_want_manager_peers",metrics:r.metrics}),this.wantlist=new Cv(n,r),this.network=e,this._stats=n,this._peerId=t,this._log=Bv(t,"want")}_addEntries(t,e,n){const r=t.map(((t,n)=>new Uv.Entry(t,jv-n,Uv.WantType.Block,e)));r.forEach((t=>{t.cancel?n?this.wantlist.removeForce(t.cid.toString(z.base58btc)):this.wantlist.remove(t.cid):(this._log("adding to wl"),this.wantlist.add(t.cid,t.priority))}));for(const t of this.peers.values())t.addEntries(r)}_startPeerHandler(t){let e=this.peers.get(t.toString());if(e)return void e.refcnt++;e=new Vv(this._peerId,t,this.network);const n=new Uv(!0);for(const t of this.wantlist.entries())n.addEntry(t[1].cid,t[1].priority);return e.addMessage(n),this.peers.set(t.toString(),e),e}_stopPeerHandler(t){const e=this.peers.get(t.toString());e&&(e.refcnt--,e.refcnt>0||this.peers.delete(t.toString()))}wantBlocks(t,e={}){this._addEntries(t,!1),e&&e.signal&&e.signal.addEventListener("abort",(()=>{this.cancelWants(t)}))}unwantBlocks(t){this._log("unwant blocks: %s",t.length),this._addEntries(t,!0,!0)}cancelWants(t){this._log("cancel wants: %s",t.length),this._addEntries(t,!0)}connectedPeers(){return Array.from(this.peers.keys())}connected(t){this._startPeerHandler(t)}disconnected(t){this._stopPeerHandler(t)}start(){}stop(){this.peers.forEach((t=>this.disconnected(t.peerId)))}}const Fv="/ipfs/bitswap/1.0.0",Kv="/ipfs/bitswap/1.1.0",qv="/ipfs/bitswap/1.2.0";class Gv{constructor(t,e,n,r={}){this._log=Bv(t.peerId,"network"),this._libp2p=t,this._bitswap=e,this._protocols=[Fv],r.b100Only||(this._protocols.unshift(Kv),this._protocols.unshift(qv)),this._stats=n,this._running=!1,this._onPeerConnect=this._onPeerConnect.bind(this),this._onPeerDisconnect=this._onPeerDisconnect.bind(this),this._onConnection=this._onConnection.bind(this),this._hashLoader=r.hashLoader,this._maxInboundStreams=r.maxInboundStreams??32,this._maxOutboundStreams=r.maxOutboundStreams??128,this._incomingStreamTimeout=r.incomingStreamTimeout??3e4}async start(){this._running=!0,await this._libp2p.handle(this._protocols,this._onConnection,{maxInboundStreams:this._maxInboundStreams,maxOutboundStreams:this._maxOutboundStreams});const t=(0,Tm.a)({onConnect:this._onPeerConnect,onDisconnect:this._onPeerDisconnect});this._registrarIds=[];for(const e of this._protocols)this._registrarIds.push(await this._libp2p.register(e,t));this._libp2p.getConnections().forEach((t=>{this._onPeerConnect(t.remotePeer)}))}async stop(){if(this._running=!1,await this._libp2p.unhandle(this._protocols),null!=this._registrarIds){for(const t of this._registrarIds)this._libp2p.unregister(t);this._registrarIds=[]}}_onConnection({stream:t,connection:e}){if(!this._running)return;const n=new B.TimeoutController(this._incomingStreamTimeout);Promise.resolve().then((async()=>{this._log("incoming new bitswap %s connection from %p",t.stat.protocol,e.remotePeer),await Gs((0,zf.wJ)(t.source,n.signal),Pf(),(async t=>{for await(const r of t){try{const t=await Uv.deserialize(r.subarray(),this._hashLoader);await this._bitswap._receiveMessage(e.remotePeer,t)}catch(t){this._bitswap._receiveError(t);break}n.reset()}}))})).catch((e=>{this._log(e),t.abort(e)})).finally((()=>{n.clear(),t.close()}))}_onPeerConnect(t){this._bitswap._onPeerConnected(t)}_onPeerDisconnect(t){this._bitswap._onPeerDisconnected(t)}findProviders(t,e={}){return this._libp2p.contentRouting.findProviders(t,e)}async findAndConnect(t,e){const n=[];let r=0;for await(const s of this.findProviders(t,e))if(this._log(`connecting to provider ${s.id}`),n.push(this.connectTo(s.id,e).catch((t=>{this._log.error(t)}))),r++,3===r)break;await Promise.all(n)}async provide(t,e){await this._libp2p.contentRouting.provide(t,e)}async sendMessage(t,e){if(!this._running)throw new Error("network isn't running");const n=t.toString();this._log("sendMessage to %s",n,e);const r=await this._libp2p.dial(t),s=await r.newStream([qv,Kv,Fv]);await async function(t,e,n){try{let n;switch(t.stat.protocol){case Fv:n=e.serializeToBitswap100();break;case Kv:case qv:n=e.serializeToBitswap110();break;default:throw new Error("Unknown protocol: "+t.stat.protocol)}await Gs([n],Sf(),t)}catch(t){n(t)}finally{t.close()}}(s,e,this._log),this._updateSentStats(t,e.blocks)}async connectTo(t,e){if(!this._running)throw new Error("network isn't running");return this._libp2p.dial(t,e)}_updateSentStats(t,e){const n=t.toString();if(this._stats){for(const t of e.values())this._stats.push(n,"dataSent",t.length);this._stats.push(n,"blocksSent",e.size)}}}class Wv{constructor(t){this.partner=t,this.wantlist=new Cv,this.exchangeCount=0,this.sentToPeer=new Map,this.accounting={bytesSent:0,bytesRecv:0}}sentBytes(t){this.exchangeCount++,this.lastExchange=(new Date).getTime(),this.accounting.bytesSent+=t}receivedBytes(t){this.exchangeCount++,this.lastExchange=(new Date).getTime(),this.accounting.bytesRecv+=t}wants(t,e,n){this.wantlist.add(t,e,n)}cancelWant(t){this.wantlist.remove(t)}wantlistContains(t){return this.wantlist.get(t)}debtRatio(){return this.accounting.bytesSent/(this.accounting.bytesRecv+1)}}class Zv extends Map{constructor(t,e){super(),this._cmp=e||this._defaultSort,this._keys=[];for(const[e,n]of t||[])this.set(e,n)}update(t){if(t<0||t>=this._keys.length)return;const e=this._keys[t];this._keys.splice(t,1);const n=this._find(e);this._keys.splice(n,0,e)}set(t,e){if(this.has(t)){const e=this.indexOf(t);this._keys.splice(e,1)}super.set(t,e);const n=this._find(t);return this._keys.splice(n,0,t),this}clear(){super.clear(),this._keys=[]}delete(t){if(!this.has(t))return!1;const e=this.indexOf(t);return this._keys.splice(e,1),super.delete(t)}indexOf(t){if(!this.has(t))return-1;const e=this._find(t);if(this._keys[e]===t)return e;for(let n=1;n<this._keys.length;n++){if(this._keys[e+n]===t)return e+n;if(this._keys[e-n]===t)return e-n}return-1}_find(t){let e=0,n=this._keys.length;for(;e<n;){const r=e+n>>>1,s=this._kCmp(this._keys[r],t);if(s<0)e=r+1;else{if(!(s>0))return r;n=r}}return e}*keys(){for(const t of this._keys)yield t}*values(){for(const t of this._keys)yield this.get(t)}*entries(){for(const t of this._keys)yield[t,this.get(t)]}*[Symbol.iterator](){yield*this.entries()}forEach(t,e){if(t)for(const n of this._keys)t.apply(e,[[n,this.get(n)]])}_defaultSort(t,e){return t[0]<e[0]?-1:e[0]<t[0]?1:0}_kCmp(t,e){return this._cmp([t,this.get(t)],[e,this.get(e)])}}const Yv={hasNewInfo:()=>!1,merge(){}};class Jv{constructor(t=Yv){this._taskMerger=t,this._byPeer=new Zv([],Qv.compare)}pushTasks(t,e){let n=this._byPeer.get(t.toString());n||(n=new Qv(t,this._taskMerger)),n.pushTasks(e),this._byPeer.set(t.toString(),n)}popTasks(t){const e=this._head();if(void 0===e)return{tasks:[],pendingSize:0};const{tasks:n,pendingSize:r}=e.popTasks(t);if(0===n.length)return{tasks:n,pendingSize:r};const s=e.peerId;return e.isIdle()?this._byPeer.delete(s.toString()):this._byPeer.update(0),{peerId:s,tasks:n,pendingSize:r}}_head(){if(0!==this._byPeer.size)for(const[,t]of this._byPeer)return t}remove(t,e){const n=this._byPeer.get(e.toString());n&&n.remove(t)}tasksDone(t,e){const n=this._byPeer.get(t.toString());if(!n)return;const r=this._byPeer.indexOf(t.toString());for(const t of e)n.taskDone(t);this._byPeer.update(r)}}class Qv{constructor(t,e){this.peerId=t,this._taskMerger=e,this._activeTotalSize=0,this._pending=new Xv,this._active=new Set}pushTasks(t){for(const e of t)this._pushTask(e)}_pushTask(t){if(!this._taskHasMoreInfoThanActiveTasks(t))return;const e=this._pending.get(t.topic);if(e)return t.priority>e.priority&&this._pending.updatePriority(t.topic,t.priority),void this._taskMerger.merge(t,e);this._pending.add(t)}_taskHasMoreInfoThanActiveTasks(t){const e=[];for(const n of this._active)n.topic===t.topic&&e.push(n);return 0===e.length||this._taskMerger.hasNewInfo(t,e)}popTasks(t){let e=0;const n=[],r=this._pending.tasks();for(let s=0;s<r.length&&e<t;s++){const t=r[s];n.push(t),e+=t.size,this._pending.delete(t.topic),this._activeTotalSize+=t.size,this._active.add(t)}return{tasks:n,pendingSize:this._pending.totalSize}}taskDone(t){this._active.has(t)&&(this._activeTotalSize-=t.size,this._active.delete(t))}remove(t){this._pending.delete(t)}isIdle(){return 0===this._pending.length&&0===this._active.size}static compare(t,e){return 0===t[1]._pending.length?1:0===e[1]._pending.length?-1:t[1]._activeTotalSize===e[1]._activeTotalSize?e[1]._pending.length-t[1]._pending.length:t[1]._activeTotalSize-e[1]._activeTotalSize}}class Xv{constructor(){this._tasks=new Zv([],this._compare)}get length(){return this._tasks.size}get totalSize(){return[...this._tasks.values()].reduce(((t,e)=>t+e.task.size),0)}get(t){return(this._tasks.get(t)||{}).task}add(t){this._tasks.set(t.topic,{created:Date.now(),task:t})}delete(t){this._tasks.delete(t)}tasks(){return[...this._tasks.values()].map((t=>t.task))}updatePriority(t,e){const n=this._tasks.get(t);if(!n)return;const r=this._tasks.indexOf(t);n.task.priority=e,this._tasks.update(r)}_compare(t,e){return t[1].task.priority===e[1].task.priority?t[1].created-e[1].created:e[1].task.priority-t[1].task.priority}}const tk={hasNewInfo(t,e){let n=!1,r=!1;for(const t of e)t.data.haveBlock&&(n=!0),t.data.isWantBlock&&(r=!0);return!(r||!t.data.isWantBlock)||!(n||!t.data.haveBlock)},merge(t,e){const n=t.data,r=e.data;!r.haveBlock&&n.haveBlock&&(r.haveBlock=n.haveBlock,r.blockSize=n.blockSize),!r.isWantBlock&&n.isWantBlock&&(r.isWantBlock=!0,r.haveBlock&&!n.haveBlock||(r.haveBlock=n.haveBlock,e.size=t.size)),r.isWantBlock&&r.haveBlock&&(e.size=r.blockSize)}},ek=Uv.WantType;class nk{constructor(t,e,n,r,s,o={}){this._log=Bv(t,"engine"),this.blockstore=e,this.network=n,this._stats=r,this._opts=this._processOpts(o),this.ledgerMap=(0,wy.s)({name:"ipfs_bitswap_ledger_map",metrics:s.metrics}),this._running=!1,this._requestQueue=new Jv(tk)}_processOpts(t){return{maxSizeReplaceHasWithBlock:1024,targetMessageSize:16384,...t}}_scheduleProcessTasks(){setTimeout((()=>{this._processTasks()}))}async _processTasks(){if(!this._running)return;const{peerId:t,tasks:e,pendingSize:n}=this._requestQueue.popTasks(this._opts.targetMessageSize);if(0===e.length)return;const r=new Uv(!1);r.setPendingBytes(n);const s=[],o=new Map;for(const t of e){const e=Q.k0.parse(t.topic);t.data.haveBlock?t.data.isWantBlock?(s.push(e),o.set(t.topic,t.data)):r.addHave(e):r.addDontHave(e)}const i=await this._getBlocks(s);for(const[t,e]of o){const n=Q.k0.parse(t),s=i.get(t);s?r.addBlock(n,s):e.sendDontHave&&r.addDontHave(n)}if(r.empty)return t&&this._requestQueue.tasksDone(t,e),void this._scheduleProcessTasks();try{t&&await this.network.sendMessage(t,r);for(const[e,n]of i.entries())t&&this.messageSent(t,Q.k0.parse(e),n)}catch(t){this._log.error(t)}t&&this._requestQueue.tasksDone(t,e),this._scheduleProcessTasks()}wantlistForPeer(t){const e=t.toString(),n=this.ledgerMap.get(e);return n?n.wantlist.sortedEntries():new Map}ledgerForPeer(t){const e=t.toString(),n=this.ledgerMap.get(e);return n?{peer:n.partner,value:n.debtRatio(),sent:n.accounting.bytesSent,recv:n.accounting.bytesRecv,exchanged:n.exchangeCount}:null}peers(){return Array.from(this.ledgerMap.values()).map((t=>t.partner))}receivedBlocks(t){if(t.length){for(const e of this.ledgerMap.values())for(const n of t){const t=e.wantlistContains(n.cid);if(!t)continue;const r=n.data.length,s=this._sendAsBlock(t.wantType,r);let o=r;s||(o=Uv.blockPresenceSize(t.cid)),this._requestQueue.pushTasks(e.partner,[{topic:t.cid.toString(z.base58btc),priority:t.priority,size:o,data:{blockSize:r,isWantBlock:s,haveBlock:!0,sendDontHave:!1}}])}this._scheduleProcessTasks()}}async messageReceived(t,e){const n=this._findOrCreate(t);if(e.empty)return;if(e.full&&(n.wantlist=new Cv),this._updateBlockAccounting(e.blocks,n),0===e.wantlist.size)return void this._scheduleProcessTasks();const r=[],s=[];e.wantlist.forEach((t=>{t.cancel?(n.cancelWant(t.cid),r.push(t.cid)):(n.wants(t.cid,t.priority,t.wantType),s.push(t))})),this._cancelWants(t,r),await this._addWants(t,s),this._scheduleProcessTasks()}_cancelWants(t,e){for(const n of e)this._requestQueue.remove(n.toString(z.base58btc),t)}async _addWants(t,e){const n=await this._getBlockSizes(e.map((t=>t.cid))),r=[];for(const s of e){const e=s.cid.toString(z.base58btc),o=n.get(e);if(null==o)s.sendDontHave&&r.push({topic:e,priority:s.priority,size:Uv.blockPresenceSize(s.cid),data:{isWantBlock:s.wantType===ek.Block,blockSize:0,haveBlock:!1,sendDontHave:s.sendDontHave}});else{const t=this._sendAsBlock(s.wantType,o);let n=o;t||(n=Uv.blockPresenceSize(s.cid)),r.push({topic:e,priority:s.priority,size:n,data:{isWantBlock:t,blockSize:o,haveBlock:!0,sendDontHave:s.sendDontHave}})}this._requestQueue.pushTasks(t,r)}}_sendAsBlock(t,e){return t===ek.Block||e<=this._opts.maxSizeReplaceHasWithBlock}async _getBlockSizes(t){const e=await this._getBlocks(t);return new Map([...e].map((([t,e])=>[t,e.length])))}async _getBlocks(t){const e=new Map;return await Promise.all(t.map((async t=>{try{const n=await this.blockstore.get(t);e.set(t.toString(z.base58btc),n)}catch(e){"ERR_NOT_FOUND"!==e.code&&this._log.error("failed to query blockstore for %s: %s",t,e)}}))),e}_updateBlockAccounting(t,e){for(const n of t.values())this._log("got block (%s bytes)",n.length),e.receivedBytes(n.length)}messageSent(t,e,n){const r=this._findOrCreate(t);r.sentBytes(n.length),r.wantlist.remove(e)}numBytesSentTo(t){return this._findOrCreate(t).accounting.bytesSent}numBytesReceivedFrom(t){return this._findOrCreate(t).accounting.bytesRecv}peerDisconnected(t){this.ledgerMap.delete(t.toString())}_findOrCreate(t){const e=t.toString(),n=this.ledgerMap.get(e);if(n)return n;const r=new Wv(t);return this.ledgerMap.set(e,r),this._stats&&this._stats.push(e,"peerCount",1),r}start(){this._running=!0}stop(){this._running=!1}}const rk=t=>`unwant:${(0,H.B)(t.multihash.bytes,"base64")}`,sk=t=>`block:${(0,H.B)(t.multihash.bytes,"base64")}`;class ok extends Ep.EventEmitter{constructor(t){super(),this.setMaxListeners(1e3),this._log=Bv(t,"notif")}hasBlock(t,e){const n=sk(t);this._log(n),this.emit(n,e)}wantBlock(t,e={}){if(!t)throw new Error("Not a valid cid");const n=sk(t),r=rk(t);return this._log(`wantBlock:${t}`),new Promise(((s,o)=>{const i=()=>{this.removeListener(n,a),o(new Error(`Block for ${t} unwanted`))},a=t=>{this.removeListener(r,i),s(t)};this.once(r,i),this.once(n,a),e&&e.signal&&e.signal.addEventListener("abort",(()=>{this.removeListener(n,a),this.removeListener(r,i),o(new Error(`Want for ${t} aborted`))}))}))}unwantBlock(t){const e=rk(t);this._log(e),this.emit(e)}}var ik=n(63573);class ak extends Ep.EventEmitter{constructor(t,e){super(),this._options=e,this._queue=[],this._stats={},this._frequencyLastTime=Date.now(),this._frequencyAccumulators={},this._movingAverages={},this._update=this._update.bind(this),t.forEach((t=>{this._stats[t]=BigInt(0),this._movingAverages[t]={},this._options.movingAverageIntervals.forEach((e=>{(this._movingAverages[t][e]=ik(e)).push(this._frequencyLastTime,0)}))})),this._enabled=this._options.enabled}enable(){this._enabled=!0}disable(){this._disabled=!0}stop(){this._timeout&&clearTimeout(this._timeout)}get snapshot(){return Object.assign({},this._stats)}get movingAverages(){return Object.assign({},this._movingAverages)}push(t,e){this._enabled&&(this._queue.push([t,e,Date.now()]),this._resetComputeTimeout())}_resetComputeTimeout(){this._timeout&&clearTimeout(this._timeout),this._timeout=setTimeout(this._update,this._nextTimeout())}_nextTimeout(){const t=this._queue.length/this._options.computeThrottleMaxQueueSize;return Math.max(this._options.computeThrottleTimeout*(1-t),0)}_update(){if(this._timeout=null,this._queue.length){let t;for(;this._queue.length;){const e=t=this._queue.shift();e&&this._applyOp(e)}t&&this._updateFrequency(t[2]),this.emit("update",this._stats)}}_updateFrequency(t){const e=t-this._frequencyLastTime;e&&Object.keys(this._stats).forEach((n=>{this._updateFrequencyFor(n,e,t)})),this._frequencyLastTime=t}_updateFrequencyFor(t,e,n){const r=this._frequencyAccumulators[t]||0;this._frequencyAccumulators[t]=0;const s=r/e*1e3;let o=this._movingAverages[t];o||(o=this._movingAverages[t]={}),this._options.movingAverageIntervals.forEach((t=>{let e=o[t];e||(e=o[t]=ik(t)),e.push(n,s)}))}_applyOp(t){const e=t[0],n=t[1];if("number"!=typeof n)throw new Error(`invalid increment number: ${n}`);Object.prototype.hasOwnProperty.call(this._stats,e)||(this._stats[e]=BigInt(0)),this._stats[e]=BigInt(this._stats[e])+BigInt(n),this._frequencyAccumulators[e]||(this._frequencyAccumulators[e]=0),this._frequencyAccumulators[e]+=n}}const ck={enabled:!1,computeThrottleTimeout:1e3,computeThrottleMaxQueueSize:1e3,movingAverageIntervals:[6e4,3e5,9e5]};class lk extends Ep.EventEmitter{constructor(t,e=[],n=ck){super();const r=Object.assign({},ck,n);if("number"!=typeof r.computeThrottleTimeout)throw new Error("need computeThrottleTimeout");if("number"!=typeof r.computeThrottleMaxQueueSize)throw new Error("need computeThrottleMaxQueueSize");this._initialCounters=e,this._options=r,this._enabled=this._options.enabled,this._global=new ak(e,r),this._global.on("update",(t=>this.emit("update",t))),this._peers=(0,wy.s)({name:"ipfs_bitswap_stats_peers",metrics:t.metrics})}enable(){this._enabled=!0,this._options.enabled=!0,this._global.enable()}disable(){this._enabled=!1,this._options.enabled=!1,this._global.disable()}stop(){this._enabled=!1,this._global.stop();for(const t of this._peers)t[1].stop()}get snapshot(){return this._global.snapshot}get movingAverages(){return this._global.movingAverages}forPeer(t){const e="string"!=typeof t&&t.toString?t.toString():`${t}`;return this._peers.get(e)}push(t,e,n){if(this._enabled&&(this._global.push(e,n),t)){let r=this._peers.get(t);r||(r=new ak(this._initialCounters,this._options),this._peers.set(t,r)),r.push(e,n)}}disconnected(t){const e=t.toString(),n=this._peers.get(e);n&&(n.stop(),this._peers.delete(e))}}const uk=(t,e)=>async function*(){const n=await On(t);yield*n.sort(e)}();class dk{open(){return Promise.reject(new Error(".open is not implemented"))}close(){return Promise.reject(new Error(".close is not implemented"))}put(t,e,n){return Promise.reject(new Error(".put is not implemented"))}get(t,e){return Promise.reject(new Error(".get is not implemented"))}has(t,e){return Promise.reject(new Error(".has is not implemented"))}delete(t,e){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(t,e={}){for await(const{key:n,value:r}of t)await this.put(n,r,e),yield{key:n,value:r}}async*getMany(t,e={}){for await(const n of t)yield this.get(n,e)}async*deleteMany(t,e={}){for await(const n of t)await this.delete(n,e),yield n}batch(){let t=[],e=[];return{put(e,n){t.push({key:e,value:n})},delete(t){e.push(t)},commit:async n=>{await(0,Cn.Z)(this.putMany(t,n)),t=[],await(0,Cn.Z)(this.deleteMany(e,n)),e=[]}}}async*_all(t,e){throw new Error("._all is not implemented")}async*_allKeys(t,e){throw new Error("._allKeys is not implemented")}query(t,e){let n=this._all(t,e);if(null!=t.prefix&&(n=(0,Mn.Z)(n,(e=>e.key.toString().startsWith(t.prefix||"")))),Array.isArray(t.filters)&&(n=t.filters.reduce(((t,e)=>(0,Mn.Z)(t,e)),n)),Array.isArray(t.orders)&&(n=t.orders.reduce(((t,e)=>uk(t,e)),n)),null!=t.offset){let e=0;n=(0,Mn.Z)(n,(()=>e++>=(t.offset||0)))}return null!=t.limit&&(n=(0,xn.Z)(n,t.limit)),n}queryKeys(t,e){let n=this._allKeys(t,e);if(null!=t.prefix&&(n=(0,Mn.Z)(n,(e=>e.toString().startsWith(t.prefix||"")))),Array.isArray(t.filters)&&(n=t.filters.reduce(((t,e)=>(0,Mn.Z)(t,e)),n)),Array.isArray(t.orders)&&(n=t.orders.reduce(((t,e)=>uk(t,e)),n)),null!=t.offset){let e=0;n=(0,Mn.Z)(n,(()=>e++>=t.offset))}return null!=t.limit&&(n=(0,xn.Z)(n,t.limit)),n}}const hk={statsEnabled:!1,statsComputeThrottleTimeout:1e3,statsComputeThrottleMaxQueueSize:1e3},pk=["blocksReceived","dataReceived","dupBlksReceived","dupDataReceived","blocksSent","dataSent","providesBufferLength","wantListLength","peerCount"];class fk extends dk{constructor(t,e,n={}){super(),this._libp2p=t,this._log=Bv(this.peerId),this._options=Object.assign({},hk,n),this._stats=new lk(t,pk,{enabled:this._options.statsEnabled,computeThrottleTimeout:this._options.statsComputeThrottleTimeout,computeThrottleMaxQueueSize:this._options.statsComputeThrottleMaxQueueSize}),this.network=new Gv(t,this,this._stats,{hashLoader:n.hashLoader,maxInboundStreams:n.maxInboundStreams,maxOutboundStreams:n.maxOutboundStreams,incomingStreamTimeout:n.incomingStreamTimeout}),this.blockstore=e,this.engine=new nk(this.peerId,e,this.network,this._stats,t),this.wm=new Hv(this.peerId,this.network,this._stats,t),this.notifications=new ok(this.peerId),this.started=!1}isStarted(){return this.started}get peerId(){return this._libp2p.peerId}async _receiveMessage(t,e){try{await this.engine.messageReceived(t,e)}catch(t){this._log("failed to receive message",e)}if(0===e.blocks.size)return;const n=[];for(const[t,r]of e.blocks.entries()){const e=Q.k0.parse(t);n.push({wasWanted:this.wm.wantlist.contains(e),cid:e,data:r})}this.wm.cancelWants(n.filter((({wasWanted:t})=>t)).map((({cid:t})=>t))),await Promise.all(n.map((({cid:e,wasWanted:n,data:r})=>this._handleReceivedBlock(t,e,r,n))))}async _handleReceivedBlock(t,e,n,r){this._log("received block");const s=await this.blockstore.has(e);this._updateReceiveCounters(t.toString(),e,n,s),r&&await this.put(e,n)}_updateReceiveCounters(t,e,n,r){this._stats.push(t,"blocksReceived",1),this._stats.push(t,"dataReceived",n.length),r&&(this._stats.push(t,"dupBlksReceived",1),this._stats.push(t,"dupDataReceived",n.length))}_receiveError(t){this._log.error("ReceiveError: %s",t.message)}_onPeerConnected(t){this.wm.connected(t)}_onPeerDisconnected(t){this.wm.disconnected(t),this.engine.peerDisconnected(t),this._stats.disconnected(t)}enableStats(){this._stats.enable()}disableStats(){this._stats.disable()}wantlistForPeer(t,e){return this.engine.wantlistForPeer(t)}ledgerForPeer(t){return this.engine.ledgerForPeer(t)}async get(t,e={}){const n=(t,e)=>(this.wm.wantBlocks([t],e),this.notifications.wantBlock(t,e));let r=!1;const s=async(t,e)=>{try{return await this.blockstore.get(t,e)}catch(s){if("ERR_NOT_FOUND"!==s.code)throw s;return r||(r=!0,this.network.findAndConnect(t,e).catch((t=>this._log.error(t)))),n(t,e)}},o=new AbortController,i=e.signal?(0,dr.anySignal)([e.signal,o.signal]):o.signal;try{return await Promise.race([this.notifications.wantBlock(t,{signal:i}),s(t,{signal:i})])}finally{o.abort()}}async*getMany(t,e={}){for await(const n of t)yield this.get(n,e)}unwant(t){const e=Array.isArray(t)?t:[t];this.wm.unwantBlocks(e),e.forEach((t=>this.notifications.unwantBlock(t)))}cancelWants(t){this.wm.cancelWants(Array.isArray(t)?t:[t])}async put(t,e,n){await this.blockstore.put(t,e),this._sendHaveBlockNotifications(t,e)}async*putMany(t,e){for await(const{key:n,value:r}of this.blockstore.putMany(t,e))this._sendHaveBlockNotifications(n,r),yield{key:n,value:r}}_sendHaveBlockNotifications(t,e){this.notifications.hasBlock(t,e),this.engine.receivedBlocks([{cid:t,data:e}]),this.network.provide(t).catch((t=>{this._log.error("Failed to provide: %s",t.message)}))}getWantlist(){return this.wm.wantlist.entries()}peers(){return this.engine.peers()}stat(){return this._stats}async start(){this.wm.start(),await this.network.start(),this.engine.start(),this.started=!0}async stop(){this._stats.stop(),this.wm.stop(),await this.network.stop(),this.engine.stop(),this.started=!1}unwrap(){return this.blockstore}has(t){return this.blockstore.has(t)}}function yk(t){return t=t||new Error("Not Found"),a(t,"ERR_NOT_FOUND")}function gk(t){return t=t||new Error("Aborted"),a(t,"ERR_ABORTED")}class wk extends dk{constructor(t,e){super(),this.child=t,this.bitswap=e}open(){return this.child.open()}close(){return this.child.close()}unwrap(){return this.child}async put(t,e,n={}){await this.has(t)||(this.bitswap.isStarted()?await this.bitswap.put(t,e,n):await this.child.put(t,e,n))}async*putMany(t,e={}){const n=(0,Mn.Z)(t,(async({key:t})=>!await this.has(t)));this.bitswap.isStarted()?yield*this.bitswap.putMany(n,e):yield*this.child.putMany(n,e)}async get(t,e={}){return!await this.has(t)&&this.bitswap.isStarted()?this.bitswap.get(t,e):this.child.get(t,e)}async*getMany(t,e={}){const n=(0,zn.d)({objectMode:!0}),r=(0,zn.d)({objectMode:!0});Promise.resolve().then((async()=>{for await(const e of t)!await this.has(e)&&this.bitswap.isStarted()?n.push(e):r.push(e);n.end(),r.end()})),yield*(0,Vs.Z)(this.bitswap.getMany(n,e),this.child.getMany(r,e))}async delete(t,e){await this.child.delete(t,e)}async*deleteMany(t,e){yield*this.child.deleteMany(t,e)}async has(t,e={}){return this.child.has(t,e)}async*query(t,e={}){yield*this.child.query(t,e)}async*queryKeys(t,e={}){yield*this.child.queryKeys(t,e)}}class mk{constructor(t,e,n,r,s){this.peerId=t,this.libp2p=e,this.bitswap=n,this.repo=r,this.blockstore=s}static async start({peerId:t,repo:e,print:n,hashers:r,options:s}){e.closed&&await e.open();const o=await e.config.getAll(),i=await dv({options:s,repo:e,peerId:t,multiaddrs:bk(t,o),config:o,keychainConfig:void 0});await i.start();for(const t of i.getMultiaddrs())n(`Swarm listening on ${t.toString()}`);const a=((t,e,n={})=>new fk(t,e,n))(i,e.blocks,{statsEnabled:!0,hashLoader:r,maxInboundStreams:1024,maxOutboundStreams:1024});await a.start();const c=new wk(e.blocks,a);return e.blocks=c,e.pins.blockstore=c,new mk(t,i,a,e,c)}static async stop(t){t.repo.blocks=t.blockstore.unwrap(),t.repo.pins.blockstore=t.blockstore.unwrap(),await t.bitswap.stop(),await t.libp2p.stop()}}const bk=(t,e)=>{const n=t.toString(),r=[],s=e.Addresses&&e.Addresses.Swarm||[];for(const t of s){let e=(0,$.HM)(t);if(e.protoCodes().includes(Ek))throw a(new Error("websocket-star swarm addresses are not supported. See https://github.com/ipfs/js-ipfs/issues/2779"),"ERR_WEBSOCKET_STAR_SWARM_ADDR_NOT_SUPPORTED");const s=e.getPeerId();s&&s!==n&&(e=e.encapsulate(`/p2p/${n}`)),r.push(e)}return r},Ek=479;class _k{constructor({network:t}){this.addrs=function({network:t}){return(0,Ee.a)((async function(e={}){const n=[],{libp2p:r}=await t.use(e);return await r.peerStore.forEach((t=>{n.push({id:t.id,addrs:t.addresses.map((t=>t.multiaddr))})})),n}))}({network:t}),this.connect=function({network:t}){return(0,Ee.a)((async function(e,n={}){const{libp2p:r}=await t.use(n);await r.dial(e,n)}))}({network:t}),this.disconnect=function({network:t}){return(0,Ee.a)((async function(e,n={}){const{libp2p:r}=await t.use(n);await r.hangUp(e)}))}({network:t}),this.localAddrs=function({network:t}){return(0,Ee.a)((async function(e={}){const{libp2p:n}=await t.use(e);return n.getMultiaddrs()}))}({network:t}),this.peers=function({network:t}){return(0,Ee.a)((async function(e={}){const{libp2p:n}=await t.use(e);if(e.verbose){const t=[];for(const r of n.getConnections()){const n={addr:r.remoteAddr,peer:r.remotePeer};(e.verbose||e.direction)&&(n.direction=r.stat.direction),e.verbose&&(n.muxer=r.stat.multiplexer,n.latency="n/a",n.streams=[]),t.push(n)}return t}const r=new Map;for(const t of n.getConnections()){const e={addr:t.remoteAddr,peer:t.remotePeer};r.set(t.remotePeer.toString(),e)}return Array.from(r.values())}))}({network:t})}}const vk={success:!0,time:0,text:""};const kk="/ipns/";function Rk(t){let e;if(t.startsWith(kk)&&(t=t.substring(kk.length)),"1"!==t[0]&&"Q"!==t[0]||(t=`z${t}`),"z"===t[0]&&(e=z.base58btc.decode(t)),"k"===t[0]&&(e=rr.base36.decode(t)),!e)throw new Error("Could not parse string");if(1!==e[0]&&114!==e[1]&&(e=(0,tt.z)([[1,114],e])),40!==e.length)throw new Error("Incorrect length "+e.length);return(0,tt.z)([(0,x.m)(kk),e.subarray(2)])}const Sk=async(t,e,n)=>{const r=await t.use(n);if(null!=r.libp2p.dht)return r;{const t=async function*(){yield{from:e,name:"QUERY_ERROR",type:3,error:new M("dht not enabled")}};return{libp2p:{dht:{get:t,put:t,findProviders:t,findPeer:t,provide:t,getClosestPeers:t}}}}};const Tk=async()=>{throw new M("pubsub not enabled")};var Ak=n(25108);const Ik=s.Z.bind({ignoreUndefined:!0}),Dk=(0,i.kg)("ipfs");class Pk{constructor({print:t,storage:e,codecs:n,options:r}){const{peerId:s,repo:o,keychain:i}=e,c=De.create(mk),l=function(t={}){if(t.enabled=Boolean(t.enabled),t.addresses=t.addresses||[],t.cache=t.cache||1e3,!t.enabled||!t.addresses.length){Ba("preload disabled");const t=()=>{};return Object.assign(t,{start:()=>{},stop:()=>{}})}let e=!0,n=[];const r=t.addresses.map((t=>(0,Ca.k)(t))),s=In(t.cache),o=async t=>{try{if(e)throw new Error(`preload ${t} but preloader is not started`);const o=t.toString();if(s.has(o))return;s.set(o,!0);const i=(0,Ma.Z)(r);let a=!1;const c=Date.now();for(const t of i){if(e)throw new Error(`preload aborted for ${o}`);let r;try{r=new AbortController,n=n.concat(r),await(0,xa.M)(`${t}/api/v0/refs?r=true&arg=${encodeURIComponent(o)}`,{signal:r.signal}),a=!0}catch(t){"aborted"!==t.type&&Ba.error(t)}finally{n=n.filter((t=>t!==r))}if(a)break}Ba(`${a?"":"un"}successfully preloaded ${o} in ${Date.now()-c}ms`)}catch(t){Ba.error(t)}};return o.start=()=>{e=!1},o.stop=()=>{e=!0,Ba(`aborting ${n.length} pending preload request(s)`),n.forEach((t=>t.abort())),n=[]},o}(r.preload),u=(0,Ee.a)((async(t,e={recursive:!0})=>{if("string"!=typeof t)throw new Error("Invalid arguments, domain must be a string");return t=function(t){return t.endsWith(".eth")&&(t=t.replace(/.eth$/,".eth.link")),t}(t),(0,Pe.D)(t,e)})),d=function({network:t}){return()=>{const e=t.try();return null!=e&&Boolean(e.libp2p.isStarted())}}({network:c}),h=new Qn(r),p=Object.values(A.kq);(r.ipld&&r.ipld.hashers?r.ipld.hashers:[]).forEach((t=>p.push(t))),this.hashers=new Fl.d({hashers:p,loadHasher:r.ipld&&r.ipld.loadHasher});const f=Object.values(A.gh);(r.ipld&&r.ipld.bases?r.ipld.bases:[]).forEach((t=>f.push(t))),this.bases=new Vl.x({bases:f,loadBase:r.ipld&&r.ipld.loadBase});const y=new Be({repo:o,codecs:n}),g=new Zs({codecs:n,hashers:this.hashers,preload:l,repo:o}),w=new ur({dns:u,ipns:h,repo:o,codecs:n,peerId:s,isOnline:d,keychain:i,options:r}),m=Oe({repo:o,codecs:n,bases:this.bases,name:w}),b=new La({repo:o,codecs:n,hashers:this.hashers,preload:l}),E=Object.assign(fr({repo:o,codecs:n,resolve:m,preload:l}),{local:mr({repo:e.repo})}),{add:_,addAll:v,cat:k,get:R,ls:S}=new Hi({preload:l,repo:o,options:r.EXPERIMENTAL,hashers:this.hashers}),T=kl({repo:o,preload:l,hashers:this.hashers,options:r}),I=function({preload:t,files:e,options:n={}}){if(n.interval=n.interval||3e4,!n.enabled){za("MFS preload disabled");const t=async()=>{};return{start:t,stop:t}}let r,s="";const o=async()=>{try{const n=await e.stat("/"),r=n.cid.toString();s!==r&&(za(`preloading updated MFS root ${s} -> ${n.cid}`),await t(n.cid),s=r)}catch(t){za.error("failed to preload MFS root",t)}finally{r=setTimeout(o,n.interval)}};return{async start(){const t=await e.stat("/");s=t.cid.toString(),za(`monitoring MFS root ${t.cid}`),r=setTimeout(o,n.interval)},stop(){clearTimeout(r)}}}({files:T,preload:l,options:r.preload});this.preload=l,this.name=w,this.ipns=h,this.pin=y,this.resolve=m,this.block=g,this.refs=E,this.start=function({network:t,preload:e,peerId:n,keychain:r,repo:s,ipns:o,mfsPreload:i,print:a,hashers:c,options:l}){return async()=>{const{libp2p:u}=await De.start(t,{peerId:n,repo:s,print:a,hashers:c,options:l});await Promise.all([o.startOnline({keychain:r,libp2p:u,peerId:n,repo:s}),e.start(),i.start()])}}({network:c,peerId:s,repo:o,preload:l,ipns:h,mfsPreload:I,print:t,keychain:i,hashers:this.hashers,options:r}),this.stop=function({network:t,preload:e,ipns:n,repo:r,mfsPreload:s}){return async()=>{await Promise.all([e.stop(),n.stop(),s.stop()]),await De.stop(t),await r.close()}}({network:c,preload:l,mfsPreload:I,ipns:h,repo:o}),this.dht=function({network:t,repo:e,peerId:n}){const{get:r,put:s,findProvs:o,findPeer:i,provide:c,query:l}={async*get(e,r={}){const{libp2p:s}=await Sk(t,n,r),o=e instanceof Uint8Array?e:Rk(e);if(null==s.dht)throw a(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");yield*s.dht.get(o,r)},async*put(e,r,s){const{libp2p:o}=await Sk(t,n,s),i=e instanceof Uint8Array?e:Rk(e);if(null==o.dht)throw a(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");yield*o.dht.put(i,r,s)},async*findProvs(e,r={}){const{libp2p:s}=await Sk(t,n,r);if(null==s.dht)throw a(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");yield*s.dht.findProviders(e,{signal:r.signal})},async*findPeer(e,r={}){const{libp2p:s}=await Sk(t,n,r);if(null==s.dht)throw a(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");yield*s.dht.findPeer(e,{signal:r.signal})},async*provide(r,s={recursive:!1}){const{libp2p:o}=await Sk(t,n,s);if(!await e.blocks.has(r))throw a(new Error("block(s) not found locally, cannot provide"),"ERR_BLOCK_NOT_FOUND");if(s.recursive)throw a(new Error("not implemented yet"),"ERR_NOT_IMPLEMENTED_YET");if(null==o.dht)throw a(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");yield*o.dht.provide(r)},async*query(e,r={}){const{libp2p:s}=await Sk(t,n,r);let o;const i=Q.k0.asCID(e);if(o=null!=i?i.multihash.bytes:(0,Ne.jE)(e.toString()).toBytes(),null==s.dht)throw a(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");yield*s.dht.getClosestPeers(o,r)}};return{get:(0,Ee.a)(r),put:(0,Ee.a)(s),findProvs:(0,Ee.a)(o),findPeer:(0,Ee.a)(i),provide:(0,Ee.a)(c),query:(0,Ee.a)(l)}}({network:c,repo:o,peerId:s}),this.pubsub=function({network:t,config:e}){const n=$n(e||{},"Pubsub.Enabled",!0),r={};let s;return{subscribe:n?(0,Ee.a)((async function(e,n,o={}){const{libp2p:i}=await t.use(o);i.pubsub.subscribe(e),null==s&&(s=t=>{const e=t.detail;r[e.topic]&&r[e.topic].forEach((t=>{"function"!=typeof t?null!=t&&null!=t.handleEvent&&t.handleEvent(e):t(e)}))},i.pubsub.addEventListener("message",s)),null!=n&&(null==r[e]&&(r[e]=[]),r[e].push(n))})):Tk,unsubscribe:n?(0,Ee.a)((async function(e,n,o={}){const{libp2p:i}=await t.use(o);null!=n&&null!=r[e]&&(r[e]=r[e].filter((t=>t!==n)),0===r[e].length&&delete r[e]),"function"!=typeof n&&delete r[e],null==r[e]&&i.pubsub.unsubscribe(e),0===Object.keys(r).length&&(i.pubsub.removeEventListener("message",s),s=void 0)})):Tk,publish:n?(0,Ee.a)((async function(e,n,r={}){const{libp2p:s}=await t.use(r);if(!n)throw a(new Error('argument "data" is required'),"ERR_ARG_REQUIRED");await s.pubsub.publish(e,n)})):Tk,ls:n?(0,Ee.a)((async function(e={}){const{libp2p:n}=await t.use(e);return n.pubsub.getTopics()})):Tk,peers:n?(0,Ee.a)((async function(e,n={}){const{libp2p:r}=await t.use(n);return r.pubsub.getSubscribers(e)})):Tk}}({network:c,config:r.config}),this.dns=u,this.isOnline=d,this.id=qi({network:c,peerId:s}),this.version=function({repo:t}){return(0,Ee.a)((async function(e={}){const n=await t.version.get();return{version:Fi,commit:"",repo:`${n}`,"ipfs-core":Fi,"interface-ipfs-core":"^0.158.0"}}))}({repo:o}),this.bitswap=new Er({network:c}),this.bootstrap=new Us({repo:o}),this.config=function({repo:t}){return{getAll:(0,Ee.a)((async function(e={}){return t.config.getAll(e)})),get:(0,Ee.a)((async function(e,n){return e?t.config.get(e,n):Promise.reject(new Error("key argument is required"))})),set:(0,Ee.a)((async function(e,n,r){return t.config.set(e,n,r)})),replace:(0,Ee.a)((async function(e,n){return t.config.replace(e,n)})),profiles:{apply:(0,Ee.a)((async function(e,n={dryRun:!1}){const{dryRun:r}=n,s=Wi[e];if(!s)throw new Error(`No profile with name '${e}' exists`);try{const e=await t.config.getAll(n);let o=JSON.parse(JSON.stringify(e));return o=s.transform(o),r||await t.config.replace(o,n),delete e.Identity.PrivKey,delete o.Identity.PrivKey,{original:e,updated:o}}catch(t){throw Zi(t),new Error(`Could not apply profile '${e}' to config: ${t.message}`)}})),list:(0,Ee.a)(Yi)}}}({repo:o}),this.ping=function({network:t}){return(0,Ee.a)((async function*(e,n={}){const{libp2p:r}=await t.use();n.count=n.count||10;const s=await r.peerStore.get(e);let o=s&&s.id;if(!o){yield{...vk,text:`Looking up peer ${e}`};const t=await r.peerRouting.findPeer(e);o=t&&t.id}if(!o)throw new Error("Peer was not found");yield{...vk,text:`PING ${o.toString()}`};let i=0,a=0;for(let t=0;t<n.count;t++)try{const t=await r.ping(o);a+=t,i++,yield{...vk,time:t}}catch(t){yield{...vk,success:!1,text:t.toString()}}if(i){const t=a/i;yield{...vk,text:`Average latency: ${t}ms`}}}))}({network:c}),this.add=_,this.addAll=v,this.cat=k,this.get=R,this.ls=S,this.dag=b,this.files=T,this.key=new Sl({keychain:i}),this.object=new Nl({preload:l,codecs:n,repo:o}),this.repo=new Ml({repo:o,hashers:this.hashers}),this.stats=new Bl({repo:o,network:c}),this.swarm=new _k({network:c}),Object.defineProperty(this,"libp2p",{get(){const t=c.try();return t?t.libp2p:void 0}});const D=()=>Promise.reject(a(new Error("Not implemented"),"ERR_NOT_IMPLEMENTED"));this.commands=D,this.diag={cmds:D,net:D,sys:D},this.log={level:D,ls:D,tail:async function*(){throw a(new Error("Not implemented"),"ERR_NOT_IMPLEMENTED")}},this.mount=D,this.codecs=n}async init(){throw new N}}n(52596);const Nk=async function(t={}){const e=(t=Ik({start:!0,EXPERIMENTAL:{},preload:{enabled:!o.isTest,addresses:["/dns4/node0.preload.ipfs.io/https","/dns4/node1.preload.ipfs.io/https","/dns4/node2.preload.ipfs.io/https","/dns4/node3.preload.ipfs.io/https"]}},t)).init||{},n={name:T.identity.name,code:T.identity.code,encode:t=>t,decode:t=>t},r=Object.values(A.QB);[v,k,R,S,n].concat(t.ipld&&t.ipld.codecs||[]).forEach((t=>r.push(t)));const s=new Hl.w({codecs:r,loadCodec:t.ipld&&t.ipld.loadCodec}),i=t.silent?Dk:Ak.log;Dk("creating repo");const c=await yv.start(i,s,t);Dk("getting repo config");const l=await c.repo.config.getAll(),u=new Pk({storage:c,print:i,codecs:s,options:{...t,config:l}});if(Dk("starting preload"),await u.preload.start(),Dk("starting storage"),u.ipns.startOffline(c),c.isNew&&!e.emptyRepo){const t=await(async t=>{const e=v.encode({Data:new _({type:"directory"}).marshal(),Links:[]}),n=await t.block.put(e,{mhtype:"sha2-256",format:"dag-pb"});return await t.pin.add(n),n})(u);if(Dk("adding default assets"),await(0,I.L)({addAll:u.addAll,print:i}),Dk("initializing IPNS keyspace"),null==c.peerId.publicKey)throw a(new Error("Public key missing"),"ERR_MISSING_PUBLIC_KEY");const e=new B.TimeoutController(3e4);try{await u.ipns.initializeKeyspace(c.peerId,(0,x.m)(`/ipfs/${t}`),{signal:e.signal})}finally{e.clear()}}return!1!==t.start&&(Dk("starting node"),await u.start()),u}},45895:function(t,e,n){"use strict";n.d(e,{_:function(){return r}});const r=12},68919:function(t,e,n){"use strict";n.d(e,{AJ:function(){return a},CK:function(){return o},_I:function(){return c},dR:function(){return s},gg:function(){return r},uF:function(){return i}});class r extends Error{constructor(t){super(t),this.name="LockExistsError",this.code=r.code}}r.code="ERR_LOCK_EXISTS";class s extends Error{constructor(t){super(t),this.name="NotFoundError",this.code=s.code}}s.code="ERR_NOT_FOUND";class o extends Error{constructor(t){super(t),this.name="InvalidRepoVersionError",this.code=o.code}}o.code="ERR_INVALID_REPO_VERSION";const i="ERR_REPO_NOT_INITIALIZED",a="ERR_REPO_ALREADY_OPEN",c="ERR_REPO_ALREADY_CLOSED"},63204:function(t,e,n){"use strict";n.d(e,{x:function(){return Ze}});var r={};n.r(r),n.d(r,{InvalidValueError:function(){return $t},MissingRepoOptionsError:function(){return Vt},NonReversibleMigrationError:function(){return zt},NotInitializedRepoError:function(){return Ut},RequiredParameterError:function(){return jt}});var s=n(91589),o=n(11227),i=n(32114),a=n(38161),c=n(66699),l=n(95918),u=n(14249),d=n(53137),h=n(29094);const p=o("ipfs:repo:migrator:migration-8");function f(t){return t.child?f(t.child):t}function y(t){try{const e=u.base32.decode(`b${t.toString().toLowerCase().slice(1)}`),n=a.k0.decode(e).multihash.bytes,r=u.base32.encode(n).slice(1).toUpperCase();return new c.s(`/${r}`,!1)}catch(e){return t}}function g(t){try{const e=u.base32.decode(`b${t.toString().toLowerCase().slice(1)}`),n=h.Jx(e),r=u.base32.encode(a.k0.createV1(d.code,n).bytes).slice(1);return new c.s(`/${r.toUpperCase()}`,!1)}catch{return t}}async function w(t,e,n){const r=t.blocks;await r.open();const s=f(r),o=await(0,l.Z)(s.queryKeys({filters:[t=>n(t).toString()!==t.toString()]}));try{let t=0;for await(const r of s.query({})){const i=n(r.key);i.toString()!==r.key.toString()&&(t+=1,p(`Migrating Block from ${r.key} to ${i}`,await s.has(r.key)),await s.delete(r.key),await s.put(i,r.value),e(t/o*100,`Migrated Block from ${r.key} to ${i}`))}}finally{await r.close()}}const m={version:8,description:"Transforms key names into base32 encoding and converts Block store to use bare multihashes encoded as base32",migrate:(t,e=(()=>{}))=>w(t,e,y),revert:(t,e=(()=>{}))=>w(t,e,g)};var b=n(33808),E=n(64936),_=n(67412);const v=_.Reader,k=_.Writer,R=(_.util,_.roots.default||(_.roots.default={})),S=R.ipfs=(()=>{const t={};return t.pin=function(){const t={};return t.Set=function(){function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.version=0,t.prototype.fanout=0,t.prototype.seed=0,t.encode=function(t,e){return e||(e=k.create()),null!=t.version&&Object.hasOwnProperty.call(t,"version")&&e.uint32(8).uint32(t.version),null!=t.fanout&&Object.hasOwnProperty.call(t,"fanout")&&e.uint32(16).uint32(t.fanout),null!=t.seed&&Object.hasOwnProperty.call(t,"seed")&&e.uint32(29).fixed32(t.seed),e},t.decode=function(t,e){t instanceof v||(t=v.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new R.ipfs.pin.Set;t.pos<n;){var s=t.uint32();switch(s>>>3){case 1:r.version=t.uint32();break;case 2:r.fanout=t.uint32();break;case 3:r.seed=t.fixed32();break;default:t.skipType(7&s)}}return r},t.fromObject=function(t){if(t instanceof R.ipfs.pin.Set)return t;var e=new R.ipfs.pin.Set;return null!=t.version&&(e.version=t.version>>>0),null!=t.fanout&&(e.fanout=t.fanout>>>0),null!=t.seed&&(e.seed=t.seed>>>0),e},t.toObject=function(t,e){e||(e={});var n={};return e.defaults&&(n.version=0,n.fanout=0,n.seed=0),null!=t.version&&t.hasOwnProperty("version")&&(n.version=t.version),null!=t.fanout&&t.hasOwnProperty("fanout")&&(n.fanout=t.fanout),null!=t.seed&&t.hasOwnProperty("seed")&&(n.seed=t.seed),n},t.prototype.toJSON=function(){return this.constructor.toObject(this,_.util.toJSONOptions)},t}(),t}(),t})();var T=n(96132),A=n(33497);const I=new c.s("/local/pins"),D=256,P=8192,N=a.k0.parse("QmdfTbBqBPQ7VNxZEYEj14VmRuZBkqFbiwReogJgS1zR1n"),O="direct",L="recursive";function C(t){return new c.s(`/${u.base32.encode(t.multihash.bytes).toUpperCase().substring(1)}`)}var M=n(41690),x=n(20295),B=n(49784),z=n(77408),U=n(27353);const j=S.pin.Set;async function*$(t,e){const n=function(t){const e=t.Data;if(!e)throw new Error("No data present");const n=A.decode(e),r=A.decode.bytes??0;if(r<=0)throw new Error("Invalid Set header length");if(r+n>e.length)throw new Error("Impossibly large set header length");const s=e.slice(r,n+r),o=j.toObject(j.decode(s),{defaults:!1,arrays:!0,longs:Number,objects:!1});if(1!==o.version)throw new Error(`Unsupported Set version: ${o.version}`);if(o.fanout>t.Links.length)throw new Error("Impossibly large fanout");return{header:o,data:e.slice(n+r)}}(e);let r=0;for(const s of e.Links){if(r<n.header.fanout){const e=s.Hash;if(!N.equals(e)){const n=await t.get(e),r=b.decode(n);yield*$(t,r)}}else yield s.Hash;r++}}async function*V(t,e,n){const r=e.Links.find((t=>t.Name===n));if(!r)throw new Error("No link found with name "+n);const s=await t.get(r.Hash),o=b.decode(s);yield*$(t,o)}function H(t,e){return async function e(n,r){const s=j.encode({version:1,fanout:D,seed:r}).finish(),o=A.encode(s.length),i=(0,M.z)([o,s]),c=[];for(let t=0;t<D;t++)c.push({Name:"",Tsize:1,Hash:N});if(n.length<=P){const t=n.map((t=>({link:{Name:"",Tsize:1,Hash:t.key},data:t.data||new Uint8Array}))).sort(((t,e)=>(0,x.q)(t.link.Hash.bytes,e.link.Hash.bytes))),e=c.concat(t.map((t=>t.link)));return{Data:(0,M.z)([i,...t.map((t=>t.data))]),Links:e}}{const t=n.reduce(((t,e)=>{const n=function(t,e){const n=new Uint8Array(4);new DataView(n.buffer).setUint32(0,t,!0);const r=(0,z.m)(e.toString()),s=(0,M.z)([n,r],n.byteLength+r.byteLength);return T((0,B.B)(s))}(r,e.key)%D;return t[n]=n in t?t[n].concat([e]):[e],t}),[]);let s=0;for(const n of t){const t=await e(n,r+1);await l(t,s),s++}return{Data:i,Links:c}}async function l(e,n){const r=b.encode(e),s=await U.sha256.digest(r),o=a.k0.createV0(s);await t.put(o,r);const i=e.Links.reduce(((t,e)=>t+(e.Tsize||0)),0)+r.length;c[n]={Name:"",Tsize:i,Hash:o}}}(e,0)}async function F(t,e,n){const r=await H(t,n.map((t=>({key:t})))),s=b.encode(r),o=await U.sha256.digest(s),i=a.k0.createV0(o);await t.put(i,s);return{Name:e,Tsize:r.Links.reduce(((t,e)=>t+e.Tsize),0)+s.length,Hash:i}}async function K(t,e,n,r){if(!await e.has(I))return;const s=await e.get(I),o=a.k0.decode(s),i=await t.get(o),c=b.decode(i);let u=0;const d=await(0,l.Z)(V(t,c,L))+await(0,l.Z)(V(t,c,O));for await(const e of V(t,c,L)){u++;const t={depth:1/0};0!==e.version&&(t.version=e.version),e.code!==b.code&&(t.codec=e.code),await n.put(C(e),E.cv(t)),r(u/d*100,`Migrated recursive pin ${e}`)}for await(const e of V(t,c,O)){u++;const t={depth:0};0!==e.version&&(t.version=e.version),e.code!==b.code&&(t.codec=e.code),await n.put(C(e),E.cv(t)),r(u/d*100,`Migrated direct pin ${e}`)}await t.delete(o),await e.delete(I)}async function q(t,e,n,r){const s=[],o=[];let i=0;const c=await(0,l.Z)(n.queryKeys({}));for await(const{key:t,value:e}of n.query({})){i++;const n=E.Jx(e),l=a.k0.create(n.version||0,n.codec||b.code,h.Jx(u.base32.decode("b"+t.toString().toLowerCase().split("/").pop())));0===n.depth?(r(i/c*100,`Reverted direct pin ${l}`),o.push(l)):(r(i/c*100,`Reverted recursive pin ${l}`),s.push(l))}r(100,"Updating pin root");const d={Links:[await F(t,O,o),await F(t,L,s)]},p=b.encode(d),f=await U.sha256.digest(p),y=a.k0.createV0(f);await t.put(y,p),await e.put(I,y.bytes)}async function G(t,e,n){const r=t.blocks,s=t.datastore,o=t.pins;await r.open(),await s.open(),await o.open();try{await n(r,s,o,e)}finally{await o.close(),await s.close(),await r.close()}}const W={version:9,description:"Migrates pins to datastore",migrate:(t,e=(()=>{}))=>G(t,e,K),revert:(t,e=(()=>{}))=>G(t,e,q)};function Z(t){return t=t||new Error("Not Found"),i(t,"ERR_NOT_FOUND")}const Y=new c.s("/config"),J=new c.s("/version");function Q(t){let e=t;for(;e.db||e.child;)if(e=e.db||e.child,"level-js"===e.type||"Level"===e.constructor.name)return e}function X(t){const e=t.get.bind(t),n=t.has.bind(t);return t.get=r=>async function(t,e,n,r){if(await n(t))return e(t);const s=Q(r);if(!s)throw Z();return new Promise(((e,n)=>{const r=s.store("readonly").get(t.toString());r.transaction.onabort=()=>{n(r.transaction.error)},r.transaction.oncomplete=()=>{if(r.result)return e(r.result);n(Z())}}))}(r,e,n,t),t.has=e=>async function(t,e,n){const r=await e(t);if(r)return r;const s=Q(n);return!!s&&new Promise(((e,n)=>{const r=s.store("readonly").get(t.toString());r.transaction.onabort=()=>{n(r.transaction.error)},r.transaction.oncomplete=()=>{e(Boolean(r.result))}}))}(e,n,t),t}function tt(t){return{...t,root:X(t.root),datastore:X(t.datastore),pins:X(t.pins),keys:X(t.keys)}}async function et(t,e,n=(()=>{})){const r=Q(e);if(!r)return void n(`${t} did not need an upgrade`);n(`Upgrading ${t}`);await it(r,((t,e)=>[{type:"del",key:t},{type:"put",key:(0,z.m)(t),value:e}]))}async function nt(t,e,n=(()=>{})){const r=Q(e);if(!r)return void n(`${t} did not need a downgrade`);n(`Downgrading ${t}`);await it(r,((t,e)=>[{type:"del",key:t},{type:"put",key:(0,B.B)(t),value:e}]))}function rt(t){return t.child?rt(t.child):t}async function st(t,e,n){const r=Object.entries(t).map((([t,e])=>({key:t,backend:rt(e)}))).filter((({key:t,backend:e})=>"LevelDatastore"===e.constructor.name)).map((({key:t,backend:e})=>({name:t,store:e})));e(0,`Migrating ${r.length} dbs`);let s=0;const o=t=>{e(Math.round(s/r.length*100),t)};for(const{name:t,store:e}of r){await e.open();try{await n(t,e,o)}finally{s++,await e.close()}}e(100,`Migrated ${r.length} dbs`)}const ot={version:10,description:"Migrates datastore-level keys to binary",migrate:(t,e=(()=>{}))=>st(t,e,et),revert:(t,e=(()=>{}))=>st(t,e,nt)};function it(t,e){return new Promise(((n,r)=>{const s=t.iterator();s._deserializeKey=s._deserializeValue=t=>t,function o(){const i=(i,a,c)=>{if(i||void 0===a){const t=t=>{t?r(t):n()};s.end(t)}else!function(e,n){const r=t.store("readwrite"),s=r.transaction;let o,i=0;s.onabort=()=>n(o||s.error||new Error("aborted by user")),s.oncomplete=()=>n(),function t(){const n=e[i++],a=n.key;let c;try{c="del"===n.type?r.delete(a):r.put(n.value,a)}catch(t){return o=t,void s.abort()}i<e.length&&(c.onsuccess=t)}()}(e(a,c),o)};s.next(i)}()}))}const at=new c.s("/local/filesroot");const ct={version:11,description:"Store mfs root in the datastore",migrate:async function(t,e=(()=>{})){if(e(100,"Migrating MFS root to repo datastore"),await t.root.open(),await t.datastore.open(),await t.root.has(at)){const e=await t.root.get(at);await t.datastore.put(at,e),await t.root.delete(at)}await t.datastore.close(),await t.root.close(),e(100,"Stored MFS root in repo datastore")},revert:async function(t,e=(()=>{})){if(e(100,"Migrating MFS root to repo root datastore"),await t.root.open(),await t.datastore.open(),await t.datastore.has(at)){const e=await t.datastore.get(at);await t.root.put(at,e),await t.datastore.delete(at)}await t.datastore.close(),await t.root.close(),e(100,"Stored MFS root in repo root datastore")}},lt=_.Reader,ut=_.Writer,dt=_.util,ht=_.roots.default||(_.roots.default={}),pt=ht.Protocols=(()=>{function t(t){if(this.protocols=[],t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.protocols=dt.emptyArray,t.encode=function(t,e){if(e||(e=ut.create()),null!=t.protocols&&t.protocols.length)for(var n=0;n<t.protocols.length;++n)e.uint32(10).string(t.protocols[n]);return e},t.decode=function(t,e){t instanceof lt||(t=lt.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new ht.Protocols;t.pos<n;){var s=t.uint32();if(s>>>3==1)r.protocols&&r.protocols.length||(r.protocols=[]),r.protocols.push(t.string());else t.skipType(7&s)}return r},t.fromObject=function(t){if(t instanceof ht.Protocols)return t;var e=new ht.Protocols;if(t.protocols){if(!Array.isArray(t.protocols))throw TypeError(".Protocols.protocols: array expected");e.protocols=[];for(var n=0;n<t.protocols.length;++n)e.protocols[n]=String(t.protocols[n])}return e},t.toObject=function(t,e){e||(e={});var n={};if((e.arrays||e.defaults)&&(n.protocols=[]),t.protocols&&t.protocols.length){n.protocols=[];for(var r=0;r<t.protocols.length;++r)n.protocols[r]=t.protocols[r]}return n},t.prototype.toJSON=function(){return this.constructor.toObject(this,_.util.toJSONOptions)},t})(),ft=_.Reader,yt=_.Writer,gt=_.util,wt=_.roots.default||(_.roots.default={}),mt=wt.Addresses=(()=>{function t(t){if(this.addrs=[],t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.addrs=gt.emptyArray,t.prototype.certifiedRecord=null,t.encode=function(t,e){if(e||(e=yt.create()),null!=t.addrs&&t.addrs.length)for(var n=0;n<t.addrs.length;++n)wt.Addresses.Address.encode(t.addrs[n],e.uint32(10).fork()).ldelim();return null!=t.certifiedRecord&&Object.hasOwnProperty.call(t,"certifiedRecord")&&wt.Addresses.CertifiedRecord.encode(t.certifiedRecord,e.uint32(18).fork()).ldelim(),e},t.decode=function(t,e){t instanceof ft||(t=ft.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new wt.Addresses;t.pos<n;){var s=t.uint32();switch(s>>>3){case 1:r.addrs&&r.addrs.length||(r.addrs=[]),r.addrs.push(wt.Addresses.Address.decode(t,t.uint32()));break;case 2:r.certifiedRecord=wt.Addresses.CertifiedRecord.decode(t,t.uint32());break;default:t.skipType(7&s)}}return r},t.fromObject=function(t){if(t instanceof wt.Addresses)return t;var e=new wt.Addresses;if(t.addrs){if(!Array.isArray(t.addrs))throw TypeError(".Addresses.addrs: array expected");e.addrs=[];for(var n=0;n<t.addrs.length;++n){if("object"!=typeof t.addrs[n])throw TypeError(".Addresses.addrs: object expected");e.addrs[n]=wt.Addresses.Address.fromObject(t.addrs[n])}}if(null!=t.certifiedRecord){if("object"!=typeof t.certifiedRecord)throw TypeError(".Addresses.certifiedRecord: object expected");e.certifiedRecord=wt.Addresses.CertifiedRecord.fromObject(t.certifiedRecord)}return e},t.toObject=function(t,e){e||(e={});var n={};if((e.arrays||e.defaults)&&(n.addrs=[]),e.defaults&&(n.certifiedRecord=null),t.addrs&&t.addrs.length){n.addrs=[];for(var r=0;r<t.addrs.length;++r)n.addrs[r]=wt.Addresses.Address.toObject(t.addrs[r],e)}return null!=t.certifiedRecord&&t.hasOwnProperty("certifiedRecord")&&(n.certifiedRecord=wt.Addresses.CertifiedRecord.toObject(t.certifiedRecord,e)),n},t.prototype.toJSON=function(){return this.constructor.toObject(this,_.util.toJSONOptions)},t.Address=function(){function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}let e;return t.prototype.multiaddr=gt.newBuffer([]),t.prototype.isCertified=null,Object.defineProperty(t.prototype,"_isCertified",{get:gt.oneOfGetter(e=["isCertified"]),set:gt.oneOfSetter(e)}),t.encode=function(t,e){return e||(e=yt.create()),null!=t.multiaddr&&Object.hasOwnProperty.call(t,"multiaddr")&&e.uint32(10).bytes(t.multiaddr),null!=t.isCertified&&Object.hasOwnProperty.call(t,"isCertified")&&e.uint32(16).bool(t.isCertified),e},t.decode=function(t,e){t instanceof ft||(t=ft.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new wt.Addresses.Address;t.pos<n;){var s=t.uint32();switch(s>>>3){case 1:r.multiaddr=t.bytes();break;case 2:r.isCertified=t.bool();break;default:t.skipType(7&s)}}return r},t.fromObject=function(t){if(t instanceof wt.Addresses.Address)return t;var e=new wt.Addresses.Address;return null!=t.multiaddr&&("string"==typeof t.multiaddr?gt.base64.decode(t.multiaddr,e.multiaddr=gt.newBuffer(gt.base64.length(t.multiaddr)),0):t.multiaddr.length&&(e.multiaddr=t.multiaddr)),null!=t.isCertified&&(e.isCertified=Boolean(t.isCertified)),e},t.toObject=function(t,e){e||(e={});var n={};return e.defaults&&(e.bytes===String?n.multiaddr="":(n.multiaddr=[],e.bytes!==Array&&(n.multiaddr=gt.newBuffer(n.multiaddr)))),null!=t.multiaddr&&t.hasOwnProperty("multiaddr")&&(n.multiaddr=e.bytes===String?gt.base64.encode(t.multiaddr,0,t.multiaddr.length):e.bytes===Array?Array.prototype.slice.call(t.multiaddr):t.multiaddr),null!=t.isCertified&&t.hasOwnProperty("isCertified")&&(n.isCertified=t.isCertified,e.oneofs&&(n._isCertified="isCertified")),n},t.prototype.toJSON=function(){return this.constructor.toObject(this,_.util.toJSONOptions)},t}(),t.CertifiedRecord=function(){function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.seq=gt.Long?gt.Long.fromBits(0,0,!0):0,t.prototype.raw=gt.newBuffer([]),t.encode=function(t,e){return e||(e=yt.create()),null!=t.seq&&Object.hasOwnProperty.call(t,"seq")&&e.uint32(8).uint64(t.seq),null!=t.raw&&Object.hasOwnProperty.call(t,"raw")&&e.uint32(18).bytes(t.raw),e},t.decode=function(t,e){t instanceof ft||(t=ft.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new wt.Addresses.CertifiedRecord;t.pos<n;){var s=t.uint32();switch(s>>>3){case 1:r.seq=t.uint64();break;case 2:r.raw=t.bytes();break;default:t.skipType(7&s)}}return r},t.fromObject=function(t){if(t instanceof wt.Addresses.CertifiedRecord)return t;var e=new wt.Addresses.CertifiedRecord;return null!=t.seq&&(gt.Long?(e.seq=gt.Long.fromValue(t.seq)).unsigned=!0:"string"==typeof t.seq?e.seq=parseInt(t.seq,10):"number"==typeof t.seq?e.seq=t.seq:"object"==typeof t.seq&&(e.seq=new gt.LongBits(t.seq.low>>>0,t.seq.high>>>0).toNumber(!0))),null!=t.raw&&("string"==typeof t.raw?gt.base64.decode(t.raw,e.raw=gt.newBuffer(gt.base64.length(t.raw)),0):t.raw.length&&(e.raw=t.raw)),e},t.toObject=function(t,e){e||(e={});var n={};if(e.defaults){if(gt.Long){var r=new gt.Long(0,0,!0);n.seq=e.longs===String?r.toString():e.longs===Number?r.toNumber():r}else n.seq=e.longs===String?"0":0;e.bytes===String?n.raw="":(n.raw=[],e.bytes!==Array&&(n.raw=gt.newBuffer(n.raw)))}return null!=t.seq&&t.hasOwnProperty("seq")&&("number"==typeof t.seq?n.seq=e.longs===String?String(t.seq):t.seq:n.seq=e.longs===String?gt.Long.prototype.toString.call(t.seq):e.longs===Number?new gt.LongBits(t.seq.low>>>0,t.seq.high>>>0).toNumber(!0):t.seq),null!=t.raw&&t.hasOwnProperty("raw")&&(n.raw=e.bytes===String?gt.base64.encode(t.raw,0,t.raw.length):e.bytes===Array?Array.prototype.slice.call(t.raw):t.raw),n},t.prototype.toJSON=function(){return this.constructor.toObject(this,_.util.toJSONOptions)},t}(),t})(),bt=_.Reader,Et=_.Writer,_t=_.util,vt=_.roots.default||(_.roots.default={}),kt=vt.Peer=(()=>{function t(t){if(this.addresses=[],this.protocols=[],this.metadata=[],t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}let e;return t.prototype.addresses=_t.emptyArray,t.prototype.protocols=_t.emptyArray,t.prototype.metadata=_t.emptyArray,t.prototype.pubKey=null,t.prototype.peerRecordEnvelope=null,Object.defineProperty(t.prototype,"_pubKey",{get:_t.oneOfGetter(e=["pubKey"]),set:_t.oneOfSetter(e)}),Object.defineProperty(t.prototype,"_peerRecordEnvelope",{get:_t.oneOfGetter(e=["peerRecordEnvelope"]),set:_t.oneOfSetter(e)}),t.encode=function(t,e){if(e||(e=Et.create()),null!=t.addresses&&t.addresses.length)for(var n=0;n<t.addresses.length;++n)vt.Address.encode(t.addresses[n],e.uint32(10).fork()).ldelim();if(null!=t.protocols&&t.protocols.length)for(n=0;n<t.protocols.length;++n)e.uint32(18).string(t.protocols[n]);if(null!=t.metadata&&t.metadata.length)for(n=0;n<t.metadata.length;++n)vt.Metadata.encode(t.metadata[n],e.uint32(26).fork()).ldelim();return null!=t.pubKey&&Object.hasOwnProperty.call(t,"pubKey")&&e.uint32(34).bytes(t.pubKey),null!=t.peerRecordEnvelope&&Object.hasOwnProperty.call(t,"peerRecordEnvelope")&&e.uint32(42).bytes(t.peerRecordEnvelope),e},t.decode=function(t,e){t instanceof bt||(t=bt.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new vt.Peer;t.pos<n;){var s=t.uint32();switch(s>>>3){case 1:r.addresses&&r.addresses.length||(r.addresses=[]),r.addresses.push(vt.Address.decode(t,t.uint32()));break;case 2:r.protocols&&r.protocols.length||(r.protocols=[]),r.protocols.push(t.string());break;case 3:r.metadata&&r.metadata.length||(r.metadata=[]),r.metadata.push(vt.Metadata.decode(t,t.uint32()));break;case 4:r.pubKey=t.bytes();break;case 5:r.peerRecordEnvelope=t.bytes();break;default:t.skipType(7&s)}}return r},t.fromObject=function(t){if(t instanceof vt.Peer)return t;var e=new vt.Peer;if(t.addresses){if(!Array.isArray(t.addresses))throw TypeError(".Peer.addresses: array expected");e.addresses=[];for(var n=0;n<t.addresses.length;++n){if("object"!=typeof t.addresses[n])throw TypeError(".Peer.addresses: object expected");e.addresses[n]=vt.Address.fromObject(t.addresses[n])}}if(t.protocols){if(!Array.isArray(t.protocols))throw TypeError(".Peer.protocols: array expected");e.protocols=[];for(n=0;n<t.protocols.length;++n)e.protocols[n]=String(t.protocols[n])}if(t.metadata){if(!Array.isArray(t.metadata))throw TypeError(".Peer.metadata: array expected");e.metadata=[];for(n=0;n<t.metadata.length;++n){if("object"!=typeof t.metadata[n])throw TypeError(".Peer.metadata: object expected");e.metadata[n]=vt.Metadata.fromObject(t.metadata[n])}}return null!=t.pubKey&&("string"==typeof t.pubKey?_t.base64.decode(t.pubKey,e.pubKey=_t.newBuffer(_t.base64.length(t.pubKey)),0):t.pubKey.length&&(e.pubKey=t.pubKey)),null!=t.peerRecordEnvelope&&("string"==typeof t.peerRecordEnvelope?_t.base64.decode(t.peerRecordEnvelope,e.peerRecordEnvelope=_t.newBuffer(_t.base64.length(t.peerRecordEnvelope)),0):t.peerRecordEnvelope.length&&(e.peerRecordEnvelope=t.peerRecordEnvelope)),e},t.toObject=function(t,e){e||(e={});var n={};if((e.arrays||e.defaults)&&(n.addresses=[],n.protocols=[],n.metadata=[]),t.addresses&&t.addresses.length){n.addresses=[];for(var r=0;r<t.addresses.length;++r)n.addresses[r]=vt.Address.toObject(t.addresses[r],e)}if(t.protocols&&t.protocols.length){n.protocols=[];for(r=0;r<t.protocols.length;++r)n.protocols[r]=t.protocols[r]}if(t.metadata&&t.metadata.length){n.metadata=[];for(r=0;r<t.metadata.length;++r)n.metadata[r]=vt.Metadata.toObject(t.metadata[r],e)}return null!=t.pubKey&&t.hasOwnProperty("pubKey")&&(n.pubKey=e.bytes===String?_t.base64.encode(t.pubKey,0,t.pubKey.length):e.bytes===Array?Array.prototype.slice.call(t.pubKey):t.pubKey,e.oneofs&&(n._pubKey="pubKey")),null!=t.peerRecordEnvelope&&t.hasOwnProperty("peerRecordEnvelope")&&(n.peerRecordEnvelope=e.bytes===String?_t.base64.encode(t.peerRecordEnvelope,0,t.peerRecordEnvelope.length):e.bytes===Array?Array.prototype.slice.call(t.peerRecordEnvelope):t.peerRecordEnvelope,e.oneofs&&(n._peerRecordEnvelope="peerRecordEnvelope")),n},t.prototype.toJSON=function(){return this.constructor.toObject(this,_.util.toJSONOptions)},t})(),Rt=(vt.Address=(()=>{function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}let e;return t.prototype.multiaddr=_t.newBuffer([]),t.prototype.isCertified=null,Object.defineProperty(t.prototype,"_isCertified",{get:_t.oneOfGetter(e=["isCertified"]),set:_t.oneOfSetter(e)}),t.encode=function(t,e){return e||(e=Et.create()),null!=t.multiaddr&&Object.hasOwnProperty.call(t,"multiaddr")&&e.uint32(10).bytes(t.multiaddr),null!=t.isCertified&&Object.hasOwnProperty.call(t,"isCertified")&&e.uint32(16).bool(t.isCertified),e},t.decode=function(t,e){t instanceof bt||(t=bt.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new vt.Address;t.pos<n;){var s=t.uint32();switch(s>>>3){case 1:r.multiaddr=t.bytes();break;case 2:r.isCertified=t.bool();break;default:t.skipType(7&s)}}return r},t.fromObject=function(t){if(t instanceof vt.Address)return t;var e=new vt.Address;return null!=t.multiaddr&&("string"==typeof t.multiaddr?_t.base64.decode(t.multiaddr,e.multiaddr=_t.newBuffer(_t.base64.length(t.multiaddr)),0):t.multiaddr.length&&(e.multiaddr=t.multiaddr)),null!=t.isCertified&&(e.isCertified=Boolean(t.isCertified)),e},t.toObject=function(t,e){e||(e={});var n={};return e.defaults&&(e.bytes===String?n.multiaddr="":(n.multiaddr=[],e.bytes!==Array&&(n.multiaddr=_t.newBuffer(n.multiaddr)))),null!=t.multiaddr&&t.hasOwnProperty("multiaddr")&&(n.multiaddr=e.bytes===String?_t.base64.encode(t.multiaddr,0,t.multiaddr.length):e.bytes===Array?Array.prototype.slice.call(t.multiaddr):t.multiaddr),null!=t.isCertified&&t.hasOwnProperty("isCertified")&&(n.isCertified=t.isCertified,e.oneofs&&(n._isCertified="isCertified")),n},t.prototype.toJSON=function(){return this.constructor.toObject(this,_.util.toJSONOptions)},t})(),vt.Metadata=(()=>{function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.key="",t.prototype.value=_t.newBuffer([]),t.encode=function(t,e){return e||(e=Et.create()),null!=t.key&&Object.hasOwnProperty.call(t,"key")&&e.uint32(10).string(t.key),null!=t.value&&Object.hasOwnProperty.call(t,"value")&&e.uint32(18).bytes(t.value),e},t.decode=function(t,e){t instanceof bt||(t=bt.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new vt.Metadata;t.pos<n;){var s=t.uint32();switch(s>>>3){case 1:r.key=t.string();break;case 2:r.value=t.bytes();break;default:t.skipType(7&s)}}return r},t.fromObject=function(t){if(t instanceof vt.Metadata)return t;var e=new vt.Metadata;return null!=t.key&&(e.key=String(t.key)),null!=t.value&&("string"==typeof t.value?_t.base64.decode(t.value,e.value=_t.newBuffer(_t.base64.length(t.value)),0):t.value.length&&(e.value=t.value)),e},t.toObject=function(t,e){e||(e={});var n={};return e.defaults&&(n.key="",e.bytes===String?n.value="":(n.value=[],e.bytes!==Array&&(n.value=_t.newBuffer(n.value)))),null!=t.key&&t.hasOwnProperty("key")&&(n.key=t.key),null!=t.value&&t.hasOwnProperty("value")&&(n.value=e.bytes===String?_t.base64.encode(t.value,0,t.value.length):e.bytes===Array?Array.prototype.slice.call(t.value):t.value),n},t.prototype.toJSON=function(){return this.constructor.toObject(this,_.util.toJSONOptions)},t})(),_.Reader),St=_.Writer,Tt=_.util,At=_.roots.default||(_.roots.default={}),It=At.Envelope=(()=>{function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.publicKey=Tt.newBuffer([]),t.prototype.payloadType=Tt.newBuffer([]),t.prototype.payload=Tt.newBuffer([]),t.prototype.signature=Tt.newBuffer([]),t.encode=function(t,e){return e||(e=St.create()),null!=t.publicKey&&Object.hasOwnProperty.call(t,"publicKey")&&e.uint32(10).bytes(t.publicKey),null!=t.payloadType&&Object.hasOwnProperty.call(t,"payloadType")&&e.uint32(18).bytes(t.payloadType),null!=t.payload&&Object.hasOwnProperty.call(t,"payload")&&e.uint32(26).bytes(t.payload),null!=t.signature&&Object.hasOwnProperty.call(t,"signature")&&e.uint32(42).bytes(t.signature),e},t.decode=function(t,e){t instanceof Rt||(t=Rt.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new At.Envelope;t.pos<n;){var s=t.uint32();switch(s>>>3){case 1:r.publicKey=t.bytes();break;case 2:r.payloadType=t.bytes();break;case 3:r.payload=t.bytes();break;case 5:r.signature=t.bytes();break;default:t.skipType(7&s)}}return r},t.fromObject=function(t){if(t instanceof At.Envelope)return t;var e=new At.Envelope;return null!=t.publicKey&&("string"==typeof t.publicKey?Tt.base64.decode(t.publicKey,e.publicKey=Tt.newBuffer(Tt.base64.length(t.publicKey)),0):t.publicKey.length&&(e.publicKey=t.publicKey)),null!=t.payloadType&&("string"==typeof t.payloadType?Tt.base64.decode(t.payloadType,e.payloadType=Tt.newBuffer(Tt.base64.length(t.payloadType)),0):t.payloadType.length&&(e.payloadType=t.payloadType)),null!=t.payload&&("string"==typeof t.payload?Tt.base64.decode(t.payload,e.payload=Tt.newBuffer(Tt.base64.length(t.payload)),0):t.payload.length&&(e.payload=t.payload)),null!=t.signature&&("string"==typeof t.signature?Tt.base64.decode(t.signature,e.signature=Tt.newBuffer(Tt.base64.length(t.signature)),0):t.signature.length&&(e.signature=t.signature)),e},t.toObject=function(t,e){e||(e={});var n={};return e.defaults&&(e.bytes===String?n.publicKey="":(n.publicKey=[],e.bytes!==Array&&(n.publicKey=Tt.newBuffer(n.publicKey))),e.bytes===String?n.payloadType="":(n.payloadType=[],e.bytes!==Array&&(n.payloadType=Tt.newBuffer(n.payloadType))),e.bytes===String?n.payload="":(n.payload=[],e.bytes!==Array&&(n.payload=Tt.newBuffer(n.payload))),e.bytes===String?n.signature="":(n.signature=[],e.bytes!==Array&&(n.signature=Tt.newBuffer(n.signature)))),null!=t.publicKey&&t.hasOwnProperty("publicKey")&&(n.publicKey=e.bytes===String?Tt.base64.encode(t.publicKey,0,t.publicKey.length):e.bytes===Array?Array.prototype.slice.call(t.publicKey):t.publicKey),null!=t.payloadType&&t.hasOwnProperty("payloadType")&&(n.payloadType=e.bytes===String?Tt.base64.encode(t.payloadType,0,t.payloadType.length):e.bytes===Array?Array.prototype.slice.call(t.payloadType):t.payloadType),null!=t.payload&&t.hasOwnProperty("payload")&&(n.payload=e.bytes===String?Tt.base64.encode(t.payload,0,t.payload.length):e.bytes===Array?Array.prototype.slice.call(t.payload):t.payload),null!=t.signature&&t.hasOwnProperty("signature")&&(n.signature=e.bytes===String?Tt.base64.encode(t.signature,0,t.signature.length):e.bytes===Array?Array.prototype.slice.call(t.signature):t.signature),n},t.prototype.toJSON=function(){return this.constructor.toObject(this,_.util.toJSONOptions)},t})(),Dt=_.Reader,Pt=_.Writer,Nt=_.util,Ot=_.roots.default||(_.roots.default={}),Lt=Ot.PeerRecord=(()=>{function t(t){if(this.addresses=[],t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.peerId=Nt.newBuffer([]),t.prototype.seq=Nt.Long?Nt.Long.fromBits(0,0,!0):0,t.prototype.addresses=Nt.emptyArray,t.encode=function(t,e){if(e||(e=Pt.create()),null!=t.peerId&&Object.hasOwnProperty.call(t,"peerId")&&e.uint32(10).bytes(t.peerId),null!=t.seq&&Object.hasOwnProperty.call(t,"seq")&&e.uint32(16).uint64(t.seq),null!=t.addresses&&t.addresses.length)for(var n=0;n<t.addresses.length;++n)Ot.PeerRecord.AddressInfo.encode(t.addresses[n],e.uint32(26).fork()).ldelim();return e},t.decode=function(t,e){t instanceof Dt||(t=Dt.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new Ot.PeerRecord;t.pos<n;){var s=t.uint32();switch(s>>>3){case 1:r.peerId=t.bytes();break;case 2:r.seq=t.uint64();break;case 3:r.addresses&&r.addresses.length||(r.addresses=[]),r.addresses.push(Ot.PeerRecord.AddressInfo.decode(t,t.uint32()));break;default:t.skipType(7&s)}}return r},t.fromObject=function(t){if(t instanceof Ot.PeerRecord)return t;var e=new Ot.PeerRecord;if(null!=t.peerId&&("string"==typeof t.peerId?Nt.base64.decode(t.peerId,e.peerId=Nt.newBuffer(Nt.base64.length(t.peerId)),0):t.peerId.length&&(e.peerId=t.peerId)),null!=t.seq&&(Nt.Long?(e.seq=Nt.Long.fromValue(t.seq)).unsigned=!0:"string"==typeof t.seq?e.seq=parseInt(t.seq,10):"number"==typeof t.seq?e.seq=t.seq:"object"==typeof t.seq&&(e.seq=new Nt.LongBits(t.seq.low>>>0,t.seq.high>>>0).toNumber(!0))),t.addresses){if(!Array.isArray(t.addresses))throw TypeError(".PeerRecord.addresses: array expected");e.addresses=[];for(var n=0;n<t.addresses.length;++n){if("object"!=typeof t.addresses[n])throw TypeError(".PeerRecord.addresses: object expected");e.addresses[n]=Ot.PeerRecord.AddressInfo.fromObject(t.addresses[n])}}return e},t.toObject=function(t,e){e||(e={});var n={};if((e.arrays||e.defaults)&&(n.addresses=[]),e.defaults)if(e.bytes===String?n.peerId="":(n.peerId=[],e.bytes!==Array&&(n.peerId=Nt.newBuffer(n.peerId))),Nt.Long){var r=new Nt.Long(0,0,!0);n.seq=e.longs===String?r.toString():e.longs===Number?r.toNumber():r}else n.seq=e.longs===String?"0":0;if(null!=t.peerId&&t.hasOwnProperty("peerId")&&(n.peerId=e.bytes===String?Nt.base64.encode(t.peerId,0,t.peerId.length):e.bytes===Array?Array.prototype.slice.call(t.peerId):t.peerId),null!=t.seq&&t.hasOwnProperty("seq")&&("number"==typeof t.seq?n.seq=e.longs===String?String(t.seq):t.seq:n.seq=e.longs===String?Nt.Long.prototype.toString.call(t.seq):e.longs===Number?new Nt.LongBits(t.seq.low>>>0,t.seq.high>>>0).toNumber(!0):t.seq),t.addresses&&t.addresses.length){n.addresses=[];for(var s=0;s<t.addresses.length;++s)n.addresses[s]=Ot.PeerRecord.AddressInfo.toObject(t.addresses[s],e)}return n},t.prototype.toJSON=function(){return this.constructor.toObject(this,_.util.toJSONOptions)},t.AddressInfo=function(){function t(t){if(t)for(var e=Object.keys(t),n=0;n<e.length;++n)null!=t[e[n]]&&(this[e[n]]=t[e[n]])}return t.prototype.multiaddr=Nt.newBuffer([]),t.encode=function(t,e){return e||(e=Pt.create()),null!=t.multiaddr&&Object.hasOwnProperty.call(t,"multiaddr")&&e.uint32(10).bytes(t.multiaddr),e},t.decode=function(t,e){t instanceof Dt||(t=Dt.create(t));for(var n=void 0===e?t.len:t.pos+e,r=new Ot.PeerRecord.AddressInfo;t.pos<n;){var s=t.uint32();if(s>>>3==1)r.multiaddr=t.bytes();else t.skipType(7&s)}return r},t.fromObject=function(t){if(t instanceof Ot.PeerRecord.AddressInfo)return t;var e=new Ot.PeerRecord.AddressInfo;return null!=t.multiaddr&&("string"==typeof t.multiaddr?Nt.base64.decode(t.multiaddr,e.multiaddr=Nt.newBuffer(Nt.base64.length(t.multiaddr)),0):t.multiaddr.length&&(e.multiaddr=t.multiaddr)),e},t.toObject=function(t,e){e||(e={});var n={};return e.defaults&&(e.bytes===String?n.multiaddr="":(n.multiaddr=[],e.bytes!==Array&&(n.multiaddr=Nt.newBuffer(n.multiaddr)))),null!=t.multiaddr&&t.hasOwnProperty("multiaddr")&&(n.multiaddr=e.bytes===String?Nt.base64.encode(t.multiaddr,0,t.multiaddr.length):e.bytes===Array?Array.prototype.slice.call(t.multiaddr):t.multiaddr),n},t.prototype.toJSON=function(){return this.constructor.toObject(this,_.util.toJSONOptions)},t}(),t})();var Ct=n(91026);_.util.Long=void 0,_.configure();const Mt={version:12,description:"Store each peerstore peer under a single datastore key",migrate:async function(t,e=(()=>{})){e(0,"Storing each peerstore key under a single datastore key"),await t.datastore.open();const n={},r=[];for await(const{key:e,value:s}of t.datastore.query({prefix:"/peers"})){r.push(e);const t=e.toString(),[,o,i,a,c]=t.split("/");if("peers"===o&&(["protos","addrs","metadata","keys"].includes(i)&&a))if(n[a]=n[a]||{addresses:[],protocols:[],metadata:[]},"protos"===i){const t=pt.decode(s);n[a].protocols=t.protocols.sort()}else if("addrs"===i){const t=mt.decode(s);n[a].addresses=t.addrs.sort(((t,e)=>(0,Ct.HM)(t.multiaddr).toString().localeCompare((0,Ct.HM)(e.multiaddr).toString()))),t.certifiedRecord&&t.certifiedRecord.raw&&(n[a].peerRecordEnvelope=t.certifiedRecord.raw)}else"metadata"===i?n[a].metadata.push({key:c,value:s}):"keys"===i&&(n[a].pubKey=s)}e(33,"Read peer data from store");for(const e of r)await t.datastore.delete(e);e(66,"Removed existing peer data from store");for(const e of Object.keys(n)){const r=n[e];r.metadata=r.metadata.sort(((t,e)=>t.key.localeCompare(e.key)));const s=kt.encode(r).finish();await t.datastore.put(new c.s(`/peers/${e}`),s)}await t.datastore.close(),e(100,"Stored each peerstore key under a single datastore key")},revert:async function(t,e=(()=>{})){e(0,"Storing each peerstore key under a multiple datastore keys"),await t.datastore.open();const n={},r=[];for await(const{key:e,value:s}of t.datastore.query({prefix:"/peers"})){r.push(e);const t=e.toString(),[,,o]=t.split("/");n[o]=kt.decode(s)}e(33,"Read peer data from store");for(const e of r)await t.datastore.delete(e);e(66,"Removed existing peer data from store");for(const[e,r]of Object.entries(n)){if(r.protocols&&r.protocols.length>0&&await t.datastore.put(new c.s(`/peers/protos/${e}`),pt.encode({protocols:r.protocols}).finish()),r.addresses&&r.addresses.length>0){const n=r.peerRecordEnvelope;let s;if(n){const t=It.decode(n);s={raw:n,seq:Lt.decode(t.payload).seq}}await t.datastore.put(new c.s(`/peers/addrs/${e}`),mt.encode({addrs:r.addresses,certifiedRecord:s}).finish())}if(r.metadata&&r.metadata.length>0)for(const{key:n,value:s}of r.metadata)await t.datastore.put(new c.s(`/peers/metadata/${e}/${n}`),s);r.pubKey&&await t.datastore.put(new c.s(`/peers/keys/${e}`),r.pubKey)}await t.datastore.close(),e(100,"Stored each peerstore key under multiple datastore keys")}},xt={description:"Empty migration.",migrate:()=>{},revert:()=>{},empty:!0};var Bt=[Object.assign({version:1},xt),Object.assign({version:2},xt),Object.assign({version:3},xt),Object.assign({version:4},xt),Object.assign({version:5},xt),Object.assign({version:6},xt),Object.assign({version:7},xt),m,W,ot,ct,Mt];class zt extends Error{constructor(t){super(t),this.name="NonReversibleMigrationError",this.code=zt.code,this.message=t}}zt.code="ERR_NON_REVERSIBLE_MIGRATION";class Ut extends Error{constructor(t){super(t),this.name="NotInitializedRepoError",this.code=Ut.code,this.message=t}}Ut.code="ERR_NOT_INITIALIZED_REPO";class jt extends Error{constructor(t){super(t),this.name="RequiredParameterError",this.code=jt.code,this.message=t}}jt.code="ERR_REQUIRED_PARAMETER";class $t extends Error{constructor(t){super(t),this.name="InvalidValueError",this.code=$t.code,this.message=t}}$t.code="ERR_INVALID_VALUE";class Vt extends Error{constructor(t){super(t),this.name="MissingRepoOptionsError",this.code=Vt.code,this.message=t}}Vt.code="ERR_MISSING_REPO_OPTIONS";const Ht=o("ipfs:repo:migrator:repo:init");async function Ft(t){if(!await async function(t){if(!t)throw new Vt("Please pass repo options when trying to open a repo");const e=t.root;try{await e.open();const t=await e.has(J),n=await e.has(Y);return!(!t||!n)||(Ht(`Version entry present: ${t}`),Ht(`Config entry present: ${n}`),!1)}catch(t){return Ht("While checking if repo is initialized error was thrown: "+t.message),!1}finally{if(void 0!==e)try{await e.close()}catch{}}}(t))throw new Ut("Repo is not initialized!");const e=t.root;await e.open();try{return parseInt((0,B.B)(await e.get(J)))}finally{await e.close()}}async function Kt(t,e){if(!e)throw new Vt("Please pass repo options when trying to open a repo");const n=e.root;await n.open(),await n.put(J,(0,z.m)(String(t))),await n.close()}const qt=o("ipfs:repo:migrator");async function Gt(t,e,n,r,s={}){const o=s.ignoreLock??!1,i=s.onProgress,a=s.isDryRun??!1,c=s.migrations??Bt;if(!t)throw new Zt.RequiredParameterError("Path argument is required!");if(!n)throw new Zt.RequiredParameterError("repoOptions argument is required!");if(!r)throw new Zt.RequiredParameterError("toVersion argument is required!");if(!Number.isInteger(r)||r<=0)throw new Zt.InvalidValueError("Version has to be positive integer!");e=tt(e);const l=await Ft(e);if(l===r)return void qt("Nothing to migrate.");if(l>r)throw new Zt.InvalidValueError(`Current repo's version (${l}) is higher then toVersion (${r}), you probably wanted to revert it?`);let u;Wt(c,l,r),a||o||(u=await n.repoLock.lock(t));try{for(const t of c){if(void 0!==r&&t.version>r)break;if(!(t.version<=l)){qt(`Migrating version ${t.version}`);try{if(!a){let n=()=>{};i&&(n=(e,n)=>i(t.version,e.toFixed(2),n)),await t.migrate(e,n)}}catch(n){const r=t.version-1;throw qt(`An exception was raised during execution of migration. Setting the repo's version to last successfully migrated version: ${r}`),await Kt(r,e),new Error(`During migration to version ${t.version} exception was raised: ${n.stack||n.message||n}`)}qt(`Migrating to version ${t.version} finished`)}}a||await Kt(r||function(t){return t=t||Bt,Array.isArray(t)&&0!==t.length?t[t.length-1].version:0}(c),e),qt("Repo successfully migrated",void 0!==r?`to version ${r}!`:"to latest version!")}finally{a||o||!u||await u.close()}}function Wt(t,e,n,r=!1){let s=0;for(const o of t){if(o.version>n)break;if(o.version>e){if(r&&!o.revert)throw new Zt.NonReversibleMigrationError(`It is not possible to revert to version ${e} because migration version ${o.version} is not reversible. Cancelling reversion.`);s++}}if(s!==n-e)throw new Zt.InvalidValueError(`The ipfs-repo-migrations package does not have all migration to migrate from version ${e} to ${n}`)}const Zt=r;var Yt=n(79830),Jt=n(79221),Qt=n(45895),Xt=n(68919);async function te(t,e,n){const r=await e(t);if(r)return r;const s=ne(n);return!!s&&new Promise(((e,n)=>{const r=s.store("readonly").get(t.toString());r.transaction.onabort=()=>{n(r.transaction.error)},r.transaction.oncomplete=()=>{e(Boolean(r.result))}}))}async function ee(t,e,n,r){if(await n(t))return e(t);const s=ne(r);if(!s)throw new Xt.dR;return new Promise(((e,n)=>{const r=s.store("readonly").get(t.toString());r.transaction.onabort=()=>{n(r.transaction.error)},r.transaction.oncomplete=()=>{if(r.result)return e(r.result);n(new Xt.dR)}}))}function ne(t){let e=t;for(;e.db||e.child;)if(e=e.db||e.child,"level-js"===e.type||"Level"===e.constructor.name)return e}const re=o("ipfs:repo:version"),se=new c.s("version");var oe=n(95972),ie=n(2302);const ae=oe.Z.default?oe.Z.default:oe.Z,ce=new c.s("config");var le=n(64348),ue=n(62794);const de=new le.s("datastore_spec");const he=new c.s("api");var pe=n(44752),fe=n(37430),ye=n(93361),ge=n(38566);function we(t){const e=a.k0.asCID(t);if(null==e)throw i(new Error("Not a valid cid"),"ERR_INVALID_CID");return e.multihash.code!==ge.identity.code?{isIdentity:!1}:{isIdentity:!0,digest:e.multihash.digest}}var me={autoMigrate:!0,onMigrationProgress:()=>{},repoOwner:!0,repoLock:n(83723).G},be={Spec:{type:"mount",mounts:[{mountpoint:"/blocks",type:"measure",prefix:"flatfs.datastore",child:{type:"flatfs",path:"blocks",sync:!0,shardFunc:"/repo/flatfs/shard/v1/next-to-last/2"}},{mountpoint:"/",type:"measure",prefix:"leveldb.datastore",child:{type:"levelds",path:"datastore",compression:"none"}}]}},Ee=n(91486),_e=n(7618),ve=n(11015);function ke(t){const e=ve.k0.asCID(t);if(null==e)throw i(new Error("Not a valid cid"),"ERR_INVALID_CID");const n=u.base32.encode(e.multihash.bytes);return new c.s("/"+n.slice(1).toUpperCase(),!1)}function Re(t){return h.Jx(u.base32.decode(`b${t.toString().toLowerCase().substring(1)}`))}const Se=o("ipfs:repo:utils:walk-dag");async function*Te(t,e,n,r){try{const s=await e.get(t,r),o=await n(t.code),i=(0,_e.OV)({bytes:s,cid:t,codec:o});for(const[,t]of i.links())yield t,yield*Te(t,e,n,r)}catch(e){throw Se("Could not walk DAG for CID",t.toString(),e),e}}var Ae=n(69044);class Ie extends Map{constructor(t={}){if(super(),!(t.maxSize&&t.maxSize>0))throw new TypeError("`maxSize` must be a number greater than 0");if("number"==typeof t.maxAge&&0===t.maxAge)throw new TypeError("`maxAge` must be a number greater than 0");this.maxSize=t.maxSize,this.maxAge=t.maxAge||Number.POSITIVE_INFINITY,this.onEviction=t.onEviction,this.cache=new Map,this.oldCache=new Map,this._size=0}_emitEvictions(t){if("function"==typeof this.onEviction)for(const[e,n]of t)this.onEviction(e,n.value)}_deleteIfExpired(t,e){return"number"==typeof e.expiry&&e.expiry<=Date.now()&&("function"==typeof this.onEviction&&this.onEviction(t,e.value),this.delete(t))}_getOrDeleteIfExpired(t,e){if(!1===this._deleteIfExpired(t,e))return e.value}_getItemValue(t,e){return e.expiry?this._getOrDeleteIfExpired(t,e):e.value}_peek(t,e){const n=e.get(t);return this._getItemValue(t,n)}_set(t,e){this.cache.set(t,e),this._size++,this._size>=this.maxSize&&(this._size=0,this._emitEvictions(this.oldCache),this.oldCache=this.cache,this.cache=new Map)}_moveToRecent(t,e){this.oldCache.delete(t),this._set(t,e)}*_entriesAscending(){for(const t of this.oldCache){const[e,n]=t;if(!this.cache.has(e)){!1===this._deleteIfExpired(e,n)&&(yield t)}}for(const t of this.cache){const[e,n]=t;!1===this._deleteIfExpired(e,n)&&(yield t)}}get(t){if(this.cache.has(t)){const e=this.cache.get(t);return this._getItemValue(t,e)}if(this.oldCache.has(t)){const e=this.oldCache.get(t);if(!1===this._deleteIfExpired(t,e))return this._moveToRecent(t,e),e.value}}set(t,e,{maxAge:n=this.maxAge}={}){const r="number"==typeof n&&n!==Number.POSITIVE_INFINITY?Date.now()+n:void 0;this.cache.has(t)?this.cache.set(t,{value:e,expiry:r}):this._set(t,{value:e,expiry:r})}has(t){return this.cache.has(t)?!this._deleteIfExpired(t,this.cache.get(t)):!!this.oldCache.has(t)&&!this._deleteIfExpired(t,this.oldCache.get(t))}peek(t){return this.cache.has(t)?this._peek(t,this.cache):this.oldCache.has(t)?this._peek(t,this.oldCache):void 0}delete(t){const e=this.cache.delete(t);return e&&this._size--,this.oldCache.delete(t)||e}clear(){this.cache.clear(),this.oldCache.clear(),this._size=0}resize(t){if(!(t&&t>0))throw new TypeError("`maxSize` must be a number greater than 0");const e=[...this._entriesAscending()],n=e.length-t;n<0?(this.cache=new Map(e),this.oldCache=new Map,this._size=e.length):(n>0&&this._emitEvictions(e.slice(0,n)),this.oldCache=new Map(e.slice(n)),this.cache=new Map,this._size=0),this.maxSize=t}*keys(){for(const[t]of this)yield t}*values(){for(const[,t]of this)yield t}*[Symbol.iterator](){for(const t of this.cache){const[e,n]=t;!1===this._deleteIfExpired(e,n)&&(yield[e,n.value])}for(const t of this.oldCache){const[e,n]=t;if(!this.cache.has(e)){!1===this._deleteIfExpired(e,n)&&(yield[e,n.value])}}}*entriesDescending(){let t=[...this.cache];for(let e=t.length-1;e>=0;--e){const n=t[e],[r,s]=n;!1===this._deleteIfExpired(r,s)&&(yield[r,s.value])}t=[...this.oldCache];for(let e=t.length-1;e>=0;--e){const n=t[e],[r,s]=n;if(!this.cache.has(r)){!1===this._deleteIfExpired(r,s)&&(yield[r,s.value])}}}*entriesAscending(){for(const[t,e]of this._entriesAscending())yield[t,e.value]}get size(){if(!this._size)return this.oldCache.size;let t=0;for(const e of this.oldCache.keys())this.cache.has(e)||t++;return Math.min(this._size+t,this.maxSize)}entries(){return this.entriesAscending()}forEach(t,e=this){for(const[n,r]of this.entriesAscending())t.call(e,r,n,this)}get[Symbol.toStringTag](){return JSON.stringify([...this.entriesAscending()])}}class De{constructor({pinstore:t,blockstore:e,loadCodec:n}){this.pinstore=t,this.blockstore=e,this.loadCodec=n,this.log=o("ipfs:repo:pin"),this.directPins=new Set,this.recursivePins=new Set}async pinDirectly(t,e={}){await this.blockstore.get(t,e);const n={depth:0};return 0!==t.version&&(n.version=t.version),t.code!==b.code&&(n.codec=t.code),e.metadata&&(n.metadata=e.metadata),this.pinstore.put(ke(t),E.cv(n))}unpin(t,e){return this.pinstore.delete(ke(t),e)}async pinRecursively(t,e={}){await this.fetchCompleteDag(t,e);const n={depth:1/0};0!==t.version&&(n.version=t.version),t.code!==b.code&&(n.codec=t.code),e.metadata&&(n.metadata=e.metadata),await this.pinstore.put(ke(t),E.cv(n))}async*directKeys(t){for await(const t of this.pinstore.query({filters:[t=>0===E.Jx(t.value).depth]})){const e=E.Jx(t.value),n=e.version||0,r=null!=e.codec?e.codec:b.code,s=Re(t.key);yield{cid:a.k0.create(n,r,s),metadata:e.metadata}}}async*recursiveKeys(t){for await(const t of this.pinstore.query({filters:[t=>E.Jx(t.value).depth===1/0]})){const e=E.Jx(t.value),n=e.version||0,r=null!=e.codec?e.codec:b.code,s=Re(t.key);yield{cid:a.k0.create(n,r,s),metadata:e.metadata}}}async*indirectKeys(t){for await(const{cid:e}of this.recursiveKeys())for await(const n of Te(e,this.blockstore,this.loadCodec,t)){const t=[Ae.R.recursive];(await this.isPinnedWithType(n,t)).pinned||(yield n)}}async isPinnedWithType(t,e,n){Array.isArray(e)||(e=[e]);const r=e.includes(Ae.R.all),s=e.includes(Ae.R.direct),o=e.includes(Ae.R.recursive),i=e.includes(Ae.R.indirect);if(o||s||r){const n=await(0,Ee.Z)(this.pinstore.query({prefix:ke(t).toString(),filters:[t=>{if(r)return!0;const n=E.Jx(t.value);return e.includes(0===n.depth?Ae.R.direct:Ae.R.recursive)}],limit:1}));if(n){const e=E.Jx(n.value);return{cid:t,pinned:!0,reason:0===e.depth?Ae.R.direct:Ae.R.recursive,metadata:e.metadata}}}const a=this;if(r||i){const e=await(0,Ee.Z)(async function*(t,e){for await(const{cid:n}of e)for await(const e of Te(n,a.blockstore,a.loadCodec))if(e.equals(t))return void(yield n)}(t,this.recursiveKeys()));if(e)return{cid:t,pinned:!0,reason:Ae.R.indirect,parent:e}}return{cid:t,pinned:!1}}async fetchCompleteDag(t,e={}){const n=new Ie({maxSize:e.cidCacheMaxSize??2048}),r=async(t,e)=>{if(n.has(t.toString()))return;n.set(t.toString(),!0);const s=await this.blockstore.get(t,e),o=await this.loadCodec(t.code),i=(0,_e.OV)({bytes:s,cid:t,codec:o});await Promise.all([...i.links()].map((([,t])=>r(t,e))))};await r(t,e)}static checkPinType(t){if("string"!=typeof t||!Object.keys(Ae.R).includes(t))throw function(t){return i(new Error(`Invalid type '${t}', must be one of {direct, indirect, recursive, all}`),"ERR_INVALID_PIN_TYPE")}(t);return!0}}var Pe=n(21007);async function Ne(t,e){const{pinned:n,reason:r}=await e.isPinnedWithType(t,Ae.R.all);if(n)throw i(new Error(`pinned: ${r}`),"ERR_BLOCK_PINNED")}var Oe=n(56027);var Le=n(67389),Ce=n(52019);const Me=(...t)=>{let e;for(;t.length>0;)e=t.shift()(e);return e},xe=t=>null!=t&&("function"==typeof t[Symbol.asyncIterator]||"function"==typeof t[Symbol.iterator]||"function"==typeof t.next),Be=t=>null!=t&&"function"==typeof t.sink&&xe(t.source),ze=t=>e=>{const n=t.sink(e);if(null!=n.then){const e=(0,fe.d)({objectMode:!0});n.then((()=>{e.end()}),(t=>{e.end(t)}));const r=async function*(){yield*t.source,e.end()};return(0,Ce.Z)(e,r())}return t.source};const Ue=o("ipfs:repo:gc"),je=($e=$e||new Error("Not Found"),i($e,"ERR_NOT_FOUND")).code;var $e;const Ve=256,He=new c.s("/local/filesroot");function Fe({gcLock:t,pins:e,blockstore:n,root:r,loadCodec:s}){return async function*(){const o=Date.now();Ue("Creating set of marked blocks");const i=await t.writeLock();try{const t=await async function({pins:t,blockstore:e,loadCodec:n,root:r}){const s=async function*(){let t;try{t=await r.get(He)}catch(t){if(t.code===je)return void Ue("No blocks in MFS");throw t}const s=a.k0.decode(t);yield s,yield*Te(s,e,n)}(),o=(0,Ce.Z)((0,Pe.Z)(t.recursiveKeys(),(({cid:t})=>t)),t.indirectKeys(),(0,Pe.Z)(t.directKeys(),(({cid:t})=>t)),s),i=new Set;for await(const t of(0,Ce.Z)(o,s))i.add(u.base32.encode(t.multihash.bytes));return i}({pins:e,blockstore:n,root:r,loadCodec:s}),i=n.queryKeys({});yield*async function*({blockstore:t},e,n){let r=0,s=0;const o=async n=>async function(){r++;try{const r=u.base32.encode(n.multihash.bytes);if(e.has(r))return null;try{await t.delete(n),s++}catch(t){return{err:new Error(`Could not delete block with CID ${n}: ${t.message}`)}}return{cid:n}}catch(t){const e=`Could delete block with CID ${n}`;return Ue(e,t),{err:new Error(e+`: ${t.message}`)}}};yield*function(t,...e){if(Be(t)){const e=t;t=()=>e.source}else if(xe(t)){const e=t;t=()=>e}const n=[t,...e];if(n.length>1&&Be(n[n.length-1])&&(n[n.length-1]=n[n.length-1].sink),n.length>2)for(let t=1;t<n.length-1;t++)Be(n[t])&&(n[t]=ze(n[t]));return Me(...n)}((0,Le.Z)((0,Pe.Z)(n,o),Ve),(t=>(0,pe.Z)(t,Boolean))),Ue(`Marked set has ${e.size} unique blocks. Blockstore has ${r} blocks. Deleted ${s} blocks.`)}({blockstore:n},t,i),Ue(`Complete (${Date.now()-o}ms)`)}finally{i()}}}const Ke=o("ipfs:repo"),qe=Number.MAX_SAFE_INTEGER;class Ge{constructor(t,e,n,r){if("string"!=typeof t)throw new Error("missing repo path");if("function"!=typeof e)throw new Error("missing codec loader");this.options=(0,Jt.Z)(me,r),this.closed=!0,this.path=t,this.root=n.root,this.datastore=n.datastore,this.keys=n.keys;const o=n.blocks,a=n.pins;this.pins=new De({pinstore:a,blockstore:o,loadCodec:e});const c=(l=this.pins,u=o,{open:()=>u.open(),close:()=>u.close(),query:(t,e)=>u.query(t,e),queryKeys:(t,e)=>u.queryKeys(t,e),get:async(t,e)=>u.get(t,e),async*getMany(t,e){yield*u.getMany(t,e)},async put(t,e,n){await u.put(t,e,n)},async*putMany(t,e){yield*u.putMany(t,e)},has:(t,e)=>u.has(t,e),delete:async(t,e)=>(await Ne(t,l),u.delete(t,e)),deleteMany:(t,e)=>u.deleteMany((0,Pe.Z)(t,(async t=>(await Ne(t,l),t))),e),batch:()=>u.batch()});var l,u;this.blocks=function(t){return{open:()=>t.open(),close:()=>t.close(),query:(e,n)=>t.query(e,n),queryKeys:(e,n)=>t.queryKeys(e,n),async get(e,n){const r=we(e);return r.isIdentity?Promise.resolve(r.digest):t.get(e,n)},async*getMany(t,e){for await(const n of t)yield this.get(n,e)},async put(e,n,r){const{isIdentity:s}=we(e);s||await t.put(e,n,r)},async*putMany(e,n){const r=(0,fe.d)({objectMode:!0});(globalThis.process&&globalThis.process.nextTick?globalThis.process.nextTick:globalThis.setImmediate||globalThis.setTimeout)((async()=>{try{await(0,ye.Z)(t.putMany(async function*(){for await(const{key:t,value:n}of e)we(t).isIdentity||(yield{key:t,value:n}),r.push({key:t,value:n})}())),r.end()}catch(t){r.end(t)}})),yield*r},has(e,n){const{isIdentity:r}=we(e);return r?Promise.resolve(!0):t.has(e,n)},delete(e,n){const{isIdentity:r}=we(e);return r?Promise.resolve():t.delete(e,n)},deleteMany:(e,n)=>t.deleteMany((0,pe.Z)(e,(t=>!we(t).isIdentity)),n),batch(){const e=t.batch();return{put(t,n){const{isIdentity:r}=we(t);r||e.put(t,n)},delete(t){const{isIdentity:n}=we(t);n||e.delete(t)},commit:t=>e.commit(t)}}}}(c),this.version=function(t){return{exists:async()=>te(se,t.has.bind(t),t),async get(){const e=await ee(se,t.get.bind(t),t.has.bind(t),t);return parseInt((0,B.B)(e),10)},set:e=>t.put(se,(0,z.m)(String(e))),async check(t){const e=await this.get();return re("comparing version: %s and %s",e,t),e===t||6===e&&7===t||6===t&&7===e}}}(this.root),this.config=function(t){const e=new ae({concurrency:1}),n={async getAll(e={}){const n=await ee(ce,t.get.bind(t),t.has.bind(t),t);return JSON.parse((0,B.B)(n))},async get(t,e={}){if(null==t)throw new Xt.dR(`Key ${t} does not exist in config`);const n=await this.getAll(e),r=(0,s.Z)(n,t);if(void 0===r)throw new Xt.dR(`Key ${t} does not exist in config`);return r},set(t,n,s={}){if("string"!=typeof t&&!(t instanceof String))throw i(new Error("Invalid key type: "+typeof t),"ERR_INVALID_KEY");if(void 0===n||n instanceof Uint8Array)throw i(new Error("Invalid value type: "+typeof n),"ERR_INVALID_VALUE");return e.add((()=>r({key:t,value:n},s.signal)))},replace(t,n={}){if(!t||t instanceof Uint8Array)throw i(new Error("Invalid value type: "+typeof t),"ERR_INVALID_VALUE");return e.add((()=>r({key:void 0,value:t},n.signal)))},exists:async()=>te(ce,t.has.bind(t),t)};return n;async function r(t,e){if(e&&e.aborted)return;const r=t.key,s=t.value;if(r){const t=await n.getAll();return"object"==typeof t&&null!==t&&(0,ie.Z)(t,r,s),o(t)}return o(s)}function o(e){const n=(0,z.m)(JSON.stringify(e,null,2));return t.put(ce,n)}}(this.root),this.spec=function(t){return{exists:()=>t.has(de),async get(){const e=await t.get(de);return JSON.parse((0,B.B)(e))},set:async e=>t.put(de,(0,z.m)(JSON.stringify((0,ue.Z)(e,{deep:!0}))))}}(this.root),this.apiAddr=function(t){return{async get(){const e=await t.get(he);return e&&e.toString()},set:e=>t.put(he,(0,z.m)(e.toString())),delete:()=>t.delete(he)}}(this.root),this.gcLock=(0,Oe.Z)({name:t,singleProcess:!1!==this.options.repoOwner}),this.gc=Fe({gcLock:this.gcLock,pins:this.pins,blockstore:this.blocks,root:this.root,loadCodec:e})}async init(t){var e;Ke("initializing at: %s",this.path),await this._openRoot(),await this.config.replace((e=t,e.Datastore=Object.assign({},be,(0,s.Z)(e,"datastore")),e)),await this.spec.set(function(t){const e={...be.Spec,...(0,s.Z)(t,"Datastore.Spec")};return{type:e.type,mounts:e.mounts.map((t=>({mountpoint:t.mountpoint,type:t.child.type,path:t.child.path,shardFunc:t.child.shardFunc})))}}(t)),await this.version.set(Qt._)}async isInitialized(){if(!this.closed)return!0;try{return await this._openRoot(),await this._checkInitialized(),await this.root.close(),!0}catch(t){return!1}}async open(){if(!this.closed)throw i(new Error("repo is already open"),Xt.AJ);Ke("opening at: %s",this.path);try{await this._openRoot(),await this._checkInitialized(),this._lockfile=await this._openLock(),Ke("acquired repo.lock");if(!await this.version.check(Qt._)){if(!await this._isAutoMigrationEnabled())throw new Xt.CK("Incompatible repo versions. Automatic migrations disabled. Please migrate the repo manually.");await this._migrate(Qt._,{root:this.root,datastore:this.datastore,pins:this.pins.pinstore,blocks:this.pins.blockstore,keys:this.keys})}Ke("creating datastore"),await this.datastore.open(),Ke("creating blocks"),await this.blocks.open(),Ke("creating keystore"),await this.keys.open(),Ke("creating pins"),await this.pins.pinstore.open(),this.closed=!1,Ke("all opened")}catch(t){if(this._lockfile)try{await this._closeLock(),this._lockfile=null}catch(t){Ke("error removing lock",t)}throw t}}async _openRoot(){try{await this.root.open()}catch(t){if("Already open"!==t.message)throw t}}async _openLock(){const t=await this.options.repoLock.lock(this.path);if("function"!=typeof t.close)throw i(new Error("Locks must have a close method"),"ERR_NO_CLOSE_FUNCTION");return t}_closeLock(){return this._lockfile&&this._lockfile.close()}async _checkInitialized(){let t;Ke("init check");try{[t]=await Promise.all([this.config.exists(),this.spec.exists(),this.version.exists()])}catch(t){if("ERR_NOT_FOUND"===t.code)throw i(new Error("repo is not initialized yet"),Xt.uF,{path:this.path});throw t}if(!t)throw i(new Error("repo is not initialized yet"),Xt.uF,{path:this.path})}async close(){if(this.closed)throw i(new Error("repo is already closed"),Xt._I);Ke("closing at: %s",this.path);try{await this.apiAddr.delete()}catch(t){if(t.code!==Xt.uF&&!t.message.startsWith("ENOENT"))throw t}await Promise.all([this.root,this.blocks,this.keys,this.datastore,this.pins.pinstore].map((t=>t&&t.close()))),Ke("unlocking"),this.closed=!0,await this._closeLock()}exists(){return this.version.exists()}async stat(){if(this.datastore&&this.keys){const[t,e,n,r,s]=await Promise.all([this._storageMaxStat(),this._blockStat(),this.version.get(),We(this.datastore),We(this.keys)]),o=e.size+r+s;return{repoPath:this.path,storageMax:t,version:n,numObjects:e.count,repoSize:o}}throw i(new Error("repo is not initialized yet"),Xt.uF,{path:this.path})}async _isAutoMigrationEnabled(){if(void 0!==this.options.autoMigrate)return this.options.autoMigrate;let t;try{t=await this.config.get("repoAutoMigrate")}catch(e){if(e.code!==Xt.dR.code)throw e;t=!0}return t}async _migrate(t,e){return await this.version.get()>t?(Ke(`reverting to version ${t}`),async function(t,e,n,r,s={}){const o=s.ignoreLock??!1,i=s.onProgress,a=s.isDryRun??!1,c=s.migrations??Bt;if(!t)throw new Zt.RequiredParameterError("Path argument is required!");if(!n)throw new Zt.RequiredParameterError("repoOptions argument is required!");if(!r)throw new Zt.RequiredParameterError("When reverting migrations, you have to specify to which version to revert!");if(!Number.isInteger(r)||r<=0)throw new Zt.InvalidValueError("Version has to be positive integer!");e=tt(e);const l=await Ft(e);if(l===r)return void qt("Nothing to revert.");if(l<r)throw new Zt.InvalidValueError(`Current repo's version (${l}) is lower then toVersion (${r}), you probably wanted to migrate it?`);let u;Wt(c,r,l,!0),a||o||(u=await n.repoLock.lock(t)),qt(`Reverting from version ${l} to ${r}`);try{const t=c.slice().reverse();for(const n of t){if(n.version<=r)break;if(!(n.version>l)){qt(`Reverting migration version ${n.version}`);try{if(!a){let t=()=>{};i&&(t=(t,e)=>i(n.version,t.toFixed(2),e)),await n.revert(e,t)}}catch(t){const r=n.version;throw qt(`An exception was raised during execution of migration. Setting the repo's version to last successfully reverted version: ${r}`),await Kt(r,e),t.message=`During reversion to version ${n.version} exception was raised: ${t.message}`,t}qt(`Reverting to version ${n.version} finished`)}}a||await Kt(r,e),qt(`All migrations successfully reverted to version ${r}!`)}finally{a||o||!u||await u.close()}}(this.path,e,this.options,t,{ignoreLock:!0,onProgress:this.options.onMigrationProgress})):(Ke(`migrating to version ${t}`),Gt(this.path,e,this.options,t,{ignoreLock:!0,onProgress:this.options.onMigrationProgress}))}async _storageMaxStat(){try{const t=await this.config.get("Datastore.StorageMax");return BigInt(Yt(t))}catch(t){return BigInt(qe)}}async _blockStat(){let t=BigInt(0),e=BigInt(0);if(this.blocks)for await(const{key:n,value:r}of this.blocks.query({}))t+=BigInt(1),e+=BigInt(r.byteLength),e+=BigInt(n.bytes.byteLength);return{count:t,size:e}}}async function We(t){let e=BigInt(0);for await(const n of t.query({}))e+=BigInt(n.value.byteLength),e+=BigInt(n.key.uint8Array().byteLength);return e}function Ze(t,e,n,r){return new Ge(t,e,n,r)}},83723:function(t,e,n){"use strict";n.d(e,{G:function(){return a}});var r=n(68919);const s=n(11227)("ipfs:repo:lock:memory"),o="repo.lock",i={};const a={lock:async function(t){const e=t+"/"+o;if(s("locking %s",e),!0===i[e])throw new r.gg(`Lock already being held for file: ${e}`);return i[e]=!0,{async close(){i[e]&&delete i[e]}}},locked:async function(t){const e=t+"/"+o;return s(`checking lock: ${e}`),Boolean(i[e])}}},69044:function(t,e,n){"use strict";n.d(e,{R:function(){return r}});const r={direct:"direct",recursive:"recursive",indirect:"indirect",all:"all"}},67031:function(t,e,n){"use strict";function r(t){return/^127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(t)||/^::1$/.test(t)}n.d(e,{B:function(){return r}})}}]);
//# sourceMappingURL=937.c378c2ab.chunk.js.map